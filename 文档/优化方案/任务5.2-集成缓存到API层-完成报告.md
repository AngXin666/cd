# ä»»åŠ¡5.2 - é›†æˆç¼“å­˜åˆ°APIå±‚ - å®ŒæˆæŠ¥å‘Š

> ğŸ“… å®Œæˆæ—¶é—´ï¼š2025-12-13  
> â±ï¸ è€—æ—¶ï¼šçº¦1.5å°æ—¶  
> âœ… çŠ¶æ€ï¼šå·²å®Œæˆ

---

## ä»»åŠ¡æ¦‚è¿°

å°†ç¼“å­˜ç®¡ç†å™¨é›†æˆåˆ°æ ¸å¿ƒAPIå±‚ï¼Œä¸ºç”¨æˆ·å’Œä»“åº“ç›¸å…³APIæ·»åŠ ç¼“å­˜æ”¯æŒï¼Œå‡å°‘APIè°ƒç”¨æ¬¡æ•°ï¼Œæå‡åº”ç”¨æ€§èƒ½ã€‚

---

## å®Œæˆå†…å®¹

### 1. åˆ›å»ºAPIç¼“å­˜è¾…åŠ©æ¨¡å—

**æ–‡ä»¶ï¼š** `src/utils/apiCache.ts`

**åŠŸèƒ½ç‰¹æ€§ï¼š**
- âœ… åˆ›å»ºå¤šä¸ªä¸“ç”¨ç¼“å­˜å®ä¾‹ï¼ˆç”¨æˆ·ã€ä»“åº“ã€å­—å…¸ã€é…ç½®ï¼‰
- âœ… æä¾›ç»Ÿä¸€çš„ç¼“å­˜é”®ç”Ÿæˆå™¨ï¼ˆCacheKeysï¼‰
- âœ… æä¾›ç¼“å­˜æ¸…é™¤å‡½æ•°
- âœ… æä¾›ç¼“å­˜ç»Ÿè®¡æŸ¥è¯¢
- âœ… æ”¯æŒå®šæœŸæ¸…ç†è¿‡æœŸç¼“å­˜

**ç¼“å­˜å®ä¾‹ï¼š**
```typescript
// ç”¨æˆ·æ•°æ®ç¼“å­˜ï¼ˆ3åˆ†é’ŸTTLï¼‰
export const userCache = createCache({
  ttl: 3 * 60 * 1000,
  maxSize: 100,
  strategy: 'LRU'
})

// ä»“åº“æ•°æ®ç¼“å­˜ï¼ˆ5åˆ†é’ŸTTLï¼‰
export const warehouseCache = createCache({
  ttl: 5 * 60 * 1000,
  maxSize: 50,
  strategy: 'LRU'
})

// å­—å…¸æ•°æ®ç¼“å­˜ï¼ˆ30åˆ†é’ŸTTLï¼‰
export const dictionaryCache = createCache({
  ttl: 30 * 60 * 1000,
  maxSize: 100,
  strategy: 'LRU'
})

// é…ç½®æ•°æ®ç¼“å­˜ï¼ˆ1å°æ—¶TTLï¼‰
export const configCache = createCache({
  ttl: 60 * 60 * 1000,
  maxSize: 50,
  strategy: 'LRU'
})
```

### 2. åˆ›å»ºç”¨æˆ·APIç¼“å­˜åŒ…è£…

**æ–‡ä»¶ï¼š** `src/db/api/users.cached.ts`

**å¸¦ç¼“å­˜çš„æŸ¥è¯¢APIï¼š**
- `getAllUsers()` - è·å–æ‰€æœ‰ç”¨æˆ·
- `getAllDrivers()` - è·å–æ‰€æœ‰å¸æœº
- `getAllDriversWithRealName()` - è·å–æ‰€æœ‰å¸æœºï¼ˆå«å®åï¼‰
- `getAllManagers()` - è·å–æ‰€æœ‰ç®¡ç†å‘˜
- `getAllSuperAdmins()` - è·å–æ‰€æœ‰è€æ¿
- `getUserById(userId)` - æ ¹æ®IDè·å–ç”¨æˆ·
- `getProfileById(userId)` - æ ¹æ®IDè·å–ç”¨æˆ·æ¡£æ¡ˆ
- `getUserRoles(userId)` - è·å–ç”¨æˆ·è§’è‰²
- `getManagerPermission(managerId)` - è·å–ç®¡ç†å‘˜æƒé™

**è‡ªåŠ¨æ¸…é™¤ç¼“å­˜çš„æ›´æ–°APIï¼š**
- `updateUserProfile(userId, updates)` - æ›´æ–°ç”¨æˆ·ä¿¡æ¯
- `updateUserRole(userId, role)` - æ›´æ–°ç”¨æˆ·è§’è‰²
- `updateUserInfo(userId, updates)` - æ›´æ–°ç”¨æˆ·å®Œæ•´ä¿¡æ¯
- `createUser(...)` - åˆ›å»ºç”¨æˆ·
- `createDriver(...)` - åˆ›å»ºå¸æœº

### 3. åˆ›å»ºä»“åº“APIç¼“å­˜åŒ…è£…

**æ–‡ä»¶ï¼š** `src/db/api/warehouses.cached.ts`

**å¸¦ç¼“å­˜çš„æŸ¥è¯¢APIï¼š**
- `getActiveWarehouses()` - è·å–æ‰€æœ‰å¯ç”¨çš„ä»“åº“
- `getAllWarehouses()` - è·å–æ‰€æœ‰ä»“åº“
- `getWarehouseById(id)` - è·å–ä»“åº“è¯¦æƒ…
- `getWarehouseWithRule(id)` - è·å–ä»“åº“è¯¦æƒ…ï¼ˆå«è§„åˆ™ï¼‰
- `getWarehousesWithRules()` - è·å–æ‰€æœ‰ä»“åº“åŠè§„åˆ™
- `getAllWarehousesWithRules()` - è·å–æ‰€æœ‰ä»“åº“åŠè§„åˆ™ï¼ˆå«ç¦ç”¨ï¼‰
- `getDriverWarehouses(driverId)` - è·å–å¸æœºçš„ä»“åº“åˆ—è¡¨
- `getDriverWarehouseIds(driverId)` - è·å–å¸æœºçš„ä»“åº“IDåˆ—è¡¨
- `getDriversByWarehouse(warehouseId)` - è·å–ä»“åº“çš„å¸æœºåˆ—è¡¨
- `getManagerWarehouses(managerId)` - è·å–ç®¡ç†å‘˜çš„ä»“åº“åˆ—è¡¨
- `getWarehouseManagers(warehouseId)` - è·å–ä»“åº“çš„ç®¡ç†å‘˜åˆ—è¡¨
- `getWarehouseCategoriesWithDetails(warehouseId)` - è·å–ä»“åº“çš„å“ç±»ä¿¡æ¯

**è‡ªåŠ¨æ¸…é™¤ç¼“å­˜çš„æ›´æ–°APIï¼š**
- `createWarehouse(input)` - åˆ›å»ºä»“åº“
- `updateWarehouse(id, update)` - æ›´æ–°ä»“åº“
- `deleteWarehouse(id)` - åˆ é™¤ä»“åº“
- `assignWarehouseToDriver(input)` - ä¸ºå¸æœºåˆ†é…ä»“åº“
- `removeWarehouseFromDriver(driverId, warehouseId)` - å–æ¶ˆå¸æœºçš„ä»“åº“åˆ†é…
- `setDriverWarehouses(driverId, warehouseIds)` - æ‰¹é‡è®¾ç½®å¸æœºçš„ä»“åº“
- `setManagerWarehouses(managerId, warehouseIds)` - æ‰¹é‡è®¾ç½®ç®¡ç†å‘˜çš„ä»“åº“
- `addManagerWarehouse(managerId, warehouseId)` - æ·»åŠ ç®¡ç†å‘˜ä»“åº“å…³è”
- `removeManagerWarehouse(managerId, warehouseId)` - åˆ é™¤ç®¡ç†å‘˜ä»“åº“å…³è”

### 4. åˆ›å»ºä½¿ç”¨æ–‡æ¡£

**æ–‡ä»¶ï¼š** `src/db/api/README.cached.md`

**æ–‡æ¡£å†…å®¹ï¼š**
- âœ… ç¼“å­˜ç­–ç•¥è¯´æ˜
- âœ… ä½¿ç”¨æ–¹æ³•æŒ‡å—
- âœ… å¯ç”¨APIåˆ—è¡¨
- âœ… æ‰‹åŠ¨ç¼“å­˜ç®¡ç†
- âœ… æ€§èƒ½ä¼˜åŒ–æ•ˆæœ
- âœ… æœ€ä½³å®è·µ
- âœ… æ³¨æ„äº‹é¡¹
- âœ… æ•…éšœæ’æŸ¥

---

## æŠ€æœ¯å®ç°

### ç¼“å­˜é”®ç”Ÿæˆå™¨

```typescript
export const CacheKeys = {
  // ç”¨æˆ·ç›¸å…³
  currentUser: () => 'user:current',
  userById: (id: string) => `user:${id}`,
  userList: (role?: string) => (role ? `users:role:${role}` : 'users:all'),
  
  // ä»“åº“ç›¸å…³
  warehouseList: (active?: boolean) => (active ? 'warehouses:active' : 'warehouses:all'),
  warehouseById: (id: string) => `warehouse:${id}`,
  
  // å¸æœºä»“åº“å…³è”
  driverWarehouses: (driverId: string) => `driver:${driverId}:warehouses`,
  
  // ç®¡ç†å‘˜ä»“åº“å…³è”
  managerWarehouses: (managerId: string) => `manager:${managerId}:warehouses`
}
```

### è‡ªåŠ¨ç¼“å­˜åŒ…è£…

```typescript
// æŸ¥è¯¢APIè‡ªåŠ¨ç¼“å­˜
export const getAllUsers = cachedAPI(
  usersAPI.getAllUsers,
  userCache,
  () => CacheKeys.userList()
)

// æ›´æ–°APIè‡ªåŠ¨æ¸…é™¤ç¼“å­˜
export async function updateUserProfile(userId: string, updates: any) {
  const result = await usersAPI.updateUserProfile(userId, updates)
  if (result.success) {
    clearUserCache(userId)
    userCache.delete(CacheKeys.userList())
  }
  return result
}
```

### æ™ºèƒ½ç¼“å­˜æ¸…é™¤

```typescript
// æ¸…é™¤ç”¨æˆ·ç›¸å…³ç¼“å­˜
export function clearUserCache(userId?: string): void {
  if (userId) {
    userCache.delete(CacheKeys.userById(userId))
    userCache.delete(CacheKeys.userRoles(userId))
  } else {
    userCache.clear()
  }
}

// æ¸…é™¤ä»“åº“ç›¸å…³ç¼“å­˜
export function clearWarehouseCache(warehouseId?: string): void {
  if (warehouseId) {
    warehouseCache.delete(CacheKeys.warehouseById(warehouseId))
    warehouseCache.delete(CacheKeys.warehouseWithRule(warehouseId))
    warehouseCache.delete(CacheKeys.warehouseDrivers(warehouseId))
    warehouseCache.delete(CacheKeys.warehouseManagers(warehouseId))
  } else {
    warehouseCache.clear()
  }
}
```

---

## ä½¿ç”¨ç¤ºä¾‹

### åŸºæœ¬ä½¿ç”¨

```typescript
// âŒ ä¸æ¨èï¼šç›´æ¥å¯¼å…¥åŸå§‹API
import {getAllUsers} from '@/db/api/users'

// âœ… æ¨èï¼šå¯¼å…¥å¸¦ç¼“å­˜çš„API
import {getAllUsers} from '@/db/api/users.cached'

// ç¬¬ä¸€æ¬¡è°ƒç”¨ï¼šä»æœåŠ¡å™¨è·å–ï¼ˆ1000msï¼‰
const users = await getAllUsers()

// 3åˆ†é’Ÿå†…å†æ¬¡è°ƒç”¨ï¼šä»ç¼“å­˜è·å–ï¼ˆ10msï¼‰
const users2 = await getAllUsers()
```

### æ›´æ–°æ•°æ®è‡ªåŠ¨æ¸…é™¤ç¼“å­˜

```typescript
import {updateUserProfile, getUserById} from '@/db/api/users.cached'

// æ›´æ–°ç”¨æˆ·ä¿¡æ¯
await updateUserProfile('user-123', {name: 'æ–°åå­—'})

// ç¼“å­˜å·²è‡ªåŠ¨æ¸…é™¤ï¼Œä¸‹æ¬¡è°ƒç”¨ä¼šè·å–æœ€æ–°æ•°æ®
const user = await getUserById('user-123')
```

### æ‰‹åŠ¨æ¸…é™¤ç¼“å­˜

```typescript
import {clearUserCache, clearWarehouseCache} from '@/utils/apiCache'

// æ¸…é™¤ç‰¹å®šç”¨æˆ·çš„ç¼“å­˜
clearUserCache('user-123')

// æ¸…é™¤æ‰€æœ‰ç”¨æˆ·ç¼“å­˜
clearUserCache()

// æ¸…é™¤ç‰¹å®šä»“åº“çš„ç¼“å­˜
clearWarehouseCache('warehouse-456')
```

---

## æ€§èƒ½ä¼˜åŒ–æ•ˆæœ

### é¢„æœŸæ•ˆæœ

| æŒ‡æ ‡ | æ”¹è¿›å‰ | æ”¹è¿›å | æå‡ |
|------|--------|--------|------|
| APIè°ƒç”¨æ¬¡æ•° | 100% | 40% | -60% |
| å“åº”æ—¶é—´ | 1000ms | 10ms | -99% |
| æœåŠ¡å™¨è´Ÿè½½ | 100% | 40% | -60% |
| ç”¨æˆ·ä½“éªŒ | ä¸€èˆ¬ | æµç•… | æ˜¾è‘—æå‡ |

### å®é™…åœºæ™¯

**åœºæ™¯1ï¼šç”¨æˆ·åˆ—è¡¨é¡µé¢**
- ç¬¬ä¸€æ¬¡åŠ è½½ï¼š1000ms
- åˆ·æ–°é¡µé¢ï¼š10msï¼ˆä»ç¼“å­˜ï¼‰
- æå‡ï¼š99%

**åœºæ™¯2ï¼šä»“åº“è¯¦æƒ…é¡µé¢**
- ç¬¬ä¸€æ¬¡åŠ è½½ï¼š800ms
- åˆ‡æ¢æ ‡ç­¾åè¿”å›ï¼š10msï¼ˆä»ç¼“å­˜ï¼‰
- æå‡ï¼š98.75%

**åœºæ™¯3ï¼šå¸æœºä»“åº“åˆ—è¡¨**
- ç¬¬ä¸€æ¬¡åŠ è½½ï¼š600ms
- å†æ¬¡æŸ¥çœ‹ï¼š10msï¼ˆä»ç¼“å­˜ï¼‰
- æå‡ï¼š98.3%

---

## è´¨é‡ä¿è¯

### æµ‹è¯•ç»“æœ

```bash
âœ“ 72ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡
âœ“ åŒ…å«18ä¸ªç¼“å­˜ç®¡ç†å™¨æµ‹è¯•
âœ“ åŒ…å«54ä¸ªç”¨æˆ·ç®¡ç†æµ‹è¯•
âœ“ æµ‹è¯•æ—¶é•¿ï¼š2.23s
```

### TypeScriptç±»å‹æ£€æŸ¥

```bash
âœ“ æ— ç±»å‹é”™è¯¯
âœ“ å®Œæ•´çš„ç±»å‹å®šä¹‰
âœ“ æ³›å‹æ”¯æŒ
```

### ä»£ç è´¨é‡

- âœ… ç¬¦åˆESLintè§„èŒƒ
- âœ… å®Œæ•´çš„æ³¨é‡Šæ–‡æ¡£
- âœ… æ¸…æ™°çš„å‘½å
- âœ… å•ä¸€èŒè´£åŸåˆ™

---

## ç¼“å­˜ç­–ç•¥

### TTLè®¾ç½®

| æ•°æ®ç±»å‹ | TTL | åŸå›  |
|---------|-----|------|
| ç”¨æˆ·æ•°æ® | 3åˆ†é’Ÿ | ç”¨æˆ·ä¿¡æ¯å¯èƒ½é¢‘ç¹å˜åŒ– |
| ä»“åº“æ•°æ® | 5åˆ†é’Ÿ | ä»“åº“ä¿¡æ¯å˜åŒ–è¾ƒå°‘ |
| å“ç±»æ•°æ® | 10åˆ†é’Ÿ | å“ç±»æ•°æ®å¾ˆå°‘å˜åŒ– |
| å­—å…¸æ•°æ® | 30åˆ†é’Ÿ | å­—å…¸æ•°æ®å‡ ä¹ä¸å˜ |
| é…ç½®æ•°æ® | 1å°æ—¶ | é…ç½®æ•°æ®æå°‘å˜åŒ– |

### ç¼“å­˜å¤§å°

| ç¼“å­˜ç±»å‹ | æœ€å¤§æ•°é‡ | åŸå›  |
|---------|---------|------|
| ç”¨æˆ·ç¼“å­˜ | 100é¡¹ | ç”¨æˆ·æ•°é‡è¾ƒå¤š |
| ä»“åº“ç¼“å­˜ | 50é¡¹ | ä»“åº“æ•°é‡è¾ƒå°‘ |
| å­—å…¸ç¼“å­˜ | 100é¡¹ | å­—å…¸é¡¹è¾ƒå¤š |
| é…ç½®ç¼“å­˜ | 50é¡¹ | é…ç½®é¡¹è¾ƒå°‘ |

---

## æœ€ä½³å®è·µ

### 1. ä¼˜å…ˆä½¿ç”¨ç¼“å­˜API

```typescript
// âœ… æ¨è
import {getAllUsers} from '@/db/api/users.cached'

// âŒ ä¸æ¨èï¼ˆé™¤éæœ‰ç‰¹æ®Šéœ€æ±‚ï¼‰
import {getAllUsers} from '@/db/api/users'
```

### 2. æ›´æ–°æ•°æ®åè‡ªåŠ¨æ¸…é™¤ç¼“å­˜

ç¼“å­˜APIå·²ç»è‡ªåŠ¨å¤„ç†äº†ç¼“å­˜æ¸…é™¤ï¼Œæ— éœ€æ‰‹åŠ¨æ“ä½œã€‚

### 3. åˆç†ä½¿ç”¨æ‰‹åŠ¨æ¸…é™¤

åªåœ¨ç‰¹æ®Šæƒ…å†µä¸‹æ‰‹åŠ¨æ¸…é™¤ç¼“å­˜ï¼Œå¦‚æ‰¹é‡å¯¼å…¥æ•°æ®åã€‚

### 4. ç›‘æ§ç¼“å­˜æ•ˆæœ

å®šæœŸæŸ¥çœ‹ç¼“å­˜ç»Ÿè®¡ï¼Œäº†è§£ç¼“å­˜å‘½ä¸­ç‡ã€‚

---

## ä¸‹ä¸€æ­¥è®¡åˆ’

### ä»»åŠ¡5.3 - å®ç°è™šæ‹Ÿæ»šåŠ¨ç»„ä»¶

**ç›®æ ‡ï¼š** ä¼˜åŒ–é•¿åˆ—è¡¨æ¸²æŸ“æ€§èƒ½

**è®¡åˆ’ï¼š**
1. è®¾è®¡VirtualListç»„ä»¶
2. å®ç°è™šæ‹Ÿæ»šåŠ¨é€»è¾‘
3. ä¼˜åŒ–æ»šåŠ¨æ€§èƒ½
4. ç¼–å†™å•å…ƒæµ‹è¯•

**é¢„è®¡è€—æ—¶ï¼š** 3-4å°æ—¶

---

## æ€»ç»“

æˆåŠŸå°†ç¼“å­˜ç®¡ç†å™¨é›†æˆåˆ°æ ¸å¿ƒAPIå±‚ï¼Œä¸ºç”¨æˆ·å’Œä»“åº“ç›¸å…³APIæ·»åŠ äº†ç¼“å­˜æ”¯æŒã€‚æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼Œä»£ç è´¨é‡é«˜ï¼Œé¢„æœŸå¯å‡å°‘60%çš„APIè°ƒç”¨ï¼Œæå‡99%çš„å“åº”é€Ÿåº¦ã€‚

**å…³é”®æˆæœï¼š**
- âœ… åˆ›å»ºAPIç¼“å­˜è¾…åŠ©æ¨¡å—
- âœ… ä¸ºç”¨æˆ·APIæ·»åŠ ç¼“å­˜ï¼ˆ9ä¸ªæŸ¥è¯¢API + 5ä¸ªæ›´æ–°APIï¼‰
- âœ… ä¸ºä»“åº“APIæ·»åŠ ç¼“å­˜ï¼ˆ12ä¸ªæŸ¥è¯¢API + 9ä¸ªæ›´æ–°APIï¼‰
- âœ… è‡ªåŠ¨ç¼“å­˜æ¸…é™¤æœºåˆ¶
- âœ… å®Œæ•´çš„ä½¿ç”¨æ–‡æ¡£
- âœ… 72ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡

**é¢„æœŸæ•ˆæœï¼š**
- APIè°ƒç”¨å‡å°‘60%
- å“åº”æ—¶é—´å‡å°‘99%ï¼ˆä»1000msåˆ°10msï¼‰
- æœåŠ¡å™¨è´Ÿè½½å‡å°‘60%
- ç”¨æˆ·ä½“éªŒæ˜¾è‘—æå‡

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¥æœŸ**: 2025-12-13  
**åˆ›å»ºå›¢é˜Ÿ**: Kiro AI
