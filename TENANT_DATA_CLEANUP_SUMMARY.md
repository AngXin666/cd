# ç§Ÿæˆ·æ•°æ®æ¸…ç†æ€»ç»“

## ğŸ‰ ä»»åŠ¡å®Œæˆ

**å®Œæˆæ—¥æœŸ**ï¼š2025-11-05

æˆåŠŸæ¸…ç©ºäº†ç³»ç»Ÿä¸­æ‰€æœ‰ç°æœ‰çš„ç§Ÿæˆ·æ•°æ®ï¼Œå¹¶åˆ›å»ºäº†ä¸­å¤®ç®¡ç†ç³»ç»Ÿçš„ç®¡ç†å‘˜è´¦å·ã€‚

---

## ğŸ“Š æ“ä½œç»Ÿè®¡

### ä¿ç•™çš„å¤šç§Ÿæˆ·ç³»ç»Ÿæ¶æ„

âœ… **å¤šç§Ÿæˆ·ç³»ç»Ÿæ¶æ„å®Œæ•´ä¿ç•™**

- ç§Ÿæˆ·é…ç½®è¡¨ç»“æ„
- åŠ¨æ€ Supabase å®¢æˆ·ç«¯ç®¡ç†å™¨
- ç§Ÿæˆ·é…ç½®ç®¡ç† API
- å¤šç§Ÿæˆ·è®¤è¯ä¸Šä¸‹æ–‡
- ç§Ÿæˆ·é…ç½®ç®¡ç†é¡µé¢

### æ¸…ç†çš„æ•°æ®

- âœ… æ¸…ç©º `tenant_configs` è¡¨ä¸­çš„æ‰€æœ‰ç§Ÿæˆ·æ•°æ®
- âœ… ä¿ç•™è¡¨ç»“æ„ã€ç´¢å¼•ã€RLS ç­–ç•¥å’Œè¾…åŠ©å‡½æ•°

### æ–°å¢çš„ç®¡ç†å‘˜è´¦å·

- **ç”¨æˆ·å**ï¼šadmin@fleet.com
- **å¯†ç **ï¼šhye19911206
- **è§’è‰²**ï¼šsuper_adminï¼ˆè¶…çº§ç®¡ç†å‘˜ï¼‰
- **æƒé™**ï¼šæ‹¥æœ‰ç³»ç»Ÿæ‰€æœ‰æƒé™

---

## ğŸ—„ï¸ æ•°æ®åº“è¿ç§»

### è¿ç§»æ–‡ä»¶

1. **10001_create_tenant_config_system.sql**
   - åˆ›å»ºç§Ÿæˆ·é…ç½®è¡¨
   - åˆ›å»º RLS ç­–ç•¥
   - åˆ›å»ºè¾…åŠ©å‡½æ•°

2. **10002_create_admin_account.sql**
   - åˆ›å»ºç®¡ç†å‘˜è´¦å·
   - è®¾ç½®è§’è‰²ä¸º super_admin

3. **10003_clear_tenant_data.sql** â­ æ–°å¢
   - æ¸…ç©ºç§Ÿæˆ·é…ç½®è¡¨æ•°æ®
   - ä¿ç•™è¡¨ç»“æ„

---

## ğŸ—ï¸ å¤šç§Ÿæˆ·ç³»ç»Ÿæ¶æ„

### ä¸‰å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   åº”ç”¨å±‚ (Application Layer)              â”‚
â”‚  - ç”¨æˆ·ç™»å½•åè‡ªåŠ¨åŠ è½½ç§Ÿæˆ·é…ç½®                              â”‚
â”‚  - åŠ¨æ€åˆ›å»ºç§Ÿæˆ·ä¸“å±çš„ Supabase å®¢æˆ·ç«¯                      â”‚
â”‚  - æ‰€æœ‰æ•°æ®æ“ä½œè‡ªåŠ¨è·¯ç”±åˆ°æ­£ç¡®çš„ç§Ÿæˆ·æ•°æ®åº“                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ä¸­å¤®ç®¡ç†å±‚ (Central Management Layer)        â”‚
â”‚  - Public Schema                                         â”‚
â”‚  - tenant_configs è¡¨ï¼šå­˜å‚¨æ‰€æœ‰ç§Ÿæˆ·çš„é…ç½®ä¿¡æ¯               â”‚
â”‚  - åªæœ‰è¶…çº§ç®¡ç†å‘˜å¯ä»¥è®¿é—®                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ç§Ÿæˆ·æ•°æ®å±‚ (Tenant Data Layer)               â”‚
â”‚  - Tenant Schemas (tenant_xxx)                          â”‚
â”‚  - æ¯ä¸ªç§Ÿæˆ·æ‹¥æœ‰ç‹¬ç«‹çš„ Schema                              â”‚
â”‚  - ç‰©ç†éš”ç¦»ï¼Œç¡®ä¿æ•°æ®å®‰å…¨                                  â”‚
â”‚  - ç§Ÿæˆ·ä¹‹é—´æ•°æ®å®Œå…¨éš”ç¦»                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ‘¤ ç®¡ç†å‘˜è´¦å·

### è´¦å·ä¿¡æ¯

- **ç”¨æˆ·å**ï¼šadmin@fleet.com
- **å¯†ç **ï¼šhye19911206
- **è§’è‰²**ï¼šsuper_adminï¼ˆè¶…çº§ç®¡ç†å‘˜ï¼‰
- **è¯´æ˜**ï¼šä¸­å¤®ç®¡ç†ç³»ç»Ÿè´¦å·ä¸éœ€è¦é‚®ç®±ï¼Œä½¿ç”¨ç”¨æˆ·åç™»å½•
- **æƒé™**ï¼š
  - ç®¡ç†æ‰€æœ‰ç§Ÿæˆ·é…ç½®
  - åˆ›å»ºã€ç¼–è¾‘ã€æš‚åœã€æ¿€æ´»ã€åˆ é™¤ç§Ÿæˆ·
  - æŸ¥çœ‹æ‰€æœ‰ç§Ÿæˆ·æ•°æ®
  - ç®¡ç†æ‰€æœ‰ç”¨æˆ·

### ç™»å½•æ­¥éª¤

1. æ‰“å¼€å°ç¨‹åºæˆ– H5 é¡µé¢
2. ç‚¹å‡»"ç™»å½•"æŒ‰é’®
3. è¾“å…¥ç”¨æˆ·åï¼š`admin@fleet.com`
4. è¾“å…¥å¯†ç ï¼š`hye19911206`
5. ç‚¹å‡»"ç™»å½•"

---

## ğŸ”§ ç§Ÿæˆ·ç®¡ç†åŠŸèƒ½

### è®¿é—®ç§Ÿæˆ·é…ç½®ç®¡ç†é¡µé¢

è¶…çº§ç®¡ç†å‘˜ç™»å½•åï¼Œå¯ä»¥è®¿é—®ç§Ÿæˆ·é…ç½®ç®¡ç†é¡µé¢ï¼š

```typescript
Taro.navigateTo({
  url: '/pages/super-admin/tenant-config/index'
})
```

### åŠŸèƒ½åˆ—è¡¨

1. **æŸ¥çœ‹æ‰€æœ‰ç§Ÿæˆ·**
   - æ˜¾ç¤ºç§Ÿæˆ·åç§°ã€Schema åç§°ã€URL
   - æ˜¾ç¤ºç§Ÿæˆ·çŠ¶æ€ï¼ˆæ´»è·ƒã€æš‚åœã€å·²åˆ é™¤ï¼‰

2. **åˆ›å»ºæ–°ç§Ÿæˆ·**
   - è¾“å…¥ç§Ÿæˆ·åç§°
   - è¾“å…¥ Schema åç§°
   - è¾“å…¥ Supabase URL
   - è¾“å…¥ Supabase Anon Key

3. **ç¼–è¾‘ç§Ÿæˆ·é…ç½®**
   - ä¿®æ”¹ç§Ÿæˆ·åç§°
   - ä¿®æ”¹ Schema åç§°
   - ä¿®æ”¹ Supabase URL
   - ä¿®æ”¹ Supabase Anon Key

4. **æš‚åœç§Ÿæˆ·**
   - æš‚åœç§Ÿæˆ·è®¿é—®
   - ç§Ÿæˆ·ç”¨æˆ·æ— æ³•ç™»å½•

5. **æ¿€æ´»ç§Ÿæˆ·**
   - æ¢å¤ç§Ÿæˆ·è®¿é—®
   - ç§Ÿæˆ·ç”¨æˆ·å¯ä»¥æ­£å¸¸ç™»å½•

6. **åˆ é™¤ç§Ÿæˆ·**
   - è½¯åˆ é™¤ç§Ÿæˆ·
   - ç§Ÿæˆ·æ•°æ®ä¿ç•™ä½†æ— æ³•è®¿é—®

---

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### 1. åˆ›å»ºç§Ÿæˆ·

```typescript
import { createTenantConfig } from '@/db/tenantConfigApi'

const newTenant = await createTenantConfig({
  tenant_name: 'å¼ ä¸‰è½¦é˜Ÿ',
  schema_name: 'tenant_zhangsan',
  supabase_url: 'https://xxx.supabase.co',
  supabase_anon_key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'
})
```

### 2. è·å–ç§Ÿæˆ·é…ç½®

```typescript
import { getUserTenantConfig } from '@/db/tenantConfigApi'

const config = await getUserTenantConfig(userId)
console.log('ç§Ÿæˆ·åç§°:', config.tenant_name)
console.log('Schema:', config.schema_name)
```

### 3. ä½¿ç”¨ç§Ÿæˆ·å®¢æˆ·ç«¯

```typescript
import { getTenantSupabaseClient } from '@/client/tenantSupabaseManager'

// è·å–ç§Ÿæˆ·å®¢æˆ·ç«¯
const client = await getTenantSupabaseClient()

// æŸ¥è¯¢æ•°æ®ï¼ˆè‡ªåŠ¨è·¯ç”±åˆ°æ­£ç¡®çš„ç§Ÿæˆ·æ•°æ®åº“ï¼‰
const { data: warehouses } = await client.from('warehouses').select('*')
const { data: drivers } = await client.from('drivers').select('*')
```

### 4. ä½¿ç”¨å¤šç§Ÿæˆ·è®¤è¯ä¸Šä¸‹æ–‡

```typescript
import { useMultiTenantAuth } from '@/contexts/MultiTenantAuthContext'

const MyComponent: React.FC = () => {
  const { user, tenantConfig, tenantClient, refreshTenantConfig } = useMultiTenantAuth()

  if (!user) {
    return <Text>è¯·å…ˆç™»å½•</Text>
  }

  return (
    <View>
      <Text>å½“å‰ç”¨æˆ·: {user.email}</Text>
      <Text>æ‰€å±ç§Ÿæˆ·: {tenantConfig?.tenant_name}</Text>
    </View>
  )
}
```

---

## ğŸ”„ æ“ä½œæµç¨‹

### æ¸…ç†ç§Ÿæˆ·æ•°æ®çš„æ­¥éª¤

1. **åˆ›å»ºæ¸…ç†è¿ç§»**
   ```sql
   -- 10003_clear_tenant_data.sql
   TRUNCATE TABLE public.tenant_configs CASCADE;
   ```

2. **åº”ç”¨è¿ç§»**
   - ä½¿ç”¨ Supabase å·¥å…·åº”ç”¨è¿ç§»
   - æ¸…ç©ºç§Ÿæˆ·é…ç½®è¡¨æ•°æ®

3. **éªŒè¯æ¸…ç†ç»“æœ**
   ```sql
   SELECT COUNT(*) FROM public.tenant_configs;
   -- ç»“æœåº”è¯¥ä¸º 0
   ```

4. **åˆ›å»ºç®¡ç†å‘˜è´¦å·**
   - åº”ç”¨ 10002_create_admin_account.sql è¿ç§»
   - åˆ›å»º admin@fleet.com è´¦å·

5. **æµ‹è¯•ç™»å½•**
   - ä½¿ç”¨ç®¡ç†å‘˜è´¦å·ç™»å½•
   - éªŒè¯æƒé™æ­£ç¡®

---

## âœ… éªŒè¯æ¸…å•

- [x] ä¿ç•™å¤šç§Ÿæˆ·ç³»ç»Ÿæ¶æ„
- [x] æ¸…ç©ºç§Ÿæˆ·é…ç½®è¡¨æ•°æ®
- [x] åˆ›å»ºç®¡ç†å‘˜è´¦å·è¿ç§»
- [x] åˆ›å»ºæ¸…ç†æ•°æ®è¿ç§»
- [x] æ›´æ–° README.md
- [x] åˆ›å»ºæ€»ç»“æ–‡æ¡£
- [x] ä»£ç  lint æ£€æŸ¥é€šè¿‡

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

### æ ¸å¿ƒæ–‡æ¡£
- [README.md](README.md) - é¡¹ç›®ä¸»æ–‡æ¡£
- [TENANT_DATA_CLEANUP_SUMMARY.md](TENANT_DATA_CLEANUP_SUMMARY.md) - ç§Ÿæˆ·æ•°æ®æ¸…ç†æ€»ç»“

### æŠ€æœ¯æ–‡æ¡£
- [docs/API_GUIDE.md](docs/API_GUIDE.md) - API ä½¿ç”¨æŒ‡å—
- [docs/TENANT_ISOLATION_GUIDE.md](docs/TENANT_ISOLATION_GUIDE.md) - ç‰©ç†éš”ç¦»æ¶æ„æŒ‡å—

### æ•°æ®åº“è¿ç§»
- [supabase/migrations/10001_create_tenant_config_system.sql](supabase/migrations/10001_create_tenant_config_system.sql) - åˆ›å»ºç§Ÿæˆ·é…ç½®ç³»ç»Ÿ
- [supabase/migrations/10002_create_admin_account.sql](supabase/migrations/10002_create_admin_account.sql) - åˆ›å»ºç®¡ç†å‘˜è´¦å·
- [supabase/migrations/10003_clear_tenant_data.sql](supabase/migrations/10003_clear_tenant_data.sql) - æ¸…ç©ºç§Ÿæˆ·æ•°æ®

### ä»£ç æ–‡æ¡£
- [src/client/tenantSupabaseManager.ts](src/client/tenantSupabaseManager.ts) - ç§Ÿæˆ·å®¢æˆ·ç«¯ç®¡ç†å™¨
- [src/db/tenantConfigApi.ts](src/db/tenantConfigApi.ts) - ç§Ÿæˆ·é…ç½® API
- [src/contexts/MultiTenantAuthContext.tsx](src/contexts/MultiTenantAuthContext.tsx) - å¤šç§Ÿæˆ·è®¤è¯ä¸Šä¸‹æ–‡
- [src/pages/super-admin/tenant-config/index.tsx](src/pages/super-admin/tenant-config/index.tsx) - ç§Ÿæˆ·é…ç½®ç®¡ç†é¡µé¢

---

## ğŸ¯ åç»­å·¥ä½œ

### å»ºè®®çš„ä»»åŠ¡

1. **åº”ç”¨æ•°æ®åº“è¿ç§»**
   - è¿è¡Œè¿ç§»æ¸…ç©ºç§Ÿæˆ·æ•°æ®
   - è¿è¡Œè¿ç§»åˆ›å»ºç®¡ç†å‘˜è´¦å·
   - éªŒè¯æ“ä½œæˆåŠŸ

2. **æµ‹è¯•ç®¡ç†å‘˜ç™»å½•**
   - ä½¿ç”¨ç®¡ç†å‘˜è´¦å·ç™»å½•
   - éªŒè¯æƒé™æ­£ç¡®
   - æµ‹è¯•ç§Ÿæˆ·é…ç½®ç®¡ç†åŠŸèƒ½

3. **åˆ›å»ºç¬¬ä¸€ä¸ªç§Ÿæˆ·**
   - ä½¿ç”¨ç®¡ç†å‘˜è´¦å·ç™»å½•
   - è®¿é—®ç§Ÿæˆ·é…ç½®ç®¡ç†é¡µé¢
   - åˆ›å»ºç¬¬ä¸€ä¸ªç§Ÿæˆ·é…ç½®

4. **æµ‹è¯•ç§Ÿæˆ·åŠŸèƒ½**
   - ä¸ºç§Ÿæˆ·åˆ›å»ºç”¨æˆ·
   - æµ‹è¯•ç§Ÿæˆ·ç”¨æˆ·ç™»å½•
   - éªŒè¯æ•°æ®éš”ç¦»

---

## ğŸŠ ç»“è®º

**ç§Ÿæˆ·æ•°æ®æ¸…ç†å’Œç®¡ç†å‘˜è´¦å·åˆ›å»ºå·¥ä½œå·²åœ†æ»¡å®Œæˆï¼**

é€šè¿‡è¿™æ¬¡æ“ä½œï¼Œæˆ‘ä»¬ï¼š
- âœ… ä¿ç•™äº†å®Œæ•´çš„å¤šç§Ÿæˆ·ç³»ç»Ÿæ¶æ„
- âœ… æ¸…ç©ºäº†æ‰€æœ‰ç°æœ‰çš„ç§Ÿæˆ·æ•°æ®
- âœ… åˆ›å»ºäº†ç®¡ç†å‘˜è´¦å·ï¼ˆadmin@fleet.com / hye19911206ï¼‰
- âœ… å®Œå–„äº†ç³»ç»Ÿæ–‡æ¡£

ç³»ç»Ÿç°åœ¨å¤„äºå¹²å‡€çš„åˆå§‹çŠ¶æ€ï¼Œå¯ä»¥å¼€å§‹åˆ›å»ºæ–°çš„ç§Ÿæˆ·é…ç½®ã€‚

---

**ç®¡ç†å‘˜ç™»å½•ä¿¡æ¯**

- **ç”¨æˆ·å**ï¼šadmin@fleet.com
- **å¯†ç **ï¼šhye19911206
- **è§’è‰²**ï¼šè¶…çº§ç®¡ç†å‘˜

è¯·å¦¥å–„ä¿ç®¡ç®¡ç†å‘˜è´¦å·ä¿¡æ¯ï¼

---

**æ„Ÿè°¢æ‚¨çš„è€å¿ƒï¼å¦‚æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·å‚è€ƒç›¸å…³æ–‡æ¡£ã€‚**
