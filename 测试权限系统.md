# æƒé™ç³»ç»Ÿæµ‹è¯•æŒ‡å—

## ğŸ“‹ æµ‹è¯•æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾›äº†æƒé™ç³»ç»Ÿçš„æµ‹è¯•æ–¹æ³•å’ŒéªŒè¯æ­¥éª¤ã€‚

---

## ğŸ§ª æµ‹è¯•ç¯å¢ƒå‡†å¤‡

### 1. ç¡®è®¤æ•°æ®åº“è¿ç§»å·²åº”ç”¨

```sql
-- æ£€æŸ¥æƒé™ç³»ç»Ÿè¡¨æ˜¯å¦å­˜åœ¨
SELECT table_name 
FROM information_schema.tables 
WHERE table_schema = 'public' 
  AND table_name IN ('permission_strategies', 'role_permission_mappings', 'resource_permissions')
ORDER BY table_name;

-- é¢„æœŸç»“æœï¼šåº”è¯¥è¿”å› 3 ä¸ªè¡¨
```

### 2. ç¡®è®¤ç­–ç•¥æ¨¡æ¿å·²æ’å…¥

```sql
-- æ£€æŸ¥ç­–ç•¥æ¨¡æ¿
SELECT strategy_name, strategy_type, description
FROM permission_strategies
WHERE is_active = true
ORDER BY strategy_name;

-- é¢„æœŸç»“æœï¼šåº”è¯¥è¿”å› 3 ä¸ªç­–ç•¥æ¨¡æ¿
-- 1. boss_full_access
-- 2. driver_own_data_only
-- 3. manager_managed_resources
```

### 3. ç¡®è®¤è§’è‰²æƒé™æ˜ å°„å·²åˆ›å»º

```sql
-- æ£€æŸ¥è§’è‰²æƒé™æ˜ å°„
SELECT 
  rpm.role,
  ps.strategy_name,
  rpm.resource_field,
  rpm.priority
FROM role_permission_mappings rpm
JOIN permission_strategies ps ON rpm.strategy_id = ps.id
WHERE rpm.is_active = true
ORDER BY rpm.priority DESC;

-- é¢„æœŸç»“æœï¼šåº”è¯¥è¿”å› 3 ä¸ªæ˜ å°„
-- BOSS â†’ boss_full_access (ä¼˜å…ˆçº§ 100)
-- MANAGER â†’ manager_managed_resources (ä¼˜å…ˆçº§ 50)
-- DRIVER â†’ driver_own_data_only (ä¼˜å…ˆçº§ 10)
```

---

## ğŸ” åŠŸèƒ½æµ‹è¯•

### æµ‹è¯• 1ï¼šéªŒè¯ users è¡¨ç­–ç•¥

```sql
-- æŸ¥çœ‹ users è¡¨çš„æ‰€æœ‰ç­–ç•¥
SELECT * FROM verify_users_table_policies();

-- é¢„æœŸç»“æœï¼šåº”è¯¥è¿”å› 6 ä¸ªç­–ç•¥
-- new_admins_delete_users (DELETE)
-- new_admins_insert_users (INSERT)
-- new_admins_update_all_users (UPDATE)
-- new_admins_view_all_users (SELECT)
-- new_drivers_update_self (UPDATE)
-- new_drivers_view_self (SELECT)
```

### æµ‹è¯• 2ï¼šè·å–ç”¨æˆ·ç­–ç•¥æ¨¡æ¿

```sql
-- å‡è®¾æœ‰ä¸€ä¸ª BOSS ç”¨æˆ·ï¼ŒID ä¸º 'user-uuid-here'
SELECT * FROM get_user_strategy('user-uuid-here');

-- é¢„æœŸç»“æœï¼šåº”è¯¥è¿”å› boss_full_access ç­–ç•¥
```

### æµ‹è¯• 3ï¼šæ„å»ºæƒé™è§„åˆ™

```sql
-- ä¸º BOSS ç”¨æˆ·æ„å»º users è¡¨çš„ SELECT è§„åˆ™
SELECT build_permission_rule('users', 'SELECT', 'user-uuid-here');

-- é¢„æœŸç»“æœï¼šåº”è¯¥è¿”å› 'is_admin(auth.uid())'
```

### æµ‹è¯• 4ï¼šæ£€æŸ¥ç”¨æˆ·æƒé™

```sql
-- æ£€æŸ¥ BOSS ç”¨æˆ·æ˜¯å¦å¯ä»¥æŸ¥çœ‹ users è¡¨
SELECT check_permission('user-uuid-here', 'users', 'SELECT', NULL);

-- é¢„æœŸç»“æœï¼šåº”è¯¥è¿”å› true
```

### æµ‹è¯• 5ï¼šè·å–ç”¨æˆ·æƒé™æ‘˜è¦

```sql
-- è·å– BOSS ç”¨æˆ·çš„æƒé™æ‘˜è¦
SELECT * FROM get_user_permissions_summary('user-uuid-here');

-- é¢„æœŸç»“æœï¼šåº”è¯¥è¿”å›æ‰€æœ‰è¡¨çš„æƒé™ï¼Œæ‰€æœ‰æ“ä½œéƒ½ä¸º true
```

---

## ğŸ­ è§’è‰²æƒé™æµ‹è¯•

### BOSS è§’è‰²æµ‹è¯•

**é¢„æœŸæƒé™**:
- âœ… å¯ä»¥æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·
- âœ… å¯ä»¥åˆ›å»ºç”¨æˆ·
- âœ… å¯ä»¥æ›´æ–°æ‰€æœ‰ç”¨æˆ·
- âœ… å¯ä»¥åˆ é™¤ç”¨æˆ·

**æµ‹è¯• SQL**:
```sql
-- å‡è®¾ BOSS ç”¨æˆ· ID ä¸º 'boss-uuid'
-- 1. æµ‹è¯•æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·
SELECT COUNT(*) FROM users; -- åº”è¯¥è¿”å›æ‰€æœ‰ç”¨æˆ·æ•°é‡

-- 2. æµ‹è¯•åˆ›å»ºç”¨æˆ·
INSERT INTO users (id, name, email) 
VALUES (gen_random_uuid(), 'æµ‹è¯•ç”¨æˆ·', 'test@example.com');
-- åº”è¯¥æˆåŠŸ

-- 3. æµ‹è¯•æ›´æ–°ç”¨æˆ·
UPDATE users SET name = 'æ›´æ–°åçš„åå­—' WHERE email = 'test@example.com';
-- åº”è¯¥æˆåŠŸ

-- 4. æµ‹è¯•åˆ é™¤ç”¨æˆ·
DELETE FROM users WHERE email = 'test@example.com';
-- åº”è¯¥æˆåŠŸ
```

### MANAGER è§’è‰²æµ‹è¯•

**é¢„æœŸæƒé™**:
- âœ… å¯ä»¥æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·ï¼ˆå› ä¸º is_admin åŒ…å« MANAGERï¼‰
- âœ… å¯ä»¥åˆ›å»ºç”¨æˆ·
- âœ… å¯ä»¥æ›´æ–°æ‰€æœ‰ç”¨æˆ·
- âœ… å¯ä»¥åˆ é™¤ç”¨æˆ·

**æµ‹è¯• SQL**:
```sql
-- å‡è®¾ MANAGER ç”¨æˆ· ID ä¸º 'manager-uuid'
-- æµ‹è¯•æ–¹æ³•ä¸ BOSS ç›¸åŒ
```

### DRIVER è§’è‰²æµ‹è¯•

**é¢„æœŸæƒé™**:
- âœ… åªèƒ½æŸ¥çœ‹è‡ªå·±
- âŒ ä¸èƒ½åˆ›å»ºç”¨æˆ·
- âœ… åªèƒ½æ›´æ–°è‡ªå·±çš„ä¿¡æ¯
- âŒ ä¸èƒ½åˆ é™¤ç”¨æˆ·

**æµ‹è¯• SQL**:
```sql
-- å‡è®¾ DRIVER ç”¨æˆ· ID ä¸º 'driver-uuid'
-- 1. æµ‹è¯•æŸ¥çœ‹è‡ªå·±
SELECT * FROM users WHERE id = 'driver-uuid';
-- åº”è¯¥æˆåŠŸ

-- 2. æµ‹è¯•æŸ¥çœ‹å…¶ä»–ç”¨æˆ·
SELECT * FROM users WHERE id != 'driver-uuid';
-- åº”è¯¥è¿”å›ç©ºç»“æœ

-- 3. æµ‹è¯•åˆ›å»ºç”¨æˆ·
INSERT INTO users (id, name, email) 
VALUES (gen_random_uuid(), 'æµ‹è¯•ç”¨æˆ·', 'test@example.com');
-- åº”è¯¥å¤±è´¥

-- 4. æµ‹è¯•æ›´æ–°è‡ªå·±çš„ä¿¡æ¯
UPDATE users SET name = 'æ›´æ–°åçš„åå­—' WHERE id = 'driver-uuid';
-- åº”è¯¥æˆåŠŸ

-- 5. æµ‹è¯•æ›´æ–°å…¶ä»–ç”¨æˆ·çš„ä¿¡æ¯
UPDATE users SET name = 'æ›´æ–°åçš„åå­—' WHERE id != 'driver-uuid';
-- åº”è¯¥å¤±è´¥

-- 6. æµ‹è¯•åˆ é™¤ç”¨æˆ·
DELETE FROM users WHERE id = 'driver-uuid';
-- åº”è¯¥å¤±è´¥
```

---

## ğŸ”§ å‰ç«¯é›†æˆæµ‹è¯•

### æµ‹è¯• 1ï¼šè·å–ç”¨æˆ·æƒé™æ‘˜è¦

```typescript
import { supabase } from '@/client/supabase';

async function testGetUserPermissionsSummary() {
  const { data: { user } } = await supabase.auth.getUser();
  
  if (!user) {
    console.error('ç”¨æˆ·æœªç™»å½•');
    return;
  }
  
  const { data, error } = await supabase
    .rpc('get_user_permissions_summary', {
      p_user_id: user.id
    });
  
  if (error) {
    console.error('è·å–æƒé™æ‘˜è¦å¤±è´¥:', error);
    return;
  }
  
  console.log('ç”¨æˆ·æƒé™æ‘˜è¦:', data);
  
  // æ£€æŸ¥æ˜¯å¦å¯ä»¥ç®¡ç†ç”¨æˆ·
  const usersPermission = data.find(p => p.table_name === 'users');
  if (usersPermission) {
    console.log('users è¡¨æƒé™:', {
      canSelect: usersPermission.can_select,
      canInsert: usersPermission.can_insert,
      canUpdate: usersPermission.can_update,
      canDelete: usersPermission.can_delete
    });
  }
}
```

### æµ‹è¯• 2ï¼šæ£€æŸ¥ç‰¹å®šè®°å½•çš„æƒé™

```typescript
async function testCheckPermission(recordId: string) {
  const { data: { user } } = await supabase.auth.getUser();
  
  if (!user) {
    console.error('ç”¨æˆ·æœªç™»å½•');
    return;
  }
  
  const { data, error } = await supabase
    .rpc('check_permission', {
      p_user_id: user.id,
      p_table_name: 'users',
      p_operation: 'UPDATE',
      p_record_id: recordId
    });
  
  if (error) {
    console.error('æ£€æŸ¥æƒé™å¤±è´¥:', error);
    return;
  }
  
  console.log(`æ˜¯å¦å¯ä»¥æ›´æ–°è®°å½• ${recordId}:`, data);
}
```

### æµ‹è¯• 3ï¼šè·å–å¯è®¿é—®çš„èµ„æº

```typescript
async function testGetAccessibleResources() {
  const { data: { user } } = await supabase.auth.getUser();
  
  if (!user) {
    console.error('ç”¨æˆ·æœªç™»å½•');
    return;
  }
  
  const { data, error } = await supabase
    .rpc('get_accessible_resources', {
      p_user_id: user.id,
      p_table_name: 'users'
    });
  
  if (error) {
    console.error('è·å–å¯è®¿é—®èµ„æºå¤±è´¥:', error);
    return;
  }
  
  console.log('å¯è®¿é—®çš„ç”¨æˆ· ID åˆ—è¡¨:', data);
  
  // æŸ¥è¯¢è¿™äº›ç”¨æˆ·çš„è¯¦ç»†ä¿¡æ¯
  if (data && data.length > 0) {
    const { data: users, error: usersError } = await supabase
      .from('users')
      .select('*')
      .in('id', data.map(r => r.resource_id));
    
    if (usersError) {
      console.error('æŸ¥è¯¢ç”¨æˆ·è¯¦æƒ…å¤±è´¥:', usersError);
      return;
    }
    
    console.log('å¯è®¿é—®çš„ç”¨æˆ·åˆ—è¡¨:', users);
  }
}
```

---

## ğŸ“Š æ€§èƒ½æµ‹è¯•

### æµ‹è¯• 1ï¼šæƒé™æ£€æŸ¥æ€§èƒ½

```sql
-- æµ‹è¯• 1000 æ¬¡æƒé™æ£€æŸ¥çš„æ€§èƒ½
EXPLAIN ANALYZE
SELECT check_permission('user-uuid-here', 'users', 'SELECT', NULL)
FROM generate_series(1, 1000);

-- è®°å½•æ‰§è¡Œæ—¶é—´
```

### æµ‹è¯• 2ï¼šæ‰¹é‡æƒé™æ£€æŸ¥æ€§èƒ½

```sql
-- å‡†å¤‡æµ‹è¯•æ•°æ®
WITH test_ids AS (
  SELECT id FROM users LIMIT 100
)
-- æµ‹è¯•æ‰¹é‡æ£€æŸ¥æ€§èƒ½
EXPLAIN ANALYZE
SELECT * FROM check_permissions_batch(
  'user-uuid-here',
  'users',
  ARRAY(SELECT id FROM test_ids)
);

-- è®°å½•æ‰§è¡Œæ—¶é—´
```

---

## âœ… æµ‹è¯•æ£€æŸ¥æ¸…å•

### åŸºç¡€åŠŸèƒ½æµ‹è¯•
- [ ] æƒé™ç³»ç»Ÿè¡¨å·²åˆ›å»º
- [ ] ç­–ç•¥æ¨¡æ¿å·²æ’å…¥
- [ ] è§’è‰²æƒé™æ˜ å°„å·²åˆ›å»º
- [ ] users è¡¨ç­–ç•¥å·²åº”ç”¨

### è§’è‰²æƒé™æµ‹è¯•
- [ ] BOSS è§’è‰²æƒé™æ­£ç¡®
- [ ] MANAGER è§’è‰²æƒé™æ­£ç¡®
- [ ] DRIVER è§’è‰²æƒé™æ­£ç¡®

### å‡½æ•°æµ‹è¯•
- [ ] get_user_strategy å‡½æ•°æ­£å¸¸
- [ ] build_permission_rule å‡½æ•°æ­£å¸¸
- [ ] check_permission å‡½æ•°æ­£å¸¸
- [ ] get_accessible_resources å‡½æ•°æ­£å¸¸
- [ ] get_user_permissions_summary å‡½æ•°æ­£å¸¸

### å‰ç«¯é›†æˆæµ‹è¯•
- [ ] è·å–ç”¨æˆ·æƒé™æ‘˜è¦æ­£å¸¸
- [ ] æ£€æŸ¥ç‰¹å®šè®°å½•æƒé™æ­£å¸¸
- [ ] è·å–å¯è®¿é—®èµ„æºæ­£å¸¸

### æ€§èƒ½æµ‹è¯•
- [ ] æƒé™æ£€æŸ¥æ€§èƒ½å¯æ¥å—
- [ ] æ‰¹é‡æƒé™æ£€æŸ¥æ€§èƒ½å¯æ¥å—

---

## ğŸ› å¸¸è§é—®é¢˜

### é—®é¢˜ 1ï¼šæƒé™æ£€æŸ¥è¿”å› false

**å¯èƒ½åŸå› **:
1. ç”¨æˆ·æ²¡æœ‰å¯¹åº”çš„è§’è‰²
2. ç­–ç•¥æ¨¡æ¿é…ç½®é”™è¯¯
3. èµ„æºé…ç½®é”™è¯¯

**è§£å†³æ–¹æ³•**:
```sql
-- æ£€æŸ¥ç”¨æˆ·è§’è‰²
SELECT * FROM user_roles WHERE user_id = 'user-uuid-here';

-- æ£€æŸ¥ç­–ç•¥æ¨¡æ¿
SELECT * FROM get_user_strategy('user-uuid-here');

-- æ£€æŸ¥èµ„æºé…ç½®
SELECT * FROM resource_permissions WHERE table_name = 'users';
```

### é—®é¢˜ 2ï¼šæ— æ³•æŸ¥è¯¢æ•°æ®

**å¯èƒ½åŸå› **:
1. RLS ç­–ç•¥é…ç½®é”™è¯¯
2. ç”¨æˆ·æƒé™ä¸è¶³

**è§£å†³æ–¹æ³•**:
```sql
-- æ£€æŸ¥è¡¨çš„ RLS ç­–ç•¥
SELECT * FROM verify_users_table_policies();

-- æ£€æŸ¥ç”¨æˆ·æƒé™
SELECT * FROM get_user_permissions_summary('user-uuid-here');
```

### é—®é¢˜ 3ï¼šæ€§èƒ½é—®é¢˜

**å¯èƒ½åŸå› **:
1. ç¼ºå°‘ç´¢å¼•
2. æƒé™æ£€æŸ¥é€»è¾‘å¤æ‚

**è§£å†³æ–¹æ³•**:
```sql
-- æ·»åŠ ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_user_roles_user_id ON user_roles(user_id);
CREATE INDEX IF NOT EXISTS idx_warehouse_assignments_user_id ON warehouse_assignments(user_id);

-- ä½¿ç”¨ EXPLAIN ANALYZE åˆ†ææŸ¥è¯¢
EXPLAIN ANALYZE
SELECT * FROM users WHERE id = 'user-uuid-here';
```

---

## ğŸ“ æµ‹è¯•æŠ¥å‘Šæ¨¡æ¿

```markdown
# æƒé™ç³»ç»Ÿæµ‹è¯•æŠ¥å‘Š

## æµ‹è¯•ä¿¡æ¯
- æµ‹è¯•æ—¥æœŸ: YYYY-MM-DD
- æµ‹è¯•äººå‘˜: XXX
- æµ‹è¯•ç¯å¢ƒ: å¼€å‘/æµ‹è¯•/ç”Ÿäº§

## æµ‹è¯•ç»“æœ

### åŸºç¡€åŠŸèƒ½æµ‹è¯•
- [ ] é€šè¿‡ / [ ] å¤±è´¥

### è§’è‰²æƒé™æµ‹è¯•
- BOSS: [ ] é€šè¿‡ / [ ] å¤±è´¥
- MANAGER: [ ] é€šè¿‡ / [ ] å¤±è´¥
- DRIVER: [ ] é€šè¿‡ / [ ] å¤±è´¥

### å‡½æ•°æµ‹è¯•
- [ ] é€šè¿‡ / [ ] å¤±è´¥

### å‰ç«¯é›†æˆæµ‹è¯•
- [ ] é€šè¿‡ / [ ] å¤±è´¥

### æ€§èƒ½æµ‹è¯•
- [ ] é€šè¿‡ / [ ] å¤±è´¥

## é—®é¢˜è®°å½•
1. é—®é¢˜æè¿°
   - è§£å†³æ–¹æ¡ˆ

## æ€»ç»“
æµ‹è¯•ç»“è®ºå’Œå»ºè®®
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**åˆ›å»ºæ—¶é—´**: 2025-12-01  
**é€‚ç”¨èŒƒå›´**: è½¦é˜Ÿç®¡å®¶å°ç¨‹åºæƒé™ç³»ç»Ÿæµ‹è¯•  
**çŠ¶æ€**: å·²å®Œæˆ
