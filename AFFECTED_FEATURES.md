# Migration 编号冲突 - 受影响功能分析

## 概述

由于 migration 文件编号冲突导致执行顺序混乱，以下功能可能受到影响。按影响程度分类：

---

## 🔴 高风险功能（必须测试）

### 1. 仓库分配系统 ⭐⭐⭐⭐⭐

**涉及的 Migration 文件**：
- `008_create_driver_warehouses.sql` - 创建表
- `039_fix_super_admin_driver_warehouses_insert.sql` - 修复权限（启用 RLS）
- `044_disable_all_rls.sql` - 禁用所有 RLS

**为什么高风险**：
- 这是本次修复的核心问题
- RLS 策略在启用和禁用之间切换
- 执行顺序直接影响功能是否正常

**受影响的功能**：
- ✓ 普通管理端分配仓库给司机
- ✓ 超级管理端分配仓库给司机
- ✓ 司机端查看自己的仓库列表
- ✓ 司机端在计件录入时选择仓库

**测试重点**：
1. 管理端分配仓库是否成功（不报错）
2. 司机端是否能看到分配的仓库
3. 数据是否正确写入 driver_warehouses 表

---

### 2. 用户认证和角色系统 ⭐⭐⭐⭐⭐

**涉及的 Migration 文件**：
- `001_create_profiles_table.sql` - 创建用户表
- `040_disable_profiles_rls.sql` - 禁用 profiles RLS
- `044_disable_all_rls.sql` - 禁用所有 RLS
- `049_enable_profiles_rls.sql` - 重新启用 profiles RLS
- `059_fix_handle_new_user_trigger.sql` - 修复用户创建触发器

**为什么高风险**：
- 认证是整个系统的基础
- RLS 策略多次切换
- 触发器可能受影响

**受影响的功能**：
- ✓ 用户登录（司机、管理员、超级管理员）
- ✓ 用户注册
- ✓ 角色识别和权限控制
- ✓ 首个用户自动成为管理员

**测试重点**：
1. 三种角色都能正常登录
2. 登录后能正确识别角色
3. 不同角色看到的界面和功能正确

---

### 3. 管理员权限系统 ⭐⭐⭐⭐

**涉及的 Migration 文件**：
- `016_create_permission_tables.sql` - 创建权限表
- `018_fix_super_admin_permissions.sql` - 修复超级管理员权限
- `034_fix_manager_warehouse_assignment_permissions.sql` - 修复管理员仓库分配权限

**为什么高风险**：
- 权限控制是安全的核心
- 多次修复说明这部分容易出问题

**受影响的功能**：
- ✓ 超级管理员管理所有数据
- ✓ 普通管理员只能管理自己负责的仓库
- ✓ 管理员分配仓库给司机
- ✓ 管理员查看司机数据

**测试重点**：
1. 超级管理员可以访问所有功能
2. 普通管理员只能访问自己负责的仓库
3. 权限边界清晰，不能越权

---

## 🟡 中风险功能（建议测试）

### 4. 计件录入系统 ⭐⭐⭐⭐

**涉及的 Migration 文件**：
- `009_create_piece_work_records.sql` - 创建计件记录表
- `010_enhance_piece_work_system.sql` - 增强计件系统
- `011_update_piece_work_permissions.sql` - 更新权限
- `012_fix_piece_work_permissions.sql` - 修复权限
- `026_cleanup_piece_work_policies.sql` - 清理策略

**为什么中风险**：
- 权限策略多次修改
- 依赖仓库分配功能

**受影响的功能**：
- ✓ 司机录入计件数据
- ✓ 管理员查看计件记录
- ✓ 计件数据统计

**测试重点**：
1. 司机可以录入计件数据
2. 数据正确保存
3. 管理员可以查看统计

---

### 5. 考勤系统 ⭐⭐⭐

**涉及的 Migration 文件**：
- `005_create_attendance_table.sql` - 创建考勤表
- `006_create_warehouse_and_attendance_rules.sql` - 创建考勤规则
- `007_simplify_attendance_system.sql` - 简化考勤系统
- `013_fix_attendance_constraints.sql` - 修复约束

**为什么中风险**：
- 系统经过多次重构
- 约束条件可能受影响

**受影响的功能**：
- ✓ 司机打卡（上班、下班）
- ✓ 考勤记录查看
- ✓ 考勤规则设置

**测试重点**：
1. 司机可以正常打卡
2. 考勤记录正确保存
3. 考勤规则生效

---

### 6. 价格分类系统 ⭐⭐⭐

**涉及的 Migration 文件**：
- `026_create_category_prices.sql` - 创建价格分类表
- `069_rename_can_manage_system_to_categories.sql` - 重命名字段

**为什么中风险**：
- 字段重命名可能导致代码不匹配

**受影响的功能**：
- ✓ 创建价格分类
- ✓ 编辑价格
- ✓ 计件录入时选择分类

**测试重点**：
1. 可以创建和编辑价格分类
2. 司机录入时可以选择分类
3. 价格计算正确

---

### 7. 车辆管理系统 ⭐⭐⭐

**涉及的 Migration 文件**：
- `084_create_vehicle_records_system.sql` - 创建车辆记录系统
- `085_make_vehicles_view_insertable.sql` - 使视图可插入
- `088_add_vehicle_lease_management.sql` - 添加租赁管理
- 多个修复文件（086-092）

**为什么中风险**：
- 系统较新，经过多次修复
- 使用了视图和触发器

**受影响的功能**：
- ✓ 添加车辆
- ✓ 编辑车辆信息
- ✓ 车辆租赁管理
- ✓ 车辆分配给司机

**测试重点**：
1. 可以添加和编辑车辆
2. 租赁功能正常
3. 车辆分配正常

---

## 🟢 低风险功能（可选测试）

### 8. 请假系统 ⭐⭐

**涉及的 Migration 文件**：
- `104_create_leave_and_resignation_tables.sql` - 创建请假表
- `103_add_warehouse_leave_settings.sql` - 添加请假设置
- `029_add_cancelled_status_to_leave.sql` - 添加取消状态

**为什么低风险**：
- 功能相对独立
- 没有复杂的权限控制

**受影响的功能**：
- ✓ 司机申请请假
- ✓ 管理员审批请假
- ✓ 请假记录查看

---

### 9. 反馈系统 ⭐⭐

**涉及的 Migration 文件**：
- `017_add_profile_fields_and_feedback.sql` - 创建反馈表

**为什么低风险**：
- 功能简单
- 不涉及复杂权限

**受影响的功能**：
- ✓ 提交反馈
- ✓ 查看反馈

---

### 10. 头像上传 ⭐

**涉及的 Migration 文件**：
- `019_create_avatars_bucket.sql` - 创建头像存储桶

**为什么低风险**：
- 功能独立
- 不影响核心业务

**受影响的功能**：
- ✓ 上传头像
- ✓ 显示头像

---

## 📊 功能依赖关系图

```
用户认证系统 (高风险)
    ↓
    ├─→ 角色识别
    │       ↓
    │       ├─→ 司机功能
    │       │       ├─→ 仓库分配 (高风险) ⭐
    │       │       ├─→ 计件录入 (中风险)
    │       │       ├─→ 考勤打卡 (中风险)
    │       │       └─→ 请假申请 (低风险)
    │       │
    │       ├─→ 管理员功能
    │       │       ├─→ 管理员权限 (高风险) ⭐
    │       │       ├─→ 仓库分配 (高风险) ⭐
    │       │       ├─→ 数据查看
    │       │       └─→ 审批功能
    │       │
    │       └─→ 超级管理员功能
    │               ├─→ 仓库管理
    │               ├─→ 用户管理
    │               ├─→ 权限分配 (高风险) ⭐
    │               └─→ 系统设置
    │
    └─→ 数据权限控制 (RLS)
            ├─→ profiles 表 (高风险) ⭐
            ├─→ driver_warehouses 表 (高风险) ⭐
            └─→ 其他表 (中/低风险)
```

---

## 🎯 测试优先级建议

### 第一轮测试（必须通过）
1. ✅ 用户登录（三种角色）
2. ✅ 仓库分配（管理端 → 司机端）
3. ✅ 基本权限验证

**如果第一轮失败**：系统不可用，需要立即修复

---

### 第二轮测试（重要功能）
1. ✅ 计件录入
2. ✅ 考勤打卡
3. ✅ 价格分类
4. ✅ 车辆管理

**如果第二轮失败**：核心业务受影响，建议修复后再上线

---

### 第三轮测试（辅助功能）
1. ✅ 请假系统
2. ✅ 反馈系统
3. ✅ 头像上传

**如果第三轮失败**：不影响核心业务，可以后续修复

---

## 📝 测试结果汇总表

| 功能模块 | 风险等级 | 测试状态 | 问题数量 | 备注 |
|---------|---------|---------|---------|------|
| 仓库分配系统 | 🔴 高 | ⏳ 待测试 | - | 核心问题 |
| 用户认证系统 | 🔴 高 | ⏳ 待测试 | - | 系统基础 |
| 管理员权限 | 🔴 高 | ⏳ 待测试 | - | 安全关键 |
| 计件录入 | 🟡 中 | ⏳ 待测试 | - | - |
| 考勤系统 | 🟡 中 | ⏳ 待测试 | - | - |
| 价格分类 | 🟡 中 | ⏳ 待测试 | - | - |
| 车辆管理 | 🟡 中 | ⏳ 待测试 | - | - |
| 请假系统 | 🟢 低 | ⏳ 待测试 | - | - |
| 反馈系统 | 🟢 低 | ⏳ 待测试 | - | - |
| 头像上传 | 🟢 低 | ⏳ 待测试 | - | - |

**测试状态图例**：
- ⏳ 待测试
- ✅ 通过
- ❌ 失败
- ⚠️ 部分通过

---

## 🔍 快速诊断命令

如果某个功能失败，可以使用以下 SQL 快速诊断：

### 检查 RLS 状态
```sql
SELECT tablename, rowsecurity 
FROM pg_tables 
WHERE schemaname = 'public' 
AND tablename = 'driver_warehouses';
```

### 检查策略
```sql
SELECT * FROM pg_policies 
WHERE tablename = 'driver_warehouses';
```

### 检查数据
```sql
SELECT * FROM driver_warehouses 
ORDER BY created_at DESC 
LIMIT 10;
```

---

## 📞 问题上报模板

如果发现问题，请使用以下格式记录：

```markdown
### 问题 #1

**功能模块**: 仓库分配系统
**风险等级**: 🔴 高
**发现时间**: 2025-11-05 14:30
**测试人员**: 张三

**问题描述**:
管理端分配仓库时报错：column "related_id" does not exist

**复现步骤**:
1. 登录管理端
2. 进入员工管理
3. 选择司机
4. 分配仓库
5. 点击保存

**错误信息**:
```
{code: '42703', message: 'column "related_id" of relation "notifications" does not exist'}
```

**影响范围**:
- 无法分配仓库
- 司机无法使用计件功能

**紧急程度**: 🔴 紧急（核心功能不可用）

**建议修复方案**:
检查是否有代码尝试插入 notifications 表
```

---

**文档版本**: 1.0  
**最后更新**: 2025-11-05  
**相关文档**: 
- `MIGRATION_FIX_REPORT.md` - 修复报告
- `TESTING_GUIDE.md` - 测试指南
