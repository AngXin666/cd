# ä»“åº“ç®¡ç†å¿«é€Ÿå‚è€ƒ

## ğŸš€ å¸¸ç”¨å‡½æ•°

### 1. è·å–ç”¨æˆ·å¯è®¿é—®çš„ä»“åº“åˆ—è¡¨

```typescript
const { data, error } = await supabase
  .rpc('get_user_accessible_warehouses', {
    p_user_id: user.id
  });
```

**è¿”å›**: `{ warehouse_id, warehouse_name, is_active }`

---

### 2. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å¯ä»¥è®¿é—®ä»“åº“

```typescript
const { data, error } = await supabase
  .rpc('can_user_access_warehouse', {
    p_user_id: user.id,
    p_warehouse_id: warehouseId
  });
```

**è¿”å›**: `boolean`

---

### 3. è·å–ä»“åº“çš„ç”¨æˆ·åˆ—è¡¨

```typescript
const { data, error } = await supabase
  .rpc('get_warehouse_users', {
    p_warehouse_id: warehouseId
  });
```

**è¿”å›**: `{ user_id, user_name, user_email, assigned_at }`

---

### 4. ä¸ºç”¨æˆ·åˆ†é…ä»“åº“

```typescript
const { data, error } = await supabase
  .rpc('assign_user_to_warehouse', {
    p_user_id: userId,
    p_warehouse_id: warehouseId,
    p_assigned_by: currentUser.id
  });
```

**è¿”å›**: `uuid` (åˆ†é…è®°å½• ID)

**å¼‚å¸¸**:
- åªæœ‰ç®¡ç†å‘˜å¯ä»¥åˆ†é…ä»“åº“
- ç”¨æˆ·ä¸å­˜åœ¨
- ä»“åº“ä¸å­˜åœ¨
- ç”¨æˆ·å·²ç»è¢«åˆ†é…åˆ°è¯¥ä»“åº“

---

### 5. å–æ¶ˆç”¨æˆ·çš„ä»“åº“åˆ†é…

```typescript
const { data, error } = await supabase
  .rpc('unassign_user_from_warehouse', {
    p_user_id: userId,
    p_warehouse_id: warehouseId,
    p_unassigned_by: currentUser.id
  });
```

**è¿”å›**: `boolean`

**å¼‚å¸¸**:
- åªæœ‰ç®¡ç†å‘˜å¯ä»¥å–æ¶ˆä»“åº“åˆ†é…
- åˆ†é…è®°å½•ä¸å­˜åœ¨

---

### 6. æ‰¹é‡åˆ†é…ç”¨æˆ·åˆ°ä»“åº“

```typescript
const { data, error } = await supabase
  .rpc('batch_assign_users_to_warehouse', {
    p_user_ids: [userId1, userId2, userId3],
    p_warehouse_id: warehouseId,
    p_assigned_by: currentUser.id
  });
```

**è¿”å›**: `{ user_id, success, error_message }[]`

---

## ğŸ” æƒé™çŸ©é˜µ

| æ“ä½œ | BOSS | MANAGER | DRIVER |
|-----|------|---------|--------|
| æŸ¥çœ‹æ‰€æœ‰ä»“åº“ | âœ… | âœ… | âŒ |
| æŸ¥çœ‹è‡ªå·±çš„ä»“åº“ | âœ… | âœ… | âœ… |
| åˆ›å»ºä»“åº“ | âœ… | âœ… | âŒ |
| æ›´æ–°ä»“åº“ | âœ… | âœ… | âŒ |
| åˆ é™¤ä»“åº“ | âœ… | âœ… | âŒ |
| åˆ†é…ç”¨æˆ·åˆ°ä»“åº“ | âœ… | âœ… | âŒ |
| å–æ¶ˆç”¨æˆ·åˆ†é… | âœ… | âœ… | âŒ |

---

## ğŸ“ å®Œæ•´ç¤ºä¾‹

### ä»“åº“åˆ—è¡¨é¡µé¢

```typescript
import React, { useEffect, useState } from 'react';
import { View, Text } from '@tarojs/components';
import Taro from '@tarojs/taro';
import { supabase } from '@/client/supabase';

const WarehouseList: React.FC = () => {
  const [warehouses, setWarehouses] = useState([]);
  
  useEffect(() => {
    loadWarehouses();
  }, []);
  
  const loadWarehouses = async () => {
    const { data: { user } } = await supabase.auth.getUser();
    
    const { data, error } = await supabase
      .rpc('get_user_accessible_warehouses', {
        p_user_id: user.id
      });
    
    if (!error) {
      setWarehouses(data || []);
    }
  };
  
  return (
    <View className="p-4">
      {warehouses.map(w => (
        <View key={w.warehouse_id} className="bg-card p-4 rounded-lg mb-2">
          <Text className="text-lg font-semibold">{w.warehouse_name}</Text>
        </View>
      ))}
    </View>
  );
};
```

### åˆ†é…ç”¨æˆ·åˆ°ä»“åº“

```typescript
const handleAssign = async () => {
  try {
    const { data: { user } } = await supabase.auth.getUser();
    
    await supabase.rpc('assign_user_to_warehouse', {
      p_user_id: selectedUserId,
      p_warehouse_id: warehouseId,
      p_assigned_by: user.id
    });
    
    Taro.showToast({
      title: 'åˆ†é…æˆåŠŸ',
      icon: 'success'
    });
  } catch (error) {
    Taro.showToast({
      title: error.message,
      icon: 'none'
    });
  }
};
```

---

## ğŸ§ª æµ‹è¯•å‘½ä»¤

### éªŒè¯ç­–ç•¥

```sql
-- éªŒè¯ warehouses è¡¨ç­–ç•¥
SELECT * FROM verify_warehouses_table_policies();

-- éªŒè¯ warehouse_assignments è¡¨ç­–ç•¥
SELECT * FROM verify_warehouse_assignments_table_policies();
```

### æµ‹è¯•æƒé™

```sql
-- æµ‹è¯•ç®¡ç†å‘˜æƒé™
SELECT * FROM warehouses; -- åº”è¯¥è¿”å›æ‰€æœ‰ä»“åº“

-- æµ‹è¯•å¸æœºæƒé™
SELECT * FROM warehouses; -- åº”è¯¥åªè¿”å›è‡ªå·±çš„ä»“åº“
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ä»“åº“ç®¡ç†åŠŸèƒ½ä½¿ç”¨æŒ‡å—](./ä»“åº“ç®¡ç†åŠŸèƒ½ä½¿ç”¨æŒ‡å—.md) - å®Œæ•´æ–‡æ¡£
- [ä»“åº“ç®¡ç†RLSç­–ç•¥åº”ç”¨æ€»ç»“](./ä»“åº“ç®¡ç†RLSç­–ç•¥åº”ç”¨æ€»ç»“.md) - å®æ–½æ€»ç»“
- [æƒé™ç³»ç»Ÿé‡æ„å®ŒæˆæŠ¥å‘Š](./æƒé™ç³»ç»Ÿé‡æ„å®ŒæˆæŠ¥å‘Š.md) - é‡æ„æŠ¥å‘Š

---

**ç‰ˆæœ¬**: 1.0  
**æ—¥æœŸ**: 2025-12-01
