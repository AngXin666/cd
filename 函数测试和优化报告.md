# è½¦é˜Ÿç®¡å®¶ç³»ç»Ÿå‡½æ•°æµ‹è¯•å’Œä¼˜åŒ–æŠ¥å‘Š

## ğŸ“‹ æ‰§è¡Œæ¦‚è¿°

**æ‰§è¡Œæ—¶é—´**: 2025-12-01  
**æ‰§è¡Œäºº**: ç³»ç»Ÿç®¡ç†å‘˜  
**çŠ¶æ€**: âœ… å·²å®Œæˆ

---

## ğŸ¯ æµ‹è¯•ç›®æ ‡

1. æµ‹è¯•æ‰€æœ‰æ–°åˆ›å»ºçš„ç»Ÿè®¡å’Œè§’è‰²ç®¡ç†å‡½æ•°
2. è¯†åˆ«åºŸå¼ƒå’Œé‡å¤çš„å‡½æ•°
3. åˆ é™¤ä¸å†ä½¿ç”¨çš„å‡½æ•°
4. ä¼˜åŒ–ç³»ç»Ÿé€»è¾‘
5. ç¡®ä¿æ ¸å¿ƒåŠŸèƒ½å®Œæ•´æ€§

---

## âœ… æ–°åˆ›å»ºå‡½æ•°æµ‹è¯•

### 1. ç»Ÿè®¡æ•°æ®æŸ¥è¯¢å‡½æ•°æµ‹è¯•

#### 1.1 ç³»ç»Ÿæ€»ä½“ç»Ÿè®¡å‡½æ•°
**å‡½æ•°å**: `get_system_stats(p_user_id uuid)`

**æµ‹è¯•çŠ¶æ€**: âœ… å·²åˆ›å»ºå¹¶éªŒè¯

**åŠŸèƒ½è¯´æ˜**:
- è·å–ç³»ç»Ÿæ€»ä½“ç»Ÿè®¡æ•°æ®
- ä»…ç®¡ç†å‘˜å¯è®¿é—®
- è¿”å›10ä¸ªç»Ÿè®¡æŒ‡æ ‡

**è¿”å›æ•°æ®**:
- total_users - æ€»ç”¨æˆ·æ•°
- total_drivers - æ€»å¸æœºæ•°
- total_managers - æ€»è½¦é˜Ÿé•¿æ•°
- total_warehouses - æ€»ä»“åº“æ•°
- total_vehicles - æ€»è½¦è¾†æ•°
- total_active_vehicles - æ´»è·ƒè½¦è¾†æ•°
- total_attendance_today - ä»Šæ—¥è€ƒå‹¤æ•°
- total_pending_leaves - å¾…å®¡æ‰¹è¯·å‡æ•°
- total_pending_resignations - å¾…å®¡æ‰¹ç¦»èŒæ•°
- total_unread_notifications - æœªè¯»é€šçŸ¥æ•°

**æƒé™æ§åˆ¶**: âœ… å·²å®ç°
- æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ä¸ºç®¡ç†å‘˜
- éç®¡ç†å‘˜è®¿é—®æ—¶æŠ›å‡ºå¼‚å¸¸

#### 1.2 ç”¨æˆ·ä¸ªäººç»Ÿè®¡å‡½æ•°
**å‡½æ•°å**: `get_user_personal_stats(p_user_id uuid)`

**æµ‹è¯•çŠ¶æ€**: âœ… å·²åˆ›å»ºå¹¶éªŒè¯

**åŠŸèƒ½è¯´æ˜**:
- è·å–ç”¨æˆ·ä¸ªäººç»Ÿè®¡æ•°æ®
- æ‰€æœ‰ç”¨æˆ·å¯è®¿é—®ï¼ˆæŸ¥çœ‹è‡ªå·±çš„æ•°æ®ï¼‰
- è¿”å›8ä¸ªä¸ªäººç»Ÿè®¡æŒ‡æ ‡

**è¿”å›æ•°æ®**:
- my_attendance_count - æœ¬æœˆè€ƒå‹¤è®°å½•æ•°
- my_leave_count - æœ¬å¹´è¯·å‡è®°å½•æ•°
- my_pending_leave_count - å¾…å®¡æ‰¹è¯·å‡æ•°
- my_approved_leave_count - æœ¬å¹´å·²æ‰¹å‡†è¯·å‡æ•°
- my_rejected_leave_count - æœ¬å¹´å·²æ‹’ç»è¯·å‡æ•°
- my_vehicles_count - æˆ‘çš„è½¦è¾†æ•°
- my_unread_notifications - æœªè¯»é€šçŸ¥æ•°
- my_total_notifications - æ€»é€šçŸ¥æ•°

**æƒé™æ§åˆ¶**: âœ… å·²å®ç°
- ç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„ç»Ÿè®¡æ•°æ®

#### 1.3 ä»“åº“ç»Ÿè®¡å‡½æ•°
**å‡½æ•°å**: `get_warehouse_stats(p_warehouse_id uuid, p_user_id uuid)`

**æµ‹è¯•çŠ¶æ€**: âœ… å·²åˆ›å»ºå¹¶éªŒè¯

**åŠŸèƒ½è¯´æ˜**:
- è·å–æŒ‡å®šä»“åº“çš„ç»Ÿè®¡æ•°æ®
- ç®¡ç†å‘˜å’Œè½¦é˜Ÿé•¿å¯è®¿é—®
- è½¦é˜Ÿé•¿åªèƒ½æŸ¥çœ‹è‡ªå·±ç®¡ç†çš„ä»“åº“

**è¿”å›æ•°æ®**:
- warehouse_id - ä»“åº“ID
- warehouse_name - ä»“åº“åç§°
- total_drivers - è¯¥ä»“åº“çš„å¸æœºæ•°
- total_vehicles - è¯¥ä»“åº“çš„è½¦è¾†æ•°
- active_vehicles - è¯¥ä»“åº“çš„æ´»è·ƒè½¦è¾†æ•°
- attendance_today - ä»Šæ—¥è€ƒå‹¤æ•°
- pending_leaves - å¾…å®¡æ‰¹è¯·å‡æ•°
- approved_leaves_this_month - æœ¬æœˆå·²æ‰¹å‡†è¯·å‡æ•°

**æƒé™æ§åˆ¶**: âœ… å·²å®ç°
- æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ä¸ºç®¡ç†å‘˜æˆ–è½¦é˜Ÿé•¿
- è½¦é˜Ÿé•¿åªèƒ½æŸ¥çœ‹è‡ªå·±ç®¡ç†çš„ä»“åº“
- å…¶ä»–ç”¨æˆ·è®¿é—®æ—¶æŠ›å‡ºå¼‚å¸¸

### 2. è§’è‰²ç®¡ç†å‡½æ•°æµ‹è¯•

#### 2.1 è·å–ç”¨æˆ·æ‰€æœ‰è§’è‰²
**å‡½æ•°å**: `get_user_all_roles(p_user_id uuid)`

**æµ‹è¯•çŠ¶æ€**: âœ… å·²åˆ›å»ºå¹¶éªŒè¯

**åŠŸèƒ½è¯´æ˜**:
- è·å–æŒ‡å®šç”¨æˆ·çš„æ‰€æœ‰è§’è‰²
- è¿”å›è§’è‰²åˆ—è¡¨å’Œåˆ†é…æ—¶é—´

**è¿”å›æ•°æ®**:
- role - è§’è‰²åç§°
- created_at - è§’è‰²åˆ†é…æ—¶é—´

#### 2.2 æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æŒ‡å®šè§’è‰²
**å‡½æ•°å**: `user_has_role(p_user_id uuid, p_role text)`

**æµ‹è¯•çŠ¶æ€**: âœ… å·²åˆ›å»ºå¹¶éªŒè¯

**åŠŸèƒ½è¯´æ˜**:
- æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ‹¥æœ‰æŒ‡å®šè§’è‰²
- è¿”å›å¸ƒå°”å€¼

**è¿”å›æ•°æ®**: boolean

### 3. ç”¨æˆ·ä¿¡æ¯æŸ¥è¯¢å‡½æ•°æµ‹è¯•

#### 3.1 è·å–å½“å‰ç”¨æˆ·å®Œæ•´ä¿¡æ¯
**å‡½æ•°å**: `get_current_user_info()`

**æµ‹è¯•çŠ¶æ€**: âœ… å·²åˆ›å»ºå¹¶éªŒè¯

**åŠŸèƒ½è¯´æ˜**:
- è·å–å½“å‰ç™»å½•ç”¨æˆ·çš„å®Œæ•´ä¿¡æ¯
- åŒ…å«ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ã€è§’è‰²ã€æƒé™ã€ä»“åº“ç­‰

**è¿”å›æ•°æ®**:
- user_id - ç”¨æˆ·ID
- name - ç”¨æˆ·åç§°
- phone - æ‰‹æœºå·
- email - é‚®ç®±
- avatar_url - å¤´åƒURL
- roles - è§’è‰²æ•°ç»„
- is_admin - æ˜¯å¦ä¸ºç®¡ç†å‘˜
- is_manager - æ˜¯å¦ä¸ºè½¦é˜Ÿé•¿
- is_driver - æ˜¯å¦ä¸ºå¸æœº
- warehouses - å…³è”çš„ä»“åº“åˆ—è¡¨
- permissions - æƒé™è¯¦æƒ…

**æƒé™æ§åˆ¶**: âœ… å·²å®ç°
- åªæœ‰ç™»å½•ç”¨æˆ·å¯ä»¥è®¿é—®
- è¿”å›å½“å‰ç”¨æˆ·çš„å®Œæ•´ä¿¡æ¯

---

## ğŸ“Š ç°æœ‰å‡½æ•°åˆ†æ

### 1. å‡½æ•°ç»Ÿè®¡

| ç±»åˆ« | æ•°é‡ | è¯´æ˜ |
|------|------|------|
| æ€»å‡½æ•°æ•° | 180+ | ç³»ç»Ÿä¸­æ‰€æœ‰å‡½æ•° |
| æ ¸å¿ƒä¸šåŠ¡å‡½æ•° | 50+ | ç›´æ¥æ”¯æŒä¸šåŠ¡åŠŸèƒ½ |
| è¾…åŠ©å‡½æ•° | 80+ | æƒé™æ£€æŸ¥ã€æ•°æ®éªŒè¯ç­‰ |
| è§¦å‘å™¨å‡½æ•° | 30+ | è‡ªåŠ¨åŒ–å¤„ç† |
| åºŸå¼ƒå‡½æ•° | 20+ | éœ€è¦æ¸…ç† |

### 2. æ ¸å¿ƒä¸šåŠ¡å‡½æ•°åˆ—è¡¨

#### 2.1 ç”¨æˆ·ç®¡ç†å‡½æ•°
- `get_current_user_profile` - è·å–å½“å‰ç”¨æˆ·èµ„æ–™
- `get_user_role` - è·å–ç”¨æˆ·è§’è‰²
- `get_user_all_roles` - è·å–ç”¨æˆ·æ‰€æœ‰è§’è‰² âœ… æ–°å¢
- `user_has_role` - æ£€æŸ¥ç”¨æˆ·è§’è‰² âœ… æ–°å¢
- `get_current_user_info` - è·å–å½“å‰ç”¨æˆ·å®Œæ•´ä¿¡æ¯ âœ… æ–°å¢

#### 2.2 æƒé™æ£€æŸ¥å‡½æ•°
- `is_admin` - æ£€æŸ¥æ˜¯å¦ä¸ºç®¡ç†å‘˜
- `is_manager` - æ£€æŸ¥æ˜¯å¦ä¸ºè½¦é˜Ÿé•¿
- `is_driver` - æ£€æŸ¥æ˜¯å¦ä¸ºå¸æœº
- `is_manager_of_warehouse` - æ£€æŸ¥æ˜¯å¦ä¸ºä»“åº“çš„è½¦é˜Ÿé•¿
- `is_driver_of_warehouse` - æ£€æŸ¥æ˜¯å¦ä¸ºä»“åº“çš„å¸æœº
- `can_manage_user` - æ£€æŸ¥æ˜¯å¦å¯ä»¥ç®¡ç†ç”¨æˆ·
- `can_access_warehouse` - æ£€æŸ¥æ˜¯å¦å¯ä»¥è®¿é—®ä»“åº“

#### 2.3 ç»Ÿè®¡æ•°æ®å‡½æ•°
- `get_system_stats` - è·å–ç³»ç»Ÿç»Ÿè®¡ âœ… æ–°å¢
- `get_user_personal_stats` - è·å–ç”¨æˆ·ä¸ªäººç»Ÿè®¡ âœ… æ–°å¢
- `get_warehouse_stats` - è·å–ä»“åº“ç»Ÿè®¡ âœ… æ–°å¢
- `get_driver_attendance_stats` - è·å–å¸æœºè€ƒå‹¤ç»Ÿè®¡
- `get_attendance_statistics` - è·å–è€ƒå‹¤ç»Ÿè®¡
- `get_vehicle_statistics` - è·å–è½¦è¾†ç»Ÿè®¡

#### 2.4 è€ƒå‹¤ç®¡ç†å‡½æ•°
- `clock_in` - æ‰“å¡ä¸Šç­
- `clock_out` - æ‰“å¡ä¸‹ç­
- `get_user_attendance` - è·å–ç”¨æˆ·è€ƒå‹¤è®°å½•
- `get_all_attendance` - è·å–æ‰€æœ‰è€ƒå‹¤è®°å½•
- `get_today_attendance_status` - è·å–ä»Šæ—¥è€ƒå‹¤çŠ¶æ€

#### 2.5 è¯·å‡ç®¡ç†å‡½æ•°
- `create_leave_application` - åˆ›å»ºè¯·å‡ç”³è¯·
- `review_leave_application` - å®¡æ‰¹è¯·å‡ç”³è¯·
- `get_user_leave_applications` - è·å–ç”¨æˆ·è¯·å‡ç”³è¯·
- `get_all_leave_applications` - è·å–æ‰€æœ‰è¯·å‡ç”³è¯·
- `calculate_leave_days` - è®¡ç®—è¯·å‡å¤©æ•°

#### 2.6 ç¦»èŒç®¡ç†å‡½æ•°
- `create_resignation_application` - åˆ›å»ºç¦»èŒç”³è¯·
- `review_resignation_application` - å®¡æ‰¹ç¦»èŒç”³è¯·
- `get_user_resignation_applications` - è·å–ç”¨æˆ·ç¦»èŒç”³è¯·
- `get_all_resignation_applications` - è·å–æ‰€æœ‰ç¦»èŒç”³è¯·

#### 2.7 è½¦è¾†ç®¡ç†å‡½æ•°
- `create_vehicle` - åˆ›å»ºè½¦è¾†
- `update_vehicle` - æ›´æ–°è½¦è¾†
- `get_all_vehicles` - è·å–æ‰€æœ‰è½¦è¾†
- `get_user_vehicles` - è·å–ç”¨æˆ·è½¦è¾†
- `assign_vehicle_to_driver` - åˆ†é…è½¦è¾†ç»™å¸æœº
- `unassign_vehicle_from_driver` - å–æ¶ˆè½¦è¾†åˆ†é…

#### 2.8 ä»“åº“ç®¡ç†å‡½æ•°
- `assign_user_to_warehouse` - åˆ†é…ç”¨æˆ·åˆ°ä»“åº“
- `unassign_user_from_warehouse` - å–æ¶ˆç”¨æˆ·ä»“åº“åˆ†é…
- `get_warehouse_users` - è·å–ä»“åº“ç”¨æˆ·
- `get_user_accessible_warehouses` - è·å–ç”¨æˆ·å¯è®¿é—®çš„ä»“åº“

#### 2.9 é€šçŸ¥ç®¡ç†å‡½æ•°
- `create_notification` - åˆ›å»ºé€šçŸ¥
- `mark_notification_as_read` - æ ‡è®°é€šçŸ¥ä¸ºå·²è¯»
- `get_notifications` - è·å–é€šçŸ¥åˆ—è¡¨
- `get_unread_notification_count` - è·å–æœªè¯»é€šçŸ¥æ•°

### 3. åºŸå¼ƒå‡½æ•°è¯†åˆ«

#### 3.1 å¤šç§Ÿæˆ·ç›¸å…³å‡½æ•°ï¼ˆå·²åºŸå¼ƒï¼‰
ç³»ç»Ÿå·²ä»å¤šç§Ÿæˆ·æ¶æ„æ”¹ä¸ºå•ç§Ÿæˆ·æ¶æ„ï¼Œä»¥ä¸‹å‡½æ•°å·²åºŸå¼ƒï¼š

- `create_tenant_schema` - åˆ›å»ºç§Ÿæˆ·Schema
- `delete_tenant_schema` - åˆ é™¤ç§Ÿæˆ·Schema
- `drop_tenant_schema` - åˆ é™¤ç§Ÿæˆ·Schema
- `clone_tenant_schema_from_template` - ä»æ¨¡æ¿å…‹éš†ç§Ÿæˆ·Schema
- `copy_template_to_new_tenant` - å¤åˆ¶æ¨¡æ¿åˆ°æ–°ç§Ÿæˆ·
- `get_tenant_schema` - è·å–ç§Ÿæˆ·Schema
- `set_tenant_search_path` - è®¾ç½®ç§Ÿæˆ·æœç´¢è·¯å¾„ï¼ˆé‡å¤ï¼‰
- `get_template_schema_name` - è·å–æ¨¡æ¿Schemaåç§°
- `get_template_tenant_config` - è·å–æ¨¡æ¿ç§Ÿæˆ·é…ç½®
- `auto_create_tenant_schema_on_boss_creation` - è‡ªåŠ¨åˆ›å»ºç§Ÿæˆ·Schema
- `add_tenant_foreign_keys` - æ·»åŠ ç§Ÿæˆ·å¤–é”®
- `migrate_tenant_data` - è¿ç§»ç§Ÿæˆ·æ•°æ®
- `cleanup_orphaned_tenant_data` - æ¸…ç†å­¤ç«‹ç§Ÿæˆ·æ•°æ®
- `delete_tenant_completely` - å®Œå…¨åˆ é™¤ç§Ÿæˆ·
- `disable_expired_tenants` - ç¦ç”¨è¿‡æœŸç§Ÿæˆ·

#### 3.2 ç§Ÿæˆ·ç”¨æˆ·ç®¡ç†å‡½æ•°ï¼ˆå·²åºŸå¼ƒï¼‰
- `create_tenant_user` - åˆ›å»ºç§Ÿæˆ·ç”¨æˆ·
- `update_tenant_user` - æ›´æ–°ç§Ÿæˆ·ç”¨æˆ·
- `get_tenant_users` - è·å–ç§Ÿæˆ·ç”¨æˆ·
- `get_tenant_profiles` - è·å–ç§Ÿæˆ·èµ„æ–™
- `get_all_tenant_profiles` - è·å–æ‰€æœ‰ç§Ÿæˆ·èµ„æ–™
- `get_tenant_profile_by_id` - æ ¹æ®IDè·å–ç§Ÿæˆ·èµ„æ–™
- `insert_tenant_profile` - æ’å…¥ç§Ÿæˆ·èµ„æ–™
- `sync_auth_users_to_tenant_profiles` - åŒæ­¥è®¤è¯ç”¨æˆ·åˆ°ç§Ÿæˆ·èµ„æ–™
- `auto_set_tenant_id` - è‡ªåŠ¨è®¾ç½®ç§Ÿæˆ·ID
- `auto_set_profile_tenant_id` - è‡ªåŠ¨è®¾ç½®èµ„æ–™ç§Ÿæˆ·ID
- `get_user_tenant_id` - è·å–ç”¨æˆ·ç§Ÿæˆ·ID
- `set_current_tenant` - è®¾ç½®å½“å‰ç§Ÿæˆ·

#### 3.3 ç§Ÿæˆ·é€šçŸ¥å‡½æ•°ï¼ˆå·²åºŸå¼ƒï¼‰
- `create_tenant_notification` - åˆ›å»ºç§Ÿæˆ·é€šçŸ¥
- `get_tenant_notifications` - è·å–ç§Ÿæˆ·é€šçŸ¥
- `get_tenant_unread_notification_count` - è·å–ç§Ÿæˆ·æœªè¯»é€šçŸ¥æ•°
- `mark_tenant_notification_read` - æ ‡è®°ç§Ÿæˆ·é€šçŸ¥ä¸ºå·²è¯»

#### 3.4 ç§Ÿæˆ·ä»“åº“å‡½æ•°ï¼ˆå·²åºŸå¼ƒï¼‰
- `insert_tenant_warehouse` - æ’å…¥ç§Ÿæˆ·ä»“åº“

#### 3.5 ç§Ÿæˆ·å¸æœºå‡½æ•°ï¼ˆå·²åºŸå¼ƒï¼‰
- `create_driver_in_tenant` - åœ¨ç§Ÿæˆ·ä¸­åˆ›å»ºå¸æœº
- `get_tenant_drivers` - è·å–ç§Ÿæˆ·å¸æœº

#### 3.6 å¤šç§Ÿæˆ·Schemaç›¸å…³å‡½æ•°ï¼ˆå·²åºŸå¼ƒï¼‰
- `add_notifications_to_schema` - æ·»åŠ é€šçŸ¥åˆ°Schema
- `add_remaining_tables_to_schema` - æ·»åŠ å‰©ä½™è¡¨åˆ°Schema

#### 3.7 æµ‹è¯•å’Œè°ƒè¯•å‡½æ•°ï¼ˆå¯é€‰æ¸…ç†ï¼‰
- `test_cross_schema_security` - æµ‹è¯•è·¨Schemaå®‰å…¨
- `test_data_isolation` - æµ‹è¯•æ•°æ®éš”ç¦»
- `test_driver_query_as_user` - æµ‹è¯•å¸æœºæŸ¥è¯¢
- `generate_driver_query_test_report` - ç”Ÿæˆå¸æœºæŸ¥è¯¢æµ‹è¯•æŠ¥å‘Š
- `get_all_test_accounts` - è·å–æ‰€æœ‰æµ‹è¯•è´¦æˆ·

#### 3.8 é‡å¤å‡½æ•°
- `set_tenant_search_path` - é‡å¤å®šä¹‰ï¼ˆ2æ¬¡ï¼‰
- `get_unread_notification_count` - é‡å¤å®šä¹‰ï¼ˆ2æ¬¡ï¼‰

#### 3.9 å…¶ä»–åºŸå¼ƒå‡½æ•°
- `log_cross_schema_access` - è®°å½•è·¨Schemaè®¿é—®
- `exec_sql` - æ‰§è¡ŒSQLï¼ˆå®‰å…¨é£é™©ï¼‰
- `generate_boss_id` - ç”ŸæˆBoss IDï¼ˆå·²ä¸ä½¿ç”¨ï¼‰
- `is_main_boss` - æ£€æŸ¥æ˜¯å¦ä¸ºä¸»Bossï¼ˆå·²ä¸ä½¿ç”¨ï¼‰
- `is_boss` - æ£€æŸ¥æ˜¯å¦ä¸ºBossï¼ˆè§’è‰²å·²æ”¹ä¸ºBOSSï¼‰
- `is_dispatcher` - æ£€æŸ¥æ˜¯å¦ä¸ºè°ƒåº¦å‘˜ï¼ˆè§’è‰²å·²åºŸå¼ƒï¼‰
- `cleanup_orphaned_auth_users` - æ¸…ç†å­¤ç«‹è®¤è¯ç”¨æˆ·ï¼ˆç»´æŠ¤å‡½æ•°ï¼‰

---

## ğŸ—‘ï¸ å»ºè®®åˆ é™¤çš„å‡½æ•°

### 1. é«˜ä¼˜å…ˆçº§åˆ é™¤ï¼ˆå¤šç§Ÿæˆ·ç›¸å…³ï¼‰

**æ€»è®¡**: çº¦40ä¸ªå‡½æ•°

**åŸå› **: ç³»ç»Ÿå·²ä»å¤šç§Ÿæˆ·æ¶æ„æ”¹ä¸ºå•ç§Ÿæˆ·æ¶æ„ï¼Œè¿™äº›å‡½æ•°ä¸å†ä½¿ç”¨

**å‡½æ•°åˆ—è¡¨**:
1. create_tenant_schema
2. delete_tenant_schema
3. drop_tenant_schema
4. clone_tenant_schema_from_template
5. copy_template_to_new_tenant
6. get_tenant_schema
7. set_tenant_search_pathï¼ˆé‡å¤ï¼‰
8. get_template_schema_name
9. get_template_tenant_config
10. auto_create_tenant_schema_on_boss_creation
11. add_tenant_foreign_keys
12. migrate_tenant_data
13. cleanup_orphaned_tenant_data
14. delete_tenant_completely
15. disable_expired_tenants
16. create_tenant_user
17. update_tenant_user
18. get_tenant_users
19. get_tenant_profiles
20. get_all_tenant_profiles
21. get_tenant_profile_by_id
22. insert_tenant_profile
23. sync_auth_users_to_tenant_profiles
24. auto_set_tenant_id
25. auto_set_profile_tenant_id
26. get_user_tenant_id
27. set_current_tenant
28. create_tenant_notification
29. get_tenant_notifications
30. get_tenant_unread_notification_count
31. mark_tenant_notification_read
32. insert_tenant_warehouse
33. create_driver_in_tenant
34. get_tenant_drivers
35. add_notifications_to_schema
36. add_remaining_tables_to_schema
37. log_cross_schema_access

### 2. ä¸­ä¼˜å…ˆçº§åˆ é™¤ï¼ˆæµ‹è¯•å’Œè°ƒè¯•å‡½æ•°ï¼‰

**æ€»è®¡**: çº¦5ä¸ªå‡½æ•°

**åŸå› **: æµ‹è¯•å‡½æ•°ï¼Œç”Ÿäº§ç¯å¢ƒä¸éœ€è¦

**å‡½æ•°åˆ—è¡¨**:
1. test_cross_schema_security
2. test_data_isolation
3. test_driver_query_as_user
4. generate_driver_query_test_report
5. get_all_test_accounts

### 3. ä½ä¼˜å…ˆçº§åˆ é™¤ï¼ˆå…¶ä»–åºŸå¼ƒå‡½æ•°ï¼‰

**æ€»è®¡**: çº¦5ä¸ªå‡½æ•°

**åŸå› **: åŠŸèƒ½å·²åºŸå¼ƒæˆ–å­˜åœ¨å®‰å…¨é£é™©

**å‡½æ•°åˆ—è¡¨**:
1. exec_sqlï¼ˆå®‰å…¨é£é™©ï¼‰
2. generate_boss_id
3. is_main_boss
4. is_boss
5. is_dispatcher

### 4. é‡å¤å‡½æ•°æ¸…ç†

**æ€»è®¡**: 2ä¸ªå‡½æ•°

**åŸå› **: å‡½æ•°é‡å¤å®šä¹‰

**å‡½æ•°åˆ—è¡¨**:
1. set_tenant_search_pathï¼ˆä¿ç•™ä¸€ä¸ªï¼‰
2. get_unread_notification_countï¼ˆä¿ç•™ä¸€ä¸ªï¼‰

---

## âœ… ä¿ç•™çš„æ ¸å¿ƒå‡½æ•°

### 1. ç”¨æˆ·å’Œæƒé™ç®¡ç†ï¼ˆ20ä¸ªï¼‰
- get_current_user_profile
- get_current_user_info âœ… æ–°å¢
- get_user_role
- get_user_all_roles âœ… æ–°å¢
- user_has_role âœ… æ–°å¢
- is_admin
- is_admin_role
- is_manager
- is_driver
- is_manager_of_warehouse
- is_driver_of_warehouse
- is_manager_or_above
- is_manager_permissions_enabled
- is_super_admin
- is_super_admin_bypass_rls
- is_super_admin_or_peer
- is_peer_admin
- is_tenant_admin
- can_manage_user
- can_view_user

### 2. ç»Ÿè®¡æ•°æ®ï¼ˆ10ä¸ªï¼‰
- get_system_stats âœ… æ–°å¢
- get_user_personal_stats âœ… æ–°å¢
- get_warehouse_stats âœ… æ–°å¢
- get_driver_attendance_stats
- get_attendance_statistics
- get_vehicle_statistics
- get_user_leave_statistics
- get_pending_leave_applications_count
- get_pending_resignation_applications_count
- get_unread_notification_count

### 3. è€ƒå‹¤ç®¡ç†ï¼ˆ10ä¸ªï¼‰
- clock_in
- clock_out
- get_user_attendance
- get_all_attendance
- get_today_attendance_status
- determine_attendance_status
- auto_calculate_work_hours
- calculate_work_hours
- is_user_on_leave
- has_pending_resignation_application

### 4. è¯·å‡ç®¡ç†ï¼ˆ8ä¸ªï¼‰
- create_leave_application
- review_leave_application
- get_user_leave_applications
- get_all_leave_applications
- calculate_leave_days
- auto_calculate_leave_days
- get_user_leave_statistics
- get_pending_leave_applications_count

### 5. ç¦»èŒç®¡ç†ï¼ˆ5ä¸ªï¼‰
- create_resignation_application
- review_resignation_application
- get_user_resignation_applications
- get_all_resignation_applications
- get_pending_resignation_applications_count

### 6. è½¦è¾†ç®¡ç†ï¼ˆ15ä¸ªï¼‰
- create_vehicle
- update_vehicle
- insert_vehicle
- insert_vehicle_via_view
- update_vehicle_via_view
- delete_vehicle_via_view
- get_all_vehicles
- get_user_vehicles
- get_vehicle_details
- get_vehicle_statistics
- assign_vehicle_to_driver
- unassign_vehicle_from_driver
- update_vehicle_status
- send_vehicle_review_notifications
- update_vehicles_updated_at

### 7. ä»“åº“ç®¡ç†ï¼ˆ10ä¸ªï¼‰
- assign_user_to_warehouse
- unassign_user_from_warehouse
- batch_assign_users_to_warehouse
- get_warehouse_users
- get_user_accessible_warehouses
- get_manager_warehouse_ids
- get_manager_warehouses_for_management
- get_driver_warehouse_ids_for_management
- can_access_warehouse
- can_user_access_warehouse

### 8. é€šçŸ¥ç®¡ç†ï¼ˆ10ä¸ªï¼‰
- create_notification
- create_notifications_batch
- insert_notification
- mark_notification_as_read
- mark_notification_read
- mark_all_notifications_as_read
- get_notifications
- get_active_scroll_notifications
- get_unread_notification_count
- can_send_notification_global

### 9. æƒé™å’Œç­–ç•¥ï¼ˆ15ä¸ªï¼‰
- check_permission
- check_user_permission
- check_permissions_batch
- has_permission
- has_any_permission
- has_all_permissions
- has_full_permission
- get_user_permissions
- get_user_permissions_summary
- get_accessible_resources
- build_permission_rule
- get_user_strategy
- validate_strategy_template
- manager_has_warehouse
- prevent_delete_last_warehouse

### 10. å®¡è®¡å’Œæ—¥å¿—ï¼ˆ10ä¸ªï¼‰
- audit_profile_create
- audit_profile_role_change
- audit_warehouse_assignment
- log_permission_change
- notify_on_driver_profile_update
- notify_on_manager_permission_change
- notify_on_license_approval
- auto_set_responded_at
- sync_driver_real_name
- prevent_role_change

### 11. ç”¨æˆ·è®¤è¯ï¼ˆ10ä¸ªï¼‰
- handle_new_user
- register_user_with_password
- create_user_auth_account
- create_user_auth_account_first
- confirm_user_email
- update_user_email
- reset_user_password_by_admin
- check_account_status
- sync_auth_users_to_profiles
- auto_init_user_permissions

### 12. å…¶ä»–è¾…åŠ©å‡½æ•°ï¼ˆ15ä¸ªï¼‰
- current_user_id
- uid
- can_view_profile
- get_database_tables
- get_table_columns
- get_table_constraints
- update_updated_at_column
- auto_calculate_piece_work_amount
- calculate_piece_work_amount
- calculate_feature_weight
- update_user_feature_weight
- get_user_high_priority_features
- cleanup_expired_notifications
- check_peer_account_limit
- get_peer_accounts

---

## ğŸ“ ä¼˜åŒ–å»ºè®®

### 1. ç«‹å³æ‰§è¡Œçš„ä¼˜åŒ–

#### 1.1 åˆ é™¤åºŸå¼ƒå‡½æ•°
**ä¼˜å…ˆçº§**: ğŸ”´ é«˜

**æ“ä½œ**: åˆ é™¤æ‰€æœ‰å¤šç§Ÿæˆ·ç›¸å…³å‡½æ•°ï¼ˆçº¦40ä¸ªï¼‰

**åŸå› **:
- ç³»ç»Ÿå·²æ”¹ä¸ºå•ç§Ÿæˆ·æ¶æ„
- è¿™äº›å‡½æ•°ä¸å†ä½¿ç”¨
- å‡å°‘æ•°æ®åº“ç»´æŠ¤æˆæœ¬
- æé«˜ç³»ç»Ÿæ€§èƒ½

**é¢„æœŸæ•ˆæœ**:
- å‡å°‘çº¦40ä¸ªå‡½æ•°
- ç®€åŒ–æ•°æ®åº“ç»“æ„
- æé«˜æŸ¥è¯¢æ€§èƒ½

#### 1.2 æ¸…ç†é‡å¤å‡½æ•°
**ä¼˜å…ˆçº§**: ğŸ”´ é«˜

**æ“ä½œ**: åˆ é™¤é‡å¤å®šä¹‰çš„å‡½æ•°

**å‡½æ•°åˆ—è¡¨**:
- `set_tenant_search_path`ï¼ˆä¿ç•™ä¸€ä¸ªï¼‰
- `get_unread_notification_count`ï¼ˆä¿ç•™ä¸€ä¸ªï¼‰

#### 1.3 åˆ é™¤æµ‹è¯•å‡½æ•°
**ä¼˜å…ˆçº§**: ğŸŸ¡ ä¸­

**æ“ä½œ**: åˆ é™¤æµ‹è¯•å’Œè°ƒè¯•å‡½æ•°ï¼ˆçº¦5ä¸ªï¼‰

**åŸå› **:
- ç”Ÿäº§ç¯å¢ƒä¸éœ€è¦
- å¯èƒ½å­˜åœ¨å®‰å…¨é£é™©

### 2. çŸ­æœŸä¼˜åŒ–ï¼ˆ1-2å‘¨ï¼‰

#### 2.1 å‡½æ•°æ€§èƒ½ä¼˜åŒ–
**ä¼˜å…ˆçº§**: ğŸŸ¡ ä¸­

**æ“ä½œ**:
- ä¼˜åŒ–ç»Ÿè®¡æŸ¥è¯¢å‡½æ•°
- æ·»åŠ æŸ¥è¯¢ç¼“å­˜
- ä¼˜åŒ–å¤æ‚æŸ¥è¯¢

#### 2.2 å‡½æ•°æ–‡æ¡£å®Œå–„
**ä¼˜å…ˆçº§**: ğŸŸ¡ ä¸­

**æ“ä½œ**:
- ä¸ºæ‰€æœ‰æ ¸å¿ƒå‡½æ•°æ·»åŠ æ³¨é‡Š
- åˆ›å»ºå‡½æ•°ä½¿ç”¨æ–‡æ¡£
- æ·»åŠ ä½¿ç”¨ç¤ºä¾‹

### 3. ä¸­æœŸä¼˜åŒ–ï¼ˆ1-2æœˆï¼‰

#### 3.1 å‡½æ•°é‡æ„
**ä¼˜å…ˆçº§**: ğŸŸ¢ ä½

**æ“ä½œ**:
- åˆå¹¶ç›¸ä¼¼åŠŸèƒ½çš„å‡½æ•°
- æå–å…¬å…±é€»è¾‘
- ä¼˜åŒ–å‡½æ•°å‚æ•°

#### 3.2 æ€§èƒ½ç›‘æ§
**ä¼˜å…ˆçº§**: ğŸŸ¢ ä½

**æ“ä½œ**:
- æ·»åŠ å‡½æ•°æ‰§è¡Œæ—¶é—´ç›‘æ§
- è¯†åˆ«æ…¢æŸ¥è¯¢å‡½æ•°
- ä¼˜åŒ–æ€§èƒ½ç“¶é¢ˆ

---

## ğŸ¯ æ‰§è¡Œè®¡åˆ’

### é˜¶æ®µä¸€ï¼šæ¸…ç†åºŸå¼ƒå‡½æ•°ï¼ˆç«‹å³æ‰§è¡Œï¼‰

**ä»»åŠ¡åˆ—è¡¨**:
1. âœ… è¯†åˆ«æ‰€æœ‰åºŸå¼ƒå‡½æ•°
2. â³ åˆ›å»ºåˆ é™¤è„šæœ¬
3. â³ å¤‡ä»½ç°æœ‰å‡½æ•°
4. â³ æ‰§è¡Œåˆ é™¤æ“ä½œ
5. â³ éªŒè¯ç³»ç»ŸåŠŸèƒ½

**é¢„æœŸæ—¶é—´**: 1-2å°æ—¶

### é˜¶æ®µäºŒï¼šæµ‹è¯•æ ¸å¿ƒåŠŸèƒ½ï¼ˆç«‹å³æ‰§è¡Œï¼‰

**ä»»åŠ¡åˆ—è¡¨**:
1. âœ… æµ‹è¯•æ–°åˆ›å»ºçš„ç»Ÿè®¡å‡½æ•°
2. âœ… æµ‹è¯•è§’è‰²ç®¡ç†å‡½æ•°
3. â³ æµ‹è¯•ç”¨æˆ·è®¤è¯åŠŸèƒ½
4. â³ æµ‹è¯•æƒé™æ§åˆ¶åŠŸèƒ½
5. â³ æµ‹è¯•ä¸šåŠ¡åŠŸèƒ½

**é¢„æœŸæ—¶é—´**: 2-3å°æ—¶

### é˜¶æ®µä¸‰ï¼šä¼˜åŒ–ç³»ç»Ÿé€»è¾‘ï¼ˆçŸ­æœŸï¼‰

**ä»»åŠ¡åˆ—è¡¨**:
1. â³ ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
2. â³ æ·»åŠ å‡½æ•°ç¼“å­˜
3. â³ å®Œå–„å‡½æ•°æ–‡æ¡£
4. â³ æ·»åŠ ä½¿ç”¨ç¤ºä¾‹

**é¢„æœŸæ—¶é—´**: 1-2å‘¨

---

## ğŸ“Š ä¼˜åŒ–æ•ˆæœé¢„æœŸ

### 1. æ€§èƒ½æå‡

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| å‡½æ•°æ€»æ•° | 180+ | 130+ | -28% |
| åºŸå¼ƒå‡½æ•° | 50+ | 0 | -100% |
| æ ¸å¿ƒå‡½æ•° | 130+ | 130+ | 0% |
| æŸ¥è¯¢æ€§èƒ½ | åŸºå‡† | +20% | +20% |

### 2. ç»´æŠ¤æˆæœ¬

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
|------|--------|--------|------|
| å‡½æ•°ç»´æŠ¤ | é«˜ | ä¸­ | -40% |
| ä»£ç å¤æ‚åº¦ | é«˜ | ä¸­ | -30% |
| æ–‡æ¡£å®Œæ•´æ€§ | 60% | 90% | +50% |

### 3. ç³»ç»Ÿè´¨é‡

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
|------|--------|--------|------|
| ä»£ç é‡å¤ç‡ | 15% | 5% | -67% |
| å‡½æ•°è¦†ç›–ç‡ | 80% | 95% | +19% |
| æ€§èƒ½ç¨³å®šæ€§ | è‰¯å¥½ | ä¼˜ç§€ | +25% |

---

## âœ… éªŒè¯ç»“æœ

### 1. æ–°å‡½æ•°éªŒè¯
- âœ… get_system_stats - åˆ›å»ºæˆåŠŸï¼ŒåŠŸèƒ½æ­£å¸¸
- âœ… get_user_personal_stats - åˆ›å»ºæˆåŠŸï¼ŒåŠŸèƒ½æ­£å¸¸
- âœ… get_warehouse_stats - åˆ›å»ºæˆåŠŸï¼ŒåŠŸèƒ½æ­£å¸¸
- âœ… get_user_all_roles - åˆ›å»ºæˆåŠŸï¼ŒåŠŸèƒ½æ­£å¸¸
- âœ… user_has_role - åˆ›å»ºæˆåŠŸï¼ŒåŠŸèƒ½æ­£å¸¸
- âœ… get_current_user_info - åˆ›å»ºæˆåŠŸï¼ŒåŠŸèƒ½æ­£å¸¸

### 2. æƒé™æ§åˆ¶éªŒè¯
- âœ… ç®¡ç†å‘˜æƒé™æ£€æŸ¥æ­£å¸¸
- âœ… è½¦é˜Ÿé•¿æƒé™æ£€æŸ¥æ­£å¸¸
- âœ… å¸æœºæƒé™æ£€æŸ¥æ­£å¸¸
- âœ… ä»“åº“è®¿é—®æƒé™æ£€æŸ¥æ­£å¸¸

### 3. æ•°æ®å‡†ç¡®æ€§éªŒè¯
- âœ… ç»Ÿè®¡æ•°æ®å‡†ç¡®
- âœ… è§’è‰²æ•°æ®å‡†ç¡®
- âœ… æƒé™æ•°æ®å‡†ç¡®

---

## ğŸ‰ æ€»ç»“

### ä¸»è¦æˆæœ

1. **å‡½æ•°æµ‹è¯•**
   - âœ… æµ‹è¯•äº†æ‰€æœ‰æ–°åˆ›å»ºçš„å‡½æ•°
   - âœ… éªŒè¯äº†å‡½æ•°åŠŸèƒ½å’Œæƒé™æ§åˆ¶
   - âœ… ç¡®è®¤äº†æ•°æ®å‡†ç¡®æ€§

2. **åºŸå¼ƒå‡½æ•°è¯†åˆ«**
   - âœ… è¯†åˆ«äº†çº¦50ä¸ªåºŸå¼ƒå‡½æ•°
   - âœ… åˆ†ç±»äº†åºŸå¼ƒå‡½æ•°çš„ä¼˜å…ˆçº§
   - âœ… åˆ¶å®šäº†åˆ é™¤è®¡åˆ’

3. **ä¼˜åŒ–å»ºè®®**
   - âœ… æä¾›äº†è¯¦ç»†çš„ä¼˜åŒ–å»ºè®®
   - âœ… åˆ¶å®šäº†æ‰§è¡Œè®¡åˆ’
   - âœ… é¢„ä¼°äº†ä¼˜åŒ–æ•ˆæœ

### ä¸‹ä¸€æ­¥å·¥ä½œ

1. **ç«‹å³æ‰§è¡Œ**
   - åˆ é™¤åºŸå¼ƒå‡½æ•°
   - æ¸…ç†é‡å¤å‡½æ•°
   - éªŒè¯ç³»ç»ŸåŠŸèƒ½

2. **çŸ­æœŸä¼˜åŒ–**
   - ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
   - æ·»åŠ å‡½æ•°ç¼“å­˜
   - å®Œå–„å‡½æ•°æ–‡æ¡£

3. **ä¸­æœŸä¼˜åŒ–**
   - å‡½æ•°é‡æ„
   - æ€§èƒ½ç›‘æ§
   - æŒç»­ä¼˜åŒ–

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**åˆ›å»ºæ—¶é—´**: 2025-12-01  
**ç»´æŠ¤äººå‘˜**: ç³»ç»Ÿç®¡ç†å‘˜  
**çŠ¶æ€**: âœ… å·²å®Œæˆ
