{
  "summary": {
    "total": 47,
    "passed": 42,
    "failed": 5,
    "passRate": "89.4%",
    "timestamp": "2025-12-03T11:24:17.391Z"
  },
  "tests": [
    {
      "category": "数据库结构",
      "name": "users 表",
      "description": "用户表 - 存储用户基本信息和角色",
      "passed": true,
      "testData": {
        "tableName": "users",
        "hasData": true
      },
      "error": null,
      "timestamp": "2025-12-03T11:24:05.490Z"
    },
    {
      "category": "数据库结构",
      "name": "warehouses 表",
      "description": "仓库表 - 存储仓库信息",
      "passed": true,
      "testData": {
        "tableName": "warehouses",
        "hasData": true
      },
      "error": null,
      "timestamp": "2025-12-03T11:24:05.600Z"
    },
    {
      "category": "数据库结构",
      "name": "warehouse_assignments 表",
      "description": "仓库分配表 - 关联用户和仓库",
      "passed": true,
      "testData": {
        "tableName": "warehouse_assignments",
        "hasData": false
      },
      "error": null,
      "timestamp": "2025-12-03T11:24:05.692Z"
    },
    {
      "category": "数据库结构",
      "name": "vehicles 表",
      "description": "车辆表 - 存储车辆信息",
      "passed": true,
      "testData": {
        "tableName": "vehicles",
        "hasData": false
      },
      "error": null,
      "timestamp": "2025-12-03T11:24:05.922Z"
    },
    {
      "category": "数据库结构",
      "name": "attendance 表",
      "description": "考勤表 - 记录打卡数据",
      "passed": true,
      "testData": {
        "tableName": "attendance",
        "hasData": true
      },
      "error": null,
      "timestamp": "2025-12-03T11:24:06.017Z"
    },
    {
      "category": "数据库结构",
      "name": "leave_applications 表",
      "description": "请假申请表 - 管理请假流程",
      "passed": true,
      "testData": {
        "tableName": "leave_applications",
        "hasData": false
      },
      "error": null,
      "timestamp": "2025-12-03T11:24:06.120Z"
    },
    {
      "category": "数据库结构",
      "name": "piece_work_records 表",
      "description": "计件记录表 - 记录工作量",
      "passed": true,
      "testData": {
        "tableName": "piece_work_records",
        "hasData": false
      },
      "error": null,
      "timestamp": "2025-12-03T11:24:06.213Z"
    },
    {
      "category": "数据库结构",
      "name": "notifications 表",
      "description": "通知表 - 系统消息推送",
      "passed": true,
      "testData": {
        "tableName": "notifications",
        "hasData": false
      },
      "error": null,
      "timestamp": "2025-12-03T11:24:06.295Z"
    },
    {
      "category": "数据库结构",
      "name": "用户角色枚举",
      "description": "验证 user_role 枚举类型定义（BOSS, PEER_ADMIN, MANAGER, DRIVER 等）",
      "passed": true,
      "testData": {
        "enumValues": [
          "BOSS",
          "PEER_ADMIN",
          "MANAGER",
          "DRIVER"
        ]
      },
      "error": null,
      "timestamp": "2025-12-03T11:24:06.385Z"
    },
    {
      "category": "用户认证",
      "name": "老板登录",
      "description": "最高权限角色，可管理所有功能",
      "passed": true,
      "testData": {
        "userId": "8a927ad9-f6b7-4794-a594-3f59b810496c",
        "email": "13800000001@phone.local",
        "expectedRole": "BOSS",
        "actualRole": "BOSS",
        "userName": "老板admin",
        "userPhone": "13800000001"
      },
      "error": null,
      "timestamp": "2025-12-03T11:24:06.670Z"
    },
    {
      "category": "用户认证",
      "name": "调度登录",
      "description": "调度管理角色，管理仓库和人员分配",
      "passed": true,
      "testData": {
        "userId": "d59b8140-d70b-4d19-aef7-685450ca73d2",
        "email": "13800000002@phone.local",
        "expectedRole": "PEER_ADMIN",
        "actualRole": "PEER_ADMIN",
        "userName": "调度admin1",
        "userPhone": "13800000002"
      },
      "error": null,
      "timestamp": "2025-12-03T11:24:07.022Z"
    },
    {
      "category": "用户认证",
      "name": "车队长登录",
      "description": "车队管理角色，管理司机和车辆",
      "passed": true,
      "testData": {
        "userId": "8a0a9af4-d137-48c0-9159-0b3d586b5498",
        "email": "13800000003@phone.local",
        "expectedRole": "MANAGER",
        "actualRole": "MANAGER",
        "userName": "车队长admin2",
        "userPhone": "13800000003"
      },
      "error": null,
      "timestamp": "2025-12-03T11:24:07.356Z"
    },
    {
      "category": "用户认证",
      "name": "司机登录",
      "description": "司机角色，记录考勤和工作量",
      "passed": true,
      "testData": {
        "userId": "781db950-91bd-4149-b34f-136bb1d53d58",
        "email": "13800000004@phone.local",
        "expectedRole": "DRIVER",
        "actualRole": "DRIVER",
        "userName": "司机admin3",
        "userPhone": "13800000004"
      },
      "error": null,
      "timestamp": "2025-12-03T11:24:07.696Z"
    },
    {
      "category": "仓库管理",
      "name": "获取仓库列表",
      "description": "测试 SELECT 权限和数据完整性",
      "passed": true,
      "testData": {
        "warehouseCount": 2,
        "warehouses": [
          {
            "id": "306f4173-bdd5-4050-b7a3-7b9d1244e564",
            "name": "测试仓库_1764760090792",
            "isActive": true
          },
          {
            "id": "d47eebc6-8534-4b13-b916-30da9bd4068f",
            "name": "测试仓库_1764760627882",
            "isActive": true
          }
        ]
      },
      "error": null,
      "timestamp": "2025-12-03T11:24:08.039Z"
    },
    {
      "category": "仓库管理",
      "name": "创建仓库",
      "description": "测试 RLS 策略是否允许 BOSS 角色创建仓库",
      "passed": true,
      "testData": {
        "createdWarehouse": {
          "id": "10388800-10ad-468d-a6d0-4acd1e4c2c9f",
          "name": "测试仓库_1764761048039",
          "isActive": true
        }
      },
      "error": null,
      "timestamp": "2025-12-03T11:24:08.161Z"
    },
    {
      "category": "仓库管理",
      "name": "更新仓库",
      "description": "测试仓库信息更新功能（如每日目标）",
      "passed": true,
      "testData": {
        "warehouseId": "10388800-10ad-468d-a6d0-4acd1e4c2c9f",
        "updatedFields": {
          "daily_target": 1000
        }
      },
      "error": null,
      "timestamp": "2025-12-03T11:24:08.250Z"
    },
    {
      "category": "用户管理",
      "name": "获取用户列表",
      "description": "验证至少有4个测试用户（老板、调度、车队长、司机）",
      "passed": true,
      "testData": {
        "totalUsers": 4,
        "users": [
          {
            "phone": "13800000001",
            "role": "BOSS",
            "name": "老板admin"
          },
          {
            "phone": "13800000002",
            "role": "PEER_ADMIN",
            "name": "调度admin1"
          },
          {
            "phone": "13800000003",
            "role": "MANAGER",
            "name": "车队长admin2"
          },
          {
            "phone": "13800000004",
            "role": "DRIVER",
            "name": "司机admin3"
          }
        ]
      },
      "error": null,
      "timestamp": "2025-12-03T11:24:08.692Z"
    },
    {
      "category": "用户管理",
      "name": "筛选BOSS角色",
      "description": "验证 老板 角色用户是否存在",
      "passed": true,
      "testData": {
        "role": "BOSS",
        "count": 1,
        "users": [
          "13800000001"
        ]
      },
      "error": null,
      "timestamp": "2025-12-03T11:24:08.781Z"
    },
    {
      "category": "用户管理",
      "name": "筛选PEER_ADMIN角色",
      "description": "验证 调度 角色用户是否存在",
      "passed": true,
      "testData": {
        "role": "PEER_ADMIN",
        "count": 1,
        "users": [
          "13800000002"
        ]
      },
      "error": null,
      "timestamp": "2025-12-03T11:24:08.859Z"
    },
    {
      "category": "用户管理",
      "name": "筛选MANAGER角色",
      "description": "验证 车队长 角色用户是否存在",
      "passed": true,
      "testData": {
        "role": "MANAGER",
        "count": 1,
        "users": [
          "13800000003"
        ]
      },
      "error": null,
      "timestamp": "2025-12-03T11:24:08.944Z"
    },
    {
      "category": "用户管理",
      "name": "筛选DRIVER角色",
      "description": "验证 司机 角色用户是否存在",
      "passed": true,
      "testData": {
        "role": "DRIVER",
        "count": 1,
        "users": [
          "13800000004"
        ]
      },
      "error": null,
      "timestamp": "2025-12-03T11:24:09.022Z"
    },
    {
      "category": "仓库分配",
      "name": "查询仓库分配记录",
      "description": "测试 warehouse_assignments 表的查询权限",
      "passed": true,
      "testData": {
        "assignmentCount": 0,
        "assignments": []
      },
      "error": null,
      "timestamp": "2025-12-03T11:24:09.345Z"
    },
    {
      "category": "仓库分配",
      "name": "关联查询用户和仓库",
      "description": "验证关联查询是否返回完整的仓库和用户信息",
      "passed": true,
      "testData": {
        "assignmentCount": 0,
        "details": []
      },
      "error": null,
      "timestamp": "2025-12-03T11:24:09.436Z"
    },
    {
      "category": "考勤管理",
      "name": "查询考勤记录",
      "description": "测试考勤记录的查询权限",
      "passed": true,
      "testData": {
        "recordCount": 1,
        "latestRecords": [
          {
            "userId": "781db950-91bd-4149-b34f-136bb1d53d58",
            "workDate": "2025-12-03",
            "checkInTime": "2025-12-03T11:08:12.686+00:00"
          }
        ]
      },
      "error": null,
      "timestamp": "2025-12-03T11:24:09.803Z"
    },
    {
      "category": "考勤管理",
      "name": "创建考勤记录",
      "description": "测试考勤打卡功能",
      "passed": false,
      "testData": {
        "user_id": "781db950-91bd-4149-b34f-136bb1d53d58",
        "work_date": "2025-12-03",
        "check_in_time": "2025-12-03T11:24:09.885Z"
      },
      "error": "duplicate key value violates unique constraint \"attendance_user_id_work_date_key\"",
      "timestamp": "2025-12-03T11:24:09.969Z"
    },
    {
      "category": "请假申请",
      "name": "查询请假记录",
      "description": "测试请假申请的查询权限",
      "passed": true,
      "testData": {
        "applicationCount": 0,
        "latestApplications": []
      },
      "error": null,
      "timestamp": "2025-12-03T11:24:10.311Z"
    },
    {
      "category": "请假申请",
      "name": "筛选待审批申请",
      "description": "测试筛选待审批的请假申请",
      "passed": true,
      "testData": {
        "pendingCount": 0,
        "pendingApplications": []
      },
      "error": null,
      "timestamp": "2025-12-03T11:24:10.390Z"
    },
    {
      "category": "计件记录",
      "name": "查询计件记录",
      "description": "测试计件记录的查询功能",
      "passed": true,
      "testData": {
        "recordCount": 0,
        "totalAmount": 0,
        "latestRecords": []
      },
      "error": null,
      "timestamp": "2025-12-03T11:24:10.740Z"
    },
    {
      "category": "计件记录",
      "name": "按日期筛选",
      "description": "测试按日期范围查询计件记录",
      "passed": true,
      "testData": {
        "filterDate": "2025-12-03",
        "matchingRecords": 0
      },
      "error": null,
      "timestamp": "2025-12-03T11:24:10.822Z"
    },
    {
      "category": "车辆管理",
      "name": "查询车辆列表",
      "description": "测试车辆列表查询功能",
      "passed": true,
      "testData": {
        "vehicleCount": 0,
        "vehicles": []
      },
      "error": null,
      "timestamp": "2025-12-03T11:24:11.156Z"
    },
    {
      "category": "车辆管理",
      "name": "关联查询司机信息",
      "description": "测试车辆与司机的关联查询",
      "passed": true,
      "testData": {
        "vehicleCount": 0,
        "vehiclesWithDriver": 0
      },
      "error": null,
      "timestamp": "2025-12-03T11:24:11.241Z"
    },
    {
      "category": "通知系统",
      "name": "查询通知列表",
      "description": "测试通知列表查询功能",
      "passed": true,
      "testData": {
        "notificationCount": 0,
        "latestNotifications": []
      },
      "error": null,
      "timestamp": "2025-12-03T11:24:11.598Z"
    },
    {
      "category": "通知系统",
      "name": "筛选未读通知",
      "description": "测试筛选未读通知功能",
      "passed": true,
      "testData": {
        "unreadCount": 0
      },
      "error": null,
      "timestamp": "2025-12-03T11:24:11.690Z"
    },
    {
      "category": "辅助函数",
      "name": "is_boss()",
      "description": "验证老板角色检查函数",
      "passed": true,
      "testData": {
        "functionName": "is_boss",
        "userId": "8a927ad9-f6b7-4794-a594-3f59b810496c",
        "result": true,
        "expectedForCurrentUser": true
      },
      "error": null,
      "timestamp": "2025-12-03T11:24:12.121Z"
    },
    {
      "category": "辅助函数",
      "name": "is_manager()",
      "description": "验证车队长角色检查函数",
      "passed": true,
      "testData": {
        "functionName": "is_manager",
        "userId": "8a927ad9-f6b7-4794-a594-3f59b810496c",
        "result": false,
        "expectedForCurrentUser": false
      },
      "error": null,
      "timestamp": "2025-12-03T11:24:12.198Z"
    },
    {
      "category": "辅助函数",
      "name": "is_driver()",
      "description": "验证司机角色检查函数",
      "passed": true,
      "testData": {
        "functionName": "is_driver",
        "userId": "8a927ad9-f6b7-4794-a594-3f59b810496c",
        "result": false,
        "expectedForCurrentUser": false
      },
      "error": null,
      "timestamp": "2025-12-03T11:24:12.279Z"
    },
    {
      "category": "辅助函数",
      "name": "is_peer_admin()",
      "description": "验证调度角色检查函数",
      "passed": true,
      "testData": {
        "functionName": "is_peer_admin",
        "userId": "8a927ad9-f6b7-4794-a594-3f59b810496c",
        "result": false,
        "expectedForCurrentUser": false
      },
      "error": null,
      "timestamp": "2025-12-03T11:24:12.358Z"
    },
    {
      "category": "统计系统",
      "name": "考勤统计",
      "description": "测试考勤打卡数据的统计功能（总记录数、签到数、签退数）",
      "passed": true,
      "testData": {
        "totalRecords": 1,
        "checkedIn": 1,
        "checkedOut": 0
      },
      "error": null,
      "timestamp": "2025-12-03T11:24:12.687Z"
    },
    {
      "category": "统计系统",
      "name": "计件工作量统计",
      "description": "测试计件记录的汇总统计（总件数、总金额、平均金额）",
      "passed": false,
      "testData": {
        "totalRecords": 0,
        "totalQuantity": 0,
        "totalAmount": 0,
        "avgAmount": 0
      },
      "error": "column piece_work_records.total_amount does not exist",
      "timestamp": "2025-12-03T11:24:12.768Z"
    },
    {
      "category": "统计系统",
      "name": "用户角色分布统计",
      "description": "测试统计各角色的用户数量分布",
      "passed": true,
      "testData": {
        "totalUsers": 4,
        "roleDistribution": {
          "BOSS": 1,
          "PEER_ADMIN": 1,
          "MANAGER": 1,
          "DRIVER": 1
        }
      },
      "error": null,
      "timestamp": "2025-12-03T11:24:12.848Z"
    },
    {
      "category": "RLS策略",
      "name": "司机考勤记录隔离",
      "description": "测试司机只能查看自己的考勤记录，不能看到其他人的",
      "passed": true,
      "testData": {
        "driverId": "781db950-91bd-4149-b34f-136bb1d53d58",
        "recordCount": 1,
        "allRecordsBelongToDriver": true
      },
      "error": null,
      "timestamp": "2025-12-03T11:24:13.192Z"
    },
    {
      "category": "RLS策略",
      "name": "管理员查看所有仓库",
      "description": "测试 BOSS 角色可以查看所有仓库（管理员权限）",
      "passed": true,
      "testData": {
        "warehouseCount": 3
      },
      "error": null,
      "timestamp": "2025-12-03T11:24:13.525Z"
    },
    {
      "category": "RLS策略",
      "name": "未登录用户访问限制",
      "description": "测试未登录用户是否被拒绝访问敏感数据",
      "passed": false,
      "testData": {
        "hasError": false,
        "dataCount": 4,
        "accessDenied": false
      },
      "error": "未登录用户不应该能访问数据",
      "timestamp": "2025-12-03T11:24:13.692Z"
    },
    {
      "category": "实时更新系统",
      "name": "建立实时订阅",
      "description": "测试能否成功创建 Realtime 订阅通道",
      "passed": true,
      "testData": {
        "channel": "warehouse-changes",
        "table": "warehouses",
        "subscriptionStatus": "joining"
      },
      "error": null,
      "timestamp": "2025-12-03T11:24:14.877Z"
    },
    {
      "category": "实时更新系统",
      "name": "updated_at 自动更新触发器",
      "description": "测试数据更新时 updated_at 字段是否自动更新",
      "passed": false,
      "testData": {
        "warehouseId": "306f4173-bdd5-4050-b7a3-7b9d1244e564",
        "oldUpdatedAt": "2025-12-03T11:08:11.084448+00:00",
        "newUpdatedAt": "2025-12-03T11:08:11.084448+00:00",
        "wasAutoUpdated": false
      },
      "error": "updated_at 未自动更新",
      "timestamp": "2025-12-03T11:24:16.328Z"
    },
    {
      "category": "缓存系统",
      "name": "查询性能测试",
      "description": "测试重复查询的响应时间（第二次可能利用缓存）",
      "passed": true,
      "testData": {
        "firstQueryTime": "115ms",
        "secondQueryTime": "100ms",
        "recordCount": 4,
        "performanceImprovement": "提升 13.0%"
      },
      "error": null,
      "timestamp": "2025-12-03T11:24:16.906Z"
    },
    {
      "category": "缓存系统",
      "name": "缓存失效机制",
      "description": "测试数据更新后缓存是否正确失效，查询到最新数据",
      "passed": false,
      "testData": {
        "warehouseId": "306f4173-bdd5-4050-b7a3-7b9d1244e564",
        "oldTarget": null,
        "newTarget": 100,
        "queriedTarget": null,
        "dataConsistent": false
      },
      "error": "缓存未正确失效",
      "timestamp": "2025-12-03T11:24:17.201Z"
    }
  ],
  "debugLogs": [
    {
      "timestamp": "2025-12-03T11:24:04.942Z",
      "level": "INFO",
      "category": "系统",
      "message": "测试开始",
      "data": {
        "supabaseUrl": "https://wxvrwkpkioalqdsfswwu.supabase.co",
        "timestamp": "2025-12-03T11:24:04.942Z"
      }
    },
    {
      "timestamp": "2025-12-03T11:24:04.943Z",
      "level": "INFO",
      "category": "阶段开始",
      "message": "数据库结构测试",
      "data": {
        "description": "验证所有必需的表和枚举类型是否正确创建",
        "expectedTables": 8,
        "expectedEnums": 7
      }
    },
    {
      "timestamp": "2025-12-03T11:24:05.490Z",
      "level": "DEBUG",
      "category": "数据库结构",
      "message": "users 表 成功",
      "data": {
        "tableName": "users",
        "hasData": true
      }
    },
    {
      "timestamp": "2025-12-03T11:24:05.600Z",
      "level": "DEBUG",
      "category": "数据库结构",
      "message": "warehouses 表 成功",
      "data": {
        "tableName": "warehouses",
        "hasData": true
      }
    },
    {
      "timestamp": "2025-12-03T11:24:05.692Z",
      "level": "DEBUG",
      "category": "数据库结构",
      "message": "warehouse_assignments 表 成功",
      "data": {
        "tableName": "warehouse_assignments",
        "hasData": false
      }
    },
    {
      "timestamp": "2025-12-03T11:24:05.924Z",
      "level": "DEBUG",
      "category": "数据库结构",
      "message": "vehicles 表 成功",
      "data": {
        "tableName": "vehicles",
        "hasData": false
      }
    },
    {
      "timestamp": "2025-12-03T11:24:06.017Z",
      "level": "DEBUG",
      "category": "数据库结构",
      "message": "attendance 表 成功",
      "data": {
        "tableName": "attendance",
        "hasData": true
      }
    },
    {
      "timestamp": "2025-12-03T11:24:06.121Z",
      "level": "DEBUG",
      "category": "数据库结构",
      "message": "leave_applications 表 成功",
      "data": {
        "tableName": "leave_applications",
        "hasData": false
      }
    },
    {
      "timestamp": "2025-12-03T11:24:06.214Z",
      "level": "DEBUG",
      "category": "数据库结构",
      "message": "piece_work_records 表 成功",
      "data": {
        "tableName": "piece_work_records",
        "hasData": false
      }
    },
    {
      "timestamp": "2025-12-03T11:24:06.295Z",
      "level": "DEBUG",
      "category": "数据库结构",
      "message": "notifications 表 成功",
      "data": {
        "tableName": "notifications",
        "hasData": false
      }
    },
    {
      "timestamp": "2025-12-03T11:24:06.385Z",
      "level": "DEBUG",
      "category": "数据库结构",
      "message": "用户角色枚举 成功",
      "data": {
        "enumValues": [
          "BOSS",
          "PEER_ADMIN",
          "MANAGER",
          "DRIVER"
        ]
      }
    },
    {
      "timestamp": "2025-12-03T11:24:06.386Z",
      "level": "INFO",
      "category": "阶段开始",
      "message": "用户认证测试",
      "data": {
        "description": "测试所有角色的用户账号是否能正常登录和认证",
        "testAccounts": 4
      }
    },
    {
      "timestamp": "2025-12-03T11:24:06.386Z",
      "level": "DEBUG",
      "category": "用户认证",
      "message": "尝试登录 老板",
      "data": {
        "email": "13800000001@phone.local",
        "expectedRole": "BOSS"
      }
    },
    {
      "timestamp": "2025-12-03T11:24:06.671Z",
      "level": "DEBUG",
      "category": "用户认证",
      "message": "老板登录 成功",
      "data": {
        "userId": "8a927ad9-f6b7-4794-a594-3f59b810496c",
        "email": "13800000001@phone.local",
        "expectedRole": "BOSS",
        "actualRole": "BOSS",
        "userName": "老板admin",
        "userPhone": "13800000001"
      }
    },
    {
      "timestamp": "2025-12-03T11:24:06.755Z",
      "level": "DEBUG",
      "category": "用户认证",
      "message": "尝试登录 调度",
      "data": {
        "email": "13800000002@phone.local",
        "expectedRole": "PEER_ADMIN"
      }
    },
    {
      "timestamp": "2025-12-03T11:24:07.022Z",
      "level": "DEBUG",
      "category": "用户认证",
      "message": "调度登录 成功",
      "data": {
        "userId": "d59b8140-d70b-4d19-aef7-685450ca73d2",
        "email": "13800000002@phone.local",
        "expectedRole": "PEER_ADMIN",
        "actualRole": "PEER_ADMIN",
        "userName": "调度admin1",
        "userPhone": "13800000002"
      }
    },
    {
      "timestamp": "2025-12-03T11:24:07.105Z",
      "level": "DEBUG",
      "category": "用户认证",
      "message": "尝试登录 车队长",
      "data": {
        "email": "13800000003@phone.local",
        "expectedRole": "MANAGER"
      }
    },
    {
      "timestamp": "2025-12-03T11:24:07.356Z",
      "level": "DEBUG",
      "category": "用户认证",
      "message": "车队长登录 成功",
      "data": {
        "userId": "8a0a9af4-d137-48c0-9159-0b3d586b5498",
        "email": "13800000003@phone.local",
        "expectedRole": "MANAGER",
        "actualRole": "MANAGER",
        "userName": "车队长admin2",
        "userPhone": "13800000003"
      }
    },
    {
      "timestamp": "2025-12-03T11:24:07.438Z",
      "level": "DEBUG",
      "category": "用户认证",
      "message": "尝试登录 司机",
      "data": {
        "email": "13800000004@phone.local",
        "expectedRole": "DRIVER"
      }
    },
    {
      "timestamp": "2025-12-03T11:24:07.696Z",
      "level": "DEBUG",
      "category": "用户认证",
      "message": "司机登录 成功",
      "data": {
        "userId": "781db950-91bd-4149-b34f-136bb1d53d58",
        "email": "13800000004@phone.local",
        "expectedRole": "DRIVER",
        "actualRole": "DRIVER",
        "userName": "司机admin3",
        "userPhone": "13800000004"
      }
    },
    {
      "timestamp": "2025-12-03T11:24:07.780Z",
      "level": "INFO",
      "category": "阶段开始",
      "message": "仓库管理测试",
      "data": {
        "description": "测试仓库的创建、查询和管理功能"
      }
    },
    {
      "timestamp": "2025-12-03T11:24:07.780Z",
      "level": "DEBUG",
      "category": "仓库管理",
      "message": "使用老板账号登录",
      "data": {
        "reason": "仓库管理需要管理员权限"
      }
    },
    {
      "timestamp": "2025-12-03T11:24:08.039Z",
      "level": "DEBUG",
      "category": "仓库管理",
      "message": "获取仓库列表 成功",
      "data": {
        "warehouseCount": 2,
        "warehouses": [
          {
            "id": "306f4173-bdd5-4050-b7a3-7b9d1244e564",
            "name": "测试仓库_1764760090792",
            "isActive": true
          },
          {
            "id": "d47eebc6-8534-4b13-b916-30da9bd4068f",
            "name": "测试仓库_1764760627882",
            "isActive": true
          }
        ]
      }
    },
    {
      "timestamp": "2025-12-03T11:24:08.039Z",
      "level": "DEBUG",
      "category": "仓库管理",
      "message": "创建测试仓库",
      "data": {
        "name": "测试仓库_1764761048039",
        "is_active": true
      }
    },
    {
      "timestamp": "2025-12-03T11:24:08.162Z",
      "level": "DEBUG",
      "category": "仓库管理",
      "message": "创建仓库 成功",
      "data": {
        "createdWarehouse": {
          "id": "10388800-10ad-468d-a6d0-4acd1e4c2c9f",
          "name": "测试仓库_1764761048039",
          "isActive": true
        }
      }
    },
    {
      "timestamp": "2025-12-03T11:24:08.163Z",
      "level": "DEBUG",
      "category": "仓库管理",
      "message": "更新仓库目标",
      "data": {
        "warehouseId": "10388800-10ad-468d-a6d0-4acd1e4c2c9f",
        "daily_target": 1000
      }
    },
    {
      "timestamp": "2025-12-03T11:24:08.250Z",
      "level": "DEBUG",
      "category": "仓库管理",
      "message": "更新仓库 成功",
      "data": {
        "warehouseId": "10388800-10ad-468d-a6d0-4acd1e4c2c9f",
        "updatedFields": {
          "daily_target": 1000
        }
      }
    },
    {
      "timestamp": "2025-12-03T11:24:08.251Z",
      "level": "DEBUG",
      "category": "仓库管理",
      "message": "清理测试数据",
      "data": {
        "warehouseId": "10388800-10ad-468d-a6d0-4acd1e4c2c9f"
      }
    },
    {
      "timestamp": "2025-12-03T11:24:08.434Z",
      "level": "INFO",
      "category": "阶段开始",
      "message": "用户管理测试",
      "data": {
        "description": "测试用户查询、筛选和角色验证功能"
      }
    },
    {
      "timestamp": "2025-12-03T11:24:08.693Z",
      "level": "DEBUG",
      "category": "用户管理",
      "message": "获取用户列表 成功",
      "data": {
        "totalUsers": 4,
        "users": [
          {
            "phone": "13800000001",
            "role": "BOSS",
            "name": "老板admin"
          },
          {
            "phone": "13800000002",
            "role": "PEER_ADMIN",
            "name": "调度admin1"
          },
          {
            "phone": "13800000003",
            "role": "MANAGER",
            "name": "车队长admin2"
          },
          {
            "phone": "13800000004",
            "role": "DRIVER",
            "name": "司机admin3"
          }
        ]
      }
    },
    {
      "timestamp": "2025-12-03T11:24:08.782Z",
      "level": "DEBUG",
      "category": "用户管理",
      "message": "筛选BOSS角色 成功",
      "data": {
        "role": "BOSS",
        "count": 1,
        "users": [
          "13800000001"
        ]
      }
    },
    {
      "timestamp": "2025-12-03T11:24:08.859Z",
      "level": "DEBUG",
      "category": "用户管理",
      "message": "筛选PEER_ADMIN角色 成功",
      "data": {
        "role": "PEER_ADMIN",
        "count": 1,
        "users": [
          "13800000002"
        ]
      }
    },
    {
      "timestamp": "2025-12-03T11:24:08.944Z",
      "level": "DEBUG",
      "category": "用户管理",
      "message": "筛选MANAGER角色 成功",
      "data": {
        "role": "MANAGER",
        "count": 1,
        "users": [
          "13800000003"
        ]
      }
    },
    {
      "timestamp": "2025-12-03T11:24:09.023Z",
      "level": "DEBUG",
      "category": "用户管理",
      "message": "筛选DRIVER角色 成功",
      "data": {
        "role": "DRIVER",
        "count": 1,
        "users": [
          "13800000004"
        ]
      }
    },
    {
      "timestamp": "2025-12-03T11:24:09.101Z",
      "level": "INFO",
      "category": "阶段开始",
      "message": "仓库分配测试",
      "data": {
        "description": "测试用户与仓库的关联功能"
      }
    },
    {
      "timestamp": "2025-12-03T11:24:09.345Z",
      "level": "DEBUG",
      "category": "仓库分配",
      "message": "查询仓库分配记录 成功",
      "data": {
        "assignmentCount": 0,
        "assignments": []
      }
    },
    {
      "timestamp": "2025-12-03T11:24:09.437Z",
      "level": "DEBUG",
      "category": "仓库分配",
      "message": "关联查询用户和仓库 成功",
      "data": {
        "assignmentCount": 0,
        "details": []
      }
    },
    {
      "timestamp": "2025-12-03T11:24:09.535Z",
      "level": "INFO",
      "category": "阶段开始",
      "message": "考勤管理测试",
      "data": {
        "description": "测试考勤打卡记录的创建和查询"
      }
    },
    {
      "timestamp": "2025-12-03T11:24:09.803Z",
      "level": "DEBUG",
      "category": "考勤管理",
      "message": "查询考勤记录 成功",
      "data": {
        "recordCount": 1,
        "latestRecords": [
          {
            "userId": "781db950-91bd-4149-b34f-136bb1d53d58",
            "workDate": "2025-12-03",
            "checkInTime": "2025-12-03T11:08:12.686+00:00"
          }
        ]
      }
    },
    {
      "timestamp": "2025-12-03T11:24:09.885Z",
      "level": "DEBUG",
      "category": "考勤管理",
      "message": "创建考勤打卡记录",
      "data": {
        "user_id": "781db950-91bd-4149-b34f-136bb1d53d58",
        "work_date": "2025-12-03",
        "check_in_time": "2025-12-03T11:24:09.885Z"
      }
    },
    {
      "timestamp": "2025-12-03T11:24:09.970Z",
      "level": "ERROR",
      "category": "考勤管理",
      "message": "创建考勤记录 失败",
      "data": {
        "error": "duplicate key value violates unique constraint \"attendance_user_id_work_date_key\"",
        "testData": {
          "user_id": "781db950-91bd-4149-b34f-136bb1d53d58",
          "work_date": "2025-12-03",
          "check_in_time": "2025-12-03T11:24:09.885Z"
        }
      }
    },
    {
      "timestamp": "2025-12-03T11:24:10.053Z",
      "level": "INFO",
      "category": "阶段开始",
      "message": "请假申请测试",
      "data": {
        "description": "测试请假申请的创建和审批流程"
      }
    },
    {
      "timestamp": "2025-12-03T11:24:10.311Z",
      "level": "DEBUG",
      "category": "请假申请",
      "message": "查询请假记录 成功",
      "data": {
        "applicationCount": 0,
        "latestApplications": []
      }
    },
    {
      "timestamp": "2025-12-03T11:24:10.391Z",
      "level": "DEBUG",
      "category": "请假申请",
      "message": "筛选待审批申请 成功",
      "data": {
        "pendingCount": 0,
        "pendingApplications": []
      }
    },
    {
      "timestamp": "2025-12-03T11:24:10.478Z",
      "level": "INFO",
      "category": "阶段开始",
      "message": "计件记录测试",
      "data": {
        "description": "测试工作量计件记录的创建和统计"
      }
    },
    {
      "timestamp": "2025-12-03T11:24:10.741Z",
      "level": "DEBUG",
      "category": "计件记录",
      "message": "查询计件记录 成功",
      "data": {
        "recordCount": 0,
        "totalAmount": 0,
        "latestRecords": []
      }
    },
    {
      "timestamp": "2025-12-03T11:24:10.822Z",
      "level": "DEBUG",
      "category": "计件记录",
      "message": "按日期筛选 成功",
      "data": {
        "filterDate": "2025-12-03",
        "matchingRecords": 0
      }
    },
    {
      "timestamp": "2025-12-03T11:24:10.907Z",
      "level": "INFO",
      "category": "阶段开始",
      "message": "车辆管理测试",
      "data": {
        "description": "测试车辆信息的创建和查询功能"
      }
    },
    {
      "timestamp": "2025-12-03T11:24:11.156Z",
      "level": "DEBUG",
      "category": "车辆管理",
      "message": "查询车辆列表 成功",
      "data": {
        "vehicleCount": 0,
        "vehicles": []
      }
    },
    {
      "timestamp": "2025-12-03T11:24:11.241Z",
      "level": "DEBUG",
      "category": "车辆管理",
      "message": "关联查询司机信息 成功",
      "data": {
        "vehicleCount": 0,
        "vehiclesWithDriver": 0
      }
    },
    {
      "timestamp": "2025-12-03T11:24:11.350Z",
      "level": "INFO",
      "category": "阶段开始",
      "message": "通知系统测试",
      "data": {
        "description": "测试系统消息通知的发送和接收"
      }
    },
    {
      "timestamp": "2025-12-03T11:24:11.599Z",
      "level": "DEBUG",
      "category": "通知系统",
      "message": "查询通知列表 成功",
      "data": {
        "notificationCount": 0,
        "latestNotifications": []
      }
    },
    {
      "timestamp": "2025-12-03T11:24:11.690Z",
      "level": "DEBUG",
      "category": "通知系统",
      "message": "筛选未读通知 成功",
      "data": {
        "unreadCount": 0
      }
    },
    {
      "timestamp": "2025-12-03T11:24:11.768Z",
      "level": "INFO",
      "category": "阶段开始",
      "message": "辅助函数测试",
      "data": {
        "description": "测试数据库辅助函数（角色检查、权限验证）"
      }
    },
    {
      "timestamp": "2025-12-03T11:24:12.030Z",
      "level": "DEBUG",
      "category": "辅助函数",
      "message": "调用 is_boss()",
      "data": {
        "userId": "8a927ad9-f6b7-4794-a594-3f59b810496c"
      }
    },
    {
      "timestamp": "2025-12-03T11:24:12.121Z",
      "level": "DEBUG",
      "category": "辅助函数",
      "message": "is_boss() 成功",
      "data": {
        "functionName": "is_boss",
        "userId": "8a927ad9-f6b7-4794-a594-3f59b810496c",
        "result": true,
        "expectedForCurrentUser": true
      }
    },
    {
      "timestamp": "2025-12-03T11:24:12.121Z",
      "level": "DEBUG",
      "category": "辅助函数",
      "message": "调用 is_manager()",
      "data": {
        "userId": "8a927ad9-f6b7-4794-a594-3f59b810496c"
      }
    },
    {
      "timestamp": "2025-12-03T11:24:12.199Z",
      "level": "DEBUG",
      "category": "辅助函数",
      "message": "is_manager() 成功",
      "data": {
        "functionName": "is_manager",
        "userId": "8a927ad9-f6b7-4794-a594-3f59b810496c",
        "result": false,
        "expectedForCurrentUser": false
      }
    },
    {
      "timestamp": "2025-12-03T11:24:12.199Z",
      "level": "DEBUG",
      "category": "辅助函数",
      "message": "调用 is_driver()",
      "data": {
        "userId": "8a927ad9-f6b7-4794-a594-3f59b810496c"
      }
    },
    {
      "timestamp": "2025-12-03T11:24:12.280Z",
      "level": "DEBUG",
      "category": "辅助函数",
      "message": "is_driver() 成功",
      "data": {
        "functionName": "is_driver",
        "userId": "8a927ad9-f6b7-4794-a594-3f59b810496c",
        "result": false,
        "expectedForCurrentUser": false
      }
    },
    {
      "timestamp": "2025-12-03T11:24:12.281Z",
      "level": "DEBUG",
      "category": "辅助函数",
      "message": "调用 is_peer_admin()",
      "data": {
        "userId": "8a927ad9-f6b7-4794-a594-3f59b810496c"
      }
    },
    {
      "timestamp": "2025-12-03T11:24:12.358Z",
      "level": "DEBUG",
      "category": "辅助函数",
      "message": "is_peer_admin() 成功",
      "data": {
        "functionName": "is_peer_admin",
        "userId": "8a927ad9-f6b7-4794-a594-3f59b810496c",
        "result": false,
        "expectedForCurrentUser": false
      }
    },
    {
      "timestamp": "2025-12-03T11:24:12.436Z",
      "level": "INFO",
      "category": "阶段开始",
      "message": "统计系统测试",
      "data": {
        "description": "测试数据统计和聚合功能"
      }
    },
    {
      "timestamp": "2025-12-03T11:24:12.688Z",
      "level": "DEBUG",
      "category": "统计系统",
      "message": "考勤统计 成功",
      "data": {
        "totalRecords": 1,
        "checkedIn": 1,
        "checkedOut": 0
      }
    },
    {
      "timestamp": "2025-12-03T11:24:12.768Z",
      "level": "ERROR",
      "category": "统计系统",
      "message": "计件工作量统计 失败",
      "data": {
        "error": "column piece_work_records.total_amount does not exist",
        "testData": {
          "totalRecords": 0,
          "totalQuantity": 0,
          "totalAmount": 0,
          "avgAmount": 0
        }
      }
    },
    {
      "timestamp": "2025-12-03T11:24:12.849Z",
      "level": "DEBUG",
      "category": "统计系统",
      "message": "用户角色分布统计 成功",
      "data": {
        "totalUsers": 4,
        "roleDistribution": {
          "BOSS": 1,
          "PEER_ADMIN": 1,
          "MANAGER": 1,
          "DRIVER": 1
        }
      }
    },
    {
      "timestamp": "2025-12-03T11:24:12.928Z",
      "level": "INFO",
      "category": "阶段开始",
      "message": "RLS策略测试",
      "data": {
        "description": "测试行级安全策略是否正确限制数据访问"
      }
    },
    {
      "timestamp": "2025-12-03T11:24:12.929Z",
      "level": "DEBUG",
      "category": "RLS策略",
      "message": "使用司机账号登录",
      "data": {
        "role": "DRIVER"
      }
    },
    {
      "timestamp": "2025-12-03T11:24:13.194Z",
      "level": "DEBUG",
      "category": "RLS策略",
      "message": "司机考勤记录隔离 成功",
      "data": {
        "driverId": "781db950-91bd-4149-b34f-136bb1d53d58",
        "recordCount": 1,
        "allRecordsBelongToDriver": true
      }
    },
    {
      "timestamp": "2025-12-03T11:24:13.281Z",
      "level": "DEBUG",
      "category": "RLS策略",
      "message": "使用老板账号登录",
      "data": {
        "role": "BOSS"
      }
    },
    {
      "timestamp": "2025-12-03T11:24:13.525Z",
      "level": "DEBUG",
      "category": "RLS策略",
      "message": "管理员查看所有仓库 成功",
      "data": {
        "warehouseCount": 3
      }
    },
    {
      "timestamp": "2025-12-03T11:24:13.612Z",
      "level": "DEBUG",
      "category": "RLS策略",
      "message": "测试未登录访问",
      "data": {
        "expectedResult": "拒绝访问"
      }
    },
    {
      "timestamp": "2025-12-03T11:24:13.692Z",
      "level": "ERROR",
      "category": "RLS策略",
      "message": "未登录用户访问限制 失败",
      "data": {
        "error": "未登录用户不应该能访问数据",
        "testData": {
          "hasError": false,
          "dataCount": 4,
          "accessDenied": false
        }
      }
    },
    {
      "timestamp": "2025-12-03T11:24:13.694Z",
      "level": "INFO",
      "category": "阶段开始",
      "message": "实时更新系统测试",
      "data": {
        "description": "测试 Supabase Realtime 订阅和实时数据更新功能"
      }
    },
    {
      "timestamp": "2025-12-03T11:24:13.866Z",
      "level": "DEBUG",
      "category": "实时更新",
      "message": "创建仓库表订阅",
      "data": {
        "table": "warehouses"
      }
    },
    {
      "timestamp": "2025-12-03T11:24:14.877Z",
      "level": "DEBUG",
      "category": "实时更新系统",
      "message": "建立实时订阅 成功",
      "data": {
        "channel": "warehouse-changes",
        "table": "warehouses",
        "subscriptionStatus": "joining"
      }
    },
    {
      "timestamp": "2025-12-03T11:24:14.883Z",
      "level": "DEBUG",
      "category": "实时更新",
      "message": "测试 updated_at 触发器",
      "data": {
        "action": "更新仓库记录"
      }
    },
    {
      "timestamp": "2025-12-03T11:24:16.328Z",
      "level": "ERROR",
      "category": "实时更新系统",
      "message": "updated_at 自动更新触发器 失败",
      "data": {
        "error": "updated_at 未自动更新",
        "testData": {
          "warehouseId": "306f4173-bdd5-4050-b7a3-7b9d1244e564",
          "oldUpdatedAt": "2025-12-03T11:08:11.084448+00:00",
          "newUpdatedAt": "2025-12-03T11:08:11.084448+00:00",
          "wasAutoUpdated": false
        }
      }
    },
    {
      "timestamp": "2025-12-03T11:24:16.507Z",
      "level": "INFO",
      "category": "阶段开始",
      "message": "缓存系统测试",
      "data": {
        "description": "测试查询性能和数据缓存机制"
      }
    },
    {
      "timestamp": "2025-12-03T11:24:16.691Z",
      "level": "DEBUG",
      "category": "缓存系统",
      "message": "测试查询性能",
      "data": {
        "action": "执行两次相同查询"
      }
    },
    {
      "timestamp": "2025-12-03T11:24:16.906Z",
      "level": "DEBUG",
      "category": "缓存系统",
      "message": "查询性能测试 成功",
      "data": {
        "firstQueryTime": "115ms",
        "secondQueryTime": "100ms",
        "recordCount": 4,
        "performanceImprovement": "提升 13.0%"
      }
    },
    {
      "timestamp": "2025-12-03T11:24:16.906Z",
      "level": "DEBUG",
      "category": "缓存系统",
      "message": "测试缓存失效",
      "data": {
        "action": "更新后立即查询"
      }
    },
    {
      "timestamp": "2025-12-03T11:24:17.201Z",
      "level": "ERROR",
      "category": "缓存系统",
      "message": "缓存失效机制 失败",
      "data": {
        "error": "缓存未正确失效",
        "testData": {
          "warehouseId": "306f4173-bdd5-4050-b7a3-7b9d1244e564",
          "oldTarget": null,
          "newTarget": 100,
          "queriedTarget": null,
          "dataConsistent": false
        }
      }
    }
  ]
}