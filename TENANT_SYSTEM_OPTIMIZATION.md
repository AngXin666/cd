# 租户系统优化功能说明

## 更新时间
2025-11-27

## 功能概述

本次优化主要针对新租户自动部署流程，加强系统数据安全性与业务连续性，实现了以下四个核心功能：

1. **新租户初始化自动创建默认仓库**
2. **仓库删除限制（至少保留一个仓库）**
3. **用户账户创建强制分配仓库**
4. **中央系统管理员特权管理**

---

## 功能详细说明

### 1. 新租户初始化 - 自动创建默认仓库

#### 功能描述
当通过自动部署流程成功添加一个新租户（即一个新的老板账号及其所属系统）后，系统会自动在该租户下创建一个预设的"默认仓库"。

#### 技术实现

**数据库函数**: `public.insert_tenant_warehouse`

```sql
CREATE OR REPLACE FUNCTION public.insert_tenant_warehouse(
  p_schema_name TEXT,
  p_warehouse_name TEXT,
  p_max_leave_days INTEGER,
  p_resignation_notice_days INTEGER
)
RETURNS JSONB
```

**Edge Function**: `create-tenant`

在创建租户的流程中，添加了第6步：创建默认仓库

```typescript
// 6. 创建默认仓库
const {data: warehouseResult, error: warehouseError} = await supabase.rpc('insert_tenant_warehouse', {
  p_schema_name: schemaName,
  p_warehouse_name: '默认仓库',
  p_max_leave_days: 7,
  p_resignation_notice_days: 30
})
```

#### 默认仓库配置

| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| 仓库名称 | 默认仓库 | 可以修改 |
| 最大请假天数 | 7天 | 可以修改 |
| 离职通知天数 | 30天 | 可以修改 |
| 状态 | 可用 (active) | 可以修改 |
| 是否可删除 | 是 | 但必须保留至少一个仓库 |

#### 创建流程

```
1. 创建租户记录
   ↓
2. 创建租户 Schema
   ↓
3. 创建老板账号
   ↓
4. 创建老板 Profile
   ↓
5. 创建默认仓库 ← 新增步骤
   ↓
6. 更新租户记录
```

#### 回滚机制

如果创建默认仓库失败，系统会自动回滚：
- 删除老板账号
- 删除租户 Schema
- 删除租户记录

---

### 2. 仓库删除限制 - 至少保留一个仓库

#### 功能描述
对于同一租户内的操作（如老板或其授予同等权限的管理员），在执行删除仓库操作时，系统必须进行校验，禁止删除操作导致该租户下剩余的可用仓库数量少于1个。

#### 技术实现

**文件位置**: `src/pages/super-admin/warehouse-management/index.tsx`

**核心代码**:

```typescript
// 删除仓库
const handleDeleteWarehouse = async (warehouse: WarehouseWithRule) => {
  // 检查是否是最后一个仓库
  if (warehouses.length <= 1) {
    showToast({
      title: '无法删除：每个老板号必须保留至少一个仓库',
      icon: 'none',
      duration: 3000
    })
    return
  }

  // ... 继续删除流程
}
```

#### 限制规则

| 角色 | 是否受限制 | 说明 |
|------|-----------|------|
| 老板（主账号） | ✅ 是 | 必须保留至少一个仓库 |
| 老板（平级账号） | ✅ 是 | 必须保留至少一个仓库 |
| 管理员 | ✅ 是 | 必须保留至少一个仓库 |
| 中央管理员 | ❌ 否 | 不直接管理仓库 |

#### 用户体验

**删除最后一个仓库时**:
```
┌─────────────────────────────────────┐
│  ⚠️ 提示                            │
├─────────────────────────────────────┤
│  无法删除：每个老板号必须保留至少   │
│  一个仓库                           │
│                                     │
│  [确定]                             │
└─────────────────────────────────────┘
```

**删除非最后一个仓库时**:
```
┌─────────────────────────────────────┐
│  确认删除                           │
├─────────────────────────────────────┤
│  确定要删除仓库"XX仓库"吗？         │
│                                     │
│  删除后相关考勤规则和打卡记录也将   │
│  被删除，此操作无法恢复。           │
│                                     │
│  [取消]  [确定]                     │
└─────────────────────────────────────┘
```

---

### 3. 用户账户创建与仓库分配规则

#### 功能描述
在创建该租户下的司机或管理员账户时，"仓库分配"必须作为必填步骤。系统必须强制要求为新账户选择至少一个可访问的仓库。如果未分配任何仓库，则系统应阻止账户创建流程并给出明确提示。

#### 技术实现

**文件位置**: `src/pages/super-admin/user-management/index.tsx`

**核心代码**:

```typescript
// 验证仓库选择（司机和管理员需要，老板不需要）
if (newUserRole !== 'boss' && newUserWarehouseIds.length === 0) {
  const roleText = newUserRole === 'driver' ? '司机' : '管理员'
  showToast({title: `请为${roleText}至少选择一个仓库`, icon: 'none'})
  return
}
```

#### 分配规则

| 角色 | 是否必须分配仓库 | 最少数量 | 说明 |
|------|----------------|---------|------|
| 司机 | ✅ 是 | 1个 | 必须选择至少一个仓库 |
| 管理员 | ✅ 是 | 1个 | 必须选择至少一个仓库 |
| 老板（主账号） | ❌ 否 | 0个 | 不需要分配仓库 |
| 老板（平级账号） | ❌ 否 | 0个 | 不需要分配仓库 |

#### 用户界面

**添加司机/管理员时**:
```
┌─────────────────────────────────────┐
│  添加用户                           │
├─────────────────────────────────────┤
│  手机号: [_______________]          │
│  姓名:   [_______________]          │
│                                     │
│  用户角色:                          │
│  [司机] [管理员] [老板]             │
│                                     │
│  分配仓库: *                        │
│  ☑ 默认仓库                         │
│  ☐ 北京仓库                         │
│  ☐ 上海仓库                         │
│                                     │
│  [添加用户]                         │
└─────────────────────────────────────┘
```

**添加老板时**:
```
┌─────────────────────────────────────┐
│  添加用户                           │
├─────────────────────────────────────┤
│  手机号: [_______________]          │
│  姓名:   [_______________]          │
│                                     │
│  用户角色:                          │
│  [司机] [管理员] [老板]             │
│                                     │
│  （老板账号不需要分配仓库）         │
│                                     │
│  [添加用户]                         │
└─────────────────────────────────────┘
```

#### 错误提示

**未分配仓库时**:
```
┌─────────────────────────────────────┐
│  ⚠️ 提示                            │
├─────────────────────────────────────┤
│  请为司机至少选择一个仓库           │
│                                     │
│  [确定]                             │
└─────────────────────────────────────┘
```

---

### 4. 中央系统管理员特权

#### 功能描述
中央系统管理员（或超级管理员）在删除整个老板账号（即租户）时，不受上述所有规则的限制。执行此操作时，系统应关联删除该老板账号下的所有数据。

#### 权限说明

| 功能 | 中央管理员 | 租户老板 | 说明 |
|------|-----------|---------|------|
| 创建租户 | ✅ 可以 | ❌ 不可以 | 只有中央管理员可以创建租户 |
| 查看所有租户 | ✅ 可以 | ❌ 不可以 | 中央管理员可以查看所有租户 |
| 删除租户 | ✅ 可以 | ❌ 不可以 | 删除租户会删除所有相关数据 |
| 管理仓库 | ❌ 不可以 | ✅ 可以 | 中央管理员不直接管理仓库 |
| 管理用户 | ❌ 不可以 | ✅ 可以 | 中央管理员不直接管理用户 |

#### 删除租户流程

```
中央管理员登录
   ↓
进入租户管理页面
   ↓
选择要删除的租户
   ↓
点击删除按钮
   ↓
确认删除
   ↓
系统删除租户及所有数据
   ↓
删除成功
```

#### 删除范围

删除租户时，会删除以下所有数据：
- ✅ 租户 Schema
- ✅ 所有仓库
- ✅ 所有用户（老板、管理员、司机）
- ✅ 所有车辆
- ✅ 所有考勤记录
- ✅ 所有请假记录
- ✅ 所有计件记录
- ✅ 所有通知
- ✅ 所有其他业务数据

---

## 使用场景示例

### 场景 1：创建新租户

**操作步骤**:
1. 中央管理员登录系统
2. 进入"租户管理"页面
3. 点击"创建租户"按钮
4. 填写租户信息：
   - 公司名称：XX物流公司
   - 老板姓名：张三
   - 老板手机：13800138000
   - 老板密码：123456
5. 点击"创建"按钮

**系统自动执行**:
1. ✅ 创建租户记录
2. ✅ 创建租户 Schema (tenant_002)
3. ✅ 创建老板账号
4. ✅ 创建老板 Profile
5. ✅ **自动创建"默认仓库"** ← 新功能
6. ✅ 更新租户记录

**结果**:
- 租户创建成功
- 老板可以立即登录
- 系统中已有一个"默认仓库"可用
- 老板可以修改默认仓库的名称和配置
- 老板可以添加更多仓库

### 场景 2：添加司机

**操作步骤**:
1. 老板登录系统
2. 进入"用户管理"页面
3. 点击"添加用户"按钮
4. 填写司机信息：
   - 手机号：13900139000
   - 姓名：李四
   - 角色：司机
   - 司机类型：纯司机
5. **必须选择仓库**：勾选"默认仓库"
6. 点击"添加用户"按钮

**系统验证**:
- ✅ 手机号格式正确
- ✅ 姓名已填写
- ✅ 已选择至少一个仓库

**如果未选择仓库**:
- ❌ 系统提示："请为司机至少选择一个仓库"
- ❌ 阻止创建

### 场景 3：删除仓库

**场景 3.1：删除非最后一个仓库**

**前提条件**:
- 租户有 2 个仓库：默认仓库、北京仓库

**操作步骤**:
1. 老板登录系统
2. 进入"仓库管理"页面
3. 选择"北京仓库"
4. 点击"删除"按钮
5. 确认删除

**结果**:
- ✅ 删除成功
- ✅ 剩余 1 个仓库（默认仓库）

**场景 3.2：删除最后一个仓库**

**前提条件**:
- 租户只有 1 个仓库：默认仓库

**操作步骤**:
1. 老板登录系统
2. 进入"仓库管理"页面
3. 选择"默认仓库"
4. 点击"删除"按钮

**结果**:
- ❌ 系统提示："无法删除：每个老板号必须保留至少一个仓库"
- ❌ 删除失败
- ✅ 仓库保留

### 场景 4：添加平级老板账号

**操作步骤**:
1. 主老板登录系统
2. 进入"用户管理"页面
3. 点击"添加用户"按钮
4. 填写信息：
   - 手机号：13700137000
   - 姓名：王五
   - 角色：**老板** ← 选择老板角色
5. **不需要选择仓库**（老板角色不显示仓库选择）
6. 点击"添加用户"按钮

**结果**:
- ✅ 创建成功
- ✅ 新老板账号可以登录
- ✅ 新老板账号拥有完全权限
- ✅ 新老板账号被标记为平级账号

---

## 数据库变更

### 新增函数

#### insert_tenant_warehouse

```sql
CREATE OR REPLACE FUNCTION public.insert_tenant_warehouse(
  p_schema_name TEXT,
  p_warehouse_name TEXT,
  p_max_leave_days INTEGER,
  p_resignation_notice_days INTEGER
)
RETURNS JSONB
```

**功能**: 在租户 Schema 中插入仓库记录

**参数**:
- `p_schema_name`: 租户 Schema 名称
- `p_warehouse_name`: 仓库名称
- `p_max_leave_days`: 最大请假天数
- `p_resignation_notice_days`: 离职通知天数

**返回值**:
```json
{
  "success": true
}
```

或

```json
{
  "success": false,
  "error": "错误信息"
}
```

---

## 相关文件

### 后端文件

| 文件路径 | 说明 |
|---------|------|
| `supabase/functions/create-tenant/index.ts` | 租户创建 Edge Function |
| `supabase/migrations/00362_add_insert_tenant_warehouse_function.sql` | 创建仓库插入函数的 SQL |

### 前端文件

| 文件路径 | 说明 |
|---------|------|
| `src/pages/super-admin/warehouse-management/index.tsx` | 仓库管理页面（包含删除限制） |
| `src/pages/super-admin/user-management/index.tsx` | 用户管理页面（包含仓库分配验证） |
| `src/pages/central-admin/tenant-create/index.tsx` | 租户创建页面 |

---

## 测试验证

### 测试用例 1：创建新租户并验证默认仓库

**步骤**:
1. 使用中央管理员账号登录
2. 创建一个新租户
3. 使用新租户的老板账号登录
4. 进入"仓库管理"页面

**预期结果**:
- ✅ 可以看到一个名为"默认仓库"的仓库
- ✅ 默认仓库状态为"可用"
- ✅ 默认仓库可以被编辑
- ✅ 默认仓库的配置为：最大请假天数 7 天，离职通知天数 30 天

### 测试用例 2：验证仓库删除限制

**步骤**:
1. 使用老板账号登录
2. 进入"仓库管理"页面
3. 尝试删除唯一的仓库

**预期结果**:
- ✅ 系统提示："无法删除：每个老板号必须保留至少一个仓库"
- ✅ 删除操作被阻止
- ✅ 仓库仍然存在

### 测试用例 3：验证用户创建仓库分配

**步骤**:
1. 使用老板账号登录
2. 进入"用户管理"页面
3. 点击"添加用户"
4. 填写司机信息，但不选择仓库
5. 点击"添加用户"按钮

**预期结果**:
- ✅ 系统提示："请为司机至少选择一个仓库"
- ✅ 创建操作被阻止

### 测试用例 4：验证老板账号不需要仓库

**步骤**:
1. 使用主老板账号登录
2. 进入"用户管理"页面
3. 点击"添加用户"
4. 选择角色为"老板"

**预期结果**:
- ✅ 不显示仓库选择选项
- ✅ 可以直接创建老板账号
- ✅ 创建成功

---

## 常见问题

### Q1: 默认仓库可以被删除吗？

**A**: 可以，但前提是租户至少有 2 个仓库。如果只剩一个仓库（无论是否为默认仓库），都无法删除。

### Q2: 默认仓库可以被修改吗？

**A**: 可以。默认仓库的名称、最大请假天数、离职通知天数等所有配置都可以修改。

### Q3: 如果创建默认仓库失败会怎样？

**A**: 系统会自动回滚整个租户创建流程，包括：
- 删除老板账号
- 删除租户 Schema
- 删除租户记录

### Q4: 中央管理员可以删除仓库吗？

**A**: 不可以。中央管理员主要管理租户，不直接管理具体租户的仓库。但中央管理员可以删除整个租户，这会同时删除该租户的所有仓库。

### Q5: 平级老板账号需要分配仓库吗？

**A**: 不需要。所有老板账号（包括主账号和平级账号）都不需要分配仓库。

### Q6: 如果租户有多个仓库，删除到只剩一个时会怎样？

**A**: 可以正常删除，直到只剩一个仓库。当只剩一个仓库时，系统会阻止继续删除。

---

## 后续优化建议

1. **仓库模板功能**
   - 允许管理员创建仓库模板
   - 创建租户时可以选择使用哪个模板

2. **批量创建仓库**
   - 支持一次性创建多个仓库
   - 支持从 Excel 导入仓库信息

3. **仓库归档功能**
   - 不直接删除仓库，而是归档
   - 归档的仓库不计入"至少一个仓库"的限制

4. **仓库权限细化**
   - 为不同角色设置不同的仓库操作权限
   - 支持只读、编辑、删除等不同权限级别

5. **仓库使用统计**
   - 统计每个仓库的用户数量
   - 统计每个仓库的业务数据量
   - 在删除前提示相关统计信息
