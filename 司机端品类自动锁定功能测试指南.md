# 司机端品类自动锁定功能测试指南

## 功能说明

司机端计件录入时，品类选择会根据选中的仓库自动过滤，只显示该仓库配置的品类。

### 核心特性

1. **仓库-品类关联**：每个仓库只显示该仓库配置的品类
2. **单品类自动锁定**：如果仓库只有一个品类，自动选中并显示为只读
3. **多品类手动选择**：如果仓库有多个品类，显示选择器供司机选择
4. **无品类提示**：如果仓库没有配置品类，显示友好提示

## 测试账号

### 司机账号
- **手机号**：13787673732
- **密码**：123456
- **分配仓库**：好惠购、山姆

## 测试步骤

### 测试场景 1：单品类仓库（好惠购）

1. 使用司机账号登录小程序
2. 进入"计件录入"页面
3. 选择仓库：**好惠购**
4. 观察品类选择区域

**预期结果**：
- 品类自动显示为"饮料"
- 品类显示为只读状态（灰色背景）
- 显示提示文字："（该仓库仅此一个品类）"
- 无法点击修改品类

### 测试场景 2：单品类仓库（山姆）

1. 在计件录入页面
2. 切换仓库：**山姆**
3. 观察品类选择区域

**预期结果**：
- 品类自动切换为"配送点位"
- 品类显示为只读状态（灰色背景）
- 显示提示文字："（该仓库仅此一个品类）"
- 无法点击修改品类

### 测试场景 3：多品类仓库（如果配置）

如果某个仓库配置了多个品类：

1. 选择该仓库
2. 观察品类选择区域

**预期结果**：
- 显示品类选择器（白色背景）
- 可以点击选择不同的品类
- 默认选中第一个品类

### 测试场景 4：无品类仓库（如果存在）

如果某个仓库没有配置品类：

1. 选择该仓库
2. 观察品类选择区域

**预期结果**：
- 显示灰色提示："该仓库暂无可用品类"
- 无法进行计件录入

## 数据库验证

### 查看仓库品类配置

```sql
SELECT 
  w.name as warehouse_name,
  c.name as category_name,
  w.is_active as warehouse_active,
  c.is_active as category_active
FROM warehouse_categories wc
JOIN warehouses w ON wc.warehouse_id = w.id
JOIN piece_work_categories c ON wc.category_id = c.id
ORDER BY w.name, c.name;
```

**当前配置**：
- 好惠购 → 饮料
- 山姆 → 配送点位

### 查看司机仓库分配

```sql
SELECT 
  p.name as driver_name,
  p.phone,
  w.name as warehouse_name
FROM driver_warehouses dw
JOIN profiles p ON dw.driver_id = p.id
JOIN warehouses w ON dw.warehouse_id = w.id
WHERE p.phone = '13787673732'
ORDER BY w.name;
```

## 权限验证

### RLS 策略检查

司机现在拥有以下权限：

1. **查看自己仓库的品类配置**
   - 策略名称：`Drivers can view own warehouse categories`
   - 权限范围：只能查看自己被分配的仓库的品类

2. **查看品类详情**
   - 可以查看品类的名称、单价等信息

### 权限测试 SQL

```sql
-- 模拟司机查询（使用测试司机的ID）
SET LOCAL role TO authenticated;
SET LOCAL request.jwt.claims TO '{"sub": "00000000-0000-0000-0000-000000000003"}';

SELECT 
  w.name as warehouse_name,
  c.name as category_name
FROM warehouse_categories wc
JOIN warehouses w ON wc.warehouse_id = w.id
JOIN piece_work_categories c ON wc.category_id = c.id;
```

**预期结果**：
- 可以查询到好惠购→饮料
- 可以查询到山姆→配送点位
- 无法查询到其他仓库的品类

## 常见问题排查

### 问题 1：选择仓库后没有品类显示

**可能原因**：
1. 该仓库没有配置品类
2. 品类被禁用了
3. RLS 策略未生效

**排查步骤**：
1. 检查数据库中的品类配置
2. 确认品类的 `is_active` 字段为 `true`
3. 检查 RLS 策略是否正确

### 问题 2：品类显示不正确

**可能原因**：
1. 仓库品类配置错误
2. 缓存问题

**排查步骤**：
1. 下拉刷新页面
2. 重新登录
3. 检查数据库配置

### 问题 3：无法切换品类

**说明**：
- 如果仓库只有一个品类，这是正常行为
- 品类会自动锁定为只读状态
- 这是为了防止司机误操作

## 技术实现

### API 函数

```typescript
// 获取仓库的品类详细信息
getWarehouseCategoriesWithDetails(warehouseId: string): Promise<PieceWorkCategory[]>
```

### 核心逻辑

1. 当司机选择仓库时，触发 `useEffect`
2. 调用 `getWarehouseCategoriesWithDetails` 获取该仓库的品类
3. 根据品类数量决定显示方式：
   - 0 个：显示"暂无可用品类"
   - 1 个：自动选中并锁定
   - 多个：显示选择器

### UI 状态

```typescript
// 单品类：只读显示
<View className="border border-gray-300 rounded-lg p-3 bg-gray-100">
  <Text className="text-gray-800">{categories[0]?.name}</Text>
  <Text className="text-xs text-gray-500 mt-1">（该仓库仅此一个品类）</Text>
</View>

// 多品类：选择器
<Picker
  mode="selector"
  range={categories.map((c) => c.name)}
  value={selectedCategoryIndex}
  onChange={(e) => setSelectedCategoryIndex(Number(e.detail.value))}>
  <View className="border border-gray-300 rounded-lg p-3 bg-gray-50">
    <Text className="text-gray-800">{categories[selectedCategoryIndex]?.name}</Text>
  </View>
</Picker>

// 无品类：提示
<View className="border border-gray-300 rounded-lg p-3 bg-gray-100">
  <Text className="text-gray-400">该仓库暂无可用品类</Text>
</View>
```

## 更新日志

### 2025-11-11

1. **新增功能**：
   - 实现仓库品类自动过滤
   - 单品类自动锁定
   - 多品类手动选择
   - 无品类友好提示

2. **权限修复**：
   - 添加司机查看仓库品类的 RLS 策略
   - 修复司机无法查询品类的问题

3. **API 优化**：
   - 新增 `getWarehouseCategoriesWithDetails` 函数
   - 优化品类加载逻辑

4. **UI 优化**：
   - 单品类显示只读样式
   - 多品类显示选择器
   - 无品类显示灰色提示
