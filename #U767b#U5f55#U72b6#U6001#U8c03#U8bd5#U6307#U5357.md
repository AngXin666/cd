# 登录状态调试指南

## 问题描述
如果在使用中央管理系统时遇到"登录状态已过期"的错误，请按照以下步骤进行调试。

---

## 调试步骤

### 1. 打开浏览器开发者工具
- **Chrome/Edge**: 按 `F12` 或 `Ctrl+Shift+I` (Windows) / `Cmd+Option+I` (Mac)
- **Firefox**: 按 `F12` 或 `Ctrl+Shift+K` (Windows) / `Cmd+Option+K` (Mac)
- **Safari**: 按 `Cmd+Option+C` (Mac)

### 2. 切换到 Console 标签页
在开发者工具中找到并点击 "Console" 标签页。

### 3. 查看登录状态日志

#### 在租户列表页面
当你打开租户列表页面时，控制台会输出以下日志：

```
🔍 [租户列表] 检查登录状态...
📋 [租户列表] Session 获取结果: {
  hasData: true,
  hasSession: true,
  hasError: false,
  userId: "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
}
✅ [租户列表] 已登录，session 有效
用户 ID: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
用户邮箱: your-email@example.com
```

**如果看到以下日志，说明未登录：**
```
🔍 [租户列表] 检查登录状态...
📋 [租户列表] Session 获取结果: {
  hasData: true,
  hasSession: false,
  hasError: false,
  userId: undefined
}
❌ [租户列表] 未登录，session 为空
Session 详情: {...}
```

#### 在创建租户页面
当你点击"创建租户"按钮时，控制台会输出以下日志：

```
🔍 提交前检查登录状态...
✅ 提交时登录状态有效
🚀 开始创建租户: 公司名称
📋 Session 获取结果: {
  hasData: true,
  hasSession: true,
  hasError: false
}
✅ Session 有效，准备调用 Edge Function
```

**如果看到以下日志，说明登录已过期：**
```
🔍 提交前检查登录状态...
❌ 提交时未登录，session 为空
```

---

## 常见问题和解决方案

### 问题1：登录后立即显示"未登录"
**可能原因**：
- 登录失败，但没有显示错误提示
- 浏览器禁用了 localStorage
- 浏览器处于隐私模式/无痕模式

**解决方案**：
1. 检查浏览器是否允许使用 localStorage
2. 退出隐私模式/无痕模式
3. 清除浏览器缓存和 Cookie，重新登录
4. 尝试使用其他浏览器

### 问题2：登录后一段时间显示"登录状态已过期"
**可能原因**：
- Session 过期（默认 1 小时）
- 浏览器清除了 localStorage
- 访问了登录页面导致 session 被清除

**解决方案**：
1. 重新登录
2. 如果经常遇到这个问题，请联系管理员延长 session 有效期

### 问题3：在创建租户时显示"登录状态已过期"
**可能原因**：
- 在填写表单期间 session 过期
- 浏览器在后台清除了 localStorage
- 访问了其他页面导致 session 被清除

**解决方案**：
1. 不用担心，您填写的内容已自动保存为草稿
2. 重新登录后，打开创建租户页面，内容会自动恢复
3. 继续完成创建流程

### 问题4：登录后访问登录页面，再回到中央管理系统时显示"未登录"
**可能原因**：
- 登录页面的某些操作可能影响了 session

**解决方案**：
1. 避免在登录后访问登录页面
2. 如果需要切换账号，请先退出登录
3. 如果不小心访问了登录页面，请重新登录

---

## 详细日志说明

### Session 获取结果字段说明
- `hasData`: 是否成功获取到数据（通常为 true）
- `hasSession`: 是否存在有效的 session
- `hasError`: 是否有错误
- `userId`: 当前登录用户的 ID（如果已登录）

### 登录状态判断逻辑
```
如果 hasSession === true 且 userId 存在
  → 登录状态有效
否则
  → 登录状态已过期或未登录
```

---

## 如何报告问题

如果按照以上步骤仍然无法解决问题，请提供以下信息：

1. **浏览器信息**：
   - 浏览器名称和版本
   - 操作系统

2. **控制台日志**：
   - 复制完整的控制台日志（包括错误信息）
   - 截图控制台输出

3. **操作步骤**：
   - 详细描述你的操作步骤
   - 在哪个页面遇到的问题
   - 什么时候开始出现问题

4. **Session 详情**：
   - 复制 "Session 详情" 的完整输出（注意隐藏敏感信息）

---

## 临时解决方案

如果急需使用系统，可以尝试以下临时解决方案：

1. **清除浏览器数据**：
   - Chrome/Edge: 设置 → 隐私和安全 → 清除浏览数据
   - 选择"Cookie 和其他网站数据"和"缓存的图片和文件"
   - 时间范围选择"全部时间"
   - 点击"清除数据"

2. **使用无痕模式测试**：
   - 打开无痕窗口
   - 访问系统并登录
   - 如果无痕模式下正常，说明是浏览器缓存或扩展程序的问题

3. **禁用浏览器扩展**：
   - 某些浏览器扩展可能会干扰 localStorage
   - 尝试禁用所有扩展后重试

---

## 开发者信息

### 相关代码文件
- `src/pages/central-admin/tenants/index.tsx` - 租户列表页面
- `src/pages/central-admin/tenant-create/index.tsx` - 创建租户页面
- `src/db/central-admin-api.ts` - 中央管理 API
- `src/client/supabase.ts` - Supabase 客户端

### 日志标记说明
- `🔍` - 开始检查
- `📋` - 数据信息
- `✅` - 成功
- `❌` - 失败/错误
- `🚀` - 开始操作

### Session 存储位置
- 浏览器 localStorage
- Key: `sb-<project-id>-auth-token`

---

## 更新日志

### 2025-11-28 - 修复20
- 在创建租户提交前添加登录状态检查
- 增强租户列表页面的日志输出
- 添加详细的 session 信息日志
- 登录过期时自动保存草稿

### 2025-11-28 - 修复19
- 优化 RLS 策略，允许 authenticated 角色读取 profiles 表
- 移除登录页面的退出登录逻辑
- 保护中央管理系统的登录状态

### 2025-11-28 - 修复18
- 添加 RLS 策略允许匿名用户读取 profiles 表
- 修复测试账号列表加载问题
