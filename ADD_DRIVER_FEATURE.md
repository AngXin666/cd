# 添加司机功能说明文档

## 功能概述

为普通管理端和超级管理端的司机管理功能添加了"添加司机"功能，允许管理员直接在系统中创建新的司机账号，无需司机自行注册。

---

## 功能特点

### 1. 快速添加

管理员可以通过简单的表单快速添加新司机：
- 输入手机号（11位）
- 输入姓名
- 点击确认即可创建

### 2. 数据验证

系统会自动进行多重验证：
- **必填验证**：手机号和姓名都必须填写
- **格式验证**：手机号必须是11位数字，且符合中国手机号格式（1开头，第二位3-9）
- **重复检查**：自动检查手机号是否已存在，避免重复创建

### 3. 用户体验

- **内联表单**：点击"添加司机"按钮展开表单，无需跳转页面
- **即时反馈**：添加过程中显示加载状态，完成后显示成功或失败提示
- **自动刷新**：添加成功后自动刷新司机列表，新司机立即可见
- **表单重置**：添加成功或取消后自动清空表单

---

## 使用流程

### 普通管理端

1. 进入"司机管理"页面（从管理端首页点击"司机管理"）
2. 在司机列表区域，点击右上角的"添加司机"按钮
3. 表单展开，输入司机信息：
   - 手机号：11位数字
   - 姓名：司机真实姓名
4. 点击"确认添加"按钮
5. 等待系统处理（显示"添加中..."）
6. 添加成功后：
   - 显示"添加成功"提示
   - 表单自动收起
   - 司机列表自动刷新
   - 新司机出现在列表中

### 超级管理端

1. 进入"司机仓库分配"页面（从超级管理端首页点击"司机分配"）
2. 在司机列表区域，点击右上角的"添加司机"按钮
3. 后续步骤与普通管理端相同

---

## 界面设计

### 添加司机按钮

```
┌─────────────────────────────────────┐
│ 👥 选择司机          [+ 添加司机]   │
└─────────────────────────────────────┘
```

- 位置：司机列表标题右侧
- 样式：蓝色背景，白色文字
- 图标：加号图标
- 交互：点击展开表单，再次点击（显示"取消"）收起表单

### 添加司机表单

```
┌─────────────────────────────────────┐
│ 手机号                               │
│ ┌─────────────────────────────────┐ │
│ │ 请输入11位手机号                 │ │
│ └─────────────────────────────────┘ │
│                                     │
│ 姓名                                 │
│ ┌─────────────────────────────────┐ │
│ │ 请输入司机姓名                   │ │
│ └─────────────────────────────────┘ │
│                                     │
│        ✓ 确认添加                   │
└─────────────────────────────────────┘
```

- 背景：浅蓝色（#EFF6FF）
- 边框：蓝色边框
- 输入框：白色背景，灰色边框
- 按钮：蓝色背景，白色文字

---

## 技术实现

### 1. 数据库API

**新增函数**：`createDriver(phone: string, name: string)`

**位置**：`src/db/api.ts`

**功能**：
- 检查手机号是否已存在
- 创建新的profile记录
- 自动设置role为'driver'
- 返回创建的司机资料或null（失败时）

**代码示例**：
```typescript
export async function createDriver(phone: string, name: string): Promise<Profile | null> {
  try {
    // 检查手机号是否已存在
    const {data: existingProfiles} = await supabase
      .from('profiles')
      .select('*')
      .eq('phone', phone)
      .maybeSingle()

    if (existingProfiles) {
      return null // 手机号已存在
    }

    // 创建新的司机资料
    const {data, error} = await supabase
      .from('profiles')
      .insert({
        phone,
        name,
        role: 'driver'
      })
      .select()
      .maybeSingle()

    if (error || !data) {
      console.error('创建司机失败:', error)
      return null
    }

    return data as Profile
  } catch (error) {
    console.error('创建司机异常:', error)
    return null
  }
}
```

### 2. 前端状态管理

**新增状态**：
```typescript
const [showAddDriver, setShowAddDriver] = useState(false)      // 控制表单显示
const [newDriverPhone, setNewDriverPhone] = useState('')       // 手机号输入
const [newDriverName, setNewDriverName] = useState('')         // 姓名输入
const [addingDriver, setAddingDriver] = useState(false)        // 添加中状态
```

### 3. 核心函数

#### toggleAddDriver - 切换表单显示

```typescript
const toggleAddDriver = () => {
  setShowAddDriver(!showAddDriver)
  if (!showAddDriver) {
    // 重置表单
    setNewDriverPhone('')
    setNewDriverName('')
  }
}
```

#### handleAddDriver - 处理添加司机

```typescript
const handleAddDriver = async () => {
  // 1. 验证输入
  if (!newDriverPhone.trim()) {
    showToast({title: '请输入手机号', icon: 'none'})
    return
  }
  if (!newDriverName.trim()) {
    showToast({title: '请输入姓名', icon: 'none'})
    return
  }

  // 2. 验证手机号格式
  const phoneRegex = /^1[3-9]\d{9}$/
  if (!phoneRegex.test(newDriverPhone.trim())) {
    showToast({title: '请输入正确的手机号', icon: 'none'})
    return
  }

  // 3. 显示加载状态
  setAddingDriver(true)
  showLoading({title: '添加中...'})

  // 4. 调用API创建司机
  const newDriver = await createDriver(newDriverPhone.trim(), newDriverName.trim())

  // 5. 隐藏加载状态
  Taro.hideLoading()
  setAddingDriver(false)

  // 6. 处理结果
  if (newDriver) {
    showToast({title: '添加成功', icon: 'success'})
    // 重置表单
    setNewDriverPhone('')
    setNewDriverName('')
    setShowAddDriver(false)
    // 刷新司机列表
    await loadDrivers()
  } else {
    showToast({title: '添加失败，手机号可能已存在', icon: 'error'})
  }
}
```

### 4. UI组件

#### 添加司机按钮

```tsx
<View
  onClick={toggleAddDriver}
  className="flex items-center bg-blue-600 rounded-lg px-3 py-2 active:scale-95 transition-all">
  <View className={`${showAddDriver ? 'i-mdi-close' : 'i-mdi-plus'} text-white text-base mr-1`} />
  <Text className="text-white text-xs font-medium">{showAddDriver ? '取消' : '添加司机'}</Text>
</View>
```

#### 添加司机表单

```tsx
{showAddDriver && (
  <View className="bg-blue-50 rounded-lg p-4 mb-3 border-2 border-blue-200">
    {/* 手机号输入 */}
    <View className="mb-3">
      <Text className="text-gray-700 text-sm block mb-2">手机号</Text>
      <Input
        type="number"
        maxlength={11}
        placeholder="请输入11位手机号"
        value={newDriverPhone}
        onInput={(e) => setNewDriverPhone(e.detail.value)}
        className="bg-white rounded-lg px-3 py-2 text-sm border border-gray-300"
      />
    </View>
    
    {/* 姓名输入 */}
    <View className="mb-3">
      <Text className="text-gray-700 text-sm block mb-2">姓名</Text>
      <Input
        type="text"
        placeholder="请输入司机姓名"
        value={newDriverName}
        onInput={(e) => setNewDriverName(e.detail.value)}
        className="bg-white rounded-lg px-3 py-2 text-sm border border-gray-300"
      />
    </View>
    
    {/* 确认按钮 */}
    <View
      onClick={addingDriver ? undefined : handleAddDriver}
      className={`flex items-center justify-center bg-blue-600 rounded-lg py-2 active:scale-98 transition-all ${
        addingDriver ? 'opacity-50' : ''
      }`}>
      <View className="i-mdi-check text-white text-base mr-1" />
      <Text className="text-white text-sm font-medium">确认添加</Text>
    </View>
  </View>
)}
```

---

## 验证规则

### 1. 手机号验证

**规则**：
- 必须是11位数字
- 第一位必须是1
- 第二位必须是3-9之间的数字

**正则表达式**：`/^1[3-9]\d{9}$/`

**有效示例**：
- 13800138000 ✅
- 15912345678 ✅
- 18888888888 ✅

**无效示例**：
- 12345678901 ❌（第二位是2）
- 1380013800 ❌（只有10位）
- 138001380000 ❌（12位）

### 2. 姓名验证

**规则**：
- 不能为空
- 去除首尾空格后不能为空

### 3. 重复检查

**规则**：
- 手机号在数据库中必须唯一
- 如果手机号已存在，返回错误提示

---

## 错误处理

### 1. 输入验证错误

| 错误情况 | 提示信息 | 处理方式 |
|---------|---------|---------|
| 手机号为空 | "请输入手机号" | Toast提示，不执行添加 |
| 姓名为空 | "请输入姓名" | Toast提示，不执行添加 |
| 手机号格式错误 | "请输入正确的手机号" | Toast提示，不执行添加 |

### 2. 数据库错误

| 错误情况 | 提示信息 | 处理方式 |
|---------|---------|---------|
| 手机号已存在 | "添加失败，手机号可能已存在" | Toast提示，保持表单 |
| 网络错误 | "添加失败，手机号可能已存在" | Toast提示，保持表单 |
| 数据库错误 | "添加失败，手机号可能已存在" | Toast提示，保持表单 |

### 3. 成功处理

| 操作 | 行为 |
|-----|-----|
| 显示提示 | Toast显示"添加成功" |
| 重置表单 | 清空手机号和姓名输入 |
| 收起表单 | 设置showAddDriver为false |
| 刷新列表 | 调用loadDrivers()重新加载司机列表 |

---

## 使用场景

### 场景1：新司机入职

**情况**：公司招聘了新司机，需要在系统中创建账号

**操作流程**：
1. 管理员进入司机管理页面
2. 点击"添加司机"按钮
3. 输入新司机的手机号和姓名
4. 点击"确认添加"
5. 系统创建司机账号
6. 新司机可以使用手机号登录系统

**结果**：新司机账号创建成功，可以开始使用系统

### 场景2：批量添加司机

**情况**：需要添加多个新司机

**操作流程**：
1. 管理员进入司机管理页面
2. 点击"添加司机"按钮
3. 输入第一个司机的信息
4. 点击"确认添加"
5. 添加成功后，表单自动收起
6. 再次点击"添加司机"按钮
7. 输入下一个司机的信息
8. 重复步骤4-7，直到所有司机添加完成

**结果**：多个司机账号创建成功

### 场景3：手机号重复

**情况**：尝试添加的手机号已经存在

**操作流程**：
1. 管理员输入已存在的手机号
2. 点击"确认添加"
3. 系统检测到手机号重复
4. 显示"添加失败，手机号可能已存在"提示
5. 表单保持打开状态
6. 管理员可以修改手机号重新尝试

**结果**：避免重复创建账号

### 场景4：输入错误

**情况**：输入的手机号格式不正确

**操作流程**：
1. 管理员输入错误格式的手机号（如：12345678901）
2. 点击"确认添加"
3. 系统验证手机号格式
4. 显示"请输入正确的手机号"提示
5. 表单保持打开状态
6. 管理员修正手机号

**结果**：确保数据质量

---

## 视觉设计

### 配色方案

| 元素 | 颜色 | 说明 |
|-----|-----|-----|
| 按钮背景 | #2563EB（蓝色） | 主要操作按钮 |
| 按钮文字 | #FFFFFF（白色） | 按钮文字颜色 |
| 表单背景 | #EFF6FF（浅蓝色） | 表单区域背景 |
| 表单边框 | #BFDBFE（蓝色） | 表单边框颜色 |
| 输入框背景 | #FFFFFF（白色） | 输入框背景 |
| 输入框边框 | #D1D5DB（灰色） | 输入框边框 |
| 标签文字 | #374151（深灰色） | 表单标签文字 |

### 图标使用

| 图标 | 类名 | 用途 |
|-----|-----|-----|
| 加号 | `i-mdi-plus` | 添加司机按钮（未展开） |
| 关闭 | `i-mdi-close` | 添加司机按钮（已展开） |
| 对勾 | `i-mdi-check` | 确认添加按钮 |

### 交互效果

| 元素 | 效果 | 说明 |
|-----|-----|-----|
| 添加司机按钮 | `active:scale-95` | 点击时缩小到95% |
| 确认添加按钮 | `active:scale-98` | 点击时缩小到98% |
| 加载状态 | `opacity-50` | 添加中时透明度50% |
| 过渡动画 | `transition-all` | 所有变化都有过渡动画 |

---

## 数据流程

### 添加司机流程图

```
开始
  ↓
点击"添加司机"按钮
  ↓
展开表单
  ↓
输入手机号和姓名
  ↓
点击"确认添加"
  ↓
验证手机号是否为空？
  ├─ 是 → 显示"请输入手机号" → 返回表单
  └─ 否 ↓
验证姓名是否为空？
  ├─ 是 → 显示"请输入姓名" → 返回表单
  └─ 否 ↓
验证手机号格式？
  ├─ 错误 → 显示"请输入正确的手机号" → 返回表单
  └─ 正确 ↓
显示加载状态
  ↓
调用createDriver API
  ↓
检查手机号是否已存在？
  ├─ 是 → 返回null
  └─ 否 ↓
创建profile记录
  ↓
返回创建的司机资料
  ↓
隐藏加载状态
  ↓
创建成功？
  ├─ 是 → 显示"添加成功" → 重置表单 → 收起表单 → 刷新列表
  └─ 否 → 显示"添加失败，手机号可能已存在" → 保持表单
  ↓
结束
```

---

## 权限说明

### 普通管理端

- **可以添加司机**：✅
- **添加的司机**：可以被分配到管理员负责的仓库
- **权限范围**：只能管理自己负责的仓库的司机分配

### 超级管理端

- **可以添加司机**：✅
- **添加的司机**：可以被分配到任何仓库
- **权限范围**：可以管理所有司机的所有仓库分配

---

## 最佳实践

### 1. 数据准确性

- 添加司机前，确认手机号和姓名的准确性
- 使用司机的真实手机号，方便后续联系
- 姓名使用真实姓名，避免使用昵称

### 2. 批量添加

- 如需添加多个司机，建议准备好所有司机的信息
- 按顺序逐个添加，避免遗漏
- 添加完成后检查司机列表，确认所有司机都已添加

### 3. 错误处理

- 如果添加失败，检查手机号是否已存在
- 如果手机号已存在，可以在司机列表中查找该司机
- 如果是网络错误，稍后重试

### 4. 后续操作

- 添加司机后，记得为司机分配工作仓库
- 通知司机使用手机号登录系统
- 指导司机完善个人资料

---

## 常见问题

### Q1: 添加司机后，司机如何登录？

**A**: 司机使用添加时填写的手机号登录系统。首次登录时，系统会发送验证码到该手机号。

### Q2: 可以修改已添加的司机信息吗？

**A**: 可以。司机可以在个人中心修改自己的资料，管理员也可以在用户管理页面修改司机信息。

### Q3: 添加司机时手机号输错了怎么办？

**A**: 如果还未点击"确认添加"，可以直接修改。如果已经添加成功，需要在用户管理页面修改手机号。

### Q4: 为什么添加失败？

**A**: 可能的原因：
- 手机号已存在
- 手机号格式不正确
- 网络连接问题
- 数据库错误

### Q5: 添加的司机会自动分配到仓库吗？

**A**: 不会。添加司机后，需要手动为司机分配工作仓库。

### Q6: 普通管理员和超级管理员添加的司机有区别吗？

**A**: 没有区别。两者添加的司机都是相同的，只是在仓库分配权限上有所不同。

---

## 更新日志

### 2025-11-05

**新增功能**：
- ✅ 添加createDriver API函数
- ✅ 普通管理端添加"添加司机"功能
- ✅ 超级管理端添加"添加司机"功能
- ✅ 手机号格式验证
- ✅ 手机号重复检查
- ✅ 添加成功后自动刷新列表

**技术实现**：
- ✅ 使用内联表单，无需跳转页面
- ✅ 实时验证输入
- ✅ 加载状态显示
- ✅ 错误提示
- ✅ 成功提示

**用户体验**：
- ✅ 点击按钮展开/收起表单
- ✅ 添加成功后自动重置表单
- ✅ 清晰的错误提示
- ✅ 流畅的交互动画

---

## 总结

添加司机功能为管理员提供了便捷的司机账号创建工具，简化了司机入职流程。

### 核心价值

1. **提高效率**：管理员可以快速创建司机账号，无需司机自行注册
2. **数据准确**：通过验证确保手机号格式正确，避免错误数据
3. **避免重复**：自动检查手机号是否已存在，防止重复创建
4. **用户友好**：内联表单设计，操作简单直观

### 技术亮点

1. **实时验证**：输入时即时验证，提前发现错误
2. **原子操作**：创建司机和检查重复在一个事务中完成
3. **自动刷新**：添加成功后自动刷新列表，无需手动刷新
4. **错误处理**：完善的错误提示和处理机制

### 用户价值

1. **简化流程**：减少司机入职的步骤和时间
2. **降低门槛**：司机无需了解注册流程，由管理员统一创建
3. **提高准确性**：管理员可以确保信息的准确性
4. **便于管理**：集中管理司机账号，便于后续操作

---

**功能状态**：✅ 已完成并验证通过  
**实现时间**：2025-11-05  
**适用角色**：普通管理员、超级管理员  
**相关页面**：司机管理、司机仓库分配
