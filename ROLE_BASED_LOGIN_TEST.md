# 角色登录跳转测试指南

## 测试目的
验证不同角色的账号登录后能够正确跳转到对应的工作台界面。

## 测试环境准备

### 1. 确认数据库状态
```sql
-- 检查测试账户是否存在
SELECT id, phone, name, role FROM profiles ORDER BY role DESC;
```

预期结果：
| phone  | name       | role        |
|--------|-----------|-------------|
| admin  | 超级管理员 | super_admin |
| admin2 | 普通管理员 | manager     |
| admin1 | 测试司机   | driver      |

### 2. 确认仓库分配
```sql
-- 检查管理员的仓库分配
SELECT p.name as manager_name, w.name as warehouse_name
FROM manager_warehouses mw
JOIN profiles p ON mw.manager_id = p.id
JOIN warehouses w ON mw.warehouse_id = w.id;

-- 检查司机的仓库分配
SELECT p.name as driver_name, w.name as warehouse_name
FROM driver_warehouses dw
JOIN profiles p ON dw.driver_id = p.id
JOIN warehouses w ON dw.warehouse_id = w.id;
```

## 测试用例

### 测试用例 1: 司机账号登录

#### 测试步骤
1. 打开小程序/H5应用
2. 在登录页面输入：
   - 账号：`admin1`
   - 密码：`123456`
3. 点击"登录"按钮

#### 预期结果
✅ **登录成功提示**
- 显示 Toast 提示："登录成功"

✅ **页面跳转**
- 自动跳转到司机工作台页面 (`/pages/driver/index`)
- 页面标题显示："司机工作台"

✅ **界面内容**
- 显示欢迎信息："你好，测试司机"
- 显示所属仓库："东区仓库"
- 显示司机功能卡片：
  - 📍 打卡签到
  - 📊 考勤记录
  - 📦 计件录入
  - 📝 请假申请
  - 📋 离职申请

✅ **底部导航栏**
- 显示两个标签：
  - 工作台（当前选中）
  - 我的

✅ **权限验证**
- 只能看到自己的数据
- 不能访问管理员功能

---

### 测试用例 2: 普通管理员账号登录

#### 测试步骤
1. 退出当前账号（如果已登录）
2. 在登录页面输入：
   - 账号：`admin2`
   - 密码：`123456`
3. 点击"登录"按钮

#### 预期结果
✅ **登录成功提示**
- 显示 Toast 提示："登录成功"

✅ **页面跳转**
- 自动跳转到管理员工作台页面 (`/pages/manager/index`)
- 页面标题显示："管理员工作台"

✅ **界面内容**
- 显示欢迎信息："你好，普通管理员"
- 显示管理的仓库：
  - 东区仓库
  - 西区仓库
- 可以切换查看不同仓库的数据
- 显示管理员功能卡片：
  - 📊 数据汇总
  - 📈 计件报表
  - ✅ 请假审批
  - 👥 司机管理
  - 🏷️ 类别管理

✅ **底部导航栏**
- 显示两个标签：
  - 工作台（当前选中）
  - 我的

✅ **权限验证**
- 只能看到分配的仓库（东区、西区）数据
- 不能看到总部仓库的数据
- 可以查看所有司机档案
- 可以修改司机档案
- 不能修改其他管理员档案

---

### 测试用例 3: 超级管理员账号登录

#### 测试步骤
1. 退出当前账号（如果已登录）
2. 在登录页面输入：
   - 账号：`admin`
   - 密码：`123456`
3. 点击"登录"按钮

#### 预期结果
✅ **登录成功提示**
- 显示 Toast 提示："登录成功"

✅ **页面跳转**
- 自动跳转到超级管理员工作台页面 (`/pages/super-admin/index`)
- 页面标题显示："超级管理员控制台"

✅ **界面内容**
- 显示欢迎信息："你好，超级管理员"
- 显示所有仓库：
  - 全部仓库（汇总）
  - 总部仓库
  - 东区仓库
  - 西区仓库
- 可以切换查看不同仓库的数据
- 显示超级管理员功能卡片：
  - 🏢 仓库管理
  - 👥 用户管理
  - 🔐 权限配置
  - 📊 数据汇总
  - 📈 计件报表
  - ✅ 请假审批
  - 🏷️ 类别管理

✅ **底部导航栏**
- 显示两个标签：
  - 工作台（当前选中）
  - 我的

✅ **权限验证**
- 可以看到所有仓库的数据
- 可以查看和修改所有用户档案
- 可以管理仓库、分类、权限等系统设置
- 拥有最高权限

---

## 测试检查点

### 1. 登录流程检查
- [ ] 输入账号密码后，点击登录按钮
- [ ] 显示"登录中..."加载状态
- [ ] 登录成功后显示 Toast 提示
- [ ] 自动跳转到对应的工作台页面

### 2. 页面跳转检查
- [ ] 跳转过程流畅，无卡顿
- [ ] 显示加载动画（在 pages/index/index 页面）
- [ ] 正确跳转到对应角色的工作台
- [ ] 底部导航栏正常显示

### 3. 界面显示检查
- [ ] 页面标题正确
- [ ] 用户名称正确显示
- [ ] 仓库信息正确显示
- [ ] 功能卡片完整显示
- [ ] 图标和文字清晰可见

### 4. 权限验证检查
- [ ] 司机只能看到自己的数据
- [ ] 管理员只能看到分配的仓库数据
- [ ] 超级管理员可以看到所有数据
- [ ] 功能菜单根据角色正确显示

### 5. 导航栏检查
- [ ] 底部导航栏正常显示
- [ ] "工作台"标签处于选中状态
- [ ] 点击"我的"标签可以正常跳转
- [ ] 图标和文字显示正确

---

## 常见问题排查

### 问题 1: 登录后没有跳转
**可能原因**:
- 网络连接问题
- Supabase 配置错误
- 用户角色未正确设置

**排查步骤**:
1. 检查浏览器控制台是否有错误信息
2. 验证 `.env` 文件中的 Supabase 配置
3. 查询数据库确认用户角色

### 问题 2: 跳转到错误的工作台
**可能原因**:
- 用户角色数据不正确
- 角色判断逻辑错误

**排查步骤**:
1. 查询数据库确认用户角色：
   ```sql
   SELECT id, phone, name, role FROM profiles WHERE phone = 'admin1';
   ```
2. 检查 `pages/index/index.tsx` 中的角色判断逻辑

### 问题 3: 底部导航栏不显示
**可能原因**:
- 使用了 `reLaunch` 而不是 `switchTab`
- 目标页面不在 tabBar 配置中

**排查步骤**:
1. 确认登录后跳转到 `pages/index/index`
2. 检查 `app.config.ts` 中的 tabBar 配置
3. 查看控制台是否有跳转错误

### 问题 4: 页面显示空白或加载中
**可能原因**:
- 数据加载失败
- 权限验证失败
- 网络请求超时

**排查步骤**:
1. 检查网络请求是否成功
2. 查看控制台错误信息
3. 验证用户是否有访问权限

---

## 测试报告模板

### 测试信息
- **测试日期**: ___________
- **测试人员**: ___________
- **测试环境**: □ 微信小程序 □ H5浏览器
- **数据库状态**: □ 正常 □ 异常

### 测试结果

#### 司机账号 (admin1)
- [ ] 登录成功
- [ ] 跳转正确
- [ ] 界面显示正常
- [ ] 权限验证通过
- [ ] 导航栏正常

**备注**: ___________

#### 管理员账号 (admin2)
- [ ] 登录成功
- [ ] 跳转正确
- [ ] 界面显示正常
- [ ] 权限验证通过
- [ ] 导航栏正常

**备注**: ___________

#### 超级管理员账号 (admin)
- [ ] 登录成功
- [ ] 跳转正确
- [ ] 界面显示正常
- [ ] 权限验证通过
- [ ] 导航栏正常

**备注**: ___________

### 总体评价
- **测试通过率**: ____%
- **发现问题数**: ___个
- **严重问题数**: ___个
- **测试结论**: □ 通过 □ 不通过

### 问题记录
| 序号 | 问题描述 | 严重程度 | 状态 |
|------|---------|---------|------|
| 1    |         |         |      |
| 2    |         |         |      |
| 3    |         |         |      |

---

## 下一步行动

### 如果测试通过
1. ✅ 标记此功能为已完成
2. 📝 更新用户文档
3. 🚀 准备部署到生产环境

### 如果测试失败
1. 🐛 记录所有发现的问题
2. 🔍 分析问题原因
3. 🛠️ 修复问题
4. 🔄 重新测试

---

## 附录：快速测试命令

### 查询用户角色
```sql
SELECT id, phone, name, role FROM profiles WHERE phone IN ('admin', 'admin1', 'admin2');
```

### 查询仓库分配
```sql
-- 管理员仓库
SELECT p.name, w.name FROM manager_warehouses mw
JOIN profiles p ON mw.manager_id = p.id
JOIN warehouses w ON mw.warehouse_id = w.id;

-- 司机仓库
SELECT p.name, w.name FROM driver_warehouses dw
JOIN profiles p ON dw.driver_id = p.id
JOIN warehouses w ON dw.warehouse_id = w.id;
```

### 重置测试数据
```sql
-- 清空考勤记录
DELETE FROM attendance_records;

-- 清空计件记录
DELETE FROM piece_work_records;

-- 清空请假申请
DELETE FROM leave_applications;

-- 清空离职申请
DELETE FROM resignation_applications;
```
