# æµè§ˆå™¨æ§åˆ¶å°ç²˜è´´é—®é¢˜è§£å†³

## é—®é¢˜è¯´æ˜

å½“ä½ åœ¨æµè§ˆå™¨æ§åˆ¶å°ç²˜è´´ä»£ç æ—¶ï¼Œæµè§ˆå™¨ä¼šæ˜¾ç¤ºï¼š
```
å…è®¸é»è´´
```

è¿™**ä¸æ˜¯é”™è¯¯**ï¼Œè¿™æ˜¯æµè§ˆå™¨çš„å®‰å…¨æç¤ºï¼

## è§£å†³æ–¹æ³•

### Chrome/Edge æµè§ˆå™¨

#### æ–¹æ³• 1: è¾“å…¥"å…è®¸é»è´´"ï¼ˆæ¨èï¼‰
1. åœ¨æ§åˆ¶å°ä¸­**æ‰‹åŠ¨è¾“å…¥**ï¼š`å…è®¸é»è´´`
2. æŒ‰å›è½¦
3. ç„¶åå°±å¯ä»¥æ­£å¸¸ç²˜è´´ä»£ç äº†

#### æ–¹æ³• 2: ä½¿ç”¨å¿«æ·é”®
1. æŒ‰ `Command + V` ç²˜è´´ä»£ç 
2. å¦‚æœæç¤º"å…è®¸é»è´´"ï¼Œå°±è¾“å…¥è¿™å››ä¸ªå­—
3. æŒ‰å›è½¦
4. å†æ¬¡æŒ‰ `Command + V` ç²˜è´´

#### æ–¹æ³• 3: ç¦ç”¨ç²˜è´´è­¦å‘Šï¼ˆä¸æ¨èï¼‰
è¿™ä¸ªè­¦å‘Šæ˜¯ä¸ºäº†å®‰å…¨ï¼Œå»ºè®®ä¿ç•™ã€‚

---

## æœ€ç®€å•çš„æµ‹è¯•æ–¹æ³•ï¼ˆæ— éœ€ç²˜è´´å¤§æ®µä»£ç ï¼‰

### æ­¥éª¤ 1: å¯åŠ¨é¡¹ç›®
```bash
cd /workspace/app-7cdqf07mbu9t
pnpm run dev:h5
```

### æ­¥éª¤ 2: æ‰“å¼€è€æ¿ç«¯é¡µé¢
æµè§ˆå™¨ä¼šè‡ªåŠ¨æ‰“å¼€ï¼Œç™»å½•è€æ¿è´¦å·

### æ­¥éª¤ 3: æ‰“å¼€æ§åˆ¶å°
æŒ‰ `Command + Option + J`

### æ­¥éª¤ 4: é€è¡Œæ‰§è¡Œæµ‹è¯•ï¼ˆæ— éœ€ç²˜è´´ï¼‰

#### æµ‹è¯• 1: å¯¼å…¥ Supabase
åœ¨æ§åˆ¶å°è¾“å…¥å¹¶å›è½¦ï¼š
```javascript
const { supabase } = await import('/src/db/supabase.ts')
```

çœ‹åˆ° `undefined` å°±æ˜¯æˆåŠŸäº†ã€‚

#### æµ‹è¯• 2: è·å–å½“å‰ç”¨æˆ·
```javascript
const { data: { user } } = await supabase.auth.getUser()
console.log('ç”¨æˆ·ID:', user.id)
```

åº”è¯¥æ˜¾ç¤ºä½ çš„ç”¨æˆ·IDã€‚

#### æµ‹è¯• 3: æŸ¥è¯¢ç”¨æˆ·è§’è‰²
```javascript
const { data: role } = await supabase.from('user_roles').select('role').eq('user_id', user.id).maybeSingle()
console.log('è§’è‰²:', role?.role)
```

åº”è¯¥æ˜¾ç¤º `BOSS` æˆ–å…¶ä»–è§’è‰²ã€‚

#### æµ‹è¯• 4: æŸ¥è¯¢ç”¨æˆ·è¡¨
```javascript
const { data: users, error } = await supabase.from('users').select('id, name').limit(5)
console.log('ç”¨æˆ·æ•°é‡:', users?.length)
console.log('é”™è¯¯:', error)
```

åº”è¯¥æ˜¾ç¤ºç”¨æˆ·æ•°é‡ï¼Œé”™è¯¯åº”è¯¥æ˜¯ `null`ã€‚

#### æµ‹è¯• 5: æŸ¥è¯¢é€šçŸ¥è¡¨
```javascript
const { data: notifs, error: nError } = await supabase.from('notifications').select('*').limit(5)
console.log('é€šçŸ¥æ•°é‡:', notifs?.length)
console.log('é”™è¯¯:', nError)
```

åº”è¯¥æ˜¾ç¤ºé€šçŸ¥æ•°é‡ï¼Œé”™è¯¯åº”è¯¥æ˜¯ `null`ã€‚

#### æµ‹è¯• 6: æµ‹è¯•åˆ›å»ºé€šçŸ¥ï¼ˆä»…ç®¡ç†å‘˜ï¼‰
```javascript
const { data: newNotif, error: createError } = await supabase.from('notifications').insert({
  recipient_id: user.id,
  sender_id: user.id,
  type: 'system',
  title: 'æµ‹è¯•é€šçŸ¥',
  content: 'è¿™æ˜¯ä¸€æ¡æµ‹è¯•é€šçŸ¥',
  is_read: false
}).select('id').single()

console.log('åˆ›å»ºç»“æœ:', newNotif?.id ? 'æˆåŠŸ' : 'å¤±è´¥')
console.log('é”™è¯¯:', createError)
```

åº”è¯¥æ˜¾ç¤º"åˆ›å»ºç»“æœ: æˆåŠŸ"ã€‚

#### æµ‹è¯• 7: æµ‹è¯•æ›´æ–°é€šçŸ¥
```javascript
const { error: updateError } = await supabase.from('notifications').update({
  content: 'é€šçŸ¥å·²æ›´æ–°'
}).eq('id', newNotif.id)

console.log('æ›´æ–°ç»“æœ:', updateError ? 'å¤±è´¥' : 'æˆåŠŸ')
console.log('é”™è¯¯:', updateError)
```

åº”è¯¥æ˜¾ç¤º"æ›´æ–°ç»“æœ: æˆåŠŸ"ã€‚

#### æµ‹è¯• 8: æ¸…ç†æµ‹è¯•æ•°æ®
```javascript
await supabase.from('notifications').delete().eq('id', newNotif.id)
console.log('âœ… æµ‹è¯•å®Œæˆï¼')
```

---

## ä¸€é”®æµ‹è¯•è„šæœ¬ï¼ˆéœ€è¦ç²˜è´´ï¼‰

å¦‚æœä½ æƒ³ä¸€æ¬¡æ€§æ‰§è¡Œæ‰€æœ‰æµ‹è¯•ï¼Œå¯ä»¥ä½¿ç”¨è¿™ä¸ªè„šæœ¬ï¼š

### æ­¥éª¤ 1: åœ¨æ§åˆ¶å°è¾“å…¥"å…è®¸é»è´´"
æ‰‹åŠ¨è¾“å…¥è¿™å››ä¸ªå­—ï¼Œç„¶åæŒ‰å›è½¦ã€‚

### æ­¥éª¤ 2: ç²˜è´´ä»¥ä¸‹ä»£ç 
```javascript
(async () => {
  console.log('ğŸš€ å¼€å§‹æµ‹è¯•...\n');
  
  try {
    // å¯¼å…¥ Supabase
    const { supabase } = await import('/src/db/supabase.ts');
    console.log('âœ… 1. Supabase å¯¼å…¥æˆåŠŸ');
    
    // è·å–å½“å‰ç”¨æˆ·
    const { data: { user }, error: userError } = await supabase.auth.getUser();
    if (userError || !user) {
      console.error('âŒ è·å–ç”¨æˆ·å¤±è´¥:', userError);
      return;
    }
    console.log('âœ… 2. å½“å‰ç”¨æˆ·:', user.id);
    
    // æŸ¥è¯¢è§’è‰²
    const { data: roleData } = await supabase.from('user_roles').select('role').eq('user_id', user.id).maybeSingle();
    console.log('âœ… 3. ç”¨æˆ·è§’è‰²:', roleData?.role);
    
    // æŸ¥è¯¢ç”¨æˆ·è¡¨
    const { data: users, error: usersError } = await supabase.from('users').select('id, name').limit(5);
    if (usersError) {
      console.error('âŒ 4. æŸ¥è¯¢ç”¨æˆ·è¡¨å¤±è´¥:', usersError.message);
    } else {
      console.log('âœ… 4. æŸ¥è¯¢ç”¨æˆ·è¡¨æˆåŠŸï¼Œæ•°é‡:', users?.length);
    }
    
    // æŸ¥è¯¢é€šçŸ¥è¡¨
    const { data: notifs, error: notifsError } = await supabase.from('notifications').select('*').limit(5);
    if (notifsError) {
      console.error('âŒ 5. æŸ¥è¯¢é€šçŸ¥è¡¨å¤±è´¥:', notifsError.message);
    } else {
      console.log('âœ… 5. æŸ¥è¯¢é€šçŸ¥è¡¨æˆåŠŸï¼Œæ•°é‡:', notifs?.length);
    }
    
    // æµ‹è¯•åˆ›å»ºé€šçŸ¥ï¼ˆä»…ç®¡ç†å‘˜ï¼‰
    const isAdmin = roleData?.role && ['BOSS', 'MANAGER', 'PEER_ADMIN'].includes(roleData.role);
    if (isAdmin) {
      const { data: newNotif, error: createError } = await supabase.from('notifications').insert({
        recipient_id: user.id,
        sender_id: user.id,
        type: 'system',
        title: 'æµ‹è¯•é€šçŸ¥',
        content: 'è¿™æ˜¯ä¸€æ¡æµ‹è¯•é€šçŸ¥',
        is_read: false
      }).select('id').single();
      
      if (createError) {
        console.error('âŒ 6. åˆ›å»ºé€šçŸ¥å¤±è´¥:', createError.message);
      } else {
        console.log('âœ… 6. åˆ›å»ºé€šçŸ¥æˆåŠŸï¼ŒID:', newNotif.id);
        
        // æµ‹è¯•æ›´æ–°é€šçŸ¥
        const { error: updateError } = await supabase.from('notifications').update({
          content: 'é€šçŸ¥å·²æ›´æ–°'
        }).eq('id', newNotif.id);
        
        if (updateError) {
          console.error('âŒ 7. æ›´æ–°é€šçŸ¥å¤±è´¥:', updateError.message);
          console.error('âš ï¸ è¿™å¯èƒ½æ˜¯ RLS ç­–ç•¥é—®é¢˜ï¼è¯·æ‰§è¡Œä¿®å¤è„šæœ¬ã€‚');
        } else {
          console.log('âœ… 7. æ›´æ–°é€šçŸ¥æˆåŠŸ');
        }
        
        // æ¸…ç†æµ‹è¯•æ•°æ®
        await supabase.from('notifications').delete().eq('id', newNotif.id);
        console.log('âœ… 8. æµ‹è¯•æ•°æ®å·²æ¸…ç†');
      }
    } else {
      console.log('â„¹ï¸ å½“å‰ç”¨æˆ·ä¸æ˜¯ç®¡ç†å‘˜ï¼Œè·³è¿‡åˆ›å»º/æ›´æ–°æµ‹è¯•');
    }
    
    console.log('\nğŸ‰ æ‰€æœ‰æµ‹è¯•å®Œæˆï¼');
    
  } catch (error) {
    console.error('âŒ æµ‹è¯•å¼‚å¸¸:', error);
  }
})();
```

### æ­¥éª¤ 3: æŒ‰å›è½¦æ‰§è¡Œ

---

## é¢„æœŸç»“æœ

### æˆåŠŸçš„è¾“å‡º
```
ğŸš€ å¼€å§‹æµ‹è¯•...

âœ… 1. Supabase å¯¼å…¥æˆåŠŸ
âœ… 2. å½“å‰ç”¨æˆ·: xxx-xxx-xxx
âœ… 3. ç”¨æˆ·è§’è‰²: BOSS
âœ… 4. æŸ¥è¯¢ç”¨æˆ·è¡¨æˆåŠŸï¼Œæ•°é‡: 5
âœ… 5. æŸ¥è¯¢é€šçŸ¥è¡¨æˆåŠŸï¼Œæ•°é‡: 3
âœ… 6. åˆ›å»ºé€šçŸ¥æˆåŠŸï¼ŒID: xxx-xxx-xxx
âœ… 7. æ›´æ–°é€šçŸ¥æˆåŠŸ
âœ… 8. æµ‹è¯•æ•°æ®å·²æ¸…ç†

ğŸ‰ æ‰€æœ‰æµ‹è¯•å®Œæˆï¼
```

### å¤±è´¥çš„è¾“å‡º
```
âŒ 7. æ›´æ–°é€šçŸ¥å¤±è´¥: new row violates row-level security policy
âš ï¸ è¿™å¯èƒ½æ˜¯ RLS ç­–ç•¥é—®é¢˜ï¼è¯·æ‰§è¡Œä¿®å¤è„šæœ¬ã€‚
```

å¦‚æœçœ‹åˆ°è¿™ä¸ªé”™è¯¯ï¼Œéœ€è¦æ‰§è¡Œ RLS ä¿®å¤è„šæœ¬ã€‚

---

## æ‰§è¡Œ RLS ä¿®å¤è„šæœ¬

### æ­¥éª¤ 1: æ‰“å¼€ Supabase SQL Editor
ç™»å½• Supabase æ§åˆ¶å°ï¼Œè¿›å…¥ SQL Editor

### æ­¥éª¤ 2: å¤åˆ¶ä¿®å¤è„šæœ¬
åœ¨ Mac ç»ˆç«¯æ‰§è¡Œï¼š
```bash
cat /workspace/app-7cdqf07mbu9t/supabase/migrations/99999_fix_notification_rls_final.sql
```

### æ­¥éª¤ 3: ç²˜è´´åˆ° SQL Editor
å¤åˆ¶è¾“å‡ºçš„å†…å®¹ï¼Œç²˜è´´åˆ° Supabase SQL Editor

### æ­¥éª¤ 4: æ‰§è¡Œ
ç‚¹å‡» "Run" æŒ‰é’®æ‰§è¡Œ

### æ­¥éª¤ 5: é‡æ–°æµ‹è¯•
å›åˆ°æµè§ˆå™¨æ§åˆ¶å°ï¼Œé‡æ–°æ‰§è¡Œæµ‹è¯•è„šæœ¬

---

## å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆè¦è¾“å…¥"å…è®¸é»è´´"ï¼Ÿ
**A**: è¿™æ˜¯æµè§ˆå™¨çš„å®‰å…¨æœºåˆ¶ï¼Œé˜²æ­¢æ¶æ„ç½‘ç«™è‡ªåŠ¨æ‰§è¡Œä»£ç ã€‚è¾“å…¥è¿™å››ä¸ªå­—è¡¨ç¤ºä½ ç¡®è®¤è¦ç²˜è´´ä»£ç ã€‚

### Q2: å¯ä»¥ç¦ç”¨è¿™ä¸ªæç¤ºå—ï¼Ÿ
**A**: ä¸å»ºè®®ç¦ç”¨ï¼Œè¿™æ˜¯ä¸ºäº†ä½ çš„å®‰å…¨ã€‚

### Q3: æ¯æ¬¡éƒ½è¦è¾“å…¥å—ï¼Ÿ
**A**: æ˜¯çš„ï¼Œæ¯æ¬¡æ‰“å¼€æ–°çš„æ§åˆ¶å°ä¼šè¯éƒ½éœ€è¦è¾“å…¥ä¸€æ¬¡ã€‚

### Q4: å¯ä»¥ç”¨è‹±æ–‡è¾“å…¥å—ï¼Ÿ
**A**: ä¸è¡Œï¼Œå¿…é¡»è¾“å…¥ä¸­æ–‡"å…è®¸é»è´´"ã€‚

### Q5: è¾“å…¥åè¿˜æ˜¯ä¸èƒ½ç²˜è´´ï¼Ÿ
**A**: ç¡®ä¿ï¼š
1. è¾“å…¥çš„æ˜¯ä¸­æ–‡"å…è®¸é»è´´"
2. æŒ‰äº†å›è½¦é”®
3. ç„¶åå†æŒ‰ `Command + V` ç²˜è´´

---

## Safari æµè§ˆå™¨

Safari æ²¡æœ‰"å…è®¸é»è´´"çš„æç¤ºï¼Œå¯ä»¥ç›´æ¥ç²˜è´´ä»£ç ã€‚

### å¯ç”¨å¼€å‘è€…èœå•
1. Safari â†’ åå¥½è®¾ç½®ï¼ˆ`Command + ,`ï¼‰
2. é«˜çº§ â†’ å‹¾é€‰"åœ¨èœå•æ ä¸­æ˜¾ç¤ºå¼€å‘èœå•"
3. æŒ‰ `Command + Option + C` æ‰“å¼€æ§åˆ¶å°

---

## Firefox æµè§ˆå™¨

Firefox ä¹Ÿæ²¡æœ‰"å…è®¸é»è´´"çš„æç¤ºï¼Œå¯ä»¥ç›´æ¥ç²˜è´´ä»£ç ã€‚

### æ‰“å¼€æ§åˆ¶å°
æŒ‰ `Command + Option + K`

---

## æ¨èæ–¹æ¡ˆ

### æ–¹æ¡ˆ 1: ä½¿ç”¨é€è¡Œæµ‹è¯•ï¼ˆæœ€ç®€å•ï¼‰
- ä¸éœ€è¦ç²˜è´´å¤§æ®µä»£ç 
- æ¯è¡Œå•ç‹¬æ‰§è¡Œï¼Œå®¹æ˜“ç†è§£
- å¯ä»¥çœ‹åˆ°æ¯ä¸€æ­¥çš„ç»“æœ

### æ–¹æ¡ˆ 2: ä½¿ç”¨ä¸€é”®æµ‹è¯•è„šæœ¬
- éœ€è¦è¾“å…¥"å…è®¸é»è´´"
- ä¸€æ¬¡æ€§æ‰§è¡Œæ‰€æœ‰æµ‹è¯•
- ç»“æœæ›´æ¸…æ™°

### æ–¹æ¡ˆ 3: ä½¿ç”¨ Safari æˆ– Firefox
- æ²¡æœ‰ç²˜è´´é™åˆ¶
- å¯ä»¥ç›´æ¥ç²˜è´´ä»£ç 
- æ¨èä½¿ç”¨ Safariï¼ˆMac åŸç”Ÿæµè§ˆå™¨ï¼‰

---

## æ€»ç»“

1. âœ… "å…è®¸é»è´´"ä¸æ˜¯é”™è¯¯ï¼Œæ˜¯å®‰å…¨æç¤º
2. âœ… è¾“å…¥è¿™å››ä¸ªå­—åå°±å¯ä»¥ç²˜è´´äº†
3. âœ… æ¨èä½¿ç”¨é€è¡Œæµ‹è¯•æ–¹æ³•
4. âœ… æˆ–è€…ä½¿ç”¨ Safari/Firefox æµè§ˆå™¨

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**åˆ›å»ºæ—¶é—´**: 2025-11-05  
**é€‚ç”¨ç³»ç»Ÿ**: macOS  
**é—®é¢˜**: æµè§ˆå™¨æ§åˆ¶å°ç²˜è´´é™åˆ¶
