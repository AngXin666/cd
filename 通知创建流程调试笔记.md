# 通知创建流程调试笔记

## 概述
本文档详细记录了老板端和车队长端的通知创建流程，包含每一步的操作和调试信息，方便排查问题。

## 调试日志格式说明

### 日志级别
- `🔍` - 查询操作
- `📊` - 数据统计
- `✅` - 成功操作
- `❌` - 失败操作
- `⚠️` - 警告信息
- `ℹ️` - 提示信息
- `📬` - 通知发送
- `📮` - 通知创建
- `📋` - 参数信息

### 日志结构
```
╔═══════════════════════════════════════════════════════════════╗
║                   主标题                                       ║
╚═══════════════════════════════════════════════════════════════╝

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
子标题
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

## 通知创建完整流程

### 流程图
```
司机提交申请
    ↓
调用 sendDriverSubmissionNotification()
    ↓
并行查询接收者
    ├─→ 查询主账号（老板）
    ├─→ 查询平级账号
    └─→ 查询有管辖权的车队长
    ↓
汇总接收者
    ↓
创建通知记录
    ↓
发送成功/失败
```

## 详细调试步骤

### 步骤 1: 查询主账号（老板）

#### 触发位置
`src/services/notificationService.ts` - `getPrimaryAdmin()`

#### 日志输出
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔍 [通知服务] 步骤 1: 查询主账号（老板）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  📊 查询条件:
    - 表: user_roles
    - 角色: BOSS
    - 排序: user_id ASC
    - 限制: 1 条
```

#### 查询逻辑
1. 从 `user_roles` 表查询第一个 `BOSS` 角色
2. 使用查询到的 `user_id` 从 `users` 表获取用户信息

#### 成功输出
```
  ✅ 找到 BOSS 角色:
    - 用户ID: <uuid>
    - 角色: BOSS
  📊 查询用户信息:
    - 表: users
    - 用户ID: <uuid>
  ✅ 找到用户信息:
    - 用户ID: <uuid>
    - 姓名: <name>
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ [通知服务] 主账号查询成功
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

#### 失败情况
```
  ❌ 查询角色失败: <error>
  或
  ⚠️ 未找到 BOSS 角色用户
  或
  ❌ 查询用户信息失败: <error>
  或
  ⚠️ 未找到用户信息
```

#### 排查方法
1. 检查 `user_roles` 表是否有 `BOSS` 角色记录
   ```sql
   SELECT * FROM user_roles WHERE role = 'BOSS';
   ```

2. 检查 `users` 表是否有对应的用户记录
   ```sql
   SELECT * FROM users WHERE id = '<user_id>';
   ```

3. 检查 RLS 策略是否允许查询
   ```sql
   SELECT * FROM pg_policies WHERE tablename IN ('user_roles', 'users');
   ```

### 步骤 2: 查询平级账号

#### 触发位置
`src/services/notificationService.ts` - `getPeerAccounts()`

#### 日志输出
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔍 [通知服务] 步骤 2: 查询平级账号
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  📊 查询条件:
    - 表: user_roles
    - 角色: PEER_ADMIN
    - 排序: user_id ASC
```

#### 查询逻辑
1. 从 `user_roles` 表查询所有 `PEER_ADMIN` 角色
2. 使用查询到的 `user_id` 列表从 `users` 表批量获取用户信息

#### 成功输出
```
  ✅ 找到 PEER_ADMIN 角色: <count> 位
  📊 查询用户信息:
    - 表: users
    - 用户ID列表: [<uuid1>, <uuid2>, ...]
  ✅ 找到用户信息: <count> 位
    [1] <name1> (<uuid1>)
    [2] <name2> (<uuid2>)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ [通知服务] 平级账号查询成功，共 <count> 位
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

#### 无平级账号
```
  ℹ️ 未找到 PEER_ADMIN 角色用户
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
ℹ️ [通知服务] 无平级账号
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 步骤 3: 查询有管辖权的车队长

#### 触发位置
`src/services/notificationService.ts` - `getManagersWithJurisdiction()`

#### 日志输出
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔍 [通知服务] 步骤 3: 查询有管辖权的车队长
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  📋 输入参数:
    - 司机ID: <driver_id>
```

#### 查询逻辑
1. **步骤 3.1**: 查询司机所在仓库
   ```
   📊 步骤 3.1: 查询司机所在仓库
     - 表: warehouse_assignments
     - 条件: user_id = <driver_id>
   ```

2. **步骤 3.2**: 查询管理这些仓库的用户
   ```
   📊 步骤 3.2: 查询管理这些仓库的用户
     - 表: warehouse_assignments
     - 条件: warehouse_id IN [<warehouse_ids>]
   ```

3. **步骤 3.3**: 查询用户详细信息和角色
   ```
   📊 步骤 3.3: 查询用户详细信息和角色
     - 查询 users 表
     - 查询 user_roles 表（筛选 MANAGER 角色）
   ```

#### 成功输出
```
  ✅ 找到司机所在仓库:
    - 仓库数量: <count>
    - 仓库ID列表: [<warehouse_id1>, <warehouse_id2>, ...]
  ✅ 找到管理这些仓库的用户:
    - 用户数量: <count>
    - 用户ID列表: [<user_id1>, <user_id2>, ...]
  📊 查询结果:
    - 用户数量: <count>
    - MANAGER 角色数量: <count>
  ✅ 找到有管辖权的车队长:
    [1] <name1> (<user_id1>)
    [2] <name2> (<user_id2>)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ [通知服务] 车队长查询成功，共 <count> 位
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

#### 失败情况

##### 司机未分配仓库
```
  ⚠️ 司机未分配仓库
```
**排查方法**:
```sql
SELECT * FROM warehouse_assignments WHERE user_id = '<driver_id>';
```

##### 仓库没有车队长
```
  ⚠️ 没有用户管理这些仓库
```
**排查方法**:
```sql
SELECT * FROM warehouse_assignments WHERE warehouse_id IN ('<warehouse_ids>');
```

##### 没有 MANAGER 角色
```
  ⚠️ 未找到车队长（没有用户具有 MANAGER 角色）
```
**排查方法**:
```sql
SELECT * FROM user_roles WHERE user_id IN ('<user_ids>') AND role = 'MANAGER';
```

### 步骤 4: 汇总接收者

#### 日志输出
```
╔═══════════════════════════════════════════════════════════════╗
║                   📬 发送司机提交申请通知                      ║
╚═══════════════════════════════════════════════════════════════╝

📋 通知参数:
  - 司机ID: <driver_id>
  - 司机姓名: <driver_name>
  - 通知类型: <type>
  - 通知标题: <title>
  - 通知内容: <content>
  - 关联ID: <related_id>
  - 批次ID: <batch_id>
  - 审批状态: <approval_status>

✅ 参数验证通过

🚀 开始并行查询通知接收者...
  - 查询 1: 主账号（老板）
  - 查询 2: 平级账号
  - 查询 3: 有管辖权的车队长

✅ 所有查询完成，开始汇总接收者...

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📊 汇总结果 - 主账号（老板）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  ✅ 将通知主账号
    - 用户ID: <user_id>
    - 姓名: <name>
    - 角色: BOSS

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📊 汇总结果 - 平级账号
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  ✅ 将通知平级账号，共 <count> 位
    [1] <name1> (<user_id1>)
    [2] <name2> (<user_id2>)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📊 汇总结果 - 有管辖权的车队长
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  ✅ 将通知有管辖权的车队长，共 <count> 位
    [1] <name1> (<user_id1>)
    [2] <name2> (<user_id2>)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📊 最终接收者统计
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  - 总人数: <count>
  - 接收者列表:
    [1] <name1> (<role1>) - <user_id1>
    [2] <name2> (<role2>) - <user_id2>
    [3] <name3> (<role3>) - <user_id3>
```

### 步骤 5: 创建通知记录

#### 日志输出
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📮 创建通知记录
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  - 通知数量: <count>
  - 通知类型: <type>
  - 批次ID: <batch_id>
  - 审批状态: <approval_status>

  📝 准备创建的通知:
    [1] 接收者: <user_id1>
        标题: <title>
        类型: <type>
        关联ID: <related_id>
        批次ID: <batch_id>
        审批状态: <approval_status>
    [2] 接收者: <user_id2>
        标题: <title>
        类型: <type>
        关联ID: <related_id>
        批次ID: <batch_id>
        审批状态: <approval_status>
```

#### 成功输出
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ 通知发送成功
  - 成功创建 <count> 条通知
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

#### 失败输出
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
❌ 通知发送失败
  - 请检查数据库连接和 RLS 策略
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

## 常见问题排查

### 问题 1: 未找到主账号（老板）

#### 症状
```
⚠️ 未找到主账号，跳过主账号通知
```

#### 排查步骤
1. 检查 `user_roles` 表是否有 BOSS 角色
   ```sql
   SELECT * FROM user_roles WHERE role = 'BOSS';
   ```

2. 如果没有，创建一个 BOSS 用户
   ```sql
   -- 假设用户ID为 <user_id>
   INSERT INTO user_roles (user_id, role) VALUES ('<user_id>', 'BOSS');
   ```

3. 检查 `users` 表是否有对应用户
   ```sql
   SELECT * FROM users WHERE id = '<user_id>';
   ```

### 问题 2: 司机未分配仓库

#### 症状
```
⚠️ 司机未分配仓库
```

#### 排查步骤
1. 检查司机的仓库分配
   ```sql
   SELECT * FROM warehouse_assignments WHERE user_id = '<driver_id>';
   ```

2. 如果没有，分配仓库给司机
   ```sql
   INSERT INTO warehouse_assignments (warehouse_id, user_id, assigned_by)
   VALUES ('<warehouse_id>', '<driver_id>', '<admin_id>');
   ```

### 问题 3: 没有车队长管理仓库

#### 症状
```
⚠️ 没有用户管理这些仓库
```

#### 排查步骤
1. 检查仓库的管理者分配
   ```sql
   SELECT * FROM warehouse_assignments WHERE warehouse_id = '<warehouse_id>';
   ```

2. 检查管理者是否有 MANAGER 角色
   ```sql
   SELECT ur.* FROM user_roles ur
   JOIN warehouse_assignments wa ON ur.user_id = wa.user_id
   WHERE wa.warehouse_id = '<warehouse_id>' AND ur.role = 'MANAGER';
   ```

3. 如果没有，分配车队长到仓库
   ```sql
   -- 先确保用户有 MANAGER 角色
   INSERT INTO user_roles (user_id, role) VALUES ('<manager_id>', 'MANAGER');
   
   -- 然后分配仓库
   INSERT INTO warehouse_assignments (warehouse_id, user_id, assigned_by)
   VALUES ('<warehouse_id>', '<manager_id>', '<admin_id>');
   ```

### 问题 4: 通知创建失败

#### 症状
```
❌ 通知发送失败
  - 请检查数据库连接和 RLS 策略
```

#### 排查步骤
1. 检查 RLS 策略
   ```sql
   SELECT * FROM pg_policies WHERE tablename = 'notifications';
   ```

2. 检查管理员是否有创建通知的权限
   ```sql
   -- 测试创建通知
   INSERT INTO notifications (recipient_id, sender_id, type, title, content, is_read)
   VALUES ('<recipient_id>', '<sender_id>', 'system', '测试通知', '这是一条测试通知', false);
   ```

3. 如果失败，检查 `is_admin` 函数
   ```sql
   SELECT is_admin('<current_user_id>');
   ```

4. 如果返回 false，检查用户角色
   ```sql
   SELECT * FROM user_roles WHERE user_id = '<current_user_id>';
   ```

## 调试技巧

### 1. 使用浏览器控制台
打开浏览器开发者工具（F12），查看 Console 标签页，所有调试日志都会输出到这里。

### 2. 过滤日志
在控制台中使用过滤功能：
- 输入 `通知服务` 查看通知服务相关日志
- 输入 `步骤` 查看各个步骤的日志
- 输入 `❌` 查看所有错误日志
- 输入 `⚠️` 查看所有警告日志

### 3. 复制日志
右键点击日志 → "Copy" → "Copy object"，可以复制完整的日志对象，方便分析。

### 4. 保存日志
右键点击控制台 → "Save as..."，可以保存所有日志到文件。

### 5. 清除日志
点击控制台左上角的 🚫 图标，可以清除所有日志，方便重新测试。

## 测试流程

### 完整测试步骤
1. 打开浏览器开发者工具（F12）
2. 切换到 Console 标签页
3. 清除现有日志（点击 🚫 图标）
4. 司机登录，提交请假申请
5. 观察控制台输出的调试日志
6. 检查每个步骤是否成功
7. 如果有错误，根据错误信息排查问题

### 预期日志流程
```
╔═══════════════════════════════════════════════════════════════╗
║                   📬 发送司机提交申请通知                      ║
╚═══════════════════════════════════════════════════════════════╝

📋 通知参数: ...
✅ 参数验证通过

🚀 开始并行查询通知接收者...

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔍 [通知服务] 步骤 1: 查询主账号（老板）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
...
✅ [通知服务] 主账号查询成功

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔍 [通知服务] 步骤 2: 查询平级账号
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
...
ℹ️ [通知服务] 无平级账号

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔍 [通知服务] 步骤 3: 查询有管辖权的车队长
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
...
✅ [通知服务] 车队长查询成功，共 2 位

✅ 所有查询完成，开始汇总接收者...

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📊 汇总结果 - 主账号（老板）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
...

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📊 最终接收者统计
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  - 总人数: 3

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📮 创建通知记录
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
...

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ 通知发送成功
  - 成功创建 3 条通知
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

## 总结

### 关键检查点
1. ✅ 主账号（老板）是否存在
2. ✅ 司机是否分配了仓库
3. ✅ 仓库是否有车队长管理
4. ✅ 车队长是否有 MANAGER 角色
5. ✅ RLS 策略是否允许创建通知

### 常见错误
1. 司机未分配仓库 → 在老板端分配仓库
2. 仓库没有车队长 → 在老板端分配车队长
3. 用户没有正确角色 → 检查 user_roles 表
4. RLS 策略阻止创建 → 执行 RLS 修复脚本

### 调试建议
1. 始终打开浏览器控制台查看日志
2. 按步骤检查每个查询是否成功
3. 使用 SQL 查询验证数据库状态
4. 保存日志以便后续分析

---

**文档版本**: 1.0  
**创建时间**: 2025-11-05  
**适用范围**: 老板端、车队长端通知创建流程
