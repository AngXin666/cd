# 实时通知功能快速测试指南

## 🚀 快速开始

### 第一步：查看欢迎通知

1. 打开浏览器开发者工具（F12）
2. 访问任意角色的首页（管理员/超级管理员/司机）
3. 应该看到：
   - ✅ 页面顶部出现通知栏
   - ✅ 显示 3 条欢迎通知，每 5 秒自动切换
   - ✅ 控制台有详细的日志输出

**如果没有看到通知栏**，检查控制台是否有错误信息。

### 第二步：测试实时通知

#### 测试场景 1：管理员接收请假申请通知

1. **准备工作**：
   - 打开两个浏览器标签页
   - 标签页 A：登录管理员账号
   - 标签页 B：登录司机账号

2. **执行测试**：
   - 在标签页 A（管理员），打开控制台，确认看到 `✅ 实时通知订阅成功！`
   - 切换到标签页 B（司机），提交一个请假申请
   - 立即切换回标签页 A（管理员）

3. **预期结果**：
   - ✅ Toast 提示："收到新的请假申请"
   - ✅ 手机震动反馈（如果支持）
   - ✅ 顶部通知栏显示新通知
   - ✅ 控制台显示：`📨 收到新的请假申请`

#### 测试场景 2：司机接收审批结果通知

1. **准备工作**：
   - 确保司机有一个待审批的请假申请
   - 打开两个浏览器标签页
   - 标签页 A：登录司机账号
   - 标签页 B：登录管理员账号

2. **执行测试**：
   - 在标签页 A（司机），打开控制台，确认看到 `✅ 实时通知订阅成功！`
   - 切换到标签页 B（管理员），审批司机的请假申请
   - 立即切换回标签页 A（司机）

3. **预期结果**：
   - ✅ Toast 提示："您的请假申请已通过" 或 "已被驳回"
   - ✅ 手机震动反馈（如果支持）
   - ✅ 顶部通知栏显示新通知
   - ✅ 控制台显示：`📝 请假申请状态变化`

## 🔍 调试检查清单

如果通知不工作，按以下顺序检查：

### ✅ 1. 订阅状态检查

打开控制台，查找以下日志：

```
🔌 开始设置实时通知订阅: {userId: "xxx", userRole: "xxx"}
📡 创建新的订阅通道: notifications_xxx
👔 设置管理员/超级管理员监听  (或 🚗 设置司机监听)
📡 实时通知订阅状态: SUBSCRIBED
✅ 实时通知订阅成功！
```

**如果没有这些日志**：
- 检查用户是否已登录
- 检查 userId 是否正确
- 检查 Supabase 连接是否正常

### ✅ 2. 数据变更检查

当触发操作后（提交申请/审批），查找以下日志：

**管理员端应该看到：**
```
📨 收到新的请假申请: {payload}
```

**司机端应该看到：**
```
📝 请假申请状态变化: {payload}
```

**如果没有这些日志**：
- 检查 Realtime 是否正确启用
- 检查数据是否真的发生了变更
- 检查过滤条件是否正确

### ✅ 3. 通知显示检查

查找以下日志：

```
🔔 尝试显示通知: {title, content, ...}
✅ 通过防抖检查，显示通知
📢 调用 onNewNotification 回调
📢 添加新通知: {notification}
📋 当前通知列表: [...]
🔔 NotificationBar 渲染: {总通知数, 未读通知数, ...}
```

**如果有这些日志但没有看到通知栏**：
- 检查 NotificationBar 组件是否正确渲染
- 检查 CSS 样式是否正确
- 检查是否被其他元素遮挡

## 🧹 清除缓存

如果想重新看到欢迎通知，执行以下操作：

### 浏览器环境

打开控制台，执行：
```javascript
localStorage.removeItem('manager_welcome_shown')
localStorage.removeItem('super_admin_welcome_shown')
localStorage.removeItem('driver_welcome_shown')
localStorage.removeItem('app_notifications')
```

然后刷新页面。

### 微信开发者工具

方法 1：点击工具栏的"清除缓存" > "清除数据缓存"

方法 2：在控制台执行：
```javascript
Taro.removeStorageSync('manager_welcome_shown')
Taro.removeStorageSync('super_admin_welcome_shown')
Taro.removeStorageSync('driver_welcome_shown')
Taro.removeStorageSync('app_notifications')
```

然后重新编译运行。

## 📊 控制台日志说明

### 初始化日志（页面加载时）

| 日志 | 说明 |
|------|------|
| 🔌 开始设置实时通知订阅 | 开始初始化 Realtime 订阅 |
| 📡 创建新的订阅通道 | 创建 Supabase Channel |
| 👔 设置管理员/超级管理员监听 | 配置管理员端的监听规则 |
| 🚗 设置司机监听 | 配置司机端的监听规则 |
| ✅ 实时通知订阅成功！ | 订阅成功，可以接收通知 |

### 通知添加日志

| 日志 | 说明 |
|------|------|
| 📢 添加新通知 | 添加一条新通知到列表 |
| 📋 当前通知列表 | 显示当前所有通知 |
| 🔔 NotificationBar 渲染 | 通知栏组件渲染状态 |

### 实时通知日志

| 日志 | 说明 |
|------|------|
| 📨 收到新的请假申请 | 管理员收到新的请假申请 |
| 📝 请假申请状态变化 | 司机的请假申请被审批 |
| 🔔 尝试显示通知 | 准备显示通知 |
| ✅ 通过防抖检查，显示通知 | 通知将被显示 |
| 📢 调用 onNewNotification 回调 | 添加通知到通知栏 |

## 🐛 常见问题

### Q1: 看不到欢迎通知

**原因**：已经显示过了，缓存中有标记。

**解决**：清除缓存（见上方"清除缓存"部分）。

### Q2: 订阅失败

**症状**：控制台显示 `❌ 实时通知订阅失败！`

**可能原因**：
- Supabase URL 或 Key 配置错误
- 网络连接问题
- Supabase 项目未正常运行

**解决**：检查 `.env` 文件中的配置。

### Q3: 收不到实时通知

**症状**：订阅成功，但操作后没有收到通知。

**可能原因**：
- Realtime 未启用（已修复）
- 数据未真正变更
- 过滤条件不匹配

**解决**：
1. 检查控制台是否有数据变更日志（📨 或 📝）
2. 如果没有，说明 Realtime 有问题
3. 检查数据库中的数据是否真的变更了

### Q4: 通知被防抖拦截

**症状**：控制台显示 `⏭️ 防抖拦截，跳过通知`

**原因**：3 秒内重复触发了相同类型的通知。

**解决**：这是正常的保护机制，等待 3 秒后再试。
