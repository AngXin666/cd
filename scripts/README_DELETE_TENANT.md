# 删除租户功能使用指南

## 📋 功能说明

租赁管理端可以删除老板账号（租户），删除时会自动级联删除该租户下的所有数据。

## 🚀 使用方法

### 方法 1：通过租赁管理端界面（推荐）

1. 登录租赁管理端
2. 进入"租户列表"页面
3. 找到要删除的租户
4. 点击"删除"按钮
5. 查看详细的删除确认对话框
6. 确认无误后点击"确认删除"
7. 等待删除完成

### 方法 2：使用测试脚本

```bash
# 列出所有租户
cd /workspace/app-7cdqf07mbu9t
npx tsx scripts/test-delete-tenant.ts

# 测试删除指定租户（不会实际删除，仅显示统计信息）
npx tsx scripts/test-delete-tenant.ts [租户ID]
```

## 📊 删除范围

删除租户时会自动删除以下所有数据：

- ✅ 平级账号
- ✅ 车队长
- ✅ 司机
- ✅ 车辆
- ✅ 仓库和仓库品类
- ✅ 考勤记录
- ✅ 请假记录
- ✅ 计件记录
- ✅ 通知
- ✅ 其他所有关联数据

## ⚠️ 重要提示

### 1. 不可恢复

删除操作是**永久性**的，无法恢复。请在删除前确认：
- 确实需要删除该租户
- 已经备份了重要数据（如需要）
- 了解删除的影响范围

### 2. 只能删除主账号

- ✅ 可以删除主账号（main_account_id = NULL）
- ❌ 不能删除平级账号（main_account_id ≠ NULL）
- 💡 删除主账号时，平级账号会自动级联删除

### 3. 删除确认

系统会显示详细的删除确认对话框，包括：
- 租户名称和手机号
- 将要删除的数据统计
- 不可恢复的警告

示例：
```
⚠️ 危险操作

删除租户：张三
手机号：13800000001

将同时删除：
• 平级账号：2 个
• 车队长：5 名
• 该租户下的所有司机
• 所有车辆、仓库数据
• 所有考勤、请假记录

此操作不可恢复！
```

## 🛡️ 安全机制

### 1. 身份验证

- 只能删除角色为 `super_admin` 的账号
- 只能删除主账号，不能删除平级账号

### 2. 二次确认

- 用户必须在确认对话框中点击"确认删除"
- 显示详细的删除影响范围

### 3. 错误处理

- 如果删除失败，会显示错误提示
- 不会部分删除数据（要么全部删除，要么全部保留）

## 🧪 测试建议

### 测试环境

建议先在测试环境中验证删除功能：

1. 创建测试租户
2. 为测试租户添加一些数据
3. 执行删除操作
4. 验证所有数据都已删除

### 测试脚本

```bash
# 1. 查看所有租户
npx tsx scripts/list-all-accounts.ts

# 2. 测试删除功能（不会实际删除）
npx tsx scripts/test-delete-tenant.ts [租户ID]

# 3. 查看删除统计信息
# 脚本会显示将要删除的所有数据

# 4. 在租赁管理端执行实际删除

# 5. 再次查看所有账号，验证删除成功
npx tsx scripts/list-all-accounts.ts
```

## 📝 常见问题

### Q1: 删除失败怎么办？

**可能原因**：
- 网络连接问题
- 数据库权限问题
- 租户不存在或已被删除

**解决方法**：
1. 检查网络连接
2. 刷新页面重试
3. 查看浏览器控制台的错误信息
4. 联系技术支持

### Q2: 可以恢复已删除的租户吗？

**答案**：不可以。

删除操作是永久性的，无法恢复。如果需要保留数据，请在删除前备份。

### Q3: 删除租户会影响其他租户吗？

**答案**：不会。

删除操作只会删除指定租户及其关联数据，不会影响其他租户。

### Q4: 可以只删除租户，保留其下的用户吗？

**答案**：不可以。

删除租户时会自动级联删除所有关联数据，包括平级账号、车队长、司机等。这是为了保证数据一致性。

### Q5: 如何备份租户数据？

**方法 1：使用 Supabase Dashboard**
1. 登录 Supabase Dashboard
2. 进入 SQL Editor
3. 导出相关表的数据

**方法 2：使用 pg_dump**
```bash
pg_dump -h [host] -U [user] -d [database] > backup.sql
```

## 📞 技术支持

如果在使用过程中遇到问题，请：
1. 查看浏览器控制台的错误信息
2. 查看 [DELETE_TENANT_FIX_SUMMARY.md](../DELETE_TENANT_FIX_SUMMARY.md) 了解技术细节
3. 联系技术支持团队

## 📚 相关文档

- [删除租户功能修复总结](../DELETE_TENANT_FIX_SUMMARY.md)
- [查询所有账号总结](../QUERY_ACCOUNTS_SUMMARY.md)
- [用户迁移功能总结](../USER_MIGRATION_SUMMARY.md)

---

**创建日期**：2025-11-05  
**最后更新**：2025-11-05  
**维护人员**：秒哒 AI
