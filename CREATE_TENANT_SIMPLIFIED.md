# 创建租户功能简化说明

## 更新时间
2025-11-27

## 更新内容

### 1. 表单字段简化

创建租户表单现在只包含以下必要字段：

#### 基本信息
- **公司名称** (必填)
- **老板姓名** (必填)
- **老板电话** (必填) - 用于接收通知和验证码登录

#### 登录信息
- **登录账号** (必填) - 用于账号密码登录，4-20位字母、数字或下划线
- **登录密码** (必填) - 至少6位
- **确认密码** (必填) - 必须与登录密码一致

**移除的字段**：
- 联系人
- 联系电话
- 联系邮箱
- 租期设置

### 2. 密码二次验证

- 添加了"确认密码"字段
- 提交时会验证两次输入的密码是否一致
- 如果不一致，会提示"两次输入的密码不一致"

### 3. 登录账号支持

#### 创建租户时
- 老板必须设置一个自定义的登录账号（4-20位字母、数字或下划线）
- 系统会将账号名转换为邮箱格式（`账号名@fleet.local`）存储在 Supabase Auth 中
- 账号名会同时保存在 `user_metadata.account` 字段中

#### 登录时
老板可以使用以下任一方式登录：
1. **登录账号 + 密码**
2. **手机号 + 密码**
3. **手机号 + 验证码**

### 4. 技术实现

#### 前端修改
- **文件**: `src/pages/central-admin/tenant-create/index.tsx`
  - 简化表单状态，只保留必要字段：`company_name`, `boss_name`, `boss_phone`, `boss_account`, `boss_password`
  - 添加 `confirmPassword` 状态用于密码二次验证
  - 更新表单验证逻辑，添加账号名格式验证和密码一致性验证
  - 简化表单 UI，只显示必要的输入框
  - 移除了 `Picker` 组件的导入（不再需要日期选择）

- **文件**: `src/db/types.ts`
  - 在 `CreateTenantInput` 接口中添加 `boss_account?: string` 字段

- **文件**: `src/pages/login/index.tsx`
  - 更新密码登录逻辑，支持账号名登录
  - 如果输入的不是手机号，会自动添加 `@fleet.local` 后缀转换为邮箱格式进行登录

#### 后端修改
- **文件**: `supabase/functions/create-tenant/index.ts`
  - 在 `CreateTenantInput` 接口中添加 `boss_account?: string` 字段
  - 创建用户时，如果提供了 `boss_account`，将其转换为邮箱格式（`账号名@fleet.local`）
  - 将账号名保存在 `user_metadata.account` 字段中

### 5. 使用示例

#### 创建租户
```
公司名称: 测试公司
老板姓名: 张三
老板电话: 13800138000
登录账号: zhangsan
登录密码: 123456
确认密码: 123456
```

#### 登录方式
老板可以使用以下任一方式登录：
1. 账号名登录: `zhangsan` + `123456`
2. 手机号登录: `13800138000` + `123456`
3. 验证码登录: `13800138000` + 验证码

### 6. 验证规则

#### 公司名称
- 必填
- 不能为空

#### 老板姓名
- 必填
- 不能为空

#### 老板电话
- 必填
- 11位数字
- 必须是有效的中国大陆手机号
- 正则表达式: `/^1[3-9]\d{9}$/`

#### 登录账号
- 必填
- 4-20位字符
- 只允许字母、数字、下划线
- 正则表达式: `/^[a-zA-Z0-9_]{4,20}$/`

#### 登录密码
- 必填
- 至少6位
- 两次输入必须一致

### 7. 成功提示

创建成功后会显示：
```
租户"[公司名称]"创建成功！

登录账号：[账号名]
密码：[密码]
手机号：[手机号]

请妥善保管账号信息。
```

## 界面展示

### 基本信息卡片
- 公司名称输入框
- 老板姓名输入框
- 老板电话输入框（带提示：用于接收通知和验证码登录）

### 登录信息卡片
- 登录账号输入框（带提示：用于账号密码登录）
- 登录密码输入框（带提示：密码至少6位）
- 确认密码输入框（带提示：请再次输入密码以确认）

### 提示信息
- 📌 自动化部署说明
  - 系统将自动创建独立的数据库 Schema
  - 自动初始化所有业务表结构
  - 自动创建老板账号并设置权限
  - 整个过程约需 3-5 秒

### 操作按钮
- 取消按钮（灰色）
- 创建租户按钮（蓝色）

## 注意事项

1. **账号唯一性**: 系统会自动检查账号名是否已被使用（通过邮箱唯一性约束）
2. **密码安全**: 建议使用强密码，至少包含字母和数字
3. **账号保管**: 创建成功后请妥善保管账号信息，系统不会再次显示密码
4. **登录方式**: 老板可以选择最方便的方式登录（账号名或手机号）
5. **表单简化**: 移除了不必要的字段，使创建流程更加简洁高效

## 相关文件

- `src/pages/central-admin/tenant-create/index.tsx` - 创建租户页面
- `src/db/types.ts` - 类型定义
- `src/pages/login/index.tsx` - 登录页面
- `supabase/functions/create-tenant/index.ts` - 创建租户 Edge Function
