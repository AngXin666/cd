# 通知分类错误修复总结

## 问题描述

用户反馈：**请假驳回通知错误地显示在"权限变更"分类中**，而不是"请假/离职"分类。

## 问题分析

### 1. 通知分类系统

通知中心有三个分类：
- **请假/离职** (`leave_resignation`) - 包含请假和离职相关的通知
- **车辆审批** (`vehicle_approval`) - 包含车辆审核相关的通知
- **权限变更** (`permission`) - 包含权限、仓库分配等通知

### 2. 分类逻辑

代码中的 `getNotificationCategory()` 函数负责根据通知类型自动确定分类：

```typescript
export function getNotificationCategory(type: NotificationType): NotificationCategory {
  // 请假离职信息
  if (
    type === 'leave_application_submitted' ||
    type === 'leave_approved' ||
    type === 'leave_rejected' ||  // ← 请假驳回应该在这里
    type === 'resignation_application_submitted' ||
    type === 'resignation_approved' ||
    type === 'resignation_rejected'
  ) {
    return 'leave_resignation'
  }
  
  // 车辆审批信息
  if (
    type === 'vehicle_review_pending' ||
    type === 'vehicle_review_approved' ||
    type === 'vehicle_review_need_supplement'
  ) {
    return 'vehicle_approval'
  }
  
  // 权限信息（默认分类）
  return 'permission'
}
```

### 3. 根本原因

代码逻辑是正确的，但**数据库中的历史通知数据的 `category` 字段值不正确**。

查询数据库发现：

```sql
SELECT type::text, category::text, COUNT(*) 
FROM notifications 
WHERE type::text LIKE '%reject%'
GROUP BY type, category;

-- 结果显示：
-- leave_rejected 通知有的是 leave_resignation（正确）
-- 但大部分是 permission（错误）
```

## 修复方案

### 1. 数据修复 Migration

创建并执行数据修复 migration，更新所有历史通知的 `category` 字段：

```sql
-- 修复请假离职信息的分类
UPDATE notifications
SET category = 'leave_resignation'::notification_category
WHERE type IN (
  'leave_application_submitted',
  'leave_approved',
  'leave_rejected',
  'resignation_application_submitted',
  'resignation_approved',
  'resignation_rejected'
)
AND category != 'leave_resignation'::notification_category;

-- 修复车辆审批信息的分类
UPDATE notifications
SET category = 'vehicle_approval'::notification_category
WHERE type IN (
  'vehicle_review_pending',
  'vehicle_review_approved',
  'vehicle_review_need_supplement'
)
AND category != 'vehicle_approval'::notification_category;

-- 修复权限信息的分类
UPDATE notifications
SET category = 'permission'::notification_category
WHERE type IN (
  'warehouse_assigned',
  'warehouse_unassigned',
  'driver_type_changed',
  'permission_change',
  'driver_info_update',
  'driver_created',
  'system_notice'
)
AND category != 'permission'::notification_category;
```

### 2. 验证修复结果

执行修复后，再次查询数据库：

```sql
SELECT type::text, category::text, COUNT(*) 
FROM notifications 
GROUP BY type, category 
ORDER BY category, type;

-- 结果：
-- ✓ leave_approved: leave_resignation (12条)
-- ✓ leave_rejected: leave_resignation (36条)
-- ✓ resignation_rejected: leave_resignation (2条)
-- ✓ driver_type_changed: permission (6条)
-- ✓ warehouse_assigned: permission (6条)
-- ✓ warehouse_unassigned: permission (2条)
```

所有通知的分类现在都正确了！

## 修复效果

### 修复前
- ✗ 请假驳回通知显示在"权限变更"分类中
- ✗ 用户需要在错误的分类中查找请假相关通知
- ✗ 通知分类功能失效

### 修复后
- ✓ 请假驳回通知正确显示在"请假/离职"分类中
- ✓ 所有请假相关通知（提交、批准、驳回）都在同一分类
- ✓ 通知分类功能正常工作

## 影响范围

### 修复的通知类型

**请假/离职分类** (`leave_resignation`):
- `leave_application_submitted` - 请假申请提交
- `leave_approved` - 请假批准
- `leave_rejected` - **请假驳回** ← 本次修复重点
- `resignation_application_submitted` - 离职申请提交
- `resignation_approved` - 离职批准
- `resignation_rejected` - 离职驳回

**车辆审批分类** (`vehicle_approval`):
- `vehicle_review_pending` - 车辆待审核
- `vehicle_review_approved` - 车辆审核通过
- `vehicle_review_need_supplement` - 车辆需要补录

**权限变更分类** (`permission`):
- `warehouse_assigned` - 仓库分配
- `warehouse_unassigned` - 仓库取消分配
- `driver_type_changed` - 司机类型变更
- `permission_change` - 权限变更
- `driver_info_update` - 司机信息更新
- `driver_created` - 司机创建
- `system_notice` - 系统通知

### 修复的数据量

- 请假驳回通知：36 条
- 离职驳回通知：2 条
- 其他类型通知：已验证分类正确

## 技术细节

### 1. 为什么会出现这个问题？

可能的原因：
1. 早期版本的代码在创建通知时没有正确设置 `category` 字段
2. 数据库迁移时的默认值设置不当
3. 某些通知创建逻辑绕过了 `getNotificationCategory()` 函数

### 2. 如何避免将来再次出现？

1. **代码层面**：
   - 所有通知创建都必须通过 `createNotification()` 函数
   - 该函数会自动调用 `getNotificationCategory()` 确定分类
   - 禁止直接插入 notifications 表

2. **数据库层面**：
   - 可以考虑添加触发器，自动根据 `type` 字段设置 `category`
   - 或者添加约束，确保 `type` 和 `category` 的组合是合法的

3. **测试层面**：
   - 添加自动化测试，验证每种通知类型的分类是否正确
   - 定期检查数据库中是否有分类错误的通知

## 相关文件

### 修改的文件
- `supabase/migrations/00144_fix_notification_category_data.sql` - 数据修复 migration

### 相关代码文件
- `src/db/notificationApi.ts` - 通知 API 和分类逻辑
- `src/pages/shared/notification-center/index.tsx` - 通知中心页面

## 测试验证

### 测试步骤

1. 登录任意角色账号
2. 进入通知中心
3. 点击"请假/离职"分类
4. 查看是否包含请假驳回通知

### 预期结果

- ✓ 请假驳回通知显示在"请假/离职"分类中
- ✓ 不再出现在"权限变更"分类中
- ✓ 所有请假相关通知都在同一分类

## 相关提交

- `835a6f8` - 修复通知分类错误
- `f2f66a9` - 添加达标率显示问题修复总结文档
- `c4dea69` - 修复达标率显示问题并优化提示信息

## 总结

此次修复通过执行数据修复 migration，成功将所有历史通知的 `category` 字段更新为正确的值。现在：

1. **请假驳回通知正确显示在"请假/离职"分类中**
2. **所有通知类型的分类都已验证正确**
3. **通知中心的分类筛选功能正常工作**

用户现在可以在正确的分类中找到请假相关的所有通知，提升了系统的可用性和用户体验。
