# 仓库分配数据同步 - 测试指南

## 快速测试步骤

### 测试前准备

1. **确认账号信息**
   - 超级管理员：`admin` / `admin123`
   - 普通管理员：`admin2` / `admin123`

2. **确认系统中有仓库**
   - 至少创建一个仓库用于测试

---

## 测试场景 1: 首次分配仓库

### 步骤

1. **使用超级管理员登录**
   ```
   手机号：admin
   密码：admin123
   ```

2. **进入"管理员仓库分配"页面**
   - 在超级管理端首页点击"管理员仓库分配"

3. **选择 admin2 管理员**
   - 在管理员列表中点击 admin2

4. **选择一个或多个仓库**
   - 勾选要分配的仓库

5. **点击"保存"按钮**
   - 观察提示信息

6. **验证提示信息**
   - ✅ 应该显示"分配成功，数据已同步"
   - ✅ 2秒后应该弹出详细的 Modal 提示
   - ✅ Modal 内容应该说明"管理员下次登录时将自动同步最新数据"

7. **退出超级管理员账号**

8. **使用 admin2 登录**
   ```
   手机号：admin2
   密码：admin123
   ```

9. **验证结果**
   - ✅ 应该立即看到分配的仓库
   - ✅ 不应该显示"暂无分配仓库"
   - ✅ 仓库列表应该显示刚才分配的仓库

### 预期结果

- ✅ 数据实时同步
- ✅ 无需等待或手动刷新
- ✅ 提示信息清晰明确

---

## 测试场景 2: 修改仓库分配

### 步骤

1. **admin2 当前已分配仓库 A**

2. **使用超级管理员登录**

3. **进入"管理员仓库分配"页面**

4. **选择 admin2 管理员**

5. **取消勾选仓库 A，勾选仓库 B**

6. **点击"保存"**

7. **退出超级管理员账号**

8. **使用 admin2 重新登录**
   - 如果已经登录，可以退出后重新登录
   - 或者切换到其他页面再回到首页

9. **验证结果**
   - ✅ 应该看到仓库 B
   - ✅ 不应该看到仓库 A
   - ✅ 数据已更新

### 预期结果

- ✅ 修改立即生效
- ✅ 显示最新的仓库分配

---

## 测试场景 3: 取消所有仓库分配

### 步骤

1. **admin2 当前已分配仓库**

2. **使用超级管理员登录**

3. **进入"管理员仓库分配"页面**

4. **选择 admin2 管理员**

5. **取消勾选所有仓库**

6. **点击"保存"**

7. **退出超级管理员账号**

8. **使用 admin2 重新登录**

9. **验证结果**
   - ✅ 应该显示"暂无分配仓库"
   - ✅ 不应该显示任何仓库
   - ✅ 提示信息正确

### 预期结果

- ✅ 取消分配立即生效
- ✅ 正确显示空状态

---

## 测试场景 4: 页面刷新测试

### 步骤

1. **admin2 已分配仓库**

2. **使用 admin2 登录**

3. **在首页查看仓库列表**

4. **不退出登录，使用超级管理员在另一个设备/浏览器修改仓库分配**

5. **在 admin2 的页面上，切换到其他 Tab 再切换回来**
   - 或者下拉刷新

6. **验证结果**
   - ✅ 应该看到最新的仓库分配
   - ✅ 数据已更新

### 预期结果

- ✅ 页面显示时自动刷新数据
- ✅ 无需手动刷新

---

## 测试场景 5: 多次快速修改

### 步骤

1. **使用超级管理员登录**

2. **快速修改 admin2 的仓库分配多次**
   - 第1次：分配仓库 A
   - 第2次：分配仓库 B
   - 第3次：分配仓库 A 和 B
   - 第4次：取消所有

3. **使用 admin2 登录**

4. **验证结果**
   - ✅ 应该显示最后一次的分配结果（取消所有）
   - ✅ 不应该显示中间状态的数据

### 预期结果

- ✅ 显示最新的分配结果
- ✅ 不会出现数据不一致

---

## 常见问题排查

### Q1: admin2 登录后还是显示"暂无分配仓库"

**可能原因**：
1. 超级管理员没有成功保存
2. 网络问题导致数据没有同步
3. 缓存没有正确清除

**排查步骤**：
1. 检查超级管理员保存时是否显示"分配成功"
2. 使用超级管理员重新查看 admin2 的仓库分配，确认是否保存成功
3. admin2 退出登录后重新登录
4. 尝试下拉刷新页面

### Q2: 修改仓库分配后，admin2 看到的还是旧数据

**可能原因**：
1. admin2 没有重新登录或刷新页面
2. 网络延迟

**排查步骤**：
1. admin2 切换到其他 Tab 再切换回来
2. 下拉刷新页面
3. 退出登录后重新登录

### Q3: 保存时提示"保存失败"

**可能原因**：
1. 网络问题
2. 数据库连接问题
3. 权限问题

**排查步骤**：
1. 检查网络连接
2. 查看浏览器控制台是否有错误信息
3. 确认超级管理员账号权限正常

---

## 技术验证

### 验证缓存清除

1. **打开浏览器开发者工具**
2. **切换到 Console 标签**
3. **执行分配仓库操作**
4. **查看日志输出**
   - 应该看到：`[API] 已清除管理员 xxx 的仓库缓存`

### 验证数据刷新

1. **打开浏览器开发者工具**
2. **切换到 Network 标签**
3. **admin2 登录后切换页面**
4. **查看网络请求**
   - 应该看到对 `manager_warehouses` 表的查询请求
   - 请求应该返回最新的数据

### 验证数据库

1. **使用 Supabase Dashboard**
2. **查看 `manager_warehouses` 表**
3. **确认数据是否正确保存**
   ```sql
   SELECT * FROM manager_warehouses 
   WHERE manager_id = '00000000-0000-0000-0000-000000000002';
   ```

---

## 性能测试

### 测试页面加载速度

1. **admin2 登录**
2. **记录首页加载时间**
3. **切换到其他页面再回到首页**
4. **记录刷新时间**

**预期结果**：
- 首次加载：< 2 秒
- 刷新加载：< 1 秒

### 测试网络请求

1. **打开 Network 标签**
2. **admin2 登录并查看首页**
3. **统计网络请求数量**

**预期结果**：
- 仓库列表请求：1 次
- 仪表板数据请求：1 次
- 司机统计请求：1 次

---

## 测试检查清单

### 功能测试
- [ ] 首次分配仓库 - 立即生效
- [ ] 修改仓库分配 - 实时同步
- [ ] 取消所有仓库 - 正确显示
- [ ] 页面刷新 - 自动更新
- [ ] 多次快速修改 - 显示最新数据

### 用户体验测试
- [ ] 保存成功提示清晰
- [ ] Modal 提示信息准确
- [ ] 无需手动刷新
- [ ] 加载速度快

### 技术验证
- [ ] 缓存正确清除
- [ ] 数据库正确更新
- [ ] 网络请求正常
- [ ] 日志输出正确

### 边界情况测试
- [ ] 网络断开时的处理
- [ ] 同时多个管理员分配
- [ ] 分配不存在的仓库
- [ ] 分配已删除的仓库

---

## 测试报告模板

### 测试信息
- 测试日期：____________________
- 测试人员：____________________
- 测试环境：____________________

### 测试结果

| 测试场景 | 预期结果 | 实际结果 | 状态 | 备注 |
|---------|---------|---------|------|------|
| 首次分配仓库 | 立即生效 | | ☐ 通过 ☐ 失败 | |
| 修改仓库分配 | 实时同步 | | ☐ 通过 ☐ 失败 | |
| 取消所有仓库 | 正确显示 | | ☐ 通过 ☐ 失败 | |
| 页面刷新 | 自动更新 | | ☐ 通过 ☐ 失败 | |
| 多次快速修改 | 显示最新 | | ☐ 通过 ☐ 失败 | |

### 发现的问题
1. _______________________________________________
2. _______________________________________________
3. _______________________________________________

### 总体评价
☐ 完全通过  
☐ 部分通过  
☐ 未通过  

### 建议
_______________________________________________
_______________________________________________
_______________________________________________

---

## 相关文档

- `WAREHOUSE_ASSIGNMENT_SYNC_FIX.md` - 详细的修复说明
- `ALL_ACCOUNTS.md` - 所有账号列表
- `PROFILES_RLS_ENABLED.md` - RLS 策略说明

---

**文档更新时间**: 2025-11-14 22:10  
**文档维护**: Miaoda AI Assistant  
**文档版本**: 1.0
