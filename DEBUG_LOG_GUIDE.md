# 调试日志使用指南

## 📋 概述

本文档详细说明如何使用调试日志来跟踪添加司机后的数据写入情况，帮助开发者和管理员快速定位问题。

---

## 🔍 如何查看调试日志

### 方法1：浏览器开发者工具（推荐）

#### H5 环境
1. 打开车队管家 H5 应用
2. 按 `F12` 打开浏览器开发者工具
3. 切换到 `Console`（控制台）标签页
4. 执行添加司机操作
5. 查看控制台输出的详细日志

#### 微信开发者工具
1. 打开微信开发者工具
2. 点击顶部菜单 `调试` → `调试器`
3. 切换到 `Console` 标签页
4. 执行添加司机操作
5. 查看控制台输出的详细日志

### 方法2：真机调试（微信小程序）

1. 在微信开发者工具中点击 `预览`
2. 使用手机微信扫码打开小程序
3. 在微信开发者工具的 `Console` 中查看日志
4. 或使用 `vConsole` 在手机上查看日志（需要集成）

---

## 📊 日志格式说明

### 日志结构

每次调用 `createDriver` 函数都会输出以下结构的日志：

```
================================================================================
🚀 [createDriver] 函数调用开始
⏰ 时间戳: 2025-01-10T10:30:45.123Z
📱 输入参数:
  - 手机号: 13800138000
  - 姓名: 张三
================================================================================

📋 [步骤1] 检查手机号是否已存在
  - 查询条件: phone = 13800138000
  ✅ 手机号可用，继续创建

📋 [步骤2] 创建 profiles 表记录
  - 插入数据: {
      "phone": "13800138000",
      "name": "张三",
      "role": "driver",
      "login_account": "13800138000@fleet.com",
      "email": "13800138000@fleet.com"
    }
  ✅ profiles 表记录创建成功
  - 用户ID: 550e8400-e29b-41d4-a716-446655440000
  - 手机号: 13800138000
  - 姓名: 张三
  - 角色: driver
  - 登录账号: 13800138000@fleet.com
  - 邮箱: 13800138000@fleet.com
  - 创建时间: 2025-01-10T10:30:45.456Z
  - 完整数据: { ... }

📋 [步骤3] 创建 auth.users 表记录
  - 目标用户ID: 550e8400-e29b-41d4-a716-446655440000
  - 登录邮箱: 13800138000@fleet.com
  - 默认密码: 123456
  ✅ auth.users 记录创建成功
  - RPC 返回数据: null
  - 登录账号: 13800138000@fleet.com
  - 默认密码: 123456
  💡 用户可以使用以下方式登录:
    1. 手机号 + 密码: 13800138000 / 123456
    2. 邮箱 + 密码: 13800138000@fleet.com / 123456
    3. 手机号 + 验证码

================================================================================
✅ [createDriver] 函数执行完成
📊 最终结果:
  - profiles 表: ✅ 创建成功
  - auth.users 表: 请查看上方日志
  - 返回数据: { ... }
================================================================================
```

### 日志符号说明

| 符号 | 含义 | 说明 |
|------|------|------|
| 🚀 | 开始 | 函数调用开始 |
| ⏰ | 时间 | 操作时间戳 |
| 📱 | 输入 | 输入参数 |
| 📋 | 步骤 | 执行步骤 |
| ✅ | 成功 | 操作成功 |
| ❌ | 失败 | 操作失败 |
| ⚠️ | 警告 | 需要注意的情况 |
| 💡 | 提示 | 有用的信息 |
| 📊 | 结果 | 最终结果 |

---

## 🔍 常见日志场景

### 场景1：成功创建司机

```
================================================================================
🚀 [createDriver] 函数调用开始
⏰ 时间戳: 2025-01-10T10:30:45.123Z
📱 输入参数:
  - 手机号: 13800138000
  - 姓名: 张三
================================================================================

📋 [步骤1] 检查手机号是否已存在
  - 查询条件: phone = 13800138000
  ✅ 手机号可用，继续创建

📋 [步骤2] 创建 profiles 表记录
  - 插入数据: { ... }
  ✅ profiles 表记录创建成功
  - 用户ID: xxx
  - 手机号: 13800138000
  - 姓名: 张三
  ...

📋 [步骤3] 创建 auth.users 表记录
  - 目标用户ID: xxx
  - 登录邮箱: 13800138000@fleet.com
  - 默认密码: 123456
  ✅ auth.users 记录创建成功
  ...

================================================================================
✅ [createDriver] 函数执行完成
📊 最终结果:
  - profiles 表: ✅ 创建成功
  - auth.users 表: 请查看上方日志
  - 返回数据: { ... }
================================================================================
```

**说明**：
- ✅ profiles 表记录创建成功
- ✅ auth.users 表记录创建成功
- ✅ 用户可以正常登录

---

### 场景2：手机号已存在

```
================================================================================
🚀 [createDriver] 函数调用开始
⏰ 时间戳: 2025-01-10T10:30:45.123Z
📱 输入参数:
  - 手机号: 13800138000
  - 姓名: 张三
================================================================================

📋 [步骤1] 检查手机号是否已存在
  - 查询条件: phone = 13800138000
  ⚠️ 手机号已存在
  已存在的用户ID: xxx
  已存在的用户姓名: 李四
  ❌ 创建失败：手机号重复
```

**说明**：
- ❌ 手机号已被其他用户使用
- ❌ 创建失败
- 💡 需要使用其他手机号

---

### 场景3：profiles 创建成功，auth.users 创建失败

```
================================================================================
🚀 [createDriver] 函数调用开始
⏰ 时间戳: 2025-01-10T10:30:45.123Z
📱 输入参数:
  - 手机号: 13800138000
  - 姓名: 张三
================================================================================

📋 [步骤1] 检查手机号是否已存在
  - 查询条件: phone = 13800138000
  ✅ 手机号可用，继续创建

📋 [步骤2] 创建 profiles 表记录
  - 插入数据: { ... }
  ✅ profiles 表记录创建成功
  - 用户ID: xxx
  ...

📋 [步骤3] 创建 auth.users 表记录
  - 目标用户ID: xxx
  - 登录邮箱: 13800138000@fleet.com
  - 默认密码: 123456
  ❌ 创建 auth.users 记录失败
  错误代码: 23505
  错误消息: duplicate key value violates unique constraint "profiles_pkey"
  错误详情: { ... }
  ⚠️ profiles 记录已创建，但 auth.users 记录创建失败
  💡 用户可以通过手机号验证码登录
  💡 或稍后通过编辑用户信息创建登录账号

================================================================================
✅ [createDriver] 函数执行完成
📊 最终结果:
  - profiles 表: ✅ 创建成功
  - auth.users 表: 请查看上方日志
  - 返回数据: { ... }
================================================================================
```

**说明**：
- ✅ profiles 表记录创建成功
- ❌ auth.users 表记录创建失败
- 💡 用户可以通过手机号验证码登录
- 💡 管理员可以稍后通过编辑用户信息重新创建登录账号

---

### 场景4：数据库插入失败

```
================================================================================
🚀 [createDriver] 函数调用开始
⏰ 时间戳: 2025-01-10T10:30:45.123Z
📱 输入参数:
  - 手机号: 13800138000
  - 姓名: 张三
================================================================================

📋 [步骤1] 检查手机号是否已存在
  - 查询条件: phone = 13800138000
  ✅ 手机号可用，继续创建

📋 [步骤2] 创建 profiles 表记录
  - 插入数据: { ... }
  ❌ 插入失败: { ... }
  错误代码: 42501
  错误消息: new row violates row-level security policy for table "profiles"
  错误详情: { ... }
```

**说明**：
- ❌ profiles 表记录创建失败
- ❌ 可能是权限问题（RLS 策略）
- 💡 需要检查数据库权限配置

---

### 场景5：函数执行异常

```
================================================================================
🚀 [createDriver] 函数调用开始
⏰ 时间戳: 2025-01-10T10:30:45.123Z
📱 输入参数:
  - 手机号: 13800138000
  - 姓名: 张三
================================================================================

📋 [步骤1] 检查手机号是否已存在
  - 查询条件: phone = 13800138000

================================================================================
❌ [createDriver] 函数执行异常
异常类型: object
异常内容: Error: Network request failed
异常消息: Network request failed
异常堆栈: Error: Network request failed
    at ...
================================================================================
```

**说明**：
- ❌ 函数执行过程中发生异常
- ❌ 可能是网络问题或数据库连接问题
- 💡 需要检查网络连接和数据库状态

---

## 🛠️ 调试技巧

### 1. 过滤日志

在浏览器控制台中，可以使用过滤功能快速定位日志：

- 输入 `createDriver` 只显示相关日志
- 输入 `✅` 只显示成功日志
- 输入 `❌` 只显示失败日志
- 输入 `⚠️` 只显示警告日志

### 2. 保存日志

在浏览器控制台中：
1. 右键点击控制台
2. 选择 `Save as...`
3. 保存为文本文件

### 3. 复制日志

在浏览器控制台中：
1. 选中需要复制的日志
2. 右键点击
3. 选择 `Copy`
4. 粘贴到文本编辑器或问题报告中

### 4. 清空日志

在浏览器控制台中：
1. 点击左上角的 🚫 图标
2. 或按 `Ctrl + L`（Windows）/ `Cmd + K`（Mac）

---

## 📝 日志分析示例

### 示例1：分析成功创建的日志

```
✅ profiles 表记录创建成功
  - 用户ID: 550e8400-e29b-41d4-a716-446655440000
  - 手机号: 13800138000
  - 姓名: 张三
  - 角色: driver
  - 登录账号: 13800138000@fleet.com
  - 邮箱: 13800138000@fleet.com
  - 创建时间: 2025-01-10T10:30:45.456Z
```

**分析**：
- ✅ 用户ID 已生成（UUID 格式）
- ✅ 手机号、姓名正确
- ✅ 角色为 `driver`（司机）
- ✅ 登录账号和邮箱自动生成（格式：`{手机号}@fleet.com`）
- ✅ 创建时间已记录

**验证方法**：
1. 在 Supabase 控制台中查询 `profiles` 表
2. 使用用户ID查找记录：`SELECT * FROM profiles WHERE id = '550e8400-e29b-41d4-a716-446655440000'`
3. 验证所有字段是否正确

---

### 示例2：分析失败的日志

```
❌ 创建 auth.users 记录失败
  错误代码: 23505
  错误消息: duplicate key value violates unique constraint "profiles_pkey"
  错误详情: {
    "code": "23505",
    "details": "Key (id)=(550e8400-e29b-41d4-a716-446655440000) already exists.",
    "hint": null,
    "message": "duplicate key value violates unique constraint \"profiles_pkey\""
  }
```

**分析**：
- ❌ 错误代码 `23505` 表示唯一约束冲突
- ❌ 错误消息显示主键冲突
- ❌ 用户ID 已存在于 `profiles` 表中

**可能原因**：
1. `handle_new_user` 触发器尝试插入已存在的记录
2. 数据库触发器配置问题

**解决方法**：
1. 检查 `handle_new_user` 触发器是否正确配置
2. 确保触发器在插入前检查记录是否已存在
3. 参考 `supabase/migrations/36_fix_update_user_email_check_profile_exists.sql`

---

## 🔧 常见问题排查

### 问题1：看不到日志

**可能原因**：
1. 控制台被清空
2. 日志级别设置过滤了 `console.log`
3. 浏览器禁用了控制台

**解决方法**：
1. 刷新页面重新执行操作
2. 检查控制台设置，确保显示所有日志级别
3. 尝试使用其他浏览器

---

### 问题2：日志显示乱码

**可能原因**：
1. 浏览器编码设置问题
2. 特殊字符显示问题

**解决方法**：
1. 使用 Chrome 或 Edge 浏览器（推荐）
2. 检查浏览器编码设置（应为 UTF-8）

---

### 问题3：日志太多，难以查找

**解决方法**：
1. 使用控制台过滤功能
2. 清空控制台后重新执行操作
3. 使用 `createDriver` 关键字过滤

---

## 📊 数据验证方法

### 方法1：Supabase 控制台查询

1. 登录 Supabase 控制台
2. 进入 `Table Editor`
3. 选择 `profiles` 表
4. 查找新创建的记录
5. 验证所有字段是否正确

### 方法2：SQL 查询

```sql
-- 查询最新创建的司机
SELECT * FROM profiles 
WHERE role = 'driver' 
ORDER BY created_at DESC 
LIMIT 10;

-- 查询特定手机号的司机
SELECT * FROM profiles 
WHERE phone = '13800138000';

-- 查询 auth.users 表中的记录
SELECT id, email, phone, created_at 
FROM auth.users 
WHERE email = '13800138000@fleet.com';
```

### 方法3：前端页面验证

1. 刷新司机列表页面
2. 查找新创建的司机
3. 点击查看详情
4. 验证所有信息是否正确

---

## 📚 相关文档

- [数据插入详细说明](./DATA_INSERTION_GUIDE.md)
- [用户创建和登录流程优化总结](./USER_CREATION_AND_LOGIN_OPTIMIZATION.md)
- [快速测试指南](./QUICK_TEST_GUIDE.md)

---

## 💡 最佳实践

1. **每次添加司机前清空控制台**
   - 便于查看最新的日志
   - 避免日志混乱

2. **保存重要的日志**
   - 遇到问题时保存日志
   - 便于后续分析和报告

3. **定期检查数据库**
   - 验证数据是否正确写入
   - 及时发现潜在问题

4. **使用过滤功能**
   - 快速定位关键信息
   - 提高调试效率

---

## 📞 技术支持

如有问题或需要帮助，请：
1. 保存完整的日志
2. 记录操作步骤
3. 联系开发团队
