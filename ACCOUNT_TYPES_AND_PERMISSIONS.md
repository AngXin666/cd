# è´¦å·ç±»å‹å’Œæƒé™ä½“ç³»

## ğŸ“‹ è´¦å·ç±»å‹æ¦‚è¿°

ç³»ç»Ÿæ”¯æŒå››ç§è´¦å·ç±»å‹ï¼Œæ¯ç§è´¦å·æ‹¥æœ‰ä¸åŒçš„æƒé™å’ŒèŒè´£ã€‚

---

## ğŸ‘¥ è´¦å·ç±»å‹è¯¦è§£

### 1. è¶…çº§ç®¡ç†å‘˜ï¼ˆsuper_adminï¼‰

**å®šä½**ï¼šä¸­å¤®ç®¡ç†ç³»ç»Ÿç®¡ç†å‘˜

**èŒè´£**ï¼š
- ç®¡ç†æ‰€æœ‰ç§Ÿæˆ·ï¼ˆè€æ¿è´¦å·ï¼‰
- ç®¡ç†ç§Ÿæˆ·é…ç½®
- ç›‘æ§ç³»ç»Ÿè¿è¡ŒçŠ¶æ€

**æƒé™**ï¼š
- âœ… åˆ›å»ºè€æ¿è´¦å·
- âœ… ä¿®æ”¹è€æ¿è´¦å·ä¿¡æ¯
- âœ… æš‚åœè€æ¿è´¦å·
- âœ… åˆ é™¤è€æ¿è´¦å·
- âœ… æŸ¥çœ‹æ‰€æœ‰ç§Ÿæˆ·é…ç½®
- âœ… ç®¡ç†ç§Ÿæˆ·æ•°æ®åº“é…ç½®
- âŒ ä¸èƒ½ç›´æ¥æ“ä½œç§Ÿæˆ·å†…éƒ¨çš„ä¸šåŠ¡æ•°æ®

**ç™»å½•å…¥å£**ï¼šä¸­å¤®ç®¡ç†ç³»ç»Ÿ

**é»˜è®¤è´¦å·**ï¼š
- ç”¨æˆ·åï¼šadmin
- å¯†ç ï¼šhye19911206
- è¯´æ˜ï¼šä¸­å¤®ç®¡ç†ç³»ç»Ÿè´¦å·ä¸éœ€è¦é‚®ç®±ï¼Œä½¿ç”¨ç”¨æˆ·åç™»å½•

---

### 2. è€æ¿ï¼ˆbossï¼‰

**å®šä½**ï¼šç§Ÿæˆ·ç³»ç»Ÿçš„æœ€é«˜æƒé™æ‰€æœ‰è€…

**èŒè´£**ï¼š
- ç®¡ç†è‡ªå·±ç§Ÿæˆ·å†…çš„æ‰€æœ‰æ•°æ®
- ç®¡ç†å¹³çº§è´¦å·
- ç®¡ç†è½¦é˜Ÿé•¿è´¦å·
- ç®¡ç†å¸æœºè´¦å·

**æƒé™**ï¼š
- âœ… æŸ¥çœ‹æ‰€æœ‰æ•°æ®
- âœ… åˆ›å»ºã€ä¿®æ”¹ã€åˆ é™¤æ‰€æœ‰æ•°æ®
- âœ… åˆ›å»ºå¹³çº§è´¦å·ï¼ˆæœ€å¤š3ä¸ªï¼‰
- âœ… æˆäºˆå¹³çº§è´¦å·æƒé™
- âœ… åˆ›å»ºè½¦é˜Ÿé•¿è´¦å·
- âœ… æˆäºˆè½¦é˜Ÿé•¿æƒé™å’Œç®¡è¾–èŒƒå›´
- âœ… åˆ›å»ºå¸æœºè´¦å·
- âœ… ä¿®æ”¹ã€åˆ é™¤å¸æœºè´¦å·

**ç™»å½•å…¥å£**ï¼šç§Ÿæˆ·ç³»ç»Ÿ

---

### 3. å¹³çº§è´¦å·ï¼ˆpeerï¼‰

**å®šä½**ï¼šä¸è€æ¿å¹³çº§çš„åä½œè´¦å·

**èŒè´£**ï¼š
- æ ¹æ®è€æ¿æˆäºˆçš„æƒé™ååŠ©ç®¡ç†ç§Ÿæˆ·
- æœ€å¤šå¯åˆ›å»º3ä¸ªå¹³çº§è´¦å·

**æƒé™ç±»å‹**ï¼š

#### 3.1 å®Œæ•´æƒé™ï¼ˆfull_permissionï¼‰
- âœ… æ‹¥æœ‰ä¸è€æ¿ç›¸åŒçš„æ‰€æœ‰æƒé™
- âœ… æŸ¥çœ‹æ‰€æœ‰æ•°æ®
- âœ… åˆ›å»ºã€ä¿®æ”¹ã€åˆ é™¤æ‰€æœ‰æ•°æ®
- âœ… ç®¡ç†è½¦é˜Ÿé•¿è´¦å·
- âœ… ç®¡ç†å¸æœºè´¦å·
- âŒ ä¸èƒ½åˆ›å»ºæˆ–ç®¡ç†å…¶ä»–å¹³çº§è´¦å·

#### 3.2 åªè¯»æƒé™ï¼ˆread_onlyï¼‰
- âœ… æŸ¥çœ‹æ‰€æœ‰æ•°æ®
- âŒ ä¸èƒ½åˆ›å»ºã€ä¿®æ”¹ã€åˆ é™¤æ•°æ®
- âŒ ä¸èƒ½ç®¡ç†ä»»ä½•è´¦å·

**ç™»å½•å…¥å£**ï¼šç§Ÿæˆ·ç³»ç»Ÿ

---

### 4. è½¦é˜Ÿé•¿ï¼ˆmanagerï¼‰

**å®šä½**ï¼šç®¡ç†æŒ‡å®šèŒƒå›´å†…çš„è½¦é˜Ÿå’Œå¸æœº

**èŒè´£**ï¼š
- ç®¡ç†åˆ†é…ç»™è‡ªå·±çš„è½¦é˜Ÿ
- ç®¡ç†ç®¡è¾–èŒƒå›´å†…çš„å¸æœº
- å¤„ç†æ—¥å¸¸è¿è¥äº‹åŠ¡

**æƒé™ç±»å‹**ï¼š

#### 4.1 å®Œæ•´æƒé™ï¼ˆfull_permissionï¼‰
- âœ… æŸ¥çœ‹ç®¡è¾–èŒƒå›´å†…çš„æ‰€æœ‰æ•°æ®
- âœ… åˆ›å»ºã€ä¿®æ”¹ã€åˆ é™¤ç®¡è¾–èŒƒå›´å†…çš„æ•°æ®
- âœ… åˆ›å»ºå¸æœºè´¦å·
- âœ… ä¿®æ”¹ã€åˆ é™¤ç®¡è¾–èŒƒå›´å†…çš„å¸æœºè´¦å·
- âœ… å®¡æ‰¹è¯·å‡ç”³è¯·
- âœ… ç®¡ç†è€ƒå‹¤è®°å½•
- âŒ ä¸èƒ½è®¿é—®ç®¡è¾–èŒƒå›´å¤–çš„æ•°æ®

#### 4.2 åªè¯»æƒé™ï¼ˆread_onlyï¼‰
- âœ… æŸ¥çœ‹ç®¡è¾–èŒƒå›´å†…çš„æ‰€æœ‰æ•°æ®
- âŒ ä¸èƒ½åˆ›å»ºã€ä¿®æ”¹ã€åˆ é™¤æ•°æ®
- âŒ ä¸èƒ½ç®¡ç†å¸æœºè´¦å·

**ç®¡è¾–èŒƒå›´**ï¼š
- ç”±è€æ¿æˆ–æ‹¥æœ‰å®Œæ•´æƒé™çš„å¹³çº§è´¦å·æŒ‡å®š
- å¯ä»¥ç®¡ç†å¤šä¸ªä»“åº“
- å¯ä»¥ç®¡ç†å¤šä¸ªè½¦é˜Ÿ
- åªèƒ½ç®¡ç†åˆ†é…ç»™è‡ªå·±çš„å¸æœº

**ç™»å½•å…¥å£**ï¼šç§Ÿæˆ·ç³»ç»Ÿ

---

### 5. å¸æœºï¼ˆdriverï¼‰

**å®šä½**ï¼šåŸºå±‚æ“ä½œäººå‘˜

**èŒè´£**ï¼š
- å®Œæˆæ—¥å¸¸å·¥ä½œä»»åŠ¡
- è®°å½•å·¥ä½œæ•°æ®
- æäº¤è¯·å‡ç”³è¯·

**æƒé™**ï¼š
- âœ… æŸ¥çœ‹è‡ªå·±çš„ä¿¡æ¯
- âœ… ä¿®æ”¹è‡ªå·±çš„åŸºæœ¬ä¿¡æ¯ï¼ˆéƒ¨åˆ†å­—æ®µï¼‰
- âœ… æ‰“å¡ç­¾åˆ°
- âœ… æäº¤è®¡ä»¶å·¥ä½œè®°å½•
- âœ… ç”³è¯·è¯·å‡
- âœ… æŸ¥çœ‹è‡ªå·±çš„è€ƒå‹¤è®°å½•
- âœ… æŸ¥çœ‹è‡ªå·±çš„å·¥èµ„è®°å½•
- âŒ ä¸èƒ½æŸ¥çœ‹å…¶ä»–å¸æœºçš„æ•°æ®
- âŒ ä¸èƒ½ä¿®æ”¹ç³»ç»Ÿé…ç½®

**ç™»å½•å…¥å£**ï¼šç§Ÿæˆ·ç³»ç»Ÿ

---

## ğŸ” æƒé™çŸ©é˜µ

| åŠŸèƒ½ | è¶…çº§ç®¡ç†å‘˜ | è€æ¿ | å¹³çº§è´¦å·ï¼ˆå®Œæ•´ï¼‰ | å¹³çº§è´¦å·ï¼ˆåªè¯»ï¼‰ | è½¦é˜Ÿé•¿ï¼ˆå®Œæ•´ï¼‰ | è½¦é˜Ÿé•¿ï¼ˆåªè¯»ï¼‰ | å¸æœº |
|------|-----------|------|----------------|----------------|--------------|--------------|------|
| ç®¡ç†ç§Ÿæˆ·é…ç½® | âœ… | âŒ | âŒ | âŒ | âŒ | âŒ | âŒ |
| åˆ›å»ºè€æ¿è´¦å· | âœ… | âŒ | âŒ | âŒ | âŒ | âŒ | âŒ |
| ä¿®æ”¹è€æ¿è´¦å· | âœ… | âŒ | âŒ | âŒ | âŒ | âŒ | âŒ |
| æš‚åœè€æ¿è´¦å· | âœ… | âŒ | âŒ | âŒ | âŒ | âŒ | âŒ |
| åˆ é™¤è€æ¿è´¦å· | âœ… | âŒ | âŒ | âŒ | âŒ | âŒ | âŒ |
| åˆ›å»ºå¹³çº§è´¦å· | âŒ | âœ… | âŒ | âŒ | âŒ | âŒ | âŒ |
| æˆäºˆå¹³çº§æƒé™ | âŒ | âœ… | âŒ | âŒ | âŒ | âŒ | âŒ |
| åˆ›å»ºè½¦é˜Ÿé•¿ | âŒ | âœ… | âœ… | âŒ | âŒ | âŒ | âŒ |
| æˆäºˆè½¦é˜Ÿé•¿æƒé™ | âŒ | âœ… | âœ… | âŒ | âŒ | âŒ | âŒ |
| åˆ›å»ºå¸æœº | âŒ | âœ… | âœ… | âŒ | âœ… | âŒ | âŒ |
| ä¿®æ”¹å¸æœºï¼ˆå…¨éƒ¨ï¼‰ | âŒ | âœ… | âœ… | âŒ | âŒ | âŒ | âŒ |
| ä¿®æ”¹å¸æœºï¼ˆç®¡è¾–èŒƒå›´ï¼‰ | âŒ | âœ… | âœ… | âŒ | âœ… | âŒ | âŒ |
| åˆ é™¤å¸æœºï¼ˆå…¨éƒ¨ï¼‰ | âŒ | âœ… | âœ… | âŒ | âŒ | âŒ | âŒ |
| åˆ é™¤å¸æœºï¼ˆç®¡è¾–èŒƒå›´ï¼‰ | âŒ | âœ… | âœ… | âŒ | âœ… | âŒ | âŒ |
| æŸ¥çœ‹æ‰€æœ‰æ•°æ® | âŒ | âœ… | âœ… | âœ… | âŒ | âŒ | âŒ |
| æŸ¥çœ‹ç®¡è¾–èŒƒå›´æ•°æ® | âŒ | âœ… | âœ… | âœ… | âœ… | âœ… | âŒ |
| æŸ¥çœ‹è‡ªå·±çš„æ•°æ® | âŒ | âœ… | âœ… | âœ… | âœ… | âœ… | âœ… |
| ä¿®æ”¹æ‰€æœ‰æ•°æ® | âŒ | âœ… | âœ… | âŒ | âŒ | âŒ | âŒ |
| ä¿®æ”¹ç®¡è¾–èŒƒå›´æ•°æ® | âŒ | âœ… | âœ… | âŒ | âœ… | âŒ | âŒ |
| ä¿®æ”¹è‡ªå·±çš„æ•°æ® | âŒ | âœ… | âœ… | âŒ | âœ… | âŒ | âœ… |
| å®¡æ‰¹è¯·å‡ | âŒ | âœ… | âœ… | âŒ | âœ… | âŒ | âŒ |
| ç”³è¯·è¯·å‡ | âŒ | âŒ | âŒ | âŒ | âŒ | âŒ | âœ… |
| æ‰“å¡ç­¾åˆ° | âŒ | âŒ | âŒ | âŒ | âŒ | âŒ | âœ… |
| æäº¤è®¡ä»¶å·¥ä½œ | âŒ | âŒ | âŒ | âŒ | âŒ | âŒ | âœ… |

---

## ğŸ—ï¸ æ•°æ®åº“è®¾è®¡

### ç‰©ç†éš”ç¦»æ¶æ„

**æ ¸å¿ƒç†å¿µ**ï¼šæ¯ä¸ªç§Ÿæˆ·ä½¿ç”¨ç‹¬ç«‹çš„æ•°æ®åº“ï¼ˆç‹¬ç«‹çš„ Schemaï¼‰ï¼Œæ•°æ®åœ¨ç‰©ç†ä¸Šå®Œå…¨éš”ç¦»ã€‚

**å…³é”®ç‚¹**ï¼š
- âœ… ä¸éœ€è¦ `tenant_id` å­—æ®µï¼ˆæ•°æ®å·²ç»ç‰©ç†éš”ç¦»ï¼‰
- âœ… ä¸éœ€è¦ `boss_id` å­—æ®µï¼ˆæ•°æ®å·²ç»ç‰©ç†éš”ç¦»ï¼‰
- âœ… åªéœ€è¦ `manager_id` æ¥æ ‡è¯†å¸æœºæ‰€å±çš„è½¦é˜Ÿé•¿
- âœ… åªéœ€è¦ `managed_warehouses` æ¥æ ‡è¯†è½¦é˜Ÿé•¿ç®¡è¾–çš„ä»“åº“

### profiles è¡¨å­—æ®µ

```sql
CREATE TABLE profiles (
  id uuid PRIMARY KEY,
  role text NOT NULL,  -- è§’è‰²ï¼šsuper_admin, boss, peer, manager, driver
  permission_level text,  -- æƒé™çº§åˆ«ï¼šfull_permission, read_onlyï¼ˆä»…å¹³çº§è´¦å·å’Œè½¦é˜Ÿé•¿ï¼‰
  manager_id uuid REFERENCES profiles(id),  -- æ‰€å±è½¦é˜Ÿé•¿ï¼ˆä»…å¸æœºï¼‰
  managed_warehouses uuid[],  -- ç®¡è¾–çš„ä»“åº“ï¼ˆä»…è½¦é˜Ÿé•¿ï¼‰
  real_name text,
  phone text,
  email text,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);
```

### å­—æ®µè¯´æ˜

- **role**ï¼šè§’è‰²ç±»å‹
  - `super_admin`ï¼šè¶…çº§ç®¡ç†å‘˜ï¼ˆä¸­å¤®ç®¡ç†ç³»ç»Ÿï¼‰
  - `boss`ï¼šè€æ¿ï¼ˆç§Ÿæˆ·ç³»ç»Ÿæœ€é«˜æƒé™æ‰€æœ‰è€…ï¼‰
  - `peer`ï¼šå¹³çº§è´¦å·
  - `manager`ï¼šè½¦é˜Ÿé•¿
  - `driver`ï¼šå¸æœº
- **permission_level**ï¼šæƒé™çº§åˆ«ï¼ˆä»…å¹³çº§è´¦å·å’Œè½¦é˜Ÿé•¿éœ€è¦ï¼‰
  - `full_permission`ï¼šå®Œæ•´æƒé™
  - `read_only`ï¼šåªè¯»æƒé™
- **manager_id**ï¼šæ‰€å±è½¦é˜Ÿé•¿IDï¼ˆä»…å¸æœºéœ€è¦ï¼‰
- **managed_warehouses**ï¼šç®¡è¾–çš„ä»“åº“IDæ•°ç»„ï¼ˆä»…è½¦é˜Ÿé•¿éœ€è¦ï¼‰

**æ³¨æ„**ï¼š
- è¶…çº§ç®¡ç†å‘˜åœ¨ä¸­å¤®ç®¡ç†ç³»ç»Ÿçš„ `public` schema ä¸­
- å…¶ä»–è§’è‰²åœ¨å„è‡ªç§Ÿæˆ·çš„ç‹¬ç«‹ schema ä¸­ï¼ˆå¦‚ `tenant_xxx`ï¼‰
- æ•°æ®é€šè¿‡ç‰©ç†éš”ç¦»ï¼Œä¸éœ€è¦ `tenant_id` æˆ– `boss_id` å­—æ®µ

---

## ğŸ”„ è´¦å·åˆ›å»ºæµç¨‹

### 1. è¶…çº§ç®¡ç†å‘˜åˆ›å»ºè€æ¿è´¦å·

```typescript
// è¶…çº§ç®¡ç†å‘˜æ“ä½œï¼ˆåœ¨ä¸­å¤®ç®¡ç†ç³»ç»Ÿï¼‰
const boss = await createBossAccount({
  real_name: 'å¼ ä¸‰',
  phone: '13800000001',
  email: 'zhangsan@example.com',
  password: 'password123'
})
```

**è¯´æ˜**ï¼š
- è¶…çº§ç®¡ç†å‘˜åœ¨ä¸­å¤®ç®¡ç†ç³»ç»Ÿåˆ›å»ºè€æ¿è´¦å·
- åŒæ—¶åˆ›å»ºç§Ÿæˆ·é…ç½®å’Œç‹¬ç«‹çš„æ•°æ®åº“ Schema
- è€æ¿è´¦å·åœ¨ç§Ÿæˆ·çš„ç‹¬ç«‹ Schema ä¸­

### 2. è€æ¿åˆ›å»ºå¹³çº§è´¦å·

```typescript
// è€æ¿æ“ä½œï¼ˆåœ¨ç§Ÿæˆ·ç³»ç»Ÿï¼‰
const peer = await createPeerAccount({
  real_name: 'æå››',
  phone: '13800000002',
  email: 'lisi@example.com',
  password: 'password123',
  permission_level: 'full_permission'  // æˆ– 'read_only'
})
```

**è¯´æ˜**ï¼š
- æœ€å¤šå¯åˆ›å»º 3 ä¸ªå¹³çº§è´¦å·
- ä¸éœ€è¦æŒ‡å®š `boss_id`ï¼ˆæ•°æ®å·²ç‰©ç†éš”ç¦»ï¼‰
- å¹³çº§è´¦å·åœ¨åŒä¸€ä¸ªç§Ÿæˆ· Schema ä¸­

### 3. è€æ¿æˆ–å¹³çº§è´¦å·ï¼ˆå®Œæ•´æƒé™ï¼‰åˆ›å»ºè½¦é˜Ÿé•¿

```typescript
// è€æ¿æˆ–å¹³çº§è´¦å·ï¼ˆå®Œæ•´æƒé™ï¼‰æ“ä½œ
const manager = await createManagerAccount({
  real_name: 'ç‹äº”',
  phone: '13800000003',
  email: 'wangwu@example.com',
  password: 'password123',
  permission_level: 'full_permission',  // æˆ– 'read_only'
  managed_warehouses: [warehouse1Id, warehouse2Id]
})
```

**è¯´æ˜**ï¼š
- ä¸éœ€è¦æŒ‡å®š `boss_id`ï¼ˆæ•°æ®å·²ç‰©ç†éš”ç¦»ï¼‰
- éœ€è¦æŒ‡å®šç®¡è¾–çš„ä»“åº“
- è½¦é˜Ÿé•¿åœ¨åŒä¸€ä¸ªç§Ÿæˆ· Schema ä¸­

### 4. è€æ¿ã€å¹³çº§è´¦å·ï¼ˆå®Œæ•´æƒé™ï¼‰æˆ–è½¦é˜Ÿé•¿ï¼ˆå®Œæ•´æƒé™ï¼‰åˆ›å»ºå¸æœº

```typescript
// è€æ¿ã€å¹³çº§è´¦å·ï¼ˆå®Œæ•´æƒé™ï¼‰æˆ–è½¦é˜Ÿé•¿ï¼ˆå®Œæ•´æƒé™ï¼‰æ“ä½œ
const driver = await createDriverAccount({
  real_name: 'èµµå…­',
  phone: '13800000004',
  password: 'password123',
  manager_id: managerId  // å¯é€‰ï¼ŒæŒ‡å®šæ‰€å±è½¦é˜Ÿé•¿
})
```

**è¯´æ˜**ï¼š
- ä¸éœ€è¦æŒ‡å®š `boss_id`ï¼ˆæ•°æ®å·²ç‰©ç†éš”ç¦»ï¼‰
- å¯é€‰æŒ‡å®š `manager_id`ï¼ˆæ‰€å±è½¦é˜Ÿé•¿ï¼‰
- å¸æœºåœ¨åŒä¸€ä¸ªç§Ÿæˆ· Schema ä¸­

---

## ğŸ›¡ï¸ RLS ç­–ç•¥è®¾è®¡

### è¶…çº§ç®¡ç†å‘˜ç­–ç•¥

```sql
-- è¶…çº§ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹æ‰€æœ‰ç§Ÿæˆ·é…ç½®ï¼ˆåœ¨ä¸­å¤®ç®¡ç†ç³»ç»Ÿçš„ public schemaï¼‰
CREATE POLICY "è¶…çº§ç®¡ç†å‘˜æŸ¥çœ‹ç§Ÿæˆ·é…ç½®" ON tenant_configs
  FOR SELECT
  TO authenticated
  USING (
    is_super_admin(auth.uid())
  );
```

**è¯´æ˜**ï¼š
- è¶…çº§ç®¡ç†å‘˜åªåœ¨ä¸­å¤®ç®¡ç†ç³»ç»Ÿçš„ `public` schema ä¸­æ“ä½œ
- ä¸èƒ½ç›´æ¥è®¿é—®ç§Ÿæˆ·çš„ä¸šåŠ¡æ•°æ®

### è€æ¿ç­–ç•¥

```sql
-- è€æ¿å¯ä»¥æŸ¥çœ‹æ‰€æœ‰æ•°æ®ï¼ˆåœ¨ç§Ÿæˆ· schema ä¸­ï¼‰
CREATE POLICY "è€æ¿æŸ¥çœ‹æ‰€æœ‰æ•°æ®" ON profiles
  FOR SELECT
  TO authenticated
  USING (
    is_boss(auth.uid())
  );
```

**è¯´æ˜**ï¼š
- ä¸éœ€è¦æ£€æŸ¥ `tenant_id` æˆ– `boss_id`ï¼ˆæ•°æ®å·²ç‰©ç†éš”ç¦»ï¼‰
- è€æ¿å¯ä»¥æŸ¥çœ‹åŒä¸€ç§Ÿæˆ· schema ä¸­çš„æ‰€æœ‰æ•°æ®

### å¹³çº§è´¦å·ç­–ç•¥

```sql
-- å¹³çº§è´¦å·ï¼ˆå®Œæ•´æƒé™ï¼‰å¯ä»¥æŸ¥çœ‹å’Œä¿®æ”¹æ‰€æœ‰æ•°æ®
CREATE POLICY "å¹³çº§è´¦å·å®Œæ•´æƒé™" ON profiles
  FOR ALL
  TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM profiles
      WHERE id = auth.uid()
      AND role = 'peer'
      AND permission_level = 'full_permission'
    )
  );

-- å¹³çº§è´¦å·ï¼ˆåªè¯»ï¼‰åªèƒ½æŸ¥çœ‹æ•°æ®
CREATE POLICY "å¹³çº§è´¦å·åªè¯»æƒé™" ON profiles
  FOR SELECT
  TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM profiles
      WHERE id = auth.uid()
      AND role = 'peer'
      AND permission_level = 'read_only'
    )
  );
```

**è¯´æ˜**ï¼š
- ä¸éœ€è¦æ£€æŸ¥ `tenant_id` æˆ– `boss_id`ï¼ˆæ•°æ®å·²ç‰©ç†éš”ç¦»ï¼‰
- å¹³çº§è´¦å·å¯ä»¥è®¿é—®åŒä¸€ç§Ÿæˆ· schema ä¸­çš„æ•°æ®

### è½¦é˜Ÿé•¿ç­–ç•¥

```sql
-- è½¦é˜Ÿé•¿ï¼ˆå®Œæ•´æƒé™ï¼‰å¯ä»¥æŸ¥çœ‹å’Œä¿®æ”¹ç®¡è¾–èŒƒå›´å†…çš„æ•°æ®
CREATE POLICY "è½¦é˜Ÿé•¿å®Œæ•´æƒé™" ON drivers
  FOR ALL
  TO authenticated
  USING (
    -- å¸æœºå±äºè½¦é˜Ÿé•¿ç®¡è¾–
    manager_id = auth.uid()
    OR
    -- å¸æœºçš„ä»“åº“åœ¨è½¦é˜Ÿé•¿ç®¡è¾–èŒƒå›´å†…
    warehouse_id IN (
      SELECT unnest(managed_warehouses) FROM profiles
      WHERE id = auth.uid()
      AND role = 'manager'
      AND permission_level = 'full_permission'
    )
  );

-- è½¦é˜Ÿé•¿ï¼ˆåªè¯»ï¼‰åªèƒ½æŸ¥çœ‹ç®¡è¾–èŒƒå›´å†…çš„æ•°æ®
CREATE POLICY "è½¦é˜Ÿé•¿åªè¯»æƒé™" ON drivers
  FOR SELECT
  TO authenticated
  USING (
    -- å¸æœºå±äºè½¦é˜Ÿé•¿ç®¡è¾–
    manager_id = auth.uid()
    OR
    -- å¸æœºçš„ä»“åº“åœ¨è½¦é˜Ÿé•¿ç®¡è¾–èŒƒå›´å†…
    warehouse_id IN (
      SELECT unnest(managed_warehouses) FROM profiles
      WHERE id = auth.uid()
      AND role = 'manager'
      AND permission_level = 'read_only'
    )
  );
```

**è¯´æ˜**ï¼š
- ä¸éœ€è¦æ£€æŸ¥ `tenant_id` æˆ– `boss_id`ï¼ˆæ•°æ®å·²ç‰©ç†éš”ç¦»ï¼‰
- è½¦é˜Ÿé•¿åªèƒ½è®¿é—®ç®¡è¾–èŒƒå›´å†…çš„æ•°æ®

### å¸æœºç­–ç•¥

```sql
-- å¸æœºåªèƒ½æŸ¥çœ‹å’Œä¿®æ”¹è‡ªå·±çš„æ•°æ®
CREATE POLICY "å¸æœºæŸ¥çœ‹è‡ªå·±çš„æ•°æ®" ON profiles
  FOR SELECT
  TO authenticated
  USING (
    id = auth.uid()
    AND role = 'driver'
  );

CREATE POLICY "å¸æœºä¿®æ”¹è‡ªå·±çš„æ•°æ®" ON profiles
  FOR UPDATE
  TO authenticated
  USING (
    id = auth.uid()
    AND role = 'driver'
  );
```

**è¯´æ˜**ï¼š
- ä¸éœ€è¦æ£€æŸ¥ `tenant_id` æˆ– `boss_id`ï¼ˆæ•°æ®å·²ç‰©ç†éš”ç¦»ï¼‰
- å¸æœºåªèƒ½è®¿é—®è‡ªå·±çš„æ•°æ®

---

## ğŸ“± ç•Œé¢è®¾è®¡

### è¶…çº§ç®¡ç†å‘˜ç•Œé¢

- ç§Ÿæˆ·é…ç½®ç®¡ç†
- è€æ¿è´¦å·ç®¡ç†
- ç³»ç»Ÿç›‘æ§

### è€æ¿ç•Œé¢

- ä»ªè¡¨ç›˜
- å¹³çº§è´¦å·ç®¡ç†
- è½¦é˜Ÿé•¿ç®¡ç†
- å¸æœºç®¡ç†
- è½¦è¾†ç®¡ç†
- ä»“åº“ç®¡ç†
- è€ƒå‹¤ç®¡ç†
- å·¥èµ„ç®¡ç†
- æŠ¥è¡¨ç»Ÿè®¡

### å¹³çº§è´¦å·ç•Œé¢ï¼ˆå®Œæ•´æƒé™ï¼‰

- ä¸è€æ¿ç•Œé¢ç›¸åŒï¼ˆé™¤äº†å¹³çº§è´¦å·ç®¡ç†ï¼‰

### å¹³çº§è´¦å·ç•Œé¢ï¼ˆåªè¯»ï¼‰

- ä»ªè¡¨ç›˜ï¼ˆåªè¯»ï¼‰
- æ•°æ®æŸ¥çœ‹ï¼ˆåªè¯»ï¼‰
- æŠ¥è¡¨æŸ¥çœ‹ï¼ˆåªè¯»ï¼‰

### è½¦é˜Ÿé•¿ç•Œé¢ï¼ˆå®Œæ•´æƒé™ï¼‰

- ä»ªè¡¨ç›˜ï¼ˆç®¡è¾–èŒƒå›´ï¼‰
- å¸æœºç®¡ç†ï¼ˆç®¡è¾–èŒƒå›´ï¼‰
- è½¦è¾†ç®¡ç†ï¼ˆç®¡è¾–èŒƒå›´ï¼‰
- è€ƒå‹¤ç®¡ç†ï¼ˆç®¡è¾–èŒƒå›´ï¼‰
- è¯·å‡å®¡æ‰¹ï¼ˆç®¡è¾–èŒƒå›´ï¼‰

### è½¦é˜Ÿé•¿ç•Œé¢ï¼ˆåªè¯»ï¼‰

- ä»ªè¡¨ç›˜ï¼ˆç®¡è¾–èŒƒå›´ï¼Œåªè¯»ï¼‰
- æ•°æ®æŸ¥çœ‹ï¼ˆç®¡è¾–èŒƒå›´ï¼Œåªè¯»ï¼‰

### å¸æœºç•Œé¢

- ä¸ªäººä¿¡æ¯
- æ‰“å¡ç­¾åˆ°
- è®¡ä»¶å·¥ä½œæäº¤
- è¯·å‡ç”³è¯·
- è€ƒå‹¤è®°å½•æŸ¥çœ‹
- å·¥èµ„è®°å½•æŸ¥çœ‹

---

## ğŸ” æƒé™æ£€æŸ¥å‡½æ•°

### æ£€æŸ¥æ˜¯å¦ä¸ºè¶…çº§ç®¡ç†å‘˜

```typescript
export async function isSuperAdmin(userId: string): Promise<boolean> {
  const { data } = await supabase
    .from('profiles')
    .select('role')
    .eq('id', userId)
    .single()
  
  return data?.role === 'super_admin'
}
```

### æ£€æŸ¥æ˜¯å¦ä¸ºè€æ¿

```typescript
export async function isBoss(userId: string): Promise<boolean> {
  const { data } = await supabase
    .from('profiles')
    .select('role')
    .eq('id', userId)
    .single()
  
  return data?.role === 'boss'
}
```

### æ£€æŸ¥æ˜¯å¦æ‹¥æœ‰å®Œæ•´æƒé™

```typescript
export async function hasFullPermission(userId: string): Promise<boolean> {
  const { data } = await supabase
    .from('profiles')
    .select('role, permission_level')
    .eq('id', userId)
    .single()
  
  if (!data) return false
  
  // è€æ¿å§‹ç»ˆæ‹¥æœ‰å®Œæ•´æƒé™
  if (data.role === 'boss') return true
  
  // å¹³çº§è´¦å·å’Œè½¦é˜Ÿé•¿éœ€è¦æ£€æŸ¥æƒé™çº§åˆ«
  if (data.role === 'peer' || data.role === 'manager') {
    return data.permission_level === 'full_permission'
  }
  
  return false
}
```

### æ£€æŸ¥ç®¡è¾–èŒƒå›´

```typescript
export async function canManageWarehouse(
  userId: string,
  warehouseId: string
): Promise<boolean> {
  const { data } = await supabase
    .from('profiles')
    .select('role, permission_level, managed_warehouses')
    .eq('id', userId)
    .single()
  
  if (!data) return false
  
  // è€æ¿å’Œæ‹¥æœ‰å®Œæ•´æƒé™çš„å¹³çº§è´¦å·å¯ä»¥ç®¡ç†æ‰€æœ‰ä»“åº“
  if (data.role === 'boss') return true
  if (data.role === 'peer' && data.permission_level === 'full_permission') return true
  
  // è½¦é˜Ÿé•¿åªèƒ½ç®¡ç†åˆ†é…ç»™è‡ªå·±çš„ä»“åº“
  if (data.role === 'manager' && data.permission_level === 'full_permission') {
    return data.managed_warehouses?.includes(warehouseId) ?? false
  }
  
  return false
}
```

---

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šè€æ¿åˆ›å»ºå¹³çº§è´¦å·

```typescript
import { createPeerAccount } from '@/db/accountApi'

// è€æ¿ç™»å½•å
const peer = await createPeerAccount({
  boss_id: currentUser.id,
  real_name: 'æå››',
  phone: '13800000002',
  email: 'lisi@example.com',
  password: 'password123',
  permission_level: 'full_permission'
})

console.log('å¹³çº§è´¦å·åˆ›å»ºæˆåŠŸ:', peer)
```

### ç¤ºä¾‹ 2ï¼šè½¦é˜Ÿé•¿æŸ¥çœ‹ç®¡è¾–èŒƒå›´å†…çš„å¸æœº

```typescript
import { getDriversByManager } from '@/db/driverApi'

// è½¦é˜Ÿé•¿ç™»å½•å
const drivers = await getDriversByManager(currentUser.id)

console.log('ç®¡è¾–èŒƒå›´å†…çš„å¸æœº:', drivers)
```

### ç¤ºä¾‹ 3ï¼šæ£€æŸ¥ç”¨æˆ·æƒé™

```typescript
import { hasFullPermission, canManageWarehouse } from '@/db/permissionApi'

// æ£€æŸ¥æ˜¯å¦æ‹¥æœ‰å®Œæ•´æƒé™
const hasFull = await hasFullPermission(currentUser.id)

if (hasFull) {
  console.log('ç”¨æˆ·æ‹¥æœ‰å®Œæ•´æƒé™')
} else {
  console.log('ç”¨æˆ·åªæœ‰åªè¯»æƒé™')
}

// æ£€æŸ¥æ˜¯å¦å¯ä»¥ç®¡ç†æŒ‡å®šä»“åº“
const canManage = await canManageWarehouse(currentUser.id, warehouseId)

if (canManage) {
  console.log('å¯ä»¥ç®¡ç†è¯¥ä»“åº“')
} else {
  console.log('æ— æƒç®¡ç†è¯¥ä»“åº“')
}
```

---

## ğŸ¯ æ€»ç»“

### æƒé™å±‚çº§

```
è¶…çº§ç®¡ç†å‘˜ï¼ˆä¸­å¤®ç®¡ç†ç³»ç»Ÿï¼‰
  â””â”€â”€ ç®¡ç†æ‰€æœ‰ç§Ÿæˆ·
  
è€æ¿ï¼ˆç§Ÿæˆ·ç³»ç»Ÿæœ€é«˜æƒé™ï¼‰
  â”œâ”€â”€ å¹³çº§è´¦å·ï¼ˆæœ€å¤š3ä¸ªï¼‰
  â”‚   â”œâ”€â”€ å®Œæ•´æƒé™ï¼šä¸è€æ¿ç›¸åŒ
  â”‚   â””â”€â”€ åªè¯»æƒé™ï¼šåªèƒ½æŸ¥çœ‹
  â”œâ”€â”€ è½¦é˜Ÿé•¿
  â”‚   â”œâ”€â”€ å®Œæ•´æƒé™ï¼šç®¡è¾–èŒƒå›´å†…æœ€é«˜æƒé™
  â”‚   â””â”€â”€ åªè¯»æƒé™ï¼šç®¡è¾–èŒƒå›´å†…åªèƒ½æŸ¥çœ‹
  â””â”€â”€ å¸æœº
      â””â”€â”€ åªèƒ½æ“ä½œè‡ªå·±çš„æ•°æ®
```

### å…³é”®ç‚¹

1. **è¶…çº§ç®¡ç†å‘˜**ï¼šåªç®¡ç†ç§Ÿæˆ·é…ç½®ï¼Œä¸ç›´æ¥æ“ä½œä¸šåŠ¡æ•°æ®
2. **è€æ¿**ï¼šç§Ÿæˆ·å†…çš„æœ€é«˜æƒé™æ‰€æœ‰è€…
3. **å¹³çº§è´¦å·**ï¼šååŠ©è€æ¿ç®¡ç†ï¼Œæƒé™ç”±è€æ¿æˆäºˆ
4. **è½¦é˜Ÿé•¿**ï¼šç®¡ç†æŒ‡å®šèŒƒå›´ï¼Œæƒé™ç”±è€æ¿æˆ–å¹³çº§è´¦å·ï¼ˆå®Œæ•´æƒé™ï¼‰æˆäºˆ
5. **å¸æœº**ï¼šåŸºå±‚æ“ä½œäººå‘˜ï¼Œåªèƒ½æ“ä½œè‡ªå·±çš„æ•°æ®

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**æ›´æ–°æ—¥æœŸ**ï¼š2025-11-05  
**ç»´æŠ¤è€…**ï¼šå¼€å‘å›¢é˜Ÿ
