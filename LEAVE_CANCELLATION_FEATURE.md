# 请假申请撤销功能完整说明

## 📋 功能概述

本文档详细说明了"撤销请假申请"功能的设计规则、业务流程、技术实现和用户交互细节。该功能旨在为司机提供灵活的请假管理能力，同时保持审批流程的严肃性和可追溯性。

---

## ✅ 核心原则

### 1. 时效性原则
- **允许撤销时间**：假期结束日期之前的任何时间（包括假期当天）
- **判断标准**：系统记录的请假结束日期尚未过去
- **示例**：
  - 请假时间：2025-11-10 至 2025-11-15
  - 可撤销时间：2025-11-15 23:59:59 之前
  - 不可撤销时间：2025-11-16 00:00:00 之后

### 2. 状态判断原则
- **可撤销状态**：
  - `pending`（待审批）
  - `approved`（已批准）
- **不可撤销状态**：
  - `rejected`（已驳回）
  - `cancelled`（已撤销）
  - 假期已完全过去

### 3. 用户体验原则
- **二次确认**：所有撤销操作必须经过用户确认
- **强化提示**：已批准的请假撤销时需要特别提示
- **信息完整**：确认对话框显示详细的请假信息
- **状态透明**：撤销后状态清晰可见，保留操作记录

---

## 🔧 具体规则与条件

### 撤销规则矩阵

| 请假状态 | 假期时间 | 可否撤销 | 说明 |
|---------|---------|---------|------|
| `pending` | 未开始 | ✅ 可以 | 待审批状态，随时可撤销 |
| `pending` | 进行中 | ✅ 可以 | 待审批状态，随时可撤销 |
| `pending` | 已结束 | ❌ 不可以 | 假期已完全过去 |
| `approved` | 未开始 | ✅ 可以 | 已批准但未开始，可撤销 |
| `approved` | 进行中 | ✅ 可以 | 假期进行中，可撤销 |
| `approved` | 当天最后一天 | ✅ 可以 | 假期结束日期当天，可撤销 |
| `approved` | 已结束 | ❌ 不可以 | 假期已完全过去 |
| `rejected` | 任何时间 | ❌ 不可以 | 已驳回，无需撤销 |
| `cancelled` | 任何时间 | ❌ 不可以 | 已撤销，不能重复撤销 |

### 时间判断逻辑

```typescript
// 检查假期是否已完全过去
const today = new Date()
today.setHours(0, 0, 0, 0)  // 今天 00:00:00

const endDate = new Date(leave.end_date)
endDate.setHours(23, 59, 59, 999)  // 假期结束日期 23:59:59

// 如果今天 <= 假期结束日期，可以撤销
return today <= endDate
```

**示例说明**：
- 假期结束日期：2025-11-15
- 2025-11-15 当天任何时间：可以撤销（today = 2025-11-15 00:00:00 <= endDate = 2025-11-15 23:59:59）
- 2025-11-16 凌晨：不可撤销（today = 2025-11-16 00:00:00 > endDate = 2025-11-15 23:59:59）

---

## 💬 业务流程与用户交互

### 流程1: 撤销待审批的请假

```
司机进入"请假管理"页面
  ↓
查看"请假申请"列表
  ↓
找到待审批状态的请假记录
  ↓
点击"撤销请假"按钮
  ↓
系统弹出确认对话框
  ┌─────────────────────────────────────┐
  │ 确认撤销                            │
  ├─────────────────────────────────────┤
  │ 您确定要撤销本次从 2025-11-10 到   │
  │ 2025-11-15 的共 6 天请假申请吗？   │
  │                                     │
  │ 撤销后，请假记录将更新为"已撤销"   │
  │ 状态。如需请假请重新提交。         │
  ├─────────────────────────────────────┤
  │ [取消]           [确认撤销]         │
  └─────────────────────────────────────┘
  ↓
用户点击"确认撤销"
  ↓
系统检查状态和时间
  ↓
更新状态为"已撤销"
  ↓
显示"撤销成功"提示
  ↓
刷新页面数据
  ↓
请假记录显示"已撤销"状态
```

### 流程2: 撤销已批准的请假（强化提示）

```
司机进入"请假管理"页面
  ↓
查看"请假申请"列表
  ↓
找到已批准状态的请假记录
  ↓
点击"撤销请假"按钮
  ↓
系统弹出强化确认对话框
  ┌─────────────────────────────────────┐
  │ ⚠️ 撤销已批准的请假                 │
  ├─────────────────────────────────────┤
  │ 您确定要撤销本次从 2025-11-10 到   │
  │ 2025-11-15 的共 6 天请假申请吗？   │
  │                                     │
  │ ⚠️ 此请假已经批准，撤销后您将恢复   │
  │ 正常工作状态，需要打卡。如需请假   │
  │ 请重新提交。                        │
  ├─────────────────────────────────────┤
  │ [取消]           [确认撤销]         │
  └─────────────────────────────────────┘
  ↓
用户点击"确认撤销"
  ↓
系统检查状态和时间
  ↓
更新状态为"已撤销"
  ↓
显示"撤销成功"提示
  ↓
刷新页面数据
  ↓
请假记录显示"已撤销"状态
  ↓
司机恢复正常工作状态，需要打卡
```

### 流程3: 尝试撤销已过期的请假

```
司机进入"请假管理"页面
  ↓
查看"请假申请"列表
  ↓
找到已批准但假期已过的请假记录
  ↓
系统不显示"撤销请假"按钮
  ↓
司机无法撤销该请假
```

---

## 🎨 用户界面设计

### 请假申请卡片（待审批状态）

```
┌─────────────────────────────────────┐
│ 📅 事假                    待审批   │
├─────────────────────────────────────┤
│ 请假时间：                          │
│ 2025-11-10 至 2025-11-15 （共6天） │
│                                     │
│ 请假事由：                          │
│ 家中有事需要处理                    │
│                                     │
│ 申请时间：2025-11-05                │
├─────────────────────────────────────┤
│ [🚫 撤销请假]                       │
└─────────────────────────────────────┘
```

### 请假申请卡片（已批准状态，假期未过）

```
┌─────────────────────────────────────┐
│ 📅 事假                    已通过   │
├─────────────────────────────────────┤
│ 请假时间：                          │
│ 2025-11-10 至 2025-11-15 （共6天） │
│                                     │
│ 请假事由：                          │
│ 家中有事需要处理                    │
│                                     │
│ 审批意见：                          │
│ 同意                                │
│                                     │
│ 申请时间：2025-11-05                │
├─────────────────────────────────────┤
│ [🚫 撤销请假]                       │
└─────────────────────────────────────┘
```

### 请假申请卡片（已批准状态，假期已过）

```
┌─────────────────────────────────────┐
│ 📅 事假                    已通过   │
├─────────────────────────────────────┤
│ 请假时间：                          │
│ 2025-10-10 至 2025-10-15 （共6天） │
│                                     │
│ 请假事由：                          │
│ 家中有事需要处理                    │
│                                     │
│ 审批意见：                          │
│ 同意                                │
│                                     │
│ 申请时间：2025-10-05                │
└─────────────────────────────────────┘
（无撤销按钮，假期已过）
```

### 请假申请卡片（已撤销状态）

```
┌─────────────────────────────────────┐
│ 📅 事假                    已撤销   │
├─────────────────────────────────────┤
│ 请假时间：                          │
│ 2025-11-10 至 2025-11-15 （共6天） │
│                                     │
│ 请假事由：                          │
│ 家中有事需要处理                    │
│                                     │
│ 审批意见：                          │
│ 司机主动撤销                        │
│                                     │
│ 申请时间：2025-11-05                │
└─────────────────────────────────────┘
（无撤销按钮，已撤销）
```

---

## 💻 技术实现

### 1. 数据库API函数 (`src/db/api.ts`)

```typescript
/**
 * 撤销请假申请
 * 
 * 撤销规则：
 * 1. 可撤销状态：待审批(pending)、已批准(approved)
 * 2. 不可撤销：已驳回(rejected)、已撤销(cancelled)、假期已完全过去
 * 3. 时效性：假期结束日期之前都可以撤销（包括假期当天）
 * 
 * @param leaveId 请假记录ID
 * @param userId 用户ID（用于权限验证）
 * @returns 是否成功
 */
export async function cancelLeaveApplication(
  leaveId: string, 
  userId: string
): Promise<boolean> {
  try {
    // 1. 检查请假记录是否属于该用户
    const {data: leave, error: fetchError} = await supabase
      .from('leave_applications')
      .select('*')
      .eq('id', leaveId)
      .eq('user_id', userId)
      .maybeSingle()

    if (fetchError || !leave) {
      console.error('[cancelLeaveApplication] 查询请假记录失败')
      return false
    }

    // 2. 检查状态是否允许撤销
    if (leave.status !== 'pending' && leave.status !== 'approved') {
      console.error('[cancelLeaveApplication] 只能撤销待审批或已批准的请假')
      return false
    }

    // 3. 检查假期是否已完全过去
    const today = new Date()
    today.setHours(0, 0, 0, 0)

    const endDate = new Date(leave.end_date)
    endDate.setHours(23, 59, 59, 999)

    if (today > endDate) {
      console.error('[cancelLeaveApplication] 假期已完全过去，不能撤销')
      return false
    }

    // 4. 更新状态为已撤销
    const {error: updateError} = await supabase
      .from('leave_applications')
      .update({
        status: 'cancelled',
        review_comment: '司机主动撤销'
      })
      .eq('id', leaveId)

    if (updateError) {
      console.error('[cancelLeaveApplication] 更新失败:', updateError)
      return false
    }

    return true
  } catch (error) {
    console.error('[cancelLeaveApplication] 未预期的错误:', error)
    return false
  }
}
```

### 2. 前端判断函数 (`src/pages/driver/leave/index.tsx`)

```typescript
/**
 * 判断是否可以撤销请假
 * 
 * 撤销规则：
 * 1. 可撤销状态：待审批(pending)、已批准(approved)
 * 2. 不可撤销：已驳回(rejected)、已撤销(cancelled)、假期已完全过去
 * 3. 时效性：假期结束日期之前都可以撤销（包括假期当天）
 */
const canCancelLeave = (leave: LeaveApplication): boolean => {
  // 只能撤销待审批或已批准的请假
  if (leave.status !== 'pending' && leave.status !== 'approved') {
    return false
  }

  // 检查假期是否已完全过去
  const today = new Date()
  today.setHours(0, 0, 0, 0)

  const endDate = new Date(leave.end_date)
  endDate.setHours(23, 59, 59, 999)

  // 假期结束日期之前都可以撤销（包括假期当天）
  return today <= endDate
}
```

### 3. 撤销处理函数

```typescript
/**
 * 撤销请假申请
 * 
 * 撤销规则：
 * 1. 可撤销状态：待审批(pending)、已批准(approved)
 * 2. 不可撤销：已驳回(rejected)、已撤销(cancelled)、假期已完全过去
 * 3. 时效性：假期结束日期之前都可以撤销（包括假期当天）
 * 4. 已批准的请假需要强化提示
 */
const handleCancelLeave = async (leaveId: string) => {
  if (!user) return

  // 查找请假记录
  const leave = leaveApplications.find((l) => l.id === leaveId)
  if (!leave) {
    showToast({title: '请假记录不存在', icon: 'none'})
    return
  }

  // 计算请假天数
  const days = calculateDays(leave.start_date, leave.end_date)

  // 根据状态显示不同的提示信息
  let title = '确认撤销'
  let content = ''

  if (leave.status === 'approved') {
    // 已批准的请假需要强化提示
    title = '⚠️ 撤销已批准的请假'
    content = `您确定要撤销本次从 ${formatDate(leave.start_date)} 到 ${formatDate(leave.end_date)} 的共 ${days} 天请假申请吗？\n\n⚠️ 此请假已经批准，撤销后您将恢复正常工作状态，需要打卡。如需请假请重新提交。`
  } else if (leave.status === 'pending') {
    // 待审批的请假
    content = `您确定要撤销本次从 ${formatDate(leave.start_date)} 到 ${formatDate(leave.end_date)} 的共 ${days} 天请假申请吗？\n\n撤销后，请假记录将更新为"已撤销"状态。如需请假请重新提交。`
  }

  const result = await showModal({
    title,
    content,
    confirmText: '确认撤销',
    cancelText: '取消'
  })

  if (result.confirm) {
    const success = await cancelLeaveApplication(leaveId, user.id)

    if (success) {
      showToast({title: '撤销成功', icon: 'success', duration: 2000})
      // 刷新数据
      loadData()
    } else {
      showToast({
        title: '撤销失败，假期已完全过去或状态不允许撤销',
        icon: 'none',
        duration: 2500
      })
    }
  }
}
```

### 4. UI渲染

```typescript
{/* 撤销按钮 - 待审批或已批准且假期未完全过去的请假可以撤销 */}
{canCancelLeave(app) && (
  <View className="mt-3 pt-3 border-t border-gray-200">
    <Button
      className="bg-orange-500 text-white rounded-lg py-2 active:bg-orange-600 transition-all text-sm"
      onClick={() => handleCancelLeave(app.id)}>
      <View className="flex items-center justify-center">
        <View className="i-mdi-cancel text-lg mr-1" />
        <Text className="text-white text-sm">撤销请假</Text>
      </View>
    </Button>
  </View>
)}
```

---

## 🔄 系统处理逻辑

### 1. 资源同步

撤销成功后，系统会自动处理以下资源同步：

#### 工作状态恢复
- 撤销请假后，司机的工作状态自动恢复为"在岗"
- 通过打卡检测机制，系统会在司机下次打开应用时检测打卡状态
- 如果未打卡，会弹出打卡提醒

#### 打卡检测流程
```
司机撤销请假
  ↓
请假状态更新为"已撤销"
  ↓
司机下次打开应用
  ↓
系统检测当日打卡状态
  ↓
检测到未打卡
  ↓
弹出打卡提醒
  ↓
司机完成打卡
  ↓
恢复正常工作状态
```

### 2. 通知机制

#### 管理端实时同步
- 使用 Supabase 数据库，数据实时共享
- 管理端页面使用 `useDidShow` Hook，在页面显示时自动刷新数据
- 当司机撤销请假时，管理端会在下次打开页面时看到最新状态

#### 同步流程
```
司机撤销请假
  ↓
Supabase 数据库更新
  ↓
管理员打开审批页面
  ↓
useDidShow 触发
  ↓
loadData() 从数据库获取最新数据
  ↓
显示最新状态（已撤销）
```

#### 管理端实现
```typescript
// 页面显示时刷新数据
useDidShow(() => {
  loadData()
})

// 下拉刷新
usePullDownRefresh(async () => {
  await Promise.all([loadData()])
  Taro.stopPullDownRefresh()
})
```

### 3. 操作日志

每次撤销操作都会记录在数据库中：

```sql
UPDATE leave_applications
SET 
  status = 'cancelled',
  review_comment = '司机主动撤销'
WHERE id = :leave_id
```

记录内容包括：
- 状态变更：`approved` → `cancelled` 或 `pending` → `cancelled`
- 操作原因：`司机主动撤销`
- 操作时间：数据库自动记录更新时间

---

## 🎯 特殊情况考量

### 1. 部分执行的请假

**场景**：申请了周一至周三的假期，用户在周二当天申请撤销

**处理规则**：
- ✅ **允许撤销**：因为假期结束日期（周三）尚未过去
- 📅 **考勤处理**：
  - 周一：已休假期，计入考勤记录
  - 周二：撤销当天，需要打卡
  - 周三：假期已撤销，需要打卡

**技术实现**：
```typescript
// 假期结束日期之前都可以撤销（包括假期当天）
const today = new Date()  // 周二
const endDate = new Date(leave.end_date)  // 周三

// today <= endDate，可以撤销
return today <= endDate
```

**用户提示**：
```
⚠️ 撤销已批准的请假

您确定要撤销本次从 2025-11-11（周一）到 
2025-11-13（周三）的共 3 天请假申请吗？

⚠️ 此请假已经批准，撤销后您将恢复正常工作
状态，需要打卡。如需请假请重新提交。

注意：周一的假期已经生效，撤销后从今天
（周二）开始需要打卡。
```

### 2. 假期最后一天撤销

**场景**：申请了周一至周五的假期，用户在周五当天申请撤销

**处理规则**：
- ✅ **允许撤销**：因为假期结束日期（周五）尚未过去
- 📅 **考勤处理**：
  - 周一至周四：已休假期，计入考勤记录
  - 周五：撤销当天，需要打卡

**技术实现**：
```typescript
// 周五当天
const today = new Date('2025-11-15')
today.setHours(0, 0, 0, 0)  // 2025-11-15 00:00:00

const endDate = new Date('2025-11-15')
endDate.setHours(23, 59, 59, 999)  // 2025-11-15 23:59:59

// today <= endDate，可以撤销
return today <= endDate  // true
```

### 3. 假期结束后第二天

**场景**：申请了周一至周五的假期，用户在周六尝试撤销

**处理规则**：
- ❌ **不允许撤销**：因为假期已完全过去
- 🚫 **UI表现**：不显示撤销按钮

**技术实现**：
```typescript
// 周六
const today = new Date('2025-11-16')
today.setHours(0, 0, 0, 0)  // 2025-11-16 00:00:00

const endDate = new Date('2025-11-15')
endDate.setHours(23, 59, 59, 999)  // 2025-11-15 23:59:59

// today > endDate，不可撤销
return today <= endDate  // false
```

### 4. 管理员主动撤销（未实现）

**场景**：管理员发现虚假请假，需要主动撤销已批准的申请

**设计建议**：
- 🔐 **权限控制**：只有管理员和超级管理员可以主动撤销
- 📝 **操作日志**：记录管理员ID、撤销原因、操作时间
- 🔔 **通知机制**：撤销后通知司机
- ⚠️ **警告提示**：管理员撤销时需要填写详细原因

**数据库设计**：
```sql
-- 添加撤销操作人字段
ALTER TABLE leave_applications
ADD COLUMN cancelled_by uuid REFERENCES profiles(id),
ADD COLUMN cancelled_at timestamptz;

-- 更新时记录操作人
UPDATE leave_applications
SET 
  status = 'cancelled',
  review_comment = '管理员撤销：虚假请假',
  cancelled_by = :admin_id,
  cancelled_at = NOW()
WHERE id = :leave_id;
```

---

## 📊 测试场景

### 测试场景1: 撤销待审批的请假

**前置条件**：
- 司机已提交一个请假申请
- 请假状态为"待审批"
- 假期尚未开始

**测试步骤**：
1. 司机进入"请假管理"页面
2. 找到待审批的请假记录
3. 验证显示"撤销请假"按钮
4. 点击"撤销请假"按钮
5. 验证弹出确认对话框，显示详细信息
6. 点击"确认撤销"
7. 验证显示"撤销成功"提示
8. 验证请假状态更新为"已撤销"
9. 验证"撤销请假"按钮消失

**预期结果**：
- ✅ 撤销成功
- ✅ 状态更新为"已撤销"
- ✅ 审批意见显示"司机主动撤销"

### 测试场景2: 撤销已批准的请假（假期未开始）

**前置条件**：
- 司机已提交一个请假申请
- 管理员已批准该申请
- 假期尚未开始

**测试步骤**：
1. 司机进入"请假管理"页面
2. 找到已批准的请假记录
3. 验证显示"撤销请假"按钮
4. 点击"撤销请假"按钮
5. 验证弹出强化确认对话框，标题包含"⚠️"
6. 验证对话框内容包含警告信息
7. 点击"确认撤销"
8. 验证显示"撤销成功"提示
9. 验证请假状态更新为"已撤销"

**预期结果**：
- ✅ 撤销成功
- ✅ 显示强化提示
- ✅ 状态更新为"已撤销"

### 测试场景3: 撤销已批准的请假（假期进行中）

**前置条件**：
- 司机已提交一个请假申请（2025-11-10 至 2025-11-15）
- 管理员已批准该申请
- 当前日期为 2025-11-12（假期进行中）

**测试步骤**：
1. 司机进入"请假管理"页面
2. 找到已批准的请假记录
3. 验证显示"撤销请假"按钮
4. 点击"撤销请假"按钮
5. 验证弹出强化确认对话框
6. 点击"确认撤销"
7. 验证显示"撤销成功"提示
8. 验证请假状态更新为"已撤销"
9. 司机下次打开应用时，验证弹出打卡提醒

**预期结果**：
- ✅ 撤销成功
- ✅ 状态更新为"已撤销"
- ✅ 恢复正常工作状态，需要打卡

### 测试场景4: 撤销已批准的请假（假期最后一天）

**前置条件**：
- 司机已提交一个请假申请（2025-11-10 至 2025-11-15）
- 管理员已批准该申请
- 当前日期为 2025-11-15（假期最后一天）

**测试步骤**：
1. 司机进入"请假管理"页面
2. 找到已批准的请假记录
3. 验证显示"撤销请假"按钮
4. 点击"撤销请假"按钮
5. 验证弹出强化确认对话框
6. 点击"确认撤销"
7. 验证显示"撤销成功"提示
8. 验证请假状态更新为"已撤销"

**预期结果**：
- ✅ 撤销成功（假期结束日期当天可以撤销）
- ✅ 状态更新为"已撤销"

### 测试场景5: 尝试撤销已过期的请假

**前置条件**：
- 司机已提交一个请假申请（2025-11-10 至 2025-11-15）
- 管理员已批准该申请
- 当前日期为 2025-11-16（假期已结束）

**测试步骤**：
1. 司机进入"请假管理"页面
2. 找到已批准的请假记录
3. 验证**不显示**"撤销请假"按钮

**预期结果**：
- ✅ 不显示撤销按钮
- ✅ 无法撤销该请假

### 测试场景6: 尝试撤销已驳回的请假

**前置条件**：
- 司机已提交一个请假申请
- 管理员已驳回该申请

**测试步骤**：
1. 司机进入"请假管理"页面
2. 找到已驳回的请假记录
3. 验证**不显示**"撤销请假"按钮

**预期结果**：
- ✅ 不显示撤销按钮
- ✅ 无法撤销该请假

### 测试场景7: 管理端同步更新

**前置条件**：
- 司机已提交一个请假申请
- 管理员已批准该申请

**测试步骤**：
1. 管理员打开"请假审批"页面
2. 验证显示该请假申请，状态为"已通过"
3. 司机撤销该请假申请
4. 管理员关闭"请假审批"页面
5. 管理员重新打开"请假审批"页面
6. 验证该请假申请状态更新为"已撤销"
7. 验证审批意见显示"司机主动撤销"

**预期结果**：
- ✅ 管理端自动同步最新状态
- ✅ 显示"已撤销"状态
- ✅ 显示撤销原因

### 测试场景8: 下拉刷新同步

**前置条件**：
- 司机已提交一个请假申请
- 管理员已批准该申请
- 管理员已打开"请假审批"页面

**测试步骤**：
1. 管理员在"请假审批"页面，验证显示该请假申请，状态为"已通过"
2. 司机撤销该请假申请
3. 管理员在"请假审批"页面下拉刷新
4. 验证该请假申请状态更新为"已撤销"

**预期结果**：
- ✅ 下拉刷新后显示最新状态
- ✅ 显示"已撤销"状态

---

## ✅ 完成状态

- ✅ 撤销规则已完善
- ✅ 可撤销待审批和已批准状态的请假
- ✅ 假期结束日期之前都可以撤销（包括假期当天）
- ✅ 已批准的请假撤销时强化提示
- ✅ 确认对话框显示详细信息（开始日期、结束日期、天数）
- ✅ 撤销后自动恢复工作状态
- ✅ 管理端自动同步最新状态
- ✅ 支持下拉刷新手动同步
- ✅ 代码质量检查通过

---

## 📅 创建时间

2025-11-05

---

## 👨‍💻 开发者备注

所有功能已完整实现并通过代码检查。系统现在支持：

1. **灵活的撤销规则**：待审批和已批准的请假都可以撤销，只要假期未完全过去
2. **清晰的用户提示**：根据请假状态显示不同的确认对话框，已批准的请假有强化提示
3. **完整的信息展示**：确认对话框显示详细的请假信息（开始日期、结束日期、天数）
4. **自动资源同步**：撤销后自动恢复工作状态，通过打卡检测机制提醒司机打卡
5. **实时信息同步**：管理端使用 useDidShow 自动刷新数据，支持下拉刷新

这些优化大大提升了系统的灵活性和用户体验，同时保持了审批流程的严肃性和可追溯性。
