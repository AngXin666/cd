# è¯·å‡ç®¡ç†å…¨åŠŸèƒ½å¤šç§Ÿæˆ·é€‚é…æ£€æŸ¥æŠ¥å‘Š

## ğŸ“‹ æ£€æŸ¥æ¦‚è¿°

å…¨é¢æ£€æŸ¥è¯·å‡ç®¡ç†ç³»ç»Ÿçš„æ‰€æœ‰åŠŸèƒ½æ˜¯å¦æ­£ç¡®é€‚é…å¤šç§Ÿæˆ·æ¶æ„ï¼ˆæ¯ä¸ªç§Ÿæˆ·ä½¿ç”¨ç‹¬ç«‹æ•°æ®åº“æ¨¡å¼ï¼‰ã€‚

## ğŸ” æ£€æŸ¥èŒƒå›´

### 1. è¯·å‡ç”³è¯·åŠŸèƒ½
- âŒ åˆ›å»ºè¯·å‡ç”³è¯·
- âœ… æŸ¥è¯¢è¯·å‡ç”³è¯·
- âœ… æ›´æ–°è¯·å‡ç”³è¯·
- âœ… åˆ é™¤è¯·å‡ç”³è¯·

### 2. è¯·å‡å®¡æ‰¹åŠŸèƒ½
- âœ… å®¡æ‰¹è¯·å‡ç”³è¯·
- âœ… æŸ¥è¯¢å¾…å®¡æ‰¹ç”³è¯·

### 3. è¯·å‡ç»Ÿè®¡åŠŸèƒ½
- âœ… æœˆåº¦è¯·å‡ç»Ÿè®¡
- âœ… å¾…å®¡æ‰¹è¯·å‡ç»Ÿè®¡
- âœ… ä»Šæ—¥è¯·å‡æŸ¥è¯¢

## ğŸ“Š è¯¦ç»†æ£€æŸ¥ç»“æœ

### âœ… å·²æ­£ç¡®é€‚é…çš„åŠŸèƒ½

#### 1. æŸ¥è¯¢è¯·å‡ç”³è¯· - âœ… ä¾èµ– RLS ç­–ç•¥
**å‡½æ•°**ï¼š
- `getLeaveApplicationsByUser(userId)` - è·å–ç”¨æˆ·çš„è¯·å‡ç”³è¯·
- `getLeaveApplicationsByWarehouse(warehouseId)` - è·å–ä»“åº“çš„è¯·å‡ç”³è¯·
- `getAllLeaveApplications()` - è·å–æ‰€æœ‰è¯·å‡ç”³è¯·
- `getDraftLeaveApplications(userId)` - è·å–è‰ç¨¿è¯·å‡ç”³è¯·

**RLS ç­–ç•¥**ï¼š
```sql
-- ç”¨æˆ·å¯ä»¥ç®¡ç†è‡ªå·±çš„è¯·å‡ç”³è¯·
CREATE POLICY "Users can manage own leave applications" ON leave_applications
  FOR ALL TO authenticated
  USING ((boss_id = get_current_user_boss_id()) AND (user_id = auth.uid()))
  WITH CHECK ((boss_id = get_current_user_boss_id()) AND (user_id = auth.uid()));

-- ç®¡ç†å‘˜å¯ä»¥ç®¡ç†ç§Ÿæˆ·çš„è¯·å‡ç”³è¯·
CREATE POLICY "Manager can manage tenant leave applications" ON leave_applications
  FOR ALL TO authenticated
  USING ((boss_id = get_current_user_boss_id()) AND (is_admin(auth.uid()) OR is_super_admin(auth.uid())))
  WITH CHECK ((boss_id = get_current_user_boss_id()) AND (is_admin(auth.uid()) OR is_super_admin(auth.uid())));

-- è€æ¿å¯ä»¥ç®¡ç†ç§Ÿæˆ·çš„è¯·å‡ç”³è¯·
CREATE POLICY "Super admin can manage tenant leave applications" ON leave_applications
  FOR ALL TO authenticated
  USING ((boss_id = get_current_user_boss_id()) AND is_super_admin(auth.uid()))
  WITH CHECK ((boss_id = get_current_user_boss_id()) AND is_super_admin(auth.uid()));
```

**æ•ˆæœ**ï¼š
- âœ… æ•°æ®åº“å±‚é¢è‡ªåŠ¨è¿‡æ»¤ `boss_id`
- âœ… ç”¨æˆ·åªèƒ½æŸ¥è¯¢è‡ªå·±ç§Ÿæˆ·çš„è¯·å‡ç”³è¯·
- âœ… å¸æœºåªèƒ½æŸ¥çœ‹è‡ªå·±çš„è¯·å‡ç”³è¯·
- âœ… ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹æ‰€æœ‰å¸æœºçš„è¯·å‡ç”³è¯·

#### 2. æ›´æ–°å’Œåˆ é™¤è¯·å‡ç”³è¯· - âœ… ä¾èµ– RLS ç­–ç•¥
**å‡½æ•°**ï¼š
- `updateDraftLeaveApplication(draftId, input)` - æ›´æ–°è¯·å‡ç”³è¯·
- `deleteDraftLeaveApplication(draftId)` - åˆ é™¤è¯·å‡ç”³è¯·

**RLS ç­–ç•¥**ï¼š
```sql
-- ç”¨æˆ·å¯ä»¥ç®¡ç†è‡ªå·±çš„è¯·å‡ç”³è¯·ï¼ˆåŒ…æ‹¬æ›´æ–°å’Œåˆ é™¤ï¼‰
CREATE POLICY "Users can manage own leave applications" ON leave_applications
  FOR ALL TO authenticated
  USING ((boss_id = get_current_user_boss_id()) AND (user_id = auth.uid()))
  WITH CHECK ((boss_id = get_current_user_boss_id()) AND (user_id = auth.uid()));
```

**æ•ˆæœ**ï¼š
- âœ… RLS ç­–ç•¥é˜»æ­¢è·¨ç§Ÿæˆ·æ“ä½œ
- âœ… åªèƒ½æ›´æ–°/åˆ é™¤è‡ªå·±ç§Ÿæˆ·çš„è¯·å‡ç”³è¯·

#### 3. å®¡æ‰¹è¯·å‡ç”³è¯· - âœ… ä¾èµ– RLS ç­–ç•¥
**å‡½æ•°**ï¼š
- `reviewLeaveApplication(applicationId, review)` - å®¡æ‰¹è¯·å‡ç”³è¯·

**RLS ç­–ç•¥**ï¼š
```sql
-- ç®¡ç†å‘˜å¯ä»¥ç®¡ç†ç§Ÿæˆ·çš„è¯·å‡ç”³è¯·ï¼ˆåŒ…æ‹¬å®¡æ‰¹ï¼‰
CREATE POLICY "Manager can manage tenant leave applications" ON leave_applications
  FOR ALL TO authenticated
  USING ((boss_id = get_current_user_boss_id()) AND (is_admin(auth.uid()) OR is_super_admin(auth.uid())))
  WITH CHECK ((boss_id = get_current_user_boss_id()) AND (is_admin(auth.uid()) OR is_super_admin(auth.uid())));
```

**æ•ˆæœ**ï¼š
- âœ… RLS ç­–ç•¥é˜»æ­¢è·¨ç§Ÿæˆ·å®¡æ‰¹
- âœ… åªèƒ½å®¡æ‰¹è‡ªå·±ç§Ÿæˆ·çš„è¯·å‡ç”³è¯·

#### 4. è¯·å‡ç»Ÿè®¡ - âœ… ä¾èµ– RLS ç­–ç•¥
**å‡½æ•°**ï¼š
- `getMonthlyLeaveCount(userId, year, month)` - è·å–æœˆåº¦è¯·å‡ç»Ÿè®¡
- `getMonthlyPendingLeaveCount(userId, year, month)` - è·å–æœˆåº¦å¾…å®¡æ‰¹è¯·å‡ç»Ÿè®¡
- `getApprovedLeaveForToday(userId)` - è·å–ä»Šæ—¥è¯·å‡

**æ•ˆæœ**ï¼š
- âœ… RLS ç­–ç•¥è‡ªåŠ¨è¿‡æ»¤ç§Ÿæˆ·æ•°æ®
- âœ… åªèƒ½æŸ¥è¯¢è‡ªå·±ç§Ÿæˆ·çš„ç»Ÿè®¡æ•°æ®

### âŒ éœ€è¦ä¿®å¤çš„åŠŸèƒ½

#### é—®é¢˜ 1ï¼šåˆ›å»ºè¯·å‡ç”³è¯·ç¼ºå°‘ boss_id

**å‡½æ•°**ï¼š`createLeaveApplication`  
**å½“å‰ä»£ç **ï¼š
```typescript
export async function createLeaveApplication(input: LeaveApplicationInput): Promise<LeaveApplication | null> {
  const {data, error} = await supabase
    .from('leave_applications')
    .insert({
      user_id: input.user_id,
      warehouse_id: input.warehouse_id,
      leave_type: input.leave_type,
      start_date: input.start_date,
      end_date: input.end_date,
      reason: input.reason,
      status: 'pending'
      // âŒ ç¼ºå°‘ boss_id å’Œ tenant_id
    })
    .select()
    .maybeSingle()

  if (error) {
    console.error('åˆ›å»ºè¯·å‡ç”³è¯·å¤±è´¥:', error)
    return null
  }

  return data
}
```

**é—®é¢˜**ï¼š
- âŒ æ’å…¥æ—¶æ²¡æœ‰æ·»åŠ  `boss_id` å­—æ®µ
- âŒ RLS ç­–ç•¥çš„ `WITH CHECK` æ¡ä»¶è¦æ±‚ `boss_id = get_current_user_boss_id()`
- âŒ ä¼šå¯¼è‡´åˆ›å»ºè¯·å‡ç”³è¯·å¤±è´¥

**RLS ç­–ç•¥**ï¼š
```sql
-- ç”¨æˆ·å¯ä»¥åˆ›å»ºè‡ªå·±çš„è¯·å‡ç”³è¯·
CREATE POLICY "Users can create own leave applications" ON leave_applications
  FOR INSERT TO authenticated
  WITH CHECK ((boss_id = get_current_user_boss_id()) AND (user_id = auth.uid()));

-- ç®¡ç†å‘˜å¯ä»¥åˆ›å»ºç§Ÿæˆ·çš„è¯·å‡ç”³è¯·
CREATE POLICY "Manager can manage tenant leave applications" ON leave_applications
  FOR ALL TO authenticated
  USING ((boss_id = get_current_user_boss_id()) AND (is_admin(auth.uid()) OR is_super_admin(auth.uid())))
  WITH CHECK ((boss_id = get_current_user_boss_id()) AND (is_admin(auth.uid()) OR is_super_admin(auth.uid())));
```

**å½±å“**ï¼š
- å¸æœºæ— æ³•åˆ›å»ºè¯·å‡ç”³è¯·
- ç®¡ç†å‘˜æ— æ³•ä¸ºå¸æœºåˆ›å»ºè¯·å‡ç”³è¯·
- è€æ¿æ— æ³•ä¸ºå¸æœºåˆ›å»ºè¯·å‡ç”³è¯·
- è¿™æ˜¯ä¸€ä¸ª**ä¸¥é‡çš„é—®é¢˜**ï¼Œä¼šå¯¼è‡´è¯·å‡ç®¡ç†åŠŸèƒ½å®Œå…¨æ— æ³•ä½¿ç”¨

**å…³è”å‡½æ•°**ï¼š
- `saveDraftLeaveApplication(input)` - å†…éƒ¨è°ƒç”¨ `createLeaveApplication`ï¼Œä¹Ÿä¼šå—å½±å“

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤ï¼šä¿®æ”¹ createLeaveApplication å‡½æ•°

**ä¿®æ”¹æ–‡ä»¶**ï¼š`src/db/api.ts`

**ä¿®å¤åçš„ä»£ç **ï¼š
```typescript
export async function createLeaveApplication(input: LeaveApplicationInput): Promise<LeaveApplication | null> {
  // 1. è·å–å½“å‰ç”¨æˆ·
  const {
    data: {user}
  } = await supabase.auth.getUser()

  if (!user) {
    console.error('åˆ›å»ºè¯·å‡ç”³è¯·å¤±è´¥: ç”¨æˆ·æœªç™»å½•')
    return null
  }

  // 2. è·å–å½“å‰ç”¨æˆ·çš„ boss_id
  const {data: profile} = await supabase
    .from('profiles')
    .select('boss_id')
    .eq('id', user.id)
    .maybeSingle()

  if (!profile?.boss_id) {
    console.error('åˆ›å»ºè¯·å‡ç”³è¯·å¤±è´¥: æ— æ³•è·å– boss_id')
    return null
  }

  // 3. æ’å…¥è¯·å‡ç”³è¯·ï¼ˆè‡ªåŠ¨æ·»åŠ  boss_id å’Œ tenant_idï¼‰
  const {data, error} = await supabase
    .from('leave_applications')
    .insert({
      user_id: input.user_id,
      warehouse_id: input.warehouse_id,
      leave_type: input.leave_type,
      start_date: input.start_date,
      end_date: input.end_date,
      reason: input.reason,
      status: 'pending',
      boss_id: profile.boss_id,
      tenant_id: profile.boss_id
    })
    .select()
    .maybeSingle()

  if (error) {
    console.error('åˆ›å»ºè¯·å‡ç”³è¯·å¤±è´¥:', error)
    return null
  }

  return data
}
```

## ğŸ“Š å¤šç§Ÿæˆ·æ¶æ„éªŒè¯

### æ•°æ®éš”ç¦»ä¿è¯

#### 1. è¯·å‡ç”³è¯·æ•°æ®éš”ç¦»
```typescript
// ç§Ÿæˆ· A çš„å¸æœºç™»å½•
const applications = await getLeaveApplicationsByUser(userId)
// âœ… åªè¿”å›ç§Ÿæˆ· A çš„è¯·å‡ç”³è¯·

// ç§Ÿæˆ· B çš„å¸æœºç™»å½•
const applications = await getLeaveApplicationsByUser(userId)
// âœ… åªè¿”å›ç§Ÿæˆ· B çš„è¯·å‡ç”³è¯·
```

#### 2. è¯·å‡å®¡æ‰¹æ•°æ®éš”ç¦»
```typescript
// ç§Ÿæˆ· A çš„ç®¡ç†å‘˜ç™»å½•
const success = await reviewLeaveApplication(applicationId, review)
// âœ… åªèƒ½å®¡æ‰¹ç§Ÿæˆ· A çš„è¯·å‡ç”³è¯·

// ç§Ÿæˆ· B çš„ç®¡ç†å‘˜ç™»å½•
const success = await reviewLeaveApplication(applicationId, review)
// âœ… åªèƒ½å®¡æ‰¹ç§Ÿæˆ· B çš„è¯·å‡ç”³è¯·
```

#### 3. è¯·å‡ç»Ÿè®¡æ•°æ®éš”ç¦»
```typescript
// ç§Ÿæˆ· A çš„è€æ¿ç™»å½•
const count = await getMonthlyLeaveCount(userId, year, month)
// âœ… åªè¿”å›ç§Ÿæˆ· A çš„ç»Ÿè®¡æ•°æ®

// ç§Ÿæˆ· B çš„è€æ¿ç™»å½•
const count = await getMonthlyLeaveCount(userId, year, month)
// âœ… åªè¿”å›ç§Ÿæˆ· B çš„ç»Ÿè®¡æ•°æ®
```

### RLS ç­–ç•¥å·¥ä½œåŸç†

```
ç”¨æˆ·è¯·æ±‚ â†’ Supabase Client â†’ Supabase Server
                                    â†“
                            åº”ç”¨ RLS ç­–ç•¥
                                    â†“
                            è¿‡æ»¤ boss_id
                                    â†“
                            è¿”å›ç§Ÿæˆ·æ•°æ®
```

**å…³é”®ç‚¹**ï¼š
1. RLS ç­–ç•¥åœ¨æ•°æ®åº“å±‚é¢æ‰§è¡Œï¼Œæ— æ³•ç»•è¿‡
2. å³ä½¿åº”ç”¨å±‚ä»£ç æœ‰æ¼æ´ï¼Œæ•°æ®åº“ä¹Ÿä¼šç¡®ä¿ç§Ÿæˆ·éš”ç¦»
3. æ‰€æœ‰æŸ¥è¯¢éƒ½ä¼šè‡ªåŠ¨æ·»åŠ  `WHERE boss_id = get_current_user_boss_id()` æ¡ä»¶
4. æ‰€æœ‰æ’å…¥éƒ½ä¼šæ£€æŸ¥ `boss_id = get_current_user_boss_id()` æ¡ä»¶

## ğŸ“ˆ æ£€æŸ¥æ€»ç»“

### å·²æ£€æŸ¥çš„è¡¨

| è¡¨å | boss_id å­—æ®µ | RLS ç­–ç•¥ | åˆ›å»ºå‡½æ•° | æŸ¥è¯¢å‡½æ•° | æ›´æ–°å‡½æ•° | åˆ é™¤å‡½æ•° |
|------|-------------|---------|---------|---------|---------|---------|
| leave_applications | âœ… | âœ… | âŒ éœ€ä¿®å¤ | âœ… | âœ… | âœ… |

### å·²æ£€æŸ¥çš„åŠŸèƒ½æ¨¡å—

| åŠŸèƒ½æ¨¡å— | çŠ¶æ€ | è¯´æ˜ |
|---------|------|------|
| è¯·å‡ç”³è¯· CRUD | âŒ | åˆ›å»ºå‡½æ•°éœ€è¦ä¿®å¤ï¼Œå…¶ä»–å·²æ­£ç¡®é€‚é… |
| è¯·å‡å®¡æ‰¹ | âœ… | ä¾èµ– RLS ç­–ç•¥ï¼Œè‡ªåŠ¨éš”ç¦» |
| è¯·å‡ç»Ÿè®¡ | âœ… | ä¾èµ– RLS ç­–ç•¥ï¼Œè‡ªåŠ¨éš”ç¦» |

### éœ€è¦ä¿®å¤çš„é—®é¢˜

1. **é«˜ä¼˜å…ˆçº§**ï¼š
   - âŒ `createLeaveApplication` å‡½æ•°ç¼ºå°‘ `boss_id` å’Œ `tenant_id`ï¼ˆ**ä¸¥é‡é—®é¢˜**ï¼‰

2. **ä½ä¼˜å…ˆçº§**ï¼š
   - æ— 

### ä¿®å¤åçš„æ•ˆæœ

- âœ… æ‰€æœ‰è¯·å‡ç®¡ç†åŠŸèƒ½éƒ½æ­£ç¡®é€‚é…å¤šç§Ÿæˆ·æ¶æ„
- âœ… æ¯ä¸ªç§Ÿæˆ·çš„æ•°æ®å®Œå…¨éš”ç¦»
- âœ… æ— æ³•è·¨ç§Ÿæˆ·è®¿é—®æˆ–æ“ä½œæ•°æ®
- âœ… å¸æœºå¯ä»¥æ­£å¸¸åˆ›å»ºè¯·å‡ç”³è¯·
- âœ… ç®¡ç†å‘˜å¯ä»¥æ­£å¸¸åˆ›å»ºè¯·å‡ç”³è¯·
- âœ… è€æ¿å¯ä»¥æ­£å¸¸å®¡æ‰¹è¯·å‡ç”³è¯·
- âœ… æ•°æ®åº“å±‚é¢å’Œåº”ç”¨å±‚é¢åŒé‡ä¿æŠ¤

## ğŸ§ª æµ‹è¯•å»ºè®®

### æµ‹è¯•åœºæ™¯ 1ï¼šåˆ›å»ºè¯·å‡ç”³è¯·
1. ä½¿ç”¨ç§Ÿæˆ· A çš„å¸æœºè´¦å·ç™»å½•
2. è¿›å…¥è¯·å‡ç®¡ç†é¡µé¢
3. åˆ›å»ºä¸€æ¡è¯·å‡ç”³è¯·
4. **é¢„æœŸç»“æœ**ï¼šâœ… åˆ›å»ºæˆåŠŸï¼Œä¸ä¼šå‡ºç°æƒé™é”™è¯¯

### æµ‹è¯•åœºæ™¯ 2ï¼šéªŒè¯è¯·å‡ç”³è¯·éš”ç¦»
1. ä½¿ç”¨ç§Ÿæˆ· A çš„å¸æœºè´¦å·ç™»å½•
2. åˆ›å»ºä¸€æ¡è¯·å‡ç”³è¯·
3. é€€å‡ºç™»å½•
4. ä½¿ç”¨ç§Ÿæˆ· B çš„è€æ¿è´¦å·ç™»å½•
5. æŸ¥è¯¢è¯·å‡ç”³è¯·åˆ—è¡¨
6. **é¢„æœŸç»“æœ**ï¼šâœ… çœ‹ä¸åˆ°ç§Ÿæˆ· A çš„è¯·å‡ç”³è¯·

### æµ‹è¯•åœºæ™¯ 3ï¼šå®¡æ‰¹è¯·å‡ç”³è¯·
1. ä½¿ç”¨ç§Ÿæˆ· A çš„ç®¡ç†å‘˜è´¦å·ç™»å½•
2. è¿›å…¥è¯·å‡å®¡æ‰¹é¡µé¢
3. å®¡æ‰¹æŸä¸ªå¸æœºçš„è¯·å‡ç”³è¯·
4. **é¢„æœŸç»“æœ**ï¼šâœ… å®¡æ‰¹æˆåŠŸï¼Œä¸ä¼šå‡ºç°æƒé™é”™è¯¯

### æµ‹è¯•åœºæ™¯ 4ï¼šéªŒè¯è¯·å‡å®¡æ‰¹éš”ç¦»
1. ä½¿ç”¨ç§Ÿæˆ· A çš„ç®¡ç†å‘˜è´¦å·ç™»å½•
2. è·å–ç§Ÿæˆ· B çš„æŸä¸ªè¯·å‡ç”³è¯· ID
3. å°è¯•å®¡æ‰¹è¯¥è¯·å‡ç”³è¯·
4. **é¢„æœŸç»“æœ**ï¼šâœ… å®¡æ‰¹å¤±è´¥ï¼ŒRLS ç­–ç•¥é˜»æ­¢æ“ä½œ

### æµ‹è¯•åœºæ™¯ 5ï¼šéªŒè¯è·¨ç§Ÿæˆ·æ“ä½œè¢«é˜»æ­¢
1. ä½¿ç”¨ç§Ÿæˆ· A çš„è€æ¿è´¦å·ç™»å½•
2. è·å–ç§Ÿæˆ· B çš„æŸä¸ªè¯·å‡ç”³è¯· ID
3. å°è¯•æ›´æ–°è¯¥è¯·å‡ç”³è¯·
4. **é¢„æœŸç»“æœ**ï¼šâœ… æ›´æ–°å¤±è´¥ï¼ŒRLS ç­–ç•¥é˜»æ­¢æ“ä½œ

## ğŸ“ æŠ€æœ¯ç»†èŠ‚

### æ•°æ®åº“è¡¨ç»“æ„

#### leave_applications è¡¨
```sql
CREATE TABLE leave_applications (
  id uuid PRIMARY KEY,
  user_id uuid NOT NULL REFERENCES profiles(id),
  warehouse_id uuid NOT NULL REFERENCES warehouses(id),
  leave_type leave_type_enum NOT NULL,
  start_date date NOT NULL,
  end_date date NOT NULL,
  days numeric NOT NULL,
  reason text NOT NULL,
  status application_status_enum NOT NULL,
  reviewed_by uuid REFERENCES profiles(id),
  reviewed_at timestamptz,
  review_notes text,
  boss_id text NOT NULL,      -- ç§Ÿæˆ· ID
  tenant_id uuid,              -- ç§Ÿæˆ· IDï¼ˆä¸ boss_id ç›¸åŒï¼‰
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);
```

### RLS ç­–ç•¥

#### leave_applications è¡¨ç­–ç•¥
```sql
-- ç”¨æˆ·å¯ä»¥åˆ›å»ºè‡ªå·±çš„è¯·å‡ç”³è¯·
CREATE POLICY "Users can create own leave applications" ON leave_applications
  FOR INSERT TO authenticated
  WITH CHECK ((boss_id = get_current_user_boss_id()) AND (user_id = auth.uid()));

-- ç”¨æˆ·å¯ä»¥ç®¡ç†è‡ªå·±çš„è¯·å‡ç”³è¯·
CREATE POLICY "Users can manage own leave applications" ON leave_applications
  FOR ALL TO authenticated
  USING ((boss_id = get_current_user_boss_id()) AND (user_id = auth.uid()))
  WITH CHECK ((boss_id = get_current_user_boss_id()) AND (user_id = auth.uid()));

-- ç®¡ç†å‘˜å¯ä»¥ç®¡ç†ç§Ÿæˆ·çš„è¯·å‡ç”³è¯·
CREATE POLICY "Manager can manage tenant leave applications" ON leave_applications
  FOR ALL TO authenticated
  USING ((boss_id = get_current_user_boss_id()) AND (is_admin(auth.uid()) OR is_super_admin(auth.uid())))
  WITH CHECK ((boss_id = get_current_user_boss_id()) AND (is_admin(auth.uid()) OR is_super_admin(auth.uid())));

-- è€æ¿å¯ä»¥ç®¡ç†ç§Ÿæˆ·çš„æ‰€æœ‰è¯·å‡ç”³è¯·
CREATE POLICY "Super admin can manage tenant leave applications" ON leave_applications
  FOR ALL TO authenticated
  USING ((boss_id = get_current_user_boss_id()) AND is_super_admin(auth.uid()))
  WITH CHECK ((boss_id = get_current_user_boss_id()) AND is_super_admin(auth.uid()));
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. boss_id çš„è·å–
- æ‰€æœ‰åˆ›å»ºå‡½æ•°éƒ½ä¼šè‡ªåŠ¨ä»å½“å‰ç™»å½•ç”¨æˆ·çš„ profile ä¸­è·å– `boss_id`
- å¦‚æœç”¨æˆ·æœªç™»å½•æˆ–æ— æ³•è·å– `boss_id`ï¼Œåˆ›å»ºä¼šå¤±è´¥

### 2. tenant_id çš„è®¾ç½®
- `tenant_id` å­—æ®µè®¾ç½®ä¸ºä¸ `boss_id` ç›¸åŒçš„å€¼
- è¿™æ˜¯å› ä¸ºåœ¨å½“å‰ç³»ç»Ÿä¸­ï¼Œç§Ÿæˆ· ID å°±æ˜¯è€æ¿çš„ ID

### 3. RLS ç­–ç•¥çš„ä½œç”¨
- RLS ç­–ç•¥åœ¨æ•°æ®åº“å±‚é¢æ‰§è¡Œï¼Œæ— æ³•ç»•è¿‡
- å³ä½¿åº”ç”¨å±‚ä»£ç æœ‰æ¼æ´ï¼Œæ•°æ®åº“ä¹Ÿä¼šç¡®ä¿ç§Ÿæˆ·éš”ç¦»
- æ‰€æœ‰æŸ¥è¯¢éƒ½ä¼šè‡ªåŠ¨æ·»åŠ  `WHERE boss_id = get_current_user_boss_id()` æ¡ä»¶

### 4. å¤–é”®å…³è”
- `leave_applications.user_id` å¼•ç”¨ `profiles.id`
- `leave_applications.warehouse_id` å¼•ç”¨ `warehouses.id`
- `leave_applications.reviewed_by` å¼•ç”¨ `profiles.id`
- ç”±äºæ‰€æœ‰è¡¨éƒ½æœ‰ `boss_id` è¿‡æ»¤ï¼Œè¯·å‡ç”³è¯·åªèƒ½å…³è”åˆ°åŒä¸€ç§Ÿæˆ·çš„ç”¨æˆ·å’Œä»“åº“
- è¿™ç¡®ä¿äº†æ•°æ®çš„ä¸€è‡´æ€§å’Œéš”ç¦»æ€§

### 5. è¯·å‡åŠŸèƒ½çš„ç‰¹æ®Šæ€§
- è¯·å‡åŠŸèƒ½æ˜¯å¸æœºçš„æ ¸å¿ƒåŠŸèƒ½
- å¿…é¡»ç¡®ä¿è¯·å‡åŠŸèƒ½æ­£å¸¸å·¥ä½œ
- è¯·å‡å¤±è´¥ä¼šä¸¥é‡å½±å“ç”¨æˆ·ä½“éªŒå’Œè€ƒå‹¤ç®¡ç†

### 6. è‰ç¨¿åŠŸèƒ½è¯´æ˜
- å½“å‰æ•°æ®åº“ä¸æ”¯æŒè‰ç¨¿çŠ¶æ€
- `saveDraftLeaveApplication` å‡½æ•°å†…éƒ¨è°ƒç”¨ `createLeaveApplication`
- ä¿®å¤ `createLeaveApplication` åï¼Œè‰ç¨¿åŠŸèƒ½ä¹Ÿä¼šè‡ªåŠ¨ä¿®å¤

## ğŸ“ˆ ä¿®å¤è¿›åº¦

- [x] æ£€æŸ¥è¯·å‡ç”³è¯· CRUD åŠŸèƒ½ - âœ… å·²å®Œæˆ
- [x] æ£€æŸ¥è¯·å‡å®¡æ‰¹åŠŸèƒ½ - âœ… å·²å®Œæˆ
- [x] æ£€æŸ¥è¯·å‡ç»Ÿè®¡åŠŸèƒ½ - âœ… å·²å®Œæˆ
- [ ] ä¿®å¤ createLeaveApplication å‡½æ•° - â³ å¾…ä¿®å¤
- [ ] æµ‹è¯•éªŒè¯ - â³ å¾…æµ‹è¯•

---

**æ£€æŸ¥æ—¥æœŸ**ï¼š2025-11-26  
**æ£€æŸ¥äººå‘˜**ï¼šç§’å“’ AI  
**çŠ¶æ€**ï¼šâœ… æ£€æŸ¥å®Œæˆï¼Œå‘ç° 1 ä¸ªéœ€è¦ä¿®å¤çš„é—®é¢˜

## ğŸ¯ æ€»ç»“

### æ ¸å¿ƒå‘ç°
1. âœ… è¯·å‡ç®¡ç†çš„å¤§éƒ¨åˆ†åŠŸèƒ½å·²æ­£ç¡®é€‚é…å¤šç§Ÿæˆ·æ¶æ„
2. âœ… RLS ç­–ç•¥å·²æ­£ç¡®å®ç°ï¼Œç¡®ä¿æ•°æ®åº“å±‚é¢çš„ç§Ÿæˆ·éš”ç¦»
3. âŒ åˆ›å»ºè¯·å‡ç”³è¯·å‡½æ•°éœ€è¦ä¿®å¤ï¼Œç¼ºå°‘ `boss_id` å’Œ `tenant_id`ï¼ˆ**ä¸¥é‡é—®é¢˜**ï¼‰

### æ¶æ„ä¿è¯
1. âœ… æ•°æ®åº“å±‚é¢ï¼šRLS ç­–ç•¥ç¡®ä¿ç§Ÿæˆ·éš”ç¦»
2. âœ… åº”ç”¨å±‚é¢ï¼šåˆ›å»ºå‡½æ•°è‡ªåŠ¨æ·»åŠ ç§Ÿæˆ·æ ‡è¯†å­—æ®µ
3. âœ… åŒé‡ä¿æŠ¤ï¼šå³ä½¿åº”ç”¨å±‚æœ‰æ¼æ´ï¼Œæ•°æ®åº“ä¹Ÿä¼šé˜»æ­¢è·¨ç§Ÿæˆ·è®¿é—®

### ä¿®å¤å»ºè®®
1. **ç«‹å³ä¿®å¤**ï¼š`createLeaveApplication` å‡½æ•°ï¼ˆ**é«˜ä¼˜å…ˆçº§ï¼Œä¸¥é‡é—®é¢˜**ï¼‰
2. **æµ‹è¯•éªŒè¯**ï¼šä¿®å¤åè¿›è¡Œå…¨é¢æµ‹è¯•
3. **æ–‡æ¡£æ›´æ–°**ï¼šæ›´æ–°ç›¸å…³æ–‡æ¡£

### ä¿®å¤åçš„æ•ˆæœ
- âœ… æ‰€æœ‰è¯·å‡ç®¡ç†åŠŸèƒ½éƒ½æ­£ç¡®é€‚é…å¤šç§Ÿæˆ·æ¶æ„
- âœ… æ¯ä¸ªç§Ÿæˆ·çš„æ•°æ®å®Œå…¨éš”ç¦»
- âœ… æ— æ³•è·¨ç§Ÿæˆ·è®¿é—®æˆ–æ“ä½œæ•°æ®
- âœ… å¸æœºå¯ä»¥æ­£å¸¸åˆ›å»ºè¯·å‡ç”³è¯·
- âœ… ç®¡ç†å‘˜å¯ä»¥æ­£å¸¸åˆ›å»ºè¯·å‡ç”³è¯·
- âœ… è€æ¿å¯ä»¥æ­£å¸¸å®¡æ‰¹è¯·å‡ç”³è¯·

### é—®é¢˜ä¸¥é‡æ€§åˆ†æ
- **ä¸¥é‡ç¨‹åº¦**ï¼šğŸ”´ é«˜
- **å½±å“èŒƒå›´**ï¼šè¯·å‡ç®¡ç†çš„æ ¸å¿ƒåŠŸèƒ½
- **å½±å“ç”¨æˆ·**ï¼šæ‰€æœ‰å¸æœºã€ç®¡ç†å‘˜å’Œè€æ¿
- **ä¿®å¤ä¼˜å…ˆçº§**ï¼šæœ€é«˜
- **ä¿®å¤éš¾åº¦**ï¼šä½ï¼ˆåªéœ€æ·»åŠ å‡ è¡Œä»£ç ï¼‰

### å…³è”å½±å“
- `saveDraftLeaveApplication` å‡½æ•°å†…éƒ¨è°ƒç”¨ `createLeaveApplication`
- ä¿®å¤ `createLeaveApplication` åï¼Œè‰ç¨¿åŠŸèƒ½ä¹Ÿä¼šè‡ªåŠ¨ä¿®å¤
- æ— éœ€å•ç‹¬ä¿®å¤è‰ç¨¿ç›¸å…³å‡½æ•°
