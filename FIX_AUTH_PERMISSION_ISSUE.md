# ä¿®å¤æƒé™é—®é¢˜å¯¼è‡´çš„ç”¨æˆ·åˆ›å»ºå¤±è´¥

## ğŸ“‹ é—®é¢˜æè¿°

æ–°æ·»åŠ çš„å¸æœºç”¨æˆ·åœ¨é‡ç½®å¯†ç æ—¶æ˜¾ç¤º"ç”¨æˆ·ä¸å­˜åœ¨ï¼Œæœªæ‰¾åˆ°æŒ‡å®šçš„ç”¨æˆ·ID"ã€‚

## ğŸ” é—®é¢˜æ ¹æœ¬åŸå› 

ç»è¿‡æ·±å…¥åˆ†æï¼Œå‘ç°é—®é¢˜çš„æ ¹æœ¬åŸå› æ˜¯**æƒé™é™åˆ¶**ï¼š

### é—®é¢˜é“¾è·¯

1. **ç®¡ç†å‘˜åˆ›å»ºå¸æœº**
   - ç®¡ç†å‘˜ï¼ˆrole = 'manager'ï¼‰åœ¨å¸æœºç®¡ç†é¡µé¢ç‚¹å‡»"æ·»åŠ å¸æœº"
   - å‰ç«¯è°ƒç”¨ `createDriver` å‡½æ•°

2. **createDriver å‡½æ•°æ‰§è¡Œ**
   - âœ… æ­¥éª¤1ï¼šåœ¨ `profiles` è¡¨ä¸­åˆ›å»ºè®°å½•ï¼ˆæˆåŠŸï¼‰
   - âŒ æ­¥éª¤2ï¼šè°ƒç”¨ `update_user_email` å‡½æ•°åˆ›å»º `auth.users` è®°å½•ï¼ˆå¤±è´¥ï¼‰

3. **update_user_email å‡½æ•°æƒé™æ£€æŸ¥**
   ```sql
   -- æ£€æŸ¥è°ƒç”¨è€…æ˜¯å¦ä¸ºè¶…çº§ç®¡ç†å‘˜
   IF NOT is_super_admin(auth.uid()) THEN
     RAISE EXCEPTION 'åªæœ‰è¶…çº§ç®¡ç†å‘˜å¯ä»¥ä¿®æ”¹ç”¨æˆ·é‚®ç®±';
   END IF;
   ```
   - âŒ ç®¡ç†å‘˜ä¸æ˜¯è¶…çº§ç®¡ç†å‘˜ï¼Œæƒé™æ£€æŸ¥å¤±è´¥
   - âŒ å‡½æ•°æŠ›å‡ºå¼‚å¸¸ï¼Œ`auth.users` è®°å½•æœªåˆ›å»º

4. **ç»“æœ**
   - âœ… `profiles` è¡¨æœ‰è®°å½•
   - âŒ `auth.users` è¡¨æ²¡æœ‰è®°å½•
   - âŒ ç”¨æˆ·æ— æ³•ç™»å½•
   - âŒ æ— æ³•é‡ç½®å¯†ç ï¼ˆå› ä¸º `reset_user_password_by_admin` æ£€æŸ¥ `auth.users` è¡¨ï¼‰

### ä¸ºä»€ä¹ˆä¹‹å‰æ²¡å‘ç°è¿™ä¸ªé—®é¢˜ï¼Ÿ

- å¦‚æœæ˜¯**è¶…çº§ç®¡ç†å‘˜**åˆ›å»ºå¸æœºï¼šâœ… æˆåŠŸï¼ˆå› ä¸ºæœ‰æƒé™è°ƒç”¨ `update_user_email`ï¼‰
- å¦‚æœæ˜¯**æ™®é€šç®¡ç†å‘˜**åˆ›å»ºå¸æœºï¼šâŒ å¤±è´¥ï¼ˆå› ä¸ºæ²¡æœ‰æƒé™è°ƒç”¨ `update_user_email`ï¼‰

## ğŸ› ï¸ è§£å†³æ–¹æ¡ˆ

åˆ›å»ºä¸€ä¸ªæ–°çš„æ•°æ®åº“å‡½æ•° `create_user_auth_account`ï¼Œä¸“é—¨ç”¨äºåˆ›å»ºç”¨æˆ·æ—¶è°ƒç”¨ï¼Œå…è®¸**ç®¡ç†å‘˜å’Œè¶…çº§ç®¡ç†å‘˜**éƒ½å¯ä»¥ä½¿ç”¨ã€‚

### æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ | æ˜¯å¦é‡‡ç”¨ |
|------|------|------|----------|
| ä¿®æ”¹ `update_user_email` å‡½æ•°æƒé™ | ç®€å• | ä¼šå½±å“ç°æœ‰çš„é‚®ç®±ä¿®æ”¹åŠŸèƒ½ï¼Œå¯èƒ½å¸¦æ¥å®‰å…¨é£é™© | âŒ |
| åˆ›å»ºæ–°å‡½æ•° `create_user_auth_account` | èŒè´£æ¸…æ™°ï¼Œä¸å½±å“ç°æœ‰åŠŸèƒ½ï¼Œå®‰å…¨å¯æ§ | éœ€è¦åˆ›å»ºæ–°å‡½æ•° | âœ… |
| åœ¨å‰ç«¯ç›´æ¥æ’å…¥ `auth.users` | ä¸éœ€è¦æ•°æ®åº“å‡½æ•° | å‰ç«¯æ— æ³•ç›´æ¥æ“ä½œ `auth.users` è¡¨ï¼Œéœ€è¦ SECURITY DEFINER æƒé™ | âŒ |

### å®æ–½æ–¹æ¡ˆ

#### 1. åˆ›å»ºæ–°çš„æ•°æ®åº“å‡½æ•°

**æ–‡ä»¶**ï¼š`supabase/migrations/40_create_user_auth_account.sql`

**å‡½æ•°ç­¾å**ï¼š
```sql
CREATE OR REPLACE FUNCTION create_user_auth_account(
  target_user_id uuid,
  user_email text,
  user_phone text DEFAULT NULL
)
RETURNS json
```

**æƒé™è¦æ±‚**ï¼š
- âœ… è¶…çº§ç®¡ç†å‘˜ï¼ˆrole = 'super_admin'ï¼‰
- âœ… æ™®é€šç®¡ç†å‘˜ï¼ˆrole = 'manager'ï¼‰
- âŒ å¸æœºï¼ˆrole = 'driver'ï¼‰

**åŠŸèƒ½**ï¼š
- ä¸ºæŒ‡å®šçš„ç”¨æˆ·IDåˆ›å»º `auth.users` è®°å½•
- è®¾ç½®é»˜è®¤å¯†ç  `123456`
- è‡ªåŠ¨ç¡®è®¤é‚®ç®±å’Œæ‰‹æœºå·
- è¿”å›è¯¦ç»†çš„åˆ›å»ºç»“æœ

**è¿”å›å€¼**ï¼š
```json
{
  "success": true,
  "message": "ç”¨æˆ·è®¤è¯è´¦å·åˆ›å»ºæˆåŠŸ",
  "user_id": "550e8400-e29b-41d4-a716-446655440000",
  "email": "13800138000@fleet.com",
  "default_password": "123456"
}
```

#### 2. ä¿®æ”¹ createDriver å‡½æ•°

**æ–‡ä»¶**ï¼š`src/db/api.ts`

**ä¿®æ”¹å†…å®¹**ï¼š
- å°† RPC è°ƒç”¨ä» `update_user_email` æ”¹ä¸º `create_user_auth_account`
- æ·»åŠ  `user_phone` å‚æ•°
- å¢å¼ºé”™è¯¯å¤„ç†ï¼Œæ£€æŸ¥è¿”å›å€¼çš„ `success` å­—æ®µ

**ä¿®æ”¹å‰**ï¼š
```typescript
const {data: rpcData, error: authError} = await supabase.rpc('update_user_email', {
  target_user_id: data.id,
  new_email: loginEmail
})
```

**ä¿®æ”¹å**ï¼š
```typescript
const {data: rpcData, error: authError} = await supabase.rpc('create_user_auth_account', {
  target_user_id: data.id,
  user_email: loginEmail,
  user_phone: phone
})

// æ£€æŸ¥è¿”å›å€¼
if (rpcData && rpcData.success === false) {
  console.error('  âŒ åˆ›å»º auth.users è®°å½•å¤±è´¥')
  console.error('  é”™è¯¯:', rpcData.error)
  console.error('  è¯¦æƒ…:', rpcData.details)
}
```

## ğŸ“Š ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰

| æ“ä½œè€… | profiles è¡¨ | auth.users è¡¨ | èƒ½å¦ç™»å½• | èƒ½å¦é‡ç½®å¯†ç  |
|--------|-------------|---------------|----------|--------------|
| è¶…çº§ç®¡ç†å‘˜åˆ›å»ºå¸æœº | âœ… | âœ… | âœ… | âœ… |
| æ™®é€šç®¡ç†å‘˜åˆ›å»ºå¸æœº | âœ… | âŒ | âŒ | âŒ |

### ä¿®å¤å

| æ“ä½œè€… | profiles è¡¨ | auth.users è¡¨ | èƒ½å¦ç™»å½• | èƒ½å¦é‡ç½®å¯†ç  |
|--------|-------------|---------------|----------|--------------|
| è¶…çº§ç®¡ç†å‘˜åˆ›å»ºå¸æœº | âœ… | âœ… | âœ… | âœ… |
| æ™®é€šç®¡ç†å‘˜åˆ›å»ºå¸æœº | âœ… | âœ… | âœ… | âœ… |

## ğŸ” éªŒè¯æ–¹æ³•

### æ–¹æ³•1ï¼šä½¿ç”¨æ™®é€šç®¡ç†å‘˜è´¦å·åˆ›å»ºå¸æœº

1. ä½¿ç”¨æ™®é€šç®¡ç†å‘˜è´¦å·ç™»å½•ï¼ˆrole = 'manager'ï¼‰
2. è¿›å…¥"å¸æœºç®¡ç†"é¡µé¢
3. ç‚¹å‡»"æ·»åŠ å¸æœº"
4. è¾“å…¥æ‰‹æœºå·å’Œå§“å
5. ç‚¹å‡»"ç¡®è®¤æ·»åŠ "
6. æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°æ—¥å¿—ï¼š
   ```
   âœ… auth.users è®°å½•åˆ›å»ºæˆåŠŸ
   - ç”¨æˆ·ID: xxx
   - é‚®ç®±: xxx@fleet.com
   - é»˜è®¤å¯†ç : 123456
   ```

### æ–¹æ³•2ï¼šæ£€æŸ¥æ•°æ®åº“

```sql
-- æŸ¥è¯¢æœ€æ–°åˆ›å»ºçš„å¸æœº
SELECT 
  p.id,
  p.phone,
  p.name,
  p.role,
  p.created_at,
  a.email,
  a.created_at as auth_created_at,
  CASE 
    WHEN a.id IS NULL THEN 'âŒ auth.users ä¸å­˜åœ¨'
    ELSE 'âœ… auth.users å­˜åœ¨'
  END as auth_status
FROM profiles p
LEFT JOIN auth.users a ON p.id = a.id
WHERE p.role = 'driver'
ORDER BY p.created_at DESC
LIMIT 5;
```

### æ–¹æ³•3ï¼šæµ‹è¯•é‡ç½®å¯†ç 

1. ä½¿ç”¨è¶…çº§ç®¡ç†å‘˜è´¦å·ç™»å½•
2. è¿›å…¥"ç”¨æˆ·ç®¡ç†"é¡µé¢
3. æ‰¾åˆ°åˆšåˆ›å»ºçš„å¸æœº
4. ç‚¹å‡»"é‡ç½®å¯†ç "
5. åº”è¯¥æ˜¾ç¤º"å¯†ç å·²é‡ç½®ä¸º 123456"ï¼ˆè€Œä¸æ˜¯"ç”¨æˆ·ä¸å­˜åœ¨"ï¼‰

### æ–¹æ³•4ï¼šæµ‹è¯•ç™»å½•

1. é€€å‡ºå½“å‰è´¦å·
2. ä½¿ç”¨æ–°åˆ›å»ºçš„å¸æœºè´¦å·ç™»å½•
3. è´¦å·ï¼šæ‰‹æœºå· æˆ– æ‰‹æœºå·@fleet.com
4. å¯†ç ï¼š123456
5. åº”è¯¥èƒ½å¤ŸæˆåŠŸç™»å½•

## ğŸ“ è°ƒè¯•æ—¥å¿—ç¤ºä¾‹

### æˆåŠŸåˆ›å»ºçš„æ—¥å¿—

```
================================================================================
ğŸš€ [createDriver] å‡½æ•°è°ƒç”¨å¼€å§‹
â° æ—¶é—´æˆ³: 2025-01-10T15:30:45.123Z
ğŸ“± è¾“å…¥å‚æ•°:
  - æ‰‹æœºå·: 13800138000
  - å§“å: å¼ ä¸‰
================================================================================

ğŸ“‹ [æ­¥éª¤1] æ£€æŸ¥æ‰‹æœºå·æ˜¯å¦å·²å­˜åœ¨
  - æŸ¥è¯¢æ¡ä»¶: phone = 13800138000
  âœ… æ‰‹æœºå·å¯ç”¨ï¼Œç»§ç»­åˆ›å»º

ğŸ“‹ [æ­¥éª¤2] åˆ›å»º profiles è¡¨è®°å½•
  - æ’å…¥æ•°æ®: {
      "phone": "13800138000",
      "name": "å¼ ä¸‰",
      "role": "driver",
      "login_account": "13800138000@fleet.com",
      "email": "13800138000@fleet.com"
    }
  âœ… profiles è¡¨è®°å½•åˆ›å»ºæˆåŠŸ
  - ç”¨æˆ·ID: 550e8400-e29b-41d4-a716-446655440000
  - æ‰‹æœºå·: 13800138000
  - å§“å: å¼ ä¸‰
  - è§’è‰²: driver
  - ç™»å½•è´¦å·: 13800138000@fleet.com
  - é‚®ç®±: 13800138000@fleet.com

ğŸ“‹ [æ­¥éª¤3] åˆ›å»º auth.users è¡¨è®°å½•
  - ç›®æ ‡ç”¨æˆ·ID: 550e8400-e29b-41d4-a716-446655440000
  - ç™»å½•é‚®ç®±: 13800138000@fleet.com
  - æ‰‹æœºå·: 13800138000
  - é»˜è®¤å¯†ç : 123456
  - ä½¿ç”¨å‡½æ•°: create_user_auth_account
  - RPC è°ƒç”¨å®Œæˆ
  - è¿”å›æ•°æ®: {
      "success": true,
      "message": "ç”¨æˆ·è®¤è¯è´¦å·åˆ›å»ºæˆåŠŸ",
      "user_id": "550e8400-e29b-41d4-a716-446655440000",
      "email": "13800138000@fleet.com",
      "default_password": "123456"
    }
  - é”™è¯¯ä¿¡æ¯: null
  âœ… auth.users è®°å½•åˆ›å»ºæˆåŠŸ
  - ç”¨æˆ·ID: 550e8400-e29b-41d4-a716-446655440000
  - é‚®ç®±: 13800138000@fleet.com
  - é»˜è®¤å¯†ç : 123456
  ğŸ’¡ ç”¨æˆ·å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹å¼ç™»å½•:
    1. æ‰‹æœºå· + å¯†ç : 13800138000 / 123456
    2. é‚®ç®± + å¯†ç : 13800138000@fleet.com / 123456
    3. æ‰‹æœºå· + éªŒè¯ç 

================================================================================
âœ… [createDriver] å‡½æ•°æ‰§è¡Œå®Œæˆ
ğŸ“Š æœ€ç»ˆç»“æœ:
  - profiles è¡¨: âœ… åˆ›å»ºæˆåŠŸ
  - auth.users è¡¨: è¯·æŸ¥çœ‹ä¸Šæ–¹æ—¥å¿—
  - è¿”å›æ•°æ®: { ... }
================================================================================
```

### æƒé™ä¸è¶³çš„æ—¥å¿—ï¼ˆä¿®å¤å‰ï¼‰

```
ğŸ“‹ [æ­¥éª¤3] åˆ›å»º auth.users è¡¨è®°å½•
  - ç›®æ ‡ç”¨æˆ·ID: 550e8400-e29b-41d4-a716-446655440000
  - ç™»å½•é‚®ç®±: 13800138000@fleet.com
  - é»˜è®¤å¯†ç : 123456
  - ä½¿ç”¨å‡½æ•°: update_user_email
  âŒ åˆ›å»º auth.users è®°å½•å¤±è´¥
  é”™è¯¯ä»£ç : P0001
  é”™è¯¯æ¶ˆæ¯: åªæœ‰è¶…çº§ç®¡ç†å‘˜å¯ä»¥ä¿®æ”¹ç”¨æˆ·é‚®ç®±
  é”™è¯¯è¯¦æƒ…: { ... }
  âš ï¸ profiles è®°å½•å·²åˆ›å»ºï¼Œä½† auth.users è®°å½•åˆ›å»ºå¤±è´¥
  ğŸ’¡ ç”¨æˆ·å¯ä»¥é€šè¿‡æ‰‹æœºå·éªŒè¯ç ç™»å½•
  ğŸ’¡ æˆ–ç¨åé€šè¿‡ç¼–è¾‘ç”¨æˆ·ä¿¡æ¯åˆ›å»ºç™»å½•è´¦å·
```

## ğŸ”§ ä¿®å¤ç°æœ‰æ•°æ®

å¦‚æœå·²ç»æœ‰ä¸€äº›å¸æœºç”¨æˆ·ç¼ºå°‘ `auth.users` è®°å½•ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•ä¿®å¤ï¼š

### æ–¹æ³•1ï¼šé€šè¿‡ SQL æ‰¹é‡ä¿®å¤

```sql
-- æŸ¥æ‰¾ç¼ºå°‘ auth.users è®°å½•çš„å¸æœº
SELECT 
  p.id,
  p.phone,
  p.name,
  p.email,
  p.login_account
FROM profiles p
LEFT JOIN auth.users a ON p.id = a.id
WHERE p.role = 'driver'
AND a.id IS NULL
ORDER BY p.created_at DESC;

-- ä¸ºæ¯ä¸ªç¼ºå°‘ auth.users è®°å½•çš„å¸æœºåˆ›å»ºè®°å½•
-- æ³¨æ„ï¼šéœ€è¦ä»¥è¶…çº§ç®¡ç†å‘˜èº«ä»½æ‰§è¡Œ
DO $$
DECLARE
  missing_user RECORD;
  result json;
BEGIN
  FOR missing_user IN 
    SELECT p.id, p.phone, p.email, p.login_account
    FROM profiles p
    LEFT JOIN auth.users a ON p.id = a.id
    WHERE p.role = 'driver'
    AND a.id IS NULL
  LOOP
    -- ä½¿ç”¨æ–°çš„ create_user_auth_account å‡½æ•°
    SELECT create_user_auth_account(
      missing_user.id,
      COALESCE(missing_user.login_account, missing_user.email, missing_user.phone || '@fleet.com'),
      missing_user.phone
    ) INTO result;
    
    RAISE NOTICE 'ä¸ºç”¨æˆ· % åˆ›å»º auth.users è®°å½•: %', missing_user.id, result;
  END LOOP;
END $$;
```

### æ–¹æ³•2ï¼šé€šè¿‡å‰ç«¯é¡µé¢ä¿®å¤

1. ä½¿ç”¨è¶…çº§ç®¡ç†å‘˜è´¦å·ç™»å½•
2. è¿›å…¥"ç”¨æˆ·ç®¡ç†"é¡µé¢
3. æ‰¾åˆ°ç¼ºå°‘ `auth.users` è®°å½•çš„å¸æœº
4. ç‚¹å‡»"ç¼–è¾‘"
5. ä¿®æ”¹ä»»æ„å­—æ®µï¼ˆä¾‹å¦‚å§“åï¼‰
6. ç‚¹å‡»"ä¿å­˜"
7. ç³»ç»Ÿä¼šè‡ªåŠ¨è°ƒç”¨ `update_user_email` å‡½æ•°åˆ›å»º `auth.users` è®°å½•

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ä¿®å¤é‡ç½®å¯†ç "ç”¨æˆ·ä¸å­˜åœ¨"é—®é¢˜](./FIX_RESET_PASSWORD_ISSUE.md)
- [è°ƒè¯•æ—¥å¿—ä½¿ç”¨æŒ‡å—](./DEBUG_LOG_GUIDE.md)
- [æ•°æ®æ’å…¥è¯¦ç»†è¯´æ˜](./DATA_INSERTION_GUIDE.md)
- [ç”¨æˆ·åˆ›å»ºå’Œç™»å½•æµç¨‹ä¼˜åŒ–æ€»ç»“](./USER_CREATION_AND_LOGIN_OPTIMIZATION.md)

## ğŸ’¡ æ€»ç»“

### é—®é¢˜æœ¬è´¨

æƒé™è®¾è®¡ä¸åˆç†ï¼Œ`update_user_email` å‡½æ•°åªå…è®¸è¶…çº§ç®¡ç†å‘˜è°ƒç”¨ï¼Œä½†æ™®é€šç®¡ç†å‘˜ä¹Ÿéœ€è¦åˆ›å»ºå¸æœºã€‚

### è§£å†³æ–¹æ¡ˆ

åˆ›å»ºä¸“é—¨çš„ `create_user_auth_account` å‡½æ•°ï¼Œå…è®¸ç®¡ç†å‘˜å’Œè¶…çº§ç®¡ç†å‘˜éƒ½å¯ä»¥è°ƒç”¨ï¼ŒèŒè´£æ¸…æ™°ï¼Œå®‰å…¨å¯æ§ã€‚

### é¢„é˜²æªæ–½

1. **æƒé™è®¾è®¡**ï¼šåœ¨è®¾è®¡æ•°æ®åº“å‡½æ•°æ—¶ï¼Œè¦è€ƒè™‘æ‰€æœ‰å¯èƒ½çš„è°ƒç”¨åœºæ™¯
2. **æµ‹è¯•è¦†ç›–**ï¼šæµ‹è¯•æ—¶è¦ä½¿ç”¨ä¸åŒè§’è‰²çš„è´¦å·è¿›è¡Œæµ‹è¯•
3. **æ—¥å¿—è®°å½•**ï¼šè¯¦ç»†çš„æ—¥å¿—å¯ä»¥å¸®åŠ©å¿«é€Ÿå®šä½é—®é¢˜
4. **æ•°æ®éªŒè¯**ï¼šå®šæœŸæ£€æŸ¥æ•°æ®ä¸€è‡´æ€§

### ç»éªŒæ•™è®­

1. ä¸è¦å‡è®¾æ‰€æœ‰æ“ä½œéƒ½ç”±è¶…çº§ç®¡ç†å‘˜æ‰§è¡Œ
2. æƒé™æ£€æŸ¥è¦è€ƒè™‘å®é™…çš„ä¸šåŠ¡åœºæ™¯
3. åˆ›å»ºç”¨æˆ·å’Œä¿®æ”¹ç”¨æˆ·æ˜¯ä¸¤ä¸ªä¸åŒçš„æ“ä½œï¼Œåº”è¯¥ä½¿ç”¨ä¸åŒçš„å‡½æ•°
4. è¯¦ç»†çš„æ—¥å¿—è®°å½•éå¸¸é‡è¦ï¼Œå¯ä»¥å¿«é€Ÿå®šä½é—®é¢˜
