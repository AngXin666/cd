# 车队管家电脑端管理后台技术方案

## 📋 项目现状分析

### ✅ 已完成的基础架构

#### 1. 后端服务架构（已完成）
- **数据库**：Supabase PostgreSQL
- **API 服务**：Supabase RESTful API + Realtime
- **认证系统**：Supabase Auth（支持手机号+密码、验证码登录）
- **文件存储**：Supabase Storage（用于图片上传）
- **实时通信**：Supabase Realtime（用于通知推送）

#### 2. 数据库结构（已完成）
已建立完整的数据表结构，包括：
- `profiles` - 用户信息表（司机、管理员、超级管理员）
- `vehicles` - 车辆信息表
- `vehicle_records` - 车辆历史记录表
- `attendance_records` - 考勤打卡记录表
- `attendance_rules` - 考勤规则配置表
- `leave_applications` - 请假申请表
- `piece_work_records` - 计件记录表
- `piece_work_categories` - 计件品类表
- `warehouses` - 仓库信息表
- `warehouse_assignments` - 仓库分配表
- `notifications` - 通知消息表

#### 3. API 接口（已完成）
所有业务接口已在 `src/db/api.ts` 中实现，包括：
- 用户管理接口
- 车辆管理接口
- 考勤管理接口
- 请假管理接口
- 计件管理接口
- 仓库管理接口
- 通知管理接口

#### 4. 权限系统（已完成）
- 三级角色：`driver`（司机）、`manager`（管理员）、`super_admin`（超级管理员）
- Row Level Security (RLS) 策略已配置
- 基于角色的数据访问控制

#### 5. 小程序前端（已完成）
- 司机端功能完整
- 管理员端功能完整
- 超级管理员端功能完整
- 所有功能已与后端打通

### 🚧 待完成的工作

#### 电脑端管理后台前端界面
- ✅ 基础框架已创建（侧边栏、顶部栏、路由）
- 🚧 功能模块待实现（仪表盘、车辆管理、司机管理等）

---

## 🎯 技术方案

### 1. 技术栈选型

#### 前端技术栈（已确定）
```
- 框架：React 18 + TypeScript
- 构建工具：Taro（支持 H5 和小程序）
- 样式方案：Tailwind CSS
- 状态管理：React Hooks
- 路由：Taro Router
- 图标：Material Design Icons
```

#### 后端技术栈（已确定）
```
- 数据库：Supabase PostgreSQL
- API：Supabase RESTful API
- 认证：Supabase Auth
- 存储：Supabase Storage
- 实时通信：Supabase Realtime
```

### 2. 架构设计

#### 前后端分离架构
```
┌─────────────────────────────────────────────────────────┐
│                    电脑端管理后台                         │
│              (React + TypeScript + Tailwind)            │
│                                                          │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌────────┐ │
│  │ 仪表盘   │  │ 车辆管理 │  │ 司机管理 │  │ 系统   │ │
│  └──────────┘  └──────────┘  └──────────┘  └────────┘ │
└─────────────────────────────────────────────────────────┘
                         ↓ HTTPS
┌─────────────────────────────────────────────────────────┐
│                   Supabase 后端服务                      │
│                                                          │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌────────┐ │
│  │ Auth     │  │ Database │  │ Storage  │  │ Realtime│ │
│  └──────────┘  └──────────┘  └──────────┘  └────────┘ │
└─────────────────────────────────────────────────────────┘
```

#### API 交互规范
- 使用 Supabase JavaScript Client
- RESTful API 风格
- 统一的错误处理机制
- 统一的数据返回格式

---

## 📦 功能模块详细设计

### 模块 1：仪表盘

#### 功能需求
1. **今日数据统计**
   - 今日出勤人数 / 应出勤人数
   - 今日出勤率
   - 今日总件数
   - 今日完成件数

2. **本月数据统计**
   - 本月总出勤天数
   - 本月平均出勤率
   - 本月总件数
   - 本月完成件数

3. **车辆状态概览**
   - 在用车辆数量
   - 停用车辆数量
   - 待审核车辆数量

4. **司机状态概览**
   - 在职司机数量
   - 离职司机数量
   - 新入职司机数量（本月）

5. **待处理事项**
   - 待审批请假申请
   - 待审核车辆
   - 未分配仓库的司机

#### 数据来源
- 考勤数据：`attendance_records` 表
- 计件数据：`piece_work_records` 表
- 车辆数据：`vehicles` 表
- 司机数据：`profiles` 表
- 请假数据：`leave_applications` 表

#### 实现方式
```typescript
// 数据统计 API
const getDashboardStats = async () => {
  // 1. 获取今日考勤数据
  const todayAttendance = await getTodayAttendanceStats()
  
  // 2. 获取今日计件数据
  const todayPieceWork = await getTodayPieceWorkStats()
  
  // 3. 获取本月数据
  const monthlyStats = await getMonthlyStats()
  
  // 4. 获取车辆状态
  const vehicleStats = await getVehicleStats()
  
  // 5. 获取司机状态
  const driverStats = await getDriverStats()
  
  // 6. 获取待处理事项
  const pendingTasks = await getPendingTasks()
  
  return {
    todayAttendance,
    todayPieceWork,
    monthlyStats,
    vehicleStats,
    driverStats,
    pendingTasks
  }
}
```

---

### 模块 2：车辆管理

#### 功能需求
1. **车辆列表**
   - 显示所有车辆信息
   - 支持搜索（车牌号、司机姓名）
   - 支持筛选（状态：在用/停用、类型）
   - 支持排序（按添加时间、车牌号）

2. **车辆详情**
   - 基本信息：车牌号、车辆类型、品牌型号
   - 当前司机信息
   - 车辆照片
   - 历史记录（领用、归还、损坏）

3. **车辆操作**
   - 添加车辆
   - 编辑车辆信息
   - 启用/停用车辆
   - 删除车辆
   - 查看历史记录

4. **车辆状态监控**
   - 在用车辆列表
   - 停用车辆列表
   - 车辆使用情况统计

#### 数据来源
- 车辆信息：`vehicles` 表
- 历史记录：`vehicle_records` 表
- 司机信息：`profiles` 表

#### 界面设计
```
┌─────────────────────────────────────────────────────────┐
│ 车辆管理                                    [+ 添加车辆] │
├─────────────────────────────────────────────────────────┤
│ 搜索: [_______]  状态: [全部▼]  类型: [全部▼]  [搜索]  │
├─────────────────────────────────────────────────────────┤
│ 车牌号    │ 类型  │ 当前司机 │ 状态  │ 添加时间 │ 操作  │
├─────────────────────────────────────────────────────────┤
│ 京A12345  │ 货车  │ 张三     │ 在用  │ 2025-01  │ 详情  │
│ 京B67890  │ 面包车│ 李四     │ 在用  │ 2025-01  │ 详情  │
│ 京C11111  │ 货车  │ -        │ 停用  │ 2024-12  │ 详情  │
└─────────────────────────────────────────────────────────┘
```

---

### 模块 3：司机管理

#### 功能需求
1. **司机列表**
   - 显示所有司机信息
   - 支持搜索（姓名、手机号、登录账号）
   - 支持筛选（状态：在职/离职、类型：纯司机/带车司机）
   - 支持排序（按入职时间、姓名）

2. **司机详情**
   - 基本信息：姓名、手机号、登录账号
   - 司机类型：纯司机/带车司机
   - 车辆信息（如果是带车司机）
   - 仓库分配信息
   - 考勤统计
   - 计件统计
   - 请假记录

3. **司机操作**
   - 添加司机
   - 编辑司机信息
   - 修改司机状态（在职/离职）
   - 分配仓库
   - 查看考勤记录
   - 查看计件记录
   - 查看请假记录

4. **司机绩效查看**
   - 出勤率统计（本月、本年）
   - 计件完成情况
   - 请假次数统计
   - 迟到早退统计

#### 数据来源
- 司机信息：`profiles` 表
- 车辆信息：`vehicles` 表
- 仓库分配：`warehouse_assignments` 表
- 考勤记录：`attendance_records` 表
- 计件记录：`piece_work_records` 表
- 请假记录：`leave_applications` 表

#### 界面设计
```
┌─────────────────────────────────────────────────────────┐
│ 司机管理                                    [+ 添加司机] │
├─────────────────────────────────────────────────────────┤
│ 搜索: [_______]  状态: [全部▼]  类型: [全部▼]  [搜索]  │
├─────────────────────────────────────────────────────────┤
│ 姓名  │ 手机号    │ 类型    │ 仓库  │ 状态  │ 操作      │
├─────────────────────────────────────────────────────────┤
│ 张三  │ 138***01  │ 纯司机  │ 仓库A │ 在职  │ 详情/编辑 │
│ 李四  │ 139***02  │ 带车    │ 仓库B │ 在职  │ 详情/编辑 │
│ 王五  │ 137***03  │ 纯司机  │ -     │ 离职  │ 详情      │
└─────────────────────────────────────────────────────────┘
```

---

### 模块 4：考勤管理

#### 功能需求
1. **考勤记录查询**
   - 按日期查询
   - 按司机查询
   - 按仓库查询
   - 导出考勤报表

2. **考勤统计**
   - 每日出勤统计
   - 每月出勤统计
   - 出勤率排行
   - 迟到早退统计

3. **考勤规则配置**
   - 设置上班时间
   - 设置下班时间
   - 设置迟到判定时间
   - 设置早退判定时间

#### 数据来源
- 考勤记录：`attendance_records` 表
- 考勤规则：`attendance_rules` 表
- 司机信息：`profiles` 表

---

### 模块 5：请假审批

#### 功能需求
1. **请假申请列表**
   - 待审批申请
   - 已审批申请
   - 已拒绝申请
   - 支持搜索和筛选

2. **请假审批操作**
   - 查看请假详情
   - 批准请假
   - 拒绝请假
   - 添加审批备注

3. **请假统计**
   - 按司机统计请假次数
   - 按月份统计请假天数
   - 请假类型统计

#### 数据来源
- 请假申请：`leave_applications` 表
- 司机信息：`profiles` 表

---

### 模块 6：计件管理

#### 功能需求
1. **计件记录查询**
   - 按日期查询
   - 按司机查询
   - 按品类查询
   - 导出计件报表

2. **计件统计**
   - 每日计件统计
   - 每月计件统计
   - 司机计件排行
   - 品类完成情况

3. **品类管理**
   - 添加品类
   - 编辑品类
   - 启用/禁用品类
   - 设置品类目标

#### 数据来源
- 计件记录：`piece_work_records` 表
- 品类信息：`piece_work_categories` 表
- 司机信息：`profiles` 表

---

### 模块 7：仓库管理

#### 功能需求
1. **仓库列表**
   - 显示所有仓库
   - 仓库状态（启用/禁用）
   - 分配的司机数量

2. **仓库操作**
   - 添加仓库
   - 编辑仓库信息
   - 启用/禁用仓库
   - 删除仓库

3. **司机分配**
   - 查看仓库分配的司机
   - 添加司机到仓库
   - 移除司机从仓库
   - 批量分配司机

#### 数据来源
- 仓库信息：`warehouses` 表
- 仓库分配：`warehouse_assignments` 表
- 司机信息：`profiles` 表

---

### 模块 8：系统设置

#### 功能需求
1. **角色权限管理**
   - 查看所有用户
   - 修改用户角色
   - 重置用户密码
   - 禁用/启用用户

2. **基础参数配置**
   - 考勤规则配置
   - 计件目标配置
   - 系统通知配置

3. **操作日志审计**
   - 查看操作日志
   - 按用户筛选
   - 按操作类型筛选
   - 按时间筛选

#### 数据来源
- 用户信息：`profiles` 表
- 考勤规则：`attendance_rules` 表
- 通知记录：`notifications` 表

---

## 🔒 安全配置

### 1. 用户认证
- ✅ 已实现 Supabase Auth
- ✅ 支持手机号+密码登录
- ✅ 支持验证码登录
- ✅ JWT Token 认证

### 2. 权限校验
- ✅ 基于角色的访问控制（RBAC）
- ✅ Row Level Security (RLS) 策略
- ✅ API 级别的权限验证

### 3. 数据加密
- ✅ HTTPS 传输加密
- ✅ 密码 bcrypt 加密
- ✅ 敏感数据加密存储

### 4. API 防攻击
- ✅ Supabase 内置 Rate Limiting
- ✅ SQL 注入防护
- ✅ XSS 防护

---

## 🚀 实施计划

### 第一阶段：仪表盘开发（预计 2-3 小时）
1. 实现数据统计 API
2. 设计仪表盘界面
3. 实现数据可视化（图表）
4. 实现快速操作入口

### 第二阶段：车辆管理开发（预计 3-4 小时）
1. 实现车辆列表页面
2. 实现车辆详情页面
3. 实现车辆添加/编辑功能
4. 实现车辆状态管理
5. 实现车辆历史记录查看

### 第三阶段：司机管理开发（预计 3-4 小时）
1. 实现司机列表页面
2. 实现司机详情页面
3. 实现司机添加/编辑功能
4. 实现司机绩效查看
5. 实现仓库分配功能

### 第四阶段：其他功能模块开发（预计 4-5 小时）
1. 考勤管理
2. 请假审批
3. 计件管理
4. 仓库管理
5. 系统设置

### 第五阶段：测试和优化（预计 2-3 小时）
1. 功能测试
2. 性能优化
3. 用户体验优化
4. Bug 修复

---

## 📊 环境配置

### 开发环境
```env
TARO_APP_SUPABASE_URL=https://xxx.supabase.co
TARO_APP_SUPABASE_ANON_KEY=xxx
TARO_APP_NAME=车队管家
TARO_APP_APP_ID=app-7cdqf07mbu9t
```

### 生产环境
```env
TARO_APP_SUPABASE_URL=https://xxx.supabase.co
TARO_APP_SUPABASE_ANON_KEY=xxx
TARO_APP_NAME=车队管家
TARO_APP_APP_ID=app-7cdqf07mbu9t
```

---

## 💡 技术优势

### 1. 前后端完全打通
- 小程序和管理后台共用同一套后端服务
- 数据实时同步
- 统一的 API 接口

### 2. 开发效率高
- 使用 Taro 框架，一套代码支持 H5 和小程序
- TypeScript 提供类型安全
- Tailwind CSS 快速构建界面

### 3. 安全性高
- Supabase 提供企业级安全保障
- Row Level Security 确保数据安全
- JWT Token 认证

### 4. 可扩展性强
- 模块化设计
- 清晰的代码结构
- 易于维护和扩展

---

## 📞 下一步行动

### 请您确认：

1. **功能需求是否完整？**
   - 是否需要添加其他功能模块？
   - 是否需要调整现有功能？

2. **界面设计是否满意？**
   - 是否需要特定的设计风格？
   - 是否有参考的管理后台界面？

3. **开发优先级**
   - 哪些功能需要优先开发？
   - 是否有紧急的业务需求？

确认后，我将立即开始开发！

---

**创建时间**：2025-11-25  
**状态**：等待用户确认需求
