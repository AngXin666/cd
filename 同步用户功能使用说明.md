# 同步用户功能使用说明

## 功能概述

当数据库中已经存在一些用户（在 `auth.users` 表中），但这些用户没有对应的 `profiles` 记录时，可以使用"同步用户"功能自动为这些用户创建档案。

## 使用场景

### 1. 数据迁移
- 从其他系统导入用户时
- 批量创建 `auth.users` 后需要补充 `profiles`

### 2. 数据修复
- `profiles` 记录意外删除
- 数据不一致时的修复

### 3. 开发测试
- 快速为测试用户创建档案

## 使用步骤

### 步骤 1：进入用户管理页面
1. 登录系统（超级管理员或租户老板）
2. 进入"用户管理"页面
3. 确保在"司机管理"标签页

### 步骤 2：点击"同步用户"按钮
- 在页面顶部，"添加用户"按钮旁边有一个绿色的"同步用户"按钮
- 点击该按钮

### 步骤 3：确认操作
- 系统会弹出确认对话框
- 对话框内容：
  ```
  此操作将为数据库中已存在但未创建档案的用户自动创建档案。
  确定要继续吗？
  ```
- 点击"确定"继续，点击"取消"放弃操作

### 步骤 4：等待同步完成
- 系统显示"同步中..."加载提示
- 同步过程通常很快（取决于用户数量）

### 步骤 5：查看同步结果

#### 情况 1：成功同步用户
系统会显示同步结果对话框：
```
同步成功

成功同步 3 个用户：

张三（13800138000）
李四（13900139000）
王五（13700137000）
```

#### 情况 2：没有需要同步的用户
系统会显示提示：
```
没有需要同步的用户
```

#### 情况 3：同步失败
系统会显示错误信息：
```
同步失败：[具体错误原因]
```

### 步骤 6：查看同步后的用户
- 同步成功后，用户列表会自动刷新
- 新同步的用户会出现在列表中

## 同步规则

### 用户信息提取
系统会自动从 `auth.users` 表的 `raw_user_meta_data` 字段提取用户信息：

1. **姓名**（按优先级）：
   - `raw_user_meta_data.name`
   - `raw_user_meta_data.real_name`
   - 邮箱的用户名部分
   - 手机号
   - "未命名用户"（兜底）

2. **角色**：
   - `raw_user_meta_data.role`
   - 默认为 `driver`（司机）

3. **其他信息**：
   - 手机号：`auth.users.phone`
   - 邮箱：`auth.users.email`
   - 权限类型：默认为 `full`
   - 状态：默认为 `active`

### 同步范围

#### 中央管理员
- 同步到 `public.profiles` 表
- 只同步没有 `tenant_id` 的用户
- 跳过属于租户的用户

#### 租户用户
- 同步到租户 Schema（如 `tenant_test1.profiles`）
- 只同步属于该租户的用户（`raw_user_meta_data.tenant_id` 匹配）

### 同步条件
只同步满足以下条件的用户：
1. ✅ 在 `auth.users` 表中存在
2. ✅ `confirmed_at` 不为空（已确认的用户）
3. ✅ 在对应的 `profiles` 表中不存在

## 注意事项

### 1. 权限要求
- 只有超级管理员和租户老板可以使用此功能
- 普通管理员和司机无法访问

### 2. 数据安全
- 同步操作使用 `SECURITY DEFINER`，确保安全性
- Schema 名称经过验证，防止 SQL 注入
- 只处理已确认的用户

### 3. 错误处理
- 单个用户同步失败不会影响其他用户
- 系统会记录错误日志，方便排查问题
- 同步失败的用户可以稍后重试

### 4. 性能考虑
- 同步操作在数据库层面执行，性能较好
- 大量用户同步时可能需要几秒钟
- 建议在用户较少时进行同步

## 常见问题

### Q1：为什么点击"同步用户"后提示"没有需要同步的用户"？
**A**：这说明所有 `auth.users` 中的用户都已经有对应的 `profiles` 记录，不需要同步。

### Q2：同步后的用户角色是什么？
**A**：
- 如果 `raw_user_meta_data` 中有 `role` 字段，使用该角色
- 否则默认为 `driver`（司机）
- 同步后可以在用户管理页面修改角色

### Q3：同步后的用户姓名不正确怎么办？
**A**：
- 同步后可以在用户详情页面修改姓名
- 或者在同步前先更新 `auth.users` 表的 `raw_user_meta_data`

### Q4：可以重复执行同步操作吗？
**A**：
- 可以，系统会自动跳过已有 `profiles` 记录的用户
- 不会创建重复记录

### Q5：中央管理员和租户用户同步有什么区别？
**A**：
- **中央管理员**：同步到 `public.profiles`，只同步没有 `tenant_id` 的用户
- **租户用户**：同步到租户 Schema（如 `tenant_test1.profiles`），只同步属于该租户的用户

### Q6：同步失败了怎么办？
**A**：
1. 查看错误信息，了解失败原因
2. 检查数据库连接是否正常
3. 确认用户权限是否正确
4. 稍后重试同步操作
5. 如果问题持续，联系技术支持

## 技术细节

### 数据库函数

#### sync_auth_users_to_profiles()
- 用途：为中央管理员同步用户
- 参数：无
- 返回：
  ```json
  {
    "success": true,
    "synced_count": 3,
    "users": [
      {
        "id": "uuid",
        "name": "张三",
        "phone": "13800138000",
        "email": "13800138000@fleet.com",
        "role": "driver"
      }
    ]
  }
  ```

#### sync_auth_users_to_tenant_profiles(p_tenant_id)
- 用途：为租户同步用户
- 参数：
  - `p_tenant_id`：租户 ID
- 返回：
  ```json
  {
    "success": true,
    "synced_count": 2,
    "users": [...],
    "tenant_id": "test1",
    "schema_name": "tenant_test1"
  }
  ```

### API 函数

#### syncAuthUsersToProfiles()
- 文件：`src/db/api.ts`
- 功能：根据当前用户的 `tenant_id` 自动选择调用哪个数据库函数
- 返回：
  ```typescript
  {
    success: boolean
    syncedCount: number
    users: Array<{
      id: string
      name: string
      phone: string
      email: string
      role: string
    }>
    error?: string
  }
  ```

## 更新日志

### 2025-11-05 v1.2
- 🐛 修复：使用租户表的 schema_name 而不是构造名称
- ✅ 从 tenants 表查询实际的 schema_name
- ✅ 增加租户存在性检查
- ✅ 区分"租户不存在"和"Schema 不存在"错误

### 2025-11-05 v1.1
- 🐛 修复：schema_name 列名歧义问题
- ✅ 使用 v_ 前缀避免变量名冲突
- ✅ 添加表别名明确列来源

### 2025-11-05 v1.0
- ✨ 初始版本发布
- ✅ 支持中央管理员同步用户
- ✅ 支持租户用户同步用户
- ✅ 添加前端界面和按钮
- ✅ 完善错误处理和用户提示

## 技术说明

### Schema 名称管理
系统使用 `tenants` 表集中管理租户的 Schema 名称：

```sql
-- tenants 表结构
CREATE TABLE tenants (
  id uuid PRIMARY KEY,              -- 租户 ID（UUID）
  company_name text,                -- 公司名称
  tenant_code text,                 -- 租户代码
  schema_name text,                 -- Schema 名称 ⭐ 关键字段
  boss_user_id uuid,                -- 老板用户 ID
  ...
);

-- 示例数据
-- id: 26d10bc2-d13b-44b0-ac9f-dec469cfadc9
-- schema_name: tenant_test1
```

**重要**：
- ❌ 不要用 tenant_id 构造 Schema 名称
- ✅ 总是从 tenants 表查询 schema_name
- ✅ Schema 名称是简短的标识符（如 tenant_test1）
- ✅ tenant_id 是完整的 UUID

## 相关文档

- [多租户架构修复总结](./多租户架构修复总结.md)
- [多租户架构支持检查报告](./多租户架构支持检查报告.md)
- [通知系统多租户支持检查报告](./通知系统多租户支持检查报告.md)
