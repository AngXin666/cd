# 快速修复：通知状态不更新问题

## 问题
老板审批后，信息中心的通知状态不会更新。

## 根本原因
RLS 策略缺少 `WITH CHECK` 子句，导致老板无法更新通知状态。

## 快速修复步骤

### 步骤 1：登录 Supabase 控制台
1. 打开 Supabase 项目
2. 进入 SQL Editor

### 步骤 2：执行修复脚本
复制并执行以下 SQL：

```sql
-- ============================================================
-- 删除所有现有策略
-- ============================================================
DO $$
DECLARE
    policy_record RECORD;
BEGIN
    FOR policy_record IN 
        SELECT policyname 
        FROM pg_policies 
        WHERE tablename = 'notifications'
    LOOP
        EXECUTE format('DROP POLICY IF EXISTS %I ON notifications', policy_record.policyname);
    END LOOP;
END $$;

-- ============================================================
-- 确保 is_admin 函数正确
-- ============================================================
CREATE OR REPLACE FUNCTION is_admin(uid uuid)
RETURNS boolean
LANGUAGE sql
SECURITY DEFINER
STABLE
AS $$
    SELECT EXISTS (
        SELECT 1 FROM public.user_roles ur
        WHERE ur.user_id = uid 
        AND ur.role IN ('BOSS', 'MANAGER', 'PEER_ADMIN')
    );
$$;

-- ============================================================
-- 创建新的 RLS 策略
-- ============================================================

-- 1. 用户可以查看自己收到的通知
CREATE POLICY "users_view_own_notifications" ON notifications
  FOR SELECT
  TO authenticated
  USING (auth.uid() = recipient_id);

-- 2. 用户可以更新自己收到的通知
CREATE POLICY "users_update_own_notifications" ON notifications
  FOR UPDATE
  TO authenticated
  USING (auth.uid() = recipient_id)
  WITH CHECK (auth.uid() = recipient_id);

-- 3. 用户可以删除自己的通知
CREATE POLICY "users_delete_own_notifications" ON notifications
  FOR DELETE
  TO authenticated
  USING (auth.uid() = recipient_id);

-- 4. 管理员可以查看所有通知
CREATE POLICY "admins_view_all_notifications" ON notifications
  FOR SELECT
  TO authenticated
  USING (is_admin(auth.uid()));

-- 5. 管理员可以创建通知
CREATE POLICY "admins_create_notifications" ON notifications
  FOR INSERT
  TO authenticated
  WITH CHECK (is_admin(auth.uid()));

-- 6. 管理员可以更新所有通知（关键修复）
CREATE POLICY "admins_update_all_notifications" ON notifications
  FOR UPDATE
  TO authenticated
  USING (is_admin(auth.uid()))
  WITH CHECK (is_admin(auth.uid()));

-- 7. 管理员可以删除所有通知
CREATE POLICY "admins_delete_all_notifications" ON notifications
  FOR DELETE
  TO authenticated
  USING (is_admin(auth.uid()));
```

### 步骤 3：验证修复
执行以下 SQL 验证：

```sql
-- 检查策略
SELECT 
    policyname AS "策略名称",
    cmd AS "命令",
    CASE WHEN qual IS NOT NULL THEN '✅' ELSE '❌' END AS "USING",
    CASE WHEN with_check IS NOT NULL THEN '✅' ELSE '❌' END AS "WITH CHECK"
FROM pg_policies
WHERE tablename = 'notifications'
ORDER BY cmd, policyname;
```

**预期结果**：
- `admins_update_all_notifications` 策略应该在 `USING` 和 `WITH CHECK` 列都显示 ✅

### 步骤 4：测试功能
1. 司机登录，提交请假申请
2. 老板登录，审批请假申请
3. 检查老板的信息中心，通知状态应该更新为"已批准"或"已拒绝"

## 验证成功的标志

### 浏览器控制台日志
```
✅ 成功更新通知 <notification_id>
📊 通知更新结果: 成功 2 条, 失败 0 条
✅ 已成功更新所有 2 条请假审批通知状态
```

### 信息中心显示
- 通知标题变为"请假审批通知"
- 通知内容显示审批结果
- 通知状态变为"已批准"或"已拒绝"

## 如果还是不行

### 检查 1：确认用户角色
```sql
SELECT u.id, u.name, ur.role
FROM users u
JOIN user_roles ur ON u.id = ur.user_id
WHERE u.id = '<your_user_id>';
```

应该返回 `BOSS` 或 `MANAGER`。

### 检查 2：测试 is_admin 函数
```sql
SELECT is_admin('<your_user_id>');
```

应该返回 `true`。

### 检查 3：查看错误日志
在浏览器控制台查看是否有错误信息：
- `❌ 更新通知失败` - RLS 策略问题
- `❌ 查询原始通知失败` - 查询权限问题

### 检查 4：临时禁用 RLS（仅用于测试）
```sql
-- 临时禁用 RLS
ALTER TABLE notifications DISABLE ROW LEVEL SECURITY;

-- 测试更新
UPDATE notifications
SET approval_status = 'approved'
WHERE id = '<notification_id>';

-- 重新启用 RLS
ALTER TABLE notifications ENABLE ROW LEVEL SECURITY;
```

如果禁用 RLS 后可以更新，说明确实是 RLS 策略问题。

## 联系支持

如果以上步骤都无法解决问题，请提供以下信息：
1. Supabase 项目 ID
2. 用户 ID
3. 通知 ID
4. 浏览器控制台的完整日志
5. Supabase 日志（如果有访问权限）

---

**创建时间**：2025-11-05  
**预计修复时间**：5 分钟
