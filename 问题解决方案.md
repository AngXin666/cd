# é€šçŸ¥ç³»ç»Ÿé—®é¢˜è§£å†³æ–¹æ¡ˆ

## ğŸ”´ å½“å‰é—®é¢˜

æ ¹æ®æ‚¨æä¾›çš„æ—¥å¿—ï¼š
```
âš ï¸ æœªæ‰¾åˆ°ä¸»è´¦å·
âš ï¸ æœªæ‰¾åˆ°è½¦é˜Ÿé•¿ä¿¡æ¯
âš ï¸ æ²¡æœ‰æ‰¾åˆ°ä»»ä½•é€šçŸ¥æ¥æ”¶è€…ï¼Œé€šçŸ¥å‘é€å®Œæˆï¼ˆæ— æ¥æ”¶è€…ï¼‰
```

**é—®é¢˜åŸå› **ï¼š
1. **ä»£ç é—®é¢˜**ï¼šé€šçŸ¥æœåŠ¡æŸ¥è¯¢çš„è§’è‰²åç§°ä¸æ­£ç¡®
   - ä»£ç æŸ¥è¯¢ `'SUPER_ADMIN'`ï¼Œä½†æ•°æ®åº“æšä¸¾æ˜¯ `'BOSS'`
2. **æ•°æ®é—®é¢˜**ï¼š`user_roles` è¡¨ä¸­å¯èƒ½ç¼ºå°‘ç”¨æˆ·è§’è‰²æ•°æ®

**ç³»ç»Ÿè§’è‰²æšä¸¾**ï¼š`('BOSS', 'PEER_ADMIN', 'MANAGER', 'DRIVER')`

## âœ… è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1ï¼šä¿®å¤ä»£ç ï¼ˆâœ… å·²å®Œæˆï¼‰

æˆ‘å·²ç»ä¿®å¤äº†é€šçŸ¥æœåŠ¡çš„ä»£ç ï¼Œå°†æŸ¥è¯¢çš„è§’è‰²åç§°ä» `'SUPER_ADMIN'` æ”¹ä¸º `'BOSS'`ã€‚

**ä¿®æ”¹çš„æ–‡ä»¶**ï¼š
- `src/services/notificationService.ts`
  - `getPrimaryAdmin()`: æŸ¥è¯¢ `'BOSS'` è€Œä¸æ˜¯ `'SUPER_ADMIN'`
  - `getPeerAccounts()`: æŸ¥è¯¢ `'PEER_ADMIN'`
  - `_getAllAdmins()`: æŸ¥è¯¢ `['BOSS', 'PEER_ADMIN']`

### æ–¹æ¡ˆ 2ï¼šä¿®å¤æ•°æ®åº“ï¼ˆâš ï¸ å¿…é¡»æ‰§è¡Œï¼‰

æ‰§è¡Œä»¥ä¸‹ SQL è¯­å¥ï¼Œä¸ºæ‰€æœ‰ç”¨æˆ·æ·»åŠ è§’è‰²ï¼š

```sql
-- 1. ä¸ºç¬¬ä¸€ä¸ªç”¨æˆ·æ·»åŠ  BOSS è§’è‰²
INSERT INTO user_roles (user_id, role, created_at)
SELECT 
  u.id,
  'BOSS'::user_role,
  NOW()
FROM users u
LEFT JOIN user_roles ur ON u.id = ur.user_id
WHERE ur.role IS NULL
ORDER BY u.created_at
LIMIT 1
ON CONFLICT (user_id) DO NOTHING;

-- 2. ä¸ºå…¶ä»–ç”¨æˆ·æ·»åŠ  DRIVER è§’è‰²
INSERT INTO user_roles (user_id, role, created_at)
SELECT 
  u.id,
  'DRIVER'::user_role,
  NOW()
FROM users u
LEFT JOIN user_roles ur ON u.id = ur.user_id
WHERE ur.role IS NULL
ON CONFLICT (user_id) DO NOTHING;
```

### æ–¹æ¡ˆ 3ï¼šéªŒè¯ä¿®å¤ç»“æœ

è¿è¡Œä»¥ä¸‹ SQL ç¡®è®¤ä¿®å¤æˆåŠŸï¼š

```sql
-- æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·åŠå…¶è§’è‰²
SELECT 
  u.id,
  u.name,
  u.phone,
  ur.role,
  u.created_at
FROM users u
LEFT JOIN user_roles ur ON u.id = ur.user_id
ORDER BY u.created_at;
```

**é¢„æœŸç»“æœ**ï¼š
- âœ… ç¬¬ä¸€ä¸ªç”¨æˆ·çš„è§’è‰²æ˜¯ `BOSS`
- âœ… å…¶ä»–ç”¨æˆ·çš„è§’è‰²æ˜¯ `DRIVER`
- âœ… æ²¡æœ‰ç”¨æˆ·çš„è§’è‰²æ˜¯ `NULL`

## ğŸ“‹ åç»­æ­¥éª¤

### 1. å¦‚æœéœ€è¦è½¦é˜Ÿé•¿åŠŸèƒ½

å°†æŸäº›ç”¨æˆ·çš„è§’è‰²æ”¹ä¸º `MANAGER`ï¼š

```sql
-- æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·
SELECT id, name, phone, ur.role
FROM users u
LEFT JOIN user_roles ur ON u.id = ur.user_id
ORDER BY created_at;

-- å°†ç”¨æˆ·æ”¹ä¸º MANAGERï¼ˆæ›¿æ¢ <ç”¨æˆ·ID>ï¼‰
UPDATE user_roles
SET role = 'MANAGER'::user_role
WHERE user_id = '<ç”¨æˆ·ID>';
```

### 2. ä¸ºè½¦é˜Ÿé•¿åˆ†é…ä»“åº“

```sql
-- æŸ¥çœ‹æ‰€æœ‰ä»“åº“
SELECT id, name FROM warehouses;

-- ä¸ºè½¦é˜Ÿé•¿åˆ†é…ä»“åº“ï¼ˆæ›¿æ¢ <è½¦é˜Ÿé•¿ID> å’Œ <ä»“åº“ID>ï¼‰
INSERT INTO warehouse_assignments (user_id, warehouse_id, created_at)
VALUES ('<è½¦é˜Ÿé•¿ID>', '<ä»“åº“ID>', NOW())
ON CONFLICT (user_id, warehouse_id) DO NOTHING;
```

### 3. é‡æ–°æµ‹è¯•

1. **åˆ·æ–°é¡µé¢**
2. **é‡æ–°ç™»å½•**
3. **æäº¤è¯·å‡ç”³è¯·**
4. **æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—**ï¼Œåº”è¯¥çœ‹åˆ°ï¼š
   ```
   âœ… æ‰¾åˆ°ä¸»è´¦å·: { userId: 'xxx', name: 'xxx' }
   âœ… æ‰¾åˆ°æœ‰ç®¡è¾–æƒçš„è½¦é˜Ÿé•¿: { count: X }
   âœ… é€šçŸ¥å‘é€æˆåŠŸ
   ```

## ğŸ” æ£€æŸ¥è„šæœ¬

### æ£€æŸ¥ç”¨æˆ·è§’è‰²
```sql
-- ç»Ÿè®¡å„è§’è‰²çš„ç”¨æˆ·æ•°é‡
SELECT 
  COALESCE(ur.role::text, 'æ— è§’è‰²') as role,
  COUNT(*) as count
FROM users u
LEFT JOIN user_roles ur ON u.id = ur.user_id
GROUP BY ur.role;
```

### æ£€æŸ¥ä»“åº“åˆ†é…
```sql
-- æŸ¥çœ‹æ‰€æœ‰ä»“åº“åˆ†é…
SELECT 
  u.name as user_name,
  ur.role,
  w.name as warehouse_name
FROM warehouse_assignments wa
JOIN users u ON wa.user_id = u.id
JOIN warehouses w ON wa.warehouse_id = w.id
LEFT JOIN user_roles ur ON u.id = ur.user_id
ORDER BY u.name;
```

## ğŸ“ ç›¸å…³æ–‡æ¡£

- `æµ‹è¯•æŒ‡å—.md`ï¼šè¯¦ç»†çš„æµ‹è¯•æ­¥éª¤
- `æ£€æŸ¥ç”¨æˆ·è§’è‰².sql`ï¼šæ£€æŸ¥è„šæœ¬
- `ä¿®å¤ç”¨æˆ·è§’è‰².sql`ï¼šä¿®å¤è„šæœ¬
- `supabase/migrations/00531_fix_missing_user_roles.sql`ï¼šæ•°æ®åº“è¿ç§»

---

**æœ€åæ›´æ–°**ï¼š2025-12-01
**çŠ¶æ€**ï¼šä»£ç å·²ä¿®å¤ï¼Œç­‰å¾…æ‰§è¡Œæ•°æ®åº“ä¿®å¤ SQL
