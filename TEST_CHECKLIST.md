# 测试清单

## ✅ 已完成的修复

### 1. 登录账号映射修复
- ✅ 修改 `src/pages/login/index.tsx` 中的账号映射
- ✅ `admin` 现在正确映射到 `admin@fleet.com`
- ✅ 更新了测试账号提示信息

### 2. RLS 策略修复
- ✅ 添加了 profiles 表的 SELECT 策略
- ✅ 用户可以查看自己的档案
- ✅ 超级管理员可以查看所有档案
- ✅ 超级管理员拥有完整的 CRUD 权限

### 3. 账号状态检查修复（数据库层）
- ✅ 修复了 `check_account_status` 数据库函数
- ✅ 系统超级管理员不再受租约限制
- ✅ 只检查账号的 status 字段，不检查租约

### 4. 租期检查逻辑修复（应用层）⭐ 最新修复
- ✅ 修复了 `checkUserLeaseStatus()` API 函数
- ✅ 添加了系统超级管理员判断（tenant_id 为 NULL）
- ✅ 创建了 `getCurrentUserRoleAndTenant()` 函数
- ✅ 更新了 `index.tsx` 页面逻辑
- ✅ 前端明确判断是否需要检查租期
- ✅ 系统超级管理员不会调用租期检查函数

## 🧪 测试项目

### 测试1：使用用户名登录 ⏳

**步骤**：
1. 打开登录页面
2. 输入账号：`admin`（不是 admin@fleet.com）
3. 输入密码：`hye19911206`
4. 点击"密码登录"按钮

**预期结果**：
- [ ] 显示 "登录成功" 提示
- [ ] 跳转到超级管理员界面
- [ ] 可以看到 "租户配置管理" 等功能

**实际结果**：
```
请在此处填写测试结果
```

---

### 测试2：验证用户角色获取 ⏳

**步骤**：
1. 登录成功后，打开浏览器开发者工具（F12）
2. 查看 Console 标签页
3. 查找 `[getCurrentUserRole]` 相关日志

**预期结果**：
- [ ] 看到 `[getCurrentUserRole] 开始获取用户角色`
- [ ] 看到 `[getCurrentUserRole] 当前用户ID: d79327e9-69b4-42b7-b1b4-5d13de6e9814`
- [ ] 看到 `[getCurrentUserRole] 成功获取用户角色: super_admin`
- [ ] 没有 `[getCurrentUserRole] 用户档案不存在` 错误

**实际结果**：
```
请在此处填写测试结果
```

---

### 测试3：验证账号不会过期 ⏳

**步骤**：
1. 登录成功后，观察是否有任何过期提示
2. 检查控制台日志
3. 尝试访问各个功能页面

**预期结果**：
- [ ] 没有 "账号已过期" 的提示
- [ ] 没有 "请续费使用" 的提示
- [ ] 可以正常访问所有功能

**实际结果**：
```
请在此处填写测试结果
```

---

### 测试4：验证超级管理员权限 ⏳

**步骤**：
1. 登录后，点击 "租户配置管理"
2. 尝试创建一个测试租户
3. 尝试编辑租户信息
4. 尝试查看租户列表

**预期结果**：
- [ ] 可以访问租户配置管理页面
- [ ] 可以创建新租户
- [ ] 可以编辑租户信息
- [ ] 可以查看所有租户列表

**实际结果**：
```
请在此处填写测试结果
```

---

### 测试5：验证其他测试账号 ⏳

**测试账号列表**：

| 账号 | 密码 | 角色 | 登录结果 | 备注 |
|------|------|------|---------|------|
| admin | hye19911206 | 系统超级管理员 | ⏳ | |
| admin888 | hye19911206 | 租赁管理员 | ⏳ | |
| admin1 | 123456 | 司机 | ⏳ | |
| admin2 | 123456 | 车队长 | ⏳ | |
| admin3 | 123456 | 老板 | ⏳ | |

**测试步骤**（对每个账号）：
1. 退出当前登录
2. 使用测试账号登录
3. 验证是否可以正常登录
4. 验证是否跳转到正确的界面

**预期结果**：
- [ ] 所有账号都可以正常登录
- [ ] 每个账号跳转到对应角色的界面

**实际结果**：
```
请在此处填写测试结果
```

---

### 测试6：验证租期检查逻辑 ⭐ 重点测试

**目的**：确认系统超级管理员不会被租期检查拦截

**步骤**：
1. 打开浏览器开发者工具（F12）
2. 切换到 Console 标签页
3. 清空控制台日志
4. 使用 admin 账号登录
5. 仔细观察控制台输出

**预期结果**：

✅ **应该看到的日志**：
```
[IndexPage] 开始获取用户角色，用户ID: d79327e9-69b4-42b7-b1b4-5d13de6e9814
[getCurrentUserRoleAndTenant] 开始获取用户角色和租户信息
[getCurrentUserRoleAndTenant] 成功获取: {role: 'super_admin', tenant_id: null}
[IndexPage] 用户角色获取成功: super_admin 租户ID: null
[IndexPage] 无需检查租期状态，角色: super_admin 租户ID: null
[IndexPage] 根据角色快速跳转: super_admin
```

❌ **不应该看到的日志**：
```
❌ 正在检查租期状态...
❌ [租期检测] 查询到的租期记录
❌ [租期检测] 没有有效租期记录
❌ 账户已过期
```

**关键检查点**：
- [ ] 看到 "租户ID: null"
- [ ] 看到 "无需检查租期状态"
- [ ] 没有看到 "正在检查租期状态"
- [ ] 没有看到任何 "[租期检测]" 日志
- [ ] 没有弹出 "账户已过期" 提示
- [ ] 成功跳转到超级管理员界面

**实际结果**：
```
请在此处粘贴控制台日志
```

---

## 🔍 故障排查

### 如果测试失败

#### 问题1：仍然无法使用 admin 登录

**检查项**：
1. 确认输入的是 `admin`，不是 `admin@fleet.com`
2. 确认密码是 `hye19911206`
3. 检查浏览器控制台的 Network 标签页
4. 查看 `/auth/v1/token` 请求的参数

**解决方案**：
- 清除浏览器缓存
- 刷新页面重试
- 查看 [LOGIN_FIX_SUMMARY.md](LOGIN_FIX_SUMMARY.md) 获取详细信息

#### 问题2：仍然报错 "用户档案不存在"

**检查项**：
1. 检查控制台日志，确认错误详情
2. 验证 RLS 策略是否正确添加

**验证 SQL**：
```sql
SELECT policyname, cmd
FROM pg_policies 
WHERE schemaname = 'public' AND tablename = 'profiles'
ORDER BY cmd, policyname;
```

**解决方案**：
- 查看 [LOGIN_FIX_SUMMARY.md](LOGIN_FIX_SUMMARY.md) 中的 RLS 策略部分
- 如果策略缺失，重新执行迁移文件

#### 问题3：仍然提示账号过期 ⭐ 最新修复

**检查项**：
1. 确认登录的是系统超级管理员账号（admin）
2. 检查账号的 tenant_id 是否为 NULL
3. 查看控制台日志，确认是否调用了租期检查

**验证 SQL**：
```sql
SELECT 
  id,
  name,
  role,
  status,
  tenant_id
FROM public.profiles 
WHERE email = 'admin@fleet.com';
```

**预期结果**：
- role: super_admin
- status: active
- tenant_id: NULL （⭐ 关键：必须是 NULL）

**控制台日志检查**：

如果看到以下日志，说明修复成功：
```
✅ [IndexPage] 无需检查租期状态，角色: super_admin 租户ID: null
```

如果看到以下日志，说明还有问题：
```
❌ [IndexPage] 需要检查租期状态
❌ [租期检测] 查询到的租期记录
```

**解决方案**：
1. 查看 [LEASE_CHECK_FIX.md](LEASE_CHECK_FIX.md) 获取详细的修复说明
2. 确认 `src/db/api.ts` 中的 `checkUserLeaseStatus()` 函数已更新
3. 确认 `src/pages/index/index.tsx` 中的逻辑已更新
4. 清除浏览器缓存并刷新页面
5. 如果问题仍然存在，检查 tenant_id 是否为 NULL
6. 查看 [SUPER_ADMIN_FIX_SUMMARY.md](SUPER_ADMIN_FIX_SUMMARY.md) 获取更多信息

## 📊 测试结果汇总

### 总体评分

- [ ] ✅ 所有测试通过
- [ ] ⚠️ 部分测试通过
- [ ] ❌ 测试失败

### 通过的测试

```
请列出通过的测试项目
```

### 失败的测试

```
请列出失败的测试项目及原因
```

### 需要改进的地方

```
请列出需要改进的地方
```

## 📝 反馈

如果测试过程中遇到任何问题，请提供以下信息：

1. **问题描述**：
   ```
   请详细描述遇到的问题
   ```

2. **复现步骤**：
   ```
   请列出如何复现这个问题的步骤
   ```

3. **错误信息**：
   ```
   请粘贴浏览器控制台的错误日志
   ```

4. **环境信息**：
   - 浏览器：
   - 操作系统：
   - 网络环境：

## 📚 相关文档

- [SUPER_ADMIN_FIX_SUMMARY.md](SUPER_ADMIN_FIX_SUMMARY.md) - 超级管理员修复总结
- [LOGIN_FIX_SUMMARY.md](LOGIN_FIX_SUMMARY.md) - 登录问题修复总结
- [FINAL_TEST_GUIDE.md](FINAL_TEST_GUIDE.md) - 最终测试指南
- [README.md](README.md) - 项目主文档

---

**测试日期**：  
**测试人员**：  
**测试状态**：⏳ 待测试
