# 添加驾驶员信息展示

## 需求描述

在车辆详情页面添加驾驶员个人信息和证件照片的展示，包括：
1. 身份证信息（姓名、身份证号、出生日期、住址）
2. 驾驶证信息（驾驶证号、准驾车型、初次领证日期、有效期、发证机关）
3. 证件照片（身份证正面、身份证背面、驾驶证照片）

## 实现方案

### 1. 数据源

使用已有的`driver_licenses`表，该表包含以下字段：

#### 身份证信息
- `id_card_number`: 身份证号
- `id_card_name`: 姓名
- `id_card_address`: 住址
- `id_card_birth_date`: 出生日期
- `id_card_photo_front`: 身份证正面照片URL
- `id_card_photo_back`: 身份证背面照片URL

#### 驾驶证信息
- `license_number`: 驾驶证号
- `license_class`: 准驾车型
- `valid_from`: 初次领证日期
- `valid_to`: 有效期至
- `issue_authority`: 发证机关
- `driving_license_photo`: 驾驶证照片URL

### 2. API调用

使用已有的API函数：
```typescript
// 获取驾驶员证件信息
export async function getDriverLicense(driverId: string): Promise<DriverLicense | null>
```

### 3. 页面修改

#### 文件：`src/pages/driver/vehicle-detail/index.tsx`

#### 修改内容

##### 3.1 添加导入
```typescript
import {getDriverLicense, getVehicleById} from '@/db/api'
import type {DriverLicense, Vehicle} from '@/db/types'
```

##### 3.2 添加状态
```typescript
const [driverLicense, setDriverLicense] = useState<DriverLicense | null>(null)
```

##### 3.3 修改加载函数
```typescript
// 加载车辆详情和驾驶员证件信息
const loadVehicleDetail = async (vehicleId: string) => {
  setLoading(true)
  try {
    // 加载车辆信息
    const vehicleData = await getVehicleById(vehicleId)
    setVehicle(vehicleData)

    // 加载驾驶员证件信息
    if (vehicleData && vehicleData.user_id) {
      const licenseData = await getDriverLicense(vehicleData.user_id)
      setDriverLicense(licenseData)
    }
  } catch (error) {
    console.error('加载车辆详情失败:', error)
    Taro.showToast({
      title: '加载失败',
      icon: 'none'
    })
  } finally {
    setLoading(false)
  }
}
```

##### 3.4 添加驾驶员信息卡片

在基本信息卡片和车辆照片卡片之间插入驾驶员信息卡片：

```tsx
{/* 驾驶员信息卡片 */}
{driverLicense && (
  <View className="bg-white rounded-2xl p-5 mb-4 shadow-md">
    <View className="flex items-center mb-4">
      <View className="i-mdi-account-card text-2xl text-blue-600 mr-2"></View>
      <Text className="text-lg font-bold text-gray-800">驾驶员信息</Text>
    </View>

    {/* 身份证信息 */}
    {(driverLicense.id_card_name || driverLicense.id_card_number) && (
      <View className="mb-4">
        <View className="flex items-center mb-3">
          <View className="i-mdi-card-account-details text-xl text-orange-600 mr-2"></View>
          <Text className="text-base font-semibold text-gray-700">身份证信息</Text>
        </View>
        <View className="space-y-2 pl-7">
          {driverLicense.id_card_name && (
            <InfoRow icon="i-mdi-account" label="姓名" value={driverLicense.id_card_name} />
          )}
          {driverLicense.id_card_number && (
            <InfoRow icon="i-mdi-identifier" label="身份证号" value={driverLicense.id_card_number} />
          )}
          {driverLicense.id_card_birth_date && (
            <InfoRow
              icon="i-mdi-cake"
              label="出生日期"
              value={new Date(driverLicense.id_card_birth_date).toLocaleDateString('zh-CN')}
            />
          )}
          {driverLicense.id_card_address && (
            <InfoRow icon="i-mdi-home" label="住址" value={driverLicense.id_card_address} />
          )}
        </View>
      </View>
    )}

    {/* 驾驶证信息 */}
    {(driverLicense.license_number || driverLicense.license_class) && (
      <View className="mb-4">
        <View className="flex items-center mb-3">
          <View className="i-mdi-card-account-details-outline text-xl text-green-600 mr-2"></View>
          <Text className="text-base font-semibold text-gray-700">驾驶证信息</Text>
        </View>
        <View className="space-y-2 pl-7">
          {driverLicense.license_number && (
            <InfoRow icon="i-mdi-numeric" label="驾驶证号" value={driverLicense.license_number} />
          )}
          {driverLicense.license_class && (
            <InfoRow icon="i-mdi-car" label="准驾车型" value={driverLicense.license_class} />
          )}
          {driverLicense.valid_from && (
            <InfoRow
              icon="i-mdi-calendar-start"
              label="初次领证日期"
              value={new Date(driverLicense.valid_from).toLocaleDateString('zh-CN')}
            />
          )}
          {driverLicense.valid_to && (
            <InfoRow
              icon="i-mdi-calendar-end"
              label="有效期至"
              value={new Date(driverLicense.valid_to).toLocaleDateString('zh-CN')}
            />
          )}
          {driverLicense.issue_authority && (
            <InfoRow icon="i-mdi-office-building" label="发证机关" value={driverLicense.issue_authority} />
          )}
        </View>
      </View>
    )}

    {/* 证件照片 */}
    {(driverLicense.id_card_photo_front ||
      driverLicense.id_card_photo_back ||
      driverLicense.driving_license_photo) && (
      <View>
        <View className="flex items-center mb-3">
          <View className="i-mdi-image-multiple text-xl text-purple-600 mr-2"></View>
          <Text className="text-base font-semibold text-gray-700">证件照片</Text>
        </View>
        <View className="grid grid-cols-2 gap-3">
          {driverLicense.id_card_photo_front && (
            <PhotoCard
              title="身份证正面"
              icon="i-mdi-card-account-details"
              url={driverLicense.id_card_photo_front}
              allPhotos={[
                driverLicense.id_card_photo_front,
                driverLicense.id_card_photo_back,
                driverLicense.driving_license_photo
              ].filter(Boolean) as string[]}
              onPreview={previewImage}
            />
          )}
          {driverLicense.id_card_photo_back && (
            <PhotoCard
              title="身份证背面"
              icon="i-mdi-card-account-details"
              url={driverLicense.id_card_photo_back}
              allPhotos={[
                driverLicense.id_card_photo_front,
                driverLicense.id_card_photo_back,
                driverLicense.driving_license_photo
              ].filter(Boolean) as string[]}
              onPreview={previewImage}
            />
          )}
          {driverLicense.driving_license_photo && (
            <PhotoCard
              title="驾驶证"
              icon="i-mdi-card-account-details-outline"
              url={driverLicense.driving_license_photo}
              allPhotos={[
                driverLicense.id_card_photo_front,
                driverLicense.id_card_photo_back,
                driverLicense.driving_license_photo
              ].filter(Boolean) as string[]}
              onPreview={previewImage}
            />
          )}
        </View>
      </View>
    )}
  </View>
)}
```

## 设计细节

### 1. 卡片布局

驾驶员信息卡片采用与其他卡片一致的设计风格：
- 白色背景，圆角2xl
- 内边距5
- 阴影效果

### 2. 信息分组

信息分为三个部分，每个部分都有独立的标题和图标：

#### 身份证信息（橙色主题）
- 图标：`i-mdi-card-account-details`
- 颜色：`text-orange-600`
- 包含：姓名、身份证号、出生日期、住址

#### 驾驶证信息（绿色主题）
- 图标：`i-mdi-card-account-details-outline`
- 颜色：`text-green-600`
- 包含：驾驶证号、准驾车型、初次领证日期、有效期、发证机关

#### 证件照片（紫色主题）
- 图标：`i-mdi-image-multiple`
- 颜色：`text-purple-600`
- 包含：身份证正面、身份证背面、驾驶证照片

### 3. 条件渲染

所有信息都采用条件渲染：
- 只有当`driverLicense`存在时才显示整个卡片
- 只有当某个分组有数据时才显示该分组
- 只有当某个字段有值时才显示该字段

这样可以避免显示空白内容，提供更好的用户体验。

### 4. 日期格式化

所有日期字段都使用`toLocaleDateString('zh-CN')`格式化为中文日期格式：
```typescript
new Date(driverLicense.id_card_birth_date).toLocaleDateString('zh-CN')
// 输出：2025/1/15
```

### 5. 图片预览

证件照片使用`PhotoCard`组件展示，支持点击预览：
- 点击任意照片可以全屏预览
- 可以左右滑动查看其他证件照片
- 预览时只显示证件照片，不包括车辆照片

## 页面结构

修改后的车辆详情页面结构：

```
车辆详情页面
├── 车辆头部卡片（车牌号、品牌型号、状态）
├── 基本信息卡片（车辆类型、VIN、所有人等）
├── 驾驶员信息卡片（新增）
│   ├── 身份证信息
│   ├── 驾驶证信息
│   └── 证件照片
├── 车辆照片卡片（7张车辆照片）
└── 行驶证信息卡片（行驶证详细信息）
```

## 技术要点

### 1. 数据加载

```typescript
// 同时加载车辆信息和驾驶员证件信息
const vehicleData = await getVehicleById(vehicleId)
setVehicle(vehicleData)

if (vehicleData && vehicleData.user_id) {
  const licenseData = await getDriverLicense(vehicleData.user_id)
  setDriverLicense(licenseData)
}
```

**关键点**：
- 先加载车辆信息，获取`user_id`
- 使用`user_id`加载驾驶员证件信息
- 如果没有证件信息，不显示驾驶员信息卡片

### 2. 条件渲染

```typescript
{driverLicense && (
  <View>
    {/* 驾驶员信息卡片 */}
  </View>
)}
```

**优点**：
- 只有当数据存在时才渲染
- 避免空白内容
- 提高性能

### 3. 信息展示

使用`InfoRow`组件统一展示信息：
```typescript
<InfoRow 
  icon="i-mdi-account" 
  label="姓名" 
  value={driverLicense.id_card_name} 
/>
```

**优点**：
- 统一的样式
- 清晰的图标标识
- 易于维护

### 4. 照片预览

```typescript
<PhotoCard
  title="身份证正面"
  icon="i-mdi-card-account-details"
  url={driverLicense.id_card_photo_front}
  allPhotos={[
    driverLicense.id_card_photo_front,
    driverLicense.id_card_photo_back,
    driverLicense.driving_license_photo
  ].filter(Boolean) as string[]}
  onPreview={previewImage}
/>
```

**关键点**：
- `url`：当前照片的URL
- `allPhotos`：所有证件照片的URL数组（用于左右滑动）
- `filter(Boolean)`：过滤掉null值
- `as string[]`：类型断言

## 用户体验

### 1. 信息完整性

用户可以在车辆详情页面一次性查看：
- 车辆基本信息
- 驾驶员个人信息
- 驾驶员证件信息
- 车辆照片
- 证件照片
- 行驶证信息

### 2. 视觉层次

通过不同的颜色和图标区分不同类型的信息：
- 身份证信息：橙色
- 驾驶证信息：绿色
- 证件照片：紫色

### 3. 交互体验

- 点击证件照片可以全屏预览
- 可以左右滑动查看其他证件照片
- 所有信息都有清晰的图标标识

### 4. 空状态处理

- 如果没有驾驶员证件信息，不显示驾驶员信息卡片
- 如果某个分组没有数据，不显示该分组
- 如果某个字段没有值，不显示该字段

## 数据流程

```
1. 用户打开车辆详情页面
   ↓
2. 传入车辆ID
   ↓
3. 调用 getVehicleById(vehicleId)
   ↓
4. 获取车辆信息，包括 user_id
   ↓
5. 调用 getDriverLicense(user_id)
   ↓
6. 获取驾驶员证件信息
   ↓
7. 渲染页面
   ├── 车辆信息
   ├── 驾驶员信息（如果存在）
   └── 车辆照片
```

## 测试验证

### 测试场景1：有完整驾驶员信息

**步骤**：
1. 以司机身份登录
2. 添加车辆并上传证件照片
3. 查看车辆详情

**预期结果**：
- ✅ 显示驾驶员信息卡片
- ✅ 显示身份证信息
- ✅ 显示驾驶证信息
- ✅ 显示证件照片
- ✅ 点击照片可以预览

### 测试场景2：部分驾驶员信息

**步骤**：
1. 只填写部分驾驶员信息
2. 查看车辆详情

**预期结果**：
- ✅ 显示驾驶员信息卡片
- ✅ 只显示有值的字段
- ✅ 没有值的字段不显示

### 测试场景3：没有驾驶员信息

**步骤**：
1. 添加车辆但不填写驾驶员信息
2. 查看车辆详情

**预期结果**：
- ✅ 不显示驾驶员信息卡片
- ✅ 其他信息正常显示

### 测试场景4：照片预览

**步骤**：
1. 点击身份证正面照片
2. 进入预览模式
3. 左右滑动

**预期结果**：
- ✅ 全屏显示照片
- ✅ 可以左右滑动查看其他证件照片
- ✅ 只显示证件照片，不包括车辆照片

## 后续优化方向

### 1. 编辑功能
- [ ] 添加编辑按钮
- [ ] 支持修改驾驶员信息
- [ ] 支持重新上传证件照片

### 2. 验证功能
- [ ] 验证身份证号格式
- [ ] 验证驾驶证号格式
- [ ] 检查证件有效期

### 3. 提醒功能
- [ ] 驾驶证即将过期提醒
- [ ] 证件信息不完整提醒
- [ ] 证件照片缺失提醒

### 4. 统计功能
- [ ] 统计驾驶员数量
- [ ] 统计证件过期情况
- [ ] 生成证件管理报表

## 总结

本次修改成功在车辆详情页面添加了驾驶员信息展示功能：

### 核心改进
1. ✅ **添加驾驶员信息卡片**：展示身份证和驾驶证信息
2. ✅ **添加证件照片展示**：支持预览身份证和驾驶证照片
3. ✅ **条件渲染**：只显示有数据的内容
4. ✅ **统一设计风格**：与其他卡片保持一致

### 技术提升
- 正确的数据加载流程
- 合理的条件渲染
- 清晰的信息分组
- 友好的用户体验

### 用户体验
- 信息完整，一目了然
- 视觉层次清晰
- 交互流畅
- 空状态处理得当

所有修改都已完成并测试通过，用户现在可以在车辆详情页面查看完整的驾驶员信息和证件照片。
