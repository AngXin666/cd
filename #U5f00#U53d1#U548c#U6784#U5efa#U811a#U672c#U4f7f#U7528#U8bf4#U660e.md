# 开发和构建脚本使用说明

## 概述

本项目是基于 Taro 框架的跨平台应用，支持微信小程序和 H5 两种平台。项目提供了完整的开发和构建脚本，方便开发者进行本地开发和生产部署。

## 脚本列表

### 开发脚本（Development）

| 命令 | 说明 | 用途 |
|------|------|------|
| `pnpm run dev` | 默认开发模式 | 启动微信小程序开发服务器 |
| `pnpm run dev:weapp` | 微信小程序开发 | 启动微信小程序开发服务器（watch 模式） |
| `pnpm run dev:h5` | H5 开发 | 启动 H5 开发服务器（watch 模式） |

### 构建脚本（Build）

| 命令 | 说明 | 用途 |
|------|------|------|
| `pnpm run build` | 默认构建 | 构建微信小程序生产版本 |
| `pnpm run build:weapp` | 微信小程序构建 | 构建微信小程序生产版本 |
| `pnpm run build:h5` | H5 构建 | 构建 H5 生产版本 |

### 其他脚本

| 命令 | 说明 | 用途 |
|------|------|------|
| `pnpm run lint` | 代码检查 | 运行代码质量检查和修复 |
| `pnpm run postinstall` | 安装后处理 | 自动执行 weapp-tw patch |

## 详细说明

### 1. 开发模式（dev）

#### 微信小程序开发

```bash
# 方式1：使用默认命令
pnpm run dev

# 方式2：明确指定平台
pnpm run dev:weapp
```

**功能特性：**
- ✅ 自动监听文件变化
- ✅ 实时编译和热更新
- ✅ 开发者工具集成
- ✅ Source Map 支持
- ✅ 错误提示和警告

**输出目录：** `dist/weapp/`

**使用步骤：**
1. 运行开发命令
2. 打开微信开发者工具
3. 导入项目目录（选择 `dist/weapp/`）
4. 开始开发和调试

#### H5 开发

```bash
pnpm run dev:h5
```

**功能特性：**
- ✅ 本地开发服务器
- ✅ 热模块替换（HMR）
- ✅ 浏览器自动刷新
- ✅ 移动端预览
- ✅ 开发者工具支持

**输出目录：** `dist/h5/`

**访问地址：** 通常是 `http://localhost:10086`

**使用步骤：**
1. 运行开发命令
2. 浏览器自动打开
3. 使用浏览器开发者工具调试
4. 可以使用手机扫码预览

### 2. 构建模式（build）

#### 微信小程序构建

```bash
# 方式1：使用默认命令
pnpm run build

# 方式2：明确指定平台
pnpm run build:weapp
```

**功能特性：**
- ✅ 代码压缩和混淆
- ✅ 资源优化
- ✅ Tree Shaking
- ✅ 代码分割
- ✅ 生产环境配置

**输出目录：** `dist/weapp/`

**使用步骤：**
1. 运行构建命令
2. 等待构建完成
3. 使用微信开发者工具打开 `dist/weapp/`
4. 上传代码到微信平台

#### H5 构建

```bash
pnpm run build:h5
```

**功能特性：**
- ✅ 静态资源优化
- ✅ 代码分割和懒加载
- ✅ CDN 资源处理
- ✅ PWA 支持（可选）
- ✅ SEO 优化

**输出目录：** `dist/h5/`

**使用步骤：**
1. 运行构建命令
2. 等待构建完成
3. 将 `dist/h5/` 目录部署到服务器
4. 配置 Nginx 或其他 Web 服务器

### 3. 代码检查（lint）

```bash
pnpm run lint
```

**检查内容：**
- ✅ TypeScript 类型检查
- ✅ 代码格式检查（Biome）
- ✅ 认证使用检查
- ✅ 导航使用检查

**自动修复：**
- 代码格式问题会自动修复
- 类型错误需要手动修复

## 开发工作流

### 日常开发流程

1. **启动开发服务器**
   ```bash
   pnpm run dev:weapp  # 或 dev:h5
   ```

2. **编写代码**
   - 修改源代码
   - 保存文件
   - 自动编译和刷新

3. **运行代码检查**
   ```bash
   pnpm run lint
   ```

4. **提交代码**
   ```bash
   git add .
   git commit -m "描述"
   git push
   ```

### 发布流程

1. **代码检查**
   ```bash
   pnpm run lint
   ```

2. **构建生产版本**
   ```bash
   pnpm run build:weapp  # 或 build:h5
   ```

3. **测试构建结果**
   - 微信小程序：使用开发者工具测试
   - H5：本地启动 HTTP 服务器测试

4. **部署**
   - 微信小程序：上传到微信平台
   - H5：部署到服务器

## 常见问题

### 1. 开发服务器启动失败

**问题：** 运行 `pnpm run dev` 时报错

**解决方案：**
```bash
# 清理缓存
rm -rf node_modules
rm -rf dist

# 重新安装依赖
pnpm install

# 重新启动
pnpm run dev
```

### 2. 构建失败

**问题：** 运行 `pnpm run build` 时报错

**解决方案：**
```bash
# 先运行代码检查
pnpm run lint

# 修复所有错误后再构建
pnpm run build
```

### 3. 微信开发者工具无法打开项目

**问题：** 导入项目时提示错误

**解决方案：**
- 确保已运行 `pnpm run dev:weapp` 或 `pnpm run build:weapp`
- 检查 `dist/weapp/` 目录是否存在
- 确保 `project.config.json` 配置正确

### 4. H5 页面无法访问

**问题：** 浏览器无法打开开发服务器

**解决方案：**
- 检查端口是否被占用
- 查看控制台错误信息
- 尝试更换端口（修改配置文件）

### 5. 热更新不工作

**问题：** 修改代码后页面不自动刷新

**解决方案：**
- 重启开发服务器
- 清理浏览器缓存
- 检查文件保存是否成功

## 性能优化建议

### 开发模式优化

1. **使用增量编译**
   - watch 模式已启用
   - 只编译修改的文件

2. **减少不必要的依赖**
   - 避免引入大型库
   - 使用按需加载

3. **合理使用缓存**
   - 开发模式会自动缓存
   - 必要时清理缓存

### 构建优化

1. **代码分割**
   - 使用动态 import
   - 按路由分割代码

2. **资源压缩**
   - 图片压缩
   - 代码压缩

3. **Tree Shaking**
   - 移除未使用的代码
   - 使用 ES6 模块

## 环境变量

项目使用 `.env` 文件管理环境变量：

```bash
# Supabase 配置
TARO_APP_SUPABASE_URL=your_supabase_url
TARO_APP_SUPABASE_ANON_KEY=your_anon_key

# 应用配置
TARO_APP_NAME=车队管家
TARO_APP_APP_ID=your_app_id
```

**注意：**
- 开发环境和生产环境可以使用不同的配置
- 敏感信息不要提交到代码仓库

## 目录结构

```
project/
├── src/                    # 源代码
│   ├── pages/             # 页面
│   ├── components/        # 组件
│   ├── db/                # 数据库
│   ├── utils/             # 工具函数
│   └── app.tsx            # 入口文件
├── dist/                   # 构建输出
│   ├── weapp/             # 微信小程序
│   └── h5/                # H5
├── config/                 # 配置文件
├── scripts/               # 脚本文件
└── package.json           # 项目配置
```

## 技术栈

- **框架：** Taro 4.1.5
- **UI 库：** React 18.3.1
- **状态管理：** Zustand 5.0.8
- **样式：** Tailwind CSS 3.4.17
- **语言：** TypeScript 5.9.2
- **构建工具：** Vite 4.5.14
- **后端：** Supabase

## 相关文档

- [快速开始](./快速开始.md)
- [开发者指南](./docs/DEVELOPER_GUIDE.md)
- [API 文档](./docs/API_REFERENCE.md)
- [用户手册](./docs/USER_MANUAL.md)

## 更新日志

### 2025-11-05
- ✅ 恢复 dev 和 build 脚本
- ✅ 添加完整的脚本说明文档
- ✅ 提供详细的使用指南
- ✅ 添加常见问题解答

## 支持

如有问题，请：
1. 查看本文档的常见问题部分
2. 查看项目 README.md
3. 查看 Taro 官方文档
4. 提交 Issue

---

**祝开发愉快！** 🚀
