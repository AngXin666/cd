# 🔧 修复H5更新功能

## 问题诊断

✅ 数据库中已有1.0.1版本  
✅ 版本比较逻辑正确  
❌ **Anon Key 无效** - 这是根本原因！

## 解决方案

### 步骤1：获取正确的Anon Key

1. 打开Supabase控制台：
   https://supabase.com/dashboard/project/wxvrwkpkioalqdsfswwu/settings/api

2. 找到 **Project API keys** 部分

3. 复制 `anon` `public` 那个key（以 `eyJ` 开头的长字符串）

### 步骤2：更新 .env 文件

打开 `.env` 文件，将 `TARO_APP_SUPABASE_ANON_KEY` 替换为正确的key：

```
TARO_APP_SUPABASE_ANON_KEY=你复制的anon_key
VITE_SUPABASE_ANON_KEY=你复制的anon_key
```

### 步骤3：重新构建APK

```powershell
# 1. 重新构建H5
npm run build:h5

# 2. 同步到Android
npx cap sync android

# 3. 构建APK
cd android
.\gradlew assembleDebug
```

### 步骤4：安装新APK测试

安装新构建的APK，打开APP应该会看到更新对话框。

---

## 验证数据库

运行测试脚本确认数据库正常：

```powershell
node scripts/test-h5-update.js
```

当前结果：
- ✅ 数据库连接成功（使用Service Role Key）
- ✅ 1.0.1版本存在
- ✅ 版本比较正确（1.0.1 > 1.0.0）

---

## 当前状态

| 项目 | 状态 |
|------|------|
| h5_versions表 | ✅ 存在 |
| 1.0.1版本记录 | ✅ 存在 |
| H5文件上传 | ✅ 76/77文件成功 |
| Anon Key | ❌ 需要更新 |
| APK | ❌ 需要重新构建 |

---

**关键：获取正确的Anon Key后，更新.env文件，重新构建APK即可！**
