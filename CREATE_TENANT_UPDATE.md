# 创建租户功能更新说明

## 更新时间
2025-11-27

## 更新内容

### 1. 表单字段调整

创建租户表单现在包含以下字段：

#### 基本信息
- **公司名称** (必填)
- 联系人 (可选)
- 联系电话 (可选)
- 联系邮箱 (可选)

#### 租期设置
- 有效期至 (可选，不设置则永久有效)

#### 老板账号
- **姓名** (必填)
- **手机号** (必填) - 用于接收通知和验证码登录
- **登录账号** (必填) - 用于账号密码登录，4-20位字母、数字或下划线
- **登录密码** (必填) - 至少6位
- **确认密码** (必填) - 必须与登录密码一致

### 2. 密码二次验证

- 添加了"确认密码"字段
- 提交时会验证两次输入的密码是否一致
- 如果不一致，会提示"两次输入的密码不一致"

### 3. 登录账号支持

#### 创建租户时
- 老板可以设置一个自定义的登录账号（4-20位字母、数字或下划线）
- 系统会将账号名转换为邮箱格式（`账号名@fleet.local`）存储在 Supabase Auth 中
- 账号名会同时保存在 `user_metadata.account` 字段中

#### 登录时
老板可以使用以下任一方式登录：
1. **手机号 + 密码**
2. **登录账号 + 密码**
3. **手机号 + 验证码**

### 4. 技术实现

#### 前端修改
- **文件**: `src/pages/central-admin/tenant-create/index.tsx`
  - 添加 `loginAccount` 和 `confirmPassword` 状态
  - 更新表单验证逻辑，添加账号名格式验证和密码一致性验证
  - 更新表单 UI，添加登录账号和确认密码输入框
  - 提交时将 `boss_account` 字段传递给后端

- **文件**: `src/db/types.ts`
  - 在 `CreateTenantInput` 接口中添加 `boss_account?: string` 字段

- **文件**: `src/pages/login/index.tsx`
  - 更新密码登录逻辑，支持账号名登录
  - 如果输入的不是手机号，会自动添加 `@fleet.local` 后缀转换为邮箱格式进行登录

#### 后端修改
- **文件**: `supabase/functions/create-tenant/index.ts`
  - 在 `CreateTenantInput` 接口中添加 `boss_account?: string` 字段
  - 创建用户时，如果提供了 `boss_account`，将其转换为邮箱格式（`账号名@fleet.local`）
  - 将账号名保存在 `user_metadata.account` 字段中

### 5. 使用示例

#### 创建租户
```
公司名称: 测试公司
老板姓名: 张三
老板手机号: 13800138000
登录账号: zhangsan
登录密码: 123456
确认密码: 123456
```

#### 登录方式
老板可以使用以下任一方式登录：
1. 账号名登录: `zhangsan` + `123456`
2. 手机号登录: `13800138000` + `123456`
3. 验证码登录: `13800138000` + 验证码

### 6. 验证规则

#### 登录账号
- 必填
- 4-20位字符
- 只允许字母、数字、下划线
- 正则表达式: `/^[a-zA-Z0-9_]{4,20}$/`

#### 密码
- 必填
- 至少6位
- 两次输入必须一致

#### 手机号
- 必填
- 11位数字
- 必须是有效的中国大陆手机号
- 正则表达式: `/^1[3-9]\d{9}$/`

### 7. 成功提示

创建成功后会显示：
```
租户"[公司名称]"创建成功！

登录账号：[账号名]
密码：[密码]
手机号：[手机号]

请妥善保管账号信息。
```

## 注意事项

1. **账号唯一性**: 系统会自动检查账号名是否已被使用（通过邮箱唯一性约束）
2. **密码安全**: 建议使用强密码，至少包含字母和数字
3. **账号保管**: 创建成功后请妥善保管账号信息，系统不会再次显示密码
4. **登录方式**: 老板可以选择最方便的方式登录（账号名或手机号）

## 相关文件

- `src/pages/central-admin/tenant-create/index.tsx` - 创建租户页面
- `src/db/types.ts` - 类型定义
- `src/pages/login/index.tsx` - 登录页面
- `supabase/functions/create-tenant/index.ts` - 创建租户 Edge Function
