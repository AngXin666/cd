# 车辆管理功能说明

## 功能概述

车辆管理功能模块为司机客户端提供了全面的车辆信息管理能力，支持车辆信息录入、OCR智能识别、照片上传等功能。

## 核心功能

### 1. 车辆信息管理
- **车辆列表**：展示司机名下的所有车辆
- **添加车辆**：通过4步骤流程添加新车辆
- **车辆详情**：查看完整的车辆信息和照片
- **删除车辆**：删除不再使用的车辆

### 2. OCR智能识别
- **行驶证识别**：自动识别行驶证上的关键信息
  - 车牌号、车辆类型、所有人
  - 使用性质、品牌型号
  - 车辆识别代号（VIN）
  - 注册日期、发证日期
  
- **身份证识别**：识别驾驶员身份证信息
  - 姓名、身份证号
  - 地址、出生日期
  
- **驾驶证识别**：识别驾驶证信息
  - 证号、准驾车型
  - 有效期起止日期
  - 发证机关

### 3. 车辆照片管理
- **车辆四角照**：前、后、左、右四个角度
- **轮胎特写照**：轮胎花纹和品牌
- **行驶证照片**：行驶证原件照片
- **证件照片**：身份证和驾驶证照片

### 4. 拍照方式
- **即时拍照**：调用手机摄像头进行拍摄
- **从相册选择**：从手机本地相册中选择照片

## 技术实现

### 数据库设计

#### vehicles表扩展
```sql
-- 行驶证信息
vin TEXT                      -- 车辆识别代号
owner_name TEXT               -- 所有人
use_character TEXT            -- 使用性质
register_date DATE            -- 注册日期
issue_date DATE               -- 发证日期

-- 车辆照片
front_photo TEXT              -- 前方照片
back_photo TEXT               -- 后方照片
left_photo TEXT               -- 左侧照片
right_photo TEXT              -- 右侧照片
tire_photo TEXT               -- 轮胎照片
driving_license_photo TEXT    -- 行驶证照片
```

#### driver_licenses表
```sql
CREATE TABLE driver_licenses (
  id UUID PRIMARY KEY,
  driver_id UUID REFERENCES profiles(id),
  
  -- 身份证信息
  id_card_number TEXT,
  id_card_name TEXT,
  id_card_address TEXT,
  id_card_birth_date DATE,
  id_card_photo_front TEXT,
  id_card_photo_back TEXT,
  
  -- 驾驶证信息
  license_number TEXT,
  license_class TEXT,
  valid_from DATE,
  valid_to DATE,
  issue_authority TEXT,
  driving_license_photo TEXT,
  
  status TEXT DEFAULT 'active',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### 存储配置

**Supabase Storage Bucket**
- 名称：`app-7cdqf07mbu9t_vehicles`
- 文件大小限制：1MB
- 允许的文件类型：image/jpeg, image/png, image/jpg, image/bmp
- 访问权限：认证用户可上传，所有人可查看

### 工具函数

#### 图片处理（src/utils/imageUtils.ts）
- `imageToBase64`：将图片转换为Base64格式
- `compressImage`：压缩图片至指定质量
- `uploadImageToStorage`：上传图片到Supabase Storage
- `generateUniqueFileName`：生成唯一的文件名
- `chooseImage`：选择图片（拍照或相册）
- `uploadMultipleImages`：批量上传多张图片

#### OCR识别（src/utils/ocrUtils.ts）
- `recognizeDrivingLicense`：识别行驶证
- `recognizeIdCardFront`：识别身份证正面
- `recognizeIdCardBack`：识别身份证反面
- `recognizeDriverLicense`：识别驾驶证

使用文心一言多模态API进行OCR识别，支持进度回调。

#### 数据库API（src/db/api.ts）
- `getDriverVehicles`：获取司机的所有车辆
- `getVehicleById`：根据ID获取车辆信息
- `insertVehicle`：添加新车辆
- `updateVehicle`：更新车辆信息
- `deleteVehicle`：删除车辆
- `getDriverLicense`：获取驾驶员证件信息
- `upsertDriverLicense`：添加或更新驾驶员证件
- `updateDriverLicense`：更新驾驶员证件信息

### UI组件

#### PhotoCapture（拍照组件）
- 支持即时拍照和从相册选择
- 图片预览功能
- 拍照提示文案
- 重新拍摄功能

#### StepIndicator（步骤指示器）
- 显示当前步骤
- 步骤进度可视化
- 步骤标题和描述

### 页面路由

| 页面 | 路径 | 说明 |
|------|------|------|
| 车辆列表 | `/pages/driver/vehicle-list/index` | 显示司机名下所有车辆 |
| 添加车辆 | `/pages/driver/add-vehicle/index` | 4步骤添加车辆流程 |
| 车辆详情 | `/pages/driver/vehicle-detail/index` | 查看完整车辆信息 |

## 使用流程

### 添加车辆流程

#### 步骤1：基本信息录入
1. 填写车牌号（必填）
2. 填写品牌（必填）
3. 填写型号（必填）
4. 填写颜色（选填）

#### 步骤2：行驶证识别
1. 拍摄或选择行驶证照片
2. 点击"识别行驶证"按钮
3. 系统自动识别并填充信息
4. 可手动修改识别结果

#### 步骤3：车辆照片拍摄
1. 拍摄车辆前方照片
2. 拍摄车辆后方照片
3. 拍摄车辆左侧照片
4. 拍摄车辆右侧照片
5. 拍摄轮胎特写照片

#### 步骤4：驾驶员证件识别
1. 拍摄身份证正面
2. 点击"识别身份证"按钮
3. 拍摄身份证反面
4. 拍摄驾驶证
5. 点击"识别驾驶证"按钮
6. 可手动修改识别结果

#### 提交
点击"完成"按钮，系统将：
1. 压缩所有照片
2. 上传照片到Supabase Storage
3. 保存车辆信息到数据库
4. 保存驾驶员证件信息到数据库
5. 返回车辆列表页面

## 注意事项

### 图片要求
- **文件大小**：单张图片不超过1MB（系统自动压缩）
- **文件格式**：支持JPEG、PNG、GIF、WEBP、BMP
- **文件名**：只能包含英文字母和数字
- **拍摄要求**：
  - 证件完整清晰
  - 避免反光和阴影
  - 保持水平拍摄
  - 光线充足

### OCR识别
- **识别准确性**：受照片质量影响，建议在光线充足的环境下拍摄
- **识别失败**：如果识别失败，可以手动填写信息
- **识别结果**：所有识别结果都可以手动修改

### 数据安全
- **RLS策略**：司机只能查看和管理自己的车辆和证件
- **数据加密**：所有数据传输使用HTTPS加密
- **照片存储**：照片存储在Supabase Storage，支持公开访问

### 性能优化
- **图片压缩**：上传前自动压缩图片，减少上传时间
- **批量上传**：支持批量上传多张照片
- **缓存机制**：车辆列表数据支持缓存，减少网络请求

## 错误处理

### 常见错误及解决方案

| 错误 | 原因 | 解决方案 |
|------|------|----------|
| 上传失败 | 网络问题或文件过大 | 检查网络连接，确保图片小于1MB |
| 识别失败 | 照片质量差或API错误 | 重新拍摄清晰照片，或手动填写信息 |
| 保存失败 | 数据库错误或权限问题 | 检查必填项是否填写完整 |
| 加载失败 | 网络问题或数据不存在 | 刷新页面重试 |

## 未来优化方向

1. **批量管理**：支持批量删除、批量导出车辆信息
2. **车辆状态**：增加车辆维修、保养等状态管理
3. **提醒功能**：车辆年检、保险到期提醒
4. **数据统计**：车辆使用情况统计分析
5. **离线支持**：支持离线拍照，联网后自动上传
6. **图片编辑**：支持裁剪、旋转等基本编辑功能

## 技术支持

如有问题，请联系技术支持团队。
