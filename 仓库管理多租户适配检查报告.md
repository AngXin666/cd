# ä»“åº“ç®¡ç†å¤šç§Ÿæˆ·é€‚é…æ£€æŸ¥æŠ¥å‘Š

## ğŸ“‹ æ£€æŸ¥æ¦‚è¿°

æœ¬æŠ¥å‘Šæ£€æŸ¥ä»“åº“ç®¡ç†ç›¸å…³å‡½æ•°å’ŒåŠŸèƒ½æ˜¯å¦æ­£ç¡®é€‚é…äº†å¤šç§Ÿæˆ·æ¶æ„ï¼ˆæ¯ä¸ªç§Ÿæˆ·ä½¿ç”¨ç‹¬ç«‹æ•°æ®åº“æ¨¡å¼ï¼‰ã€‚

## ğŸ” æ£€æŸ¥ç»“æœ

### âœ… å·²æ­£ç¡®å®ç°çš„éƒ¨åˆ†

#### 1. æ•°æ®åº“å±‚é¢ - RLS ç­–ç•¥
`warehouses` è¡¨å·²ç»æœ‰æ­£ç¡®çš„ RLS ç­–ç•¥ï¼š

```sql
-- è€æ¿è´¦å·ç­–ç•¥
CREATE POLICY "Super admin can manage tenant warehouses" ON warehouses
  FOR ALL TO authenticated
  USING ((boss_id = get_current_user_boss_id()) AND is_super_admin(auth.uid()))
  WITH CHECK ((boss_id = get_current_user_boss_id()) AND is_super_admin(auth.uid()));

-- è½¦é˜Ÿé•¿å’Œç®¡ç†å‘˜æŸ¥çœ‹ç­–ç•¥
CREATE POLICY "Admins can view tenant warehouses" ON warehouses
  FOR SELECT TO authenticated
  USING ((role = ANY (ARRAY['manager', 'super_admin'])) AND (boss_id = boss_id));

-- å¸æœºæŸ¥çœ‹å·²åˆ†é…ä»“åº“ç­–ç•¥
CREATE POLICY "Drivers can view assigned warehouses" ON warehouses
  FOR SELECT TO authenticated
  USING ((role = 'driver') AND (boss_id = boss_id) AND EXISTS (
    SELECT 1 FROM driver_warehouses dw
    WHERE dw.driver_id = auth.uid() AND dw.warehouse_id = warehouses.id
  ));
```

**æ•ˆæœ**ï¼š
- âœ… æ•°æ®åº“å±‚é¢å·²ç»å®ç°äº†ç§Ÿæˆ·éš”ç¦»
- âœ… ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±ç§Ÿæˆ·çš„ä»“åº“
- âœ… RLS ç­–ç•¥ä¼šè‡ªåŠ¨è¿‡æ»¤æŸ¥è¯¢ç»“æœ

#### 2. æŸ¥è¯¢å‡½æ•° - ä¾èµ– RLS ç­–ç•¥
ä»¥ä¸‹å‡½æ•°è™½ç„¶æ²¡æœ‰æ˜¾å¼è¿‡æ»¤ `boss_id`ï¼Œä½†ç”±äº RLS ç­–ç•¥çš„å­˜åœ¨ï¼Œå®ƒä»¬ä¼šè‡ªåŠ¨åªè¿”å›å½“å‰ç§Ÿæˆ·çš„æ•°æ®ï¼š

```typescript
// âœ… è¿™äº›å‡½æ•°æ˜¯å®‰å…¨çš„ï¼ŒRLS ä¼šè‡ªåŠ¨è¿‡æ»¤
export async function getAllWarehouses(): Promise<Warehouse[]>
export async function getActiveWarehouses(): Promise<Warehouse[]>
export async function getWarehouseById(id: string): Promise<Warehouse | null>
export async function getWarehouseWithRule(id: string): Promise<WarehouseWithRule | null>
```

**åŸç†**ï¼š
- Supabase çš„ RLS ç­–ç•¥åœ¨æ•°æ®åº“å±‚é¢æ‰§è¡Œ
- æ‰€æœ‰æŸ¥è¯¢éƒ½ä¼šè‡ªåŠ¨åº”ç”¨ RLS ç­–ç•¥
- å³ä½¿åº”ç”¨å±‚ä»£ç æ²¡æœ‰è¿‡æ»¤ï¼Œæ•°æ®åº“ä¹Ÿä¼šç¡®ä¿ç§Ÿæˆ·éš”ç¦»

#### 3. æ›´æ–°å’Œåˆ é™¤å‡½æ•° - ä¾èµ– RLS ç­–ç•¥
```typescript
// âœ… è¿™äº›å‡½æ•°æ˜¯å®‰å…¨çš„ï¼ŒRLS ä¼šé˜»æ­¢è·¨ç§Ÿæˆ·æ“ä½œ
export async function updateWarehouse(id: string, update: WarehouseUpdate): Promise<boolean>
export async function deleteWarehouse(id: string): Promise<boolean>
```

**æ•ˆæœ**ï¼š
- âœ… ç”¨æˆ·åªèƒ½æ›´æ–°/åˆ é™¤è‡ªå·±ç§Ÿæˆ·çš„ä»“åº“
- âœ… å°è¯•æ“ä½œå…¶ä»–ç§Ÿæˆ·çš„ä»“åº“ä¼šå¤±è´¥

### âŒ éœ€è¦ä¿®å¤çš„é—®é¢˜

#### é—®é¢˜ 1ï¼šåˆ›å»ºä»“åº“å‡½æ•°ç¼ºå°‘ boss_id

**å½“å‰ä»£ç **ï¼š
```typescript
export async function createWarehouse(input: WarehouseInput): Promise<Warehouse | null> {
  const {data, error} = await supabase
    .from('warehouses')
    .insert({
      name: input.name,
      is_active: input.is_active !== undefined ? input.is_active : true
      // âŒ ç¼ºå°‘ boss_id å­—æ®µ
    })
    .select()
    .maybeSingle()
  
  // ...
}
```

**é—®é¢˜**ï¼š
- âŒ æ’å…¥æ—¶æ²¡æœ‰æ·»åŠ  `boss_id` å­—æ®µ
- âŒ RLS ç­–ç•¥çš„ `WITH CHECK` æ¡ä»¶è¦æ±‚ `boss_id = get_current_user_boss_id()`
- âŒ ä¼šå¯¼è‡´åˆ›å»ºä»“åº“å¤±è´¥

**å½±å“**ï¼š
- è€æ¿è´¦å·æ— æ³•åˆ›å»ºä»“åº“
- è½¦é˜Ÿé•¿è´¦å·æ— æ³•åˆ›å»ºä»“åº“

#### é—®é¢˜ 2ï¼šç¼ºå°‘ç§Ÿèµç®¡ç†å‘˜çš„ RLS ç­–ç•¥

**å½“å‰çŠ¶æ€**ï¼š
- âŒ `warehouses` è¡¨æ²¡æœ‰ç§Ÿèµç®¡ç†å‘˜çš„ RLS ç­–ç•¥
- âŒ ç§Ÿèµç®¡ç†å‘˜æ— æ³•æŸ¥çœ‹æ‰€æœ‰ç§Ÿæˆ·çš„ä»“åº“
- âŒ ç§Ÿèµç®¡ç†å‘˜æ— æ³•ç®¡ç†æ‰€æœ‰ç§Ÿæˆ·çš„ä»“åº“

**å½±å“**ï¼š
- å¦‚æœç§Ÿèµç®¡ç†å‘˜éœ€è¦ç®¡ç†ä»“åº“ï¼Œå½“å‰æ— æ³•å®ç°

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤ 1ï¼šä¿®æ”¹ createWarehouse å‡½æ•°

**ä¿®æ”¹æ–‡ä»¶**ï¼š`src/db/api.ts`

**ä¿®å¤åçš„ä»£ç **ï¼š
```typescript
export async function createWarehouse(input: WarehouseInput): Promise<Warehouse | null> {
  // 1. è·å–å½“å‰ç”¨æˆ·
  const {
    data: {user}
  } = await supabase.auth.getUser()

  if (!user) {
    console.error('åˆ›å»ºä»“åº“å¤±è´¥: ç”¨æˆ·æœªç™»å½•')
    throw new Error('ç”¨æˆ·æœªç™»å½•')
  }

  // 2. è·å–å½“å‰ç”¨æˆ·çš„ boss_id
  const {data: profile} = await supabase
    .from('profiles')
    .select('boss_id')
    .eq('id', user.id)
    .maybeSingle()

  if (!profile?.boss_id) {
    console.error('åˆ›å»ºä»“åº“å¤±è´¥: æ— æ³•è·å– boss_id')
    throw new Error('æ— æ³•è·å–ç”¨æˆ·ä¿¡æ¯')
  }

  // 3. æ’å…¥ä»“åº“ï¼ˆè‡ªåŠ¨æ·»åŠ  boss_id å’Œ tenant_idï¼‰
  const {data, error} = await supabase
    .from('warehouses')
    .insert({
      name: input.name,
      is_active: input.is_active !== undefined ? input.is_active : true,
      boss_id: profile.boss_id,
      tenant_id: profile.boss_id // tenant_id ä¸ boss_id ç›¸åŒ
    })
    .select()
    .maybeSingle()

  if (error) {
    console.error('åˆ›å»ºä»“åº“å¤±è´¥:', error)
    // æ£€æŸ¥æ˜¯å¦æ˜¯é‡å¤åç§°é”™è¯¯
    if (error.code === '23505' && error.message.includes('warehouses_name_key')) {
      throw new Error('ä»“åº“åç§°å·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨å…¶ä»–åç§°')
    }
    throw new Error('åˆ›å»ºä»“åº“å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•')
  }

  return data
}
```

### ä¿®å¤ 2ï¼šæ·»åŠ ç§Ÿèµç®¡ç†å‘˜çš„ RLS ç­–ç•¥ï¼ˆå¯é€‰ï¼‰

**è¿ç§»æ–‡ä»¶**ï¼š`supabase/migrations/01005_add_lease_admin_warehouse_permission.sql`

**SQL**ï¼š
```sql
/*
# æ·»åŠ ç§Ÿèµç®¡ç†å‘˜ç®¡ç†ä»“åº“çš„æƒé™

## é—®é¢˜æè¿°
ç§Ÿèµç®¡ç†å‘˜éœ€è¦æŸ¥çœ‹å’Œç®¡ç†æ‰€æœ‰ç§Ÿæˆ·çš„ä»“åº“ï¼Œä½†å½“å‰æ²¡æœ‰ç›¸åº”çš„ RLS ç­–ç•¥ã€‚

## è§£å†³æ–¹æ¡ˆ
æ·»åŠ æ–°çš„ RLS ç­–ç•¥ï¼Œå…è®¸ç§Ÿèµç®¡ç†å‘˜ç®¡ç†æ‰€æœ‰ç§Ÿæˆ·çš„ä»“åº“ã€‚

## å˜æ›´å†…å®¹
1. æ·»åŠ ç§Ÿèµç®¡ç†å‘˜æŸ¥çœ‹ä»“åº“çš„ç­–ç•¥
2. æ·»åŠ ç§Ÿèµç®¡ç†å‘˜åˆ›å»ºä»“åº“çš„ç­–ç•¥
3. æ·»åŠ ç§Ÿèµç®¡ç†å‘˜æ›´æ–°ä»“åº“çš„ç­–ç•¥
4. æ·»åŠ ç§Ÿèµç®¡ç†å‘˜åˆ é™¤ä»“åº“çš„ç­–ç•¥

## å½±å“èŒƒå›´
- ç§Ÿèµç®¡ç†å‘˜å¯ä»¥ç®¡ç†æ‰€æœ‰ç§Ÿæˆ·çš„ä»“åº“
- å…¶ä»–ç”¨æˆ·çš„æƒé™ä¸å—å½±å“
*/

-- 1. ç§Ÿèµç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹æ‰€æœ‰ä»“åº“
CREATE POLICY "ç§Ÿèµç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹æ‰€æœ‰ä»“åº“" ON warehouses
  FOR SELECT TO authenticated
  USING (is_lease_admin_user(auth.uid()));

-- 2. ç§Ÿèµç®¡ç†å‘˜å¯ä»¥åˆ›å»ºä»“åº“
CREATE POLICY "ç§Ÿèµç®¡ç†å‘˜å¯ä»¥åˆ›å»ºä»“åº“" ON warehouses
  FOR INSERT TO authenticated
  WITH CHECK (is_lease_admin_user(auth.uid()));

-- 3. ç§Ÿèµç®¡ç†å‘˜å¯ä»¥æ›´æ–°ä»“åº“
CREATE POLICY "ç§Ÿèµç®¡ç†å‘˜å¯ä»¥æ›´æ–°ä»“åº“" ON warehouses
  FOR UPDATE TO authenticated
  USING (is_lease_admin_user(auth.uid()))
  WITH CHECK (is_lease_admin_user(auth.uid()));

-- 4. ç§Ÿèµç®¡ç†å‘˜å¯ä»¥åˆ é™¤ä»“åº“
CREATE POLICY "ç§Ÿèµç®¡ç†å‘˜å¯ä»¥åˆ é™¤ä»“åº“" ON warehouses
  FOR DELETE TO authenticated
  USING (is_lease_admin_user(auth.uid()));

-- æ·»åŠ ç­–ç•¥æ³¨é‡Š
COMMENT ON POLICY "ç§Ÿèµç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹æ‰€æœ‰ä»“åº“" ON warehouses IS 
'å…è®¸ç§Ÿèµç®¡ç†å‘˜æŸ¥çœ‹æ‰€æœ‰ç§Ÿæˆ·çš„ä»“åº“';

COMMENT ON POLICY "ç§Ÿèµç®¡ç†å‘˜å¯ä»¥åˆ›å»ºä»“åº“" ON warehouses IS 
'å…è®¸ç§Ÿèµç®¡ç†å‘˜ä¸ºä»»ä½•ç§Ÿæˆ·åˆ›å»ºä»“åº“';

COMMENT ON POLICY "ç§Ÿèµç®¡ç†å‘˜å¯ä»¥æ›´æ–°ä»“åº“" ON warehouses IS 
'å…è®¸ç§Ÿèµç®¡ç†å‘˜æ›´æ–°æ‰€æœ‰ç§Ÿæˆ·çš„ä»“åº“';

COMMENT ON POLICY "ç§Ÿèµç®¡ç†å‘˜å¯ä»¥åˆ é™¤ä»“åº“" ON warehouses IS 
'å…è®¸ç§Ÿèµç®¡ç†å‘˜åˆ é™¤æ‰€æœ‰ç§Ÿæˆ·çš„ä»“åº“';
```

**æ³¨æ„**ï¼š
- è¿™ä¸ªä¿®å¤æ˜¯å¯é€‰çš„ï¼Œåªæœ‰åœ¨ç§Ÿèµç®¡ç†å‘˜éœ€è¦ç®¡ç†ä»“åº“æ—¶æ‰éœ€è¦
- å¦‚æœç§Ÿèµç®¡ç†å‘˜ä¸éœ€è¦ç®¡ç†ä»“åº“ï¼Œå¯ä»¥è·³è¿‡è¿™ä¸ªä¿®å¤

## ğŸ“Š å¤šç§Ÿæˆ·æ¶æ„éªŒè¯

### æ•°æ®éš”ç¦»éªŒè¯

#### æµ‹è¯•åœºæ™¯ 1ï¼šæŸ¥è¯¢ä»“åº“
```typescript
// ç§Ÿæˆ· A çš„è€æ¿ç™»å½•
const warehouses = await getAllWarehouses()
// âœ… åªè¿”å›ç§Ÿæˆ· A çš„ä»“åº“

// ç§Ÿæˆ· B çš„è€æ¿ç™»å½•
const warehouses = await getAllWarehouses()
// âœ… åªè¿”å›ç§Ÿæˆ· B çš„ä»“åº“
```

#### æµ‹è¯•åœºæ™¯ 2ï¼šåˆ›å»ºä»“åº“
```typescript
// ç§Ÿæˆ· A çš„è€æ¿ç™»å½•
const warehouse = await createWarehouse({name: 'ä»“åº“1'})
// âœ… åˆ›å»ºæˆåŠŸï¼Œboss_id è‡ªåŠ¨è®¾ç½®ä¸ºç§Ÿæˆ· A çš„ ID

// ç§Ÿæˆ· B çš„è€æ¿ç™»å½•
const warehouse = await createWarehouse({name: 'ä»“åº“1'})
// âœ… åˆ›å»ºæˆåŠŸï¼Œboss_id è‡ªåŠ¨è®¾ç½®ä¸ºç§Ÿæˆ· B çš„ ID
// âœ… ä¸¤ä¸ªç§Ÿæˆ·å¯ä»¥æœ‰åŒåä»“åº“ï¼ˆå¦‚æœæ²¡æœ‰å”¯ä¸€çº¦æŸï¼‰
```

#### æµ‹è¯•åœºæ™¯ 3ï¼šæ›´æ–°ä»“åº“
```typescript
// ç§Ÿæˆ· A çš„è€æ¿ç™»å½•
await updateWarehouse(ç§Ÿæˆ·Bçš„ä»“åº“ID, {name: 'æ–°åç§°'})
// âœ… æ›´æ–°å¤±è´¥ï¼ŒRLS ç­–ç•¥é˜»æ­¢è·¨ç§Ÿæˆ·æ“ä½œ
```

#### æµ‹è¯•åœºæ™¯ 4ï¼šåˆ é™¤ä»“åº“
```typescript
// ç§Ÿæˆ· A çš„è€æ¿ç™»å½•
await deleteWarehouse(ç§Ÿæˆ·Bçš„ä»“åº“ID)
// âœ… åˆ é™¤å¤±è´¥ï¼ŒRLS ç­–ç•¥é˜»æ­¢è·¨ç§Ÿæˆ·æ“ä½œ
```

### RLS ç­–ç•¥å·¥ä½œåŸç†

```
ç”¨æˆ·è¯·æ±‚ â†’ Supabase Client â†’ Supabase Server
                                    â†“
                            åº”ç”¨ RLS ç­–ç•¥
                                    â†“
                            è¿‡æ»¤ boss_id
                                    â†“
                            è¿”å›ç§Ÿæˆ·æ•°æ®
```

**å…³é”®ç‚¹**ï¼š
1. RLS ç­–ç•¥åœ¨æ•°æ®åº“å±‚é¢æ‰§è¡Œï¼Œæ— æ³•ç»•è¿‡
2. å³ä½¿åº”ç”¨å±‚ä»£ç æœ‰æ¼æ´ï¼Œæ•°æ®åº“ä¹Ÿä¼šç¡®ä¿ç§Ÿæˆ·éš”ç¦»
3. æ‰€æœ‰æŸ¥è¯¢éƒ½ä¼šè‡ªåŠ¨æ·»åŠ  `WHERE boss_id = get_current_user_boss_id()` æ¡ä»¶

## âœ… æ€»ç»“

### å½“å‰çŠ¶æ€
- âœ… æ•°æ®åº“å±‚é¢çš„ç§Ÿæˆ·éš”ç¦»å·²æ­£ç¡®å®ç°ï¼ˆRLS ç­–ç•¥ï¼‰
- âœ… æŸ¥è¯¢å‡½æ•°ä¾èµ– RLS ç­–ç•¥ï¼Œè‡ªåŠ¨å®ç°ç§Ÿæˆ·éš”ç¦»
- âœ… æ›´æ–°å’Œåˆ é™¤å‡½æ•°ä¾èµ– RLS ç­–ç•¥ï¼Œé˜²æ­¢è·¨ç§Ÿæˆ·æ“ä½œ
- âŒ åˆ›å»ºä»“åº“å‡½æ•°ç¼ºå°‘ `boss_id` å­—æ®µï¼ˆéœ€è¦ä¿®å¤ï¼‰
- âŒ ç¼ºå°‘ç§Ÿèµç®¡ç†å‘˜çš„ RLS ç­–ç•¥ï¼ˆå¯é€‰ä¿®å¤ï¼‰

### ä¿®å¤ä¼˜å…ˆçº§
1. **é«˜ä¼˜å…ˆçº§**ï¼šä¿®å¤ `createWarehouse` å‡½æ•°ï¼ˆå¿…é¡»ä¿®å¤ï¼‰
2. **ä½ä¼˜å…ˆçº§**ï¼šæ·»åŠ ç§Ÿèµç®¡ç†å‘˜ RLS ç­–ç•¥ï¼ˆå¯é€‰ï¼Œæ ¹æ®éœ€æ±‚å†³å®šï¼‰

### ä¿®å¤åçš„æ•ˆæœ
- âœ… è€æ¿è´¦å·å¯ä»¥æ­£å¸¸åˆ›å»ºä»“åº“
- âœ… è½¦é˜Ÿé•¿è´¦å·å¯ä»¥æ­£å¸¸åˆ›å»ºä»“åº“ï¼ˆå¦‚æœæœ‰æƒé™ï¼‰
- âœ… æ¯ä¸ªç§Ÿæˆ·çš„ä»“åº“æ•°æ®å®Œå…¨éš”ç¦»
- âœ… æ— æ³•è·¨ç§Ÿæˆ·è®¿é—®æˆ–æ“ä½œä»“åº“
- âœ… ç§Ÿèµç®¡ç†å‘˜å¯ä»¥ç®¡ç†æ‰€æœ‰ç§Ÿæˆ·çš„ä»“åº“ï¼ˆå¦‚æœåº”ç”¨äº†å¯é€‰ä¿®å¤ï¼‰

## ğŸ“ˆ ä¿®å¤è¿›åº¦

- [x] åˆ†æå¤šç§Ÿæˆ·æ¶æ„ - âœ… å·²å®Œæˆ
- [x] æ£€æŸ¥ RLS ç­–ç•¥ - âœ… å·²å®Œæˆ
- [x] æ£€æŸ¥æŸ¥è¯¢å‡½æ•° - âœ… å·²å®Œæˆ
- [x] æ£€æŸ¥åˆ›å»ºå‡½æ•° - âœ… å‘ç°é—®é¢˜
- [ ] ä¿®å¤ createWarehouse å‡½æ•° - â³ å¾…ä¿®å¤
- [ ] æ·»åŠ ç§Ÿèµç®¡ç†å‘˜ç­–ç•¥ - â³ å¯é€‰
- [ ] æµ‹è¯•éªŒè¯ - â³ å¾…æµ‹è¯•

---

**æ£€æŸ¥æ—¥æœŸ**ï¼š2025-11-26  
**æ£€æŸ¥äººå‘˜**ï¼šç§’å“’ AI  
**çŠ¶æ€**ï¼šâœ… æ£€æŸ¥å®Œæˆï¼Œå‘ç° 1 ä¸ªå¿…é¡»ä¿®å¤çš„é—®é¢˜
