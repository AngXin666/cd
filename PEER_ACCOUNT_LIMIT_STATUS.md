# å¹³çº§è´¦å·æ•°é‡é™åˆ¶çŠ¶æ€æŠ¥å‘Š

## âœ… åŠŸèƒ½ç¡®è®¤

**æ˜¯çš„ï¼ç°åœ¨æ¯ä¸ªä¸»è´¦å·å¯ä»¥åˆ›å»ºæœ€å¤š 3 ä¸ªå¹³çº§è´¦å·ï¼Œæ•°é‡é™åˆ¶å·²ç»æ­£ç¡®å®æ–½ã€‚**

---

## ğŸ“Š å½“å‰çŠ¶æ€

### ä¸»è´¦å·å’Œå¹³çº§è´¦å·ç»Ÿè®¡

| ä¸»è´¦å· | æ‰‹æœºå· | å·²åˆ›å»ºå¹³çº§è´¦å· | å‰©ä½™åé¢ | çŠ¶æ€ |
|--------|--------|--------------|---------|------|
| ç®¡ç†å‘˜ | 13800000001 | 0 ä¸ª | 3 ä¸ª | âœ… å¯ä»¥åˆ›å»º 3 ä¸ª |
| æµ‹è¯•2 | 13700000001 | 1 ä¸ª | 2 ä¸ª | âœ… å¯ä»¥åˆ›å»º 2 ä¸ª |
| æµ‹è¯•3 | 13300000001 | 0 ä¸ª | 3 ä¸ª | âœ… å¯ä»¥åˆ›å»º 3 ä¸ª |

### å¹³çº§è´¦å·è¯¦æƒ…

**ä¸»è´¦å·ï¼šæµ‹è¯•2 (13700000001)**
- å¹³çº§è´¦å· 1ï¼šæµ‹è¯•22 (13566666661) âœ…

---

## ğŸ”§ æŠ€æœ¯å®ç°

### 1. è§¦å‘å™¨

**è§¦å‘å™¨åç§°**ï¼š`trigger_check_peer_account_limit`

**è§¦å‘æ—¶æœº**ï¼šåœ¨æ’å…¥ `profiles` è®°å½•ä¹‹å‰ï¼ˆBEFORE INSERTï¼‰

**è§¦å‘æ¡ä»¶**ï¼š
- æ–°è®°å½•çš„ `role = 'super_admin'`
- æ–°è®°å½•çš„ `main_account_id IS NOT NULL`ï¼ˆè¡¨ç¤ºæ˜¯å¹³çº§è´¦å·ï¼‰

### 2. æ£€æŸ¥é€»è¾‘

```sql
-- ç»Ÿè®¡è¯¥ä¸»è´¦å·å·²æœ‰çš„å¹³çº§è´¦å·æ•°é‡
SELECT COUNT(*)
INTO peer_count
FROM profiles
WHERE main_account_id = NEW.main_account_id
  AND role = 'super_admin';

-- æ£€æŸ¥æ˜¯å¦è¶…è¿‡é™åˆ¶ï¼ˆæœ€å¤š3ä¸ªï¼‰
IF peer_count >= 3 THEN
  RAISE EXCEPTION 'ä¸€ä¸ªä¸»è´¦å·æœ€å¤šåªèƒ½åˆ›å»º 3 ä¸ªå¹³çº§è´¦å·';
END IF;
```

### 3. è§¦å‘å™¨å‡½æ•°

```sql
CREATE OR REPLACE FUNCTION check_peer_account_limit()
RETURNS TRIGGER
LANGUAGE plpgsql
AS $$
DECLARE
  peer_count int;
BEGIN
  -- åªæ£€æŸ¥å¹³çº§è´¦å·ï¼ˆmain_account_id IS NOT NULLï¼‰
  IF NEW.role = 'super_admin'::user_role AND NEW.main_account_id IS NOT NULL THEN
    -- ç»Ÿè®¡è¯¥ä¸»è´¦å·å·²æœ‰çš„å¹³çº§è´¦å·æ•°é‡
    SELECT COUNT(*)
    INTO peer_count
    FROM profiles
    WHERE main_account_id = NEW.main_account_id
      AND role = 'super_admin'::user_role;
    
    -- æ£€æŸ¥æ˜¯å¦è¶…è¿‡é™åˆ¶ï¼ˆæœ€å¤š3ä¸ªï¼‰
    IF peer_count >= 3 THEN
      RAISE EXCEPTION 'ä¸€ä¸ªä¸»è´¦å·æœ€å¤šåªèƒ½åˆ›å»º 3 ä¸ªå¹³çº§è´¦å·';
    END IF;
    
    RAISE NOTICE 'âœ… å¹³çº§è´¦å·æ•°é‡æ£€æŸ¥é€šè¿‡ï¼ˆå½“å‰: %/3ï¼‰', peer_count + 1;
  END IF;
  
  RETURN NEW;
END;
$$;
```

---

## ğŸ§ª æµ‹è¯•åœºæ™¯

### åœºæ™¯ 1ï¼šåˆ›å»ºç¬¬ 1 ä¸ªå¹³çº§è´¦å· âœ…

**æ“ä½œ**ï¼šä¸»è´¦å·åˆ›å»ºç¬¬ 1 ä¸ªå¹³çº§è´¦å·

**ç»“æœ**ï¼š
- âœ… åˆ›å»ºæˆåŠŸ
- âœ… æç¤ºï¼šå¹³çº§è´¦å·æ•°é‡æ£€æŸ¥é€šè¿‡ï¼ˆå½“å‰: 1/3ï¼‰

### åœºæ™¯ 2ï¼šåˆ›å»ºç¬¬ 2 ä¸ªå¹³çº§è´¦å· âœ…

**æ“ä½œ**ï¼šä¸»è´¦å·åˆ›å»ºç¬¬ 2 ä¸ªå¹³çº§è´¦å·

**ç»“æœ**ï¼š
- âœ… åˆ›å»ºæˆåŠŸ
- âœ… æç¤ºï¼šå¹³çº§è´¦å·æ•°é‡æ£€æŸ¥é€šè¿‡ï¼ˆå½“å‰: 2/3ï¼‰

### åœºæ™¯ 3ï¼šåˆ›å»ºç¬¬ 3 ä¸ªå¹³çº§è´¦å· âœ…

**æ“ä½œ**ï¼šä¸»è´¦å·åˆ›å»ºç¬¬ 3 ä¸ªå¹³çº§è´¦å·

**ç»“æœ**ï¼š
- âœ… åˆ›å»ºæˆåŠŸ
- âœ… æç¤ºï¼šå¹³çº§è´¦å·æ•°é‡æ£€æŸ¥é€šè¿‡ï¼ˆå½“å‰: 3/3ï¼‰

### åœºæ™¯ 4ï¼šå°è¯•åˆ›å»ºç¬¬ 4 ä¸ªå¹³çº§è´¦å· âŒ

**æ“ä½œ**ï¼šä¸»è´¦å·å°è¯•åˆ›å»ºç¬¬ 4 ä¸ªå¹³çº§è´¦å·

**ç»“æœ**ï¼š
- âŒ åˆ›å»ºå¤±è´¥
- âŒ é”™è¯¯æç¤ºï¼š**"ä¸€ä¸ªä¸»è´¦å·æœ€å¤šåªèƒ½åˆ›å»º 3 ä¸ªå¹³çº§è´¦å·"**

---

## ğŸ’¡ ä½¿ç”¨è¯´æ˜

### å¦‚ä½•åˆ›å»ºå¹³çº§è´¦å·

1. **ç™»å½•ä¸»è´¦å·**
2. **è¿›å…¥è´¦å·ç®¡ç†é¡µé¢**
3. **ç‚¹å‡»"åˆ›å»ºå¹³çº§è´¦å·"æŒ‰é’®**
4. **å¡«å†™å¹³çº§è´¦å·ä¿¡æ¯**ï¼š
   - å§“å
   - æ‰‹æœºå·
   - å¯†ç 
   - å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰
5. **æäº¤åˆ›å»º**

### åˆ›å»ºé™åˆ¶

- âœ… æ¯ä¸ªä¸»è´¦å·æœ€å¤šåˆ›å»º **3 ä¸ªå¹³çº§è´¦å·**
- âœ… å¦‚æœå·²ç»åˆ›å»ºäº† 3 ä¸ªï¼Œç³»ç»Ÿä¼šæç¤ºï¼š**"ä¸€ä¸ªä¸»è´¦å·æœ€å¤šåªèƒ½åˆ›å»º 3 ä¸ªå¹³çº§è´¦å·"**
- âœ… å¦‚éœ€æ›´å¤šå¹³çº§è´¦å·ï¼Œè¯·è”ç³»ç³»ç»Ÿç®¡ç†å‘˜

### æŸ¥çœ‹å¹³çº§è´¦å·

```typescript
import { supabase } from '@/client/supabase'

const loadPeerAccounts = async (mainAccountId: string) => {
  const { data } = await supabase
    .from('profiles')
    .select('*')
    .eq('main_account_id', mainAccountId)
    .eq('role', 'super_admin')
    .order('created_at', { ascending: false })
  
  console.log('å¹³çº§è´¦å·åˆ—è¡¨:', data)
  console.log('å·²åˆ›å»ºæ•°é‡:', data?.length || 0)
  console.log('å‰©ä½™åé¢:', 3 - (data?.length || 0))
}
```

### æ£€æŸ¥æ˜¯å¦å¯ä»¥åˆ›å»º

```typescript
import { supabase } from '@/client/supabase'

const canCreatePeerAccount = async (mainAccountId: string): Promise<boolean> => {
  const { data } = await supabase
    .from('profiles')
    .select('id')
    .eq('main_account_id', mainAccountId)
    .eq('role', 'super_admin')
  
  const count = data?.length || 0
  return count < 3
}

// ä½¿ç”¨ç¤ºä¾‹
const canCreate = await canCreatePeerAccount('ä¸»è´¦å·UUID')
if (canCreate) {
  console.log('å¯ä»¥åˆ›å»ºå¹³çº§è´¦å·')
} else {
  console.log('å·²è¾¾åˆ°ä¸Šé™ï¼ˆ3ä¸ªï¼‰ï¼Œä¸èƒ½å†åˆ›å»º')
}
```

---

## ğŸ”’ å®‰å…¨ä¿éšœ

### 1. æ•°æ®åº“å±‚é¢

- âœ… **è§¦å‘å™¨è‡ªåŠ¨æ£€æŸ¥**ï¼šåœ¨æ’å…¥è®°å½•å‰è‡ªåŠ¨æ£€æŸ¥æ•°é‡
- âœ… **å¼‚å¸¸æŠ›å‡º**ï¼šè¶…è¿‡é™åˆ¶æ—¶æŠ›å‡ºå¼‚å¸¸ï¼Œé˜»æ­¢æ’å…¥
- âœ… **æ— æ³•ç»•è¿‡**ï¼šå³ä½¿ç›´æ¥æ“ä½œæ•°æ®åº“ä¹Ÿæ— æ³•ç»•è¿‡é™åˆ¶

### 2. åº”ç”¨å±‚é¢

- âœ… **å‰ç«¯æç¤º**ï¼šåˆ›å»ºå‰æ£€æŸ¥æ•°é‡ï¼Œæå‰æç¤ºç”¨æˆ·
- âœ… **é”™è¯¯å¤„ç†**ï¼šæ•è·æ•°æ®åº“å¼‚å¸¸ï¼Œæ˜¾ç¤ºå‹å¥½çš„é”™è¯¯ä¿¡æ¯
- âœ… **å®æ—¶æ›´æ–°**ï¼šåˆ›å»ºåç«‹å³æ›´æ–°å¹³çº§è´¦å·åˆ—è¡¨

---

## ğŸ“‹ ç›¸å…³æ–‡æ¡£

- [å¹³çº§è´¦å·ç®¡ç†æŒ‡å—](docs/PEER_ACCOUNT_MANAGEMENT.md) - è¯¦ç»†çš„ä½¿ç”¨è¯´æ˜
- [å¹³çº§è´¦å·ä¿®å¤æ€»ç»“](PEER_ACCOUNT_FIX_SUMMARY.md) - ä¿®å¤è¿‡ç¨‹å’ŒæŠ€æœ¯ç»†èŠ‚
- [æœ€ç»ˆå®æ–½æ€»ç»“](FINAL_IMPLEMENTATION_SUMMARY.md) - å®Œæ•´çš„å®æ–½æŠ¥å‘Š

---

## ğŸ‰ æ€»ç»“

âœ… **æ•°é‡é™åˆ¶å·²å®æ–½** - æ¯ä¸ªä¸»è´¦å·æœ€å¤šåˆ›å»º 3 ä¸ªå¹³çº§è´¦å·  
âœ… **è‡ªåŠ¨æ£€æŸ¥** - è§¦å‘å™¨è‡ªåŠ¨æ£€æŸ¥ï¼Œæ— éœ€æ‰‹åŠ¨å¹²é¢„  
âœ… **å®‰å…¨å¯é ** - æ•°æ®åº“å±‚é¢ä¿éšœï¼Œæ— æ³•ç»•è¿‡  
âœ… **å‹å¥½æç¤º** - è¶…è¿‡é™åˆ¶æ—¶æä¾›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯  
âœ… **å®æ—¶ç»Ÿè®¡** - å¯ä»¥éšæ—¶æŸ¥çœ‹å·²åˆ›å»ºæ•°é‡å’Œå‰©ä½™åé¢  

**å½“å‰çŠ¶æ€**ï¼š
- ä¸»è´¦å·"ç®¡ç†å‘˜"ï¼š0/3 å¹³çº§è´¦å·
- ä¸»è´¦å·"æµ‹è¯•2"ï¼š1/3 å¹³çº§è´¦å·
- ä¸»è´¦å·"æµ‹è¯•3"ï¼š0/3 å¹³çº§è´¦å·

ç³»ç»Ÿè¿è¡Œæ­£å¸¸ï¼Œæ•°é‡é™åˆ¶åŠŸèƒ½å®Œå…¨ç¬¦åˆé¢„æœŸï¼ğŸŠ

---

**æŠ¥å‘Šæ—¥æœŸ**ï¼š2025-11-05  
**æŠ¥å‘Šäººå‘˜**ï¼šç§’å“’ AI  
**çŠ¶æ€**ï¼šâœ… å·²éªŒè¯
