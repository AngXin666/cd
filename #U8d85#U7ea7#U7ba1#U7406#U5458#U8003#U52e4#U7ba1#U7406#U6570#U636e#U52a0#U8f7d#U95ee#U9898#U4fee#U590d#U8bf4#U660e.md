# 超级管理员考勤管理数据加载问题修复说明

## 问题描述
超级管理员在考勤管理页面无法看到任何数据，包括：
- 请假申请
- 离职申请
- 司机统计
- 打卡记录

## 问题原因分析

### 根本原因
超级管理员不在 `manager_warehouses` 表中，调用 `getManagerWarehouses(user.id)` 会返回空数组。原代码在多处使用 `managerWarehouses` 来筛选数据，导致超级管理员看不到任何数据。

### 问题代码位置

#### 1. 仓库列表筛选（第151-154行）
```typescript
// 错误代码
const _getVisibleWarehouses = () => {
  const managedWarehouseIds = managerWarehouses.map((w) => w.id)
  return warehouses.filter((w) => managedWarehouseIds.includes(w.id))
}
```
**问题**：超级管理员的 `managerWarehouses` 为空数组，导致 `managedWarehouseIds` 也为空，筛选后没有任何仓库。

#### 2. 申请数据筛选（第157-175行）
```typescript
// 错误代码
const getVisibleApplications = () => {
  const managedWarehouseIds = managerWarehouses.map((w) => w.id)
  let visibleLeave = leaveApplications.filter((app) => 
    managedWarehouseIds.includes(app.warehouse_id)
  )
  let visibleResignation = resignationApplications.filter((app) => 
    managedWarehouseIds.includes(app.warehouse_id)
  )
  // ...
}
```
**问题**：超级管理员的 `managedWarehouseIds` 为空，筛选后没有任何申请数据。

#### 3. 打卡记录筛选（第263-269行）
```typescript
// 错误代码
let visibleAttendance = attendanceRecords
const managerWarehouseIds = managerWarehouses.map((w) => w.id)
visibleAttendance = attendanceRecords.filter((record) =>
  record.warehouse_id ? managerWarehouseIds.includes(record.warehouse_id) : false
)
```
**问题**：超级管理员的 `managerWarehouseIds` 为空，筛选后没有任何打卡记录。

#### 4. 打卡记录加载（第100-103行）
```typescript
// 错误代码
const managedWarehouseIds = managedWarehouses.map((w) => w.id)
const filteredRecords = records.filter((r) => 
  managedWarehouseIds.includes(r.warehouse_id)
)
setAttendanceRecords(filteredRecords)
```
**问题**：超级管理员的 `managedWarehouseIds` 为空，加载的打卡记录被全部过滤掉。

#### 5. 可见仓库变量（第469行）
```typescript
// 错误代码
const visibleWarehouses = managerWarehouses
```
**问题**：直接使用 `managerWarehouses`，超级管理员看不到任何仓库选项。

## 修复方案

### 核心思路
根据用户角色（`currentUserProfile.role`）来决定是否需要筛选数据：
- **超级管理员（super_admin）**：可以看到所有数据，不进行筛选
- **普通管理员（manager）**：只能看到管辖仓库的数据，需要筛选

### 修复详情

#### 1. 修复 getVisibleWarehouses 函数
```typescript
// 修复后的代码
const getVisibleWarehouses = () => {
  if (!currentUserProfile) return []

  if (currentUserProfile.role === 'super_admin') {
    // 超级管理员可以看到所有仓库
    return warehouses
  } else if (currentUserProfile.role === 'manager') {
    // 普通管理员只能看到自己管辖的仓库
    const managedWarehouseIds = managerWarehouses.map((w) => w.id)
    return warehouses.filter((w) => managedWarehouseIds.includes(w.id))
  }

  return []
}
```

#### 2. 修复 getVisibleApplications 函数
```typescript
// 修复后的代码
const getVisibleApplications = () => {
  let visibleLeave = leaveApplications
  let visibleResignation = resignationApplications

  // 如果是普通管理员，只显示其管辖仓库的数据
  if (currentUserProfile?.role === 'manager') {
    const managedWarehouseIds = managerWarehouses.map((w) => w.id)
    visibleLeave = leaveApplications.filter((app) => 
      managedWarehouseIds.includes(app.warehouse_id)
    )
    visibleResignation = resignationApplications.filter((app) => 
      managedWarehouseIds.includes(app.warehouse_id)
    )
  }

  // 按仓库筛选
  if (filterWarehouse !== 'all') {
    visibleLeave = visibleLeave.filter((app) => app.warehouse_id === filterWarehouse)
    visibleResignation = visibleResignation.filter((app) => 
      app.warehouse_id === filterWarehouse
    )
  }

  // 按状态筛选
  if (filterStatus !== 'all') {
    visibleLeave = visibleLeave.filter((app) => app.status === filterStatus)
    visibleResignation = visibleResignation.filter((app) => 
      app.status === filterStatus
    )
  }

  return {visibleLeave, visibleResignation}
}
```

#### 3. 修复 calculateDriverStats 中的打卡记录筛选
```typescript
// 修复后的代码
// 处理打卡记录
let visibleAttendance = attendanceRecords
// 如果是普通管理员，只显示其管辖仓库的数据
if (currentUserProfile?.role === 'manager') {
  const managerWarehouseIds = managerWarehouses.map((w) => w.id)
  visibleAttendance = attendanceRecords.filter((record) =>
    record.warehouse_id ? managerWarehouseIds.includes(record.warehouse_id) : false
  )
}
// 按仓库筛选
if (filterWarehouse !== 'all') {
  visibleAttendance = visibleAttendance.filter((record) => 
    record.warehouse_id === filterWarehouse
  )
}
```

#### 4. 修复 loadData 中的打卡记录加载
```typescript
// 修复后的代码
// 如果是打卡记录标签页，加载打卡记录
if (activeTab === 'attendance') {
  const currentMonth = filterMonth || initCurrentMonth()
  const [year, month] = currentMonth.split('-').map(Number)
  const records = await getAllAttendanceRecords(year, month)

  // 获取当前用户信息（使用最新获取的数据）
  const userProfile = allProfiles.find((p) => p.id === user.id) || null

  // 根据权限过滤记录
  if (userProfile?.role === 'super_admin') {
    // 超级管理员可以看到所有记录
    setAttendanceRecords(records)
  } else if (userProfile?.role === 'manager') {
    // 普通管理员只能看到管辖仓库的记录
    const managedWarehouseIds = managedWarehouses.map((w) => w.id)
    const filteredRecords = records.filter((r) => 
      managedWarehouseIds.includes(r.warehouse_id)
    )
    setAttendanceRecords(filteredRecords)
  }
}
```

#### 5. 修复 visibleWarehouses 变量
```typescript
// 修复后的代码
const visibleWarehouses = getVisibleWarehouses()
```

## 修复效果

### 超级管理员
- ✅ 可以看到所有仓库
- ✅ 可以看到所有请假申请
- ✅ 可以看到所有离职申请
- ✅ 可以看到所有司机的统计数据
- ✅ 可以看到所有打卡记录
- ✅ 可以审批所有仓库的申请

### 普通管理员
- ✅ 只能看到管辖的仓库
- ✅ 只能看到管辖仓库的请假申请
- ✅ 只能看到管辖仓库的离职申请
- ✅ 只能看到管辖仓库的司机统计
- ✅ 只能看到管辖仓库的打卡记录
- ✅ 只能审批管辖仓库的申请

## 权限控制逻辑

### 数据可见性规则
```
超级管理员 (super_admin):
  - 仓库列表: 所有仓库
  - 请假申请: 所有申请
  - 离职申请: 所有申请
  - 司机统计: 所有司机
  - 打卡记录: 所有记录

普通管理员 (manager):
  - 仓库列表: 仅管辖仓库
  - 请假申请: 仅管辖仓库的申请
  - 离职申请: 仅管辖仓库的申请
  - 司机统计: 仅管辖仓库的司机
  - 打卡记录: 仅管辖仓库的记录
```

### 筛选逻辑流程
```
1. 首先根据用户角色筛选基础数据
   - super_admin: 不筛选，使用全部数据
   - manager: 筛选管辖仓库的数据

2. 然后应用用户选择的筛选条件
   - 仓库筛选
   - 状态筛选
   - 月份筛选
   - 司机筛选

3. 最后返回筛选后的数据
```

## 测试建议

### 功能测试
1. **超级管理员测试**
   - [ ] 登录超级管理员账号
   - [ ] 检查是否能看到所有仓库
   - [ ] 检查待审批标签页是否显示所有申请
   - [ ] 检查司机统计标签页是否显示所有司机
   - [ ] 检查打卡记录标签页是否显示所有记录
   - [ ] 测试审批功能是否正常
   - [ ] 测试各种筛选条件是否正常

2. **普通管理员测试**
   - [ ] 登录普通管理员账号
   - [ ] 检查是否只能看到管辖的仓库
   - [ ] 检查待审批标签页是否只显示管辖仓库的申请
   - [ ] 检查司机统计标签页是否只显示管辖仓库的司机
   - [ ] 检查打卡记录标签页是否只显示管辖仓库的记录
   - [ ] 测试审批功能是否正常
   - [ ] 测试各种筛选条件是否正常

### 边界测试
1. **空数据测试**
   - [ ] 没有任何申请时的显示
   - [ ] 没有任何司机时的显示
   - [ ] 没有任何打卡记录时的显示

2. **权限边界测试**
   - [ ] 普通管理员尝试查看非管辖仓库的数据
   - [ ] 普通管理员尝试审批非管辖仓库的申请

## 代码质量改进

### 1. 统一的权限检查模式
所有数据筛选函数都采用相同的权限检查模式：
```typescript
if (currentUserProfile?.role === 'super_admin') {
  // 超级管理员逻辑
} else if (currentUserProfile?.role === 'manager') {
  // 普通管理员逻辑
}
```

### 2. 清晰的注释
每个权限检查点都添加了清晰的注释，说明：
- 超级管理员的权限范围
- 普通管理员的权限范围

### 3. 一致的变量命名
- `currentUserProfile`: 当前用户信息
- `visibleWarehouses`: 可见的仓库列表
- `visibleLeave`: 可见的请假申请
- `visibleResignation`: 可见的离职申请
- `visibleAttendance`: 可见的打卡记录

## 预防措施

### 1. 代码审查清单
在添加新的数据筛选逻辑时，需要检查：
- [ ] 是否考虑了超级管理员的权限
- [ ] 是否考虑了普通管理员的权限
- [ ] 是否使用了 `currentUserProfile.role` 来判断权限
- [ ] 是否避免了直接使用 `managerWarehouses` 进行筛选

### 2. 测试清单
在修改权限相关代码后，需要测试：
- [ ] 超级管理员能看到所有数据
- [ ] 普通管理员只能看到管辖仓库的数据
- [ ] 筛选功能正常工作
- [ ] 审批功能正常工作

### 3. 文档更新
在修改权限逻辑后，需要更新：
- [ ] 代码注释
- [ ] 技术文档
- [ ] 用户手册

## 总结

本次修复解决了超级管理员无法看到考勤管理数据的问题，核心改进是：

1. **明确权限控制逻辑**：根据用户角色决定数据可见性
2. **统一筛选模式**：所有数据筛选函数都采用相同的权限检查模式
3. **完善的注释**：清晰说明每个权限检查点的逻辑
4. **保持向后兼容**：普通管理员的功能不受影响

修复后，超级管理员和普通管理员都能正常使用考勤管理功能，权限控制准确有效。
