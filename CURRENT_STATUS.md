# 通知系统当前状态

## 问题描述
用户反馈：**"通知系统无法把信息的状态更新，会有两条信息"**

## 已完成的修复

### 1. ✅ 修复通知类型不匹配
**问题**：司机端发送通知使用 `leave_submitted`，老板端查询使用 `leave_application_submitted`，导致查询不到通知，无法更新状态。

**修复**：
- 文件：`src/pages/driver/leave/apply/index.tsx`
- 修改：`type: 'leave_submitted'` → `type: 'leave_application_submitted'`
- 状态：✅ 已完成

### 2. ✅ 修复 RLS 策略
**问题**：
- 用户更新通知的策略缺少 WITH CHECK 子句
- 用户无法删除自己的通知
- 管理员无法更新其他管理员的通知

**修复**：
- 文件：`supabase/migrations/00530_fix_notifications_rls_policies.sql`
- 添加：WITH CHECK 子句
- 添加：用户删除通知的策略
- 添加：管理员更新所有通知的策略
- 状态：✅ 已完成

### 3. ✅ 添加详细调试日志
**目的**：帮助诊断"两条信息"的问题

**添加内容**：
- 查询原始通知前的参数日志
- 查询结果的详细信息（ID、接收者、类型、关联ID、审批状态等）
- 更新过程的每一步日志
- 更新成功/失败的统计
- 未查询到通知时的可能原因分析

**文件**：`src/pages/super-admin/leave-approval/index.tsx`
**状态**：✅ 已完成

### 4. ✅ 创建调试指南文档
**文件**：`NOTIFICATION_DEBUG_GUIDE.md`

**包含内容**：
- 详细的测试步骤
- 数据库检查 SQL 语句
- 常见问题和解决方案
- 完整的检查清单
- 错误信息说明

**状态**：✅ 已完成

## 下一步：用户测试

### 测试步骤

#### 第一步：司机提交请假申请
1. 使用司机账号登录
2. 打开浏览器控制台（F12）
3. 提交一个请假申请
4. 查看控制台日志，确认通知发送成功

#### 第二步：老板审批请假申请
1. 使用老板账号登录
2. 打开浏览器控制台（F12）
3. 进入请假审批页面
4. 点击"批准"或"拒绝"按钮
5. **仔细查看控制台日志**，特别关注：
   - 🔍 查询到多少条原始通知
   - 📋 通知的详细信息
   - ✅ 更新成功/失败的统计

#### 第三步：检查通知中心
1. 使用老板账号查看通知中心
2. **确认是否还有两条信息**
3. 如果还有问题，提供控制台日志

### 如果问题仍然存在

请提供以下信息：
1. 完整的控制台日志（司机端和老板端）
2. 通知中心的截图（显示两条信息）
3. 具体的问题描述：
   - 哪个角色看到两条信息？（老板/车队长/司机）
   - 两条信息的内容是什么？
   - 两条信息的类型是什么？

## 相关文档

- `NOTIFICATION_DEBUG_GUIDE.md`：详细的调试指南
- `NOTIFICATION_FIX_SUMMARY.md`：通知系统修复总结
- `README.md`：项目文档，包含所有修复记录

---

**最后更新**：2025-12-01
**状态**：等待用户测试反馈
