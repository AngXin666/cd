# ç³»ç»Ÿè¶…çº§ç®¡ç†å‘˜ç§ŸæœŸæ£€æŸ¥é—®é¢˜ä¿®å¤

## ğŸ“‹ é—®é¢˜æè¿°

ç”¨æˆ·åé¦ˆï¼š**ç³»ç»Ÿè¶…çº§ç®¡ç†å‘˜è´¦å·ç™»å½•åæç¤º"è´¦å·å·²è¿‡æœŸ"**

**ç”¨æˆ·åŸè¯**ï¼š
> è¿˜æ˜¯ä¸è¡Œè´¦å·è¿‡æœŸï¼Œç³»ç»Ÿç®¡ç†å‘˜çš„è´¦å·æ˜¯ä¸æ¶‰åŠçš„ç§ŸæœŸçš„ï¼Œæ£€æŸ¥é€»è¾‘

## ğŸ” é—®é¢˜åˆ†æ

### æ ¹æœ¬åŸå› 

ç³»ç»Ÿä¸­æœ‰**ä¸¤ä¸ªåœ°æ–¹**åœ¨æ£€æŸ¥ç§ŸæœŸçŠ¶æ€ï¼Œä½†éƒ½æ²¡æœ‰æ­£ç¡®æ’é™¤ç³»ç»Ÿè¶…çº§ç®¡ç†å‘˜ï¼š

1. **æ•°æ®åº“å‡½æ•°** `check_account_status()`
   - âœ… å·²åœ¨ä¹‹å‰ä¿®å¤ï¼ˆmigration 10006ï¼‰
   - æ­£ç¡®æ’é™¤äº† `tenant_id IS NULL` çš„ç³»ç»Ÿè¶…çº§ç®¡ç†å‘˜

2. **å‰ç«¯é¡µé¢** `src/pages/index/index.tsx` âŒ é—®é¢˜æ‰€åœ¨
   - ç¬¬ 70 è¡Œï¼š`if (userRole === 'super_admin' || userRole === 'manager')`
   - åªè¦è§’è‰²æ˜¯ `super_admin` å°±ä¼šè°ƒç”¨ `checkUserLeaseStatus()`
   - **æ²¡æœ‰åˆ¤æ–­ `tenant_id` æ˜¯å¦ä¸º NULL**

3. **API å‡½æ•°** `checkUserLeaseStatus()` âŒ é—®é¢˜æ‰€åœ¨
   - ä½äº `src/db/api.ts`
   - æ’é™¤äº†å¸æœºå’Œç§Ÿèµç®¡ç†å‘˜
   - **ä½†æ²¡æœ‰æ’é™¤ç³»ç»Ÿè¶…çº§ç®¡ç†å‘˜**ï¼ˆtenant_id ä¸º NULLï¼‰

### è´¦å·ç±»å‹è¯´æ˜

| è´¦å·ç±»å‹ | role | tenant_id | æ˜¯å¦æ£€æŸ¥ç§ŸæœŸ |
|---------|------|-----------|------------|
| ç³»ç»Ÿè¶…çº§ç®¡ç†å‘˜ | super_admin | NULL | âŒ ä¸æ£€æŸ¥ |
| ç§Ÿæˆ·è€æ¿ | super_admin | æœ‰å€¼ | âœ… æ£€æŸ¥ |
| ç§Ÿèµç®¡ç†å‘˜ | lease_admin | NULL | âŒ ä¸æ£€æŸ¥ |
| å¸æœº | driver | æœ‰å€¼ | âŒ ä¸æ£€æŸ¥ |
| è½¦é˜Ÿé•¿ | manager | æœ‰å€¼ | âœ… æ£€æŸ¥ |

### åˆ¤æ–­é€»è¾‘

```
æ˜¯å¦éœ€è¦æ£€æŸ¥ç§ŸæœŸ = tenant_id IS NOT NULL 
                  AND (role = 'super_admin' OR role = 'manager')
```

**å…³é”®ç‚¹**ï¼š
- `tenant_id IS NULL` â†’ ç³»ç»Ÿçº§è´¦å· â†’ **ä¸æ£€æŸ¥ç§ŸæœŸ**
- `tenant_id IS NOT NULL` â†’ ç§Ÿæˆ·å†…è´¦å· â†’ **å¯èƒ½éœ€è¦æ£€æŸ¥ç§ŸæœŸ**

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤1ï¼šæ›´æ–° `checkUserLeaseStatus()` å‡½æ•°

**æ–‡ä»¶**ï¼š`src/db/api.ts`

**ä½ç½®**ï¼šç¬¬ 7926 è¡Œ

**ä¿®æ”¹å†…å®¹**ï¼š
```typescript
// æ·»åŠ ç³»ç»Ÿè¶…çº§ç®¡ç†å‘˜åˆ¤æ–­ï¼ˆåœ¨å¸æœºå’Œç§Ÿèµç®¡ç†å‘˜åˆ¤æ–­ä¹‹å‰ï¼‰
if (user.role === 'super_admin' && user.tenant_id === null) {
  console.log('[ç§ŸæœŸæ£€æµ‹] ç³»ç»Ÿè¶…çº§ç®¡ç†å‘˜ï¼Œä¸å—ç§ŸæœŸé™åˆ¶')
  return {status: 'ok'}
}
```

**æ•ˆæœ**ï¼š
- ç³»ç»Ÿè¶…çº§ç®¡ç†å‘˜ç›´æ¥è¿”å› `{status: 'ok'}`
- ä¸ä¼šç»§ç»­æ‰§è¡Œåç»­çš„ç§ŸæœŸæ£€æŸ¥é€»è¾‘

### ä¿®å¤2ï¼šåˆ›å»ºæ–°å‡½æ•° `getCurrentUserRoleAndTenant()`

**æ–‡ä»¶**ï¼š`src/db/api.ts`

**ä½ç½®**ï¼šç¬¬ 241 è¡Œ

**æ–°å¢å‡½æ•°**ï¼š
```typescript
/**
 * è·å–å½“å‰ç”¨æˆ·çš„è§’è‰²å’Œç§Ÿæˆ·ä¿¡æ¯
 * ç”¨äºåˆ¤æ–­æ˜¯å¦éœ€è¦æ£€æŸ¥ç§ŸæœŸ
 */
export async function getCurrentUserRoleAndTenant(): Promise<{
  role: UserRole
  tenant_id: string | null
} | null> {
  // ... å®ç°ä»£ç 
}
```

**ä½œç”¨**ï¼š
- åŒæ—¶è¿”å› `role` å’Œ `tenant_id`
- è®©å‰ç«¯å¯ä»¥åˆ¤æ–­æ˜¯å¦éœ€è¦æ£€æŸ¥ç§ŸæœŸ

### ä¿®å¤3ï¼šæ›´æ–° `index.tsx` é¡µé¢é€»è¾‘

**æ–‡ä»¶**ï¼š`src/pages/index/index.tsx`

**ä¿®æ”¹å†…å®¹**ï¼š

1. **å¯¼å…¥æ–°å‡½æ•°**ï¼š
```typescript
import {checkUserLeaseStatus, getCurrentUserRoleAndTenant} from '@/db/api'
```

2. **ä½¿ç”¨æ–°å‡½æ•°è·å–è§’è‰²å’Œç§Ÿæˆ·ä¿¡æ¯**ï¼š
```typescript
const userInfo = await getCurrentUserRoleAndTenant()
const {role: userRole, tenant_id} = userInfo
```

3. **æ·»åŠ æ˜ç¡®çš„åˆ¤æ–­é€»è¾‘**ï¼š
```typescript
// æ£€æŸ¥ç§ŸæœŸçŠ¶æ€
// åªå¯¹ç§Ÿæˆ·å†…çš„è´¦å·è¿›è¡Œæ£€æŸ¥ï¼ˆtenant_id ä¸ä¸º NULLï¼‰
// ç³»ç»Ÿè¶…çº§ç®¡ç†å‘˜ï¼ˆtenant_id ä¸º NULLï¼‰ã€ç§Ÿèµç®¡ç†å‘˜ã€å¸æœºä¸éœ€è¦æ£€æŸ¥
const needLeaseCheck =
  tenant_id !== null && (userRole === 'super_admin' || userRole === 'manager')

if (needLeaseCheck) {
  console.log('[IndexPage] éœ€è¦æ£€æŸ¥ç§ŸæœŸçŠ¶æ€')
  // ... æ‰§è¡Œç§ŸæœŸæ£€æŸ¥
} else {
  console.log('[IndexPage] æ— éœ€æ£€æŸ¥ç§ŸæœŸçŠ¶æ€ï¼Œè§’è‰²:', userRole, 'ç§Ÿæˆ·ID:', tenant_id)
}
```

**æ•ˆæœ**ï¼š
- ç³»ç»Ÿè¶…çº§ç®¡ç†å‘˜ï¼ˆtenant_id ä¸º NULLï¼‰ä¸ä¼šè°ƒç”¨ `checkUserLeaseStatus()`
- é¿å…ä¸å¿…è¦çš„æ•°æ®åº“æŸ¥è¯¢
- æé«˜ç™»å½•é€Ÿåº¦

## ğŸ§ª éªŒè¯æ–¹æ³•

### 1. æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—

ç™»å½•ç³»ç»Ÿè¶…çº§ç®¡ç†å‘˜è´¦å·åï¼Œæ§åˆ¶å°åº”è¯¥æ˜¾ç¤ºï¼š

```
[IndexPage] å¼€å§‹è·å–ç”¨æˆ·è§’è‰²ï¼Œç”¨æˆ·ID: d79327e9-69b4-42b7-b1b4-5d13de6e9814
[getCurrentUserRoleAndTenant] å¼€å§‹è·å–ç”¨æˆ·è§’è‰²å’Œç§Ÿæˆ·ä¿¡æ¯
[getCurrentUserRoleAndTenant] å½“å‰ç”¨æˆ·ID: d79327e9-69b4-42b7-b1b4-5d13de6e9814
[getCurrentUserRoleAndTenant] æˆåŠŸè·å–: {role: 'super_admin', tenant_id: null}
[IndexPage] ç”¨æˆ·è§’è‰²è·å–æˆåŠŸ: super_admin ç§Ÿæˆ·ID: null
[IndexPage] æ— éœ€æ£€æŸ¥ç§ŸæœŸçŠ¶æ€ï¼Œè§’è‰²: super_admin ç§Ÿæˆ·ID: null
[IndexPage] æ ¹æ®è§’è‰²å¿«é€Ÿè·³è½¬: super_admin
```

**å…³é”®æ—¥å¿—**ï¼š
- âœ… `ç§Ÿæˆ·ID: null` - ç¡®è®¤æ˜¯ç³»ç»Ÿè¶…çº§ç®¡ç†å‘˜
- âœ… `æ— éœ€æ£€æŸ¥ç§ŸæœŸçŠ¶æ€` - ç¡®è®¤è·³è¿‡äº†ç§ŸæœŸæ£€æŸ¥
- âŒ ä¸åº”è¯¥å‡ºç° `æ­£åœ¨æ£€æŸ¥ç§ŸæœŸçŠ¶æ€...`
- âŒ ä¸åº”è¯¥å‡ºç° `[ç§ŸæœŸæ£€æµ‹]` ç›¸å…³æ—¥å¿—

### 2. æµ‹è¯•ç™»å½•æµç¨‹

**æ­¥éª¤**ï¼š
1. æ‰“å¼€ç™»å½•é¡µé¢
2. è¾“å…¥è´¦å·ï¼š`admin`
3. è¾“å…¥å¯†ç ï¼š`hye19911206`
4. ç‚¹å‡»"å¯†ç ç™»å½•"

**é¢„æœŸç»“æœ**ï¼š
- âœ… æ˜¾ç¤º "ç™»å½•æˆåŠŸ"
- âœ… æ˜¾ç¤º "æ­£åœ¨è·å–è§’è‰²ä¿¡æ¯..."
- âœ… æ˜¾ç¤º "æ­£åœ¨è·³è½¬..."
- âœ… è·³è½¬åˆ°è¶…çº§ç®¡ç†å‘˜ç•Œé¢
- âŒ **ä¸åº”è¯¥**æ˜¾ç¤º "æ­£åœ¨æ£€æŸ¥ç§ŸæœŸçŠ¶æ€..."
- âŒ **ä¸åº”è¯¥**æ˜¾ç¤º "è´¦æˆ·å·²è¿‡æœŸ"

### 3. éªŒè¯æ•°æ®åº“çŠ¶æ€

```sql
-- æŸ¥è¯¢ç³»ç»Ÿè¶…çº§ç®¡ç†å‘˜ä¿¡æ¯
SELECT 
  id,
  name,
  role,
  status,
  tenant_id,
  lease_start_date,
  lease_end_date
FROM public.profiles 
WHERE email = 'admin@fleet.com';
```

**é¢„æœŸç»“æœ**ï¼š
```
id: d79327e9-69b4-42b7-b1b4-5d13de6e9814
name: admin
role: super_admin
status: active
tenant_id: NULL          â† å…³é”®ï¼šå¿…é¡»æ˜¯ NULL
lease_start_date: NULL
lease_end_date: NULL
```

## ğŸ“Š ä¿®å¤å¯¹æ¯”

### ä¿®å¤å‰

```
ç”¨æˆ·ç™»å½• admin
  â†“
è·å–è§’è‰²: super_admin
  â†“
åˆ¤æ–­: role === 'super_admin' â†’ æ˜¯
  â†“
è°ƒç”¨ checkUserLeaseStatus()
  â†“
æŸ¥è¯¢ leases è¡¨
  â†“
æ²¡æœ‰æ‰¾åˆ°ç§Ÿçº¦è®°å½•
  â†“
è¿”å›: {status: 'main_expired', message: 'æ‚¨çš„è´¦å·å·²è¿‡æœŸ'}
  â†“
æ˜¾ç¤º "è´¦æˆ·å·²è¿‡æœŸ" å¼¹çª— âŒ
```

### ä¿®å¤å

```
ç”¨æˆ·ç™»å½• admin
  â†“
è·å–è§’è‰²å’Œç§Ÿæˆ·: {role: 'super_admin', tenant_id: null}
  â†“
åˆ¤æ–­: tenant_id === null â†’ æ˜¯
  â†“
è·³è¿‡ç§ŸæœŸæ£€æŸ¥ âœ…
  â†“
ç›´æ¥è·³è½¬åˆ°è¶…çº§ç®¡ç†å‘˜ç•Œé¢ âœ…
```

## ğŸ“ ä¿®æ”¹æ–‡ä»¶æ¸…å•

### ä¿®æ”¹çš„æ–‡ä»¶

1. **src/db/api.ts**
   - ç¬¬ 7926-7930 è¡Œï¼šæ·»åŠ ç³»ç»Ÿè¶…çº§ç®¡ç†å‘˜åˆ¤æ–­
   - ç¬¬ 241-291 è¡Œï¼šæ–°å¢ `getCurrentUserRoleAndTenant()` å‡½æ•°

2. **src/pages/index/index.tsx**
   - ç¬¬ 6 è¡Œï¼šå¯¼å…¥ `getCurrentUserRoleAndTenant`
   - ç¬¬ 28-116 è¡Œï¼šæ›´æ–° `loadRole()` å‡½æ•°é€»è¾‘

### æ–°å¢çš„æ–‡æ¡£

1. **LEASE_CHECK_FIX.md** - æœ¬æ–‡æ¡£

## ğŸ¯ æµ‹è¯•æ¸…å•

- [ ] ä½¿ç”¨ admin è´¦å·ç™»å½•
- [ ] ç¡®è®¤æ§åˆ¶å°æ˜¾ç¤º "æ— éœ€æ£€æŸ¥ç§ŸæœŸçŠ¶æ€"
- [ ] ç¡®è®¤æ²¡æœ‰ "è´¦æˆ·å·²è¿‡æœŸ" æç¤º
- [ ] ç¡®è®¤å¯ä»¥æ­£å¸¸è®¿é—®è¶…çº§ç®¡ç†å‘˜åŠŸèƒ½
- [ ] ç¡®è®¤å¯ä»¥è®¿é—®ç§Ÿæˆ·é…ç½®ç®¡ç†
- [ ] ç¡®è®¤å¯ä»¥åˆ›å»ºå’Œç¼–è¾‘ç§Ÿæˆ·

## ğŸ’¡ æŠ€æœ¯è¦ç‚¹

### 1. ä¸ºä»€ä¹ˆè¦åœ¨å‰ç«¯ä¹Ÿåˆ¤æ–­ï¼Ÿ

è™½ç„¶ `checkUserLeaseStatus()` å‡½æ•°å·²ç»ä¿®å¤ï¼Œä¼šæ­£ç¡®è¿”å› `{status: 'ok'}`ï¼Œä½†æ˜¯ï¼š

1. **æ€§èƒ½ä¼˜åŒ–**ï¼šé¿å…ä¸å¿…è¦çš„æ•°æ®åº“æŸ¥è¯¢
2. **é€»è¾‘æ¸…æ™°**ï¼šå‰ç«¯æ˜ç¡®çŸ¥é“å“ªäº›è´¦å·éœ€è¦æ£€æŸ¥
3. **æ—¥å¿—å‹å¥½**ï¼šå¯ä»¥åœ¨æ§åˆ¶å°çœ‹åˆ°æ¸…æ™°çš„åˆ¤æ–­è¿‡ç¨‹

### 2. ä¸ºä»€ä¹ˆä¸ç›´æ¥ä¿®æ”¹ `getCurrentUserRole()`ï¼Ÿ

`getCurrentUserRole()` æ˜¯ä¸€ä¸ªé€šç”¨å‡½æ•°ï¼Œå¾ˆå¤šåœ°æ–¹éƒ½åœ¨ä½¿ç”¨ã€‚ä¿®æ”¹å®ƒå¯èƒ½å½±å“å…¶ä»–åŠŸèƒ½ã€‚

åˆ›å»ºæ–°å‡½æ•° `getCurrentUserRoleAndTenant()` çš„å¥½å¤„ï¼š
- ä¸å½±å“ç°æœ‰ä»£ç 
- ä¸“é—¨ç”¨äºéœ€è¦åˆ¤æ–­ç§ŸæœŸçš„åœºæ™¯
- å‡½æ•°åç§°æ›´æ˜ç¡®ï¼Œè¡¨è¾¾äº†è¿”å›å€¼çš„å†…å®¹

### 3. tenant_id çš„å«ä¹‰

- `tenant_id IS NULL`ï¼šç³»ç»Ÿçº§è´¦å·ï¼ˆç³»ç»Ÿè¶…çº§ç®¡ç†å‘˜ã€ç§Ÿèµç®¡ç†å‘˜ï¼‰
- `tenant_id IS NOT NULL`ï¼šç§Ÿæˆ·å†…è´¦å·ï¼ˆç§Ÿæˆ·è€æ¿ã€è½¦é˜Ÿé•¿ã€å¸æœºç­‰ï¼‰

ç³»ç»Ÿçº§è´¦å·ä¸å±äºä»»ä½•ç§Ÿæˆ·ï¼Œå› æ­¤ä¸å—ç§Ÿçº¦é™åˆ¶ã€‚

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [SUPER_ADMIN_FIX_SUMMARY.md](SUPER_ADMIN_FIX_SUMMARY.md) - è¶…çº§ç®¡ç†å‘˜ä¿®å¤æ€»ç»“
- [LOGIN_FIX_SUMMARY.md](LOGIN_FIX_SUMMARY.md) - ç™»å½•é—®é¢˜ä¿®å¤æ€»ç»“
- [TEST_CHECKLIST.md](TEST_CHECKLIST.md) - æµ‹è¯•æ¸…å•

---

**ä¿®å¤æ—¥æœŸ**ï¼š2025-11-27  
**ä¿®å¤çŠ¶æ€**ï¼šâœ… å·²å®Œæˆ  
**éªŒè¯çŠ¶æ€**ï¼šâ³ ç­‰å¾…ç”¨æˆ·æµ‹è¯•
