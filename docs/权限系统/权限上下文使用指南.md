# æƒé™ä¸Šä¸‹æ–‡ä½¿ç”¨æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æƒé™ä¸Šä¸‹æ–‡ç³»ç»Ÿæä¾›äº†ä¸€å¥—å®Œæ•´çš„æƒé™ç®¡ç†æœºåˆ¶ï¼Œç¡®ä¿æ¯ä¸ªè§’è‰²ç™»å½•åèƒ½"ä¸€æ¬¡æ€§ã€å‡†ç¡®ã€å®Œæ•´"åœ°è·å–å…¶æƒé™ä¿¡æ¯å’Œç®¡è¾–èŒƒå›´ã€‚

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§

### 1. ä¸€æ¬¡æ€§åŠ è½½
- ç”¨æˆ·ç™»å½•åè‡ªåŠ¨åˆå§‹åŒ–æƒé™ä¸Šä¸‹æ–‡
- æ‰€æœ‰æƒé™ä¿¡æ¯ä¸€æ¬¡æ€§åŠ è½½å®Œæˆ
- é¿å…é‡å¤æŸ¥è¯¢æ•°æ®åº“

### 2. å‡†ç¡®æ€§ä¿è¯
- åŸºäºæ•°æ®åº“å‡½æ•°è®¡ç®—æƒé™
- ä½¿ç”¨ SECURITY DEFINER ç¡®ä¿å®‰å…¨æ€§
- æƒé™çº§åˆ«ç²¾ç¡®åˆ°æ“ä½œç±»å‹

### 3. å®Œæ•´æ€§ä¿è¯
- åŒ…å«ç”¨æˆ·è§’è‰²ã€æƒé™çº§åˆ«ã€ç®¡è¾–èŒƒå›´
- æä¾›ç›´å±ä¸Šçº§ã€ä¸‹å±åˆ—è¡¨ã€ä»“åº“ä¿¡æ¯
- æ”¯æŒç³»ç»Ÿèµ„æºç»Ÿè®¡

## ğŸ“Š æƒé™æ¨¡å¼

### 1. own_data_onlyï¼ˆå¸æœºï¼‰
- **æƒé™çº§åˆ«**ï¼šfull_controlï¼ˆå›ºå®šï¼‰
- **æ•°æ®èŒƒå›´**ï¼šä»…è‡ªå·±çš„æ•°æ®
- **åŒ…å«ä¿¡æ¯**ï¼š
  - ç›´å±è½¦é˜Ÿé•¿
  - è°ƒåº¦è´¦å·åˆ—è¡¨
  - è€æ¿è´¦å·
  - æ‰€å±ä»“åº“åˆ—è¡¨

### 2. managed_resourcesï¼ˆè½¦é˜Ÿé•¿ï¼‰
- **æƒé™çº§åˆ«**ï¼šfull_control æˆ– view_only
- **æ•°æ®èŒƒå›´**ï¼šç®¡è¾–çš„ä»“åº“å’Œå¸æœº
- **åŒ…å«ä¿¡æ¯**ï¼š
  - ç®¡è¾–ä»“åº“åˆ—è¡¨
  - ä¸‹å±å¸æœºåˆ—è¡¨
  - è°ƒåº¦è´¦å·åˆ—è¡¨
  - è€æ¿è´¦å·

### 3. scheduled_resourcesï¼ˆè°ƒåº¦ï¼‰
- **æƒé™çº§åˆ«**ï¼šfull_control æˆ– view_only
- **æ•°æ®èŒƒå›´**ï¼šè°ƒåº¦çš„ä»“åº“ã€å¸æœºå’Œè½¦è¾†
- **åŒ…å«ä¿¡æ¯**ï¼š
  - ç®¡è¾–ä»“åº“/çº¿è·¯
  - å…³è”å¸æœºåˆ—è¡¨
  - å…³è”è½¦è¾†åˆ—è¡¨
  - è€æ¿è´¦å·

### 4. all_accessï¼ˆè€æ¿/å¹³çº§ç®¡ç†å‘˜ï¼‰
- **æƒé™çº§åˆ«**ï¼šfull_control æˆ– view_only
- **æ•°æ®èŒƒå›´**ï¼šå…¨ç³»ç»Ÿ
- **åŒ…å«ä¿¡æ¯**ï¼š
  - ç³»ç»Ÿèµ„æºç»Ÿè®¡ï¼ˆä»“åº“ã€å¸æœºã€è½¦é˜Ÿé•¿ã€è½¦è¾†æ•°é‡ï¼‰

## ğŸ”§ ä½¿ç”¨æ–¹æ³•

### 1. åŸºç¡€ä½¿ç”¨

```typescript
import {usePermissionContext} from '@/hooks/usePermissionContext'

function MyComponent() {
  const {
    context,        // æƒé™ä¸Šä¸‹æ–‡
    loading,        // æ˜¯å¦æ­£åœ¨åŠ è½½
    error,          // é”™è¯¯ä¿¡æ¯
    refresh,        // åˆ·æ–°æƒé™ä¸Šä¸‹æ–‡
    clear,          // æ¸…é™¤æƒé™ä¸Šä¸‹æ–‡
    isDriver,       // æ˜¯å¦ä¸ºå¸æœº
    isManager,      // æ˜¯å¦ä¸ºè½¦é˜Ÿé•¿
    isScheduler,    // æ˜¯å¦ä¸ºè°ƒåº¦
    isAdmin,        // æ˜¯å¦ä¸ºè€æ¿/å¹³çº§ç®¡ç†å‘˜
    hasFullControl, // æ˜¯å¦æœ‰å®Œæ•´æ§åˆ¶æƒ
    hasViewOnly     // æ˜¯å¦ä»…æœ‰æŸ¥çœ‹æƒ
  } = usePermissionContext()

  if (loading) {
    return <View>åŠ è½½ä¸­...</View>
  }

  if (error) {
    return <View>é”™è¯¯: {error}</View>
  }

  if (!context) {
    return <View>æœªè·å–åˆ°æƒé™ä¿¡æ¯</View>
  }

  return (
    <View>
      <Text>æƒé™æ¨¡å¼: {context.mode}</Text>
      <Text>æƒé™çº§åˆ«: {context.level}</Text>
    </View>
  )
}
```

### 2. å¸æœºç«¯ä½¿ç”¨

```typescript
import {useDriverPermissionContext} from '@/hooks/usePermissionContext'

function DriverComponent() {
  const driverContext = useDriverPermissionContext()

  if (!driverContext) {
    return <View>æ‚¨ä¸æ˜¯å¸æœºè§’è‰²</View>
  }

  return (
    <View>
      {/* æ˜¾ç¤ºç›´å±è½¦é˜Ÿé•¿ */}
      {driverContext.directManager && (
        <View>
          <Text>ç›´å±è½¦é˜Ÿé•¿: {driverContext.directManager.name}</Text>
          <Text>è”ç³»ç”µè¯: {driverContext.directManager.phone}</Text>
        </View>
      )}

      {/* æ˜¾ç¤ºæ‰€å±ä»“åº“ */}
      <View>
        <Text>æ‰€å±ä»“åº“:</Text>
        {driverContext.warehouses.map((warehouse) => (
          <View key={warehouse.id}>
            <Text>{warehouse.name}</Text>
          </View>
        ))}
      </View>

      {/* æ˜¾ç¤ºè€æ¿ä¿¡æ¯ */}
      {driverContext.boss && (
        <View>
          <Text>è€æ¿: {driverContext.boss.name}</Text>
        </View>
      )}
    </View>
  )
}
```

### 3. è½¦é˜Ÿé•¿ç«¯ä½¿ç”¨

```typescript
import {useManagerPermissionContext} from '@/hooks/usePermissionContext'

function ManagerComponent() {
  const managerContext = useManagerPermissionContext()

  if (!managerContext) {
    return <View>æ‚¨ä¸æ˜¯è½¦é˜Ÿé•¿è§’è‰²</View>
  }

  // æ£€æŸ¥æƒé™çº§åˆ«
  const canEdit = managerContext.level === 'full_control'

  return (
    <View>
      {/* æ˜¾ç¤ºç®¡è¾–ä»“åº“ */}
      <View>
        <Text>ç®¡è¾–ä»“åº“:</Text>
        {managerContext.managedWarehouses.map((warehouse) => (
          <View key={warehouse.id}>
            <Text>{warehouse.name}</Text>
          </View>
        ))}
      </View>

      {/* æ˜¾ç¤ºä¸‹å±å¸æœº */}
      <View>
        <Text>ä¸‹å±å¸æœº ({managerContext.managedDrivers.length}äºº):</Text>
        {managerContext.managedDrivers.map((driver) => (
          <View key={driver.id}>
            <Text>{driver.name}</Text>
          </View>
        ))}
      </View>

      {/* æ ¹æ®æƒé™çº§åˆ«æ˜¾ç¤ºæ“ä½œæŒ‰é’® */}
      {canEdit ? (
        <Button>ç¼–è¾‘å¸æœºä¿¡æ¯</Button>
      ) : (
        <Text>æ‚¨åªæœ‰æŸ¥çœ‹æƒé™</Text>
      )}
    </View>
  )
}
```

### 4. è°ƒåº¦ç«¯ä½¿ç”¨

```typescript
import {useSchedulerPermissionContext, usePermissionContext} from '@/hooks/usePermissionContext'

function SchedulerComponent() {
  const schedulerContext = useSchedulerPermissionContext()
  const {hasFullControl} = usePermissionContext()

  if (!schedulerContext) {
    return <View>æ‚¨ä¸æ˜¯è°ƒåº¦è§’è‰²</View>
  }

  // æ£€æŸ¥æƒé™çº§åˆ«
  const canEdit = hasFullControl()

  return (
    <View>
      {/* å¦‚æœæ˜¯å®Œæ•´æƒé™ï¼Œæ˜¾ç¤ºå…¨ç³»ç»Ÿè®¿é—®æç¤º */}
      {canEdit && schedulerContext.mode === 'all_access' && (
        <View className="bg-yellow-50 p-3 rounded-lg mb-4">
          <Text className="text-yellow-800 font-semibold">
            â­ æ‚¨æ‹¥æœ‰å®Œæ•´æ§åˆ¶æƒï¼Œç­‰åŒäºè€æ¿æƒé™
          </Text>
          <Text className="text-yellow-700 text-xs mt-1">
            å¯ä»¥è®¿é—®å’Œç®¡ç†å…¨ç³»ç»Ÿæ‰€æœ‰æ•°æ®
          </Text>
        </View>
      )}

      {/* å¦‚æœæ˜¯å®Œæ•´æƒé™ä¸”ä¸º all_access æ¨¡å¼ï¼Œæ˜¾ç¤ºç³»ç»Ÿèµ„æºç»Ÿè®¡ */}
      {schedulerContext.mode === 'all_access' && schedulerContext.systemResources && (
        <View>
          <Text>ç³»ç»Ÿæ¦‚è§ˆ:</Text>
          <Text>ä»“åº“æ•°é‡: {schedulerContext.systemResources.totalWarehouses}</Text>
          <Text>å¸æœºæ•°é‡: {schedulerContext.systemResources.totalDrivers}</Text>
          <Text>è½¦é˜Ÿé•¿æ•°é‡: {schedulerContext.systemResources.totalManagers}</Text>
          <Text>è½¦è¾†æ•°é‡: {schedulerContext.systemResources.totalVehicles}</Text>
        </View>
      )}

      {/* å¦‚æœæ˜¯ä»…æŸ¥çœ‹æƒé™ï¼Œæ˜¾ç¤ºè°ƒåº¦èŒƒå›´ */}
      {schedulerContext.mode === 'scheduled_resources' && (
        <View>
          <Text>è°ƒåº¦èŒƒå›´:</Text>
          <Text>ç®¡è¾–ä»“åº“: {schedulerContext.managedWarehouses.length}</Text>
          <Text>å…³è”å¸æœº: {schedulerContext.relatedDrivers.length}</Text>
          <Text>å…³è”è½¦è¾†: {schedulerContext.relatedVehicles.length}</Text>
        </View>
      )}

      {/* æ ¹æ®æƒé™çº§åˆ«æ˜¾ç¤ºæ“ä½œæŒ‰é’® */}
      {canEdit ? (
        <Button>ç®¡ç†è°ƒåº¦</Button>
      ) : (
        <Text>æ‚¨åªæœ‰æŸ¥çœ‹æƒé™</Text>
      )}
    </View>
  )
}
```

### 5. è€æ¿/å¹³çº§ç®¡ç†å‘˜ç«¯ä½¿ç”¨

```typescript
import {useAdminPermissionContext} from '@/hooks/usePermissionContext'

function AdminComponent() {
  const adminContext = useAdminPermissionContext()

  if (!adminContext) {
    return <View>æ‚¨ä¸æ˜¯è€æ¿æˆ–å¹³çº§ç®¡ç†å‘˜è§’è‰²</View>
  }

  // æ£€æŸ¥æƒé™çº§åˆ«
  const canEdit = adminContext.level === 'full_control'

  return (
    <View>
      {/* æ˜¾ç¤ºç³»ç»Ÿèµ„æºç»Ÿè®¡ */}
      {adminContext.systemResources && (
        <View>
          <Text>ç³»ç»Ÿæ¦‚è§ˆ:</Text>
          <Text>ä»“åº“æ•°é‡: {adminContext.systemResources.totalWarehouses}</Text>
          <Text>å¸æœºæ•°é‡: {adminContext.systemResources.totalDrivers}</Text>
          <Text>è½¦é˜Ÿé•¿æ•°é‡: {adminContext.systemResources.totalManagers}</Text>
          <Text>è½¦è¾†æ•°é‡: {adminContext.systemResources.totalVehicles}</Text>
        </View>
      )}

      {/* æ ¹æ®æƒé™çº§åˆ«æ˜¾ç¤ºæ“ä½œæŒ‰é’® */}
      {canEdit ? (
        <Button>ç®¡ç†ç³»ç»Ÿ</Button>
      ) : (
        <Text>æ‚¨åªæœ‰æŸ¥çœ‹æƒé™</Text>
      )}
    </View>
  )
}
```

### 5. æƒé™æ£€æŸ¥

```typescript
import {usePermissionContext} from '@/hooks/usePermissionContext'

function ProtectedComponent() {
  const {
    isDriver,
    isManager,
    isAdmin,
    hasFullControl,
    hasViewOnly
  } = usePermissionContext()

  // æ ¹æ®è§’è‰²æ˜¾ç¤ºä¸åŒå†…å®¹
  if (isDriver()) {
    return <DriverView />
  }

  if (isManager()) {
    return <ManagerView />
  }

  if (isAdmin()) {
    return <AdminView />
  }

  // æ ¹æ®æƒé™çº§åˆ«æ˜¾ç¤ºä¸åŒæ“ä½œ
  if (hasFullControl()) {
    return (
      <View>
        <Button>åˆ›å»º</Button>
        <Button>ç¼–è¾‘</Button>
        <Button>åˆ é™¤</Button>
      </View>
    )
  }

  if (hasViewOnly()) {
    return (
      <View>
        <Text>æ‚¨åªæœ‰æŸ¥çœ‹æƒé™</Text>
      </View>
    )
  }

  return <View>æœªçŸ¥æƒé™</View>
}
```

### 6. åˆ·æ–°æƒé™ä¸Šä¸‹æ–‡

```typescript
import {usePermissionContext} from '@/hooks/usePermissionContext'

function RefreshComponent() {
  const {refresh, loading} = usePermissionContext()

  const handleRefresh = async () => {
    await refresh()
    Taro.showToast({
      title: 'æƒé™å·²åˆ·æ–°',
      icon: 'success'
    })
  }

  return (
    <Button onClick={handleRefresh} disabled={loading}>
      {loading ? 'åˆ·æ–°ä¸­...' : 'åˆ·æ–°æƒé™'}
    </Button>
  )
}
```

### 7. æ¸…é™¤æƒé™ä¸Šä¸‹æ–‡ï¼ˆé€€å‡ºç™»å½•æ—¶ï¼‰

```typescript
import {usePermissionContext} from '@/hooks/usePermissionContext'
import {useAuth} from 'miaoda-auth-taro'

function LogoutComponent() {
  const {logout} = useAuth()
  const {clear} = usePermissionContext()

  const handleLogout = async () => {
    // æ¸…é™¤æƒé™ä¸Šä¸‹æ–‡
    clear()
    // é€€å‡ºç™»å½•
    await logout()
    Taro.showToast({
      title: 'å·²é€€å‡ºç™»å½•',
      icon: 'success'
    })
  }

  return (
    <Button onClick={handleLogout}>
      é€€å‡ºç™»å½•
    </Button>
  )
}
```

## ğŸ”’ å®‰å…¨æ€§

### 1. æ•°æ®åº“å±‚é¢
- ä½¿ç”¨ SECURITY DEFINER ç¡®ä¿å‡½æ•°å®‰å…¨æ‰§è¡Œ
- åŸºäº RLS ç­–ç•¥æ§åˆ¶æ•°æ®è®¿é—®
- åªè¿”å›ç”¨æˆ·æœ‰æƒè®¿é—®çš„æ•°æ®

### 2. åº”ç”¨å±‚é¢
- æƒé™ä¸Šä¸‹æ–‡ç¼“å­˜ 30 åˆ†é’Ÿ
- è‡ªåŠ¨åˆ·æ–°è¿‡æœŸçš„æƒé™ä¸Šä¸‹æ–‡
- é€€å‡ºç™»å½•æ—¶è‡ªåŠ¨æ¸…é™¤æƒé™ä¸Šä¸‹æ–‡

### 3. æƒé™éªŒè¯
- å‰ç«¯æƒé™æ£€æŸ¥ï¼ˆç”¨æˆ·ä½“éªŒï¼‰
- åç«¯æƒé™éªŒè¯ï¼ˆå®‰å…¨ä¿éšœï¼‰
- åŒé‡éªŒè¯ç¡®ä¿å®‰å…¨æ€§

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### 1. ç¼“å­˜æœºåˆ¶
- æƒé™ä¸Šä¸‹æ–‡ç¼“å­˜åˆ°æœ¬åœ°å­˜å‚¨
- 30 åˆ†é’Ÿç¼“å­˜æœ‰æ•ˆæœŸ
- é¿å…é‡å¤æŸ¥è¯¢æ•°æ®åº“

### 2. å¹¶è¡ŒæŸ¥è¯¢
- æ•°æ®åº“å‡½æ•°å†…éƒ¨ä½¿ç”¨å¹¶è¡ŒæŸ¥è¯¢
- å‡å°‘æŸ¥è¯¢æ—¶é—´
- æå‡ç”¨æˆ·ä½“éªŒ

### 3. æŒ‰éœ€åŠ è½½
- æ”¯æŒè‡ªåŠ¨åŠ è½½å’Œæ‰‹åŠ¨åŠ è½½
- æ”¯æŒå¼ºåˆ¶åˆ·æ–°
- çµæ´»æ§åˆ¶åŠ è½½æ—¶æœº

## ğŸ› æ•…éšœæ’æŸ¥

### 1. æƒé™ä¸Šä¸‹æ–‡ä¸ºç©º
- æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
- æ£€æŸ¥ç”¨æˆ·è§’è‰²æ˜¯å¦æ­£ç¡®
- æ£€æŸ¥æ•°æ®åº“å‡½æ•°æ˜¯å¦æ­£å¸¸

### 2. æƒé™ä¿¡æ¯ä¸å‡†ç¡®
- å°è¯•åˆ·æ–°æƒé™ä¸Šä¸‹æ–‡
- æ£€æŸ¥æ•°æ®åº“æ•°æ®æ˜¯å¦æ­£ç¡®
- æ£€æŸ¥ RLS ç­–ç•¥æ˜¯å¦æ­£ç¡®

### 3. åŠ è½½å¤±è´¥
- æ£€æŸ¥ç½‘ç»œè¿æ¥
- æ£€æŸ¥ Supabase é…ç½®
- æŸ¥çœ‹æ§åˆ¶å°é”™è¯¯æ—¥å¿—

## ğŸ“ æœ€ä½³å®è·µ

### 1. ç™»å½•åç«‹å³åŠ è½½
```typescript
// åœ¨ App.tsx æˆ–ç™»å½•æˆåŠŸå
const {refresh} = usePermissionContext()
useEffect(() => {
  if (user?.id) {
    refresh()
  }
}, [user])
```

### 2. é€€å‡ºç™»å½•æ—¶æ¸…é™¤
```typescript
// åœ¨é€€å‡ºç™»å½•æ—¶
const {clear} = usePermissionContext()
const handleLogout = () => {
  clear()
  logout()
}
```

### 3. æƒé™å˜æ›´ååˆ·æ–°
```typescript
// åœ¨æƒé™å˜æ›´åï¼ˆå¦‚åˆ†é…ä»“åº“ã€ä¿®æ”¹æƒé™çº§åˆ«ï¼‰
const {refresh} = usePermissionContext()
const handlePermissionChange = async () => {
  // æ‰§è¡Œæƒé™å˜æ›´æ“ä½œ
  await updatePermission()
  // åˆ·æ–°æƒé™ä¸Šä¸‹æ–‡
  await refresh()
}
```

### 4. ä½¿ç”¨ç±»å‹å®‰å…¨çš„Hook
```typescript
// æ¨èï¼šä½¿ç”¨ç±»å‹å®‰å…¨çš„Hook
const driverContext = useDriverPermissionContext()

// ä¸æ¨èï¼šæ‰‹åŠ¨ç±»å‹è½¬æ¢
const {context} = usePermissionContext()
const driverContext = context as DriverPermissionContext
```

## ğŸ”„ æ›´æ–°æ—¥å¿—

### v1.0.0 (2025-12-02)
- âœ… åˆ›å»ºæƒé™ä¸Šä¸‹æ–‡ç±»å‹å®šä¹‰
- âœ… åˆ›å»ºæ•°æ®åº“æƒé™ä¸Šä¸‹æ–‡å‡½æ•°
- âœ… åˆ›å»ºå‰ç«¯æƒé™ä¸Šä¸‹æ–‡API
- âœ… åˆ›å»ºæƒé™ä¸Šä¸‹æ–‡React Hook
- âœ… æ”¯æŒå¸æœºã€è½¦é˜Ÿé•¿ã€è°ƒåº¦ã€è€æ¿/å¹³çº§ç®¡ç†å‘˜å››ç§è§’è‰²
- âœ… æ”¯æŒæƒé™çº§åˆ«åŒºåˆ†ï¼ˆfull_controlã€view_onlyï¼‰
- âœ… æ”¯æŒæƒé™ä¸Šä¸‹æ–‡ç¼“å­˜
- âœ… æ”¯æŒæƒé™ä¸Šä¸‹æ–‡åˆ·æ–°å’Œæ¸…é™¤

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æƒé™ç³»ç»Ÿæ¶æ„](./æƒé™ç³»ç»Ÿæ¶æ„.md)
- [RLSç­–ç•¥è¯´æ˜](./RLSç­–ç•¥è¯´æ˜.md)
- [APIæ–‡æ¡£](./APIæ–‡æ¡£.md)
