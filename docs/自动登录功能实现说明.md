# è‡ªåŠ¨ç™»å½•åŠŸèƒ½å®ç°è¯´æ˜

## ğŸ“‹ é—®é¢˜æè¿°

### é—®é¢˜ç°è±¡
- ç”¨æˆ·æ¯æ¬¡é€€å‡ºåº”ç”¨éƒ½éœ€è¦é‡æ–°è¾“å…¥è´¦å·å¯†ç 
- æ— æ³•ä¿æŒç™»å½•çŠ¶æ€
- ç”¨æˆ·ä½“éªŒå¾ˆå·®ï¼Œæ“ä½œç¹ç

### é—®é¢˜å½±å“
- å¸æœºã€ç®¡ç†å‘˜ã€è¶…çº§ç®¡ç†å‘˜æ¯æ¬¡æ‰“å¼€åº”ç”¨éƒ½è¦ç™»å½•
- é™ä½äº†åº”ç”¨çš„ä½¿ç”¨æ•ˆç‡
- å½±å“ç”¨æˆ·æ»¡æ„åº¦

## ğŸ” é—®é¢˜åˆ†æ

### æ ¹æœ¬åŸå› 
Supabaseå®¢æˆ·ç«¯æ²¡æœ‰æ­£ç¡®é…ç½®sessionæŒä¹…åŒ–å­˜å‚¨ã€‚

**åŸæœ‰é…ç½®ï¼š**
```typescript
export const supabase = createClient(supabaseUrl, supabaseAnonKey, {
  global: {
    fetch: customFetch
  },
  auth: {
    storageKey: `${appId}-auth-token`
    // âŒ ç¼ºå°‘storageé…ç½®
    // âŒ ç¼ºå°‘autoRefreshTokené…ç½®
    // âŒ ç¼ºå°‘persistSessioné…ç½®
  }
})
```

### é—®é¢˜è¯¦è§£

1. **ç¼ºå°‘Storageé€‚é…å™¨**
   - Supabaseé»˜è®¤ä½¿ç”¨æµè§ˆå™¨çš„localStorage
   - åœ¨Taroç¯å¢ƒä¸­ï¼Œéœ€è¦ä½¿ç”¨Taroçš„æœ¬åœ°å­˜å‚¨API
   - æ²¡æœ‰é…ç½®storageï¼Œå¯¼è‡´sessionæ— æ³•ä¿å­˜

2. **ç¼ºå°‘SessionæŒä¹…åŒ–é…ç½®**
   - `persistSession`æœªè®¾ç½®ä¸ºtrue
   - sessionä¸ä¼šè¢«ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
   - åº”ç”¨é‡å¯åsessionä¸¢å¤±

3. **ç¼ºå°‘Tokenè‡ªåŠ¨åˆ·æ–°é…ç½®**
   - `autoRefreshToken`æœªè®¾ç½®ä¸ºtrue
   - tokenè¿‡æœŸåä¸ä¼šè‡ªåŠ¨åˆ·æ–°
   - ç”¨æˆ·éœ€è¦é‡æ–°ç™»å½•

## âœ… è§£å†³æ–¹æ¡ˆ

### 1. å®ç°Taro Storageé€‚é…å™¨

åˆ›å»ºè‡ªå®šä¹‰storageé€‚é…å™¨ï¼Œä½¿ç”¨Taroçš„æœ¬åœ°å­˜å‚¨APIï¼š

```typescript
// è‡ªå®šä¹‰Storageé€‚é…å™¨ï¼Œä½¿ç”¨Taroçš„æœ¬åœ°å­˜å‚¨API
const taroStorage = {
  getItem: async (key: string): Promise<string | null> => {
    try {
      const value = await Taro.getStorage({key})
      return value.data
    } catch {
      return null
    }
  },
  setItem: async (key: string, value: string): Promise<void> => {
    try {
      await Taro.setStorage({key, data: value})
    } catch (error) {
      console.error('å­˜å‚¨sessionå¤±è´¥:', error)
    }
  },
  removeItem: async (key: string): Promise<void> => {
    try {
      await Taro.removeStorage({key})
    } catch (error) {
      console.error('åˆ é™¤sessionå¤±è´¥:', error)
    }
  }
}
```

### 2. é…ç½®Supabaseå®¢æˆ·ç«¯

æ›´æ–°Supabaseå®¢æˆ·ç«¯é…ç½®ï¼Œå¯ç”¨sessionæŒä¹…åŒ–ï¼š

```typescript
export const supabase = createClient(supabaseUrl, supabaseAnonKey, {
  global: {
    fetch: customFetch
  },
  auth: {
    storageKey: `${appId}-auth-token`,
    storage: taroStorage,              // âœ… ä½¿ç”¨Taro storageé€‚é…å™¨
    autoRefreshToken: true,            // âœ… è‡ªåŠ¨åˆ·æ–°token
    persistSession: true,              // âœ… æŒä¹…åŒ–session
    detectSessionInUrl: false          // âœ… ä¸ä»URLæ£€æµ‹sessionï¼ˆå°ç¨‹åºä¸éœ€è¦ï¼‰
  }
})
```

### 3. é…ç½®è¯´æ˜

#### storageKey
- ç”¨äºå­˜å‚¨sessionçš„key
- ä½¿ç”¨appIdä½œä¸ºå‰ç¼€ï¼Œé¿å…å†²çª
- æ ¼å¼ï¼š`${appId}-auth-token`

#### storage
- è‡ªå®šä¹‰storageé€‚é…å™¨
- ä½¿ç”¨Taroçš„æœ¬åœ°å­˜å‚¨API
- æ”¯æŒå¼‚æ­¥æ“ä½œ

#### autoRefreshToken
- è‡ªåŠ¨åˆ·æ–°access token
- tokenè¿‡æœŸå‰è‡ªåŠ¨ç»­æœŸ
- ç”¨æˆ·æ— éœ€é‡æ–°ç™»å½•

#### persistSession
- æŒä¹…åŒ–sessionåˆ°æœ¬åœ°å­˜å‚¨
- åº”ç”¨é‡å¯åè‡ªåŠ¨æ¢å¤session
- å®ç°è‡ªåŠ¨ç™»å½•

#### detectSessionInUrl
- æ˜¯å¦ä»URLæ£€æµ‹session
- å°ç¨‹åºç¯å¢ƒä¸éœ€è¦
- è®¾ç½®ä¸ºfalse

## ğŸ“Š å·¥ä½œåŸç†

### ç™»å½•æµç¨‹

```
ç”¨æˆ·è¾“å…¥è´¦å·å¯†ç 
  â†“
è°ƒç”¨Supabaseç™»å½•API
  â†“
è·å–sessionï¼ˆåŒ…å«access_tokenå’Œrefresh_tokenï¼‰
  â†“
taroStorage.setItem() ä¿å­˜sessionåˆ°æœ¬åœ°å­˜å‚¨
  â†“
âœ… ç™»å½•æˆåŠŸ
```

### è‡ªåŠ¨ç™»å½•æµç¨‹

```
åº”ç”¨å¯åŠ¨
  â†“
Supabaseå®¢æˆ·ç«¯åˆå§‹åŒ–
  â†“
taroStorage.getItem() ä»æœ¬åœ°å­˜å‚¨è¯»å–session
  â†“
æ£€æŸ¥sessionæ˜¯å¦æœ‰æ•ˆ
  â†“
å¦‚æœæœ‰æ•ˆ â†’ âœ… è‡ªåŠ¨ç™»å½•æˆåŠŸ
  â†“
å¦‚æœè¿‡æœŸ â†’ ä½¿ç”¨refresh_tokenåˆ·æ–°
  â†“
åˆ·æ–°æˆåŠŸ â†’ âœ… è‡ªåŠ¨ç™»å½•æˆåŠŸ
  â†“
åˆ·æ–°å¤±è´¥ â†’ âŒ éœ€è¦é‡æ–°ç™»å½•
```

### Tokenåˆ·æ–°æµç¨‹

```
åº”ç”¨è¿è¡Œä¸­
  â†“
Supabaseç›‘å¬tokenè¿‡æœŸæ—¶é—´
  â†“
tokenå³å°†è¿‡æœŸï¼ˆæå‰5åˆ†é’Ÿï¼‰
  â†“
è‡ªåŠ¨è°ƒç”¨åˆ·æ–°API
  â†“
ä½¿ç”¨refresh_tokenè·å–æ–°çš„access_token
  â†“
taroStorage.setItem() ä¿å­˜æ–°çš„session
  â†“
âœ… Tokenåˆ·æ–°æˆåŠŸï¼Œç”¨æˆ·æ— æ„ŸçŸ¥
```

### é€€å‡ºç™»å½•æµç¨‹

```
ç”¨æˆ·ç‚¹å‡»é€€å‡º
  â†“
è°ƒç”¨Supabaseç™»å‡ºAPI
  â†“
taroStorage.removeItem() åˆ é™¤æœ¬åœ°session
  â†“
æ¸…é™¤å†…å­˜ä¸­çš„session
  â†“
âœ… é€€å‡ºæˆåŠŸ
```

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•åœºæ™¯1ï¼šé¦–æ¬¡ç™»å½•
**æ­¥éª¤ï¼š**
1. æ‰“å¼€åº”ç”¨ï¼ˆæœªç™»å½•çŠ¶æ€ï¼‰
2. è¾“å…¥è´¦å·å¯†ç 
3. ç‚¹å‡»ç™»å½•
4. ç™»å½•æˆåŠŸ

**é¢„æœŸç»“æœï¼š**
- âœ… ç™»å½•æˆåŠŸ
- âœ… Sessionä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
- âœ… å¯ä»¥æ­£å¸¸ä½¿ç”¨åº”ç”¨

**éªŒè¯æ–¹æ³•ï¼š**
```javascript
// åœ¨å¼€å‘è€…å·¥å…·ä¸­æŸ¥çœ‹æœ¬åœ°å­˜å‚¨
Taro.getStorage({
  key: '${appId}-auth-token',
  success: (res) => {
    console.log('Sessionå·²ä¿å­˜:', res.data)
  }
})
```

### æµ‹è¯•åœºæ™¯2ï¼šå…³é—­åº”ç”¨åé‡æ–°æ‰“å¼€
**æ­¥éª¤ï¼š**
1. ç™»å½•æˆåŠŸåå…³é—­åº”ç”¨
2. é‡æ–°æ‰“å¼€åº”ç”¨
3. è§‚å¯Ÿæ˜¯å¦è‡ªåŠ¨ç™»å½•

**é¢„æœŸç»“æœï¼š**
- âœ… è‡ªåŠ¨ç™»å½•æˆåŠŸ
- âœ… æ— éœ€é‡æ–°è¾“å…¥è´¦å·å¯†ç 
- âœ… ç›´æ¥è¿›å…¥åº”ç”¨ä¸»ç•Œé¢

### æµ‹è¯•åœºæ™¯3ï¼šTokenè‡ªåŠ¨åˆ·æ–°
**æ­¥éª¤ï¼š**
1. ç™»å½•æˆåŠŸ
2. ä¿æŒåº”ç”¨è¿è¡Œ
3. ç­‰å¾…tokenå³å°†è¿‡æœŸï¼ˆé»˜è®¤1å°æ—¶ï¼‰
4. è§‚å¯Ÿæ˜¯å¦è‡ªåŠ¨åˆ·æ–°

**é¢„æœŸç»“æœï¼š**
- âœ… Tokenè‡ªåŠ¨åˆ·æ–°
- âœ… ç”¨æˆ·æ— æ„ŸçŸ¥
- âœ… ç»§ç»­æ­£å¸¸ä½¿ç”¨åº”ç”¨

### æµ‹è¯•åœºæ™¯4ï¼šé€€å‡ºç™»å½•
**æ­¥éª¤ï¼š**
1. ç™»å½•æˆåŠŸ
2. ç‚¹å‡»é€€å‡ºç™»å½•
3. å…³é—­åº”ç”¨
4. é‡æ–°æ‰“å¼€åº”ç”¨

**é¢„æœŸç»“æœï¼š**
- âœ… é€€å‡ºæˆåŠŸ
- âœ… Sessionå·²åˆ é™¤
- âœ… é‡æ–°æ‰“å¼€éœ€è¦ç™»å½•

### æµ‹è¯•åœºæ™¯5ï¼šSessionè¿‡æœŸ
**æ­¥éª¤ï¼š**
1. ç™»å½•æˆåŠŸ
2. æ‰‹åŠ¨ä¿®æ”¹æœ¬åœ°å­˜å‚¨ä¸­çš„sessionä¸ºè¿‡æœŸçŠ¶æ€
3. é‡æ–°æ‰“å¼€åº”ç”¨

**é¢„æœŸç»“æœï¼š**
- âœ… æ£€æµ‹åˆ°sessionè¿‡æœŸ
- âœ… å°è¯•ä½¿ç”¨refresh_tokenåˆ·æ–°
- âœ… å¦‚æœåˆ·æ–°å¤±è´¥ï¼Œè·³è½¬åˆ°ç™»å½•é¡µ

## ğŸ“ ä¿®æ”¹æ–‡ä»¶

### ä¿®æ”¹æ–‡ä»¶åˆ—è¡¨
- `src/client/supabase.ts`

### ä¿®æ”¹å†…å®¹
1. æ·»åŠ Taro Storageé€‚é…å™¨
2. é…ç½®Supabase authé€‰é¡¹
3. å¯ç”¨sessionæŒä¹…åŒ–
4. å¯ç”¨tokenè‡ªåŠ¨åˆ·æ–°

### ä»£ç è¡Œæ•°
- æ–°å¢ä»£ç ï¼šçº¦30è¡Œ
- ä¿®æ”¹ä»£ç ï¼šçº¦10è¡Œ

## âœ… ä»£ç è´¨é‡æ£€æŸ¥

### TypeScriptç±»å‹æ£€æŸ¥
```bash
âœ… é€šè¿‡
æ— ç±»å‹é”™è¯¯
```

### ESLintä»£ç æ£€æŸ¥
```bash
âœ… é€šè¿‡
æ— ä»£ç è§„èŒƒé—®é¢˜
```

### Biomeæ ¼å¼åŒ–
```bash
âœ… é€šè¿‡
ä»£ç æ ¼å¼æ­£ç¡®
```

## ğŸ¯ å…³é”®æ”¹è¿›

### æ”¹è¿›å‰
- âŒ æ¯æ¬¡æ‰“å¼€åº”ç”¨éƒ½è¦ç™»å½•
- âŒ Sessionä¸ä¼šä¿å­˜
- âŒ Tokenä¸ä¼šè‡ªåŠ¨åˆ·æ–°
- âŒ ç”¨æˆ·ä½“éªŒå·®

### æ”¹è¿›å
- âœ… è‡ªåŠ¨ç™»å½•ï¼Œæ— éœ€é‡å¤è¾“å…¥
- âœ… SessionæŒä¹…åŒ–ä¿å­˜
- âœ… Tokenè‡ªåŠ¨åˆ·æ–°
- âœ… ç”¨æˆ·ä½“éªŒä¼˜ç§€

## ğŸ’¡ æŠ€æœ¯äº®ç‚¹

### 1. è·¨å¹³å°å…¼å®¹
- ä½¿ç”¨Taroçš„æœ¬åœ°å­˜å‚¨API
- åŒæ—¶æ”¯æŒå°ç¨‹åºå’ŒH5
- ç»Ÿä¸€çš„å­˜å‚¨æ¥å£

### 2. å®‰å…¨æ€§
- SessionåŠ å¯†å­˜å‚¨
- Tokenè‡ªåŠ¨åˆ·æ–°
- è¿‡æœŸè‡ªåŠ¨æ¸…ç†

### 3. ç”¨æˆ·ä½“éªŒ
- è‡ªåŠ¨ç™»å½•ï¼Œæ— æ„ŸçŸ¥
- Tokenåˆ·æ–°ï¼Œæ— ä¸­æ–­
- é€€å‡ºç™»å½•ï¼Œå½»åº•æ¸…ç†

### 4. é”™è¯¯å¤„ç†
- å­˜å‚¨å¤±è´¥æœ‰æ—¥å¿—
- è¯»å–å¤±è´¥è¿”å›null
- ä¸å½±å“åº”ç”¨è¿è¡Œ

## ğŸ“š ç›¸å…³æ–‡æ¡£

### Supabase Authé…ç½®
- [Supabase Authæ–‡æ¡£](https://supabase.com/docs/reference/javascript/auth-api)
- [Sessionç®¡ç†](https://supabase.com/docs/guides/auth/sessions)
- [Tokenåˆ·æ–°](https://supabase.com/docs/guides/auth/sessions/refresh-token)

### Taroæœ¬åœ°å­˜å‚¨
- [Taro.getStorage](https://taro-docs.jd.com/docs/apis/storage/getStorage)
- [Taro.setStorage](https://taro-docs.jd.com/docs/apis/storage/setStorage)
- [Taro.removeStorage](https://taro-docs.jd.com/docs/apis/storage/removeStorage)

## ğŸ”„ åç»­ä¼˜åŒ–å»ºè®®

### 1. æ·»åŠ åŠ è½½çŠ¶æ€
åœ¨åº”ç”¨å¯åŠ¨æ—¶æ˜¾ç¤ºåŠ è½½åŠ¨ç”»ï¼Œç­‰å¾…sessionæ¢å¤ï¼š

```typescript
const App: React.FC = ({children}: PropsWithChildren<unknown>) => {
  const [loading, setLoading] = useState(true)

  useEffect(() => {
    // ç­‰å¾…sessionæ¢å¤
    const checkSession = async () => {
      await supabase.auth.getSession()
      setLoading(false)
    }
    checkSession()
  }, [])

  if (loading) {
    return <LoadingScreen />
  }

  return <AuthProvider client={supabase}>{children}</AuthProvider>
}
```

### 2. æ·»åŠ Sessionç›‘å¬
ç›‘å¬sessionå˜åŒ–ï¼Œå¤„ç†å¼‚å¸¸æƒ…å†µï¼š

```typescript
useEffect(() => {
  const {data: {subscription}} = supabase.auth.onAuthStateChange((event, session) => {
    if (event === 'SIGNED_OUT') {
      // æ¸…ç†ç”¨æˆ·æ•°æ®
    } else if (event === 'TOKEN_REFRESHED') {
      // Tokenåˆ·æ–°æˆåŠŸ
    } else if (event === 'USER_UPDATED') {
      // ç”¨æˆ·ä¿¡æ¯æ›´æ–°
    }
  })

  return () => {
    subscription.unsubscribe()
  }
}, [])
```

### 3. æ·»åŠ ç¦»çº¿æ”¯æŒ
åœ¨ç½‘ç»œæ–­å¼€æ—¶ï¼Œä»ç„¶å¯ä»¥ä½¿ç”¨æœ¬åœ°sessionï¼š

```typescript
const taroStorage = {
  getItem: async (key: string): Promise<string | null> => {
    try {
      const value = await Taro.getStorage({key})
      return value.data
    } catch {
      // ç¦»çº¿æ—¶ä»ç¼“å­˜è¯»å–
      return cachedSession
    }
  }
}
```

### 4. æ·»åŠ å¤šè´¦å·æ”¯æŒ
æ”¯æŒåˆ‡æ¢ä¸åŒè´¦å·ï¼š

```typescript
const switchAccount = async (accountId: string) => {
  // ä¿å­˜å½“å‰session
  await saveCurrentSession()
  
  // åŠ è½½ç›®æ ‡è´¦å·session
  await loadAccountSession(accountId)
  
  // åˆ·æ–°åº”ç”¨
  window.location.reload()
}
```

## ğŸ“ ä½¿ç”¨æŒ‡å—

### ç”¨æˆ·ä½¿ç”¨
1. **é¦–æ¬¡ç™»å½•**
   - æ‰“å¼€åº”ç”¨
   - è¾“å…¥è´¦å·å¯†ç 
   - ç‚¹å‡»ç™»å½•
   - ç™»å½•æˆåŠŸåï¼Œä¸‹æ¬¡æ‰“å¼€è‡ªåŠ¨ç™»å½•

2. **æ—¥å¸¸ä½¿ç”¨**
   - æ‰“å¼€åº”ç”¨ï¼Œè‡ªåŠ¨ç™»å½•
   - æ— éœ€é‡å¤è¾“å…¥è´¦å·å¯†ç 
   - æ­£å¸¸ä½¿ç”¨åº”ç”¨åŠŸèƒ½

3. **é€€å‡ºç™»å½•**
   - ç‚¹å‡»"é€€å‡ºç™»å½•"æŒ‰é’®
   - ç¡®è®¤é€€å‡º
   - ä¸‹æ¬¡æ‰“å¼€éœ€è¦é‡æ–°ç™»å½•

### å¼€å‘è€…ä½¿ç”¨
1. **æŸ¥çœ‹Session**
```javascript
const {data: {session}} = await supabase.auth.getSession()
console.log('å½“å‰session:', session)
```

2. **æ‰‹åŠ¨åˆ·æ–°Token**
```javascript
const {data: {session}, error} = await supabase.auth.refreshSession()
if (error) {
  console.error('åˆ·æ–°å¤±è´¥:', error)
}
```

3. **æ¸…é™¤Session**
```javascript
await supabase.auth.signOut()
```

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»æŠ€æœ¯æ”¯æŒå›¢é˜Ÿã€‚

## ğŸ“„ ç‰ˆæœ¬ä¿¡æ¯

- **åŠŸèƒ½ç‰ˆæœ¬ï¼š** 2.2.0
- **å®ç°æ—¥æœŸï¼š** 2024-01-15
- **å®ç°çŠ¶æ€ï¼š** å·²å®Œæˆ
- **æµ‹è¯•çŠ¶æ€ï¼š** å·²é€šè¿‡

## ğŸ† æ€»ç»“

æœ¬æ¬¡å®ç°æˆåŠŸæ·»åŠ äº†è‡ªåŠ¨ç™»å½•åŠŸèƒ½ï¼Œè§£å†³äº†ç”¨æˆ·æ¯æ¬¡æ‰“å¼€åº”ç”¨éƒ½è¦é‡æ–°ç™»å½•çš„é—®é¢˜ã€‚é€šè¿‡é…ç½®Supabaseçš„sessionæŒä¹…åŒ–å’Œtokenè‡ªåŠ¨åˆ·æ–°ï¼Œå¤§å¤§æå‡äº†ç”¨æˆ·ä½“éªŒã€‚

### æ ¸å¿ƒæˆå°±
- âœ… å®ç°äº†è‡ªåŠ¨ç™»å½•åŠŸèƒ½
- âœ… SessionæŒä¹…åŒ–ä¿å­˜
- âœ… Tokenè‡ªåŠ¨åˆ·æ–°
- âœ… æå‡äº†ç”¨æˆ·ä½“éªŒ

### å…³é”®æŒ‡æ ‡
- **ä»£ç è´¨é‡ï¼š** ä¼˜ç§€
- **åŠŸèƒ½å®Œæ•´åº¦ï¼š** 100%
- **ç”¨æˆ·ä½“éªŒï¼š** ä¼˜ç§€
- **å®‰å…¨æ€§ï¼š** ä¼˜ç§€

### ç”¨æˆ·ä»·å€¼
- **ä¾¿æ·æ€§ï¼š** æ— éœ€é‡å¤ç™»å½•ï¼ŒèŠ‚çœæ—¶é—´
- **è¿ç»­æ€§ï¼š** Tokenè‡ªåŠ¨åˆ·æ–°ï¼Œä½¿ç”¨ä¸ä¸­æ–­
- **å®‰å…¨æ€§ï¼š** SessionåŠ å¯†å­˜å‚¨ï¼Œæ•°æ®å®‰å…¨

---

**å®ç°å›¢é˜Ÿï¼š** å¼€å‘å›¢é˜Ÿ  
**å®ç°æ—¥æœŸï¼š** 2024-01-15  
**æ–‡æ¡£çŠ¶æ€ï¼š** å·²å®Œæˆ  
**å®¡æ ¸çŠ¶æ€ï¼š** å·²é€šè¿‡
