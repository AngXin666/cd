# 超级管理员权限修复说明

## 一、问题描述

### 1.1 问题现象
超级管理员无法看到审批记录，包括：
- 无法查看历史审批数据
- 无法查看实时数据
- 只能看到未分配管理员的仓库的申请

### 1.2 问题原因
数据库RLS（Row Level Security）策略限制了超级管理员的查看权限。

**原有策略：**
```sql
-- 超级管理员只能查看未分配管理员的仓库的申请
CREATE POLICY "Super admins can view unassigned warehouse leave applications" 
ON leave_applications
FOR SELECT USING (
    is_super_admin(auth.uid()) 
    AND is_draft = false
    AND NOT EXISTS (
        SELECT 1 FROM manager_warehouses mw
        WHERE mw.warehouse_id = leave_applications.warehouse_id
    )
);
```

这个策略导致超级管理员无法查看已分配管理员的仓库的申请记录。

## 二、解决方案

### 2.1 修复策略
修改RLS策略，允许超级管理员查看所有非草稿申请。

**新策略：**
```sql
-- 超级管理员可以查看所有非草稿申请
CREATE POLICY "Super admins can view all leave applications" 
ON leave_applications
FOR SELECT USING (
    is_super_admin(auth.uid()) 
    AND is_draft = false
);
```

### 2.2 权限规则

#### 超级管理员权限
**查看权限：**
- ✅ 可以查看所有非草稿申请（包括历史和实时数据）
- ✅ 可以查看所有仓库的申请（无论是否分配管理员）
- ✅ 可以查看所有状态的申请（待审批、已通过、已驳回）

**审批权限：**
- ✅ 可以审批未分配管理员的仓库的申请
- ❌ 不能审批已分配管理员的仓库的申请（保持原有限制）

#### 普通管理员权限
**查看权限：**
- ✅ 可以查看自己管辖仓库的非草稿申请
- ❌ 不能查看其他仓库的申请

**审批权限：**
- ✅ 可以审批自己管辖仓库的申请
- ❌ 不能审批其他仓库的申请

## 三、实施步骤

### 3.1 数据库迁移
执行以下SQL迁移脚本：

**文件：** `supabase/migrations/fix_super_admin_view_all_applications.sql`

**内容：**
1. 删除原有的超级管理员限制性查看策略
2. 创建新的超级管理员全局查看策略
3. 保持超级管理员的审批权限限制

### 3.2 应用更新
使用`supabase_apply_migration`工具应用迁移：

```typescript
await supabase_apply_migration({
  name: 'fix_super_admin_view_all_applications',
  query: '...' // SQL内容
})
```

## 四、验证测试

### 4.1 测试场景

#### 场景1：超级管理员查看所有申请
**步骤：**
1. 使用超级管理员账号登录
2. 进入请假审批管理页面
3. 查看司机列表

**预期结果：**
- ✅ 可以看到所有仓库的司机
- ✅ 可以看到所有司机的请假统计
- ✅ 可以点击查看司机的详细记录

#### 场景2：超级管理员查看已分配管理员的仓库
**步骤：**
1. 使用超级管理员账号登录
2. 选择已分配管理员的仓库
3. 查看该仓库下的司机

**预期结果：**
- ✅ 可以看到该仓库下的所有司机
- ✅ 可以看到司机的请假统计
- ✅ 可以查看司机的详细记录
- ✅ 可以看到所有审批历史

#### 场景3：超级管理员查看历史审批记录
**步骤：**
1. 使用超级管理员账号登录
2. 进入司机详情页
3. 查看已审批的申请

**预期结果：**
- ✅ 可以看到所有已审批的申请
- ✅ 可以看到审批人信息
- ✅ 可以看到审批时间
- ✅ 可以看到审批意见

#### 场景4：超级管理员审批权限
**步骤：**
1. 使用超级管理员账号登录
2. 查看未分配管理员的仓库的待审批申请
3. 尝试审批

**预期结果：**
- ✅ 可以审批未分配管理员的仓库的申请
- ✅ 审批成功后记录审批人和时间

**步骤：**
1. 使用超级管理员账号登录
2. 查看已分配管理员的仓库的待审批申请
3. 尝试审批

**预期结果：**
- ❌ 不能审批已分配管理员的仓库的申请（保持原有限制）

### 4.2 测试结果
- ✅ 超级管理员可以查看所有申请记录
- ✅ 超级管理员可以查看历史审批数据
- ✅ 超级管理员可以查看实时数据
- ✅ 审批权限限制正常工作

## 五、影响范围

### 5.1 受影响的功能
- ✅ 超级管理员请假审批管理页面
- ✅ 超级管理员司机详情页面
- ✅ 数据库查询API

### 5.2 不受影响的功能
- ✅ 普通管理员请假审批管理页面
- ✅ 司机请假申请功能
- ✅ 其他管理功能

## 六、技术细节

### 6.1 RLS策略对比

#### 修复前
```sql
-- 请假申请表
CREATE POLICY "Super admins can view unassigned warehouse leave applications" 
ON leave_applications
FOR SELECT USING (
    is_super_admin(auth.uid()) 
    AND is_draft = false
    AND NOT EXISTS (
        SELECT 1 FROM manager_warehouses mw
        WHERE mw.warehouse_id = leave_applications.warehouse_id
    )
);

-- 离职申请表
CREATE POLICY "Super admins can view unassigned warehouse resignation applications" 
ON resignation_applications
FOR SELECT USING (
    is_super_admin(auth.uid()) 
    AND is_draft = false
    AND NOT EXISTS (
        SELECT 1 FROM manager_warehouses mw
        WHERE mw.warehouse_id = resignation_applications.warehouse_id
    )
);
```

#### 修复后
```sql
-- 请假申请表
CREATE POLICY "Super admins can view all leave applications" 
ON leave_applications
FOR SELECT USING (
    is_super_admin(auth.uid()) 
    AND is_draft = false
);

-- 离职申请表
CREATE POLICY "Super admins can view all resignation applications" 
ON resignation_applications
FOR SELECT USING (
    is_super_admin(auth.uid()) 
    AND is_draft = false
);
```

### 6.2 关键变化
1. **删除了仓库限制**：移除了`NOT EXISTS`子查询
2. **保持草稿过滤**：仍然只显示非草稿申请
3. **保持审批限制**：审批权限策略未修改

### 6.3 安全考虑
- ✅ 草稿仍然只能由创建者查看
- ✅ 超级管理员不能审批已分配管理员的仓库
- ✅ 普通管理员权限不受影响
- ✅ 司机权限不受影响

## 七、后续优化建议

### 7.1 功能优化
1. **审批权限提示**
   - 在超级管理员查看已分配管理员的仓库时，提示无法审批
   - 显示该仓库的管理员信息

2. **数据统计优化**
   - 区分可审批和不可审批的申请
   - 显示不同仓库的审批权限状态

3. **审批流程优化**
   - 支持超级管理员临时接管审批权限
   - 支持审批权限转移

### 7.2 监控和日志
1. **审批日志**
   - 记录所有审批操作
   - 记录权限检查结果

2. **权限审计**
   - 定期审计权限配置
   - 检查异常访问

## 八、总结

### 8.1 问题解决
- ✅ 修复了超级管理员无法查看审批记录的问题
- ✅ 超级管理员现在可以查看所有历史和实时数据
- ✅ 保持了原有的审批权限限制

### 8.2 核心价值
1. **数据可见性**：超级管理员可以查看所有数据
2. **权限控制**：保持了合理的审批权限限制
3. **安全性**：草稿和其他敏感数据仍受保护
4. **一致性**：与用户需求保持一致

### 8.3 技术亮点
1. **数据库层面控制**：使用RLS策略确保安全
2. **最小化修改**：只修改必要的策略
3. **向后兼容**：不影响现有功能
4. **可维护性**：清晰的策略命名和注释

---

**修复日期：** 2024-01-15  
**修复版本：** 2.1  
**影响范围：** 超级管理员查看权限  
**测试状态：** 已验证
