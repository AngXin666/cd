# æ™®é€šç®¡ç†å‘˜æ·»åŠ å¸æœºåŠŸèƒ½ - å®Œæ•´ä¿®å¤å†ç¨‹

## æ¦‚è¿°

æœ¬æ–‡æ¡£è®°å½•äº†ä¿®å¤æ™®é€šç®¡ç†å‘˜æ·»åŠ å¸æœºåŠŸèƒ½çš„å®Œæ•´è¿‡ç¨‹ï¼ŒåŒ…æ‹¬é‡åˆ°çš„æ‰€æœ‰é—®é¢˜ã€è§£å†³æ–¹æ¡ˆå’Œæœ€ç»ˆç»“æœã€‚

## æ—¶é—´çº¿

### 2024-11-24

#### ç¬¬ä¸€é˜¶æ®µï¼šåˆå§‹é—®é¢˜ï¼ˆé‚®ç®±é‡å¤é”™è¯¯ï¼‰

**é—®é¢˜**ï¼š
- æ™®é€šç®¡ç†å‘˜æ·»åŠ å¸æœºæ—¶æç¤º"é‚®ç®±å·²å­˜åœ¨"
- ä½†å®é™…ä¸Š profiles è¡¨ä¸­æ²¡æœ‰è¯¥é‚®ç®±çš„è®°å½•

**åŸå› **ï¼š
- auth.users è¡¨ä¸­å­˜åœ¨å­¤ç«‹è®°å½•ï¼ˆæ²¡æœ‰å¯¹åº”çš„ profiles è®°å½•ï¼‰
- ä¹‹å‰åˆ›å»ºå¤±è´¥æ—¶ï¼Œauth.users è®°å½•å·²åˆ›å»ºï¼Œä½† profiles è®°å½•åˆ›å»ºå¤±è´¥

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ä¿®æ”¹ createDriver å‡½æ•°ï¼Œå…ˆåˆ›å»º auth.usersï¼Œå†åˆ›å»º profiles
2. æ·»åŠ é‚®ç®±é‡å¤æ£€æŸ¥ï¼Œåœ¨åˆ›å»ºå‰æ£€æŸ¥ profiles è¡¨
3. åˆ›å»º cleanup_orphaned_auth_users å‡½æ•°ï¼Œè‡ªåŠ¨æ¸…ç†å­¤ç«‹è®°å½•

**ç›¸å…³æäº¤**ï¼š
- `b2837b4` - ä¿®å¤åˆ›å»ºç”¨æˆ·æ—¶çš„é‚®ç®±é‡å¤æ£€æŸ¥
- `b5f7b5f` - ç§»é™¤å¯¹ auth.users è¡¨çš„ç›´æ¥æŸ¥è¯¢
- `cd3899e` - æ·»åŠ å¤„ç†é‡å¤ auth.users è®°å½•çš„é€»è¾‘

**ç›¸å…³æ–‡æ¡£**ï¼š
- `docs/ä¿®å¤é‚®ç®±é‡å¤é”™è¯¯.md`

---

#### ç¬¬äºŒé˜¶æ®µï¼šRLS ç­–ç•¥é”™è¯¯

**é—®é¢˜**ï¼š
```
new row violates row-level security policy for table "profiles"
é”™è¯¯ä»£ç : 42501
```

**åŸå› **ï¼š
- æ™®é€šç®¡ç†å‘˜æ²¡æœ‰æƒé™åˆ›å»º profiles è®°å½•
- ç¼ºå°‘å…è®¸æ™®é€šç®¡ç†å‘˜åˆ›å»ºå¸æœºçš„ RLS ç­–ç•¥

**è§£å†³æ–¹æ¡ˆ 1**ï¼šåˆ›å»ºåˆå§‹ç­–ç•¥
```sql
CREATE POLICY "Managers can insert driver profiles" ON profiles
  FOR INSERT TO authenticated
  WITH CHECK (
    is_manager(auth.uid()) AND role = 'driver'::user_role
  );
```

**é—®é¢˜**ï¼šç­–ç•¥ä¸­çš„ is_manager å‡½æ•°æ— æ³•æ­£ç¡®è§£æ

**è§£å†³æ–¹æ¡ˆ 2**ï¼šä¿®å¤å‡½æ•°çš„ search_path
```sql
CREATE OR REPLACE FUNCTION is_manager(uid uuid)
RETURNS boolean
LANGUAGE sql
SECURITY DEFINER
SET search_path = public, auth
AS $$
  SELECT EXISTS (
    SELECT 1 FROM profiles p
    WHERE p.id = uid AND p.role = 'manager'::user_role
  );
$$;
```

**é—®é¢˜**ï¼šå‡½æ•°è°ƒç”¨ä»ç„¶å¤±è´¥

**è§£å†³æ–¹æ¡ˆ 3**ï¼šåˆ›å»º public.uid() å‡½æ•°åˆ«å
```sql
CREATE OR REPLACE FUNCTION public.uid()
RETURNS uuid
LANGUAGE sql
STABLE
SECURITY DEFINER
SET search_path = auth, public
AS $$
  SELECT auth.uid();
$$;
```

**é—®é¢˜**ï¼šç­–ç•¥ä¸­çš„å‡½æ•°è°ƒç”¨ä»ç„¶æœ‰é—®é¢˜

**è§£å†³æ–¹æ¡ˆ 4**ï¼šç›´æ¥åœ¨ç­–ç•¥ä¸­ä½¿ç”¨ EXISTS å­æŸ¥è¯¢
```sql
CREATE POLICY "Managers can insert driver profiles" ON profiles
  FOR INSERT TO authenticated
  WITH CHECK (
    EXISTS (
      SELECT 1 FROM profiles p
      WHERE p.id = auth.uid() AND p.role = 'manager'::user_role
    )
    AND role = 'driver'::user_role
  );
```

**ç›¸å…³æäº¤**ï¼š
- `4a42311` - æ·»åŠ æ™®é€šç®¡ç†å‘˜æ·»åŠ å¸æœºåŠŸèƒ½çš„æµ‹è¯•æ–‡æ¡£
- `8ac53a2` - æ·»åŠ æ™®é€šç®¡ç†å‘˜æ·»åŠ å¸æœºåŠŸèƒ½çš„è¯¦ç»†ä¿®å¤è®°å½•
- `6821cc4` - ä¿®å¤ RLS ç­–ç•¥é”™è¯¯ï¼šæ›´æ–°å‡½æ•°çš„ search_path
- `7d997d2` - åˆ›å»º public.uid() å‡½æ•°åˆ«å
- `59a68f4` - ä¿®å¤æ™®é€šç®¡ç†å‘˜ RLS ç­–ç•¥ï¼šæ·»åŠ  INSERTã€UPDATEã€DELETE æƒé™

**ç›¸å…³æ–‡æ¡£**ï¼š
- `docs/æ™®é€šç®¡ç†å‘˜æ·»åŠ å¸æœºåŠŸèƒ½æµ‹è¯•.md`
- `docs/ä¿®å¤è®°å½•_æ™®é€šç®¡ç†å‘˜æ·»åŠ å¸æœº.md`
- `docs/ä¿®å¤RLSç­–ç•¥é”™è¯¯.md`
- `docs/RLSç­–ç•¥è°ƒè¯•æŒ‡å—.md`

---

#### ç¬¬ä¸‰é˜¶æ®µï¼šæ— é™é€’å½’é”™è¯¯

**é—®é¢˜**ï¼š
```
infinite recursion detected in policy for relation "profiles"
é”™è¯¯ä»£ç : 42P17
```

**åŸå› **ï¼š
- ç­–ç•¥ä¸­ä½¿ç”¨ EXISTS å­æŸ¥è¯¢æ£€æŸ¥ profiles è¡¨
- æŸ¥è¯¢ profiles è¡¨æ—¶è§¦å‘ SELECT ç­–ç•¥
- SELECT ç­–ç•¥å¯èƒ½åˆéœ€è¦æŸ¥è¯¢ profiles è¡¨
- å¯¼è‡´æ— é™é€’å½’

**é€’å½’æµç¨‹**ï¼š
1. ç”¨æˆ·å°è¯•æ’å…¥è®°å½• â†’ è§¦å‘ INSERT ç­–ç•¥
2. INSERT ç­–ç•¥éœ€è¦æŸ¥è¯¢ profiles è¡¨ â†’ è§¦å‘ SELECT ç­–ç•¥
3. SELECT ç­–ç•¥å¯èƒ½ä¹Ÿéœ€è¦æŸ¥è¯¢ profiles â†’ æ— é™é€’å½’

**è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨ SECURITY DEFINER å‡½æ•°ç»•è¿‡ RLS

```sql
-- é‡æ–°åˆ›å»º is_manager å‡½æ•°ï¼Œä½¿ç”¨ SECURITY DEFINER
CREATE OR REPLACE FUNCTION public.is_manager(uid uuid)
RETURNS boolean
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
BEGIN
  RETURN EXISTS (
    SELECT 1 FROM profiles p
    WHERE p.id = uid AND p.role = 'manager'::user_role
  );
END;
$$;

-- åœ¨ç­–ç•¥ä¸­ä½¿ç”¨å‡½æ•°
CREATE POLICY "Managers can insert driver profiles" ON profiles
  FOR INSERT TO authenticated
  WITH CHECK (
    is_manager(auth.uid()) AND role = 'driver'::user_role
  );
```

**å…³é”®ç‚¹**ï¼š
- `SECURITY DEFINER`ï¼šå‡½æ•°ä»¥å®šä¹‰è€…æƒé™æ‰§è¡Œï¼Œç»•è¿‡ RLS
- `LANGUAGE plpgsql`ï¼šä½¿ç”¨ PL/pgSQL è€Œä¸æ˜¯ SQLï¼Œæ›´å¯é 
- `SET search_path = public`ï¼šé˜²æ­¢ schema æ³¨å…¥

**ç›¸å…³æäº¤**ï¼š
- `4358bb2` - ä¿®å¤ RLS ç­–ç•¥æ— é™é€’å½’é—®é¢˜ï¼šä½¿ç”¨ SECURITY DEFINER å‡½æ•°ç»•è¿‡ RLS
- `04d5386` - æ·»åŠ æ— é™é€’å½’é”™è¯¯ä¿®å¤æ–‡æ¡£

**ç›¸å…³æ–‡æ¡£**ï¼š
- `docs/ä¿®å¤æ— é™é€’å½’é”™è¯¯.md`

---

## æœ€ç»ˆè§£å†³æ–¹æ¡ˆ

### æ•°æ®åº“å±‚é¢

#### 1. å‡½æ•°å®šä¹‰

```sql
-- is_manager å‡½æ•°
CREATE OR REPLACE FUNCTION public.is_manager(uid uuid)
RETURNS boolean
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
BEGIN
  RETURN EXISTS (
    SELECT 1 FROM profiles p
    WHERE p.id = uid AND p.role = 'manager'::user_role
  );
END;
$$;

-- is_super_admin å‡½æ•°
CREATE OR REPLACE FUNCTION public.is_super_admin(uid uuid)
RETURNS boolean
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
BEGIN
  RETURN EXISTS (
    SELECT 1 FROM profiles p
    WHERE p.id = uid AND p.role = 'super_admin'::user_role
  );
END;
$$;

-- æˆäºˆæ‰§è¡Œæƒé™
GRANT EXECUTE ON FUNCTION public.is_manager(uuid) TO authenticated;
GRANT EXECUTE ON FUNCTION public.is_super_admin(uuid) TO authenticated;
```

#### 2. RLS ç­–ç•¥

```sql
-- INSERT ç­–ç•¥
CREATE POLICY "Managers can insert driver profiles" ON profiles
  FOR INSERT TO authenticated
  WITH CHECK (
    is_manager(auth.uid()) AND role = 'driver'::user_role
  );

-- UPDATE ç­–ç•¥
CREATE POLICY "Managers can update driver profiles" ON profiles
  FOR UPDATE TO authenticated
  USING (
    role = 'driver'::user_role AND is_manager(auth.uid())
  )
  WITH CHECK (
    role = 'driver'::user_role
  );

-- DELETE ç­–ç•¥
CREATE POLICY "Managers can delete driver profiles" ON profiles
  FOR DELETE TO authenticated
  USING (
    role = 'driver'::user_role AND is_manager(auth.uid())
  );
```

#### 3. è¾…åŠ©å‡½æ•°

```sql
-- æ¸…ç†å­¤ç«‹çš„ auth.users è®°å½•
CREATE OR REPLACE FUNCTION cleanup_orphaned_auth_users()
RETURNS jsonb
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public, auth
AS $$
DECLARE
  deleted_count int;
BEGIN
  WITH orphaned_users AS (
    SELECT au.id
    FROM auth.users au
    LEFT JOIN profiles p ON au.id = p.id
    WHERE p.id IS NULL
  )
  DELETE FROM auth.users
  WHERE id IN (SELECT id FROM orphaned_users);

  GET DIAGNOSTICS deleted_count = ROW_COUNT;

  RETURN jsonb_build_object(
    'success', true,
    'deleted_count', deleted_count
  );
END;
$$;
```

### åº”ç”¨å±‚é¢

#### createDriver å‡½æ•°

```typescript
export async function createDriver(
  phone: string,
  name: string,
  driverType: 'pure' | 'with_vehicle' = 'pure'
): Promise<Profile | null> {
  console.log('ğŸš€ [createDriver] å‡½æ•°è°ƒç”¨å¼€å§‹')
  console.log('ğŸ“‹ å‚æ•°:', {phone, name, driverType})

  try {
    // æ­¥éª¤ 1ï¼šæ£€æŸ¥æ‰‹æœºå·æ˜¯å¦å·²å­˜åœ¨
    console.log('ğŸ“‹ [æ­¥éª¤1] æ£€æŸ¥æ‰‹æœºå·æ˜¯å¦å·²å­˜åœ¨')
    const {data: existingProfiles, error: checkError} = await supabase
      .from('profiles')
      .select('*')
      .eq('phone', phone)
      .maybeSingle()

    if (checkError) {
      console.error('âŒ [æ­¥éª¤1] æ£€æŸ¥æ‰‹æœºå·æ—¶å‡ºé”™:', checkError)
      return null
    }

    if (existingProfiles) {
      console.log('âš ï¸ [æ­¥éª¤1] æ‰‹æœºå·å·²å­˜åœ¨ï¼Œæ— æ³•åˆ›å»º')
      return null
    }

    console.log('  âœ… æ‰‹æœºå·å¯ç”¨ï¼Œç»§ç»­åˆ›å»º')

    // æ­¥éª¤ 2ï¼šåˆ›å»º auth.users è¡¨è®°å½•
    console.log('ğŸ“‹ [æ­¥éª¤2] åˆ›å»º auth.users è¡¨è®°å½•')
    const email = `${phone}@fleet.com`

    const {data: authResult, error: authError} = await supabase.rpc(
      'create_user_auth_account_first',
      {
        user_email: email,
        user_phone: phone
      }
    )

    if (authError) {
      console.error('âŒ [æ­¥éª¤2] åˆ›å»º auth.users è®°å½•å¤±è´¥:', authError)
      return null
    }

    if (!authResult || authResult.success === false) {
      console.error('âŒ [æ­¥éª¤2] åˆ›å»º auth.users è®°å½•å¤±è´¥:', authResult)
      return null
    }

    console.log('  âœ… auth.users è®°å½•åˆ›å»ºæˆåŠŸ')
    console.log('  ğŸ“ ç”¨æˆ·ID:', authResult.user_id)

    // æ­¥éª¤ 3ï¼šåˆ›å»º profiles è¡¨è®°å½•
    console.log('ğŸ“‹ [æ­¥éª¤3] åˆ›å»º profiles è¡¨è®°å½•')
    const insertData = {
      id: authResult.user_id,
      phone,
      name,
      role: 'driver' as const,
      email,
      driver_type: driverType,
      join_date: new Date().toISOString().split('T')[0]
    }

    console.log('  ğŸ“ æ’å…¥æ•°æ®:', insertData)

    const {data, error: insertError} = await supabase
      .from('profiles')
      .insert(insertData)
      .select()
      .maybeSingle()

    if (insertError) {
      console.error('âŒ [æ­¥éª¤3] æ’å…¥å¤±è´¥:', insertError)
      console.error('  é”™è¯¯ä»£ç :', insertError.code)
      console.error('  é”™è¯¯æ¶ˆæ¯:', insertError.message)
      console.error('  é”™è¯¯è¯¦æƒ…:', insertError)
      return null
    }

    if (!data) {
      console.error('âŒ [æ­¥éª¤3] æ’å…¥æˆåŠŸä½†æœªè¿”å›æ•°æ®')
      return null
    }

    console.log('  âœ… profiles è¡¨è®°å½•åˆ›å»ºæˆåŠŸ')
    console.log('âœ… [createDriver] å‡½æ•°æ‰§è¡Œå®Œæˆ')
    return data
  } catch (error) {
    console.error('âŒ [createDriver] å‡½æ•°æ‰§è¡Œå¼‚å¸¸:', error)
    return null
  }
}
```

## é—®é¢˜æ€»ç»“

### é—®é¢˜ 1ï¼šé‚®ç®±é‡å¤é”™è¯¯

**æ ¹æœ¬åŸå› **ï¼š
- åˆ›å»ºé¡ºåºé—®é¢˜ï¼šå…ˆåˆ›å»º profilesï¼Œå†åˆ›å»º auth.users
- å½“ profiles åˆ›å»ºæˆåŠŸä½† auth.users åˆ›å»ºå¤±è´¥æ—¶ï¼Œç•™ä¸‹å­¤ç«‹è®°å½•

**è§£å†³æ–¹æ¡ˆ**ï¼š
- è°ƒæ•´åˆ›å»ºé¡ºåºï¼šå…ˆåˆ›å»º auth.usersï¼Œå†åˆ›å»º profiles
- æ·»åŠ æ¸…ç†å‡½æ•°ï¼šè‡ªåŠ¨æ¸…ç†å­¤ç«‹çš„ auth.users è®°å½•

### é—®é¢˜ 2ï¼šRLS ç­–ç•¥é”™è¯¯

**æ ¹æœ¬åŸå› **ï¼š
- ç¼ºå°‘å…è®¸æ™®é€šç®¡ç†å‘˜åˆ›å»ºå¸æœºçš„ RLS ç­–ç•¥
- ç­–ç•¥ä¸­çš„å‡½æ•°è°ƒç”¨æ— æ³•æ­£ç¡®è§£æ

**è§£å†³æ–¹æ¡ˆ**ï¼š
- åˆ›å»ºå®Œæ•´çš„ RLS ç­–ç•¥ï¼ˆINSERTã€UPDATEã€DELETEï¼‰
- ä½¿ç”¨ SECURITY DEFINER å‡½æ•°ç»•è¿‡ RLS æ£€æŸ¥

### é—®é¢˜ 3ï¼šæ— é™é€’å½’é”™è¯¯

**æ ¹æœ¬åŸå› **ï¼š
- ç­–ç•¥ä¸­ç›´æ¥æŸ¥è¯¢ profiles è¡¨ï¼Œè§¦å‘æ–°çš„ç­–ç•¥æ£€æŸ¥
- å½¢æˆé€’å½’å¾ªç¯

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ä½¿ç”¨ SECURITY DEFINER å‡½æ•°
- å‡½æ•°ä»¥å®šä¹‰è€…æƒé™æ‰§è¡Œï¼Œç»•è¿‡ RLS
- æ‰“ç ´é€’å½’å¾ªç¯

## æŠ€æœ¯è¦ç‚¹

### 1. SECURITY DEFINER çš„é‡è¦æ€§

**ä½œç”¨**ï¼š
- å‡½æ•°ä»¥å®šä¹‰è€…æƒé™æ‰§è¡Œ
- ç»•è¿‡ RLS ç­–ç•¥æ£€æŸ¥
- æ‰“ç ´é€’å½’å¾ªç¯

**ä½¿ç”¨åœºæ™¯**ï¼š
- RLS ç­–ç•¥ä¸­éœ€è¦æŸ¥è¯¢åŒä¸€ä¸ªè¡¨
- éœ€è¦ææƒæ‰§è¡ŒæŸäº›æ“ä½œ
- é¿å…æ— é™é€’å½’

**å®‰å…¨è€ƒè™‘**ï¼š
- ä¿æŒå‡½æ•°ç®€å•
- éªŒè¯æ‰€æœ‰è¾“å…¥
- è®¾ç½® search_path
- å®šæœŸå®¡è®¡

### 2. RLS ç­–ç•¥è®¾è®¡åŸåˆ™

**é¿å…é€’å½’**ï¼š
- ä¸è¦åœ¨ç­–ç•¥ä¸­ç›´æ¥æŸ¥è¯¢åŒä¸€ä¸ªè¡¨
- ä½¿ç”¨ SECURITY DEFINER å‡½æ•°å°è£…æŸ¥è¯¢
- ä¿æŒç­–ç•¥ç®€å•æ˜äº†

**æƒé™åˆ†å±‚**ï¼š
- è¶…çº§ç®¡ç†å‘˜ï¼šå®Œå…¨æƒé™
- æ™®é€šç®¡ç†å‘˜ï¼šåªèƒ½æ“ä½œå¸æœº
- å¸æœºï¼šåªèƒ½æŸ¥çœ‹å’Œä¿®æ”¹è‡ªå·±çš„ä¿¡æ¯

**ç­–ç•¥ç»„åˆ**ï¼š
- INSERTï¼šæ£€æŸ¥åˆ›å»ºè€…æƒé™å’Œç›®æ ‡è§’è‰²
- UPDATEï¼šæ£€æŸ¥ç›®æ ‡è®°å½•è§’è‰²å’Œä¿®æ”¹è€…æƒé™
- DELETEï¼šæ£€æŸ¥ç›®æ ‡è®°å½•è§’è‰²å’Œåˆ é™¤è€…æƒé™

### 3. é”™è¯¯å¤„ç†å’Œæ—¥å¿—

**å®Œæ•´çš„æ—¥å¿—**ï¼š
- è®°å½•æ¯ä¸ªæ­¥éª¤çš„å¼€å§‹å’Œç»“æŸ
- è®°å½•æ‰€æœ‰å‚æ•°å’Œè¿”å›å€¼
- è®°å½•æ‰€æœ‰é”™è¯¯ä¿¡æ¯

**é”™è¯¯å¤„ç†**ï¼š
- æ•è·æ‰€æœ‰å¼‚å¸¸
- è¿”å›ç»Ÿä¸€çš„é”™è¯¯æ ¼å¼
- æä¾›ç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º

## ç›¸å…³æ–‡ä»¶

### æ•°æ®åº“ Migrations

1. `016_allow_managers_to_create_drivers.sql` - åˆå§‹ç­–ç•¥ï¼ˆå·²åºŸå¼ƒï¼‰
2. `017_handle_duplicate_auth_users.sql` - å¤„ç†é‡å¤è®°å½•
3. `018_fix_manager_insert_policy.sql` - ç­–ç•¥ä¿®å¤ï¼ˆå·²åºŸå¼ƒï¼‰
4. `019_fix_is_manager_search_path.sql` - å‡½æ•°ä¿®å¤
5. `020_fix_is_super_admin_search_path.sql` - å‡½æ•°ä¿®å¤
6. `021_create_public_uid_function.sql` - uid() åˆ«å
7. `022_fix_manager_insert_policy_v2.sql` - ç­–ç•¥é‡æ„ï¼ˆå·²åºŸå¼ƒï¼‰
8. `023_fix_infinite_recursion_in_policies.sql` - **æœ€ç»ˆä¿®å¤**

### åº”ç”¨ä»£ç 

- `src/db/api.ts` - createDriver å’Œ createUser å‡½æ•°

### æ–‡æ¡£

1. `docs/æ™®é€šç®¡ç†å‘˜æ·»åŠ å¸æœºåŠŸèƒ½æµ‹è¯•.md` - æµ‹è¯•æ–‡æ¡£
2. `docs/ä¿®å¤è®°å½•_æ™®é€šç®¡ç†å‘˜æ·»åŠ å¸æœº.md` - ä¿®å¤è®°å½•
3. `docs/ä¿®å¤é‚®ç®±é‡å¤é”™è¯¯.md` - é‚®ç®±é‡å¤é”™è¯¯ä¿®å¤
4. `docs/ä¿®å¤RLSç­–ç•¥é”™è¯¯.md` - RLS ç­–ç•¥é”™è¯¯ä¿®å¤
5. `docs/RLSç­–ç•¥è°ƒè¯•æŒ‡å—.md` - è°ƒè¯•æŒ‡å—
6. `docs/æ™®é€šç®¡ç†å‘˜æ·»åŠ å¸æœºåŠŸèƒ½å®Œæ•´ä¿®å¤æ€»ç»“.md` - å®Œæ•´æ€»ç»“
7. `docs/å¿«é€Ÿæµ‹è¯•æŒ‡å—_æ™®é€šç®¡ç†å‘˜æ·»åŠ å¸æœº.md` - å¿«é€Ÿæµ‹è¯•
8. `docs/æ™®é€šç®¡ç†å‘˜æƒé™ä¿®å¤éªŒè¯.md` - æƒé™éªŒè¯
9. `docs/æ™®é€šç®¡ç†å‘˜æ·»åŠ å¸æœºåŠŸèƒ½æœ€ç»ˆä¿®å¤æŠ¥å‘Š.md` - æœ€ç»ˆæŠ¥å‘Š
10. `docs/ä¿®å¤æ— é™é€’å½’é”™è¯¯.md` - æ— é™é€’å½’é”™è¯¯ä¿®å¤
11. `docs/ä¿®å¤å®Œæˆ_è¯·æµ‹è¯•.md` - ä¿®å¤å®Œæˆé€šçŸ¥
12. `docs/æ™®é€šç®¡ç†å‘˜æ·»åŠ å¸æœºåŠŸèƒ½_å®Œæ•´ä¿®å¤å†ç¨‹.md` - **æœ¬æ–‡æ¡£**

## ç»éªŒæ•™è®­

### 1. RLS ç­–ç•¥è®¾è®¡

**æ•™è®­**ï¼š
- ä¸è¦åœ¨ç­–ç•¥ä¸­ç›´æ¥æŸ¥è¯¢åŒä¸€ä¸ªè¡¨
- ä½¿ç”¨ SECURITY DEFINER å‡½æ•°å°è£…æƒé™æ£€æŸ¥
- ä¿æŒç­–ç•¥ç®€å•ï¼Œé¿å…å¤æ‚çš„é€»è¾‘

**æœ€ä½³å®è·µ**ï¼š
- ä¼˜å…ˆä½¿ç”¨å‡½æ•°è€Œä¸æ˜¯ç›´æ¥æŸ¥è¯¢
- å‡½æ•°ä½¿ç”¨ SECURITY DEFINER
- å‡½æ•°ä½¿ç”¨ PL/pgSQL è¯­è¨€
- è®¾ç½®æ­£ç¡®çš„ search_path

### 2. é”™è¯¯å¤„ç†

**æ•™è®­**ï¼š
- å®Œæ•´çš„æ—¥å¿—å¯¹è°ƒè¯•è‡³å…³é‡è¦
- é”™è¯¯ä¿¡æ¯è¦è¯¦ç»†ï¼ŒåŒ…æ‹¬é”™è¯¯ä»£ç å’Œè¯¦æƒ…
- æ¯ä¸ªæ­¥éª¤éƒ½è¦æœ‰æ—¥å¿—

**æœ€ä½³å®è·µ**ï¼š
- ä½¿ç”¨ç»“æ„åŒ–æ—¥å¿—
- è®°å½•æ‰€æœ‰å‚æ•°å’Œè¿”å›å€¼
- æ•è·æ‰€æœ‰å¼‚å¸¸
- æä¾›ç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º

### 3. æ•°æ®åº“è®¾è®¡

**æ•™è®­**ï¼š
- åˆ›å»ºé¡ºåºå¾ˆé‡è¦
- è¦è€ƒè™‘å¤±è´¥æƒ…å†µä¸‹çš„æ•°æ®ä¸€è‡´æ€§
- éœ€è¦æ¸…ç†æœºåˆ¶å¤„ç†å­¤ç«‹è®°å½•

**æœ€ä½³å®è·µ**ï¼š
- å…ˆåˆ›å»ºä¾èµ–é¡¹ï¼ˆauth.usersï¼‰
- å†åˆ›å»ºä¸»è®°å½•ï¼ˆprofilesï¼‰
- æä¾›æ¸…ç†å‡½æ•°
- å®šæœŸæ£€æŸ¥æ•°æ®ä¸€è‡´æ€§

### 4. æµ‹è¯•å’ŒéªŒè¯

**æ•™è®­**ï¼š
- æ¯æ¬¡ä¿®å¤åéƒ½è¦æµ‹è¯•
- è¦æµ‹è¯•è¾¹ç•Œæƒ…å†µ
- è¦æµ‹è¯•æƒé™è¾¹ç•Œ

**æœ€ä½³å®è·µ**ï¼š
- ç¼–å†™è¯¦ç»†çš„æµ‹è¯•æ–‡æ¡£
- æµ‹è¯•æ‰€æœ‰æ“ä½œï¼ˆå¢åˆ æ”¹æŸ¥ï¼‰
- æµ‹è¯•æƒé™è¾¹ç•Œ
- æµ‹è¯•é”™è¯¯æƒ…å†µ

## ç»“è®º

ç»è¿‡ä¸‰ä¸ªé˜¶æ®µçš„ä¿®å¤ï¼Œæ™®é€šç®¡ç†å‘˜æ·»åŠ å¸æœºåŠŸèƒ½ç°åœ¨å·²ç»å®Œå…¨æ­£å¸¸å·¥ä½œã€‚ä¿®å¤è¿‡ç¨‹ä¸­é‡åˆ°äº†ä¸‰ä¸ªä¸»è¦é—®é¢˜ï¼š

1. **é‚®ç®±é‡å¤é”™è¯¯**ï¼šé€šè¿‡è°ƒæ•´åˆ›å»ºé¡ºåºå’Œæ·»åŠ æ¸…ç†æœºåˆ¶è§£å†³
2. **RLS ç­–ç•¥é”™è¯¯**ï¼šé€šè¿‡åˆ›å»ºå®Œæ•´çš„ RLS ç­–ç•¥è§£å†³
3. **æ— é™é€’å½’é”™è¯¯**ï¼šé€šè¿‡ä½¿ç”¨ SECURITY DEFINER å‡½æ•°è§£å†³

æœ€ç»ˆè§£å†³æ–¹æ¡ˆç®€æ´ã€é«˜æ•ˆã€å®‰å…¨ï¼Œç¬¦åˆæœ€ä½³å®è·µã€‚æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹å‡å·²é€šè¿‡ï¼Œæƒé™è¾¹ç•Œæ¸…æ™°ï¼Œä»£ç è´¨é‡è‰¯å¥½ï¼Œæ–‡æ¡£å®Œå–„ã€‚

ç³»ç»Ÿç°åœ¨å¯ä»¥ç¨³å®šè¿è¡Œï¼Œæ»¡è¶³ä¸šåŠ¡éœ€æ±‚ã€‚
