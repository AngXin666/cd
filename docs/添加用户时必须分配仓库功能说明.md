# 添加用户时必须分配仓库功能说明

## 功能概述

为了确保新添加的司机和管理员能够正常工作，系统现在要求在创建用户时必须分配至少一个仓库。

## 修改内容

### 1. 普通管理员添加司机

**文件**：`src/pages/manager/driver-management/index.tsx`

**修改内容**：

1. **添加状态**：
   ```typescript
   const [newDriverWarehouseIds, setNewDriverWarehouseIds] = useState<string[]>([])
   ```

2. **添加验证**：
   ```typescript
   // 验证仓库选择
   if (newDriverWarehouseIds.length === 0) {
     showToast({title: '请至少选择一个仓库', icon: 'none'})
     return
   }
   ```

3. **自动分配仓库**：
   ```typescript
   // 分配仓库
   for (const warehouseId of newDriverWarehouseIds) {
     await insertWarehouseAssignment(newDriver.id, warehouseId)
   }
   ```

4. **UI 改进**：
   - 添加仓库选择复选框列表
   - 显示已选择的仓库数量
   - 在创建成功提示中显示分配的仓库名称

### 2. 超级管理员添加用户

**文件**：`src/pages/super-admin/user-management/index.tsx`

**修改内容**：

1. **添加状态**：
   ```typescript
   const [newUserWarehouseIds, setNewUserWarehouseIds] = useState<string[]>([])
   ```

2. **添加验证**：
   ```typescript
   // 验证仓库选择（司机和管理员都需要）
   if (newUserWarehouseIds.length === 0) {
     const roleText = newUserRole === 'driver' ? '司机' : '管理员'
     showToast({title: `请为${roleText}至少选择一个仓库`, icon: 'none'})
     return
   }
   ```

3. **自动分配仓库**：
   ```typescript
   // 分配仓库
   for (const warehouseId of newUserWarehouseIds) {
     await insertWarehouseAssignment(newUser.id, warehouseId)
   }
   ```

4. **UI 改进**：
   - 添加仓库选择复选框列表
   - 支持司机和管理员都分配仓库
   - 在创建成功提示中显示分配的仓库名称

## 用户界面

### 普通管理员添加司机表单

```
┌─────────────────────────────────────┐
│ 手机号                              │
│ [输入框]                            │
├─────────────────────────────────────┤
│ 姓名                                │
│ [输入框]                            │
├─────────────────────────────────────┤
│ 司机类型                            │
│ [纯司机] [带车司机]                 │
├─────────────────────────────────────┤
│ 分配仓库 *                          │
│ ☑ 仓库A                             │
│ ☐ 仓库B                             │
│ ☑ 仓库C                             │
├─────────────────────────────────────┤
│ ⚠ 默认密码为 123456                │
├─────────────────────────────────────┤
│ [确认添加]                          │
└─────────────────────────────────────┘
```

### 超级管理员添加用户表单

```
┌─────────────────────────────────────┐
│ 手机号                              │
│ [输入框]                            │
├─────────────────────────────────────┤
│ 姓名                                │
│ [输入框]                            │
├─────────────────────────────────────┤
│ 用户角色                            │
│ [司机] [管理员]                     │
├─────────────────────────────────────┤
│ 司机类型（仅司机显示）              │
│ [纯司机] [带车司机]                 │
├─────────────────────────────────────┤
│ 分配仓库 *                          │
│ ☑ 仓库A                             │
│ ☐ 仓库B                             │
│ ☑ 仓库C                             │
├─────────────────────────────────────┤
│ ⚠ 默认密码为 123456                │
├─────────────────────────────────────┤
│ [确认添加]                          │
└─────────────────────────────────────┘
```

## 验证流程

### 1. 表单验证

```
用户点击"确认添加"
    ↓
验证手机号是否填写
    ↓
验证姓名是否填写
    ↓
验证手机号格式
    ↓
验证是否选择了仓库 ← 新增
    ↓
创建用户
    ↓
分配仓库 ← 新增
    ↓
显示成功提示
```

### 2. 错误提示

| 验证项 | 错误提示 |
|--------|----------|
| 手机号为空 | "请输入手机号" |
| 姓名为空 | "请输入姓名" |
| 手机号格式错误 | "请输入正确的手机号" |
| 未选择仓库 | "请至少选择一个仓库"（普通管理员）<br>"请为司机至少选择一个仓库"（超级管理员-司机）<br>"请为管理员至少选择一个仓库"（超级管理员-管理员） |

## 成功提示

### 普通管理员添加司机

```
司机创建成功

姓名：张三
手机号码：13800138000
司机类型：纯司机
分配仓库：仓库A、仓库C
登录账号：13800138000@fleet.com
默认密码：123456
车牌号码：未设置

[知道了]
```

### 超级管理员添加用户

```
用户创建成功

姓名：李四
手机号码：13900139000
用户角色：管理员
分配仓库：仓库A、仓库B
登录账号：13900139000@fleet.com
默认密码：123456

[知道了]
```

## 数据库操作

### 1. 创建用户

```typescript
const newUser = await createUser(phone, name, role, driverType)
```

### 2. 分配仓库

```typescript
for (const warehouseId of warehouseIds) {
  await insertWarehouseAssignment(newUser.id, warehouseId)
}
```

### 3. 数据表

**warehouse_assignments**：
- `user_id`：用户ID（司机或管理员）
- `warehouse_id`：仓库ID
- `created_at`：创建时间

## 业务逻辑

### 1. 为什么需要分配仓库？

**司机**：
- 司机需要知道自己负责哪些仓库的配送工作
- 计件工作记录需要关联到具体的仓库
- 考勤记录需要关联到具体的仓库

**管理员**：
- 管理员需要管理特定仓库的司机
- 管理员需要查看特定仓库的数据
- 管理员需要审批特定仓库的请假申请

### 2. 仓库分配的作用

**数据隔离**：
- 普通管理员只能看到自己负责仓库的司机
- 司机只能看到自己负责仓库的工作记录

**权限控制**：
- 普通管理员只能管理自己负责仓库的司机
- 司机只能提交自己负责仓库的工作记录

**数据统计**：
- 按仓库统计司机数量
- 按仓库统计工作量
- 按仓库统计考勤情况

### 3. 多仓库支持

**司机可以分配到多个仓库**：
- 司机可以在多个仓库工作
- 提交工作记录时选择具体的仓库
- 考勤记录关联到具体的仓库

**管理员可以管理多个仓库**：
- 管理员可以管理多个仓库的司机
- 查看所有负责仓库的数据
- 审批所有负责仓库的请假申请

## 技术实现

### 1. 状态管理

```typescript
// 仓库选择状态
const [newDriverWarehouseIds, setNewDriverWarehouseIds] = useState<string[]>([])

// 仓库列表
const [warehouses, setWarehouses] = useState<Warehouse[]>([])
```

### 2. 复选框组件

```tsx
<CheckboxGroup
  onChange={(e) => setNewDriverWarehouseIds(e.detail.value as string[])}
  className="space-y-2">
  {warehouses.map((warehouse) => (
    <View
      key={warehouse.id}
      className={`flex items-center bg-white rounded-lg px-3 py-2.5 border-2 transition-all ${
        newDriverWarehouseIds.includes(warehouse.id)
          ? 'border-blue-600 bg-blue-50'
          : 'border-gray-300'
      }`}>
      <Checkbox
        value={warehouse.id}
        checked={newDriverWarehouseIds.includes(warehouse.id)}
        className="mr-2"
      />
      <Text className="text-sm text-gray-700 flex-1">{warehouse.name}</Text>
    </View>
  ))}
</CheckboxGroup>
```

### 3. 表单重置

```typescript
const toggleAddDriver = () => {
  setShowAddDriver(!showAddDriver)
  if (!showAddDriver) {
    // 重置表单
    setNewDriverPhone('')
    setNewDriverName('')
    setNewDriverType('pure')
    setNewDriverWarehouseIds([]) // 重置仓库选择
  }
}
```

### 4. 错误处理

```typescript
try {
  const newDriver = await createDriver(phone, name, driverType)
  
  if (newDriver) {
    // 分配仓库
    for (const warehouseId of newDriverWarehouseIds) {
      await insertWarehouseAssignment(newDriver.id, warehouseId)
    }
    
    // 显示成功提示
    Taro.showModal({...})
  } else {
    showToast({title: '添加失败，手机号可能已存在', icon: 'error'})
  }
} catch (error) {
  console.error('添加司机失败', error)
  showToast({title: '添加失败，请重试', icon: 'error'})
}
```

## 测试场景

### 1. 正常流程

**测试步骤**：
1. 登录普通管理员账号
2. 进入司机管理页面
3. 点击"添加司机"按钮
4. 填写手机号、姓名
5. 选择司机类型
6. 选择至少一个仓库
7. 点击"确认添加"

**预期结果**：
- ✅ 司机创建成功
- ✅ 仓库分配成功
- ✅ 显示成功提示，包含分配的仓库名称
- ✅ 司机列表刷新，显示新司机

### 2. 未选择仓库

**测试步骤**：
1. 登录普通管理员账号
2. 进入司机管理页面
3. 点击"添加司机"按钮
4. 填写手机号、姓名
5. 选择司机类型
6. 不选择任何仓库
7. 点击"确认添加"

**预期结果**：
- ✅ 显示错误提示："请至少选择一个仓库"
- ✅ 不创建司机
- ✅ 表单保持打开状态

### 3. 选择多个仓库

**测试步骤**：
1. 登录普通管理员账号
2. 进入司机管理页面
3. 点击"添加司机"按钮
4. 填写手机号、姓名
5. 选择司机类型
6. 选择多个仓库（如：仓库A、仓库B、仓库C）
7. 点击"确认添加"

**预期结果**：
- ✅ 司机创建成功
- ✅ 所有选中的仓库都分配成功
- ✅ 成功提示中显示所有仓库名称："仓库A、仓库B、仓库C"

### 4. 超级管理员添加管理员

**测试步骤**：
1. 登录超级管理员账号
2. 进入用户管理页面
3. 点击"添加用户"按钮
4. 填写手机号、姓名
5. 选择"管理员"角色
6. 选择至少一个仓库
7. 点击"确认添加"

**预期结果**：
- ✅ 管理员创建成功
- ✅ 仓库分配成功
- ✅ 显示成功提示，包含分配的仓库名称
- ✅ 用户列表刷新，显示新管理员

### 5. 没有可用仓库

**测试步骤**：
1. 登录普通管理员账号（该管理员没有分配任何仓库）
2. 进入司机管理页面
3. 点击"添加司机"按钮

**预期结果**：
- ✅ 显示"暂无可分配的仓库"提示
- ✅ 无法选择仓库
- ✅ 点击"确认添加"时显示错误提示

## 注意事项

### 1. 权限要求

- **普通管理员**：只能分配自己负责的仓库
- **超级管理员**：可以分配所有仓库

### 2. 数据一致性

- 创建用户和分配仓库是两个独立的操作
- 如果分配仓库失败，用户已经创建成功
- 可以后续通过"仓库分配"功能补充分配

### 3. 用户体验

- 仓库列表按名称排序
- 已选择的仓库高亮显示
- 显示已选择的仓库数量
- 成功提示中显示仓库名称，而不是ID

### 4. 性能优化

- 仓库列表只加载启用的仓库
- 使用缓存减少数据库查询
- 批量分配仓库时使用循环，而不是并发

## 相关文件

### 修改的文件

1. `src/pages/manager/driver-management/index.tsx` - 普通管理员添加司机
2. `src/pages/super-admin/user-management/index.tsx` - 超级管理员添加用户

### 相关数据库表

1. `profiles` - 用户表
2. `warehouses` - 仓库表
3. `warehouse_assignments` - 仓库分配表（用户-仓库关联表）

### 相关 API 函数

1. `createDriver()` - 创建司机
2. `createUser()` - 创建用户
3. `insertWarehouseAssignment()` - 分配仓库
4. `getManagerWarehouses()` - 获取管理员负责的仓库
5. `getAllWarehouses()` - 获取所有仓库

## 总结

### 主要改进

1. ✅ **强制仓库分配**：添加用户时必须选择至少一个仓库
2. ✅ **用户体验优化**：清晰的仓库选择界面和错误提示
3. ✅ **数据完整性**：确保新用户有明确的工作范围
4. ✅ **权限控制**：普通管理员只能分配自己负责的仓库

### 业务价值

1. **数据准确性**：避免创建没有仓库分配的用户
2. **管理效率**：新用户创建后立即可以工作
3. **权限清晰**：明确每个用户的工作范围
4. **用户体验**：一次性完成用户创建和仓库分配

### 技术亮点

1. **表单验证**：完善的输入验证和错误提示
2. **状态管理**：清晰的状态管理和表单重置
3. **错误处理**：完善的错误处理和用户反馈
4. **UI 设计**：直观的复选框界面和视觉反馈
