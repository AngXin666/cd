# 通知中心信息分类功能优化

## 完成时间
2025-11-05

## 需求概述

优化双管理员端（超级管理员与普通管理员）的通知中心信息分类功能，实现清晰、高效、易于管理的通知分类体系。

### 核心目标

1. **清晰的分类体系**：确保不同类型的信息能够准确地归类到对应的通知类别中
2. **高效的筛选功能**：支持按分类、已读/未读状态进行多维度筛选
3. **易于管理**：提供直观的UI界面，方便用户快速查看和管理通知

## 功能实现

### 1. 通知分类体系

#### 1.1 分类定义

定义了三个核心分类，覆盖所有通知类型：

| 分类 | 英文标识 | 包含的通知类型 |
|------|---------|--------------|
| **请假离职信息** | `leave_resignation` | • 请假申请提交<br>• 请假批准<br>• 请假拒绝<br>• 离职申请提交<br>• 离职批准<br>• 离职拒绝 |
| **车辆审批信息** | `vehicle_approval` | • 车辆待审核<br>• 车辆审核通过<br>• 车辆需要补录 |
| **权限信息** | `permission` | • 仓库分配<br>• 仓库取消分配<br>• 司机类型变更<br>• 权限变更 |

#### 1.2 分类规则说明

**请假离职信息**：
- 专门用于接收和处理所有与请假申请、离职申请相关的通知信息
- 包含司机提交的申请和管理员的审批结果

**车辆审批信息**：
- 专门用于接收和处理所有与车辆使用申请、审批流程相关的通知信息
- 包含车辆审核的各个状态变更通知

**权限信息**：
- 整合所有与系统账户权限调整相关的操作通知
- 包含两类操作来源：
  - 来自超级管理员端的操作：对普通管理员或司机进行的仓库分配、用户类型转换
  - 来自普通管理员端的操作：对其管辖范围内的司机进行的仓库分配、用户类型转换

### 2. 数据库设计

#### 2.1 枚举类型

创建 `notification_category` 枚举类型：

```sql
CREATE TYPE notification_category AS ENUM (
  'leave_resignation',  -- 请假离职信息
  'vehicle_approval',   -- 车辆审批信息
  'permission'          -- 权限信息
);
```

#### 2.2 表结构变更

在 `notifications` 表中添加 `category` 字段：

```sql
ALTER TABLE notifications ADD COLUMN category notification_category;
ALTER TABLE notifications ALTER COLUMN category SET DEFAULT 'permission'::notification_category;
ALTER TABLE notifications ALTER COLUMN category SET NOT NULL;
```

#### 2.3 索引优化

创建索引提升查询性能：

```sql
-- 单列索引
CREATE INDEX idx_notifications_category ON notifications(category);

-- 复合索引，优化多维度筛选
CREATE INDEX idx_notifications_user_category_read 
  ON notifications(user_id, category, is_read);
```

#### 2.4 数据迁移

为现有通知数据自动设置正确的分类：

```sql
-- 请假离职信息
UPDATE notifications
SET category = 'leave_resignation'::notification_category
WHERE type IN (
  'leave_application_submitted',
  'leave_approved',
  'leave_rejected',
  'resignation_application_submitted',
  'resignation_approved',
  'resignation_rejected'
)
AND category IS NULL;

-- 车辆审批信息
UPDATE notifications
SET category = 'vehicle_approval'::notification_category
WHERE type IN (
  'vehicle_review_pending',
  'vehicle_review_approved',
  'vehicle_review_need_supplement'
)
AND category IS NULL;

-- 权限信息
UPDATE notifications
SET category = 'permission'::notification_category
WHERE type IN (
  'warehouse_assigned',
  'warehouse_unassigned',
  'driver_type_changed',
  'permission_change'
)
AND category IS NULL;
```

### 3. 代码实现

#### 3.1 TypeScript 类型定义

```typescript
// 通知分类类型
export type NotificationCategory =
  | 'leave_resignation' // 请假离职信息
  | 'vehicle_approval' // 车辆审批信息
  | 'permission' // 权限信息

// 通知接口
export interface Notification {
  id: string
  user_id: string
  type: NotificationType
  category: NotificationCategory  // 新增分类字段
  title: string
  message: string
  related_id: string | null
  is_read: boolean
  created_at: string
}
```

#### 3.2 自动分类函数

创建辅助函数，根据通知类型自动确定分类：

```typescript
/**
 * 根据通知类型自动确定分类
 * @param type 通知类型
 * @returns 通知分类
 */
export function getNotificationCategory(type: NotificationType): NotificationCategory {
  // 请假离职信息
  if (
    type === 'leave_application_submitted' ||
    type === 'leave_approved' ||
    type === 'leave_rejected' ||
    type === 'resignation_application_submitted' ||
    type === 'resignation_approved' ||
    type === 'resignation_rejected'
  ) {
    return 'leave_resignation'
  }

  // 车辆审批信息
  if (
    type === 'vehicle_review_pending' ||
    type === 'vehicle_review_approved' ||
    type === 'vehicle_review_need_supplement'
  ) {
    return 'vehicle_approval'
  }

  // 权限信息（默认分类）
  return 'permission'
}
```

#### 3.3 创建通知函数更新

更新 `createNotification` 函数，自动设置分类：

```typescript
export async function createNotification(
  userId: string,
  type: NotificationType,
  title: string,
  message: string,
  relatedId?: string
): Promise<boolean> {
  try {
    // 自动确定分类
    const category = getNotificationCategory(type)

    const {error} = await supabase.from('notifications').insert({
      user_id: userId,
      type,
      category,  // 自动设置分类
      title,
      message,
      related_id: relatedId || null,
      is_read: false
    })

    if (error) {
      logger.error('创建通知失败', error)
      return false
    }

    return true
  } catch (error) {
    logger.error('创建通知异常', error)
    return false
  }
}
```

### 4. UI 界面设计

#### 4.1 筛选功能布局

```
通知中心                    5 条未读
┌─────────────────────────────────────┐
│ 信息分类                             │
│ [全部] [请假离职信息] [车辆审批信息] [权限信息] │
│                                     │
│ [未读信息(5)] [已读信息(3)] [全部已读] [清空已读] │
└─────────────────────────────────────┘
```

#### 4.2 分类筛选按钮

```typescript
<View className="mb-3">
  <Text className="text-sm text-muted-foreground mb-2">信息分类</Text>
  <View className="flex items-center gap-2 flex-wrap">
    <Button
      className={`${selectedCategory === 'all' ? 'bg-primary' : 'bg-muted'}`}
      onClick={() => setSelectedCategory('all')}>
      全部
    </Button>
    <Button
      className={`${selectedCategory === 'leave_resignation' ? 'bg-primary' : 'bg-muted'}`}
      onClick={() => setSelectedCategory('leave_resignation')}>
      请假离职信息
    </Button>
    <Button
      className={`${selectedCategory === 'vehicle_approval' ? 'bg-primary' : 'bg-muted'}`}
      onClick={() => setSelectedCategory('vehicle_approval')}>
      车辆审批信息
    </Button>
    <Button
      className={`${selectedCategory === 'permission' ? 'bg-primary' : 'bg-muted'}`}
      onClick={() => setSelectedCategory('permission')}>
      权限信息
    </Button>
  </View>
</View>
```

#### 4.3 已读/未读筛选按钮

```typescript
<View className="flex items-center gap-2 flex-wrap">
  <Button
    className={`${filterType === 'unread' ? 'bg-primary' : 'bg-muted'}`}
    onClick={() => setFilterType('unread')}>
    未读信息 ({unreadCount})
  </Button>
  <Button
    className={`${filterType === 'read' ? 'bg-primary' : 'bg-muted'}`}
    onClick={() => setFilterType('read')}>
    已读信息 ({readCount})
  </Button>
  <Button onClick={handleMarkAllAsRead}>
    全部已读
  </Button>
  <Button onClick={handleDeleteRead}>
    清空已读
  </Button>
</View>
```

### 5. 筛选逻辑实现

#### 5.1 状态管理

```typescript
// 筛选类型
type FilterType = 'all' | 'unread' | 'read'

const [filterType, setFilterType] = useState<FilterType>('all')
const [selectedCategory, setSelectedCategory] = useState<NotificationCategory | 'all'>('all')
```

#### 5.2 多维度筛选

```typescript
// 根据筛选条件过滤通知
const filteredNotifications = useMemo(() => {
  let result = notifications

  // 按已读/未读筛选
  if (filterType === 'unread') {
    result = result.filter((n) => !n.is_read)
  } else if (filterType === 'read') {
    result = result.filter((n) => n.is_read)
  }

  // 按分类筛选
  if (selectedCategory !== 'all') {
    result = result.filter((n) => n.category === selectedCategory)
  }

  return result
}, [notifications, filterType, selectedCategory])
```

#### 5.3 统计信息

```typescript
// 统计未读数量
const unreadCount = useMemo(() => {
  return notifications.filter((n) => !n.is_read).length
}, [notifications])

// 统计已读数量
const readCount = useMemo(() => {
  return notifications.filter((n) => n.is_read).length
}, [notifications])
```

## 功能特性

### 1. 分类筛选

- ✅ 支持按分类筛选通知
- ✅ 支持查看全部分类
- ✅ 分类按钮状态清晰可见
- ✅ 分类标签直观易懂

### 2. 已读/未读筛选

- ✅ 未读信息筛选
- ✅ 已读信息筛选（新增）
- ✅ 全部信息查看
- ✅ 显示未读/已读数量

### 3. 快捷操作

- ✅ 全部已读：一键标记所有通知为已读
- ✅ 清空已读：一键删除所有已读通知
- ✅ 点击通知自动标记为已读

### 4. 多维度筛选

- ✅ 支持同时按分类和已读状态筛选
- ✅ 筛选结果实时更新
- ✅ 保持日期分组（今天、昨天、更早）

### 5. 性能优化

- ✅ 使用索引优化查询性能
- ✅ 使用 `useMemo` 缓存计算结果
- ✅ 避免不必要的重新渲染

## 用户体验改进

### 优化前

- ❌ 所有通知混在一起，难以区分
- ❌ 无法按分类查看通知
- ❌ 只能查看未读信息，无法查看已读信息
- ❌ 需要手动滚动查找特定类型的通知

### 优化后

- ✅ 通知按分类清晰展示
- ✅ 支持按分类筛选通知
- ✅ 支持查看未读/已读信息
- ✅ 快速定位特定类型的通知
- ✅ 按钮状态清晰可见
- ✅ 多维度筛选，灵活高效

## 使用场景

### 场景 1：查看请假离职信息

1. 点击"请假离职信息"分类按钮
2. 系统只显示请假和离职相关的通知
3. 可以进一步筛选未读/已读信息

### 场景 2：查看未读的车辆审批信息

1. 点击"车辆审批信息"分类按钮
2. 点击"未读信息"筛选按钮
3. 系统只显示未读的车辆审批通知

### 场景 3：查看已读的权限信息

1. 点击"权限信息"分类按钮
2. 点击"已读信息"筛选按钮
3. 系统只显示已读的权限相关通知

### 场景 4：清理已读通知

1. 点击"已读信息"筛选按钮
2. 查看所有已读通知
3. 点击"清空已读"按钮
4. 系统删除所有已读通知

## 技术亮点

### 1. 自动分类

- 创建通知时自动根据类型确定分类
- 无需手动指定分类
- 确保分类的一致性和准确性

### 2. 数据迁移

- 自动为现有通知数据设置正确的分类
- 确保历史数据的完整性
- 无需手动处理历史数据

### 3. 索引优化

- 创建单列索引和复合索引
- 优化多维度筛选查询性能
- 提升用户体验

### 4. 类型安全

- 使用 TypeScript 严格类型定义
- 确保分类值的正确性
- 避免运行时错误

### 5. 性能优化

- 使用 `useMemo` 缓存计算结果
- 避免不必要的重新计算
- 提升渲染性能

## 测试验证

### 测试场景 1：分类筛选

- ✅ 点击"请假离职信息"，只显示请假离职相关通知
- ✅ 点击"车辆审批信息"，只显示车辆审批相关通知
- ✅ 点击"权限信息"，只显示权限相关通知
- ✅ 点击"全部"，显示所有通知

### 测试场景 2：已读/未读筛选

- ✅ 点击"未读信息"，只显示未读通知
- ✅ 点击"已读信息"，只显示已读通知
- ✅ 未读/已读数量显示正确

### 测试场景 3：多维度筛选

- ✅ 选择"请假离职信息" + "未读信息"，只显示未读的请假离职通知
- ✅ 选择"车辆审批信息" + "已读信息"，只显示已读的车辆审批通知
- ✅ 筛选结果准确无误

### 测试场景 4：快捷操作

- ✅ 点击"全部已读"，所有通知标记为已读
- ✅ 点击"清空已读"，所有已读通知被删除
- ✅ 点击通知，自动标记为已读

### 测试场景 5：空状态提示

- ✅ 筛选未读时显示"暂无未读通知"
- ✅ 筛选已读时显示"暂无已读通知"
- ✅ 无通知时显示"暂无通知"

## 代码质量

### Lint 检查

```bash
pnpm run lint
```

**结果**：✅ 通过，无新增错误

### 代码规范

- ✅ 使用 TypeScript 严格模式
- ✅ 添加详细的注释
- ✅ 遵循项目代码风格
- ✅ 使用 `useMemo` 优化性能

## 修改文件清单

### 1. 数据库迁移文件

- **文件**：`supabase/migrations/00070_add_notification_category.sql`
- **内容**：
  - 创建 `notification_category` 枚举类型
  - 添加 `category` 字段
  - 创建索引
  - 数据迁移

### 2. 通知 API 文件

- **文件**：`src/db/notificationApi.ts`
- **新增**：
  - `NotificationCategory` 类型定义
  - `getNotificationCategory` 辅助函数
- **修改**：
  - `Notification` 接口，添加 `category` 字段
  - `createNotification` 函数，自动设置分类
  - `createNotifications` 函数，自动设置分类

### 3. 通知中心页面

- **文件**：`src/pages/common/notifications/index.tsx`
- **新增**：
  - `FilterType` 类型定义
  - `filterType` 状态变量
  - `selectedCategory` 状态变量
  - `readCount` 统计
  - 分类筛选按钮
  - 已读信息筛选按钮
- **修改**：
  - 筛选逻辑，支持多维度筛选
  - 空状态提示，根据筛选状态显示不同内容
  - UI 布局，添加分类筛选区域

### 4. 文档

- **文件**：`docs/通知中心信息分类功能优化.md`
- **内容**：详细的功能说明和实现文档

## Git 提交记录

```bash
commit bae94b5
优化双管理员端通知中心信息分类功能

新增功能：
1. 添加通知分类系统
2. 添加分类筛选功能
3. 添加已读信息筛选功能
4. 优化按钮布局

数据库变更：
- 添加 notification_category 枚举类型
- 在 notifications 表中添加 category 字段
- 创建索引优化查询性能
- 为现有数据自动设置正确的分类

代码优化：
- 自动根据通知类型确定分类
- 更新 createNotification 和 createNotifications 函数
- 添加 getNotificationCategory 辅助函数
- 优化筛选逻辑，支持多维度筛选
```

## 界面效果

### 优化前

```
通知中心                    5 条未读
┌─────────────────────────────┐
│ [未读信息(5)] [全部已读] [清空已读] │
└─────────────────────────────┘

今天
● 新的请假申请 (未读)
○ 车辆审核通过 (已读)
● 仓库分配通知 (未读)
○ 请假申请已批准 (已读)
● 新的离职申请 (未读)
```

### 优化后

```
通知中心                    5 条未读
┌─────────────────────────────────────┐
│ 信息分类                             │
│ [全部] [请假离职信息] [车辆审批信息] [权限信息] │
│                                     │
│ [未读信息(5)] [已读信息(3)] [全部已读] [清空已读] │
└─────────────────────────────────────┘

点击"请假离职信息"后：
今天
● 新的请假申请
● 新的离职申请

昨天
○ 请假申请已批准

点击"请假离职信息" + "未读信息"后：
今天
● 新的请假申请
● 新的离职申请
```

## 后续优化建议

### 1. 添加分类统计

- 显示每个分类的未读数量
- 例如：请假离职信息(3)、车辆审批信息(2)、权限信息(0)

### 2. 添加分类图标

- 为每个分类添加对应的图标
- 提升视觉识别度

### 3. 添加分类颜色

- 为不同分类使用不同的颜色标识
- 例如：请假离职信息（橙色）、车辆审批信息（蓝色）、权限信息（绿色）

### 4. 添加快捷筛选

- 添加"今日未读"快捷筛选
- 添加"重要通知"快捷筛选

### 5. 添加通知优先级

- 紧急通知（红色）
- 重要通知（橙色）
- 普通通知（灰色）

## 相关文档

- [通知中心未读信息筛选功能](./通知中心未读信息筛选功能.md)
- [通知中心分组显示问题修复](./通知中心分组显示问题修复.md)
- [通知系统跳转逻辑优化](./通知系统跳转逻辑优化.md)

## 总结

本次优化成功实现了通知中心的信息分类功能，主要改进包括：

1. **添加通知分类体系**
   - ✅ 定义三个核心分类
   - ✅ 自动根据类型确定分类
   - ✅ 为现有数据自动设置分类

2. **添加分类筛选功能**
   - ✅ 支持按分类筛选通知
   - ✅ 支持查看全部分类
   - ✅ 分类按钮状态清晰可见

3. **添加已读信息筛选功能**
   - ✅ 未读信息筛选
   - ✅ 已读信息筛选（新增）
   - ✅ 全部信息查看

4. **优化按钮布局**
   - ✅ 分类筛选区域
   - ✅ 状态筛选区域
   - ✅ 快捷操作按钮

5. **性能优化**
   - ✅ 创建索引优化查询
   - ✅ 使用 `useMemo` 缓存结果
   - ✅ 避免不必要的重新渲染

这些改进显著提升了通知中心的易用性和管理效率，使得用户可以更方便地查看和管理不同类型的通知。所有功能已经过测试验证，代码质量良好，无新增错误。

## 完成状态

✅ **已完成所有需求**
- ✅ 添加通知分类体系
- ✅ 添加分类筛选功能
- ✅ 添加已读信息筛选功能
- ✅ 优化按钮布局
- ✅ 数据库迁移
- ✅ 代码优化
- ✅ 通过代码质量检查
- ✅ 创建详细文档
- ✅ 提交代码到 Git

---

**开发者**: 秒哒 (Miaoda)  
**完成日期**: 2025-11-05  
**Commit ID**: bae94b5
