# 用户偏好设置说明

## 1. 功能概述

### 1.1 登录状态持久化
- **功能描述**：用户登录后，系统会自动保存登录状态，下次打开小程序时无需重新登录
- **实现方式**：使用 `miaoda-auth-taro` 包的内置持久化功能
- **存储位置**：微信小程序本地存储
- **有效期**：根据 Supabase 的 session 有效期（默认 7 天）

### 1.2 操作习惯记忆
- **功能描述**：系统会记住用户最后一次的操作选择，下次使用时自动填充
- **应用场景**：
  - 计件录入页面
  - 考勤打卡页面（待开发）
  - 其他需要重复操作的页面

## 2. 计件录入页面的偏好设置

### 2.1 保存的偏好项

#### 最后选择的仓库
- **保存时机**：成功提交计件记录后
- **保存内容**：仓库ID、仓库名称、时间戳
- **恢复逻辑**：
  - 只在首次打开页面时恢复
  - 检查仓库是否仍在用户的仓库列表中
  - 如果仓库已被移除，则使用默认值（第一个仓库）

#### 最后选择的品类
- **保存时机**：成功提交计件记录后
- **保存内容**：品类ID、品类名称、时间戳
- **恢复逻辑**：
  - 只在首次打开页面时恢复
  - 检查品类是否仍在可用品类列表中
  - 如果品类已被禁用或删除，则使用默认值（第一个品类）

#### 最后选择的工作日期
- **保存时机**：成功提交计件记录后
- **保存内容**：日期字符串（YYYY-MM-DD）、时间戳
- **恢复逻辑**：
  - 只在首次打开页面时恢复
  - 只恢复今天或未来的日期
  - 如果日期已过期，则使用今天的日期

#### 是否需要上楼
- **保存时机**：成功提交计件记录后
- **保存内容**：布尔值（true/false）
- **恢复逻辑**：
  - 只在首次打开页面时恢复
  - 直接使用保存的值

### 2.2 使用流程

```
用户打开计件录入页面
    ↓
系统检查是否首次加载
    ↓
如果是首次加载：
    ├─ 从本地存储读取偏好设置
    ├─ 验证偏好设置的有效性
    ├─ 恢复有效的偏好设置
    └─ 标记为非首次加载
    ↓
用户填写表单
    ↓
用户提交表单
    ↓
提交成功后：
    ├─ 保存当前选择到本地存储
    └─ 重置表单（但不清除偏好设置）
```

### 2.3 代码示例

#### 保存偏好设置
```typescript
// 提交成功后保存偏好
if (success) {
  saveLastWarehouse(warehouse.id, warehouse.name)
  saveLastCategory(category.id, category.name)
  saveLastWorkDate(workDate)
  savePieceWorkFormDefaults({
    warehouseId: warehouse.id,
    categoryId: category.id,
    needUpstairs
  })
}
```

#### 恢复偏好设置
```typescript
// 只在首次加载时恢复
if (isFirstLoad) {
  const lastWarehouse = getLastWarehouse()
  const lastCategory = getLastCategory()
  const lastDate = getLastWorkDate()
  const formDefaults = getPieceWorkFormDefaults()

  // 恢复仓库
  if (lastWarehouse && warehouses.length > 0) {
    const index = warehouses.findIndex(w => w.id === lastWarehouse.id)
    if (index !== -1) {
      setSelectedWarehouseIndex(index)
    }
  }

  // 恢复品类
  if (lastCategory && categories.length > 0) {
    const index = categories.findIndex(c => c.id === lastCategory.id)
    if (index !== -1) {
      setSelectedCategoryIndex(index)
    }
  }

  // 恢复日期（只恢复今天或未来的日期）
  if (lastDate) {
    const lastDateObj = new Date(lastDate)
    const today = new Date()
    today.setHours(0, 0, 0, 0)
    if (lastDateObj >= today) {
      setWorkDate(lastDate)
    }
  }

  // 恢复是否需要上楼
  if (formDefaults?.needUpstairs !== undefined) {
    setNeedUpstairs(formDefaults.needUpstairs)
  }

  setIsFirstLoad(false)
}
```

## 3. 技术实现

### 3.1 存储方式
- **平台**：使用 Taro 的 `setStorageSync` 和 `getStorageSync` API
- **兼容性**：支持微信小程序和 H5 环境
- **容量限制**：微信小程序单个 key 最大 1MB，总容量 10MB

### 3.2 存储键名规范
```typescript
const STORAGE_KEYS = {
  LAST_WAREHOUSE: 'user_last_warehouse',
  LAST_CATEGORY: 'user_last_category',
  LAST_WORK_DATE: 'user_last_work_date',
  PIECE_WORK_FORM: 'user_piece_work_form'
}
```

### 3.3 数据结构

#### 仓库偏好
```typescript
{
  id: string,        // 仓库ID
  name: string,      // 仓库名称
  timestamp: number  // 保存时间戳
}
```

#### 品类偏好
```typescript
{
  id: string,        // 品类ID
  name: string,      // 品类名称
  timestamp: number  // 保存时间戳
}
```

#### 日期偏好
```typescript
{
  date: string,      // 日期字符串 (YYYY-MM-DD)
  timestamp: number  // 保存时间戳
}
```

#### 表单默认值
```typescript
{
  warehouseId?: string,   // 仓库ID
  categoryId?: string,    // 品类ID
  needUpstairs?: boolean, // 是否需要上楼
  timestamp: number       // 保存时间戳
}
```

### 3.4 工具函数

#### 保存函数
- `saveLastWarehouse(warehouseId, warehouseName)` - 保存最后选择的仓库
- `saveLastCategory(categoryId, categoryName)` - 保存最后选择的品类
- `saveLastWorkDate(date)` - 保存最后选择的工作日期
- `savePieceWorkFormDefaults(formData)` - 保存表单默认值

#### 获取函数
- `getLastWarehouse()` - 获取最后选择的仓库
- `getLastCategory()` - 获取最后选择的品类
- `getLastWorkDate()` - 获取最后选择的工作日期
- `getPieceWorkFormDefaults()` - 获取表单默认值

#### 清除函数
- `clearAllPreferences()` - 清除所有用户偏好设置

## 4. 用户体验优化

### 4.1 智能恢复
- **有效性验证**：恢复前检查数据是否仍然有效
- **过期处理**：自动忽略过期的日期
- **容错处理**：如果恢复失败，使用默认值

### 4.2 首次加载标记
- **目的**：避免每次刷新数据时都恢复偏好设置
- **实现**：使用 `isFirstLoad` 状态标记
- **重置时机**：页面卸载时自动重置

### 4.3 用户感知
- **无感知恢复**：用户打开页面时，表单已自动填充上次的选择
- **可修改**：用户可以随时修改任何字段
- **自动保存**：提交成功后自动保存新的选择

## 5. 安全性考虑

### 5.1 数据隔离
- **用户隔离**：每个用户的偏好设置独立存储
- **不跨设备**：偏好设置存储在本地，不同设备不共享

### 5.2 数据验证
- **ID验证**：恢复前验证仓库ID和品类ID是否仍然有效
- **日期验证**：只恢复今天或未来的日期
- **类型验证**：确保数据类型正确

### 5.3 错误处理
- **捕获异常**：所有存储操作都包含 try-catch
- **降级处理**：如果存储失败，不影响正常功能
- **日志记录**：记录错误信息便于调试

## 6. 未来扩展

### 6.1 待开发功能

#### 考勤打卡偏好
- 保存最后选择的打卡类型（上班/下班）
- 保存常用的打卡备注

#### 支出管理偏好
- 保存最后选择的支出类型
- 保存常用的支出金额

#### 车辆管理偏好
- 保存最后选择的车辆
- 保存常用的加油站

### 6.2 高级功能

#### 云端同步
- 将偏好设置同步到 Supabase
- 支持跨设备共享偏好设置
- 需要考虑隐私和安全性

#### 偏好设置页面
- 提供专门的设置页面
- 允许用户查看和管理偏好设置
- 提供清除所有偏好的选项

#### 智能推荐
- 基于历史数据推荐常用选项
- 分析用户习惯，优化默认值
- 提供快捷填充功能

## 7. 测试场景

### 7.1 基本功能测试
1. **首次使用**：无偏好设置，使用默认值
2. **第二次使用**：自动恢复上次的选择
3. **修改选择**：可以修改任何字段
4. **提交成功**：保存新的选择

### 7.2 边界情况测试
1. **仓库被删除**：恢复时使用默认值
2. **品类被禁用**：恢复时使用默认值
3. **日期过期**：使用今天的日期
4. **存储失败**：不影响正常功能

### 7.3 兼容性测试
1. **微信小程序**：正常保存和恢复
2. **H5环境**：正常保存和恢复
3. **不同设备**：各自独立的偏好设置

## 8. 常见问题

### Q1: 为什么我的选择没有被保存？
**A**: 只有在成功提交表单后，选择才会被保存。如果提交失败，选择不会被保存。

### Q2: 为什么我的偏好设置丢失了？
**A**: 可能的原因：
- 清除了微信小程序的缓存
- 卸载并重新安装了小程序
- 仓库或品类被管理员删除或禁用

### Q3: 如何清除我的偏好设置？
**A**: 目前需要清除微信小程序的缓存。未来会提供专门的清除功能。

### Q4: 偏好设置会同步到其他设备吗？
**A**: 目前不会。偏好设置存储在本地，不同设备独立。未来可能会支持云端同步。

### Q5: 偏好设置会影响其他用户吗？
**A**: 不会。每个用户的偏好设置完全独立，互不影响。

## 9. 更新日志

### 2025-11-06
- ✅ 实现计件录入页面的偏好设置保存
- ✅ 支持保存最后选择的仓库、品类、日期
- ✅ 支持保存是否需要上楼的选项
- ✅ 实现智能恢复逻辑
- ✅ 添加有效性验证
- ✅ 创建工具函数库 `src/utils/preferences.ts`

### 未来计划
- 🔄 扩展到其他页面（考勤、支出、车辆管理）
- 🔄 开发偏好设置管理页面
- 🔄 支持云端同步
- 🔄 添加智能推荐功能
