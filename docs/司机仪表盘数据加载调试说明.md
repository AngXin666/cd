# 司机仪表盘数据加载调试说明

## 最新修复（2025-01-15）

### 🔧 修复的关键问题
**问题描述**：数据无法正确加载，仪表盘显示为0

**根本原因**：调用`getPieceWorkRecordsByUser`函数时，参数格式错误
- **错误调用**：`getPieceWorkRecordsByUser(user.id, '2025', '1')`
- **正确调用**：`getPieceWorkRecordsByUser(user.id, '2025-01-01', '2025-01-31')`

**修复内容**：
1. 修正了日期参数格式，从年月字符串改为完整的日期字符串
2. 添加了详细的控制台日志，方便调试
3. 优化了代码结构，避免重复计算日期

### ✅ 现在的数据加载流程
```typescript
// 1. 计算本月的开始和结束日期
const firstDay = '2025-01-01'
const lastDayStr = '2025-01-31'

// 2. 获取当月所有计件记录
const records = await getPieceWorkRecordsByUser(user.id, firstDay, lastDayStr)

// 3. 筛选今日记录
const todayStr = '2025-01-15'
const todayRecords = records.filter((record) => record.work_date.startsWith(todayStr))

// 4. 计算统计数据
// - 今日件数和收入
// - 本月件数和收入
// - 出勤天数和请假天数
```

## 更新内容

### 1. 布局优化
- **原布局**：2列3行（6个数据卡片分3行显示）
- **新布局**：3列2行（6个数据卡片分2行显示）
- **显示数据**：
  - 第一行：当日件数、当日收入、本月件数
  - 第二行：本月收入、出勤天数、请假天数

### 2. 数据加载增强
- 添加了详细的控制台日志，方便调试
- 添加了loading状态管理
- 添加了错误处理和用户提示

## 数据加载流程

### 1. 数据源
司机仪表盘的数据来自以下几个数据表：
- **piece_work_records**：计件记录表（用于统计件数和收入）
- **attendance_records**：考勤记录表（用于统计出勤天数）
- **leave_applications**：请假申请表（用于统计请假天数）

### 2. 数据计算逻辑

#### 当日数据
```typescript
// 筛选今日记录
const todayStr = today.toISOString().split('T')[0]  // 格式：2025-01-15
const todayRecords = records.filter((record) => record.work_date.startsWith(todayStr))

// 计算今日件数
const todayPieceCount = todayRecords.reduce((sum, record) => sum + (record.quantity || 0), 0)

// 计算今日收入（包含基础计件、上楼费、分拣费）
const todayIncome = todayRecords.reduce((sum, record) => {
  const baseAmount = (record.quantity || 0) * (record.unit_price || 0)
  const upstairsAmount = record.need_upstairs ? (record.quantity || 0) * (record.upstairs_price || 0) : 0
  const sortingAmount = record.need_sorting ? (record.sorting_quantity || 0) * (record.sorting_unit_price || 0) : 0
  return sum + baseAmount + upstairsAmount + sortingAmount
}, 0)
```

#### 本月数据
```typescript
// 计算本月件数
const monthPieceCount = records.reduce((sum, record) => sum + (record.quantity || 0), 0)

// 计算本月收入（包含基础计件、上楼费、分拣费）
const monthIncome = records.reduce((sum, record) => {
  const baseAmount = (record.quantity || 0) * (record.unit_price || 0)
  const upstairsAmount = record.need_upstairs ? (record.quantity || 0) * (record.upstairs_price || 0) : 0
  const sortingAmount = record.need_sorting ? (record.sorting_quantity || 0) * (record.sorting_unit_price || 0) : 0
  return sum + baseAmount + upstairsAmount + sortingAmount
}, 0)
```

#### 考勤数据
```typescript
// 获取本月考勤数据
const firstDay = `${year}-${month.toString().padStart(2, '0')}-01`
const lastDay = new Date(year, month, 0)
const lastDayStr = `${year}-${month.toString().padStart(2, '0')}-${lastDay.getDate().toString().padStart(2, '0')}`
const attendanceData = await getDriverAttendanceStats(user.id, firstDay, lastDayStr)
```

## 调试方法

### 1. 查看控制台日志
打开浏览器开发者工具（F12），查看Console标签页，会看到以下日志：

```
开始加载统计数据，用户ID: xxx
获取计件记录: 2025 1
计件记录数量: 10 记录: [...]
今日记录数量: 2 今日日期: 2025-01-15
计件统计 - 今日件数: 50 今日收入: 500 本月件数: 300 本月收入: 3000
获取考勤数据: 2025-01-01 至 2025-01-31
考勤统计 - 出勤天数: 15 请假天数: 2
设置新的统计数据: {todayPieceCount: 50, todayIncome: 500, ...}
```

### 2. 检查数据是否存在
如果数据显示为0，可能的原因：

#### 原因1：数据库中没有数据
- 检查是否有计件记录
- 检查是否有考勤记录
- 检查是否有请假记录

#### 原因2：日期格式不匹配
- 计件记录的work_date字段格式应为：`2025-01-15T00:00:00+00:00`
- 今日筛选使用的是：`work_date.startsWith('2025-01-15')`

#### 原因3：用户ID不匹配
- 检查当前登录用户的ID
- 检查数据库中记录的driver_id是否与当前用户ID一致

### 3. 测试数据加载
可以通过以下步骤测试数据加载：

1. **添加测试数据**
   - 在司机端添加一条计件记录
   - 在司机端进行一次打卡
   - 在司机端提交一次请假申请（需要管理员审批通过）

2. **刷新页面**
   - 切换到其他页面再切换回来
   - 或者下拉刷新页面

3. **查看数据更新**
   - 检查仪表盘上的数据是否更新
   - 查看控制台日志确认数据加载过程

## 常见问题

### Q1: 数据一直显示为0
**A**: 检查以下几点：
1. 数据库中是否有对应的记录
2. 记录的日期是否是当月
3. 记录的driver_id是否与当前用户ID一致
4. 查看控制台日志，确认数据加载过程

### Q2: 今日数据为0，但本月数据有值
**A**: 这是正常的，说明：
1. 本月有计件记录，但今天没有
2. 今日数据只统计当天的记录
3. 本月数据统计整个月的记录

### Q3: 考勤数据不准确
**A**: 检查以下几点：
1. 出勤天数：统计的是attendance_records表中status='present'或'late'的记录
2. 请假天数：统计的是leave_applications表中status='approved'的记录
3. 确认日期范围是否正确（本月第一天到最后一天）

### Q4: 页面一直显示"加载中..."
**A**: 可能的原因：
1. 网络请求失败
2. 数据库查询超时
3. 用户ID未正确获取
4. 查看控制台是否有错误信息

## 数据刷新机制

### 自动刷新时机
1. **页面首次加载**：useEffect触发
2. **页面重新显示**：useDidShow触发（从其他页面返回时）
3. **手动刷新**：下拉刷新（如果实现了）

### 手动触发刷新
如果需要手动刷新数据，可以：
1. 切换到其他标签页再切换回来
2. 从其他页面返回到司机首页
3. 重新登录

## 性能优化建议

1. **数据缓存**：考虑缓存当天的数据，避免频繁查询
2. **增量更新**：只更新变化的数据，而不是每次都重新计算
3. **懒加载**：考虑延迟加载非关键数据
4. **错误重试**：网络失败时自动重试

## 下一步优化方向

1. **添加下拉刷新**：让用户可以主动刷新数据
2. **添加数据趋势**：显示数据的增长趋势（如：比昨天多10件）
3. **添加数据详情**：点击卡片可以查看详细数据
4. **添加数据导出**：支持导出数据报表
