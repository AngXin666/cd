# 普通管理员权限修复验证文档

## 修复内容

### 1. 问题描述

普通管理员在添加司机时遇到 RLS 策略错误：

```
new row violates row-level security policy for table "profiles"
错误代码: 42501
```

### 2. 根本原因

RLS 策略中使用了 `is_manager(auth.uid())` 函数调用，但在策略执行的上下文中，这个函数调用可能无法正确解析。

### 3. 解决方案

**修改前的策略**：

```sql
CREATE POLICY "Managers can insert driver profiles" ON profiles
  FOR INSERT TO authenticated
  WITH CHECK (
    is_manager(auth.uid()) AND role = 'driver'::user_role
  );
```

**修改后的策略**：

```sql
CREATE POLICY "Managers can insert driver profiles" ON profiles
  FOR INSERT TO authenticated
  WITH CHECK (
    -- 直接在策略中检查用户角色
    EXISTS (
      SELECT 1 FROM profiles p
      WHERE p.id = auth.uid() AND p.role = 'manager'::user_role
    )
    AND role = 'driver'::user_role
  );
```

### 4. 新增权限

除了修复 INSERT 策略，还新增了 UPDATE 和 DELETE 策略：

#### UPDATE 策略

```sql
CREATE POLICY "Managers can update driver profiles" ON profiles
  FOR UPDATE TO authenticated
  USING (
    role = 'driver'::user_role
    AND EXISTS (
      SELECT 1 FROM profiles p
      WHERE p.id = auth.uid() AND p.role = 'manager'::user_role
    )
  )
  WITH CHECK (
    role = 'driver'::user_role
  );
```

#### DELETE 策略

```sql
CREATE POLICY "Managers can delete driver profiles" ON profiles
  FOR DELETE TO authenticated
  USING (
    role = 'driver'::user_role
    AND EXISTS (
      SELECT 1 FROM profiles p
      WHERE p.id = auth.uid() AND p.role = 'manager'::user_role
    )
  );
```

## 验证步骤

### 步骤 1：检查策略是否正确应用

```sql
-- 查看所有与 manager 相关的策略
SELECT 
  policyname,
  cmd,
  with_check,
  qual
FROM pg_policies
WHERE tablename = 'profiles' 
  AND policyname LIKE '%Manager%'
ORDER BY cmd, policyname;
```

**预期结果**：

应该看到三个策略：
1. `Managers can insert driver profiles` (INSERT)
2. `Managers can update driver profiles` (UPDATE)
3. `Managers can delete driver profiles` (DELETE)

### 步骤 2：测试 INSERT 权限

**操作**：
1. 使用普通管理员账号登录
2. 进入司机管理页面
3. 添加新司机

**预期结果**：
- ✅ 创建成功
- ✅ 显示登录信息弹窗
- ✅ 司机列表中显示新司机

### 步骤 3：测试 UPDATE 权限

**操作**：
1. 使用普通管理员账号登录
2. 进入司机管理页面
3. 编辑某个司机的信息
4. 保存修改

**预期结果**：
- ✅ 更新成功
- ✅ 显示成功提示
- ✅ 司机信息已更新

### 步骤 4：测试 DELETE 权限

**操作**：
1. 使用普通管理员账号登录
2. 进入司机管理页面
3. 删除某个司机

**预期结果**：
- ✅ 删除成功
- ✅ 显示成功提示
- ✅ 司机从列表中移除

### 步骤 5：测试权限边界

#### 测试 5.1：普通管理员不能创建管理员

**操作**：
尝试使用普通管理员账号创建一个 manager 角色的用户

**预期结果**：
- ❌ 创建失败
- ✅ RLS 策略阻止（因为策略要求 role = 'driver'）

#### 测试 5.2：普通管理员不能修改管理员信息

**操作**：
尝试使用普通管理员账号修改另一个管理员的信息

**预期结果**：
- ❌ 修改失败
- ✅ RLS 策略阻止（因为策略要求 role = 'driver'）

#### 测试 5.3：普通管理员不能删除管理员

**操作**：
尝试使用普通管理员账号删除另一个管理员

**预期结果**：
- ❌ 删除失败
- ✅ RLS 策略阻止（因为策略要求 role = 'driver'）

## 数据库验证

### 验证 1：检查策略定义

```sql
-- 查看 INSERT 策略
SELECT 
  policyname,
  with_check
FROM pg_policies
WHERE tablename = 'profiles' 
  AND policyname = 'Managers can insert driver profiles';
```

**预期结果**：

```
policyname: Managers can insert driver profiles
with_check: ((EXISTS ( SELECT 1 FROM profiles p WHERE ((p.id = auth.uid()) AND (p.role = 'manager'::user_role)))) AND (role = 'driver'::user_role))
```

### 验证 2：测试策略条件

```sql
-- 假设当前用户是 manager，测试策略条件
SELECT 
  -- 条件 1：当前用户是 manager
  EXISTS (
    SELECT 1 FROM profiles p
    WHERE p.id = auth.uid() AND p.role = 'manager'::user_role
  ) as is_manager,
  -- 条件 2：插入的角色是 driver
  'driver'::user_role = 'driver'::user_role as is_driver_role,
  -- 两个条件都满足
  (
    EXISTS (
      SELECT 1 FROM profiles p
      WHERE p.id = auth.uid() AND p.role = 'manager'::user_role
    )
    AND 'driver'::user_role = 'driver'::user_role
  ) as policy_check;
```

**预期结果**（对于 manager 用户）：

```
is_manager: true
is_driver_role: true
policy_check: true
```

### 验证 3：检查所有权限

```sql
-- 查看普通管理员的所有权限
SELECT 
  cmd as operation,
  COUNT(*) as policy_count,
  STRING_AGG(policyname, ', ') as policies
FROM pg_policies
WHERE tablename = 'profiles'
  AND (
    policyname LIKE '%Manager%'
    OR policyname LIKE '%manager%'
  )
GROUP BY cmd
ORDER BY cmd;
```

**预期结果**：

```
operation: DELETE, policy_count: 1, policies: Managers can delete driver profiles
operation: INSERT, policy_count: 1, policies: Managers can insert driver profiles
operation: UPDATE, policy_count: 1, policies: Managers can update driver profiles
```

## 对比：超级管理员 vs 普通管理员

### 超级管理员权限

```sql
-- 超级管理员的策略
SELECT policyname, cmd
FROM pg_policies
WHERE tablename = 'profiles'
  AND policyname LIKE '%Super admin%'
ORDER BY cmd;
```

**结果**：
- INSERT: 可以插入任何角色的用户
- UPDATE: 可以更新任何用户的信息
- DELETE: 可以删除任何用户

### 普通管理员权限

```sql
-- 普通管理员的策略
SELECT policyname, cmd
FROM pg_policies
WHERE tablename = 'profiles'
  AND policyname LIKE '%Manager%'
ORDER BY cmd;
```

**结果**：
- INSERT: 只能插入 driver 角色的用户
- UPDATE: 只能更新 driver 角色的用户
- DELETE: 只能删除 driver 角色的用户

## 常见问题

### 问题 1：仍然出现 RLS 策略错误

**可能原因**：
1. 策略没有正确应用
2. 当前用户不是 manager 角色
3. 插入的数据角色不是 driver

**解决方案**：

1. 检查策略是否存在：
```sql
SELECT * FROM pg_policies 
WHERE tablename = 'profiles' 
  AND policyname = 'Managers can insert driver profiles';
```

2. 检查当前用户角色：
```sql
SELECT id, name, role FROM profiles WHERE id = auth.uid();
```

3. 检查插入的数据：
```typescript
console.log('插入数据:', insertData);
// 确保 insertData.role === 'driver'
```

### 问题 2：UPDATE 或 DELETE 失败

**可能原因**：
1. 尝试修改/删除非 driver 角色的用户
2. 当前用户不是 manager

**解决方案**：

检查目标用户的角色：
```sql
SELECT id, name, role FROM profiles WHERE id = 'target-user-id';
```

### 问题 3：权限过于宽松

**检查**：

确保策略中包含角色检查：
```sql
-- 策略必须包含这个条件
role = 'driver'::user_role
```

## 总结

### 修复前

- ❌ 普通管理员无法添加司机（RLS 策略错误）
- ❌ 普通管理员无法修改司机信息
- ❌ 普通管理员无法删除司机

### 修复后

- ✅ 普通管理员可以添加司机
- ✅ 普通管理员可以修改司机信息
- ✅ 普通管理员可以删除司机
- ✅ 普通管理员不能操作管理员账号（权限边界清晰）
- ✅ 策略直接使用 EXISTS 子查询，避免函数调用问题

### 关键改进

1. **策略简化**：不再依赖 `is_manager()` 函数，直接在策略中使用 EXISTS 子查询
2. **权限完整**：添加了 INSERT、UPDATE、DELETE 三个操作的策略
3. **安全边界**：确保普通管理员只能操作司机账号，不能操作管理员账号

### 相关文件

- `supabase/migrations/022_fix_manager_insert_policy_v2.sql` - 策略修复 migration
- `docs/RLS策略调试指南.md` - 详细的调试指南
- `docs/普通管理员添加司机功能完整修复总结.md` - 完整修复总结
