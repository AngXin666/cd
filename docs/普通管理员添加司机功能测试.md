# 普通管理员添加司机功能测试文档

## 修复概述

### 问题描述
普通管理员在添加司机时出现错误，无法成功创建司机账号。

### 根本原因
1. **数据库权限问题**：profiles 表的 INSERT 策略只允许超级管理员插入记录
2. **函数调用顺序问题**：`createDriver` 函数使用了旧的逻辑（先创建 profiles，再创建 auth.users）
3. **函数不存在问题**：`createDriver` 函数调用了已删除的 `create_user_auth_account` 函数

### 解决方案
1. **更新 createDriver 函数**：参考超级管理员端的 `createUser` 函数，先创建 auth.users 再创建 profiles
2. **添加数据库策略**：允许普通管理员插入角色为 'driver' 的 profiles 记录
3. **验证函数权限**：确保 `create_user_auth_account_first` 函数使用 SECURITY DEFINER

## 测试准备

### 1. 创建测试账号

#### 创建超级管理员账号（如果还没有）
```sql
-- 第一个注册的用户会自动成为超级管理员
-- 在小程序中注册第一个账号即可
```

#### 创建普通管理员账号
```sql
-- 方法1：使用超级管理员端创建
-- 1. 登录超级管理员账号
-- 2. 进入"用户管理"页面
-- 3. 点击"添加用户"
-- 4. 选择角色为"管理员"
-- 5. 输入手机号和姓名
-- 6. 点击"添加"

-- 方法2：使用 SQL 创建
-- 注意：需要先创建 auth.users 记录，再创建 profiles 记录
```

### 2. 准备测试数据
- 准备几个未使用的手机号（用于创建司机账号）
- 准备司机姓名

## 测试场景

### 场景 1：普通管理员添加纯司机

#### 测试步骤
1. 使用普通管理员账号登录小程序
2. 进入"司机管理"页面（路径：`/pages/manager/driver-management/index`）
3. 点击"添加司机"按钮
4. 输入测试数据：
   - 手机号：13800138001
   - 姓名：测试司机1
   - 司机类型：纯司机
5. 点击"添加"按钮

#### 预期结果
- ✅ 显示"司机创建成功"弹窗
- ✅ 弹窗显示以下信息：
  - 姓名：测试司机1
  - 手机号码：13800138001
  - 司机类型：纯司机
  - 登录账号：13800138001@fleet.com
  - 默认密码：123456
  - 车牌号码：未设置
- ✅ 点击"知道了"后，表单重置
- ✅ 司机列表自动刷新，显示新添加的司机

#### 验证数据库
```sql
-- 验证 auth.users 记录
SELECT id, email, phone, created_at
FROM auth.users
WHERE phone = '13800138001';

-- 验证 profiles 记录
SELECT id, phone, name, role, driver_type, email, join_date
FROM profiles
WHERE phone = '13800138001';

-- 验证 ID 一致性
SELECT 
  au.id as auth_id,
  p.id as profile_id,
  au.id = p.id as ids_match
FROM auth.users au
JOIN profiles p ON au.phone = p.phone
WHERE au.phone = '13800138001';
```

### 场景 2：普通管理员添加带车司机

#### 测试步骤
1. 使用普通管理员账号登录小程序
2. 进入"司机管理"页面
3. 点击"添加司机"按钮
4. 输入测试数据：
   - 手机号：13800138002
   - 姓名：测试司机2
   - 司机类型：带车司机
5. 点击"添加"按钮

#### 预期结果
- ✅ 显示"司机创建成功"弹窗
- ✅ 弹窗显示以下信息：
  - 姓名：测试司机2
  - 手机号码：13800138002
  - 司机类型：带车司机
  - 登录账号：13800138002@fleet.com
  - 默认密码：123456
  - 车牌号码：未设置
- ✅ 点击"知道了"后，表单重置
- ✅ 司机列表自动刷新，显示新添加的司机

### 场景 3：验证权限限制

#### 测试步骤
尝试通过 SQL 直接插入管理员记录（模拟绕过前端限制）

```sql
-- 尝试以普通管理员身份插入管理员记录
-- 这应该失败，因为策略限制只能插入 role = 'driver' 的记录
INSERT INTO profiles (phone, name, role, email)
VALUES ('13800138003', '测试管理员', 'manager', '13800138003@fleet.com');
```

#### 预期结果
- ✅ 插入失败
- ✅ 错误信息：权限不足或策略违规

### 场景 4：验证手机号重复检查

#### 测试步骤
1. 使用普通管理员账号登录小程序
2. 进入"司机管理"页面
3. 点击"添加司机"按钮
4. 输入已存在的手机号（如：13800138001）
5. 输入姓名：重复测试
6. 点击"添加"按钮

#### 预期结果
- ✅ 显示错误提示："添加失败，手机号可能已存在"
- ✅ 不创建新记录
- ✅ 表单不重置，允许用户修改后重试

### 场景 5：验证登录功能

#### 测试步骤
1. 退出当前账号
2. 使用新创建的司机账号登录
3. 尝试以下登录方式：
   - 方式1：手机号 + 密码（13800138001 / 123456）
   - 方式2：邮箱 + 密码（13800138001@fleet.com / 123456）

#### 预期结果
- ✅ 登录成功
- ✅ 进入司机端界面
- ✅ 显示正确的用户信息

## 技术验证

### 1. 验证数据库策略

```sql
-- 查看 profiles 表的 INSERT 策略
SELECT 
  policyname,
  cmd,
  with_check
FROM pg_policies
WHERE tablename = 'profiles' AND cmd = 'INSERT'
ORDER BY policyname;

-- 预期结果：
-- 1. "Managers can insert driver profiles" - 允许管理员插入司机记录
-- 2. "Super admins can insert profiles" - 允许超级管理员插入任何记录
```

### 2. 验证函数权限

```sql
-- 查看 create_user_auth_account_first 函数的权限
SELECT 
  proname,
  prosecdef
FROM pg_proc
WHERE proname = 'create_user_auth_account_first';

-- 预期结果：
-- prosecdef = true (使用 SECURITY DEFINER)
```

### 3. 验证函数调用流程

查看 `src/db/api.ts` 中的 `createDriver` 函数：

```typescript
// 步骤1: 检查手机号是否已存在
// 步骤2: 调用 create_user_auth_account_first 创建 auth.users 记录
// 步骤3: 使用返回的 user_id 创建 profiles 记录
```

## 常见问题排查

### 问题 1：添加司机时提示"权限不足"

**可能原因**：
- 当前用户不是管理员角色
- 数据库策略未正确应用

**排查步骤**：
```sql
-- 1. 检查当前用户角色
SELECT id, phone, name, role
FROM profiles
WHERE id = auth.uid();

-- 2. 检查数据库策略
SELECT policyname, with_check
FROM pg_policies
WHERE tablename = 'profiles' AND cmd = 'INSERT';
```

### 问题 2：添加司机时提示"函数不存在"

**可能原因**：
- `create_user_auth_account_first` 函数未创建
- 函数名称拼写错误

**排查步骤**：
```sql
-- 检查函数是否存在
SELECT proname
FROM pg_proc
WHERE proname = 'create_user_auth_account_first';
```

### 问题 3：auth.users 和 profiles 的 ID 不一致

**可能原因**：
- 使用了旧的创建逻辑
- 手动创建记录时未指定 ID

**排查步骤**：
```sql
-- 检查 ID 一致性
SELECT 
  au.id as auth_id,
  p.id as profile_id,
  au.id = p.id as ids_match,
  p.phone
FROM auth.users au
FULL OUTER JOIN profiles p ON au.id = p.id
WHERE au.id IS NULL OR p.id IS NULL OR au.id != p.id;
```

## 回滚方案

如果修复出现问题，可以执行以下回滚操作：

### 1. 删除新添加的策略

```sql
DROP POLICY IF EXISTS "Managers can insert driver profiles" ON profiles;
```

### 2. 恢复旧的 createDriver 函数

从 git 历史中恢复旧版本的 `src/db/api.ts` 文件。

## 相关文件

- `src/db/api.ts` - createDriver 函数
- `src/pages/manager/driver-management/index.tsx` - 管理员端司机管理页面
- `supabase/migrations/016_allow_managers_to_create_drivers.sql` - 数据库策略
- `supabase/migrations/014_create_user_auth_function.sql` - create_user_auth_account_first 函数

## 测试清单

- [ ] 场景 1：普通管理员添加纯司机
- [ ] 场景 2：普通管理员添加带车司机
- [ ] 场景 3：验证权限限制
- [ ] 场景 4：验证手机号重复检查
- [ ] 场景 5：验证登录功能
- [ ] 技术验证 1：数据库策略
- [ ] 技术验证 2：函数权限
- [ ] 技术验证 3：函数调用流程

## 测试结论

测试日期：_____________

测试人员：_____________

测试结果：
- [ ] 全部通过
- [ ] 部分通过（请说明）
- [ ] 未通过（请说明）

备注：
