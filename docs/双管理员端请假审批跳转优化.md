# 双管理员端请假审批跳转优化

## 需求描述

优化双管理员端（普通管理员和超级管理员）的请假审批跳转功能：

1. **管理员首页跳转**：点击"请假待审核"卡片后，跳转到考勤管理页面的待审核标签页，并自动切换到当前选中的仓库
2. **通知中心跳转**：点击请假相关通知后，跳转到考勤管理页面的待审核标签页，并自动切换到对应的仓库

## 实现方案

### 1. 管理员首页跳转优化

#### 普通管理员首页（`src/pages/manager/index.tsx`）

**修改位置**：`handleLeaveApproval` 和 `handleAttendanceManagement` 函数

**修改前**：
```typescript
const handleLeaveApproval = () => {
  navigateTo({url: '/pages/manager/leave-approval/index?tab=pending'})
}

const handleAttendanceManagement = () => {
  // 跳转到考勤管理页面（待审批标签）
  navigateTo({url: '/pages/manager/leave-approval/index?tab=pending'})
}
```

**修改后**：
```typescript
const handleLeaveApproval = () => {
  // 获取当前选中的仓库ID
  const currentWarehouse = warehouses[currentWarehouseIndex]
  const warehouseId = currentWarehouse?.id || ''
  navigateTo({url: `/pages/manager/leave-approval/index?tab=pending&warehouseId=${warehouseId}`})
}

const handleAttendanceManagement = () => {
  // 跳转到考勤管理页面（待审批标签）
  const currentWarehouse = warehouses[currentWarehouseIndex]
  const warehouseId = currentWarehouse?.id || ''
  navigateTo({url: `/pages/manager/leave-approval/index?tab=pending&warehouseId=${warehouseId}`})
}
```

**改进点**：
- ✅ 携带当前选中的仓库ID参数
- ✅ 用户体验更流畅，无需手动切换仓库

### 2. 考勤管理页面接收参数

#### 普通管理员考勤管理页面（`src/pages/manager/leave-approval/index.tsx`）

**新增状态**：
```typescript
const [urlWarehouseId, setUrlWarehouseId] = useState<string | null>(null)
```

**修改 URL 参数读取**：
```typescript
// 从URL参数读取初始标签和仓库ID
useEffect(() => {
  const params = Taro.getCurrentInstance().router?.params
  if (params?.tab === 'pending') {
    setActiveTab('pending')
  }
  if (params?.warehouseId) {
    setUrlWarehouseId(params.warehouseId)
  }
}, [])
```

**新增仓库切换逻辑**：
```typescript
// 根据URL参数切换到对应的仓库
useEffect(() => {
  if (urlWarehouseId && managerWarehouses.length > 0 && warehouses.length > 0) {
    // 计算可见仓库列表
    const managedWarehouseIds = managerWarehouses.map((w) => w.id)
    const managedWarehouses = warehouses.filter((w) => managedWarehouseIds.includes(w.id))

    // 过滤出有数据的仓库
    const warehousesWithData = managedWarehouses
      .map((warehouse) => {
        const leaveCount = leaveApplications.filter((app) => app.warehouse_id === warehouse.id).length
        const resignationCount = resignationApplications.filter((app) => app.warehouse_id === warehouse.id).length
        const attendanceCount = attendanceRecords.filter((record) => record.warehouse_id === warehouse.id).length
        const totalCount = leaveCount + resignationCount + attendanceCount
        return {warehouse, totalCount}
      })
      .filter((item) => item.totalCount > 0)
      .sort((a, b) => b.totalCount - a.totalCount)
      .map((item) => item.warehouse)

    // 如果没有数据，显示所有管理的仓库
    const visibleWarehouses = warehousesWithData.length > 0 ? warehousesWithData : managedWarehouses

    // 查找目标仓库的索引
    const targetIndex = visibleWarehouses.findIndex((w) => w.id === urlWarehouseId)
    if (targetIndex !== -1) {
      setCurrentWarehouseIndex(targetIndex)
    }
    // 清除URL参数，避免重复切换
    setUrlWarehouseId(null)
  }
}, [urlWarehouseId, managerWarehouses, warehouses, leaveApplications, resignationApplications, attendanceRecords])
```

**改进点**：
- ✅ 支持从 URL 参数读取仓库ID
- ✅ 自动切换到对应的仓库
- ✅ 避免重复切换（清除URL参数）

#### 超级管理员考勤管理页面（`src/pages/super-admin/leave-approval/index.tsx`）

**实现方式**：与普通管理员页面相同

**改进点**：
- ✅ 超级管理员也支持仓库跳转
- ✅ 统一的用户体验

### 3. 通知中心智能跳转

#### 通知栏组件（`src/components/RealNotificationBar/index.tsx`）

**新增用户资料状态**：
```typescript
const [userProfile, setUserProfile] = useState<Profile | null>(null)

// 加载用户资料
const loadUserProfile = useCallback(async () => {
  if (!user) return
  try {
    const profile = await getCurrentUserProfile()
    setUserProfile(profile)
  } catch (error) {
    logger.error('加载用户资料失败', error)
  }
}, [user])

useEffect(() => {
  loadUserProfile()
}, [loadUserProfile])
```

**修改点击处理函数**：
```typescript
// 点击通知栏
const handleClick = async () => {
  // 标记为已读
  const success = await markNotificationAsRead(currentNotification.id)
  if (success) {
    logger.info('通知已标记为已读', {notificationId: currentNotification.id})
    // 从列表中移除已读通知
    setNotifications((prev) => prev.filter((n) => n.id !== currentNotification.id))
    // 重置索引
    setCurrentIndex(0)
    setScrollCount(0)
  }

  // 根据通知类型进行智能跳转
  const notificationType = currentNotification.type
  const relatedId = currentNotification.related_id
  const userRole = userProfile?.role || 'driver'

  // 确定跳转路径前缀（根据用户角色）
  const pathPrefix = userRole === 'super_admin' ? '/pages/super-admin' : '/pages/manager'

  // 请假申请相关通知 - 跳转到考勤管理页面
  if (
    notificationType === 'leave_application_submitted' ||
    notificationType === 'leave_approved' ||
    notificationType === 'leave_rejected'
  ) {
    if (relatedId) {
      try {
        // 获取请假申请的仓库ID
        const {data: leaveApp} = await supabase
          .from('leave_applications')
          .select('warehouse_id')
          .eq('id', relatedId)
          .maybeSingle()

        if (leaveApp?.warehouse_id) {
          // 跳转到考勤管理页面，并切换到待审核标签和对应仓库
          Taro.navigateTo({
            url: `${pathPrefix}/leave-approval/index?tab=pending&warehouseId=${leaveApp.warehouse_id}`
          })
          return
        }
      } catch (error) {
        logger.error('获取请假申请仓库ID失败', error)
      }
    }
    // 如果获取失败，跳转到考勤管理页面（不指定仓库）
    Taro.navigateTo({url: `${pathPrefix}/leave-approval/index?tab=pending`})
    return
  }

  // 离职申请相关通知 - 跳转到考勤管理页面
  if (
    notificationType === 'resignation_application_submitted' ||
    notificationType === 'resignation_approved' ||
    notificationType === 'resignation_rejected'
  ) {
    if (relatedId) {
      try {
        // 获取离职申请的仓库ID
        const {data: resignationApp} = await supabase
          .from('resignation_applications')
          .select('warehouse_id')
          .eq('id', relatedId)
          .maybeSingle()

        if (resignationApp?.warehouse_id) {
          // 跳转到考勤管理页面，并切换到待审核标签和对应仓库
          Taro.navigateTo({
            url: `${pathPrefix}/leave-approval/index?tab=pending&warehouseId=${resignationApp.warehouse_id}`
          })
          return
        }
      } catch (error) {
        logger.error('获取离职申请仓库ID失败', error)
      }
    }
    // 如果获取失败，跳转到考勤管理页面（不指定仓库）
    Taro.navigateTo({url: `${pathPrefix}/leave-approval/index?tab=pending`})
    return
  }

  // 其他通知 - 跳转到通知中心
  Taro.navigateTo({url: '/pages/common/notifications/index'})
}
```

**改进点**：
- ✅ 根据用户角色选择不同的页面路径
- ✅ 请假/离职通知自动跳转到考勤管理页面
- ✅ 自动获取并携带仓库ID参数
- ✅ 容错处理：如果获取仓库ID失败，仍然跳转到考勤管理页面

## 功能特性

### 1. 智能跳转

- **请假申请提交通知**：跳转到考勤管理页面的待审核标签，并切换到对应仓库
- **请假批准/拒绝通知**：跳转到考勤管理页面的待审核标签，并切换到对应仓库
- **离职申请提交通知**：跳转到考勤管理页面的待审核标签，并切换到对应仓库
- **离职批准/拒绝通知**：跳转到考勤管理页面的待审核标签，并切换到对应仓库
- **其他通知**：跳转到通知中心

### 2. 角色适配

- **普通管理员**：跳转到 `/pages/manager/leave-approval/index`
- **超级管理员**：跳转到 `/pages/super-admin/leave-approval/index`
- **司机**：跳转到通知中心（司机不需要审批功能）

### 3. 容错处理

- **仓库ID获取失败**：仍然跳转到考勤管理页面，但不指定仓库
- **URL参数缺失**：使用默认值（第一个仓库）
- **仓库不存在**：不切换仓库，保持当前状态

## 用户体验优化

### 优化前

1. 用户点击"请假待审核"卡片
2. 跳转到考勤管理页面
3. 用户需要手动切换到对应的仓库
4. 用户才能看到待审核的请假申请

### 优化后

1. 用户点击"请假待审核"卡片
2. 自动跳转到考勤管理页面的待审核标签
3. 自动切换到当前选中的仓库
4. 用户直接看到待审核的请假申请

**节省步骤**：2 步 → 1 步
**用户体验**：更流畅、更直观

## 技术实现细节

### 1. URL 参数传递

使用 Taro 的 `navigateTo` API 传递参数：

```typescript
navigateTo({
  url: `/pages/manager/leave-approval/index?tab=pending&warehouseId=${warehouseId}`
})
```

### 2. URL 参数读取

使用 Taro 的 `getCurrentInstance` API 读取参数：

```typescript
const params = Taro.getCurrentInstance().router?.params
if (params?.tab === 'pending') {
  setActiveTab('pending')
}
if (params?.warehouseId) {
  setUrlWarehouseId(params.warehouseId)
}
```

### 3. 仓库索引计算

根据仓库ID查找对应的索引：

```typescript
const visibleWarehouses = getVisibleWarehouses()
const targetIndex = visibleWarehouses.findIndex((w) => w.id === urlWarehouseId)
if (targetIndex !== -1) {
  setCurrentWarehouseIndex(targetIndex)
}
```

### 4. 数据库查询

使用 Supabase 查询请假/离职申请的仓库ID：

```typescript
const {data: leaveApp} = await supabase
  .from('leave_applications')
  .select('warehouse_id')
  .eq('id', relatedId)
  .maybeSingle()
```

## 测试场景

### 场景 1：管理员首页跳转

1. 登录普通管理员账号
2. 在首页选择某个仓库（例如：仓库A）
3. 点击"请假待审核"卡片
4. **预期结果**：跳转到考勤管理页面，自动切换到仓库A的待审核标签

### 场景 2：通知中心跳转（请假申请）

1. 登录普通管理员账号
2. 司机提交一个请假申请（仓库B）
3. 管理员收到通知
4. 点击通知栏
5. **预期结果**：跳转到考勤管理页面，自动切换到仓库B的待审核标签

### 场景 3：通知中心跳转（离职申请）

1. 登录超级管理员账号
2. 司机提交一个离职申请（仓库C）
3. 超级管理员收到通知
4. 点击通知栏
5. **预期结果**：跳转到超级管理员的考勤管理页面，自动切换到仓库C的待审核标签

### 场景 4：容错处理

1. 登录管理员账号
2. 点击一个已删除的请假申请通知
3. **预期结果**：跳转到考勤管理页面的待审核标签，但不指定仓库（使用默认仓库）

## 修改文件清单

### 1. 普通管理员首页
- **文件**：`src/pages/manager/index.tsx`
- **修改**：`handleLeaveApproval` 和 `handleAttendanceManagement` 函数

### 2. 普通管理员考勤管理页面
- **文件**：`src/pages/manager/leave-approval/index.tsx`
- **新增**：`urlWarehouseId` 状态
- **修改**：URL 参数读取逻辑
- **新增**：仓库切换 useEffect

### 3. 超级管理员考勤管理页面
- **文件**：`src/pages/super-admin/leave-approval/index.tsx`
- **新增**：`urlWarehouseId` 状态
- **修改**：URL 参数读取逻辑
- **新增**：仓库切换 useEffect

### 4. 通知栏组件
- **文件**：`src/components/RealNotificationBar/index.tsx`
- **新增**：`userProfile` 状态
- **新增**：`loadUserProfile` 函数
- **修改**：`handleClick` 函数（智能跳转逻辑）

## 代码质量

### TypeScript 类型检查
```bash
pnpm run lint
```

**结果**：✅ 通过，无新增错误

### 代码规范
- ✅ 使用 TypeScript 严格模式
- ✅ 添加详细的注释
- ✅ 遵循项目代码风格
- ✅ 使用 useCallback 和 useEffect 优化性能

## 后续优化建议

### 1. 缓存仓库ID

可以将用户最后选择的仓库ID缓存到本地存储，下次打开页面时自动恢复：

```typescript
// 保存仓库ID
Taro.setStorageSync('lastSelectedWarehouseId', warehouseId)

// 读取仓库ID
const lastWarehouseId = Taro.getStorageSync('lastSelectedWarehouseId')
```

### 2. 添加加载动画

在仓库切换时添加加载动画，提升用户体验：

```typescript
Taro.showLoading({title: '切换仓库中...'})
// 切换仓库
Taro.hideLoading()
```

### 3. 添加错误提示

如果仓库不存在或获取失败，显示友好的错误提示：

```typescript
Taro.showToast({
  title: '仓库不存在',
  icon: 'none',
  duration: 2000
})
```

## 总结

本次优化实现了双管理员端的智能跳转功能，主要改进包括：

1. ✅ **管理员首页跳转**：携带当前选中的仓库ID
2. ✅ **考勤管理页面**：支持从 URL 参数读取仓库ID并自动切换
3. ✅ **通知中心跳转**：根据通知类型和用户角色智能跳转
4. ✅ **容错处理**：处理各种异常情况
5. ✅ **用户体验**：减少操作步骤，提升流畅度

这些改进显著提升了管理员的工作效率和用户体验。

## 完成日期

2025-11-05
