# 定位权限使用指南

## 📋 概述

车队管家小程序的打卡功能需要获取您的位置信息。本指南将帮助您了解如何授权和管理位置权限。

---

## 🎯 为什么需要位置权限？

打卡功能需要获取您的位置信息，用于：

1. **记录打卡位置**：记录您上下班打卡时的准确位置
2. **验证打卡范围**：确认您是否在仓库的有效打卡范围内
3. **自动选择仓库**：根据您的位置自动选择最近的仓库
4. **生成考勤报表**：为管理员提供准确的考勤数据

**隐私保护承诺：**
- ✅ 位置信息仅用于打卡功能
- ✅ 不会在后台持续获取位置
- ✅ 不会将位置信息用于其他用途
- ✅ 位置数据安全加密存储

---

## 📱 首次使用授权

### 步骤1：打开打卡页面

进入小程序后，点击底部"工作台"，然后点击"打卡"按钮。

### 步骤2：点击打卡按钮

首次打卡时，点击"上班打卡"按钮。

### 步骤3：授权位置权限

系统会弹出授权对话框：

```
┌─────────────────────────────────┐
│ 车队管家申请                     │
│ 获取你的位置信息                 │
│                                  │
│ 您的位置信息将用于上下班打卡定位 │
│                                  │
│  [拒绝]          [允许]          │
└─────────────────────────────────┘
```

**请点击"允许"按钮**，授权小程序获取位置信息。

### 步骤4：开始打卡

授权成功后，系统会自动获取您的位置并完成打卡。

---

## ⚠️ 常见问题

### Q1: 点击打卡后没有弹出授权对话框？

**可能原因：**
- 手机GPS未开启
- 小程序版本过旧

**解决方法：**
1. 检查手机GPS是否开启
2. 重启小程序
3. 更新微信到最新版本

### Q2: 不小心点击了"拒绝"怎么办？

**解决方法：**

系统会自动引导您开启权限：

1. 再次点击打卡按钮
2. 系统会弹出提示：
   ```
   ┌─────────────────────────────────┐
   │ 需要位置权限                     │
   │                                  │
   │ 打卡功能需要获取您的位置信息，   │
   │ 请在设置中开启位置权限           │
   │                                  │
   │  [取消]          [去设置]        │
   └─────────────────────────────────┘
   ```
3. 点击"去设置"
4. 在设置页面中找到"位置信息"
5. 开启"位置信息"权限
6. 返回小程序重新打卡

### Q3: 如何手动管理位置权限？

**方法1：通过小程序设置**

1. 打开小程序
2. 点击右上角"..."菜单
3. 点击"设置"
4. 找到"位置信息"
5. 开启或关闭权限

**方法2：通过微信设置**

1. 打开微信
2. 进入"我" → "设置" → "隐私与安全" → "授权管理"
3. 找到"车队管家"
4. 管理位置权限

### Q4: 定位失败怎么办？

**检查清单：**

1. ✅ **检查GPS**：确保手机GPS已开启
2. ✅ **检查权限**：确保已授权位置权限
3. ✅ **检查网络**：确保网络连接正常（百度地图API需要）
4. ✅ **检查位置**：到室外或窗边重试
5. ✅ **重启小程序**：关闭小程序后重新打开

**如果仍然失败：**
- 系统会自动切换到本机GPS定位
- 虽然只显示坐标，但不影响打卡功能
- 联系管理员获取帮助

### Q5: 为什么有时显示详细地址，有时只显示坐标？

**这是正常现象：**

- **详细地址**：使用百度地图API时显示（需要网络）
- **GPS坐标**：网络异常时自动降级显示（无需网络）

两种方式的定位精度相同，都可以正常打卡。

---

## 🔒 隐私与安全

### 数据收集说明

**我们收集的信息：**
- 打卡时的GPS坐标（经纬度）
- 打卡时的详细地址（如果使用百度地图API）
- 打卡时间

**我们不会收集：**
- ❌ 非打卡时间的位置信息
- ❌ 您的行动轨迹
- ❌ 其他个人隐私信息

### 数据使用说明

**位置数据仅用于：**
1. 记录考勤打卡位置
2. 验证是否在仓库范围内
3. 生成考勤统计报表
4. 管理员查看考勤记录

**数据保护措施：**
- 🔐 数据加密传输
- 🔐 数据加密存储
- 🔐 严格的访问控制
- 🔐 定期安全审计

### 权限管理

**您可以随时：**
- 查看授权状态
- 修改权限设置
- 撤销位置权限

**撤销权限的影响：**
- ⚠️ 无法使用打卡功能
- ⚠️ 无法记录考勤
- ⚠️ 可能影响工资结算

---

## 🛠️ 技术细节

### 权限配置

小程序已在配置文件中声明位置权限：

```typescript
// app.config.ts
{
  requiredPrivateInfos: ['getLocation'],
  permission: {
    'scope.userLocation': {
      desc: '您的位置信息将用于上下班打卡定位'
    }
  }
}
```

### 权限检查流程

```
用户点击打卡
    ↓
检查GPS是否开启
    ↓
检查位置权限状态
    ↓
权限状态？
    ├─ 已授权 → 直接定位 ✅
    ├─ 未询问 → 弹出授权对话框
    └─ 已拒绝 → 引导用户手动开启
            ↓
        弹出提示对话框
            ↓
        用户点击"去设置"
            ↓
        打开设置页面
            ↓
        用户开启权限
            ↓
        返回小程序
            ↓
        重新检查权限
            ↓
        开始定位 ✅
```

### 智能定位系统

系统采用多重定位方式，确保高可用性：

1. **百度地图API**（首选）
   - 需要位置权限 + 网络连接
   - 返回详细地址

2. **本机GPS定位**（降级方案）
   - 需要位置权限
   - 返回GPS坐标

详见：[智能定位系统使用指南](./SMART_LOCATION_GUIDE.md)

---

## 📊 权限状态说明

### 已授权 ✅

**状态：** 已授权位置权限

**表现：**
- 打卡时直接获取位置
- 无需额外操作
- 体验流畅

**操作：**
- 正常使用打卡功能

### 未授权 ⚠️

**状态：** 尚未授权位置权限

**表现：**
- 首次打卡时弹出授权对话框
- 需要用户点击"允许"

**操作：**
- 点击"允许"授权

### 已拒绝 ❌

**状态：** 用户拒绝了位置权限

**表现：**
- 打卡时提示需要权限
- 自动引导用户开启

**操作：**
1. 点击"去设置"
2. 开启位置权限
3. 返回小程序

---

## 💡 最佳实践

### 1. 首次使用

- ✅ 仔细阅读权限说明
- ✅ 了解位置信息用途
- ✅ 点击"允许"授权
- ✅ 确保GPS已开启

### 2. 日常使用

- ✅ 保持GPS开启
- ✅ 保持网络连接
- ✅ 在室外或窗边打卡
- ✅ 等待定位完成

### 3. 遇到问题

- ✅ 检查GPS和权限
- ✅ 查看错误提示
- ✅ 按照引导操作
- ✅ 联系管理员

---

## 🔄 权限管理操作指南

### 开启位置权限

**通过小程序：**
1. 打开车队管家小程序
2. 点击右上角"..."
3. 点击"设置"
4. 找到"位置信息"
5. 点击开启

**通过微信：**
1. 打开微信
2. 我 → 设置 → 隐私与安全
3. 授权管理
4. 找到"车队管家"
5. 开启"位置信息"

### 关闭位置权限

**注意：** 关闭后将无法使用打卡功能

**操作步骤：**
1. 按照上述路径进入设置
2. 关闭"位置信息"权限

### 重新授权

如果之前拒绝了权限，想要重新授权：

1. 打开小程序
2. 点击打卡按钮
3. 系统会提示"需要位置权限"
4. 点击"去设置"
5. 开启权限
6. 返回小程序

---

## 📞 获取帮助

### 遇到问题？

1. **查看本指南**：大多数问题都能在本指南中找到答案
2. **查看FAQ**：查看常见问题解答
3. **联系管理员**：如果问题仍未解决

### 相关文档

- 📖 [智能定位系统使用指南](./SMART_LOCATION_GUIDE.md) - 了解定位系统工作原理
- 📖 [快速开始指南](./QUICK_START.md) - 快速上手打卡功能
- 📖 [仓库考勤系统使用指南](./WAREHOUSE_ATTENDANCE_GUIDE.md) - 完整功能说明

---

## 📝 更新日志

### v1.3.0 (2025-11-05)
- ✅ 添加完整的权限检查机制
- ✅ 实现智能权限引导
- ✅ 优化权限拒绝后的处理
- ✅ 添加GPS状态检查
- ✅ 改进用户提示和引导

---

**车队管家 - 让打卡更简单，让管理更高效** 🚀
