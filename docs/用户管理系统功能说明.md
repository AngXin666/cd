# 用户管理系统功能说明

## 概述

本系统实现了完整的用户管理功能，包括用户注册、权限管理和个人信息管理。系统确保了数据安全性和用户体验的平衡。

## 一、用户注册与信息管理

### 1.1 添加司机功能

**功能描述**：
- 管理员和超级管理员可以添加新司机
- 系统自动创建用户账号并设置默认密码

**操作流程**：
1. 管理员进入司机管理页面
2. 点击"添加司机"按钮
3. 填写必填信息：
   - 手机号（11位，1开头）
   - 姓名（2-10个中文字符）
   - 车牌号（标准中国车牌格式）
4. 系统验证信息格式
5. 创建成功后显示提示："添加成功，默认密码123456"

**技术实现**：
- 使用Edge Function `create-driver` 创建用户
- 自动创建auth用户和profile记录
- 设置`is_first_login`为true

### 1.2 默认密码设置

**规则**：
- 所有新创建的用户默认密码统一为：`123456`
- 密码在Edge Function中设置，确保安全性
- 用户首次登录后必须修改密码

### 1.3 首次登录强制修改密码

**功能描述**：
- 新用户首次登录时，系统自动跳转到修改密码页面
- 用户必须修改密码后才能使用系统功能

**操作流程**：
1. 用户使用默认密码登录
2. 系统检测到`is_first_login`为true
3. 自动跳转到修改密码页面
4. 用户输入新密码（至少6位）
5. 确认新密码
6. 修改成功后，系统将`is_first_login`设置为false
7. 跳转到首页，可以正常使用系统

**密码要求**：
- 至少6位字符
- 两次输入必须一致
- 不能与默认密码相同

### 1.4 信息验证规则

**手机号验证**：
- 格式：11位数字
- 必须以1开头
- 不能重复（系统唯一）

**姓名验证**：
- 仅接受中文字符
- 长度：2-10个字
- 必填项

**车牌号验证**：
- 标准中国车牌格式
- 格式：省份简称 + 字母 + 5位数字/字母 + 可选后缀
- 示例：京A12345、沪B12345D

## 二、权限管理设置

### 2.1 密码重置权限

**权限说明**：
- 管理员（manager）具备重置用户密码的权限
- 超级管理员（super_admin）具备重置用户密码的权限
- 司机（driver）不具备此权限

### 2.2 重置密码功能

**功能描述**：
- 管理员可以重置任何用户的密码
- 重置后密码统一为：`123456`
- 用户下次登录时需要修改密码

**操作流程**：
1. 管理员进入用户管理页面
2. 找到目标用户
3. 点击"重置密码"按钮
4. 确认重置操作
5. 系统执行重置：
   - 密码重置为123456
   - `is_first_login`设置为true
6. 显示成功提示："密码已重置为123456"

**技术实现**：
- 使用Edge Function `reset-password` 重置密码
- 验证操作者权限（必须是manager或super_admin）
- 自动标记用户为首次登录状态

### 2.3 安全机制

**权限验证**：
- 所有密码操作在Edge Function中执行
- 验证操作者的角色权限
- 记录操作日志（可扩展）

**密码安全**：
- 密码使用Supabase Auth加密存储
- 不在前端明文传输
- 强制首次登录修改密码

## 三、个人信息管理

### 3.1 个人中心字段

**显示字段**：
- 姓名（必填，中文字符）
- 手机号（必填，唯一）
- 车牌号（司机必填）
- 角色（系统自动显示）

**隐藏字段**：
- 昵称（不显示此字段）

### 3.2 编辑资料功能

**可编辑字段**：
- 姓名（必填，中文验证）
- 车牌号（司机必填）

**不可编辑字段**：
- 手机号（注册后不可修改）
- 角色（由管理员管理）

**验证规则**：
- 姓名：2-10个中文字符
- 车牌号：标准中国车牌格式
- 实时验证，错误提示

### 3.3 个人中心统计

**司机端统计**：
- 本月考勤天数
- 本月计件收入
- 本月请假天数
- 管辖仓库数量

**管理员端统计**：
- 管辖仓库数量
- 管辖司机数量
- 待审批请假数量
- 本月总计件收入

**超级管理员端统计**：
- 系统总仓库数
- 系统总用户数
- 待审批请假数量
- 本月总计件收入

## 四、数据库设计

### 4.1 新增字段

**profiles表**：
```sql
-- 车牌号
license_plate text

-- 首次登录标记
is_first_login boolean DEFAULT true NOT NULL
```

### 4.2 字段说明

**license_plate**：
- 类型：text
- 可空：是
- 说明：车牌号，司机角色必填
- 验证：前端验证格式

**is_first_login**：
- 类型：boolean
- 默认值：true
- 说明：首次登录标记
- 用途：强制修改密码

### 4.3 数据迁移

**迁移文件**：`supabase/migrations/add_license_plate_and_first_login.sql`

**迁移内容**：
1. 添加license_plate字段
2. 添加is_first_login字段
3. 为现有用户设置is_first_login为false
4. 添加字段注释

## 五、API接口

### 5.1 用户管理API

**createDriver(phone, name, licensePlate)**
- 功能：创建司机用户
- 参数：
  - phone: 手机号
  - name: 姓名
  - licensePlate: 车牌号（可选）
- 返回：{success: boolean, error?: string, userId?: string}
- 权限：manager, super_admin

**resetUserPassword(userId)**
- 功能：重置用户密码
- 参数：userId - 用户ID
- 返回：{success: boolean, error?: string}
- 权限：manager, super_admin

**changePassword(newPassword)**
- 功能：修改当前用户密码
- 参数：newPassword - 新密码
- 返回：{success: boolean, error?: string}
- 权限：所有登录用户

### 5.2 验证API

**validatePhone(phone)**
- 功能：验证手机号格式
- 参数：phone - 手机号
- 返回：boolean

**validateChineseName(name)**
- 功能：验证中文姓名
- 参数：name - 姓名
- 返回：boolean

**validateLicensePlate(plate)**
- 功能：验证车牌号格式
- 参数：plate - 车牌号
- 返回：boolean

## 六、Edge Functions

### 6.1 create-driver

**功能**：创建司机用户

**请求参数**：
```json
{
  "phone": "13800138000",
  "name": "张三",
  "licensePlate": "京A12345"
}
```

**响应**：
```json
{
  "success": true,
  "message": "司机创建成功，默认密码为123456",
  "userId": "uuid"
}
```

**权限验证**：
- 验证请求者token
- 检查角色（manager或super_admin）
- 验证手机号唯一性

**操作流程**：
1. 验证请求者权限
2. 验证手机号格式和唯一性
3. 创建auth用户（密码123456）
4. 创建profile记录
5. 设置is_first_login为true
6. 返回结果

### 6.2 reset-password

**功能**：重置用户密码

**请求参数**：
```json
{
  "userId": "uuid"
}
```

**响应**：
```json
{
  "success": true,
  "message": "密码已重置为123456"
}
```

**权限验证**：
- 验证请求者token
- 检查角色（manager或super_admin）

**操作流程**：
1. 验证请求者权限
2. 重置用户密码为123456
3. 设置is_first_login为true
4. 返回结果

## 七、用户体验优化

### 7.1 错误提示

**清晰的错误信息**：
- "手机号格式不正确"
- "姓名只能包含中文字符（2-10个字）"
- "车牌号格式不正确"
- "手机号已存在"
- "密码至少6位"
- "两次密码不一致"

### 7.2 成功提示

**操作成功反馈**：
- "添加成功，默认密码123456"
- "密码已重置为123456"
- "密码修改成功"
- "资料更新成功"

### 7.3 表单验证

**实时验证**：
- 输入时实时检查格式
- 错误时显示红色提示
- 正确时显示绿色提示

**提交验证**：
- 提交前完整验证
- 验证失败阻止提交
- 显示具体错误信息

## 八、安全性说明

### 8.1 密码安全

**加密存储**：
- 使用Supabase Auth加密
- 不在数据库明文存储
- 不在前端明文传输

**强制修改**：
- 首次登录必须修改
- 重置后必须修改
- 确保密码安全性

### 8.2 权限控制

**操作权限**：
- 创建用户：manager, super_admin
- 重置密码：manager, super_admin
- 修改密码：所有用户

**数据权限**：
- 用户只能修改自己的资料
- 管理员可以管理下属用户
- 超级管理员可以管理所有用户

### 8.3 数据验证

**前端验证**：
- 格式验证
- 长度验证
- 必填验证

**后端验证**：
- Edge Function验证
- 数据库约束
- 权限验证

## 九、测试建议

### 9.1 功能测试

**用户注册**：
- 测试添加司机功能
- 验证默认密码
- 测试信息验证

**首次登录**：
- 测试强制修改密码
- 验证密码要求
- 测试修改成功后的流程

**密码重置**：
- 测试重置功能
- 验证权限控制
- 测试重置后的登录流程

### 9.2 验证测试

**手机号验证**：
- 测试正确格式
- 测试错误格式
- 测试重复手机号

**姓名验证**：
- 测试中文字符
- 测试英文字符（应失败）
- 测试长度限制

**车牌号验证**：
- 测试标准格式
- 测试错误格式
- 测试各省份简称

### 9.3 安全测试

**权限测试**：
- 测试无权限操作
- 测试跨权限操作
- 测试token验证

**数据安全**：
- 测试密码加密
- 测试数据隔离
- 测试SQL注入防护

## 十、常见问题

### Q1: 忘记密码怎么办？
A: 联系管理员重置密码，重置后密码为123456，下次登录需要修改。

### Q2: 可以修改手机号吗？
A: 不可以，手机号是账号的唯一标识，注册后不可修改。

### Q3: 车牌号必须填写吗？
A: 司机角色必须填写车牌号，管理员角色可选。

### Q4: 密码有什么要求？
A: 密码至少6位字符，建议使用字母、数字和符号组合。

### Q5: 首次登录为什么要修改密码？
A: 为了账号安全，系统要求首次登录必须修改默认密码。

## 十一、未来扩展

### 11.1 功能扩展

**可能的扩展**：
- 手机号验证码登录
- 密码找回功能
- 多因素认证
- 登录日志记录
- 操作审计日志

### 11.2 安全增强

**可能的增强**：
- 密码复杂度要求
- 密码过期策略
- 登录失败锁定
- IP白名单
- 设备绑定

### 11.3 用户体验

**可能的优化**：
- 记住登录状态
- 生物识别登录
- 快捷登录方式
- 个性化设置
- 消息通知

## 总结

本用户管理系统实现了完整的用户注册、权限管理和个人信息管理功能。系统注重安全性和用户体验，通过多层验证和权限控制确保数据安全，通过清晰的提示和流畅的操作流程提升用户体验。系统具有良好的扩展性，可以根据业务需求进行功能扩展和优化。
