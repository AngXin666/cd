# 请假审批数据显示问题排查指南

## 问题描述

用户反馈：超级管理员可以选择仓库了，但是没有加载数据，看不到司机数据。

## 可能的原因

### 1. 数据库中没有请假/离职申请数据

**现象：** 页面显示"暂无司机数据"提示

**原因：** 
- 数据库中没有任何请假申请记录
- 数据库中没有任何离职申请记录
- 司机还没有提交过任何申请

**解决方案：**
1. 使用司机账号登录系统
2. 提交一些测试用的请假申请
3. 刷新请假审批管理页面
4. 应该能看到司机数据

### 2. 数据加载失败

**现象：** 页面一直显示加载中，或者显示空白

**原因：**
- 网络连接问题
- Supabase服务异常
- API调用失败

**排查方法：**
1. 打开浏览器开发者工具（F12）
2. 切换到Console标签
3. 查看是否有错误信息
4. 查看Network标签，检查API请求是否成功

**解决方案：**
- 检查网络连接
- 检查Supabase服务状态
- 查看错误日志，根据具体错误信息处理

### 3. 权限问题

**现象：** 普通管理员看不到数据，但超级管理员可以

**原因：**
- 普通管理员没有被分配仓库
- 普通管理员管辖的仓库下没有司机
- 普通管理员管辖的仓库下的司机没有提交申请

**排查方法：**
1. 使用超级管理员账号登录
2. 进入"仓库管理员分配"页面
3. 检查该普通管理员是否被分配了仓库
4. 进入"司机仓库分配"页面
5. 检查该仓库下是否有司机

**解决方案：**
1. 为普通管理员分配仓库
2. 为仓库分配司机
3. 让司机提交请假申请

### 4. 仓库筛选问题

**现象：** 选择特定仓库后看不到数据，但选择"全部仓库"可以

**原因：**
- 该仓库下没有司机
- 该仓库下的司机没有提交申请

**解决方案：**
1. 切换到"全部仓库"查看
2. 或者选择其他有数据的仓库

## 调试方法

### 方法1：查看控制台日志

我们在代码中添加了详细的调试日志，可以通过浏览器控制台查看：

1. **打开浏览器开发者工具**
   - Chrome/Edge: 按F12或右键点击页面选择"检查"
   - Firefox: 按F12或右键点击页面选择"检查元素"
   - Safari: 按Option+Command+I

2. **切换到Console标签**

3. **刷新页面**

4. **查看日志输出**

日志会显示以下信息：
```
开始加载数据...
仓库数据: X 个
用户数据: X 个
司机数量: X 个
当前用户角色: super_admin / manager
请假申请数据: X 条
离职申请数据: X 条
数据加载完成
计算司机统计数据...
可见的请假申请: X 条
可见的离职申请: X 条
司机总数: X 个
统计结果: X 个司机有数据
```

### 方法2：检查数据库

使用Supabase控制台直接查看数据库：

1. **登录Supabase控制台**
   - 访问 https://supabase.com
   - 登录账号
   - 选择项目

2. **查看表数据**
   - 点击左侧菜单的"Table Editor"
   - 查看以下表：
     - `profiles` - 用户表（包括司机）
     - `warehouses` - 仓库表
     - `leave_applications` - 请假申请表
     - `resignation_applications` - 离职申请表
     - `driver_warehouse_assignments` - 司机仓库分配表
     - `manager_warehouse_assignments` - 管理员仓库分配表

3. **检查数据**
   - 确认是否有司机用户（role='driver'）
   - 确认是否有请假申请记录
   - 确认司机是否被分配到仓库
   - 确认管理员是否被分配到仓库

### 方法3：使用SQL查询

在Supabase SQL Editor中执行以下查询：

```sql
-- 查看所有司机
SELECT id, phone, email, role, created_at 
FROM profiles 
WHERE role = 'driver';

-- 查看所有请假申请
SELECT * FROM leave_applications 
ORDER BY created_at DESC;

-- 查看所有离职申请
SELECT * FROM resignation_applications 
ORDER BY created_at DESC;

-- 查看司机仓库分配
SELECT 
  dwa.driver_id,
  p.phone as driver_phone,
  w.name as warehouse_name
FROM driver_warehouse_assignments dwa
JOIN profiles p ON p.id = dwa.driver_id
JOIN warehouses w ON w.id = dwa.warehouse_id;

-- 查看管理员仓库分配
SELECT 
  mwa.manager_id,
  p.phone as manager_phone,
  w.name as warehouse_name
FROM manager_warehouse_assignments mwa
JOIN profiles p ON p.id = mwa.manager_id
JOIN warehouses w ON w.id = mwa.warehouse_id;
```

## 常见场景及解决方案

### 场景1：新系统，没有任何数据

**问题：** 刚部署的系统，数据库是空的

**解决步骤：**
1. 创建测试仓库
2. 注册司机账号
3. 分配司机到仓库
4. 司机提交请假申请
5. 刷新请假审批页面

### 场景2：有司机但没有申请

**问题：** 系统中有司机，但司机没有提交过申请

**解决步骤：**
1. 使用司机账号登录
2. 进入"请假申请"页面
3. 提交一个测试请假申请
4. 使用管理员账号登录
5. 进入请假审批页面
6. 应该能看到司机数据

### 场景3：普通管理员看不到数据

**问题：** 普通管理员登录后看不到任何数据

**解决步骤：**
1. 使用超级管理员账号登录
2. 进入"仓库管理员分配"页面
3. 为该普通管理员分配仓库
4. 确保该仓库下有司机
5. 确保司机提交了申请
6. 普通管理员重新登录
7. 应该能看到数据

### 场景4：选择仓库后没有数据

**问题：** 选择特定仓库后显示"暂无司机数据"

**解决步骤：**
1. 切换到"全部仓库"
2. 查看是否有其他仓库的数据
3. 如果有，说明当前选择的仓库确实没有数据
4. 如果没有，说明整个系统都没有数据

## 数据显示逻辑说明

### 重要提示

**请假审批管理页面只显示有请假或离职申请的司机。**

这意味着：
- 如果司机没有提交过任何请假申请，不会显示
- 如果司机没有提交过任何离职申请，不会显示
- 只有提交过至少一次申请的司机才会出现在列表中

### 为什么这样设计？

1. **功能定位**：这是"请假审批管理"页面，不是"司机管理"页面
2. **数据相关性**：只显示与请假审批相关的司机
3. **界面简洁**：避免显示大量无关的司机信息
4. **性能考虑**：减少不必要的数据加载和渲染

### 如果需要查看所有司机

如果需要查看所有司机（包括没有申请的），应该：
1. 进入"司机管理"页面（如果有）
2. 或者进入"司机仓库分配"页面
3. 这些页面会显示所有司机，无论是否有申请

## 测试数据创建指南

### 快速创建测试数据

如果需要快速创建一些测试数据来验证功能：

#### 1. 创建仓库
```sql
INSERT INTO warehouses (name, location, capacity, status)
VALUES 
  ('东区仓库', '北京市朝阳区', 100, 'active'),
  ('西区仓库', '北京市海淀区', 80, 'active');
```

#### 2. 创建司机账号
- 使用注册功能注册几个司机账号
- 或者使用SQL插入（需要先通过认证系统创建用户）

#### 3. 分配司机到仓库
```sql
-- 假设司机ID为 'driver-uuid-1' 和 'driver-uuid-2'
-- 假设仓库ID为 'warehouse-uuid-1' 和 'warehouse-uuid-2'
INSERT INTO driver_warehouse_assignments (driver_id, warehouse_id)
VALUES 
  ('driver-uuid-1', 'warehouse-uuid-1'),
  ('driver-uuid-2', 'warehouse-uuid-2');
```

#### 4. 创建请假申请
```sql
INSERT INTO leave_applications (
  user_id, 
  warehouse_id, 
  leave_type, 
  start_date, 
  end_date, 
  reason, 
  status
)
VALUES 
  (
    'driver-uuid-1', 
    'warehouse-uuid-1', 
    'sick', 
    '2024-01-15', 
    '2024-01-17', 
    '感冒需要休息', 
    'pending'
  ),
  (
    'driver-uuid-2', 
    'warehouse-uuid-2', 
    'personal', 
    '2024-01-20', 
    '2024-01-22', 
    '家中有事', 
    'pending'
  );
```

## 联系支持

如果按照以上步骤仍然无法解决问题，请联系技术支持团队，并提供以下信息：

1. **用户角色**：超级管理员 / 普通管理员
2. **问题描述**：详细描述看到的现象
3. **控制台日志**：复制浏览器控制台的日志信息
4. **截图**：提供页面截图
5. **操作步骤**：描述导致问题的操作步骤

---

**文档版本：** 1.0  
**更新日期：** 2024-01-15  
**适用版本：** 车队管家 v2.0
