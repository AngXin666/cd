# 车辆历史记录完整功能说明

## 功能概述

车辆历史记录页面现已完善，可以查看车辆的完整提车和还车信息，包括所有相关照片。

## 功能特性

### 1. 照片分类展示

历史记录页面支持按类别查看不同类型的照片，提供更清晰的信息组织：

#### 提车信息照片分类

- **车辆照片**：7个角度的车辆照片
  - 左前方
  - 右前方
  - 左后方
  - 右后方
  - 仪表盘
  - 后门
  - 货箱
  - 其他提车照片（pickup_photos 数组）

- **行驶证照片**：车辆行驶证
  - 行驶证主页
  - 行驶证副页
  - 行驶证副页背面
  - 其他行驶证照片（registration_photos 数组）

- **身份证照片**：提车司机身份证
  - 身份证正面
  - 身份证反面

- **驾驶证照片**：提车司机驾驶证
  - 驾驶证照片

- **车损特写**：提车时的车辆损伤照片
  - 所有车损照片（damage_photos 数组）

#### 还车信息照片分类

- **还车照片**：还车时拍摄的车辆照片
  - 所有还车照片（return_photos 数组）

- **车损特写**：还车时的车辆损伤照片
  - 所有车损照片（damage_photos 数组）

### 2. 用户界面

#### 页面布局

1. **车辆基本信息卡片**
   - 车牌号（大标题）
   - 品牌型号
   - 颜色
   - 车架号
   - 当前状态（使用中/已停用）

2. **Tab 切换**
   - 提车信息
   - 还车信息

3. **照片分类标签**
   - 圆角按钮设计
   - 选中状态高亮显示
   - 点击切换不同类别的照片

4. **照片网格展示**
   - 3列网格布局
   - 正方形缩略图
   - 点击可预览大图
   - 支持左右滑动查看

#### 交互体验

- **照片预览**：点击任意照片可全屏预览，支持左右滑动查看同类别的所有照片
- **分类切换**：点击分类标签即可切换查看不同类型的照片
- **空状态提示**：如果某个类别没有照片，显示"暂无照片"提示

### 3. 数据来源

#### vehicles 表字段

```typescript
// 车辆照片
left_front_photo: string | null
right_front_photo: string | null
left_rear_photo: string | null
right_rear_photo: string | null
dashboard_photo: string | null
rear_door_photo: string | null
cargo_box_photo: string | null

// 行驶证照片
driving_license_main_photo: string | null
driving_license_sub_photo: string | null
driving_license_sub_back_photo: string | null

// 照片数组
pickup_photos: string[] | null
registration_photos: string[] | null
damage_photos: string[] | null
return_photos: string[] | null
```

#### driver_licenses 表字段

```typescript
// 身份证照片
id_card_photo_front: string | null
id_card_photo_back: string | null

// 驾驶证照片
driving_license_photo: string | null
```

### 4. API 增强

#### getVehicleByPlateNumber 函数

```typescript
/**
 * 根据车牌号获取车辆信息（用于历史记录页面）
 * @param plateNumber 车牌号
 * @returns 车辆信息，包含司机信息和证件照片
 */
export async function getVehicleByPlateNumber(plateNumber: string): Promise<VehicleWithDriver | null>
```

**功能增强：**
1. 查询 vehicles 表获取车辆基本信息和照片
2. 关联查询 profiles 表获取司机信息
3. 如果有司机，额外查询 driver_licenses 表获取证件照片
4. 将证件照片添加到返回数据的 driver_license 字段中

### 5. 类型定义

#### VehicleWithDriver 接口

```typescript
export interface VehicleWithDriver extends Vehicle {
  driver_id?: string | null
  driver_name?: string | null
  driver_phone?: string | null
  driver_email?: string | null
  driver?: {
    id: string
    name: string | null
    phone: string | null
    email: string | null
  } | null
  driver_license?: {
    id_card_photo_front: string | null
    id_card_photo_back: string | null
    driving_license_photo: string | null
  } | null
}
```

## 使用场景

### 场景 1：查看提车记录

1. 超级管理员进入"车辆管理"页面
2. 找到已还车的车辆（状态为"已停用"）
3. 点击"查看历史记录"按钮
4. 默认显示"提车信息"标签页
5. 可以看到：
   - 提车时间
   - 司机姓名和电话
   - 默认显示"车辆照片"分类
6. 点击其他分类标签查看：
   - 行驶证照片
   - 身份证照片
   - 驾驶证照片
   - 车损特写

### 场景 2：查看还车记录

1. 在历史记录页面点击"还车信息"标签
2. 可以看到：
   - 还车时间
   - 默认显示"还车照片"分类
3. 点击"车损特写"标签查看还车时的车损照片

### 场景 3：对比提车和还车照片

1. 在"提车信息"标签查看提车时的车辆状态
2. 切换到"还车信息"标签查看还车时的车辆状态
3. 对比车损照片，了解车辆使用期间的变化

## 技术实现

### 照片获取逻辑

```typescript
const getPhotos = (category: PhotoCategory, type: 'pickup' | 'return'): string[] => {
  // 根据类别和类型（提车/还车）返回对应的照片数组
  // 自动过滤空值，只返回有效的照片 URL
}
```

### 照片分类标签渲染

```typescript
const renderPhotoTabs = (type: 'pickup' | 'return') => {
  // 根据类型显示不同的分类标签
  // 还车信息只显示"还车照片"和"车损特写"
  // 提车信息显示所有分类
}
```

### 照片网格渲染

```typescript
const renderPhotoGrid = (photos: string[]) => {
  // 3列网格布局
  // 正方形缩略图
  // 点击预览功能
}
```

## 优势特点

1. **信息完整**：显示所有相关照片，不遗漏任何细节
2. **分类清晰**：按照照片类型分类，方便快速查找
3. **操作简单**：点击标签即可切换，点击照片即可预览
4. **视觉美观**：卡片式设计，圆角按钮，网格布局
5. **响应迅速**：照片按需加载，切换流畅

## 注意事项

1. **照片存储**：所有照片 URL 都存储在 Supabase Storage 中
2. **数据一致性**：提车和还车照片分别存储在不同的字段中
3. **空值处理**：如果某个类别没有照片，会显示"暂无照片"提示
4. **司机信息**：只有提车信息会显示司机的证件照片
5. **历史局限**：当前只能查看最近一次的提车和还车信息

## 后续优化建议

1. **完整历史记录**
   - 实现 vehicle_records 表的记录功能
   - 支持查看车辆的所有历史提车和还车记录
   - 每次提车/还车创建新的记录，而不是覆盖

2. **照片对比功能**
   - 提供提车和还车照片的并排对比视图
   - 高亮显示车损变化

3. **照片下载**
   - 支持批量下载某个类别的所有照片
   - 生成 PDF 报告

4. **搜索和筛选**
   - 按时间范围筛选历史记录
   - 按司机筛选历史记录

## 总结

车辆历史记录页面现已完善，提供了全面的照片查看功能。通过分类标签和网格布局，用户可以方便地查看车辆的提车和还车信息，包括所有相关照片。这为车队管理提供了完整的车辆使用记录，便于追溯和管理。

修复日期：2025-11-23
功能版本：v2.0
