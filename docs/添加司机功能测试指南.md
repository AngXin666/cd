# 添加司机功能测试指南

## 问题现状

用户反馈：创建司机失败，提示"创建司机失败: Internal Server Error"。

## 问题根本原因

**触发器冲突**：
- 数据库有一个触发器`handle_new_user`，当用户的`confirmed_at`字段从NULL变为非NULL时，会自动在`profiles`表中插入一条记录
- Edge Function使用`phone_confirm: true`创建用户，导致`confirmed_at`立即被设置
- 触发器自动插入profiles记录后，Edge Function再次尝试插入相同的记录，导致主键冲突
- 错误信息：`duplicate key value violates unique constraint "profiles_pkey"`

## 解决方案

**修改Edge Function逻辑**（v4版本）：
1. 创建Auth用户时设置`phone_confirm: true`
2. 等待1秒，让触发器完成profiles记录的创建
3. 使用UPDATE而不是INSERT来设置姓名、车牌号等信息
4. 避免主键冲突

**代码变更**：
```typescript
// 旧代码（v3）- 会导致冲突
const {error: profileInsertError} = await supabase.from('profiles').insert({
  id: newUser.user.id,
  phone,
  name,
  license_plate: licensePlate || null,
  role: 'driver',
  is_first_login: true
})

// 新代码（v4）- 避免冲突
// 等待触发器创建profile记录
await new Promise((resolve) => setTimeout(resolve, 1000))

// 更新profile记录
const {error: profileUpdateError} = await supabase
  .from('profiles')
  .update({
    name,
    license_plate: licensePlate || null,
    is_first_login: true
  })
  .eq('id', newUser.user.id)
```

## 已完成的优化

### 1. Edge Function优化（v4版本）

**改进内容**：
- ✅ 修复触发器冲突问题
- ✅ 使用UPDATE代替INSERT
- ✅ 添加等待时间让触发器完成
- ✅ 添加详细的控制台日志
- ✅ 改进错误处理逻辑
- ✅ 修复`.single()`改为`.maybeSingle()`
- ✅ 返回更详细的错误信息
- ✅ 添加事务回滚机制

**日志输出**：
```
开始处理创建司机请求
请求参数: {phone: "13800138000", name: "张三", licensePlate: "京A12345"}
验证用户身份...
用户认证成功: xxx-xxx-xxx
检查用户角色...
用户角色: super_admin
检查手机号是否已存在...
创建Auth用户...
Auth用户创建成功: xxx-xxx-xxx
等待触发器创建Profile记录...
更新Profile记录...
司机创建成功
```

### 2. 前端错误日志优化

**改进内容**：
- ✅ 检查HTTP响应状态码
- ✅ 记录详细错误信息
- ✅ 显示具体错误原因

## 测试步骤

### 步骤1：打开浏览器开发者工具

1. 按F12打开开发者工具
2. 切换到"Console"（控制台）标签
3. 清空现有日志（点击🚫图标）

### 步骤2：尝试添加司机

1. 登录管理员或超级管理员账号
2. 进入"司机管理"或"司机仓库分配"页面
3. 点击"添加司机"按钮
4. 填写信息：
   - 手机号：13800138000（或其他未使用的手机号）
   - 姓名：张三
   - 车牌号：京A12345（可选）
5. 点击"确认添加"

### 步骤3：查看控制台日志

**正常情况**：
```javascript
// 前端日志
Edge Function返回结果: {
  success: true, 
  message: "司机创建成功，默认密码为123456", 
  userId: "xxx-xxx-xxx"
}

// 页面提示
"添加成功，默认密码123456"
```

**错误情况**：
```javascript
// 前端日志
Edge Function响应错误: 500 Internal Server Error
错误详情: {"success":false,"error":"创建用户失败: User already registered"}

// 页面提示
"创建司机失败: Internal Server Error"
```

### 步骤4：查看Network请求

1. 切换到"Network"（网络）标签
2. 找到`create-driver`请求
3. 查看请求详情：

**请求信息**：
- URL: `https://backend.appmiaoda.com/projects/supabase244341780043055104/functions/v1/create-driver`
- Method: POST
- Status: 200（成功）或 500（失败）

**请求头**：
```
Content-Type: application/json
Authorization: Bearer eyJhbGc...
```

**请求体**：
```json
{
  "phone": "13800138000",
  "name": "张三",
  "licensePlate": "京A12345"
}
```

**响应体**：
```json
{
  "success": true,
  "message": "司机创建成功，默认密码为123456",
  "userId": "xxx-xxx-xxx"
}
```

或错误响应：
```json
{
  "success": false,
  "error": "创建用户失败: User already registered"
}
```

## 常见错误及解决方法

### 错误1：手机号已存在

**错误信息**：
```
手机号已存在
```

**原因**：
- 该手机号已被注册
- 之前创建过该司机

**解决方法**：
1. 使用其他手机号
2. 或者在用户管理中查找该司机
3. 如果是测试数据，可以删除后重新创建

### 错误2：创建用户失败 - User already registered

**错误信息**：
```
创建用户失败: User already registered
```

**原因**：
- Supabase Auth中已存在该手机号
- 但profiles表中没有记录（数据不一致）

**解决方法**：
1. 检查auth.users表
2. 检查profiles表
3. 确保数据一致性
4. 如果是测试环境，可以清理数据后重试

### 错误3：创建司机资料失败

**错误信息**：
```
创建司机资料失败: duplicate key value violates unique constraint "profiles_pkey"
```

**原因**：
- profiles表插入失败
- 主键冲突
- 触发器错误

**解决方法**：
1. 检查profiles表结构
2. 检查触发器配置
3. 查看数据库日志
4. 确认RLS策略正确

### 错误4：无权限执行此操作

**错误信息**：
```
无权限执行此操作
```

**原因**：
- 当前用户不是manager或super_admin
- 用户角色配置错误

**解决方法**：
1. 确认当前用户角色
2. 使用管理员账号登录
3. 检查profiles表中的role字段

### 错误5：认证失败

**错误信息**：
```
认证失败
```

**原因**：
- Session过期
- Token无效
- 未登录

**解决方法**：
1. 重新登录
2. 刷新页面
3. 清除浏览器缓存

## 数据库检查

### 检查auth.users表

```sql
-- 查看所有用户
SELECT id, phone, email, created_at, confirmed_at 
FROM auth.users 
ORDER BY created_at DESC 
LIMIT 10;

-- 查找特定手机号
SELECT * FROM auth.users WHERE phone = '13800138000';
```

### 检查profiles表

```sql
-- 查看所有司机
SELECT id, phone, name, role, license_plate, created_at 
FROM profiles 
WHERE role = 'driver' 
ORDER BY created_at DESC 
LIMIT 10;

-- 查找特定手机号
SELECT * FROM profiles WHERE phone = '13800138000';
```

### 检查数据一致性

```sql
-- 查找auth.users中有但profiles中没有的用户
SELECT u.id, u.phone 
FROM auth.users u 
LEFT JOIN profiles p ON u.id = p.id 
WHERE p.id IS NULL;

-- 查找profiles中有但auth.users中没有的用户
SELECT p.id, p.phone 
FROM profiles p 
LEFT JOIN auth.users u ON p.id = u.id 
WHERE u.id IS NULL;
```

## Edge Function日志查看

### 方法1：Supabase Dashboard

1. 登录Supabase Dashboard
2. 进入项目
3. 点击"Edge Functions"
4. 选择"create-driver"
5. 查看"Logs"标签

### 方法2：实时日志

在调用Edge Function时，日志会实时输出到Supabase日志系统。

**正常流程日志**：
```
开始处理创建司机请求
请求参数: {phone: "13800138000", name: "张三"}
验证用户身份...
用户认证成功: abc-123-def
检查用户角色...
用户角色: super_admin
检查手机号是否已存在...
创建Auth用户...
Auth用户创建成功: xyz-456-uvw
创建Profile记录...
司机创建成功
```

**错误流程日志**：
```
开始处理创建司机请求
请求参数: {phone: "13800138000", name: "张三"}
验证用户身份...
用户认证成功: abc-123-def
检查用户角色...
用户角色: super_admin
检查手机号是否已存在...
创建Auth用户...
创建用户失败: {message: "User already registered", ...}
```

## 测试用例

### 测试用例1：正常创建司机

**前提条件**：
- 已登录管理员账号
- 手机号未被使用

**操作步骤**：
1. 进入司机管理页面
2. 点击"添加司机"
3. 输入手机号：13900139000
4. 输入姓名：测试司机
5. 输入车牌号：京B88888
6. 点击"确认添加"

**预期结果**：
- 显示"添加成功，默认密码123456"
- 司机列表中出现新司机
- 控制台显示成功日志

### 测试用例2：手机号重复

**前提条件**：
- 已登录管理员账号
- 手机号已被使用

**操作步骤**：
1. 进入司机管理页面
2. 点击"添加司机"
3. 输入已存在的手机号
4. 输入姓名：测试司机2
5. 点击"确认添加"

**预期结果**：
- 显示"手机号已存在"
- 不创建新用户
- 控制台显示"手机号已存在"日志

### 测试用例3：手机号格式错误

**前提条件**：
- 已登录管理员账号

**操作步骤**：
1. 进入司机管理页面
2. 点击"添加司机"
3. 输入错误格式手机号：12345
4. 输入姓名：测试司机
5. 点击"确认添加"

**预期结果**：
- 显示"手机号格式不正确"
- 不调用Edge Function
- 前端验证拦截

### 测试用例4：姓名格式错误

**前提条件**：
- 已登录管理员账号

**操作步骤**：
1. 进入司机管理页面
2. 点击"添加司机"
3. 输入手机号：13900139000
4. 输入英文姓名：Test Driver
5. 点击"确认添加"

**预期结果**：
- 显示"姓名只能包含中文字符（2-10个字）"
- 不调用Edge Function
- 前端验证拦截

### 测试用例5：无权限用户

**前提条件**：
- 已登录司机账号

**操作步骤**：
1. 尝试访问司机管理页面
2. 或直接调用API

**预期结果**：
- 无法访问管理页面
- 或显示"无权限执行此操作"

## 问题排查流程

### 流程图

```
开始
  ↓
检查用户是否登录？
  ↓ 是
检查用户角色是否为manager/super_admin？
  ↓ 是
检查手机号格式是否正确？
  ↓ 是
检查姓名格式是否正确？
  ↓ 是
调用Edge Function
  ↓
Edge Function验证权限
  ↓
检查手机号是否已存在？
  ↓ 否
创建Auth用户
  ↓ 成功
创建Profile记录
  ↓ 成功
返回成功
  ↓
结束
```

### 详细步骤

1. **前端验证**
   - [ ] 用户已登录
   - [ ] 用户角色正确
   - [ ] 手机号格式正确
   - [ ] 姓名格式正确

2. **Edge Function验证**
   - [ ] Authorization头存在
   - [ ] Token有效
   - [ ] 用户角色正确
   - [ ] 手机号未被使用

3. **创建Auth用户**
   - [ ] Supabase Auth服务正常
   - [ ] 手机号格式符合要求
   - [ ] 密码设置成功
   - [ ] phone_confirm设置成功

4. **创建Profile记录**
   - [ ] profiles表存在
   - [ ] 字段类型匹配
   - [ ] 约束条件满足
   - [ ] RLS策略允许插入

5. **返回结果**
   - [ ] 成功消息正确
   - [ ] userId返回
   - [ ] 前端显示成功提示

## 联系支持

如果按照以上步骤仍无法解决问题，请提供以下信息：

1. **浏览器控制台日志**
   - Console标签的完整日志
   - Network标签的请求详情

2. **操作步骤**
   - 详细的操作步骤
   - 输入的数据

3. **错误信息**
   - 完整的错误消息
   - 错误发生的时间

4. **环境信息**
   - 浏览器类型和版本
   - 操作系统
   - 用户角色

5. **数据库状态**
   - auth.users表记录数
   - profiles表记录数
   - 是否有数据不一致

## 总结

**问题根源**：
- 数据库触发器与Edge Function手动插入profiles记录冲突
- 导致主键重复错误

**解决方案**：
- 修改Edge Function，使用UPDATE代替INSERT
- 等待触发器完成后再更新记录

**当前状态**：
- ✅ Edge Function已部署（v4版本）
- ✅ 修复触发器冲突问题
- ✅ 添加了详细日志
- ✅ 优化了错误处理
- ✅ 改进了错误消息

**下一步**：
1. 按照测试步骤操作
2. 查看控制台日志
3. 根据错误信息排查
4. 如有问题，提供详细信息

**预期效果**：
- ✅ 能够成功创建司机
- ✅ 错误信息清晰明确
- ✅ 便于快速定位问题
- ✅ 触发器正常工作
- ✅ 数据一致性保证
