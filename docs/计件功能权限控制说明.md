# 计件功能权限控制说明文档

## 概述

本文档详细说明了车队管家系统中计件功能的权限控制机制，包括权限设计原则、实现方式、安全策略等内容。

---

## 权限设计原则

### 1. 最小权限原则

每个角色只拥有完成其工作所需的最小权限集合：

- **司机**：只能查看和管理自己的计件记录
- **普通管理员**：只能查看管辖仓库的计件数据，不能修改
- **超级管理员**：拥有完整的系统管理权限

### 2. 职责分离原则

不同角色的职责明确分离：

- **数据录入**：由超级管理员负责
- **数据查看**：普通管理员和超级管理员都可以
- **数据分析**：基于查看权限进行

### 3. 安全防护原则

采用多层防护机制：

- **UI层防护**：隐藏未授权的操作按钮
- **数据库层防护**：通过RLS（行级安全）策略控制数据访问
- **API层防护**：在数据库查询时自动应用权限策略

---

## 角色权限矩阵

### 计件记录权限

| 操作 | 司机 | 普通管理员 | 超级管理员 |
|------|------|-----------|-----------|
| 查看自己的记录 | ✅ | - | ✅ |
| 查看管辖仓库的记录 | - | ✅ | ✅ |
| 查看所有记录 | - | - | ✅ |
| 添加记录 | - | - | ✅ |
| 编辑记录 | - | - | ✅ |
| 删除记录 | - | - | ✅ |
| 查看统计数据 | ✅ | ✅ | ✅ |
| 筛选数据 | ✅ | ✅ | ✅ |
| 导出数据 | - | - | ✅ |

### 仓库访问权限

| 角色 | 可访问的仓库 |
|------|-------------|
| 司机 | 分配给自己的仓库 |
| 普通管理员 | 管辖的仓库 |
| 超级管理员 | 所有仓库 |

---

## 权限实现机制

### 1. UI层权限控制

#### 1.1 页面访问控制

通过路由配置和认证守卫控制页面访问：

```typescript
// 使用 useAuth hook 进行认证检查
const {user} = useAuth({guard: true})

// 如果未登录，自动跳转到登录页面
```

#### 1.2 按钮显示控制

根据用户角色动态显示/隐藏操作按钮：

**普通管理员页面：**
```typescript
// 只显示查看详情按钮
<View className="flex gap-2 mt-2">
  <View onClick={() => handleViewDetail(record)}>
    <Text>查看详情</Text>
  </View>
</View>
```

**超级管理员页面：**
```typescript
// 显示所有操作按钮
<View className="flex gap-2 mt-2">
  <View onClick={() => handleViewDetail(record)}>
    <Text>查看详情</Text>
  </View>
  <View onClick={() => handleEditRecord(record)}>
    <Text>编辑</Text>
  </View>
  <View onClick={() => handleDeleteRecord(record)}>
    <Text>删除</Text>
  </View>
</View>
```

#### 1.3 功能区域控制

根据角色显示/隐藏整个功能区域：

```typescript
// 超级管理员才显示添加按钮
{isSuperAdmin && (
  <View onClick={handleAddRecord}>
    <Text>添加计件记录</Text>
  </View>
)}
```

### 2. 数据访问控制

#### 2.1 仓库数据加载

**普通管理员：**
```typescript
// 只加载管辖的仓库
const warehouses = await getManagerWarehouses(user.id)
```

**超级管理员：**
```typescript
// 加载所有仓库
const warehouses = await getAllWarehouses()
```

#### 2.2 计件记录加载

**普通管理员：**
```typescript
// 只加载管辖仓库的记录
const records = await getPieceWorkRecordsByWarehouse(
  warehouseId,
  startDate,
  endDate
)
```

**超级管理员：**
```typescript
// 可以加载所有仓库的记录
const allRecords = await Promise.all(
  warehouses.map(w => 
    getPieceWorkRecordsByWarehouse(w.id, startDate, endDate)
  )
)
```

### 3. 数据库层权限控制

#### 3.1 行级安全策略（RLS）

数据库表启用了行级安全（Row Level Security），确保数据访问的安全性：

```sql
-- 启用行级安全
ALTER TABLE piece_work_records ENABLE ROW LEVEL SECURITY;

-- 超级管理员可以管理所有计件记录
CREATE POLICY "超级管理员可以管理所有计件记录" 
ON piece_work_records
FOR ALL TO authenticated
USING (is_super_admin(auth.uid()));

-- 司机可以查看自己的计件记录
CREATE POLICY "司机可以查看自己的计件记录" 
ON piece_work_records
FOR SELECT TO authenticated
USING (auth.uid() = user_id);

-- 管理员可以查看管辖仓库的计件记录
CREATE POLICY "管理员可以查看管辖仓库的计件记录" 
ON piece_work_records
FOR SELECT TO authenticated
USING (
  EXISTS (
    SELECT 1 FROM manager_warehouses mw
    WHERE mw.manager_id = auth.uid()
    AND mw.warehouse_id = piece_work_records.warehouse_id
  )
);
```

#### 3.2 权限检查函数

数据库中定义了权限检查函数：

```sql
-- 检查是否为超级管理员
CREATE OR REPLACE FUNCTION is_super_admin(uid uuid)
RETURNS boolean LANGUAGE sql SECURITY DEFINER AS $$
  SELECT EXISTS (
    SELECT 1 FROM profiles p
    WHERE p.id = uid AND p.role = 'super_admin'
  );
$$;

-- 检查是否为管理员
CREATE OR REPLACE FUNCTION is_manager(uid uuid)
RETURNS boolean LANGUAGE sql SECURITY DEFINER AS $$
  SELECT EXISTS (
    SELECT 1 FROM profiles p
    WHERE p.id = uid AND p.role = 'manager'
  );
$$;
```

---

## 权限验证流程

### 1. 页面访问验证

```
用户访问页面
    ↓
检查是否登录 (useAuth)
    ↓
未登录 → 跳转到登录页面
    ↓
已登录 → 加载用户信息
    ↓
根据角色加载对应数据
    ↓
渲染页面
```

### 2. 数据操作验证

```
用户执行操作（如：添加记录）
    ↓
前端检查权限（UI层）
    ↓
无权限 → 隐藏操作按钮
    ↓
有权限 → 调用API
    ↓
数据库检查权限（RLS策略）
    ↓
无权限 → 返回错误
    ↓
有权限 → 执行操作
    ↓
返回结果
```

### 3. 数据查询验证

```
用户查询数据
    ↓
前端根据角色调用对应API
    ↓
数据库应用RLS策略
    ↓
过滤用户无权访问的数据
    ↓
返回允许访问的数据
    ↓
前端渲染数据
```

---

## 安全策略

### 1. 认证安全

- 使用Supabase Auth进行用户认证
- Session持久化，支持自动登录
- Token自动刷新，保持登录状态

### 2. 授权安全

- 多层权限验证（UI层 + 数据库层）
- 最小权限原则
- 职责分离

### 3. 数据安全

- 行级安全策略（RLS）
- 数据访问审计
- 敏感操作确认（如删除）

### 4. 传输安全

- HTTPS加密传输
- API密钥保护
- 防止CSRF攻击

---

## 权限管理

### 1. 角色分配

超级管理员可以在"用户管理"页面分配用户角色：

1. 进入"用户管理"页面
2. 找到目标用户
3. 点击"编辑"按钮
4. 选择角色：司机、管理员、超级管理员
5. 保存修改

### 2. 仓库分配

超级管理员可以为管理员分配管辖仓库：

1. 进入"仓库管理"页面
2. 选择仓库
3. 分配管理员
4. 保存设置

### 3. 权限变更生效

- 角色变更：立即生效，用户下次操作时应用新权限
- 仓库分配变更：立即生效，刷新页面后生效

---

## 权限异常处理

### 1. 未登录

**现象：** 访问需要认证的页面时，自动跳转到登录页面

**处理：** 用户登录后，系统会跳转回原页面

### 2. 权限不足

**现象：** 
- UI层：操作按钮不显示或禁用
- 数据库层：操作失败，返回权限错误

**处理：** 
- 前端：显示友好的提示信息
- 后端：记录权限违规日志

### 3. Session过期

**现象：** Token过期，API请求失败

**处理：** 
- 自动刷新Token
- 如果刷新失败，跳转到登录页面

---

## 权限审计

### 1. 操作日志

系统记录以下操作：

- 用户登录/登出
- 数据添加/编辑/删除
- 权限变更
- 敏感操作

### 2. 审计内容

每条日志包含：

- 操作时间
- 操作用户
- 操作类型
- 操作对象
- 操作结果

### 3. 日志查询

超级管理员可以查询操作日志，进行安全审计。

---

## 最佳实践

### 1. 开发建议

- 始终在UI层和数据库层同时实现权限控制
- 使用TypeScript类型系统增强类型安全
- 敏感操作添加二次确认
- 定期审查权限策略

### 2. 运维建议

- 定期审查用户权限
- 及时回收离职人员权限
- 监控异常权限访问
- 定期备份数据

### 3. 安全建议

- 使用强密码策略
- 启用双因素认证（如有）
- 定期更新系统
- 及时修复安全漏洞

---

## 常见问题

### Q1: 为什么普通管理员不能添加/编辑记录？

**A:** 这是基于业务需求的权限设计。普通管理员的职责是查看和分析数据，不需要修改权限。这样可以：
- 避免误操作
- 确保数据一致性
- 简化操作流程

### Q2: 如何提升用户权限？

**A:** 只有超级管理员可以修改用户权限。在"用户管理"页面编辑用户角色即可。

### Q3: 权限变更后需要重新登录吗？

**A:** 不需要。权限变更立即生效，用户刷新页面或下次操作时自动应用新权限。

### Q4: 数据库层的权限控制是否可以绕过？

**A:** 不能。数据库层的RLS策略是强制执行的，任何访问都必须通过权限检查。

### Q5: 如何查看自己的权限？

**A:** 在"个人中心"页面可以查看自己的角色和权限信息。

---

## 技术参考

### 相关文件

- UI层权限控制：
  - `/src/pages/manager/piece-work-report/index.tsx`
  - `/src/pages/super-admin/piece-work-report/index.tsx`

- 数据访问控制：
  - `/src/db/api.ts`
  - `/src/db/types.ts`

- 数据库权限策略：
  - `/supabase/migrations/09_create_piece_work_records.sql`

### 相关文档

- [计件功能整合说明](./计件功能整合说明.md)
- [件数报表使用指南](./件数报表使用指南.md)

---

**最后更新日期：** 2025-11-05  
**文档版本：** v1.0  
**维护人员：** 开发团队
