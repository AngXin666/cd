# 通知中心未读信息筛选功能

## 需求描述

### 当前问题
通知中心缺少未读信息筛选功能：
- ❌ 无法快速查看所有未读信息
- ❌ 未读信息和已读信息混在一起，不方便查看
- ❌ 没有显示未读信息的总数量

### 期望功能
1. **添加"未读信息"按钮**
   - 显示未读信息的总数量
   - 点击后只显示未读信息，不显示已读信息

2. **调整按钮布局**
   - 按钮顺序：未读信息、全部已读、清空已读
   - 未读信息按钮显示数量

3. **筛选功能**
   - 点击"未读信息"按钮，只显示未读通知
   - 再次点击，显示所有通知

## 实现方案

### 1. 添加筛选状态

```typescript
const [showOnlyUnread, setShowOnlyUnread] = useState(false) // 是否只显示未读信息
```

**说明**：
- `showOnlyUnread`：控制是否只显示未读信息
- 默认值为 `false`，显示所有通知

### 2. 添加筛选逻辑

```typescript
// 根据筛选条件过滤通知
const filteredNotifications = useMemo(() => {
  if (showOnlyUnread) {
    return notifications.filter((n) => !n.is_read)
  }
  return notifications
}, [notifications, showOnlyUnread])
```

**说明**：
- 使用 `useMemo` 优化性能
- 当 `showOnlyUnread` 为 `true` 时，只返回未读通知
- 当 `showOnlyUnread` 为 `false` 时，返回所有通知

### 3. 重新计算分组

```typescript
// 根据筛选后的通知进行分组
const groupedFilteredNotifications = useMemo(() => {
  const groups: NotificationGroup[] = []
  const groupMap = new Map<string, Notification[]>()

  filteredNotifications.forEach((notification) => {
    const category = getDateCategory(notification.created_at)
    if (!groupMap.has(category)) {
      groupMap.set(category, [])
    }
    groupMap.get(category)!.push(notification)
  })

  // 按照今天、昨天、历史的顺序排列
  const order = ['今天', '昨天', '历史']
  order.forEach((title) => {
    const notifs = groupMap.get(title)
    if (notifs && notifs.length > 0) {
      groups.push({title, notifications: notifs})
    }
  })

  return groups
}, [filteredNotifications, getDateCategory])
```

**说明**：
- 基于筛选后的通知列表进行分组
- 保持原有的日期分组逻辑（今天、昨天、历史）
- 使用 `useMemo` 优化性能

### 4. 修改按钮布局

#### 修改前
```typescript
<View className="flex items-center gap-2">
  <Button
    className="bg-primary text-primary-foreground px-4 py-2 rounded text-sm break-keep"
    size="mini"
    onClick={handleMarkAllAsRead}>
    全部已读
  </Button>
  <Button
    className="bg-muted text-muted-foreground px-4 py-2 rounded text-sm break-keep"
    size="mini"
    onClick={handleDeleteRead}>
    清空已读
  </Button>
</View>
```

#### 修改后
```typescript
<View className="flex items-center gap-2">
  <Button
    className={`${showOnlyUnread ? 'bg-primary text-primary-foreground' : 'bg-muted text-muted-foreground'} px-4 py-2 rounded text-sm break-keep`}
    size="mini"
    onClick={() => setShowOnlyUnread(!showOnlyUnread)}>
    未读信息 ({unreadCount})
  </Button>
  <Button
    className="bg-primary text-primary-foreground px-4 py-2 rounded text-sm break-keep"
    size="mini"
    onClick={handleMarkAllAsRead}>
    全部已读
  </Button>
  <Button
    className="bg-muted text-muted-foreground px-4 py-2 rounded text-sm break-keep"
    size="mini"
    onClick={handleDeleteRead}>
    清空已读
  </Button>
</View>
```

**改进点**：
1. ✅ 添加"未读信息"按钮，显示未读数量
2. ✅ 按钮顺序调整为：未读信息、全部已读、清空已读
3. ✅ 未读信息按钮根据状态改变样式
   - 激活状态：主色调背景（`bg-primary`）
   - 未激活状态：灰色背景（`bg-muted`）

### 5. 修改通知列表显示

#### 修改前
```typescript
{loading ? (
  <View className="flex items-center justify-center py-20">
    <Text className="text-muted-foreground">加载中...</Text>
  </View>
) : notifications.length === 0 ? (
  <View className="flex flex-col items-center justify-center py-20">
    <View className="i-mdi-bell-off text-6xl text-muted-foreground mb-4"></View>
    <Text className="text-muted-foreground">暂无通知</Text>
  </View>
) : (
  <View className="pb-4">
    {groupedNotifications.map((group) => (
      // ...
    ))}
  </View>
)}
```

#### 修改后
```typescript
{loading ? (
  <View className="flex items-center justify-center py-20">
    <Text className="text-muted-foreground">加载中...</Text>
  </View>
) : filteredNotifications.length === 0 ? (
  <View className="flex flex-col items-center justify-center py-20">
    <View className="i-mdi-bell-off text-6xl text-muted-foreground mb-4"></View>
    <Text className="text-muted-foreground">
      {showOnlyUnread ? '暂无未读通知' : '暂无通知'}
    </Text>
  </View>
) : (
  <View className="pb-4">
    {groupedFilteredNotifications.map((group) => (
      // ...
    ))}
  </View>
)}
```

**改进点**：
1. ✅ 使用 `filteredNotifications` 判断是否有通知
2. ✅ 使用 `groupedFilteredNotifications` 显示分组通知
3. ✅ 根据筛选状态显示不同的空状态提示
   - 筛选未读时：显示"暂无未读通知"
   - 显示所有时：显示"暂无通知"

## 功能特性

### 1. 未读信息按钮

**显示内容**：
- 按钮文本：`未读信息 (数量)`
- 例如：`未读信息 (5)`

**按钮状态**：
- **未激活状态**（显示所有通知）
  - 背景色：灰色（`bg-muted`）
  - 文字色：灰色（`text-muted-foreground`）

- **激活状态**（只显示未读通知）
  - 背景色：主色调（`bg-primary`）
  - 文字色：白色（`text-primary-foreground`）

**点击行为**：
- 第一次点击：只显示未读通知
- 再次点击：显示所有通知
- 切换状态时，按钮样式随之改变

### 2. 筛选功能

**筛选逻辑**：
- 只显示 `is_read` 为 `false` 的通知
- 保持原有的排序规则（未读优先，时间倒序）
- 保持原有的日期分组（今天、昨天、历史）

**空状态提示**：
- 筛选未读时，如果没有未读通知，显示"暂无未读通知"
- 显示所有时，如果没有通知，显示"暂无通知"

### 3. 按钮布局

**按钮顺序**（从左到右）：
1. **未读信息** - 筛选未读通知
2. **全部已读** - 标记所有通知为已读
3. **清空已读** - 删除所有已读通知

**按钮样式**：
- 未读信息：根据状态动态改变（灰色/主色调）
- 全部已读：主色调背景
- 清空已读：灰色背景

## 用户体验流程

### 流程 1：查看未读信息

1. **进入通知中心**
   - 看到所有通知（未读 + 已读）
   - 顶部显示未读数量徽章

2. **点击"未读信息"按钮**
   - 按钮变为主色调背景（激活状态）
   - 通知列表只显示未读通知
   - 已读通知被隐藏

3. **查看未读通知**
   - 按日期分组显示（今天、昨天、历史）
   - 未读通知前有红色圆点标识

4. **再次点击"未读信息"按钮**
   - 按钮变为灰色背景（未激活状态）
   - 通知列表显示所有通知
   - 已读通知重新显示

### 流程 2：处理未读信息

1. **筛选未读信息**
   - 点击"未读信息"按钮
   - 只显示未读通知

2. **点击通知查看**
   - 通知被标记为已读
   - 该通知从未读列表中消失
   - 未读数量减 1

3. **继续查看其他未读通知**
   - 列表自动更新
   - 只显示剩余的未读通知

4. **全部处理完毕**
   - 未读列表为空
   - 显示"暂无未读通知"

### 流程 3：批量操作

1. **筛选未读信息**
   - 点击"未读信息"按钮
   - 只显示未读通知

2. **点击"全部已读"**
   - 所有未读通知被标记为已读
   - 未读列表清空
   - 显示"暂无未读通知"

3. **切换到所有通知**
   - 点击"未读信息"按钮
   - 显示所有通知（包括刚才标记为已读的）

4. **点击"清空已读"**
   - 所有已读通知被删除
   - 只剩下未读通知（如果有）

## 测试场景

### 场景 1：查看未读信息

1. 登录任意角色账号
2. 确保有未读通知
3. 进入通知中心
4. 点击"未读信息"按钮
5. **预期结果**：
   - ✅ 按钮变为主色调背景
   - ✅ 只显示未读通知
   - ✅ 已读通知被隐藏
   - ✅ 按日期分组显示

### 场景 2：切换显示模式

1. 登录任意角色账号
2. 进入通知中心
3. 点击"未读信息"按钮（激活）
4. 再次点击"未读信息"按钮（取消激活）
5. **预期结果**：
   - ✅ 第一次点击：只显示未读通知
   - ✅ 第二次点击：显示所有通知
   - ✅ 按钮样式随状态改变

### 场景 3：未读数量显示

1. 登录任意角色账号
2. 确保有 5 条未读通知
3. 进入通知中心
4. **预期结果**：
   - ✅ 顶部显示"5 条未读"徽章
   - ✅ "未读信息"按钮显示"未读信息 (5)"

### 场景 4：空状态提示

1. 登录任意角色账号
2. 确保所有通知都已读
3. 进入通知中心
4. 点击"未读信息"按钮
5. **预期结果**：
   - ✅ 显示"暂无未读通知"
   - ✅ 显示铃铛图标

### 场景 5：标记已读后更新

1. 登录任意角色账号
2. 进入通知中心
3. 点击"未读信息"按钮
4. 点击一条未读通知
5. **预期结果**：
   - ✅ 该通知被标记为已读
   - ✅ 该通知从未读列表中消失
   - ✅ 未读数量减 1
   - ✅ "未读信息"按钮数量更新

### 场景 6：全部已读后更新

1. 登录任意角色账号
2. 进入通知中心
3. 点击"未读信息"按钮
4. 点击"全部已读"按钮
5. **预期结果**：
   - ✅ 所有未读通知被标记为已读
   - ✅ 未读列表清空
   - ✅ 显示"暂无未读通知"
   - ✅ 未读数量变为 0

## 技术实现细节

### 1. 状态管理

```typescript
const [showOnlyUnread, setShowOnlyUnread] = useState(false)
```

**说明**：
- 使用 React 的 `useState` 管理筛选状态
- 默认值为 `false`，显示所有通知
- 点击按钮时切换状态

### 2. 性能优化

```typescript
// 使用 useMemo 缓存筛选结果
const filteredNotifications = useMemo(() => {
  if (showOnlyUnread) {
    return notifications.filter((n) => !n.is_read)
  }
  return notifications
}, [notifications, showOnlyUnread])

// 使用 useMemo 缓存分组结果
const groupedFilteredNotifications = useMemo(() => {
  // 分组逻辑
}, [filteredNotifications, getDateCategory])
```

**优点**：
- 避免不必要的重新计算
- 只在依赖项变化时重新计算
- 提升性能

### 3. 动态样式

```typescript
className={`${showOnlyUnread ? 'bg-primary text-primary-foreground' : 'bg-muted text-muted-foreground'} px-4 py-2 rounded text-sm break-keep`}
```

**说明**：
- 根据 `showOnlyUnread` 状态动态改变样式
- 激活状态：主色调背景
- 未激活状态：灰色背景

### 4. 空状态处理

```typescript
<Text className="text-muted-foreground">
  {showOnlyUnread ? '暂无未读通知' : '暂无通知'}
</Text>
```

**说明**：
- 根据筛选状态显示不同的提示文本
- 提升用户体验

## 代码质量

### TypeScript 类型检查
```bash
pnpm run lint
```

**结果**：✅ 通过，无新增错误

### 代码规范
- ✅ 使用 TypeScript 严格模式
- ✅ 添加详细的注释
- ✅ 遵循项目代码风格
- ✅ 使用 `useMemo` 优化性能

## 用户体验改进

### 优化前
1. ❌ 无法快速查看未读信息
2. ❌ 未读信息和已读信息混在一起
3. ❌ 没有显示未读信息数量
4. ❌ 需要手动滚动查找未读信息

### 优化后
1. ✅ 一键筛选未读信息
2. ✅ 未读信息单独显示
3. ✅ 按钮显示未读数量
4. ✅ 快速定位未读信息
5. ✅ 按钮状态清晰可见

## 界面对比

### 优化前
```
通知中心                    5 条未读
┌─────────────────────────────┐
│ [全部已读] [清空已读]        │
└─────────────────────────────┘

今天
● 新的请假申请 (未读)
○ 请假申请已批准 (已读)
● 新的离职申请 (未读)

昨天
○ 车辆审核通过 (已读)
● 司机信息更新 (未读)
```

### 优化后
```
通知中心                    5 条未读
┌─────────────────────────────┐
│ [未读信息(5)] [全部已读] [清空已读] │
└─────────────────────────────┘

点击"未读信息"后：
今天
● 新的请假申请
● 新的离职申请

昨天
● 司机信息更新
```

## 后续优化建议

### 1. 添加快捷操作

在未读信息列表中添加快捷操作：
- 批量标记已读
- 批量删除
- 批量归档

### 2. 添加通知分类

支持按通知类型筛选：
- 请假申请
- 离职申请
- 车辆审核
- 系统通知

### 3. 添加搜索功能

支持搜索通知内容：
- 按关键词搜索
- 按日期范围搜索
- 按通知类型搜索

### 4. 添加通知优先级

支持通知优先级标识：
- 紧急通知（红色）
- 重要通知（橙色）
- 普通通知（灰色）

## 总结

本次优化主要添加了未读信息筛选功能：

1. **添加"未读信息"按钮**
   - ✅ 显示未读数量
   - ✅ 一键筛选未读信息
   - ✅ 按钮状态清晰可见

2. **优化按钮布局**
   - ✅ 调整按钮顺序
   - ✅ 统一按钮样式
   - ✅ 提升视觉效果

3. **改进用户体验**
   - ✅ 快速定位未读信息
   - ✅ 减少查找时间
   - ✅ 提升操作效率

这些改进显著提升了通知中心的易用性，使得用户可以更方便地管理和查看通知。

## 相关文档

- [通知系统跳转逻辑优化](./通知系统跳转逻辑优化.md)
- [双管理员端请假审批跳转优化](./双管理员端请假审批跳转优化.md)

## 完成日期

2025-11-05
