# é€šçŸ¥ç³»ç»ŸæŠ€æœ¯æ–‡æ¡£

## ä¸€ã€åŠŸèƒ½æ¦‚è¿°

### 1.1 åŠŸèƒ½å®šä½

é€šçŸ¥ç³»ç»Ÿæ˜¯è½¦é˜Ÿç®¡å®¶çš„æ¶ˆæ¯ä¸­å¿ƒï¼Œè´Ÿè´£å„ç±»ä¸šåŠ¡äº‹ä»¶çš„é€šçŸ¥æ¨é€ã€çŠ¶æ€åŒæ­¥ã€æ¶ˆæ¯ç®¡ç†ï¼Œç¡®ä¿ç”¨æˆ·åŠæ—¶è·å–é‡è¦ä¿¡æ¯ï¼Œæå‡ç³»ç»Ÿçš„ç”¨æˆ·ä½“éªŒå’Œä¸šåŠ¡æ•ˆç‡ã€‚

### 1.2 æ ¸å¿ƒä»·å€¼

- **å®æ—¶æ¨é€**: ä¸šåŠ¡äº‹ä»¶å‘ç”Ÿæ—¶å³æ—¶é€šçŸ¥ç›¸å…³äººå‘˜
- **åˆ†ç±»ç®¡ç†**: å¤šç§é€šçŸ¥ç±»å‹ï¼Œæ–¹ä¾¿ç”¨æˆ·åˆ†ç±»æŸ¥çœ‹
- **æœªè¯»æé†’**: æœªè¯»æ¶ˆæ¯æ•°é‡æç¤ºï¼Œé¿å…é—æ¼
- **å†å²è®°å½•**: å®Œæ•´çš„é€šçŸ¥å†å²ï¼Œå¯è¿½æº¯æŸ¥çœ‹
- **æ™ºèƒ½æ¨é€**: åŸºäºè§’è‰²å’Œæƒé™çš„ç²¾å‡†æ¨é€

### 1.3 ä¸šåŠ¡åœºæ™¯

```
é€šçŸ¥ç±»å‹ï¼š
1. å®¡æ‰¹ç±»é€šçŸ¥
   - è¯·å‡ç”³è¯·å¾…å®¡æ‰¹
   - ç¦»èŒç”³è¯·å¾…å®¡æ‰¹
   - è½¦è¾†å®¡æ ¸å¾…å®¡æ‰¹
   
2. ç»“æœç±»é€šçŸ¥
   - å®¡æ‰¹é€šè¿‡/æ‹’ç»é€šçŸ¥
   - æ“ä½œæˆåŠŸ/å¤±è´¥é€šçŸ¥
   
3. æé†’ç±»é€šçŸ¥
   - å¹´æ£€åˆ°æœŸæé†’
   - å·¥èµ„å‘æ”¾é€šçŸ¥
   - ç³»ç»Ÿå…¬å‘Šé€šçŸ¥
   
4. å¼‚å¸¸ç±»é€šçŸ¥
   - è¿ç« æé†’
   - æ•°æ®å¼‚å¸¸é¢„è­¦
```

---

## äºŒã€ç³»ç»Ÿæ¶æ„

### 2.1 æ•´ä½“æ¶æ„å›¾

```mermaid
graph TB
    subgraph "ä¸šåŠ¡æ¨¡å—"
        A1[è¯·å‡æ¨¡å—]
        A2[è½¦è¾†æ¨¡å—]
        A3[è®¡ä»¶æ¨¡å—]
        A4[ç³»ç»Ÿæ¨¡å—]
    end
    
    subgraph "é€šçŸ¥æœåŠ¡å±‚"
        B1[é€šçŸ¥åˆ›å»ºæœåŠ¡]
        B2[é€šçŸ¥æ¨é€æœåŠ¡]
        B3[é€šçŸ¥æŸ¥è¯¢æœåŠ¡]
        B4[æ¶ˆæ¯æ¨¡æ¿æœåŠ¡]
    end
    
    subgraph "æ¨é€æ¸ é“"
        C1[ç³»ç»Ÿå†…æ¨é€]
        C2[å°ç¨‹åºè®¢é˜…æ¶ˆæ¯]
        C3[çŸ­ä¿¡é€šçŸ¥]
        C4[é‚®ä»¶é€šçŸ¥]
    end
    
    subgraph "APIå±‚"
        D1[notifications.ts]
        D2[templates.ts]
        D3[subscriptions.ts]
    end
    
    subgraph "æ•°æ®åº“å±‚"
        E1[(notifications)]
        E2[(notification_templates)]
        E3[(notification_subscriptions)]
        E4[(users)]
    end
    
    A1 --> B1
    A2 --> B1
    A3 --> B1
    A4 --> B1
    
    B1 --> B2
    B2 --> C1
    B2 --> C2
    B2 --> C3
    B2 --> C4
    
    B1 --> D1
    B2 --> D1
    B3 --> D1
    B4 --> D2
    
    D1 --> E1
    D2 --> E2
    D3 --> E3
    
    E1 -.å…³è”.-> E4
```

### 2.2 é€šçŸ¥æ¨é€æµç¨‹

```mermaid
sequenceDiagram
    participant Business as ä¸šåŠ¡æ¨¡å—
    participant NotifyService as é€šçŸ¥æœåŠ¡
    participant Template as æ¨¡æ¿å¼•æ“
    participant DB as æ•°æ®åº“
    participant Channel as æ¨é€æ¸ é“
    participant User as ç”¨æˆ·
    
    Business->>NotifyService: 1. è§¦å‘ä¸šåŠ¡äº‹ä»¶
    NotifyService->>Template: 2. è·å–é€šçŸ¥æ¨¡æ¿
    Template-->>NotifyService: 3. è¿”å›æ¨¡æ¿
    
    NotifyService->>NotifyService: 4. æ¸²æŸ“æ¶ˆæ¯å†…å®¹
    NotifyService->>DB: 5. ä¿å­˜é€šçŸ¥è®°å½•
    DB-->>NotifyService: 6. è¿”å›é€šçŸ¥ID
    
    NotifyService->>Channel: 7. æ¨é€é€šçŸ¥
    
    par å¤šæ¸ é“å¹¶è¡Œæ¨é€
        Channel->>User: 8a. ç³»ç»Ÿå†…æ¨é€
        Channel->>User: 8b. å°ç¨‹åºè®¢é˜…æ¶ˆæ¯
        Channel->>User: 8c. çŸ­ä¿¡é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
    end
    
    User->>NotifyService: 9. æŸ¥çœ‹é€šçŸ¥
    NotifyService->>DB: 10. æ ‡è®°ä¸ºå·²è¯»
```

### 2.3 æ¶ˆæ¯è®¢é˜…æµç¨‹

```mermaid
stateDiagram-v2
    [*] --> ç”¨æˆ·è®¾ç½®
    ç”¨æˆ·è®¾ç½® --> é€‰æ‹©é€šçŸ¥ç±»å‹
    é€‰æ‹©é€šçŸ¥ç±»å‹ --> é€‰æ‹©æ¨é€æ¸ é“
    é€‰æ‹©æ¨é€æ¸ é“ --> ä¿å­˜è®¢é˜…é…ç½®
    
    ä¿å­˜è®¢é˜…é…ç½® --> è®¢é˜…ç”Ÿæ•ˆ
    è®¢é˜…ç”Ÿæ•ˆ --> æ¥æ”¶é€šçŸ¥
    
    æ¥æ”¶é€šçŸ¥ --> æŸ¥çœ‹é€šçŸ¥
    æŸ¥çœ‹é€šçŸ¥ --> æ ‡è®°å·²è¯»
    
    æ ‡è®°å·²è¯» --> [*]
    
    æ¥æ”¶é€šçŸ¥ --> å¿½ç•¥é€šçŸ¥
    å¿½ç•¥é€šçŸ¥ --> [*]
```

---

## ä¸‰ã€æ•°æ®æ¨¡å‹è®¾è®¡

### 3.1 æ•°æ®åº“è¡¨ç»“æ„

#### 3.1.1 é€šçŸ¥è¡¨ (notifications)

```sql
CREATE TABLE notifications (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  recipient_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  sender_id UUID REFERENCES users(id) ON DELETE SET NULL,
  
  -- é€šçŸ¥å†…å®¹
  title TEXT NOT NULL,
  content TEXT NOT NULL,
  type TEXT NOT NULL,  -- é€šçŸ¥ç±»å‹
  
  -- å…³è”ä¿¡æ¯
  related_id UUID,  -- å…³è”çš„ä¸šåŠ¡è®°å½•ID
  related_type TEXT,  -- å…³è”çš„ä¸šåŠ¡ç±»å‹
  
  -- çŠ¶æ€ä¿¡æ¯
  is_read BOOLEAN DEFAULT false,
  read_at TIMESTAMPTZ,
  
  -- æ¨é€ä¿¡æ¯
  push_channels TEXT[],  -- æ¨é€æ¸ é“æ•°ç»„
  push_status JSONB,  -- å„æ¸ é“æ¨é€çŠ¶æ€
  
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  
  -- ç´¢å¼•
  INDEX idx_notifications_recipient (recipient_id),
  INDEX idx_notifications_is_read (is_read),
  INDEX idx_notifications_type (type),
  INDEX idx_notifications_created (created_at DESC)
);

COMMENT ON TABLE notifications IS 'é€šçŸ¥æ¶ˆæ¯è¡¨';
COMMENT ON COLUMN notifications.type IS 'é€šçŸ¥ç±»å‹ï¼šleave_approval, vehicle_review, system_noticeç­‰';
COMMENT ON COLUMN notifications.related_id IS 'å…³è”çš„ä¸šåŠ¡è®°å½•IDï¼ˆå¦‚è¯·å‡ç”³è¯·IDã€è½¦è¾†IDï¼‰';
COMMENT ON COLUMN notifications.push_channels IS 'æ¨é€æ¸ é“ï¼šsystem, miniprogram, sms, email';
```

#### 3.1.2 é€šçŸ¥æ¨¡æ¿è¡¨ (notification_templates)

```sql
CREATE TABLE notification_templates (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  template_code TEXT NOT NULL UNIQUE,
  template_name TEXT NOT NULL,
  template_type TEXT NOT NULL,
  
  -- æ¨¡æ¿å†…å®¹
  title_template TEXT NOT NULL,  -- æ ‡é¢˜æ¨¡æ¿
  content_template TEXT NOT NULL,  -- å†…å®¹æ¨¡æ¿
  
  -- æ¨é€é…ç½®
  default_channels TEXT[],  -- é»˜è®¤æ¨é€æ¸ é“
  priority INTEGER DEFAULT 1,  -- ä¼˜å…ˆçº§ 1-5
  
  -- å˜é‡å®šä¹‰
  variables JSONB,  -- æ¨¡æ¿å˜é‡å®šä¹‰
  
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

COMMENT ON TABLE notification_templates IS 'é€šçŸ¥æ¨¡æ¿è¡¨';
COMMENT ON COLUMN notification_templates.template_code IS 'æ¨¡æ¿ä»£ç ï¼Œå¦‚ï¼šLEAVE_APPROVAL_PENDING';
COMMENT ON COLUMN notification_templates.variables IS 'æ¨¡æ¿å˜é‡å®šä¹‰ï¼Œå¦‚ï¼š["userName", "leaveDays"]';
```

#### 3.1.3 é€šçŸ¥è®¢é˜…è¡¨ (notification_subscriptions)

```sql
CREATE TABLE notification_subscriptions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  notification_type TEXT NOT NULL,
  
  -- è®¢é˜…è®¾ç½®
  is_subscribed BOOLEAN DEFAULT true,
  channels TEXT[],  -- è®¢é˜…çš„æ¸ é“
  
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  
  -- å”¯ä¸€çº¦æŸ
  CONSTRAINT uq_user_notification_type UNIQUE (user_id, notification_type)
);

COMMENT ON TABLE notification_subscriptions IS 'ç”¨æˆ·é€šçŸ¥è®¢é˜…é…ç½®è¡¨';
```

### 3.2 TypeScript ç±»å‹å®šä¹‰

```typescript
/**
 * é€šçŸ¥ç±»å‹æšä¸¾
 */
export enum NotificationType {
  // å®¡æ‰¹ç±»
  LEAVE_APPROVAL_PENDING = 'leave_approval_pending',
  LEAVE_APPROVAL_RESULT = 'leave_approval_result',
  VEHICLE_REVIEW_PENDING = 'vehicle_review_pending',
  VEHICLE_REVIEW_RESULT = 'vehicle_review_result',
  
  // æé†’ç±»
  INSPECTION_REMINDER = 'inspection_reminder',
  SALARY_NOTICE = 'salary_notice',
  SYSTEM_NOTICE = 'system_notice',
  
  // å¼‚å¸¸ç±»
  VIOLATION_ALERT = 'violation_alert',
  DATA_ANOMALY = 'data_anomaly'
}

/**
 * æ¨é€æ¸ é“æšä¸¾
 */
export enum PushChannel {
  SYSTEM = 'system',          // ç³»ç»Ÿå†…æ¨é€
  MINIPROGRAM = 'miniprogram',  // å°ç¨‹åºè®¢é˜…æ¶ˆæ¯
  SMS = 'sms',                // çŸ­ä¿¡
  EMAIL = 'email'             // é‚®ä»¶
}

/**
 * é€šçŸ¥æ¥å£
 */
export interface Notification {
  id: string
  recipient_id: string        // æ¥æ”¶äººID
  sender_id: string | null    // å‘é€äººID
  
  title: string               // é€šçŸ¥æ ‡é¢˜
  content: string             // é€šçŸ¥å†…å®¹
  type: NotificationType      // é€šçŸ¥ç±»å‹
  
  related_id: string | null   // å…³è”ä¸šåŠ¡ID
  related_type: string | null // å…³è”ä¸šåŠ¡ç±»å‹
  
  is_read: boolean            // æ˜¯å¦å·²è¯»
  read_at: string | null      // é˜…è¯»æ—¶é—´
  
  push_channels: PushChannel[]  // æ¨é€æ¸ é“
  push_status: Record<PushChannel, PushStatus>  // æ¨é€çŠ¶æ€
  
  created_at: string
  updated_at: string
}

/**
 * æ¨é€çŠ¶æ€
 */
export interface PushStatus {
  status: 'pending' | 'success' | 'failed'
  message?: string
  pushed_at?: string
}

/**
 * é€šçŸ¥æ¨¡æ¿æ¥å£
 */
export interface NotificationTemplate {
  id: string
  template_code: string
  template_name: string
  template_type: string
  
  title_template: string      // æ”¯æŒå˜é‡ï¼Œå¦‚ï¼š{{userName}}çš„è¯·å‡ç”³è¯·
  content_template: string
  
  default_channels: PushChannel[]
  priority: number            // 1-5ï¼Œæ•°å­—è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜
  
  variables: string[]         // å˜é‡åˆ—è¡¨
  
  is_active: boolean
  created_at: string
  updated_at: string
}

/**
 * åˆ›å»ºé€šçŸ¥è¾“å…¥
 */
export interface CreateNotificationInput {
  recipient_id: string
  sender_id?: string
  title: string
  content: string
  type: NotificationType
  related_id?: string
  related_type?: string
  channels?: PushChannel[]
}

/**
 * é€šçŸ¥ç»Ÿè®¡
 */
export interface NotificationStats {
  total: number
  unread: number
  byType: Record<string, number>
}
```

---

## å››ã€æ ¸å¿ƒåŠŸèƒ½å®ç°

### 4.1 é€šçŸ¥åˆ›å»ºä¸æ¨é€

#### 4.1.1 æ ¸å¿ƒå®ç°

**APIå±‚å®ç°** (`src/db/api/notifications.ts`):

```typescript
import { supabase } from '../supabase'
import type { 
  Notification, 
  CreateNotificationInput,
  NotificationTemplate,
  PushChannel
} from '../types'

/**
 * åˆ›å»ºé€šçŸ¥
 * 
 * @param input é€šçŸ¥è¾“å…¥æ•°æ®
 * @returns åˆ›å»ºçš„é€šçŸ¥è®°å½•
 */
export async function createNotification(
  input: CreateNotificationInput
): Promise<Notification> {
  // 1. æ£€æŸ¥ç”¨æˆ·è®¢é˜…è®¾ç½®
  const channels = await getUserSubscribedChannels(
    input.recipient_id,
    input.type
  )
  
  if (channels.length === 0) {
    console.log('[createNotification] ç”¨æˆ·æœªè®¢é˜…è¯¥ç±»å‹é€šçŸ¥')
    // ä»ç„¶åˆ›å»ºé€šçŸ¥è®°å½•ï¼Œä½†ä¸æ¨é€
  }
  
  // 2. åˆ›å»ºé€šçŸ¥è®°å½•
  const { data: notification, error } = await supabase
    .from('notifications')
    .insert({
      recipient_id: input.recipient_id,
      sender_id: input.sender_id || null,
      title: input.title,
      content: input.content,
      type: input.type,
      related_id: input.related_id || null,
      related_type: input.related_type || null,
      push_channels: channels,
      push_status: {},
      is_read: false
    })
    .select()
    .single()
  
  if (error) {
    console.error('[createNotification] åˆ›å»ºå¤±è´¥:', error)
    throw new Error(`åˆ›å»ºé€šçŸ¥å¤±è´¥: ${error.message}`)
  }
  
  // 3. å¼‚æ­¥æ¨é€é€šçŸ¥
  pushNotification(notification, channels).catch(err => {
    console.error('[createNotification] æ¨é€å¤±è´¥:', err)
  })
  
  return notification
}

/**
 * ä½¿ç”¨æ¨¡æ¿åˆ›å»ºé€šçŸ¥
 * 
 * @param templateCode æ¨¡æ¿ä»£ç 
 * @param recipientId æ¥æ”¶äººID
 * @param variables æ¨¡æ¿å˜é‡
 * @param options é¢å¤–é€‰é¡¹
 * @returns åˆ›å»ºçš„é€šçŸ¥
 */
export async function createNotificationFromTemplate(
  templateCode: string,
  recipientId: string,
  variables: Record<string, any>,
  options?: {
    senderId?: string
    relatedId?: string
    relatedType?: string
  }
): Promise<Notification> {
  // 1. è·å–æ¨¡æ¿
  const template = await getNotificationTemplate(templateCode)
  if (!template) {
    throw new Error(`é€šçŸ¥æ¨¡æ¿ä¸å­˜åœ¨: ${templateCode}`)
  }
  
  // 2. æ¸²æŸ“æ¨¡æ¿
  const title = renderTemplate(template.title_template, variables)
  const content = renderTemplate(template.content_template, variables)
  
  // 3. åˆ›å»ºé€šçŸ¥
  return createNotification({
    recipient_id: recipientId,
    sender_id: options?.senderId,
    title,
    content,
    type: template.template_type as NotificationType,
    related_id: options?.relatedId,
    related_type: options?.relatedType,
    channels: template.default_channels as PushChannel[]
  })
}

/**
 * æ¸²æŸ“æ¨¡æ¿
 * æ”¯æŒ {{variableName}} æ ¼å¼çš„å˜é‡æ›¿æ¢
 */
function renderTemplate(
  template: string,
  variables: Record<string, any>
): string {
  return template.replace(/\{\{(\w+)\}\}/g, (match, key) => {
    return variables[key] !== undefined ? String(variables[key]) : match
  })
}

/**
 * è·å–é€šçŸ¥æ¨¡æ¿
 */
async function getNotificationTemplate(
  templateCode: string
): Promise<NotificationTemplate | null> {
  const { data, error } = await supabase
    .from('notification_templates')
    .select('*')
    .eq('template_code', templateCode)
    .eq('is_active', true)
    .maybeSingle()
  
  if (error) {
    console.error('[getNotificationTemplate] æŸ¥è¯¢å¤±è´¥:', error)
    return null
  }
  
  return data
}

/**
 * è·å–ç”¨æˆ·è®¢é˜…çš„æ¸ é“
 */
async function getUserSubscribedChannels(
  userId: string,
  notificationType: NotificationType
): Promise<PushChannel[]> {
  const { data } = await supabase
    .from('notification_subscriptions')
    .select('channels')
    .eq('user_id', userId)
    .eq('notification_type', notificationType)
    .eq('is_subscribed', true)
    .maybeSingle()
  
  // é»˜è®¤åªæ¨é€ç³»ç»Ÿå†…é€šçŸ¥
  return data?.channels || [PushChannel.SYSTEM]
}
```

#### 4.1.2 æ¨é€å®ç°

```typescript
/**
 * æ¨é€é€šçŸ¥åˆ°å„æ¸ é“
 */
async function pushNotification(
  notification: Notification,
  channels: PushChannel[]
): Promise<void> {
  const pushResults: Record<string, PushStatus> = {}
  
  // å¹¶è¡Œæ¨é€åˆ°å„æ¸ é“
  await Promise.all(
    channels.map(async (channel) => {
      try {
        switch (channel) {
          case PushChannel.SYSTEM:
            // ç³»ç»Ÿå†…æ¨é€å·²é€šè¿‡æ•°æ®åº“å®Œæˆ
            pushResults[channel] = {
              status: 'success',
              pushed_at: new Date().toISOString()
            }
            break
            
          case PushChannel.MINIPROGRAM:
            await pushToMiniProgram(notification)
            pushResults[channel] = {
              status: 'success',
              pushed_at: new Date().toISOString()
            }
            break
            
          case PushChannel.SMS:
            await pushToSMS(notification)
            pushResults[channel] = {
              status: 'success',
              pushed_at: new Date().toISOString()
            }
            break
            
          case PushChannel.EMAIL:
            await pushToEmail(notification)
            pushResults[channel] = {
              status: 'success',
              pushed_at: new Date().toISOString()
            }
            break
        }
      } catch (error) {
        console.error(`[pushNotification] ${channel}æ¨é€å¤±è´¥:`, error)
        pushResults[channel] = {
          status: 'failed',
          message: error instanceof Error ? error.message : 'æ¨é€å¤±è´¥'
        }
      }
    })
  )
  
  // æ›´æ–°æ¨é€çŠ¶æ€
  await supabase
    .from('notifications')
    .update({ push_status: pushResults })
    .eq('id', notification.id)
}

/**
 * å°ç¨‹åºè®¢é˜…æ¶ˆæ¯æ¨é€
 */
async function pushToMiniProgram(
  notification: Notification
): Promise<void> {
  // è°ƒç”¨å°ç¨‹åºè®¢é˜…æ¶ˆæ¯API
  // éœ€è¦ç”¨æˆ·å…ˆè®¢é˜…æ¶ˆæ¯æ¨¡æ¿
  
  // ç¤ºä¾‹å®ç°
  const response = await fetch('https://api.weixin.qq.com/cgi-bin/message/subscribe/send', {
    method: 'POST',
    body: JSON.stringify({
      touser: notification.recipient_id,
      template_id: 'TEMPLATE_ID',
      page: '/pages/notifications/detail',
      data: {
        thing1: { value: notification.title },
        thing2: { value: notification.content }
      }
    })
  })
  
  if (!response.ok) {
    throw new Error('å°ç¨‹åºæ¨é€å¤±è´¥')
  }
}

/**
 * çŸ­ä¿¡æ¨é€
 */
async function pushToSMS(notification: Notification): Promise<void> {
  // è°ƒç”¨çŸ­ä¿¡æœåŠ¡API
  // éœ€è¦è·å–ç”¨æˆ·æ‰‹æœºå·
  
  const { data: user } = await supabase
    .from('users')
    .select('phone')
    .eq('id', notification.recipient_id)
    .single()
  
  if (!user?.phone) {
    throw new Error('ç”¨æˆ·æ‰‹æœºå·ä¸å­˜åœ¨')
  }
  
  // è°ƒç”¨çŸ­ä¿¡APIï¼ˆç¤ºä¾‹ï¼‰
  // await smsService.send(user.phone, notification.content)
}

/**
 * é‚®ä»¶æ¨é€
 */
async function pushToEmail(notification: Notification): Promise<void> {
  // è°ƒç”¨é‚®ä»¶æœåŠ¡API
  // éœ€è¦è·å–ç”¨æˆ·é‚®ç®±
  
  const { data: user } = await supabase
    .from('users')
    .select('email')
    .eq('id', notification.recipient_id)
    .single()
  
  if (!user?.email) {
    throw new Error('ç”¨æˆ·é‚®ç®±ä¸å­˜åœ¨')
  }
  
  // è°ƒç”¨é‚®ä»¶APIï¼ˆç¤ºä¾‹ï¼‰
  // await emailService.send(user.email, notification.title, notification.content)
}
```

### 4.2 é€šçŸ¥æŸ¥è¯¢ä¸ç®¡ç†

#### 4.2.1 æŸ¥è¯¢å®ç°

```typescript
/**
 * è·å–ç”¨æˆ·çš„é€šçŸ¥åˆ—è¡¨
 * 
 * @param userId ç”¨æˆ·ID
 * @param options æŸ¥è¯¢é€‰é¡¹
 * @returns é€šçŸ¥åˆ—è¡¨
 */
export async function getUserNotifications(
  userId: string,
  options?: {
    type?: NotificationType
    isRead?: boolean
    page?: number
    pageSize?: number
  }
): Promise<{ data: Notification[], total: number }> {
  const page = options?.page || 1
  const pageSize = options?.pageSize || 20
  const from = (page - 1) * pageSize
  const to = from + pageSize - 1
  
  let query = supabase
    .from('notifications')
    .select('*', { count: 'exact' })
    .eq('recipient_id', userId)
  
  // ç±»å‹è¿‡æ»¤
  if (options?.type) {
    query = query.eq('type', options.type)
  }
  
  // å·²è¯»/æœªè¯»è¿‡æ»¤
  if (options?.isRead !== undefined) {
    query = query.eq('is_read', options.isRead)
  }
  
  // åˆ†é¡µå’Œæ’åº
  const { data, error, count } = await query
    .range(from, to)
    .order('created_at', { ascending: false })
  
  if (error) {
    console.error('[getUserNotifications] æŸ¥è¯¢å¤±è´¥:', error)
    throw error
  }
  
  return {
    data: data || [],
    total: count || 0
  }
}

/**
 * æ ‡è®°é€šçŸ¥ä¸ºå·²è¯»
 * 
 * @param notificationId é€šçŸ¥ID
 * @returns æ˜¯å¦æˆåŠŸ
 */
export async function markNotificationAsRead(
  notificationId: string
): Promise<boolean> {
  const { error } = await supabase
    .from('notifications')
    .update({
      is_read: true,
      read_at: new Date().toISOString()
    })
    .eq('id', notificationId)
  
  if (error) {
    console.error('[markNotificationAsRead] æ›´æ–°å¤±è´¥:', error)
    return false
  }
  
  return true
}

/**
 * æ‰¹é‡æ ‡è®°å·²è¯»
 * 
 * @param notificationIds é€šçŸ¥IDæ•°ç»„
 * @returns æ˜¯å¦æˆåŠŸ
 */
export async function markNotificationsAsRead(
  notificationIds: string[]
): Promise<boolean> {
  const { error } = await supabase
    .from('notifications')
    .update({
      is_read: true,
      read_at: new Date().toISOString()
    })
    .in('id', notificationIds)
  
  if (error) {
    console.error('[markNotificationsAsRead] æ‰¹é‡æ›´æ–°å¤±è´¥:', error)
    return false
  }
  
  return true
}

/**
 * æ ‡è®°æ‰€æœ‰é€šçŸ¥ä¸ºå·²è¯»
 * 
 * @param userId ç”¨æˆ·ID
 * @returns æ˜¯å¦æˆåŠŸ
 */
export async function markAllNotificationsAsRead(
  userId: string
): Promise<boolean> {
  const { error } = await supabase
    .from('notifications')
    .update({
      is_read: true,
      read_at: new Date().toISOString()
    })
    .eq('recipient_id', userId)
    .eq('is_read', false)
  
  if (error) {
    console.error('[markAllNotificationsAsRead] æ›´æ–°å¤±è´¥:', error)
    return false
  }
  
  return true
}

/**
 * è·å–æœªè¯»é€šçŸ¥æ•°é‡
 * 
 * @param userId ç”¨æˆ·ID
 * @returns æœªè¯»æ•°é‡
 */
export async function getUnreadCount(userId: string): Promise<number> {
  const { count, error } = await supabase
    .from('notifications')
    .select('*', { count: 'exact', head: true })
    .eq('recipient_id', userId)
    .eq('is_read', false)
  
  if (error) {
    console.error('[getUnreadCount] æŸ¥è¯¢å¤±è´¥:', error)
    return 0
  }
  
  return count || 0
}

/**
 * è·å–é€šçŸ¥ç»Ÿè®¡
 * 
 * @param userId ç”¨æˆ·ID
 * @returns ç»Ÿè®¡æ•°æ®
 */
export async function getNotificationStats(
  userId: string
): Promise<NotificationStats> {
  const { data, error } = await supabase
    .from('notifications')
    .select('type, is_read')
    .eq('recipient_id', userId)
  
  if (error) {
    console.error('[getNotificationStats] æŸ¥è¯¢å¤±è´¥:', error)
    return { total: 0, unread: 0, byType: {} }
  }
  
  const total = data.length
  const unread = data.filter(n => !n.is_read).length
  const byType: Record<string, number> = {}
  
  data.forEach(n => {
    byType[n.type] = (byType[n.type] || 0) + 1
  })
  
  return { total, unread, byType }
}
```

### 4.3 è®¢é˜…ç®¡ç†

```typescript
/**
 * æ›´æ–°ç”¨æˆ·è®¢é˜…è®¾ç½®
 * 
 * @param userId ç”¨æˆ·ID
 * @param notificationType é€šçŸ¥ç±»å‹
 * @param settings è®¢é˜…è®¾ç½®
 * @returns æ˜¯å¦æˆåŠŸ
 */
export async function updateNotificationSubscription(
  userId: string,
  notificationType: NotificationType,
  settings: {
    isSubscribed: boolean
    channels: PushChannel[]
  }
): Promise<boolean> {
  const { error } = await supabase
    .from('notification_subscriptions')
    .upsert({
      user_id: userId,
      notification_type: notificationType,
      is_subscribed: settings.isSubscribed,
      channels: settings.channels
    }, {
      onConflict: 'user_id,notification_type'
    })
  
  if (error) {
    console.error('[updateNotificationSubscription] æ›´æ–°å¤±è´¥:', error)
    return false
  }
  
  return true
}

/**
 * è·å–ç”¨æˆ·çš„è®¢é˜…è®¾ç½®
 * 
 * @param userId ç”¨æˆ·ID
 * @returns è®¢é˜…è®¾ç½®åˆ—è¡¨
 */
export async function getUserSubscriptions(
  userId: string
): Promise<Array<{
  notification_type: NotificationType
  is_subscribed: boolean
  channels: PushChannel[]
}>> {
  const { data, error } = await supabase
    .from('notification_subscriptions')
    .select('notification_type, is_subscribed, channels')
    .eq('user_id', userId)
  
  if (error) {
    console.error('[getUserSubscriptions] æŸ¥è¯¢å¤±è´¥:', error)
    return []
  }
  
  return data || []
}
```

---

## äº”ã€ä¸šåŠ¡é›†æˆç¤ºä¾‹

### 5.1 è¯·å‡å®¡æ‰¹é€šçŸ¥

```typescript
// è¯·å‡ç”³è¯·æäº¤æ—¶
async function onLeaveApplicationCreated(
  application: LeaveApplication
): Promise<void> {
  // è·å–å®¡æ‰¹äººåˆ—è¡¨
  const reviewers = await getLeaveReviewers(application)
  
  // ç»™æ¯ä¸ªå®¡æ‰¹äººå‘é€é€šçŸ¥
  for (const reviewer of reviewers) {
    await createNotificationFromTemplate(
      'LEAVE_APPROVAL_PENDING',
      reviewer.id,
      {
        userName: application.driver_name,
        leaveType: getLeaveTypeName(application.leave_type),
        leaveDays: application.days,
        startDate: application.start_date,
        endDate: application.end_date
      },
      {
        senderId: application.driver_id,
        relatedId: application.id,
        relatedType: 'leave_application'
      }
    )
  }
}

// è¯·å‡å®¡æ‰¹å®Œæˆæ—¶
async function onLeaveApplicationReviewed(
  application: LeaveApplication,
  approved: boolean
): Promise<void> {
  const result = approved ? 'å·²é€šè¿‡' : 'å·²æ‹’ç»'
  
  await createNotificationFromTemplate(
    'LEAVE_APPROVAL_RESULT',
    application.driver_id,
    {
      result,
      reviewerName: application.reviewer_name,
      leaveType: getLeaveTypeName(application.leave_type),
      leaveDays: application.days,
      reviewNotes: application.review_notes || 'æ— '
    },
    {
      senderId: application.reviewer_id!,
      relatedId: application.id,
      relatedType: 'leave_application'
    }
  )
}
```

### 5.2 è½¦è¾†å®¡æ ¸é€šçŸ¥

```typescript
// è½¦è¾†æäº¤å®¡æ ¸æ—¶
async function onVehicleSubmitted(vehicle: Vehicle): Promise<void> {
  const reviewers = await getVehicleReviewers(vehicle)
  
  for (const reviewer of reviewers) {
    await createNotificationFromTemplate(
      'VEHICLE_REVIEW_PENDING',
      reviewer.id,
      {
        plateNumber: vehicle.plate_number,
        ownerName: vehicle.owner_name,
        vehicleType: vehicle.vehicle_type || 'æœªçŸ¥'
      },
      {
        senderId: vehicle.user_id,
        relatedId: vehicle.id,
        relatedType: 'vehicle'
      }
    )
  }
}

// è½¦è¾†å®¡æ ¸å®Œæˆæ—¶
async function onVehicleReviewed(
  vehicle: Vehicle,
  approved: boolean
): Promise<void> {
  const result = approved ? 'å·²é€šè¿‡' : 'å·²æ‹’ç»'
  
  await createNotificationFromTemplate(
    'VEHICLE_REVIEW_RESULT',
    vehicle.user_id,
    {
      plateNumber: vehicle.plate_number,
      result,
      reviewNotes: vehicle.review_notes || 'æ— '
    },
    {
      senderId: vehicle.reviewer_id!,
      relatedId: vehicle.id,
      relatedType: 'vehicle'
    }
  )
}
```

---

## å…­ã€ç•Œé¢è®¾è®¡

### 6.1 é€šçŸ¥åˆ—è¡¨é¡µé¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é€šçŸ¥æ¶ˆæ¯                (5)    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç­›é€‰: â— å…¨éƒ¨  â—‹ æœªè¯»  â—‹ å·²è¯»  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ğŸ”´ æ–°çš„è¯·å‡ç”³è¯·           â”‚  â”‚
â”‚  â”‚ å¼ ä¸‰ç”³è¯·è¯·å‡3å¤©ï¼Œè¯·åŠæ—¶... â”‚  â”‚
â”‚  â”‚ 10:30                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ğŸ”´ è½¦è¾†å®¡æ ¸å¾…å¤„ç†         â”‚  â”‚
â”‚  â”‚ äº¬A12345ç­‰å¾…æ‚¨çš„å®¡æ ¸      â”‚  â”‚
â”‚  â”‚ 09:15                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ âšª æ‚¨çš„è¯·å‡ç”³è¯·å·²é€šè¿‡     â”‚  â”‚
â”‚  â”‚ æ‚¨çš„äº‹å‡ç”³è¯·å·²é€šè¿‡å®¡æ‰¹    â”‚  â”‚
â”‚  â”‚ æ˜¨å¤© 16:45                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ âšª å·¥èµ„å‘æ”¾é€šçŸ¥           â”‚  â”‚
â”‚  â”‚ æ‚¨çš„12æœˆå·¥èµ„å·²å‘æ”¾        â”‚  â”‚
â”‚  â”‚ 12-10 14:20               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚       åŠ è½½æ›´å¤š            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 é€šçŸ¥è¯¦æƒ…é¡µé¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â† é€šçŸ¥è¯¦æƒ…                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                 â”‚
â”‚  æ–°çš„è¯·å‡ç”³è¯·                    â”‚
â”‚  2025-12-11 10:30               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                 â”‚
â”‚  å¼ ä¸‰ç”³è¯·è¯·å‡3å¤©ï¼Œè¯·åŠæ—¶å®¡æ‰¹ã€‚  â”‚
â”‚                                 â”‚
â”‚  è¯·å‡ç±»å‹ï¼šäº‹å‡                 â”‚
â”‚  è¯·å‡æ—¶é—´ï¼š2025-12-15 è‡³ 12-17  â”‚
â”‚  è¯·å‡å¤©æ•°ï¼š3å¤©                  â”‚
â”‚  è¯·å‡åŸå› ï¼šå®¶ä¸­æœ‰äº‹éœ€è¦å¤„ç†     â”‚
â”‚                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚       æŸ¥çœ‹è¯¦æƒ…            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚       å»å®¡æ‰¹              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.3 è®¢é˜…è®¾ç½®é¡µé¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â† é€šçŸ¥è®¾ç½®                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                 â”‚
â”‚  å®¡æ‰¹ç±»é€šçŸ¥                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ è¯·å‡ç”³è¯·é€šçŸ¥       âœ“      â”‚  â”‚
â”‚  â”‚ æ¨é€æ–¹å¼ï¼šç³»ç»Ÿå†…ã€å°ç¨‹åº  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ è½¦è¾†å®¡æ ¸é€šçŸ¥       âœ“      â”‚  â”‚
â”‚  â”‚ æ¨é€æ–¹å¼ï¼šç³»ç»Ÿå†…ã€çŸ­ä¿¡    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                 â”‚
â”‚  æé†’ç±»é€šçŸ¥                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ å¹´æ£€æé†’           âœ“      â”‚  â”‚
â”‚  â”‚ æ¨é€æ–¹å¼ï¼šç³»ç»Ÿå†…          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ å·¥èµ„é€šçŸ¥           âœ“      â”‚  â”‚
â”‚  â”‚ æ¨é€æ–¹å¼ï¼šå…¨éƒ¨            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                 â”‚
â”‚  å¼‚å¸¸ç±»é€šçŸ¥                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ è¿ç« æé†’           âœ“      â”‚  â”‚
â”‚  â”‚ æ¨é€æ–¹å¼ï¼šç³»ç»Ÿå†…ã€çŸ­ä¿¡    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¸ƒã€æ€§èƒ½ä¼˜åŒ–

### 7.1 æ•°æ®åº“ä¼˜åŒ–

```sql
-- å¤åˆç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢
CREATE INDEX idx_notifications_user_read 
ON notifications(recipient_id, is_read);

-- éƒ¨åˆ†ç´¢å¼•ï¼ˆåªç´¢å¼•æœªè¯»é€šçŸ¥ï¼‰
CREATE INDEX idx_notifications_unread 
ON notifications(recipient_id, created_at DESC)
WHERE is_read = false;

-- é€šçŸ¥ç±»å‹ç´¢å¼•
CREATE INDEX idx_notifications_type_created 
ON notifications(type, created_at DESC);
```

### 7.2 æ‰¹é‡æ¨é€ä¼˜åŒ–

```typescript
/**
 * æ‰¹é‡åˆ›å»ºé€šçŸ¥
 * ç”¨äºç¾¤å‘åœºæ™¯ï¼Œå¦‚ç³»ç»Ÿå…¬å‘Š
 */
export async function batchCreateNotifications(
  recipientIds: string[],
  notification: Omit<CreateNotificationInput, 'recipient_id'>
): Promise<number> {
  // åˆ†æ‰¹å¤„ç†ï¼Œé¿å…å•æ¬¡æ’å…¥è¿‡å¤š
  const batchSize = 100
  let successCount = 0
  
  for (let i = 0; i < recipientIds.length; i += batchSize) {
    const batch = recipientIds.slice(i, i + batchSize)
    
    const notifications = batch.map(recipientId => ({
      recipient_id: recipientId,
      sender_id: notification.sender_id || null,
      title: notification.title,
      content: notification.content,
      type: notification.type,
      related_id: notification.related_id || null,
      related_type: notification.related_type || null,
      push_channels: notification.channels || [PushChannel.SYSTEM],
      push_status: {},
      is_read: false
    }))
    
    const { data, error } = await supabase
      .from('notifications')
      .insert(notifications)
      .select('id')
    
    if (!error && data) {
      successCount += data.length
    }
  }
  
  return successCount
}
```

### 7.3 å®æ—¶è®¢é˜…

```typescript
/**
 * è®¢é˜…å®æ—¶é€šçŸ¥
 * ç”¨æˆ·è¿›å…¥åº”ç”¨æ—¶è®¢é˜…ï¼Œæ–°é€šçŸ¥å®æ—¶æ¨é€
 */
export function subscribeToNotifications(
  userId: string,
  onNewNotification: (notification: Notification) => void
) {
  return supabase
    .channel(`notifications:${userId}`)
    .on('postgres_changes', {
      event: 'INSERT',
      schema: 'public',
      table: 'notifications',
      filter: `recipient_id=eq.${userId}`
    }, (payload) => {
      onNewNotification(payload.new as Notification)
    })
    .subscribe()
}
```

---

## å…«ã€æµ‹è¯•ç”¨ä¾‹

### 8.1 å•å…ƒæµ‹è¯•

```typescript
describe('é€šçŸ¥ç³»ç»Ÿ', () => {
  describe('æ¨¡æ¿æ¸²æŸ“', () => {
    it('åº”è¯¥æ­£ç¡®æ¸²æŸ“æ¨¡æ¿å˜é‡', () => {
      const template = '{{userName}}çš„è¯·å‡ç”³è¯·ï¼ˆ{{leaveDays}}å¤©ï¼‰'
      const result = renderTemplate(template, {
        userName: 'å¼ ä¸‰',
        leaveDays: 3
      })
      expect(result).toBe('å¼ ä¸‰çš„è¯·å‡ç”³è¯·ï¼ˆ3å¤©ï¼‰')
    })
  })
  
  describe('é€šçŸ¥åˆ›å»º', () => {
    it('åº”è¯¥æˆåŠŸåˆ›å»ºé€šçŸ¥', async () => {
      const notification = await createNotification({
        recipient_id: 'user-id',
        title: 'æµ‹è¯•é€šçŸ¥',
        content: 'è¿™æ˜¯ä¸€æ¡æµ‹è¯•é€šçŸ¥',
        type: NotificationType.SYSTEM_NOTICE
      })
      
      expect(notification.id).toBeDefined()
      expect(notification.is_read).toBe(false)
    })
  })
})
```

---

## ä¹ã€å¸¸è§é—®é¢˜

| é—®é¢˜ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|------|---------|
| æ”¶ä¸åˆ°é€šçŸ¥ | æœªè®¢é˜…æˆ–è®¢é˜…è®¾ç½®é”™è¯¯ | æ£€æŸ¥è®¢é˜…è®¾ç½® |
| å°ç¨‹åºæ¨é€å¤±è´¥ | ç”¨æˆ·æœªæˆæƒè®¢é˜…æ¶ˆæ¯ | å¼•å¯¼ç”¨æˆ·æˆæƒ |
| é€šçŸ¥å»¶è¿Ÿ | æ¨é€é˜Ÿåˆ—å µå¡ | ä¼˜åŒ–æ‰¹é‡æ¨é€é€»è¾‘ |
| æœªè¯»æ•°ä¸å‡† | ç¼“å­˜æœªæ›´æ–° | å¼ºåˆ¶åˆ·æ–°æˆ–æ¸…é™¤ç¼“å­˜ |

---

## åã€æ€»ç»“

é€šçŸ¥ç³»ç»Ÿæ˜¯è½¦é˜Ÿç®¡å®¶çš„æ¶ˆæ¯ä¸­å¿ƒï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

### ä¼˜åŠ¿

- âœ… **å¤šæ¸ é“æ¨é€**: ç³»ç»Ÿå†…ã€å°ç¨‹åºã€çŸ­ä¿¡ã€é‚®ä»¶
- âœ… **æ¨¡æ¿åŒ–ç®¡ç†**: ç»Ÿä¸€çš„æ¶ˆæ¯æ¨¡æ¿
- âœ… **å®æ—¶è®¢é˜…**: æ–°é€šçŸ¥å®æ—¶æ¨é€
- âœ… **ä¸ªæ€§åŒ–é…ç½®**: ç”¨æˆ·è‡ªå®šä¹‰è®¢é˜…è®¾ç½®
- âœ… **æ€§èƒ½ä¼˜åŒ–**: æ‰¹é‡æ¨é€ã€ç´¢å¼•ä¼˜åŒ–

### æŠ€æœ¯äº®ç‚¹

1. æ¨¡æ¿å¼•æ“æ”¯æŒçµæ´»çš„æ¶ˆæ¯å®šåˆ¶
2. å¤šæ¸ é“å¹¶è¡Œæ¨é€æå‡åˆ°è¾¾ç‡
3. å®æ—¶è®¢é˜…æœºåˆ¶ä¿è¯æ¶ˆæ¯åŠæ—¶æ€§
4. è®¢é˜…ç®¡ç†æ”¯æŒä¸ªæ€§åŒ–é…ç½®

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0.0  
**åˆ›å»ºæ—¶é—´**: 2025-12-11  
**ç»´æŠ¤äººå‘˜**: ç³»ç»Ÿå¼€å‘å›¢é˜Ÿ  
**çŠ¶æ€**: å·²å‘å¸ƒ
