# è¯·å‡ç¦»èŒç®¡ç†ç³»ç»ŸæŠ€æœ¯æ–‡æ¡£

## ä¸€ã€åŠŸèƒ½æ¦‚è¿°

### 1.1 åŠŸèƒ½å®šä½

è¯·å‡ç¦»èŒç®¡ç†ç³»ç»Ÿæ˜¯è½¦é˜Ÿç®¡å®¶çš„äººå‘˜ç®¡ç†æ ¸å¿ƒæ¨¡å—ï¼Œè´Ÿè´£å¸æœºè¯·å‡ç”³è¯·ã€ç¦»èŒç”³è¯·çš„å…¨æµç¨‹ç®¡ç†ï¼ŒåŒ…æ‹¬ç”³è¯·æäº¤ã€å®¡æ‰¹æµç¨‹ã€çŠ¶æ€é€šçŸ¥ç­‰ï¼Œç¡®ä¿äººå‘˜å˜åŠ¨çš„è§„èŒƒåŒ–å’Œå¯è¿½æº¯æ€§ã€‚

### 1.2 æ ¸å¿ƒä»·å€¼

- **æµç¨‹è§„èŒƒ**: æ ‡å‡†åŒ–çš„è¯·å‡/ç¦»èŒç”³è¯·å’Œå®¡æ‰¹æµç¨‹
- **æƒé™åˆ†æ˜**: åŸºäºè§’è‰²çš„å¤šçº§å®¡æ‰¹æœºåˆ¶
- **å®æ—¶é€šçŸ¥**: ç”³è¯·çŠ¶æ€å˜æ›´å³æ—¶é€šçŸ¥ç›¸å…³äººå‘˜
- **æ•°æ®å¯è¿½æº¯**: å®Œæ•´è®°å½•å®¡æ‰¹å†å²å’ŒçŠ¶æ€å˜æ›´

### 1.3 ä¸šåŠ¡åœºæ™¯

```
å¸æœºç«¯åœºæ™¯ï¼š
1. æäº¤è¯·å‡ç”³è¯·ï¼ˆç—…å‡ã€äº‹å‡ã€å¹´å‡ç­‰ï¼‰
2. æŸ¥çœ‹å®¡æ‰¹è¿›åº¦å’Œå†å²è®°å½•
3. æäº¤ç¦»èŒç”³è¯·
4. æ¥æ”¶å®¡æ‰¹ç»“æœé€šçŸ¥

ç®¡ç†ç«¯åœºæ™¯ï¼š
1. æŸ¥çœ‹å¾…å®¡æ‰¹çš„è¯·å‡/ç¦»èŒç”³è¯·
2. å®¡æ‰¹è¯·å‡ç”³è¯·ï¼ˆé€šè¿‡/æ‹’ç»ï¼‰
3. å®¡æ‰¹ç¦»èŒç”³è¯·
4. æŸ¥çœ‹å®¡æ‰¹å†å²è®°å½•
5. ç»Ÿè®¡è¯·å‡æ•°æ®
```

---

## äºŒã€ç³»ç»Ÿæ¶æ„

### 2.1 æ•´ä½“æ¶æ„å›¾

```mermaid
graph TB
    subgraph "å¸æœºç«¯"
        A1[è¯·å‡ç”³è¯·é¡µé¢]
        A2[ç¦»èŒç”³è¯·é¡µé¢]
        A3[ç”³è¯·å†å²é¡µé¢]
    end
    
    subgraph "ç®¡ç†ç«¯"
        B1[è¯·å‡å®¡æ‰¹é¡µé¢]
        B2[ç¦»èŒå®¡æ‰¹é¡µé¢]
        B3[å®¡æ‰¹å†å²é¡µé¢]
        B4[è¯·å‡ç»Ÿè®¡é¡µé¢]
    end
    
    subgraph "APIå±‚"
        C1[leave.ts]
        C2[notifications.ts]
        C3[stats.ts]
    end
    
    subgraph "æ•°æ®åº“å±‚"
        D1[(leave_applications)]
        D2[(resignation_applications)]
        D3[(users)]
        D4[(warehouses)]
        D5[(notifications)]
    end
    
    subgraph "é€šçŸ¥æœåŠ¡"
        E1[å®¡æ‰¹é€šçŸ¥]
        E2[çŠ¶æ€å˜æ›´é€šçŸ¥]
    end
    
    A1 --> C1
    A2 --> C1
    A3 --> C1
    B1 --> C1
    B2 --> C1
    B3 --> C1
    B4 --> C3
    
    C1 --> D1
    C1 --> D2
    C1 --> E1
    C1 --> E2
    
    E1 --> C2
    E2 --> C2
    C2 --> D5
    
    D1 -.å…³è”.-> D3
    D1 -.å…³è”.-> D4
    D2 -.å…³è”.-> D3
```

### 2.2 è¯·å‡ç”³è¯·æµç¨‹

```mermaid
sequenceDiagram
    participant Driver as å¸æœº
    participant UI as ç”³è¯·ç•Œé¢
    participant LeaveAPI as leave API
    participant Validator as éªŒè¯å™¨
    participant DB as æ•°æ®åº“
    participant Notification as é€šçŸ¥æœåŠ¡
    participant Reviewer as å®¡æ‰¹äºº
    
    Driver->>UI: 1. å¡«å†™è¯·å‡ä¿¡æ¯
    UI->>UI: 2. é€‰æ‹©æ—¥æœŸå’Œç±»å‹
    UI->>LeaveAPI: 3. æäº¤ç”³è¯·
    
    LeaveAPI->>Validator: 4. éªŒè¯è¯·å‡å¤©æ•°
    Validator-->>LeaveAPI: 5. éªŒè¯ç»“æœ
    
    alt è¶…è¿‡æœ€å¤§å¤©æ•°
        LeaveAPI-->>UI: 6a. è¿”å›é”™è¯¯
        UI-->>Driver: 6b. æ˜¾ç¤ºé”™è¯¯æç¤º
    else éªŒè¯é€šè¿‡
        LeaveAPI->>Validator: 7. æ£€æŸ¥æ—¥æœŸå†²çª
        Validator->>DB: 8. æŸ¥è¯¢å·²æœ‰è¯·å‡
        DB-->>Validator: 9. è¿”å›è®°å½•
        
        alt å­˜åœ¨å†²çª
            Validator-->>LeaveAPI: 10a. å†²çªæç¤º
            LeaveAPI-->>UI: 10b. è¿”å›é”™è¯¯
        else æ— å†²çª
            LeaveAPI->>DB: 11. åˆ›å»ºç”³è¯·è®°å½•
            DB-->>LeaveAPI: 12. è¿”å›è®°å½•ID
            
            LeaveAPI->>Notification: 13. å‘é€é€šçŸ¥
            Notification->>Reviewer: 14. æ¨é€å¾…å®¡æ‰¹é€šçŸ¥
            
            LeaveAPI-->>UI: 15. è¿”å›æˆåŠŸ
            UI-->>Driver: 16. æ˜¾ç¤ºæˆåŠŸæç¤º
        end
    end
```

### 2.3 å®¡æ‰¹æµç¨‹

```mermaid
sequenceDiagram
    participant Reviewer as å®¡æ‰¹äºº
    participant UI as å®¡æ‰¹ç•Œé¢
    participant LeaveAPI as leave API
    participant DB as æ•°æ®åº“
    participant Notification as é€šçŸ¥æœåŠ¡
    participant Driver as ç”³è¯·äºº
    
    Reviewer->>UI: 1. æŸ¥çœ‹å¾…å®¡æ‰¹åˆ—è¡¨
    UI->>LeaveAPI: 2. è·å–å¾…å®¡æ‰¹ç”³è¯·
    LeaveAPI->>DB: 3. æŸ¥è¯¢pendingçŠ¶æ€
    DB-->>LeaveAPI: 4. è¿”å›åˆ—è¡¨
    LeaveAPI-->>UI: 5. æ˜¾ç¤ºåˆ—è¡¨
    
    Reviewer->>UI: 6. ç‚¹å‡»æŸæ¡ç”³è¯·
    UI-->>Reviewer: 7. æ˜¾ç¤ºç”³è¯·è¯¦æƒ…
    
    Reviewer->>UI: 8. é€‰æ‹©é€šè¿‡/æ‹’ç»
    UI->>LeaveAPI: 9. æäº¤å®¡æ‰¹ç»“æœ
    
    LeaveAPI->>DB: 10. æ›´æ–°ç”³è¯·çŠ¶æ€
    LeaveAPI->>DB: 11. è®°å½•å®¡æ‰¹ä¿¡æ¯
    DB-->>LeaveAPI: 12. æ›´æ–°æˆåŠŸ
    
    LeaveAPI->>Notification: 13. å‘é€å®¡æ‰¹ç»“æœé€šçŸ¥
    Notification->>Driver: 14. æ¨é€ç»“æœé€šçŸ¥
    Notification->>Reviewer: 15. æ¨é€ç¡®è®¤é€šçŸ¥
    
    LeaveAPI-->>UI: 16. è¿”å›æˆåŠŸ
    UI-->>Reviewer: 17. æ˜¾ç¤ºæˆåŠŸæç¤º
```

---

## ä¸‰ã€æ•°æ®æ¨¡å‹è®¾è®¡

### 3.1 æ•°æ®åº“è¡¨ç»“æ„

#### 3.1.1 è¯·å‡ç”³è¯·è¡¨ (leave_applications)

```sql
CREATE TABLE leave_applications (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  driver_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  warehouse_id UUID REFERENCES warehouses(id) ON DELETE SET NULL,
  leave_type TEXT NOT NULL CHECK(leave_type IN ('sick', 'personal', 'annual', 'other')),
  start_date DATE NOT NULL,
  end_date DATE NOT NULL,
  days INTEGER NOT NULL CHECK(days > 0),
  reason TEXT NOT NULL,
  status TEXT NOT NULL DEFAULT 'pending' CHECK(status IN ('pending', 'approved', 'rejected')),
  reviewer_id UUID REFERENCES users(id) ON DELETE SET NULL,
  reviewed_at TIMESTAMPTZ,
  review_notes TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  
  -- çº¦æŸï¼šç»“æŸæ—¥æœŸä¸èƒ½æ—©äºå¼€å§‹æ—¥æœŸ
  CONSTRAINT check_date_range CHECK (end_date >= start_date),
  
  -- ç´¢å¼•ä¼˜åŒ–
  INDEX idx_leave_driver (driver_id),
  INDEX idx_leave_status (status),
  INDEX idx_leave_warehouse (warehouse_id),
  INDEX idx_leave_dates (start_date, end_date)
);

COMMENT ON TABLE leave_applications IS 'è¯·å‡ç”³è¯·è¡¨';
COMMENT ON COLUMN leave_applications.leave_type IS 'è¯·å‡ç±»å‹ï¼šsick=ç—…å‡, personal=äº‹å‡, annual=å¹´å‡, other=å…¶ä»–';
COMMENT ON COLUMN leave_applications.days IS 'è¯·å‡å¤©æ•°ï¼ˆå«èµ·æ­¢æ—¥æœŸï¼‰';
COMMENT ON COLUMN leave_applications.status IS 'å®¡æ‰¹çŠ¶æ€ï¼špending=å¾…å®¡æ‰¹, approved=å·²é€šè¿‡, rejected=å·²æ‹’ç»';
```

#### 3.1.2 ç¦»èŒç”³è¯·è¡¨ (resignation_applications)

```sql
CREATE TABLE resignation_applications (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  driver_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  resignation_date DATE NOT NULL,
  reason TEXT NOT NULL,
  notice_days INTEGER NOT NULL DEFAULT 30,
  status TEXT NOT NULL DEFAULT 'pending' CHECK(status IN ('pending', 'approved', 'rejected')),
  reviewer_id UUID REFERENCES users(id) ON DELETE SET NULL,
  reviewed_at TIMESTAMPTZ,
  review_notes TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  
  -- çº¦æŸï¼šç¦»èŒæ—¥æœŸä¸èƒ½æ—©äºç”³è¯·æ—¥æœŸ
  CONSTRAINT check_resignation_date CHECK (resignation_date >= CURRENT_DATE),
  
  -- ç´¢å¼•ä¼˜åŒ–
  INDEX idx_resignation_driver (driver_id),
  INDEX idx_resignation_status (status),
  INDEX idx_resignation_date (resignation_date)
);

COMMENT ON TABLE resignation_applications IS 'ç¦»èŒç”³è¯·è¡¨';
COMMENT ON COLUMN resignation_applications.resignation_date IS 'é¢„è®¡ç¦»èŒæ—¥æœŸ';
COMMENT ON COLUMN resignation_applications.notice_days IS 'æå‰é€šçŸ¥å¤©æ•°';
```

### 3.2 TypeScript ç±»å‹å®šä¹‰

```typescript
/**
 * è¯·å‡ç±»å‹æšä¸¾
 */
export type LeaveType = 'sick' | 'personal' | 'annual' | 'other'

/**
 * ç”³è¯·çŠ¶æ€æšä¸¾
 */
export type ApplicationStatus = 'pending' | 'approved' | 'rejected'

/**
 * è¯·å‡ç”³è¯·æ¥å£
 */
export interface LeaveApplication {
  id: string
  driver_id: string
  warehouse_id: string | null
  leave_type: LeaveType
  start_date: string           // YYYY-MM-DDæ ¼å¼
  end_date: string             // YYYY-MM-DDæ ¼å¼
  days: number                 // è¯·å‡å¤©æ•°
  reason: string               // è¯·å‡åŸå› 
  status: ApplicationStatus    // å®¡æ‰¹çŠ¶æ€
  reviewer_id: string | null   // å®¡æ‰¹äººID
  reviewed_at: string | null   // å®¡æ‰¹æ—¶é—´
  review_notes: string | null  // å®¡æ‰¹å¤‡æ³¨
  created_at: string
  updated_at: string
}

/**
 * ç¦»èŒç”³è¯·æ¥å£
 */
export interface ResignationApplication {
  id: string
  driver_id: string
  resignation_date: string     // é¢„è®¡ç¦»èŒæ—¥æœŸ
  reason: string               // ç¦»èŒåŸå› 
  notice_days: number          // æå‰é€šçŸ¥å¤©æ•°
  status: ApplicationStatus
  reviewer_id: string | null
  reviewed_at: string | null
  review_notes: string | null
  created_at: string
  updated_at: string
}

/**
 * åˆ›å»ºè¯·å‡ç”³è¯·çš„è¾“å…¥
 */
export interface CreateLeaveInput {
  driver_id: string
  warehouse_id?: string
  leave_type: LeaveType
  start_date: string
  end_date: string
  days: number
  reason: string
}

/**
 * å®¡æ‰¹è¯·å‡ç”³è¯·çš„è¾“å…¥
 */
export interface ReviewLeaveInput {
  application_id: string
  reviewer_id: string
  approved: boolean           // true=é€šè¿‡, false=æ‹’ç»
  review_notes?: string       // å®¡æ‰¹å¤‡æ³¨
}
```

---

## å››ã€æ ¸å¿ƒåŠŸèƒ½å®ç°

### 4.1 è¯·å‡ç”³è¯·æäº¤

#### 4.1.1 ä¸šåŠ¡æµç¨‹å›¾

```mermaid
flowchart TD
    Start([å¼€å§‹ç”³è¯·]) --> SelectType[é€‰æ‹©è¯·å‡ç±»å‹]
    SelectType --> SelectDates[é€‰æ‹©èµ·æ­¢æ—¥æœŸ]
    SelectDates --> CalcDays[è®¡ç®—è¯·å‡å¤©æ•°]
    CalcDays --> InputReason[å¡«å†™è¯·å‡åŸå› ]
    
    InputReason --> ValidateDays{éªŒè¯å¤©æ•°}
    ValidateDays -->|è¶…è¿‡é™åˆ¶| ShowError1[æ˜¾ç¤ºé”™è¯¯ï¼šè¶…è¿‡æœ€å¤§å¤©æ•°]
    ValidateDays -->|é€šè¿‡| CheckConflict{æ£€æŸ¥æ—¥æœŸå†²çª}
    
    ShowError1 --> End1([ç»“æŸ])
    
    CheckConflict -->|å­˜åœ¨å†²çª| ShowError2[æ˜¾ç¤ºé”™è¯¯ï¼šæ—¥æœŸå†²çª]
    CheckConflict -->|æ— å†²çª| Preview[æ˜¾ç¤ºé¢„è§ˆ]
    
    ShowError2 --> End1
    
    Preview --> Confirm{ç¡®è®¤æäº¤?}
    Confirm -->|å–æ¶ˆ| End1
    Confirm -->|ç¡®è®¤| Submit[æäº¤ç”³è¯·]
    
    Submit --> SaveDB[ä¿å­˜åˆ°æ•°æ®åº“]
    SaveDB --> SendNotify[å‘é€é€šçŸ¥]
    SendNotify --> Success[æäº¤æˆåŠŸ]
    Success --> End2([ç»“æŸ])
```

#### 4.1.2 æ ¸å¿ƒä»£ç å®ç°

**APIå±‚å®ç°** (`src/db/api/leave.ts`):

```typescript
import { supabase } from '../supabase'
import type { LeaveApplication, CreateLeaveInput, ReviewLeaveInput } from '../types'
import { sendLeaveNotification, sendReviewNotification } from '@/services/notificationService'

/**
 * åˆ›å»ºè¯·å‡ç”³è¯·
 * 
 * @param data è¯·å‡ç”³è¯·æ•°æ®
 * @returns åˆ›å»ºçš„è¯·å‡ç”³è¯·è®°å½•
 * @throws å¦‚æœéªŒè¯å¤±è´¥æˆ–åˆ›å»ºå¤±è´¥
 */
export async function createLeaveApplication(
  data: CreateLeaveInput
): Promise<LeaveApplication> {
  // 1. éªŒè¯è¯·å‡å¤©æ•°
  const maxDays = await getWarehouseMaxLeaveDays(data.warehouse_id)
  if (data.days > maxDays) {
    throw new Error(`è¯·å‡å¤©æ•°ä¸èƒ½è¶…è¿‡${maxDays}å¤©`)
  }
  
  // 2. æ£€æŸ¥æ—¥æœŸå†²çª
  const hasConflict = await checkLeaveDateConflict(
    data.driver_id,
    data.start_date,
    data.end_date
  )
  
  if (hasConflict) {
    throw new Error('è¯·å‡æ—¥æœŸä¸å·²æœ‰è¯·å‡è®°å½•å†²çªï¼Œè¯·é‡æ–°é€‰æ‹©æ—¥æœŸ')
  }
  
  // 3. åˆ›å»ºç”³è¯·è®°å½•
  const { data: application, error } = await supabase
    .from('leave_applications')
    .insert({
      driver_id: data.driver_id,
      warehouse_id: data.warehouse_id,
      leave_type: data.leave_type,
      start_date: data.start_date,
      end_date: data.end_date,
      days: data.days,
      reason: data.reason,
      status: 'pending'
    })
    .select()
    .single()
  
  if (error) {
    console.error('[createLeaveApplication] åˆ›å»ºå¤±è´¥:', error)
    throw new Error(`åˆ›å»ºè¯·å‡ç”³è¯·å¤±è´¥: ${error.message}`)
  }
  
  // 4. å‘é€é€šçŸ¥ç»™å®¡æ‰¹äºº
  try {
    await sendLeaveNotification(application)
  } catch (notifyError) {
    console.error('[createLeaveApplication] é€šçŸ¥å‘é€å¤±è´¥:', notifyError)
    // é€šçŸ¥å¤±è´¥ä¸å½±å“ç”³è¯·åˆ›å»ºï¼Œä»…è®°å½•æ—¥å¿—
  }
  
  return application
}

/**
 * æ£€æŸ¥è¯·å‡æ—¥æœŸæ˜¯å¦å†²çª
 * 
 * @param driverId å¸æœºID
 * @param startDate å¼€å§‹æ—¥æœŸ
 * @param endDate ç»“æŸæ—¥æœŸ
 * @returns æ˜¯å¦å­˜åœ¨å†²çª
 */
async function checkLeaveDateConflict(
  driverId: string,
  startDate: string,
  endDate: string
): Promise<boolean> {
  const { data, error } = await supabase
    .from('leave_applications')
    .select('id')
    .eq('driver_id', driverId)
    .eq('status', 'approved')  // åªæ£€æŸ¥å·²é€šè¿‡çš„è¯·å‡
    .or(`start_date.lte.${endDate},end_date.gte.${startDate}`)
    .limit(1)
  
  if (error) {
    console.error('[checkLeaveDateConflict] æŸ¥è¯¢å¤±è´¥:', error)
    return false
  }
  
  return data.length > 0
}

/**
 * è·å–ä»“åº“çš„æœ€å¤§è¯·å‡å¤©æ•°é…ç½®
 * 
 * @param warehouseId ä»“åº“ID
 * @returns æœ€å¤§è¯·å‡å¤©æ•°ï¼Œé»˜è®¤7å¤©
 */
async function getWarehouseMaxLeaveDays(
  warehouseId?: string
): Promise<number> {
  if (!warehouseId) return 7  // é»˜è®¤7å¤©
  
  const { data } = await supabase
    .from('warehouses')
    .select('max_leave_days')
    .eq('id', warehouseId)
    .single()
  
  return data?.max_leave_days || 7
}
```

### 4.2 è¯·å‡ç”³è¯·å®¡æ‰¹

#### 4.2.1 å®¡æ‰¹é€»è¾‘

```typescript
/**
 * å®¡æ‰¹è¯·å‡ç”³è¯·
 * 
 * @param input å®¡æ‰¹è¾“å…¥æ•°æ®
 * @returns æ˜¯å¦å®¡æ‰¹æˆåŠŸ
 * @throws å¦‚æœå®¡æ‰¹å¤±è´¥
 */
export async function reviewLeaveApplication(
  input: ReviewLeaveInput
): Promise<boolean> {
  const { application_id, reviewer_id, approved, review_notes } = input
  
  // 1. è·å–ç”³è¯·è¯¦æƒ…
  const { data: application, error: fetchError } = await supabase
    .from('leave_applications')
    .select('*')
    .eq('id', application_id)
    .single()
  
  if (fetchError || !application) {
    throw new Error('æœªæ‰¾åˆ°è¯¥è¯·å‡ç”³è¯·')
  }
  
  // 2. æ£€æŸ¥ç”³è¯·çŠ¶æ€
  if (application.status !== 'pending') {
    throw new Error('è¯¥ç”³è¯·å·²è¢«å®¡æ‰¹ï¼Œæ— æ³•é‡å¤æ“ä½œ')
  }
  
  // 3. æ›´æ–°å®¡æ‰¹çŠ¶æ€
  const status = approved ? 'approved' : 'rejected'
  const { error: updateError } = await supabase
    .from('leave_applications')
    .update({
      status,
      reviewer_id,
      reviewed_at: new Date().toISOString(),
      review_notes: review_notes || null,
      updated_at: new Date().toISOString()
    })
    .eq('id', application_id)
  
  if (updateError) {
    console.error('[reviewLeaveApplication] æ›´æ–°å¤±è´¥:', updateError)
    throw new Error(`å®¡æ‰¹å¤±è´¥: ${updateError.message}`)
  }
  
  // 4. å‘é€å®¡æ‰¹ç»“æœé€šçŸ¥
  try {
    await sendReviewNotification({
      applicationId: application_id,
      driverId: application.driver_id,
      reviewerId: reviewer_id,
      approved,
      applicationType: 'leave'
    })
  } catch (notifyError) {
    console.error('[reviewLeaveApplication] é€šçŸ¥å‘é€å¤±è´¥:', notifyError)
  }
  
  return true
}

/**
 * è·å–å¾…å®¡æ‰¹çš„è¯·å‡ç”³è¯·åˆ—è¡¨
 * 
 * @param reviewerId å®¡æ‰¹äººID
 * @param role å®¡æ‰¹äººè§’è‰²
 * @returns å¾…å®¡æ‰¹åˆ—è¡¨
 */
export async function getPendingLeaveApplications(
  reviewerId: string,
  role: UserRole
): Promise<LeaveApplication[]> {
  let query = supabase
    .from('leave_applications')
    .select(`
      *,
      driver:users!driver_id(id, name, phone),
      warehouse:warehouses(id, name)
    `)
    .eq('status', 'pending')
    .order('created_at', { ascending: false })
  
  // æ ¹æ®è§’è‰²è¿‡æ»¤æ•°æ®
  if (role === 'MANAGER') {
    // è½¦é˜Ÿé•¿åªèƒ½çœ‹åˆ°è‡ªå·±ç®¡è¾–ä»“åº“çš„ç”³è¯·
    const { data: warehouses } = await supabase
      .from('warehouse_assignments')
      .select('warehouse_id')
      .eq('user_id', reviewerId)
    
    const warehouseIds = warehouses?.map(w => w.warehouse_id) || []
    query = query.in('warehouse_id', warehouseIds)
  }
  // BOSSå’ŒPEER_ADMINå¯ä»¥çœ‹åˆ°æ‰€æœ‰ç”³è¯·
  
  const { data, error } = await query
  
  if (error) {
    console.error('[getPendingLeaveApplications] æŸ¥è¯¢å¤±è´¥:', error)
    throw error
  }
  
  return data || []
}
```

### 4.3 ç¦»èŒç”³è¯·ç®¡ç†

#### 4.3.1 ç¦»èŒç”³è¯·æµç¨‹

```mermaid
stateDiagram-v2
    [*] --> å¡«å†™ç”³è¯·
    å¡«å†™ç”³è¯· --> éªŒè¯æå‰å¤©æ•°
    
    éªŒè¯æå‰å¤©æ•° --> æäº¤å¤±è´¥: ä¸è¶³æå‰å¤©æ•°
    éªŒè¯æå‰å¤©æ•° --> åˆ›å»ºç”³è¯·: ç¬¦åˆè¦æ±‚
    
    åˆ›å»ºç”³è¯· --> å¾…å®¡æ‰¹
    å¾…å®¡æ‰¹ --> å®¡æ‰¹ä¸­: å®¡æ‰¹äººæŸ¥çœ‹
    
    å®¡æ‰¹ä¸­ --> å·²é€šè¿‡: å®¡æ‰¹é€šè¿‡
    å®¡æ‰¹ä¸­ --> å·²æ‹’ç»: å®¡æ‰¹æ‹’ç»
    
    å·²é€šè¿‡ --> ç¦»èŒå¤„ç†
    å·²æ‹’ç» --> [*]
    
    ç¦»èŒå¤„ç† --> [*]
    æäº¤å¤±è´¥ --> [*]
```

#### 4.3.2 æ ¸å¿ƒå®ç°

```typescript
/**
 * åˆ›å»ºç¦»èŒç”³è¯·
 * 
 * @param data ç¦»èŒç”³è¯·æ•°æ®
 * @returns åˆ›å»ºçš„ç¦»èŒç”³è¯·è®°å½•
 */
export async function createResignationApplication(data: {
  driver_id: string
  resignation_date: string
  reason: string
  notice_days: number
}): Promise<ResignationApplication> {
  // 1. éªŒè¯æå‰å¤©æ•°
  const requiredNoticeDays = await getRequiredNoticeDays(data.driver_id)
  if (data.notice_days < requiredNoticeDays) {
    throw new Error(`ç¦»èŒéœ€è¦æå‰${requiredNoticeDays}å¤©ç”³è¯·`)
  }
  
  // 2. æ£€æŸ¥æ˜¯å¦å·²æœ‰å¾…å®¡æ‰¹çš„ç¦»èŒç”³è¯·
  const { data: existing } = await supabase
    .from('resignation_applications')
    .select('id')
    .eq('driver_id', data.driver_id)
    .eq('status', 'pending')
    .maybeSingle()
  
  if (existing) {
    throw new Error('æ‚¨å·²æœ‰å¾…å®¡æ‰¹çš„ç¦»èŒç”³è¯·ï¼Œè¯·å‹¿é‡å¤æäº¤')
  }
  
  // 3. åˆ›å»ºç¦»èŒç”³è¯·
  const { data: application, error } = await supabase
    .from('resignation_applications')
    .insert({
      driver_id: data.driver_id,
      resignation_date: data.resignation_date,
      reason: data.reason,
      notice_days: data.notice_days,
      status: 'pending'
    })
    .select()
    .single()
  
  if (error) {
    console.error('[createResignationApplication] åˆ›å»ºå¤±è´¥:', error)
    throw new Error(`åˆ›å»ºç¦»èŒç”³è¯·å¤±è´¥: ${error.message}`)
  }
  
  // 4. å‘é€é€šçŸ¥
  await sendResignationNotification(application)
  
  return application
}

/**
 * è·å–ç¦»èŒæ‰€éœ€çš„æå‰é€šçŸ¥å¤©æ•°
 * 
 * @param driverId å¸æœºID
 * @returns æå‰å¤©æ•°ï¼Œé»˜è®¤30å¤©
 */
async function getRequiredNoticeDays(driverId: string): Promise<number> {
  // ä»ä»“åº“é…ç½®æˆ–ç”¨æˆ·åˆåŒä¸­è·å–ï¼Œè¿™é‡Œç®€åŒ–ä¸ºå›ºå®š30å¤©
  return 30
}
```

---

## äº”ã€æƒé™æ§åˆ¶

### 5.1 æƒé™çŸ©é˜µ

| æ“ä½œ | BOSS | PEER_ADMIN | MANAGER | DRIVER |
|------|------|------------|---------|--------|
| æäº¤è¯·å‡ç”³è¯· | âœ… | âœ… | âœ… | âœ… |
| æŸ¥çœ‹æ‰€æœ‰è¯·å‡ç”³è¯· | âœ… | âœ… | âŒ | âŒ |
| æŸ¥çœ‹ç®¡è¾–èŒƒå›´è¯·å‡ | âœ… | âœ… | âœ… | âŒ |
| æŸ¥çœ‹è‡ªå·±çš„è¯·å‡ | âœ… | âœ… | âœ… | âœ… |
| å®¡æ‰¹è¯·å‡ç”³è¯· | âœ… | âœ… | âœ… | âŒ |
| æäº¤ç¦»èŒç”³è¯· | âœ… | âœ… | âœ… | âœ… |
| å®¡æ‰¹ç¦»èŒç”³è¯· | âœ… | âœ… | âŒ | âŒ |
| æ’¤é”€ç”³è¯· | âœ… | âœ… | âœ… | âœ… |

### 5.2 æƒé™é…ç½®

**åº”ç”¨å±‚æƒé™é…ç½®** (`src/config/permission-config.ts`):

```typescript
export const permissionConfig = {
  // è¯·å‡ç”³è¯·æƒé™
  leave_applications: [
    {
      action: PermissionAction.SELECT,
      roles: ['BOSS', 'PEER_ADMIN'],
      allowAll: true  // å¯ä»¥æŸ¥çœ‹æ‰€æœ‰ç”³è¯·
    },
    {
      action: PermissionAction.SELECT,
      roles: ['MANAGER'],
      filter: (userId: string) => ({ manager_id: userId })  // æŸ¥çœ‹ç®¡è¾–èŒƒå›´
    },
    {
      action: PermissionAction.SELECT,
      roles: ['DRIVER'],
      filter: (userId: string) => ({ driver_id: userId })  // åªèƒ½æŸ¥çœ‹è‡ªå·±
    },
    {
      action: PermissionAction.INSERT,
      roles: ['BOSS', 'PEER_ADMIN', 'MANAGER', 'DRIVER'],
      filter: (userId: string) => ({ driver_id: userId })
    },
    {
      action: PermissionAction.UPDATE,
      roles: ['BOSS', 'PEER_ADMIN', 'MANAGER'],
      allowAll: true  // å®¡æ‰¹æƒé™
    }
  ],
  
  // ç¦»èŒç”³è¯·æƒé™
  resignation_applications: [
    {
      action: PermissionAction.SELECT,
      roles: ['BOSS', 'PEER_ADMIN'],
      allowAll: true
    },
    {
      action: PermissionAction.SELECT,
      roles: ['DRIVER', 'MANAGER'],
      filter: (userId: string) => ({ driver_id: userId })
    },
    {
      action: PermissionAction.INSERT,
      roles: ['BOSS', 'PEER_ADMIN', 'MANAGER', 'DRIVER'],
      filter: (userId: string) => ({ driver_id: userId })
    },
    {
      action: PermissionAction.UPDATE,
      roles: ['BOSS', 'PEER_ADMIN'],
      allowAll: true  // åªæœ‰BOSSå’Œè°ƒåº¦å¯ä»¥å®¡æ‰¹ç¦»èŒ
    }
  ]
}
```

---

## å…­ã€ä¸šåŠ¡è§„åˆ™

### 6.1 è¯·å‡è§„åˆ™

1. **å¤©æ•°é™åˆ¶**
   - å•æ¬¡è¯·å‡ä¸èƒ½è¶…è¿‡ä»“åº“é…ç½®çš„æœ€å¤§å¤©æ•°
   - é»˜è®¤æœ€å¤§è¯·å‡å¤©æ•°ä¸º7å¤©
   - ç‰¹æ®Šæƒ…å†µéœ€è¦å®¡æ‰¹äººæ‰¹å‡†

2. **æ—¥æœŸè§„åˆ™**
   - ç»“æŸæ—¥æœŸä¸èƒ½æ—©äºå¼€å§‹æ—¥æœŸ
   - ä¸èƒ½ä¸å·²æ‰¹å‡†çš„è¯·å‡æ—¥æœŸå†²çª
   - è¯·å‡æ—¥æœŸè®¡ç®—å«èµ·æ­¢ä¸¤å¤©

3. **å®¡æ‰¹è§„åˆ™**
   - å¾…å®¡æ‰¹çŠ¶æ€æ‰èƒ½è¿›è¡Œå®¡æ‰¹æ“ä½œ
   - å·²å®¡æ‰¹çš„ç”³è¯·ä¸èƒ½é‡å¤å®¡æ‰¹
   - å®¡æ‰¹åè‡ªåŠ¨å‘é€é€šçŸ¥

4. **è€ƒå‹¤å…³è”**
   - è¯·å‡æœŸé—´è‡ªåŠ¨å…é™¤æ‰“å¡è¦æ±‚
   - è¯·å‡æœŸé—´ä¸èƒ½å½•å…¥è®¡ä»¶è®°å½•

### 6.2 ç¦»èŒè§„åˆ™

1. **æå‰é€šçŸ¥**
   - æ­£å¼å‘˜å·¥éœ€æå‰30å¤©ç”³è¯·
   - è¯•ç”¨æœŸå‘˜å·¥éœ€æå‰7å¤©ç”³è¯·
   - ç‰¹æ®Šæƒ…å†µå¯åå•†å¤„ç†

2. **ç¦»èŒæ—¥æœŸ**
   - ç¦»èŒæ—¥æœŸä¸èƒ½æ—©äºç”³è¯·æ—¥æœŸ
   - ç¦»èŒæ—¥æœŸå¿…é¡»ç¬¦åˆæå‰é€šçŸ¥å¤©æ•°

3. **å®¡æ‰¹æƒé™**
   - åªæœ‰BOSSå’ŒPEER_ADMINå¯ä»¥å®¡æ‰¹ç¦»èŒ
   - ç¦»èŒå®¡æ‰¹éœ€è¦è®°å½•å®¡æ‰¹æ„è§

4. **åç»­å¤„ç†**
   - ç¦»èŒé€šè¿‡åè¿›è¡Œè´¦å·å¤„ç†
   - æ¸…ç®—å·¥èµ„å’Œç»“ç®—äº‹é¡¹
   - å›æ”¶ç›¸å…³èµ„äº§å’Œæƒé™

### 6.3 ä¸šåŠ¡çº¦æŸå›¾

```mermaid
graph TB
    A[è¯·å‡ç”³è¯·] --> B{å¤©æ•°æ£€æŸ¥}
    B -->|è¶…è¿‡é™åˆ¶| C[æ‹’ç»ç”³è¯·]
    B -->|ç¬¦åˆè§„å®š| D{æ—¥æœŸå†²çªæ£€æŸ¥}
    
    D -->|å­˜åœ¨å†²çª| C
    D -->|æ— å†²çª| E[åˆ›å»ºç”³è¯·]
    
    E --> F[å¾…å®¡æ‰¹çŠ¶æ€]
    F --> G{å®¡æ‰¹æ“ä½œ}
    
    G -->|é€šè¿‡| H[æ›´æ–°ä¸ºapproved]
    G -->|æ‹’ç»| I[æ›´æ–°ä¸ºrejected]
    
    H --> J[å‘é€é€šçŸ¥]
    I --> J
    J --> K[å½±å“è€ƒå‹¤]
    K --> L[å®Œæˆ]
```

---

## ä¸ƒã€é€šçŸ¥æœºåˆ¶

### 7.1 é€šçŸ¥æ—¶æœº

1. **ç”³è¯·æäº¤æ—¶**
   - é€šçŸ¥å®¡æ‰¹äººï¼ˆBOSSã€PEER_ADMINã€ç®¡è¾–MANAGERï¼‰
   - é€šçŸ¥å†…å®¹ï¼šæ–°ç”³è¯·å¾…å®¡æ‰¹

2. **å®¡æ‰¹å®Œæˆæ—¶**
   - é€šçŸ¥ç”³è¯·äººï¼ˆDRIVERï¼‰
   - é€šçŸ¥å†…å®¹ï¼šå®¡æ‰¹ç»“æœï¼ˆé€šè¿‡/æ‹’ç»ï¼‰

3. **çŠ¶æ€å˜æ›´æ—¶**
   - æ’¤é”€ç”³è¯·æ—¶é€šçŸ¥ç›¸å…³äººå‘˜
   - è¶…æ—¶æœªå®¡æ‰¹æ—¶æé†’å®¡æ‰¹äºº

### 7.2 é€šçŸ¥å®ç°

```typescript
/**
 * å‘é€è¯·å‡ç”³è¯·é€šçŸ¥
 * é€šçŸ¥å®¡æ‰¹äººæœ‰æ–°çš„è¯·å‡ç”³è¯·
 */
async function sendLeaveNotification(
  application: LeaveApplication
): Promise<void> {
  // è·å–é€šçŸ¥æ¥æ”¶äºº
  const recipients = await getLeaveReviewers(application)
  
  // æ‰¹é‡åˆ›å»ºé€šçŸ¥
  const notifications = recipients.map(reviewer => ({
    recipient_id: reviewer.id,
    sender_id: application.driver_id,
    title: 'æ–°çš„è¯·å‡ç”³è¯·',
    content: `${application.driver_name}ç”³è¯·è¯·å‡${application.days}å¤©ï¼Œè¯·åŠæ—¶å®¡æ‰¹`,
    type: 'leave_approval',
    related_id: application.id
  }))
  
  await supabase
    .from('notifications')
    .insert(notifications)
}

/**
 * å‘é€å®¡æ‰¹ç»“æœé€šçŸ¥
 */
async function sendReviewNotification(data: {
  applicationId: string
  driverId: string
  reviewerId: string
  approved: boolean
  applicationType: 'leave' | 'resignation'
}): Promise<void> {
  const status = data.approved ? 'å·²é€šè¿‡' : 'å·²æ‹’ç»'
  const typeText = data.applicationType === 'leave' ? 'è¯·å‡ç”³è¯·' : 'ç¦»èŒç”³è¯·'
  
  await supabase
    .from('notifications')
    .insert({
      recipient_id: data.driverId,
      sender_id: data.reviewerId,
      title: `${typeText}å®¡æ‰¹ç»“æœ`,
      content: `æ‚¨çš„${typeText}${status}`,
      type: `${data.applicationType}_approval`,
      related_id: data.applicationId
    })
}
```

---

## å…«ã€ç•Œé¢è®¾è®¡

### 8.1 å¸æœºç«¯ - è¯·å‡ç”³è¯·é¡µé¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â† è¯·å‡ç”³è¯·                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                 â”‚
â”‚  è¯·å‡ç±»å‹                        â”‚
â”‚  â—‹ ç—…å‡  â—‹ äº‹å‡                â”‚
â”‚  â—‹ å¹´å‡  â—‹ å…¶ä»–                â”‚
â”‚                                 â”‚
â”‚  å¼€å§‹æ—¥æœŸ                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 2025-12-15 â–¼             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                 â”‚
â”‚  ç»“æŸæ—¥æœŸ                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 2025-12-17 â–¼             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                 â”‚
â”‚  è¯·å‡å¤©æ•°: 3å¤©                  â”‚
â”‚                                 â”‚
â”‚  è¯·å‡åŸå›                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ å®¶ä¸­æœ‰äº‹éœ€è¦å¤„ç†          â”‚  â”‚
â”‚  â”‚                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                 â”‚
â”‚  ğŸ’¡ æç¤ºï¼š                      â”‚
â”‚  â€¢ å•æ¬¡è¯·å‡æœ€å¤š7å¤©              â”‚
â”‚  â€¢ è¯·å‡æœŸé—´æ— éœ€æ‰“å¡             â”‚
â”‚  â€¢ è¯·å‡æœŸé—´ä¸å¯å½•å…¥è®¡ä»¶         â”‚
â”‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚       æäº¤ç”³è¯·            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.2 ç®¡ç†ç«¯ - å®¡æ‰¹é¡µé¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â† è¯·å‡å®¡æ‰¹                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç­›é€‰: â— å¾…å®¡æ‰¹  â—‹ å·²å®¡æ‰¹       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ å¼ ä¸‰ - äº‹å‡               â”‚  â”‚
â”‚  â”‚ 2025-12-15 è‡³ 12-17       â”‚  â”‚
â”‚  â”‚ è¯·å‡3å¤©                   â”‚  â”‚
â”‚  â”‚ åŸå› ï¼šå®¶ä¸­æœ‰äº‹            â”‚  â”‚
â”‚  â”‚                           â”‚  â”‚
â”‚  â”‚ [é€šè¿‡] [æ‹’ç»]             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ æå›› - ç—…å‡               â”‚  â”‚
â”‚  â”‚ 2025-12-20 è‡³ 12-22       â”‚  â”‚
â”‚  â”‚ è¯·å‡3å¤©                   â”‚  â”‚
â”‚  â”‚ åŸå› ï¼šèº«ä½“ä¸é€‚éœ€è¦ä¼‘æ¯    â”‚  â”‚
â”‚  â”‚                           â”‚  â”‚
â”‚  â”‚ [é€šè¿‡] [æ‹’ç»]             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å®¡æ‰¹è¯¦æƒ…å¼¹çª—ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®¡æ‰¹è¯·å‡ç”³è¯·                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç”³è¯·äºº: å¼ ä¸‰                   â”‚
â”‚  è¯·å‡ç±»å‹: äº‹å‡                 â”‚
â”‚  è¯·å‡æ—¶é—´: 2025-12-15 è‡³ 12-17  â”‚
â”‚  è¯·å‡å¤©æ•°: 3å¤©                  â”‚
â”‚  è¯·å‡åŸå› : å®¶ä¸­æœ‰äº‹éœ€è¦å¤„ç†     â”‚
â”‚  ç”³è¯·æ—¶é—´: 2025-12-11 10:30     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å®¡æ‰¹æ„è§ï¼ˆé€‰å¡«ï¼‰               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ é€š è¿‡ â”‚  â”‚ æ‹’ ç» â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¹ã€æ€§èƒ½ä¼˜åŒ–

### 9.1 æ•°æ®åº“ä¼˜åŒ–

#### 9.1.1 ç´¢å¼•ç­–ç•¥

```sql
-- å¸æœºIDç´¢å¼•ï¼ˆæŸ¥è¯¢ä¸ªäººç”³è¯·ï¼‰
CREATE INDEX idx_leave_driver ON leave_applications(driver_id);

-- çŠ¶æ€ç´¢å¼•ï¼ˆæŸ¥è¯¢å¾…å®¡æ‰¹åˆ—è¡¨ï¼‰
CREATE INDEX idx_leave_status ON leave_applications(status);

-- æ—¥æœŸèŒƒå›´ç´¢å¼•ï¼ˆæ£€æŸ¥å†²çªï¼‰
CREATE INDEX idx_leave_dates ON leave_applications(start_date, end_date);

-- ä»“åº“IDç´¢å¼•ï¼ˆè½¦é˜Ÿé•¿æŸ¥è¯¢ç®¡è¾–èŒƒå›´ï¼‰
CREATE INDEX idx_leave_warehouse ON leave_applications(warehouse_id);

-- å¤åˆç´¢å¼•ï¼ˆä¼˜åŒ–å¸¸ç”¨æŸ¥è¯¢ï¼‰
CREATE INDEX idx_leave_driver_status 
ON leave_applications(driver_id, status);
```

#### 9.1.2 æŸ¥è¯¢ä¼˜åŒ–

```typescript
// ä½¿ç”¨EXISTSå­æŸ¥è¯¢ä¼˜åŒ–å†²çªæ£€æŸ¥
async function checkConflictOptimized(
  driverId: string,
  startDate: string,
  endDate: string
): Promise<boolean> {
  const { data } = await supabase
    .rpc('check_leave_conflict', {
      p_driver_id: driverId,
      p_start_date: startDate,
      p_end_date: endDate
    })
  
  return data || false
}

// å¯¹åº”çš„æ•°æ®åº“å‡½æ•°
/*
CREATE OR REPLACE FUNCTION check_leave_conflict(
  p_driver_id UUID,
  p_start_date DATE,
  p_end_date DATE
) RETURNS BOOLEAN AS $$
BEGIN
  RETURN EXISTS (
    SELECT 1 FROM leave_applications
    WHERE driver_id = p_driver_id
      AND status = 'approved'
      AND (start_date <= p_end_date AND end_date >= p_start_date)
  );
END;
$$ LANGUAGE plpgsql;
*/
```

### 9.2 å‰ç«¯ä¼˜åŒ–

#### 9.2.1 åˆ—è¡¨åˆ†é¡µ

```typescript
// åˆ†é¡µåŠ è½½å®¡æ‰¹åˆ—è¡¨
async function getPendingLeavesPaginated(
  page: number = 1,
  pageSize: number = 20
): Promise<{ data: LeaveApplication[], total: number }> {
  const from = (page - 1) * pageSize
  const to = from + pageSize - 1
  
  const { data, error, count } = await supabase
    .from('leave_applications')
    .select('*', { count: 'exact' })
    .eq('status', 'pending')
    .range(from, to)
    .order('created_at', { ascending: false })
  
  return {
    data: data || [],
    total: count || 0
  }
}
```

#### 9.2.2 å®æ—¶è®¢é˜…

```typescript
// è®¢é˜…å®¡æ‰¹çŠ¶æ€å˜æ›´
function subscribeToLeaveStatus(
  applicationId: string,
  onUpdate: (application: LeaveApplication) => void
) {
  return supabase
    .channel(`leave:${applicationId}`)
    .on('postgres_changes', {
      event: 'UPDATE',
      schema: 'public',
      table: 'leave_applications',
      filter: `id=eq.${applicationId}`
    }, (payload) => {
      onUpdate(payload.new as LeaveApplication)
    })
    .subscribe()
}
```

---

## åã€æµ‹è¯•ç”¨ä¾‹

### 10.1 å•å…ƒæµ‹è¯•

```typescript
describe('è¯·å‡ç¦»èŒç®¡ç†ç³»ç»Ÿ', () => {
  describe('æ—¥æœŸå†²çªæ£€æŸ¥', () => {
    it('åº”è¯¥æ£€æµ‹åˆ°é‡å çš„è¯·å‡æ—¥æœŸ', async () => {
      // å·²æœ‰è¯·å‡ï¼š12-15 åˆ° 12-20
      const hasConflict = await checkLeaveDateConflict(
        'driver-id',
        '2025-12-18',  // æ–°è¯·å‡å¼€å§‹
        '2025-12-22'   // æ–°è¯·å‡ç»“æŸ
      )
      expect(hasConflict).toBe(true)
    })
    
    it('ä¸é‡å çš„æ—¥æœŸåº”è¯¥é€šè¿‡æ£€æŸ¥', async () => {
      const hasConflict = await checkLeaveDateConflict(
        'driver-id',
        '2025-12-25',
        '2025-12-27'
      )
      expect(hasConflict).toBe(false)
    })
  })
  
  describe('å¤©æ•°éªŒè¯', () => {
    it('è¶…è¿‡æœ€å¤§å¤©æ•°åº”è¯¥æŠ›å‡ºé”™è¯¯', async () => {
      await expect(
        createLeaveApplication({
          days: 10,  // è¶…è¿‡é»˜è®¤çš„7å¤©
          // ... å…¶ä»–å‚æ•°
        })
      ).rejects.toThrow('è¯·å‡å¤©æ•°ä¸èƒ½è¶…è¿‡7å¤©')
    })
  })
  
  describe('å®¡æ‰¹æµç¨‹', () => {
    it('å·²å®¡æ‰¹çš„ç”³è¯·ä¸èƒ½é‡å¤å®¡æ‰¹', async () => {
      await expect(
        reviewLeaveApplication({
          application_id: 'approved-app-id',
          reviewer_id: 'reviewer-id',
          approved: true
        })
      ).rejects.toThrow('è¯¥ç”³è¯·å·²è¢«å®¡æ‰¹')
    })
  })
})
```

### 10.2 é›†æˆæµ‹è¯•

```typescript
describe('å®Œæ•´çš„è¯·å‡æµç¨‹', () => {
  it('ä»ç”³è¯·åˆ°å®¡æ‰¹çš„å®Œæ•´æµç¨‹', async () => {
    // 1. åˆ›å»ºè¯·å‡ç”³è¯·
    const application = await createLeaveApplication({
      driver_id: 'driver-id',
      warehouse_id: 'warehouse-id',
      leave_type: 'personal',
      start_date: '2025-12-15',
      end_date: '2025-12-17',
      days: 3,
      reason: 'å®¶ä¸­æœ‰äº‹'
    })
    
    expect(application.status).toBe('pending')
    
    // 2. å®¡æ‰¹äººå®¡æ‰¹
    await reviewLeaveApplication({
      application_id: application.id,
      reviewer_id: 'reviewer-id',
      approved: true,
      review_notes: 'åŒæ„è¯·å‡'
    })
    
    // 3. éªŒè¯çŠ¶æ€æ›´æ–°
    const { data: updated } = await supabase
      .from('leave_applications')
      .select('*')
      .eq('id', application.id)
      .single()
    
    expect(updated.status).toBe('approved')
    expect(updated.reviewer_id).toBe('reviewer-id')
  })
})
```

---

## åä¸€ã€å¸¸è§é—®é¢˜

### 11.1 é—®é¢˜æ’æŸ¥

| é—®é¢˜ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|------|---------|
| æ— æ³•æäº¤è¯·å‡ | æ—¥æœŸå†²çªæˆ–è¶…è¿‡å¤©æ•°é™åˆ¶ | æ£€æŸ¥å·²æœ‰è¯·å‡è®°å½•ï¼Œè°ƒæ•´æ—¥æœŸ |
| å®¡æ‰¹å¤±è´¥ | ç”³è¯·å·²è¢«å®¡æ‰¹ | åˆ·æ–°é¡µé¢æŸ¥çœ‹æœ€æ–°çŠ¶æ€ |
| æ”¶ä¸åˆ°é€šçŸ¥ | é€šçŸ¥æœåŠ¡å¼‚å¸¸ | æ£€æŸ¥é€šçŸ¥æƒé™å’Œç½‘ç»œè¿æ¥ |
| ç¦»èŒç”³è¯·è¢«æ‹’ | æå‰å¤©æ•°ä¸è¶³ | è°ƒæ•´ç¦»èŒæ—¥æœŸï¼Œæ»¡è¶³æå‰é€šçŸ¥è¦æ±‚ |

### 11.2 æ•°æ®ä¿®å¤è„šæœ¬

```sql
-- æ¸…ç†å¼‚å¸¸çŠ¶æ€çš„ç”³è¯·
UPDATE leave_applications 
SET status = 'rejected'
WHERE status = 'pending' 
  AND created_at < NOW() - INTERVAL '30 days';

-- ä¿®å¤æ—¥æœŸèŒƒå›´é”™è¯¯
UPDATE leave_applications
SET end_date = start_date
WHERE end_date < start_date;

-- é‡æ–°è®¡ç®—è¯·å‡å¤©æ•°
UPDATE leave_applications
SET days = (end_date - start_date) + 1
WHERE days != (end_date - start_date) + 1;
```

---

## åäºŒã€æœªæ¥æ‰©å±•

### 12.1 åŠŸèƒ½æ‰©å±•

1. **è¯·å‡é¢åº¦ç®¡ç†**
   - å¹´å‡é¢åº¦è·Ÿè¸ª
   - è¯·å‡ä½™é¢æŸ¥è¯¢
   - é¢åº¦è‡ªåŠ¨æ‰£å‡

2. **æ‰¹é‡å®¡æ‰¹**
   - ä¸€é”®æ‰¹é‡é€šè¿‡
   - æ‰¹é‡æ‹’ç»åŠŸèƒ½
   - å®¡æ‰¹è§„åˆ™è‡ªåŠ¨åŒ–

3. **è¯·å‡ç»Ÿè®¡**
   - éƒ¨é—¨è¯·å‡ç‡åˆ†æ
   - è¯·å‡ç±»å‹åˆ†å¸ƒ
   - è¯·å‡è¶‹åŠ¿é¢„æµ‹

### 12.2 æŠ€æœ¯ä¼˜åŒ–

1. **å·¥ä½œæµå¼•æ“**
   - å¤šçº§å®¡æ‰¹æµç¨‹
   - å®¡æ‰¹è§„åˆ™é…ç½®
   - è‡ªåŠ¨æµè½¬æœºåˆ¶

2. **æ™ºèƒ½æé†’**
   - è¶…æ—¶æœªå®¡æ‰¹æé†’
   - è¯·å‡åˆ°æœŸæé†’
   - å¼‚å¸¸è¯·å‡é¢„è­¦

---

## åä¸‰ã€æ€»ç»“

è¯·å‡ç¦»èŒç®¡ç†ç³»ç»Ÿæ˜¯è½¦é˜Ÿç®¡å®¶çš„äººå‘˜ç®¡ç†æ ¸å¿ƒï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

### ä¼˜åŠ¿

- âœ… **æµç¨‹è§„èŒƒ**: æ ‡å‡†åŒ–çš„ç”³è¯·å’Œå®¡æ‰¹æµç¨‹
- âœ… **æƒé™å®Œå–„**: å¤šçº§å®¡æ‰¹å’Œç»†ç²’åº¦æƒé™æ§åˆ¶
- âœ… **å®æ—¶é€šçŸ¥**: çŠ¶æ€å˜æ›´å³æ—¶é€šçŸ¥ç›¸å…³äººå‘˜
- âœ… **æ•°æ®å®Œæ•´**: å®Œæ•´çš„å®¡æ‰¹å†å²å’ŒçŠ¶æ€è®°å½•
- âœ… **æ€§èƒ½ä¼˜åŒ–**: ç´¢å¼•ä¼˜åŒ–ã€åˆ†é¡µåŠ è½½ã€å®æ—¶è®¢é˜…

### æŠ€æœ¯äº®ç‚¹

1. æ—¥æœŸå†²çªæ£€æŸ¥é¿å…è¯·å‡é‡å 
2. å¤©æ•°é™åˆ¶ä¿è¯è§„åˆ™åˆè§„
3. å¤šè§’è‰²å®¡æ‰¹æ”¯æŒçµæ´»çš„å®¡æ‰¹æµç¨‹
4. é€šçŸ¥æœºåˆ¶ç¡®ä¿ä¿¡æ¯åŠæ—¶ä¼ è¾¾

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0.0  
**åˆ›å»ºæ—¶é—´**: 2025-12-11  
**ç»´æŠ¤äººå‘˜**: ç³»ç»Ÿå¼€å‘å›¢é˜Ÿ  
**çŠ¶æ€**: å·²å‘å¸ƒ
