# 车辆管理和通知系统功能使用指南

## 目录
1. [车辆管理功能](#一车辆管理功能)
2. [通知系统功能](#二通知系统功能)
3. [常见问题](#三常见问题)

---

## 一、车辆管理功能

### 1.1 功能概述
车辆管理功能提供了完整的车辆信息管理、车辆分配、状态跟踪等功能，支持管理员和司机两种角色的不同权限。

### 1.2 管理员功能

#### 1.2.1 创建车辆
```typescript
import { supabase } from '@/client/supabase';

// 方法1：使用辅助函数
const { data, error } = await supabase.rpc('create_vehicle', {
  p_user_id: userId,
  p_plate_number: '京A12345',
  p_brand: '东风',
  p_model: '天龙',
  p_color: '白色',
  p_vin: 'VIN123456789',
  p_vehicle_type: '货车',
  p_warehouse_id: warehouseId,
  p_notes: '备注信息'
});

// 方法2：直接插入（会自动应用 RLS 策略）
const { data, error } = await supabase
  .from('vehicles')
  .insert({
    user_id: userId,
    plate_number: '京A12345',
    brand: '东风',
    model: '天龙',
    color: '白色',
    vin: 'VIN123456789',
    vehicle_type: '货车',
    warehouse_id: warehouseId,
    notes: '备注信息',
    status: 'active'
  })
  .select()
  .single();
```

#### 1.2.2 查看所有车辆
```typescript
// 方法1：使用辅助函数（推荐）
const { data, error } = await supabase.rpc('get_all_vehicles', {
  p_admin_id: adminId,
  p_status: 'active', // 可选：筛选状态
  p_warehouse_id: warehouseId // 可选：筛选仓库
});

// 方法2：直接查询（会自动应用 RLS 策略）
const { data, error } = await supabase
  .from('vehicles')
  .select(`
    *,
    warehouse:warehouses(name),
    driver:users!driver_id(name),
    current_driver:users!current_driver_id(name)
  `)
  .eq('is_active', true)
  .order('created_at', { ascending: false });
```

#### 1.2.3 分配车辆给司机
```typescript
const { data, error } = await supabase.rpc('assign_vehicle_to_driver', {
  p_vehicle_id: vehicleId,
  p_driver_id: driverId,
  p_assigned_by: adminId
});

if (error) {
  console.error('分配失败:', error.message);
} else {
  console.log('分配成功');
}
```

#### 1.2.4 取消车辆分配
```typescript
const { data, error } = await supabase.rpc('unassign_vehicle_from_driver', {
  p_vehicle_id: vehicleId,
  p_unassigned_by: adminId
});

if (error) {
  console.error('取消分配失败:', error.message);
} else {
  console.log('取消分配成功');
}
```

#### 1.2.5 更新车辆状态
```typescript
const { data, error } = await supabase.rpc('update_vehicle_status', {
  p_vehicle_id: vehicleId,
  p_status: 'maintenance', // active, maintenance, inactive, retired
  p_updated_by: adminId
});

if (error) {
  console.error('更新状态失败:', error.message);
} else {
  console.log('更新状态成功');
}
```

#### 1.2.6 获取车辆统计
```typescript
const { data, error } = await supabase.rpc('get_vehicle_statistics', {
  p_admin_id: adminId
});

if (data) {
  console.log('总车辆数:', data[0].total_vehicles);
  console.log('活跃车辆:', data[0].active_vehicles);
  console.log('维护中车辆:', data[0].maintenance_vehicles);
  console.log('已分配车辆:', data[0].assigned_vehicles);
  console.log('未分配车辆:', data[0].unassigned_vehicles);
}
```

### 1.3 司机功能

#### 1.3.1 查看自己的车辆
```typescript
// 方法1：使用辅助函数（推荐）
const { data, error } = await supabase.rpc('get_user_vehicles', {
  p_user_id: userId,
  p_status: 'active' // 可选：筛选状态
});

// 方法2：直接查询（会自动应用 RLS 策略）
const { data, error } = await supabase
  .from('vehicles')
  .select('*')
  .eq('is_active', true)
  .order('created_at', { ascending: false });
```

#### 1.3.2 创建自己的车辆
```typescript
const { data, error } = await supabase
  .from('vehicles')
  .insert({
    user_id: userId, // 必须是当前用户
    plate_number: '京A12345',
    brand: '东风',
    model: '天龙',
    color: '白色',
    notes: '备注信息',
    status: 'active'
  })
  .select()
  .single();
```

#### 1.3.3 更新自己的车辆
```typescript
const { data, error } = await supabase
  .from('vehicles')
  .update({
    notes: '更新的备注信息',
    color: '蓝色'
  })
  .eq('id', vehicleId)
  .eq('user_id', userId) // 确保只更新自己的车辆
  .select()
  .single();
```

#### 1.3.4 查看车辆详情
```typescript
const { data, error } = await supabase.rpc('get_vehicle_details', {
  p_vehicle_id: vehicleId,
  p_user_id: userId
});

if (data && data.length > 0) {
  const vehicle = data[0];
  console.log('车牌号:', vehicle.plate_number);
  console.log('品牌:', vehicle.brand);
  console.log('型号:', vehicle.model);
  console.log('状态:', vehicle.status);
  console.log('仓库:', vehicle.warehouse_name);
  console.log('司机:', vehicle.driver_name);
}
```

---

## 二、通知系统功能

### 2.1 功能概述
通知系统提供了完整的消息通知功能，支持系统通知、审批通知、提醒通知、公告通知和警告通知等多种类型。

### 2.2 管理员功能

#### 2.2.1 发送单个通知
```typescript
const { data, error } = await supabase.rpc('send_notification', {
  p_sender_id: adminId,
  p_recipient_id: recipientId,
  p_type: 'announcement', // system, approval, reminder, announcement, alert
  p_title: '通知标题',
  p_content: '通知内容',
  p_action_url: '/pages/detail/index?id=123', // 可选
  p_related_id: relatedId // 可选：关联的记录ID
});

if (error) {
  console.error('发送通知失败:', error.message);
} else {
  console.log('通知ID:', data);
}
```

#### 2.2.2 批量发送通知
```typescript
const recipientIds = [userId1, userId2, userId3];

const { data, error } = await supabase.rpc('send_notification_to_multiple', {
  p_sender_id: adminId,
  p_recipient_ids: recipientIds,
  p_type: 'announcement',
  p_title: '系统公告',
  p_content: '重要通知内容',
  p_action_url: '/pages/announcement/index',
  p_related_id: null
});

if (error) {
  console.error('批量发送失败:', error.message);
} else {
  console.log('成功发送通知数量:', data);
}
```

#### 2.2.3 查看所有通知
```typescript
const { data, error } = await supabase.rpc('get_all_notifications', {
  p_admin_id: adminId,
  p_type: 'announcement', // 可选：筛选类型
  p_recipient_id: userId, // 可选：筛选接收者
  p_limit: 100 // 可选：限制数量
});

if (data) {
  data.forEach(notification => {
    console.log('标题:', notification.title);
    console.log('接收者:', notification.recipient_name);
    console.log('类型:', notification.type);
    console.log('是否已读:', notification.is_read);
  });
}
```

#### 2.2.4 获取通知统计
```typescript
const { data, error } = await supabase.rpc('get_notification_statistics', {
  p_admin_id: adminId
});

if (data && data.length > 0) {
  const stats = data[0];
  console.log('总通知数:', stats.total_notifications);
  console.log('未读通知:', stats.unread_notifications);
  console.log('已读通知:', stats.read_notifications);
  console.log('系统通知:', stats.system_notifications);
  console.log('审批通知:', stats.approval_notifications);
  console.log('提醒通知:', stats.reminder_notifications);
  console.log('公告通知:', stats.announcement_notifications);
  console.log('警告通知:', stats.alert_notifications);
}
```

### 2.3 用户功能

#### 2.3.1 查看自己的通知
```typescript
// 方法1：使用辅助函数（推荐）
const { data, error } = await supabase.rpc('get_user_notifications', {
  p_user_id: userId,
  p_is_read: false, // 可选：只查看未读通知
  p_type: 'approval', // 可选：筛选类型
  p_limit: 50 // 可选：限制数量
});

// 方法2：直接查询（会自动应用 RLS 策略）
const { data, error } = await supabase
  .from('notifications')
  .select('*')
  .eq('is_read', false)
  .order('created_at', { ascending: false })
  .limit(50);
```

#### 2.3.2 获取未读通知数量
```typescript
const { data, error } = await supabase.rpc('get_unread_notifications_count', {
  p_user_id: userId
});

if (data !== null) {
  console.log('未读通知数量:', data);
}
```

#### 2.3.3 标记通知为已读
```typescript
const { data, error } = await supabase.rpc('mark_notification_as_read', {
  p_notification_id: notificationId,
  p_user_id: userId
});

if (error) {
  console.error('标记失败:', error.message);
} else {
  console.log('标记成功');
}
```

#### 2.3.4 批量标记所有通知为已读
```typescript
const { data, error } = await supabase.rpc('mark_all_notifications_as_read', {
  p_user_id: userId
});

if (error) {
  console.error('批量标记失败:', error.message);
} else {
  console.log('已标记通知数量:', data);
}
```

#### 2.3.5 删除通知
```typescript
const { data, error } = await supabase.rpc('delete_notification', {
  p_notification_id: notificationId,
  p_user_id: userId
});

if (error) {
  console.error('删除失败:', error.message);
} else {
  console.log('删除成功');
}
```

### 2.4 通知类型说明

| 类型 | 说明 | 使用场景 |
|------|------|----------|
| system | 系统通知 | 系统自动生成的通知 |
| approval | 审批通知 | 审批流程相关的通知 |
| reminder | 提醒通知 | 定时提醒、到期提醒等 |
| announcement | 公告通知 | 系统公告、重要通知 |
| alert | 警告通知 | 异常警告、紧急通知 |

---

## 三、常见问题

### 3.1 车辆管理常见问题

#### Q1: 司机为什么看不到某些车辆？
**A:** 司机只能查看分配给自己的车辆（driver_id、current_driver_id）或自己创建的车辆（user_id）。如果需要查看其他车辆，请联系管理员。

#### Q2: 司机可以删除车辆吗？
**A:** 不可以。只有管理员才能删除车辆。司机只能更新自己创建的车辆信息。

#### Q3: 如何区分 driver_id 和 current_driver_id？
**A:** 
- `driver_id`: 车辆的主要负责司机
- `current_driver_id`: 车辆当前使用的司机
- `user_id`: 车辆的创建者

#### Q4: 车辆状态有哪些？
**A:** 
- `active`: 活跃状态，可正常使用
- `maintenance`: 维护中，暂时不可用
- `inactive`: 停用状态
- `retired`: 已报废

### 3.2 通知系统常见问题

#### Q1: 为什么收不到通知？
**A:** 请检查：
1. 通知是否正确发送（检查 recipient_id）
2. 是否有权限查看该通知
3. 通知是否被删除

#### Q2: 如何实现实时通知？
**A:** 可以使用 Supabase 的实时订阅功能：
```typescript
const subscription = supabase
  .channel('notifications')
  .on(
    'postgres_changes',
    {
      event: 'INSERT',
      schema: 'public',
      table: 'notifications',
      filter: `recipient_id=eq.${userId}`
    },
    (payload) => {
      console.log('收到新通知:', payload.new);
      // 更新UI显示新通知
    }
  )
  .subscribe();
```

#### Q3: 通知可以撤回吗？
**A:** 管理员可以删除任何通知，用户只能删除自己的通知。删除后无法恢复。

#### Q4: 如何发送给所有用户？
**A:** 使用批量发送功能，先查询所有用户ID，然后调用 `send_notification_to_multiple` 函数。

### 3.3 权限相关问题

#### Q1: 如何判断用户是否为管理员？
**A:** 使用 `is_admin` 函数：
```typescript
const { data, error } = await supabase.rpc('is_admin', {
  uid: userId
});

if (data) {
  console.log('用户是管理员');
} else {
  console.log('用户不是管理员');
}
```

#### Q2: 权限不足时会发生什么？
**A:** 
- 查询操作：返回空结果
- 插入/更新/删除操作：返回错误信息
- 辅助函数：抛出异常并返回错误消息

#### Q3: 如何测试权限？
**A:** 
1. 使用不同角色的用户登录
2. 尝试执行各种操作
3. 检查返回结果是否符合预期
4. 查看错误消息是否清晰

---

## 四、最佳实践

### 4.1 车辆管理最佳实践

1. **使用辅助函数**
   - 优先使用提供的辅助函数，它们包含了完整的业务逻辑和权限检查
   - 辅助函数提供了更好的错误处理和数据验证

2. **错误处理**
   ```typescript
   const { data, error } = await supabase.rpc('create_vehicle', params);
   
   if (error) {
     // 显示用户友好的错误消息
     Taro.showToast({
       title: error.message,
       icon: 'none'
     });
     return;
   }
   
   // 处理成功情况
   Taro.showToast({
     title: '创建成功',
     icon: 'success'
   });
   ```

3. **数据验证**
   - 在前端进行基本的数据验证
   - 后端函数会进行更严格的验证
   - 确保必填字段不为空

### 4.2 通知系统最佳实践

1. **通知内容**
   - 标题简洁明了，不超过20个字
   - 内容清晰完整，包含必要的信息
   - 提供操作链接（action_url）方便用户快速处理

2. **通知时机**
   - 重要操作完成后立即发送通知
   - 避免频繁发送相同内容的通知
   - 合理使用批量发送功能

3. **通知管理**
   - 定期清理过期通知
   - 提供通知筛选和搜索功能
   - 实现通知分类显示

---

## 五、技术支持

如有问题，请联系：
- 技术支持邮箱：support@example.com
- 系统管理员：admin@example.com

---

**文档版本**：1.0  
**最后更新**：2025-12-01  
**维护人员**：系统管理员
