# è½¦è¾†ç®¡ç†ç³»ç»ŸæŠ€æœ¯æ–‡æ¡£

## ä¸€ã€åŠŸèƒ½æ¦‚è¿°

### 1.1 åŠŸèƒ½å®šä½

è½¦è¾†ç®¡ç†ç³»ç»Ÿæ˜¯è½¦é˜Ÿç®¡å®¶çš„æ ¸å¿ƒèµ„äº§ç®¡ç†æ¨¡å—ï¼Œè´Ÿè´£è½¦è¾†ä¿¡æ¯çš„å…¨ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ŒåŒ…æ‹¬è½¦è¾†ç™»è®°ã€å®¡æ ¸ã€OCRè¯†åˆ«ã€è¿ç« æŸ¥è¯¢ã€å¹´æ£€ç®¡ç†ç­‰ï¼Œç¡®ä¿è½¦é˜Ÿè½¦è¾†ä¿¡æ¯çš„å‡†ç¡®æ€§å’Œåˆè§„æ€§ã€‚

### 1.2 æ ¸å¿ƒä»·å€¼

- **èµ„äº§ç®¡ç†**: å®Œæ•´çš„è½¦è¾†æ¡£æ¡ˆå’Œä¿¡æ¯ç®¡ç†
- **æ™ºèƒ½è¯†åˆ«**: OCRè‡ªåŠ¨è¯†åˆ«è¡Œé©¶è¯ä¿¡æ¯
- **å®¡æ ¸æœºåˆ¶**: ä¸¥æ ¼çš„è½¦è¾†ä¿¡æ¯å®¡æ ¸æµç¨‹
- **åˆè§„ç®¡ç†**: å¹´æ£€æé†’ã€è¿ç« æŸ¥è¯¢ã€ä¿é™©ç®¡ç†
- **æ•°æ®å‡†ç¡®**: å¤šé‡éªŒè¯ç¡®ä¿è½¦è¾†ä¿¡æ¯å‡†ç¡®

### 1.3 ä¸šåŠ¡åœºæ™¯

```
å¸æœºç«¯åœºæ™¯ï¼š
1. æ·»åŠ è½¦è¾†ä¿¡æ¯ï¼ˆæ‹ç…§ä¸Šä¼ è¡Œé©¶è¯ï¼‰
2. OCRè‡ªåŠ¨è¯†åˆ«è½¦è¾†ä¿¡æ¯
3. è¡¥å……å’Œå®Œå–„è½¦è¾†ä¿¡æ¯
4. æŸ¥çœ‹å®¡æ ¸çŠ¶æ€
5. ç®¡ç†è‡ªå·±çš„è½¦è¾†åˆ—è¡¨

ç®¡ç†ç«¯åœºæ™¯ï¼š
1. å®¡æ ¸å¾…å®¡æ ¸è½¦è¾†
2. æŸ¥çœ‹æ‰€æœ‰è½¦è¾†åˆ—è¡¨
3. è½¦è¾†ä¿¡æ¯ä¿®æ”¹å’Œæ›´æ–°
4. è½¦è¾†è¿ç« æŸ¥è¯¢
5. å¹´æ£€åˆ°æœŸæé†’
6. è½¦è¾†ç»Ÿè®¡åˆ†æ
```

---

## äºŒã€ç³»ç»Ÿæ¶æ„

### 2.1 æ•´ä½“æ¶æ„å›¾

```mermaid
graph TB
    subgraph "å¸æœºç«¯"
        A1[è½¦è¾†æ·»åŠ é¡µé¢]
        A2[OCRè¯†åˆ«]
        A3[è½¦è¾†åˆ—è¡¨é¡µé¢]
        A4[è½¦è¾†è¯¦æƒ…é¡µé¢]
    end
    
    subgraph "ç®¡ç†ç«¯"
        B1[è½¦è¾†å®¡æ ¸é¡µé¢]
        B2[è½¦è¾†ç®¡ç†é¡µé¢]
        B3[è¿ç« æŸ¥è¯¢]
        B4[å¹´æ£€ç®¡ç†]
        B5[è½¦è¾†ç»Ÿè®¡]
    end
    
    subgraph "APIå±‚"
        C1[vehicles.ts]
        C2[ocr.ts]
        C3[violations.ts]
        C4[inspection.ts]
    end
    
    subgraph "ç¬¬ä¸‰æ–¹æœåŠ¡"
        E1[OCRè¯†åˆ«æœåŠ¡]
        E2[è¿ç« æŸ¥è¯¢API]
        E3[è½¦è¾†ä¿¡æ¯æŸ¥è¯¢]
    end
    
    subgraph "æ•°æ®åº“å±‚"
        D1[(vehicles)]
        D2[(users)]
        D3[(warehouses)]
        D4[(vehicle_inspections)]
    end
    
    A1 --> A2
    A2 --> E1
    A1 --> C1
    A3 --> C1
    A4 --> C1
    
    B1 --> C1
    B2 --> C1
    B3 --> C3
    B4 --> C4
    B5 --> C1
    
    C1 --> D1
    C2 --> E1
    C3 --> E2
    C4 --> D4
    
    D1 -.å…³è”.-> D2
    D1 -.å…³è”.-> D3
    D4 -.å…³è”.-> D1
```

### 2.2 è½¦è¾†æ·»åŠ æµç¨‹

```mermaid
sequenceDiagram
    participant Driver as å¸æœº
    participant UI as æ·»åŠ ç•Œé¢
    participant OCR as OCRæœåŠ¡
    participant VehicleAPI as vehicles API
    participant Validator as éªŒè¯å™¨
    participant DB as æ•°æ®åº“
    participant Reviewer as å®¡æ ¸äºº
    
    Driver->>UI: 1. ç‚¹å‡»æ·»åŠ è½¦è¾†
    UI->>Driver: 2. æ‰“å¼€ç›¸æœº
    Driver->>UI: 3. æ‹æ‘„è¡Œé©¶è¯
    
    UI->>OCR: 4. ä¸Šä¼ å›¾ç‰‡
    OCR->>OCR: 5. OCRè¯†åˆ«
    OCR-->>UI: 6. è¿”å›è¯†åˆ«ç»“æœ
    
    UI-->>Driver: 7. æ˜¾ç¤ºè¯†åˆ«ä¿¡æ¯
    Driver->>UI: 8. ç¡®è®¤/ä¿®æ”¹ä¿¡æ¯
    
    UI->>VehicleAPI: 9. æäº¤è½¦è¾†ä¿¡æ¯
    VehicleAPI->>Validator: 10. éªŒè¯è½¦ç‰Œå·æ ¼å¼
    VehicleAPI->>Validator: 11. æ£€æŸ¥é‡å¤
    
    alt éªŒè¯å¤±è´¥
        Validator-->>VehicleAPI: 12a. è¿”å›é”™è¯¯
        VehicleAPI-->>UI: 12b. æ˜¾ç¤ºé”™è¯¯
    else éªŒè¯é€šè¿‡
        VehicleAPI->>DB: 13. åˆ›å»ºè½¦è¾†è®°å½•
        DB-->>VehicleAPI: 14. è¿”å›è½¦è¾†ID
        
        VehicleAPI->>Reviewer: 15. é€šçŸ¥å®¡æ ¸
        VehicleAPI-->>UI: 16. è¿”å›æˆåŠŸ
        UI-->>Driver: 17. æ˜¾ç¤ºç­‰å¾…å®¡æ ¸
    end
```

### 2.3 è½¦è¾†å®¡æ ¸æµç¨‹

```mermaid
flowchart TD
    Start([å¼€å§‹å®¡æ ¸]) --> LoadPending[åŠ è½½å¾…å®¡æ ¸åˆ—è¡¨]
    LoadPending --> SelectVehicle[é€‰æ‹©è½¦è¾†]
    SelectVehicle --> ViewDetails[æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯]
    
    ViewDetails --> CheckPlate{éªŒè¯è½¦ç‰Œå·}
    CheckPlate -->|æ ¼å¼é”™è¯¯| Reject1[æ‹’ç»ï¼šè½¦ç‰Œå·æ ¼å¼é”™è¯¯]
    CheckPlate -->|æ ¼å¼æ­£ç¡®| CheckVIN{éªŒè¯è½¦æ¶å·}
    
    CheckVIN -->|æ ¼å¼é”™è¯¯| Reject2[æ‹’ç»ï¼šè½¦æ¶å·æ ¼å¼é”™è¯¯]
    CheckVIN -->|æ ¼å¼æ­£ç¡®| CheckOwner{éªŒè¯è½¦ä¸»ä¿¡æ¯}
    
    CheckOwner -->|ä¿¡æ¯ä¸ç¬¦| Reject3[æ‹’ç»ï¼šè½¦ä¸»ä¿¡æ¯ä¸ç¬¦]
    CheckOwner -->|ä¿¡æ¯æ­£ç¡®| CheckImage{æ£€æŸ¥ç…§ç‰‡}
    
    CheckImage -->|ç…§ç‰‡ä¸æ¸…æ™°| Reject4[æ‹’ç»ï¼šç…§ç‰‡ä¸æ¸…æ™°]
    CheckImage -->|ç…§ç‰‡æ¸…æ™°| Approve[é€šè¿‡å®¡æ ¸]
    
    Reject1 --> FillReason[å¡«å†™æ‹’ç»åŸå› ]
    Reject2 --> FillReason
    Reject3 --> FillReason
    Reject4 --> FillReason
    
    FillReason --> UpdateStatus1[æ›´æ–°çŠ¶æ€ä¸ºrejected]
    Approve --> UpdateStatus2[æ›´æ–°çŠ¶æ€ä¸ºapproved]
    
    UpdateStatus1 --> SendNotification1[å‘é€æ‹’ç»é€šçŸ¥]
    UpdateStatus2 --> SendNotification2[å‘é€é€šè¿‡é€šçŸ¥]
    
    SendNotification1 --> End([ç»“æŸ])
    SendNotification2 --> End
```

---

## ä¸‰ã€æ•°æ®æ¨¡å‹è®¾è®¡

### 3.1 æ•°æ®åº“è¡¨ç»“æ„

#### 3.1.1 è½¦è¾†è¡¨ (vehicles)

```sql
CREATE TABLE vehicles (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  warehouse_id UUID REFERENCES warehouses(id) ON DELETE SET NULL,
  
  -- åŸºæœ¬ä¿¡æ¯
  plate_number TEXT NOT NULL,
  vin TEXT,  -- è½¦æ¶å·
  vehicle_type TEXT,  -- è½¦å‹
  brand TEXT,  -- å“ç‰Œ
  model TEXT,  -- å‹å·
  color TEXT,  -- é¢œè‰²
  
  -- è¯ä»¶ä¿¡æ¯
  license_image_url TEXT,  -- è¡Œé©¶è¯ç…§ç‰‡
  registration_date DATE,  -- æ³¨å†Œæ—¥æœŸ
  issue_date DATE,  -- å‘è¯æ—¥æœŸ
  
  -- è½¦ä¸»ä¿¡æ¯
  owner_name TEXT NOT NULL,
  owner_id_number TEXT,  -- è½¦ä¸»èº«ä»½è¯å·
  
  -- å®¡æ ¸ä¿¡æ¯
  status TEXT NOT NULL DEFAULT 'pending' CHECK(status IN ('pending', 'approved', 'rejected')),
  reviewer_id UUID REFERENCES users(id) ON DELETE SET NULL,
  reviewed_at TIMESTAMPTZ,
  review_notes TEXT,
  
  -- å…¶ä»–ä¿¡æ¯
  is_active BOOLEAN DEFAULT true,
  notes TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  
  -- å”¯ä¸€çº¦æŸï¼šè½¦ç‰Œå·å”¯ä¸€
  CONSTRAINT uq_plate_number UNIQUE (plate_number),
  
  -- ç´¢å¼•
  INDEX idx_vehicles_user (user_id),
  INDEX idx_vehicles_status (status),
  INDEX idx_vehicles_warehouse (warehouse_id),
  INDEX idx_vehicles_plate (plate_number)
);

COMMENT ON TABLE vehicles IS 'è½¦è¾†ä¿¡æ¯è¡¨';
COMMENT ON COLUMN vehicles.status IS 'å®¡æ ¸çŠ¶æ€ï¼špending=å¾…å®¡æ ¸, approved=å·²é€šè¿‡, rejected=å·²æ‹’ç»';
COMMENT ON COLUMN vehicles.is_active IS 'æ˜¯å¦æ¿€æ´»ï¼ˆç”¨äºè½¯åˆ é™¤ï¼‰';
```

#### 3.1.2 è½¦è¾†å¹´æ£€è®°å½•è¡¨ (vehicle_inspections)

```sql
CREATE TABLE vehicle_inspections (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  vehicle_id UUID NOT NULL REFERENCES vehicles(id) ON DELETE CASCADE,
  inspection_date DATE NOT NULL,  -- å¹´æ£€æ—¥æœŸ
  next_inspection_date DATE NOT NULL,  -- ä¸‹æ¬¡å¹´æ£€æ—¥æœŸ
  inspection_result TEXT CHECK(inspection_result IN ('pass', 'fail')),
  inspection_location TEXT,  -- å¹´æ£€åœ°ç‚¹
  certificate_image_url TEXT,  -- å¹´æ£€è¯ä¹¦ç…§ç‰‡
  notes TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  
  INDEX idx_inspections_vehicle (vehicle_id),
  INDEX idx_inspections_next_date (next_inspection_date)
);

COMMENT ON TABLE vehicle_inspections IS 'è½¦è¾†å¹´æ£€è®°å½•è¡¨';
```

#### 3.1.3 è½¦è¾†è¿ç« è®°å½•è¡¨ (vehicle_violations)

```sql
CREATE TABLE vehicle_violations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  vehicle_id UUID NOT NULL REFERENCES vehicles(id) ON DELETE CASCADE,
  violation_date DATE NOT NULL,  -- è¿ç« æ—¥æœŸ
  violation_type TEXT NOT NULL,  -- è¿ç« ç±»å‹
  violation_location TEXT,  -- è¿ç« åœ°ç‚¹
  penalty_points INTEGER DEFAULT 0,  -- æ‰£åˆ†
  fine_amount DECIMAL(10, 2) DEFAULT 0,  -- ç½šæ¬¾é‡‘é¢
  is_processed BOOLEAN DEFAULT false,  -- æ˜¯å¦å·²å¤„ç†
  processed_at TIMESTAMPTZ,
  notes TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  
  INDEX idx_violations_vehicle (vehicle_id),
  INDEX idx_violations_processed (is_processed),
  INDEX idx_violations_date (violation_date)
);

COMMENT ON TABLE vehicle_violations IS 'è½¦è¾†è¿ç« è®°å½•è¡¨';
```

### 3.2 TypeScript ç±»å‹å®šä¹‰

```typescript
/**
 * è½¦è¾†å®¡æ ¸çŠ¶æ€æšä¸¾
 */
export type VehicleStatus = 'pending' | 'approved' | 'rejected'

/**
 * å¹´æ£€ç»“æœæšä¸¾
 */
export type InspectionResult = 'pass' | 'fail'

/**
 * è½¦è¾†ä¿¡æ¯æ¥å£
 */
export interface Vehicle {
  id: string
  user_id: string
  warehouse_id: string | null
  
  // åŸºæœ¬ä¿¡æ¯
  plate_number: string        // è½¦ç‰Œå·
  vin: string | null          // è½¦æ¶å·
  vehicle_type: string | null // è½¦å‹
  brand: string | null        // å“ç‰Œ
  model: string | null        // å‹å·
  color: string | null        // é¢œè‰²
  
  // è¯ä»¶ä¿¡æ¯
  license_image_url: string | null  // è¡Œé©¶è¯ç…§ç‰‡
  registration_date: string | null  // æ³¨å†Œæ—¥æœŸ
  issue_date: string | null         // å‘è¯æ—¥æœŸ
  
  // è½¦ä¸»ä¿¡æ¯
  owner_name: string
  owner_id_number: string | null
  
  // å®¡æ ¸ä¿¡æ¯
  status: VehicleStatus
  reviewer_id: string | null
  reviewed_at: string | null
  review_notes: string | null
  
  // å…¶ä»–
  is_active: boolean
  notes: string | null
  created_at: string
  updated_at: string
}

/**
 * å¹´æ£€è®°å½•æ¥å£
 */
export interface VehicleInspection {
  id: string
  vehicle_id: string
  inspection_date: string
  next_inspection_date: string
  inspection_result: InspectionResult
  inspection_location: string | null
  certificate_image_url: string | null
  notes: string | null
  created_at: string
  updated_at: string
}

/**
 * è¿ç« è®°å½•æ¥å£
 */
export interface VehicleViolation {
  id: string
  vehicle_id: string
  violation_date: string
  violation_type: string
  violation_location: string | null
  penalty_points: number
  fine_amount: number
  is_processed: boolean
  processed_at: string | null
  notes: string | null
  created_at: string
  updated_at: string
}

/**
 * OCRè¯†åˆ«ç»“æœæ¥å£
 */
export interface OCRResult {
  plate_number: string
  vin: string
  vehicle_type: string
  owner_name: string
  registration_date: string
  brand: string
  model: string
  confidence: number  // è¯†åˆ«ç½®ä¿¡åº¦ 0-1
}

/**
 * åˆ›å»ºè½¦è¾†è¾“å…¥
 */
export interface CreateVehicleInput {
  user_id: string
  warehouse_id?: string
  plate_number: string
  vin?: string
  vehicle_type?: string
  brand?: string
  model?: string
  color?: string
  license_image_url?: string
  registration_date?: string
  issue_date?: string
  owner_name: string
  owner_id_number?: string
  notes?: string
}

/**
 * å®¡æ ¸è½¦è¾†è¾“å…¥
 */
export interface ReviewVehicleInput {
  vehicle_id: string
  reviewer_id: string
  approved: boolean
  review_notes?: string
}
```

---

## å››ã€æ ¸å¿ƒåŠŸèƒ½å®ç°

### 4.1 è½¦è¾†æ·»åŠ ä¸OCRè¯†åˆ«

#### 4.1.1 OCRè¯†åˆ«å®ç°

```typescript
import Taro from '@tarojs/taro'

/**
 * è¡Œé©¶è¯OCRè¯†åˆ«
 * 
 * @param imagePath è¡Œé©¶è¯å›¾ç‰‡è·¯å¾„
 * @returns OCRè¯†åˆ«ç»“æœ
 */
export async function recognizeVehicleLicense(
  imagePath: string
): Promise<OCRResult> {
  try {
    // 1. å›¾ç‰‡é¢„å¤„ç†ï¼ˆå‹ç¼©ã€è£å‰ªï¼‰
    const processedImage = await preprocessImage(imagePath)
    
    // 2. è°ƒç”¨OCRæœåŠ¡
    const response = await Taro.request({
      url: 'https://api.ocr-service.com/vehicle-license',
      method: 'POST',
      data: {
        image: processedImage,
        type: 'vehicle_license'
      }
    })
    
    // 3. è§£æè¯†åˆ«ç»“æœ
    const result = parseOCRResponse(response.data)
    
    // 4. éªŒè¯è¯†åˆ«ç»“æœ
    validateOCRResult(result)
    
    return result
  } catch (error) {
    console.error('[recognizeVehicleLicense] OCRè¯†åˆ«å¤±è´¥:', error)
    throw new Error('è¡Œé©¶è¯è¯†åˆ«å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥')
  }
}

/**
 * å›¾ç‰‡é¢„å¤„ç†
 */
async function preprocessImage(imagePath: string): Promise<string> {
  // å‹ç¼©å›¾ç‰‡åˆ°åˆé€‚å¤§å°
  const { path } = await Taro.compressImage({
    src: imagePath,
    quality: 80
  })
  
  // è½¬æ¢ä¸ºbase64
  const base64 = await imageToBase64(path)
  return base64
}

/**
 * è§£æOCRå“åº”
 */
function parseOCRResponse(data: any): OCRResult {
  return {
    plate_number: data.plate_number || '',
    vin: data.vin || '',
    vehicle_type: data.vehicle_type || '',
    owner_name: data.owner_name || '',
    registration_date: data.registration_date || '',
    brand: data.brand || '',
    model: data.model || '',
    confidence: data.confidence || 0
  }
}

/**
 * éªŒè¯OCRç»“æœ
 */
function validateOCRResult(result: OCRResult): void {
  if (!result.plate_number) {
    throw new Error('æœªè¯†åˆ«åˆ°è½¦ç‰Œå·')
  }
  
  if (result.confidence < 0.7) {
    console.warn('[validateOCRResult] è¯†åˆ«ç½®ä¿¡åº¦è¾ƒä½:', result.confidence)
    // å¯ä»¥æç¤ºç”¨æˆ·ç¡®è®¤
  }
}
```

#### 4.1.2 è½¦è¾†åˆ›å»ºå®ç°

**APIå±‚å®ç°** (`src/db/api/vehicles.ts`):

```typescript
import { supabase } from '../supabase'
import type { Vehicle, CreateVehicleInput, ReviewVehicleInput } from '../types'
import { sendVehicleReviewNotification } from '@/services/notificationService'

/**
 * åˆ›å»ºè½¦è¾†è®°å½•
 * 
 * @param data è½¦è¾†ä¿¡æ¯
 * @returns åˆ›å»ºçš„è½¦è¾†è®°å½•
 * @throws å¦‚æœéªŒè¯å¤±è´¥æˆ–åˆ›å»ºå¤±è´¥
 */
export async function createVehicle(
  data: CreateVehicleInput
): Promise<Vehicle> {
  // 1. éªŒè¯è½¦ç‰Œå·æ ¼å¼
  if (!isValidPlateNumber(data.plate_number)) {
    throw new Error('è½¦ç‰Œå·æ ¼å¼ä¸æ­£ç¡®')
  }
  
  // 2. æ£€æŸ¥è½¦ç‰Œå·æ˜¯å¦å·²å­˜åœ¨
  const exists = await checkPlateNumberExists(data.plate_number)
  if (exists) {
    throw new Error('è¯¥è½¦ç‰Œå·å·²å­˜åœ¨')
  }
  
  // 3. éªŒè¯è½¦æ¶å·æ ¼å¼ï¼ˆå¦‚æœæä¾›ï¼‰
  if (data.vin && !isValidVIN(data.vin)) {
    throw new Error('è½¦æ¶å·æ ¼å¼ä¸æ­£ç¡®')
  }
  
  // 4. åˆ›å»ºè½¦è¾†è®°å½•
  const { data: vehicle, error } = await supabase
    .from('vehicles')
    .insert({
      user_id: data.user_id,
      warehouse_id: data.warehouse_id || null,
      plate_number: data.plate_number.toUpperCase(),  // ç»Ÿä¸€å¤§å†™
      vin: data.vin?.toUpperCase() || null,
      vehicle_type: data.vehicle_type || null,
      brand: data.brand || null,
      model: data.model || null,
      color: data.color || null,
      license_image_url: data.license_image_url || null,
      registration_date: data.registration_date || null,
      issue_date: data.issue_date || null,
      owner_name: data.owner_name,
      owner_id_number: data.owner_id_number || null,
      notes: data.notes || null,
      status: 'pending'
    })
    .select()
    .single()
  
  if (error) {
    console.error('[createVehicle] åˆ›å»ºå¤±è´¥:', error)
    throw new Error(`åˆ›å»ºè½¦è¾†å¤±è´¥: ${error.message}`)
  }
  
  // 5. å‘é€å®¡æ ¸é€šçŸ¥
  try {
    await sendVehicleReviewNotification(vehicle)
  } catch (notifyError) {
    console.error('[createVehicle] é€šçŸ¥å‘é€å¤±è´¥:', notifyError)
  }
  
  return vehicle
}

/**
 * éªŒè¯è½¦ç‰Œå·æ ¼å¼
 * æ”¯æŒï¼šæ™®é€šè½¦ç‰Œã€æ–°èƒ½æºè½¦ç‰Œã€å†›ç‰Œç­‰
 */
function isValidPlateNumber(plateNumber: string): boolean {
  // æ™®é€šè½¦ç‰Œï¼šäº¬A12345
  const normalPattern = /^[äº¬æ´¥æ²ªæ¸å†€è±«äº‘è¾½é»‘æ¹˜çš–é²æ–°è‹æµ™èµ£é„‚æ¡‚ç”˜æ™‹è’™é™•å‰é—½è´µç²¤é’è—å·å®ç¼ä½¿é¢†][A-HJ-NP-Z][A-HJ-NP-Z0-9]{5}$/
  
  // æ–°èƒ½æºè½¦ç‰Œï¼šäº¬AD12345
  const newEnergyPattern = /^[äº¬æ´¥æ²ªæ¸å†€è±«äº‘è¾½é»‘æ¹˜çš–é²æ–°è‹æµ™èµ£é„‚æ¡‚ç”˜æ™‹è’™é™•å‰é—½è´µç²¤é’è—å·å®ç¼ä½¿é¢†][A-HJ-NP-Z][A-HJ-NP-Z0-9]{5}[DF]$/
  
  return normalPattern.test(plateNumber) || newEnergyPattern.test(plateNumber)
}

/**
 * éªŒè¯è½¦æ¶å·æ ¼å¼
 * VINç ä¸º17ä½å­—ç¬¦
 */
function isValidVIN(vin: string): boolean {
  return /^[A-HJ-NPR-Z0-9]{17}$/.test(vin)
}

/**
 * æ£€æŸ¥è½¦ç‰Œå·æ˜¯å¦å·²å­˜åœ¨
 */
async function checkPlateNumberExists(plateNumber: string): Promise<boolean> {
  const { data, error } = await supabase
    .from('vehicles')
    .select('id')
    .eq('plate_number', plateNumber.toUpperCase())
    .eq('is_active', true)
    .maybeSingle()
  
  if (error) {
    console.error('[checkPlateNumberExists] æŸ¥è¯¢å¤±è´¥:', error)
    return false
  }
  
  return !!data
}
```

### 4.2 è½¦è¾†å®¡æ ¸

#### 4.2.1 å®¡æ ¸å®ç°

```typescript
/**
 * å®¡æ ¸è½¦è¾†
 * 
 * @param input å®¡æ ¸è¾“å…¥
 * @returns æ˜¯å¦å®¡æ ¸æˆåŠŸ
 */
export async function reviewVehicle(
  input: ReviewVehicleInput
): Promise<boolean> {
  const { vehicle_id, reviewer_id, approved, review_notes } = input
  
  // 1. è·å–è½¦è¾†è¯¦æƒ…
  const { data: vehicle, error: fetchError } = await supabase
    .from('vehicles')
    .select('*')
    .eq('id', vehicle_id)
    .single()
  
  if (fetchError || !vehicle) {
    throw new Error('æœªæ‰¾åˆ°è¯¥è½¦è¾†')
  }
  
  // 2. æ£€æŸ¥è½¦è¾†çŠ¶æ€
  if (vehicle.status !== 'pending') {
    throw new Error('è¯¥è½¦è¾†å·²è¢«å®¡æ ¸ï¼Œæ— æ³•é‡å¤æ“ä½œ')
  }
  
  // 3. æ›´æ–°å®¡æ ¸çŠ¶æ€
  const status = approved ? 'approved' : 'rejected'
  const { error: updateError } = await supabase
    .from('vehicles')
    .update({
      status,
      reviewer_id,
      reviewed_at: new Date().toISOString(),
      review_notes: review_notes || null,
      updated_at: new Date().toISOString()
    })
    .eq('id', vehicle_id)
  
  if (updateError) {
    console.error('[reviewVehicle] æ›´æ–°å¤±è´¥:', updateError)
    throw new Error(`å®¡æ ¸å¤±è´¥: ${updateError.message}`)
  }
  
  // 4. å‘é€å®¡æ ¸ç»“æœé€šçŸ¥
  try {
    await sendVehicleReviewResultNotification({
      vehicleId: vehicle_id,
      userId: vehicle.user_id,
      reviewerId: reviewer_id,
      approved
    })
  } catch (notifyError) {
    console.error('[reviewVehicle] é€šçŸ¥å‘é€å¤±è´¥:', notifyError)
  }
  
  return true
}

/**
 * è·å–å¾…å®¡æ ¸è½¦è¾†åˆ—è¡¨
 * 
 * @param reviewerId å®¡æ‰¹äººID
 * @param role å®¡æ‰¹äººè§’è‰²
 * @returns å¾…å®¡æ ¸è½¦è¾†åˆ—è¡¨
 */
export async function getPendingVehicles(
  reviewerId: string,
  role: UserRole
): Promise<Vehicle[]> {
  let query = supabase
    .from('vehicles')
    .select(`
      *,
      user:users!user_id(id, name, phone),
      warehouse:warehouses(id, name)
    `)
    .eq('status', 'pending')
    .eq('is_active', true)
    .order('created_at', { ascending: false })
  
  // æ ¹æ®è§’è‰²è¿‡æ»¤
  if (role === 'MANAGER') {
    const { data: warehouses } = await supabase
      .from('warehouse_assignments')
      .select('warehouse_id')
      .eq('user_id', reviewerId)
    
    const warehouseIds = warehouses?.map(w => w.warehouse_id) || []
    query = query.in('warehouse_id', warehouseIds)
  }
  
  const { data, error } = await query
  
  if (error) {
    console.error('[getPendingVehicles] æŸ¥è¯¢å¤±è´¥:', error)
    throw error
  }
  
  return data || []
}
```

### 4.3 è½¦è¾†å¹´æ£€ç®¡ç†

#### 4.3.1 å¹´æ£€è®°å½•

```typescript
/**
 * åˆ›å»ºå¹´æ£€è®°å½•
 * 
 * @param data å¹´æ£€æ•°æ®
 * @returns åˆ›å»ºçš„å¹´æ£€è®°å½•
 */
export async function createInspectionRecord(data: {
  vehicle_id: string
  inspection_date: string
  next_inspection_date: string
  inspection_result: InspectionResult
  inspection_location?: string
  certificate_image_url?: string
  notes?: string
}): Promise<VehicleInspection> {
  const { data: record, error } = await supabase
    .from('vehicle_inspections')
    .insert(data)
    .select()
    .single()
  
  if (error) {
    console.error('[createInspectionRecord] åˆ›å»ºå¤±è´¥:', error)
    throw error
  }
  
  return record
}

/**
 * è·å–å³å°†åˆ°æœŸçš„å¹´æ£€è½¦è¾†
 * 
 * @param days æå‰å¤©æ•°ï¼Œé»˜è®¤30å¤©
 * @returns å³å°†åˆ°æœŸçš„è½¦è¾†åˆ—è¡¨
 */
export async function getUpcomingInspections(
  days: number = 30
): Promise<Vehicle[]> {
  const futureDate = new Date()
  futureDate.setDate(futureDate.getDate() + days)
  
  const { data, error } = await supabase
    .from('vehicle_inspections')
    .select(`
      *,
      vehicle:vehicles(*)
    `)
    .lte('next_inspection_date', futureDate.toISOString().split('T')[0])
    .order('next_inspection_date', { ascending: true })
  
  if (error) {
    console.error('[getUpcomingInspections] æŸ¥è¯¢å¤±è´¥:', error)
    throw error
  }
  
  return data?.map(d => d.vehicle) || []
}
```

### 4.4 è½¦è¾†è¿ç« æŸ¥è¯¢

#### 4.4.1 è¿ç« æŸ¥è¯¢å®ç°

```typescript
/**
 * æŸ¥è¯¢è½¦è¾†è¿ç« 
 * è°ƒç”¨ç¬¬ä¸‰æ–¹è¿ç« æŸ¥è¯¢API
 * 
 * @param plateNumber è½¦ç‰Œå·
 * @param vin è½¦æ¶å·å6ä½
 * @returns è¿ç« è®°å½•åˆ—è¡¨
 */
export async function queryViolations(
  plateNumber: string,
  vin: string
): Promise<VehicleViolation[]> {
  try {
    // è°ƒç”¨ç¬¬ä¸‰æ–¹è¿ç« æŸ¥è¯¢API
    const response = await Taro.request({
      url: 'https://api.violation-service.com/query',
      method: 'POST',
      data: {
        plate_number: plateNumber,
        vin_last_6: vin.slice(-6)
      }
    })
    
    const violations = response.data.violations || []
    return violations.map(v => ({
      violation_date: v.date,
      violation_type: v.type,
      violation_location: v.location,
      penalty_points: v.points,
      fine_amount: v.fine,
      is_processed: false
    }))
  } catch (error) {
    console.error('[queryViolations] æŸ¥è¯¢å¤±è´¥:', error)
    throw new Error('è¿ç« æŸ¥è¯¢å¤±è´¥')
  }
}

/**
 * ä¿å­˜è¿ç« è®°å½•
 */
export async function saveViolationRecord(
  vehicleId: string,
  violation: Partial<VehicleViolation>
): Promise<VehicleViolation> {
  const { data, error } = await supabase
    .from('vehicle_violations')
    .insert({
      vehicle_id: vehicleId,
      ...violation
    })
    .select()
    .single()
  
  if (error) {
    console.error('[saveViolationRecord] ä¿å­˜å¤±è´¥:', error)
    throw error
  }
  
  return data
}
```

---

## äº”ã€æƒé™æ§åˆ¶

### 5.1 æƒé™çŸ©é˜µ

| æ“ä½œ | BOSS | PEER_ADMIN | MANAGER | DRIVER |
|------|------|------------|---------|--------|
| æ·»åŠ è½¦è¾† | âœ… | âœ… | âœ… | âœ… |
| æŸ¥çœ‹æ‰€æœ‰è½¦è¾† | âœ… | âœ… | âŒ | âŒ |
| æŸ¥çœ‹ç®¡è¾–è½¦è¾† | âœ… | âœ… | âœ… | âŒ |
| æŸ¥çœ‹è‡ªå·±è½¦è¾† | âœ… | âœ… | âœ… | âœ… |
| å®¡æ ¸è½¦è¾† | âœ… | âœ… | âœ… | âŒ |
| ä¿®æ”¹è½¦è¾†ä¿¡æ¯ | âœ… | âœ… | âœ… | âœ… |
| åˆ é™¤è½¦è¾† | âœ… | âœ… | âœ… | âŒ |
| è¿ç« æŸ¥è¯¢ | âœ… | âœ… | âœ… | âœ… |
| å¹´æ£€ç®¡ç† | âœ… | âœ… | âœ… | âŒ |

### 5.2 æƒé™é…ç½®

```typescript
export const permissionConfig = {
  vehicles: [
    {
      action: PermissionAction.SELECT,
      roles: ['BOSS', 'PEER_ADMIN'],
      allowAll: true
    },
    {
      action: PermissionAction.SELECT,
      roles: ['MANAGER'],
      filter: (userId: string) => ({ warehouse_manager_id: userId })
    },
    {
      action: PermissionAction.SELECT,
      roles: ['DRIVER'],
      filter: (userId: string) => ({ user_id: userId })
    },
    {
      action: PermissionAction.INSERT,
      roles: ['BOSS', 'PEER_ADMIN', 'MANAGER', 'DRIVER'],
      filter: (userId: string) => ({ user_id: userId })
    },
    {
      action: PermissionAction.UPDATE,
      roles: ['BOSS', 'PEER_ADMIN', 'MANAGER'],
      allowAll: true
    }
  ]
}
```

---

## å…­ã€ä¸šåŠ¡è§„åˆ™

### 6.1 æ ¸å¿ƒè§„åˆ™

1. **è½¦ç‰Œå·è§„åˆ™**
   - è½¦ç‰Œå·å¿…é¡»å”¯ä¸€
   - æ”¯æŒæ™®é€šè½¦ç‰Œå’Œæ–°èƒ½æºè½¦ç‰Œ
   - è‡ªåŠ¨è½¬æ¢ä¸ºå¤§å†™

2. **è½¦æ¶å·è§„åˆ™**
   - VINç å¿…é¡»ä¸º17ä½
   - ä¸åŒ…å«å­—æ¯Iã€Oã€Q
   - å¯é€‰å­—æ®µï¼Œä½†å»ºè®®å¡«å†™

3. **å®¡æ ¸è§„åˆ™**
   - æ–°æ·»åŠ çš„è½¦è¾†é»˜è®¤ä¸ºå¾…å®¡æ ¸çŠ¶æ€
   - åªæœ‰å¾…å®¡æ ¸çŠ¶æ€æ‰èƒ½è¿›è¡Œå®¡æ ¸
   - å®¡æ ¸é€šè¿‡åæ‰èƒ½æ­£å¸¸ä½¿ç”¨

4. **å¹´æ£€è§„åˆ™**
   - æ–°è½¦6å¹´å†…å…æ£€ï¼ˆéƒ¨åˆ†è½¦å‹ï¼‰
   - 6-15å¹´æ¯å¹´æ£€éªŒä¸€æ¬¡
   - 15å¹´ä»¥ä¸Šæ¯åŠå¹´æ£€éªŒä¸€æ¬¡

5. **è¿ç« è§„åˆ™**
   - è¿ç« è®°å½•éœ€è¦æ‰‹åŠ¨ç¡®è®¤
   - å¤„ç†åæ ‡è®°ä¸ºå·²å¤„ç†
   - ç½šæ¬¾å’Œæ‰£åˆ†ç»Ÿè®¡

### 6.2 ä¸šåŠ¡çº¦æŸå›¾

```mermaid
graph LR
    A[æ·»åŠ è½¦è¾†] --> B{è½¦ç‰Œå·éªŒè¯}
    B -->|æ ¼å¼é”™è¯¯| C[æ‹’ç»]
    B -->|å·²å­˜åœ¨| C
    B -->|é€šè¿‡| D[åˆ›å»ºè®°å½•]
    
    D --> E[å¾…å®¡æ ¸çŠ¶æ€]
    E --> F{å®¡æ ¸}
    F -->|é€šè¿‡| G[æ¿€æ´»è½¦è¾†]
    F -->|æ‹’ç»| H[é€šçŸ¥ä¿®æ”¹]
    
    G --> I[æ­£å¸¸ä½¿ç”¨]
    I --> J[å¹´æ£€ç®¡ç†]
    I --> K[è¿ç« æŸ¥è¯¢]
```

---

## ä¸ƒã€ç•Œé¢è®¾è®¡

### 7.1 å¸æœºç«¯ - æ·»åŠ è½¦è¾†é¡µé¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â† æ·»åŠ è½¦è¾†                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                 â”‚
â”‚  è¡Œé©¶è¯ç…§ç‰‡                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                           â”‚  â”‚
â”‚  â”‚     ğŸ“· ç‚¹å‡»æ‹æ‘„           â”‚  â”‚
â”‚  â”‚     æˆ–ä»ç›¸å†Œé€‰æ‹©          â”‚  â”‚
â”‚  â”‚                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                 â”‚
â”‚  è½¦ç‰Œå· *                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ äº¬A12345                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                 â”‚
â”‚  è½¦æ¶å·                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ LSGPC52U8ES012345         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                 â”‚
â”‚  è½¦ä¸»å§“å *                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ å¼ ä¸‰                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                 â”‚
â”‚  å“ç‰Œè½¦å‹                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ å¤§ä¼— æœ—é€¸                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                 â”‚
â”‚  è½¦è¾†é¢œè‰²                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ç™½è‰²                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ğŸ” OCRè¯†åˆ«è¡Œé©¶è¯         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚       æäº¤å®¡æ ¸            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.2 ç®¡ç†ç«¯ - è½¦è¾†å®¡æ ¸é¡µé¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è½¦è¾†å®¡æ ¸                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç­›é€‰: â— å¾…å®¡æ ¸  â—‹ å·²å®¡æ ¸       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ äº¬A12345                  â”‚  â”‚
â”‚  â”‚ è½¦ä¸»ï¼šå¼ ä¸‰                â”‚  â”‚
â”‚  â”‚ è½¦å‹ï¼šå¤§ä¼—æœ—é€¸            â”‚  â”‚
â”‚  â”‚ æäº¤æ—¶é—´ï¼š2025-12-11      â”‚  â”‚
â”‚  â”‚                           â”‚  â”‚
â”‚  â”‚ [æŸ¥çœ‹è¯¦æƒ…]                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ äº¬B67890                  â”‚  â”‚
â”‚  â”‚ è½¦ä¸»ï¼šæå››                â”‚  â”‚
â”‚  â”‚ è½¦å‹ï¼šæœ¬ç”°é›…é˜            â”‚  â”‚
â”‚  â”‚ æäº¤æ—¶é—´ï¼š2025-12-10      â”‚  â”‚
â”‚  â”‚                           â”‚  â”‚
â”‚  â”‚ [æŸ¥çœ‹è¯¦æƒ…]                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å®¡æ ¸è¯¦æƒ…å¼¹çª—ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è½¦è¾†å®¡æ ¸è¯¦æƒ…                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  è¡Œé©¶è¯ç…§ç‰‡                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                           â”‚  â”‚
â”‚  â”‚   [è¡Œé©¶è¯å›¾ç‰‡]            â”‚  â”‚
â”‚  â”‚                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                 â”‚
â”‚  è½¦è¾†ä¿¡æ¯                        â”‚
â”‚  è½¦ç‰Œå·ï¼šäº¬A12345               â”‚
â”‚  è½¦æ¶å·ï¼šLSGPC52U8ES012345      â”‚
â”‚  è½¦ä¸»ï¼šå¼ ä¸‰                     â”‚
â”‚  è½¦å‹ï¼šå¤§ä¼—æœ—é€¸                 â”‚
â”‚  é¢œè‰²ï¼šç™½è‰²                     â”‚
â”‚  æ³¨å†Œæ—¥æœŸï¼š2020-05-15           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å®¡æ ¸æ„è§ï¼ˆæ‹’ç»æ—¶å¿…å¡«ï¼‰         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ é€š è¿‡ â”‚  â”‚ æ‹’ ç» â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å…«ã€æ€§èƒ½ä¼˜åŒ–

### 8.1 æ•°æ®åº“ä¼˜åŒ–

#### 8.1.1 ç´¢å¼•ç­–ç•¥

```sql
-- è½¦ç‰Œå·å”¯ä¸€ç´¢å¼•
CREATE UNIQUE INDEX uq_vehicles_plate 
ON vehicles(plate_number) 
WHERE is_active = true;

-- ç”¨æˆ·IDç´¢å¼•
CREATE INDEX idx_vehicles_user 
ON vehicles(user_id);

-- å®¡æ ¸çŠ¶æ€ç´¢å¼•
CREATE INDEX idx_vehicles_status 
ON vehicles(status) 
WHERE is_active = true;

-- å¹´æ£€æ—¥æœŸç´¢å¼•
CREATE INDEX idx_inspections_next_date 
ON vehicle_inspections(next_inspection_date);

-- è¿ç« å¤„ç†çŠ¶æ€ç´¢å¼•
CREATE INDEX idx_violations_processed 
ON vehicle_violations(is_processed);
```

#### 8.1.2 æŸ¥è¯¢ä¼˜åŒ–

```typescript
// ä½¿ç”¨ç‰©åŒ–è§†å›¾ä¼˜åŒ–è½¦è¾†ç»Ÿè®¡
CREATE MATERIALIZED VIEW vehicle_stats AS
SELECT 
  warehouse_id,
  COUNT(*) as total_vehicles,
  COUNT(*) FILTER (WHERE status = 'approved') as approved_vehicles,
  COUNT(*) FILTER (WHERE status = 'pending') as pending_vehicles
FROM vehicles
WHERE is_active = true
GROUP BY warehouse_id;

// å®šæœŸåˆ·æ–°ç‰©åŒ–è§†å›¾
REFRESH MATERIALIZED VIEW vehicle_stats;
```

### 8.2 å›¾ç‰‡å¤„ç†ä¼˜åŒ–

#### 8.2.1 å›¾ç‰‡å‹ç¼©

```typescript
/**
 * å‹ç¼©å¹¶ä¸Šä¼ è¡Œé©¶è¯ç…§ç‰‡
 */
async function uploadLicenseImage(
  imagePath: string
): Promise<string> {
  // 1. å‹ç¼©å›¾ç‰‡
  const { path: compressedPath } = await Taro.compressImage({
    src: imagePath,
    quality: 70,
    compressedWidth: 1200
  })
  
  // 2. ä¸Šä¼ åˆ°äº‘å­˜å‚¨
  const uploadResult = await uploadToCloud(compressedPath)
  
  // 3. è¿”å›URL
  return uploadResult.fileUrl
}
```

#### 8.2.2 OCRç¼“å­˜

```typescript
// ç¼“å­˜OCRè¯†åˆ«ç»“æœï¼Œé¿å…é‡å¤è¯†åˆ«
const ocrCache = new Map<string, OCRResult>()

async function recognizeWithCache(
  imagePath: string
): Promise<OCRResult> {
  const cacheKey = await getImageHash(imagePath)
  
  if (ocrCache.has(cacheKey)) {
    return ocrCache.get(cacheKey)!
  }
  
  const result = await recognizeVehicleLicense(imagePath)
  ocrCache.set(cacheKey, result)
  
  return result
}
```

---

## ä¹ã€æµ‹è¯•ç”¨ä¾‹

### 9.1 å•å…ƒæµ‹è¯•

```typescript
describe('è½¦è¾†ç®¡ç†ç³»ç»Ÿ', () => {
  describe('è½¦ç‰Œå·éªŒè¯', () => {
    it('åº”è¯¥éªŒè¯æ™®é€šè½¦ç‰Œæ ¼å¼', () => {
      expect(isValidPlateNumber('äº¬A12345')).toBe(true)
      expect(isValidPlateNumber('æ²ªB67890')).toBe(true)
    })
    
    it('åº”è¯¥éªŒè¯æ–°èƒ½æºè½¦ç‰Œæ ¼å¼', () => {
      expect(isValidPlateNumber('äº¬AD12345')).toBe(true)
      expect(isValidPlateNumber('æ²ªAF67890')).toBe(true)
    })
    
    it('åº”è¯¥æ‹’ç»é”™è¯¯çš„è½¦ç‰Œå·', () => {
      expect(isValidPlateNumber('äº¬1234')).toBe(false)
      expect(isValidPlateNumber('ABCD1234')).toBe(false)
    })
  })
  
  describe('è½¦æ¶å·éªŒè¯', () => {
    it('åº”è¯¥éªŒè¯17ä½VINç ', () => {
      expect(isValidVIN('LSGPC52U8ES012345')).toBe(true)
    })
    
    it('åº”è¯¥æ‹’ç»åŒ…å«Iã€Oã€Qçš„VINç ', () => {
      expect(isValidVIN('LSGPC52U8ES01234I')).toBe(false)
    })
  })
  
  describe('è½¦è¾†åˆ›å»º', () => {
    it('é‡å¤è½¦ç‰Œå·åº”è¯¥æŠ›å‡ºé”™è¯¯', async () => {
      await expect(
        createVehicle({
          plate_number: 'äº¬A12345',  // å·²å­˜åœ¨
          owner_name: 'å¼ ä¸‰',
          user_id: 'user-id'
        })
      ).rejects.toThrow('è¯¥è½¦ç‰Œå·å·²å­˜åœ¨')
    })
  })
})
```

### 9.2 é›†æˆæµ‹è¯•

```typescript
describe('è½¦è¾†å®¡æ ¸æµç¨‹', () => {
  it('å®Œæ•´çš„å®¡æ ¸æµç¨‹', async () => {
    // 1. åˆ›å»ºè½¦è¾†
    const vehicle = await createVehicle({
      plate_number: 'äº¬A99999',
      owner_name: 'æµ‹è¯•ç”¨æˆ·',
      user_id: 'test-user-id'
    })
    
    expect(vehicle.status).toBe('pending')
    
    // 2. å®¡æ ¸é€šè¿‡
    await reviewVehicle({
      vehicle_id: vehicle.id,
      reviewer_id: 'reviewer-id',
      approved: true,
      review_notes: 'ä¿¡æ¯å‡†ç¡®'
    })
    
    // 3. éªŒè¯çŠ¶æ€
    const { data: updated } = await supabase
      .from('vehicles')
      .select('*')
      .eq('id', vehicle.id)
      .single()
    
    expect(updated.status).toBe('approved')
  })
})
```

---

## åã€å¸¸è§é—®é¢˜

### 10.1 é—®é¢˜æ’æŸ¥

| é—®é¢˜ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|------|---------|
| OCRè¯†åˆ«å¤±è´¥ | ç…§ç‰‡ä¸æ¸…æ™°æˆ–æ ¼å¼ä¸æ”¯æŒ | é‡æ–°æ‹ç…§ï¼Œç¡®ä¿å…‰çº¿å……è¶³ |
| è½¦ç‰Œå·å·²å­˜åœ¨ | é‡å¤æ·»åŠ  | æ£€æŸ¥å·²æœ‰è½¦è¾†åˆ—è¡¨ |
| å®¡æ ¸è¢«æ‹’ç» | ä¿¡æ¯ä¸å‡†ç¡®æˆ–ç…§ç‰‡æ¨¡ç³Š | æ ¹æ®æ‹’ç»åŸå› ä¿®æ”¹åé‡æ–°æäº¤ |
| è¿ç« æŸ¥è¯¢å¤±è´¥ | ç¬¬ä¸‰æ–¹APIå¼‚å¸¸ | ç¨åé‡è¯•æˆ–è”ç³»ç®¡ç†å‘˜ |

### 10.2 æ•°æ®ä¿®å¤

```sql
-- ä¿®å¤è½¦ç‰Œå·æ ¼å¼ï¼ˆç»Ÿä¸€å¤§å†™ï¼‰
UPDATE vehicles
SET plate_number = UPPER(plate_number)
WHERE plate_number != UPPER(plate_number);

-- æ¸…ç†é‡å¤çš„è½¦è¾†è®°å½•
DELETE FROM vehicles
WHERE id NOT IN (
  SELECT MIN(id)
  FROM vehicles
  GROUP BY plate_number
);
```

---

## åä¸€ã€æœªæ¥æ‰©å±•

### 11.1 åŠŸèƒ½æ‰©å±•

1. **æ™ºèƒ½æé†’**
   - å¹´æ£€åˆ°æœŸæé†’
   - ä¿é™©åˆ°æœŸæé†’
   - è¿ç« æœªå¤„ç†æé†’

2. **æ‰¹é‡æ“ä½œ**
   - æ‰¹é‡å¯¼å…¥è½¦è¾†
   - æ‰¹é‡å®¡æ ¸
   - æ‰¹é‡æŸ¥è¯¢è¿ç« 

3. **æ•°æ®åˆ†æ**
   - è½¦è¾†ç»Ÿè®¡æŠ¥è¡¨
   - è¿ç« è¶‹åŠ¿åˆ†æ
   - å¹´æ£€é€šè¿‡ç‡ç»Ÿè®¡

### 11.2 æŠ€æœ¯ä¼˜åŒ–

1. **OCRä¼˜åŒ–**
   - æ”¯æŒæ›´å¤šè¯ä»¶ç±»å‹
   - æé«˜è¯†åˆ«å‡†ç¡®ç‡
   - ç¦»çº¿è¯†åˆ«æ”¯æŒ

2. **æ€§èƒ½ä¼˜åŒ–**
   - å›¾ç‰‡CDNåŠ é€Ÿ
   - æ•°æ®åˆ†é¡µä¼˜åŒ–
   - ç¼“å­˜ç­–ç•¥ä¼˜åŒ–

---

## åäºŒã€æ€»ç»“

è½¦è¾†ç®¡ç†ç³»ç»Ÿæ˜¯è½¦é˜Ÿç®¡å®¶çš„èµ„äº§ç®¡ç†æ ¸å¿ƒï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

### ä¼˜åŠ¿

- âœ… **æ™ºèƒ½è¯†åˆ«**: OCRè‡ªåŠ¨è¯†åˆ«è¡Œé©¶è¯ä¿¡æ¯
- âœ… **ä¸¥æ ¼å®¡æ ¸**: å¤šé‡éªŒè¯ç¡®ä¿ä¿¡æ¯å‡†ç¡®
- âœ… **åˆè§„ç®¡ç†**: å¹´æ£€ã€è¿ç« å…¨æµç¨‹ç®¡ç†
- âœ… **æƒé™å®Œå–„**: åŸºäºè§’è‰²çš„ç»†ç²’åº¦æƒé™æ§åˆ¶
- âœ… **æ€§èƒ½ä¼˜åŒ–**: å›¾ç‰‡å‹ç¼©ã€ç´¢å¼•ä¼˜åŒ–ã€ç¼“å­˜æœºåˆ¶

### æŠ€æœ¯äº®ç‚¹

1. OCRæ™ºèƒ½è¯†åˆ«å¤§å¹…æå‡å½•å…¥æ•ˆç‡
2. è½¦ç‰Œå·å’Œè½¦æ¶å·æ ¼å¼éªŒè¯ç¡®ä¿æ•°æ®å‡†ç¡®
3. å®¡æ ¸æœºåˆ¶ä¿è¯è½¦è¾†ä¿¡æ¯çš„çœŸå®æ€§
4. å¹´æ£€æé†’å’Œè¿ç« æŸ¥è¯¢æå‡åˆè§„æ€§

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0.0  
**åˆ›å»ºæ—¶é—´**: 2025-12-11  
**ç»´æŠ¤äººå‘˜**: ç³»ç»Ÿå¼€å‘å›¢é˜Ÿ  
**çŠ¶æ€**: å·²å‘å¸ƒ
