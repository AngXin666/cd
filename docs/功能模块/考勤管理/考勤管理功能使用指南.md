# è€ƒå‹¤ç®¡ç†åŠŸèƒ½ä½¿ç”¨æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£ä»‹ç»äº†è½¦é˜Ÿç®¡å®¶å°ç¨‹åºä¸­è€ƒå‹¤ç®¡ç†åŠŸèƒ½çš„ä½¿ç”¨æ–¹æ³•ï¼ŒåŒ…æ‹¬æƒé™è®¾è®¡ã€API ä½¿ç”¨å’Œå‰ç«¯é›†æˆã€‚

---

## ğŸ” æƒé™è®¾è®¡

### è§’è‰²æƒé™çŸ©é˜µ

| æ“ä½œ | BOSS | MANAGER | DRIVER |
|-----|------|---------|--------|
| æŸ¥çœ‹æ‰€æœ‰è€ƒå‹¤è®°å½• | âœ… | âœ… | âŒ |
| æŸ¥çœ‹è‡ªå·±çš„è€ƒå‹¤è®°å½• | âœ… | âœ… | âœ… |
| åˆ›å»ºè€ƒå‹¤è®°å½• | âœ… | âœ… | âœ… |
| æ›´æ–°æ‰€æœ‰è€ƒå‹¤è®°å½• | âœ… | âœ… | âŒ |
| æ›´æ–°è‡ªå·±æœªå®Œæˆçš„è€ƒå‹¤ | âœ… | âœ… | âœ… |
| åˆ é™¤è€ƒå‹¤è®°å½• | âœ… | âœ… | âŒ |

### RLS ç­–ç•¥è¯´æ˜

#### attendance è¡¨ç­–ç•¥

1. **new_admins_view_all_attendance** (SELECT)
   - ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹æ‰€æœ‰è€ƒå‹¤è®°å½•
   - è§„åˆ™: `is_admin(auth.uid())`

2. **new_drivers_view_own_attendance** (SELECT)
   - å¸æœºå¯ä»¥æŸ¥çœ‹è‡ªå·±çš„è€ƒå‹¤è®°å½•
   - è§„åˆ™: `user_id = auth.uid()`

3. **new_admins_insert_attendance** (INSERT)
   - ç®¡ç†å‘˜å¯ä»¥åˆ›å»ºè€ƒå‹¤è®°å½•
   - è§„åˆ™: `is_admin(auth.uid())`

4. **new_drivers_insert_own_attendance** (INSERT)
   - å¸æœºå¯ä»¥åˆ›å»ºè‡ªå·±çš„è€ƒå‹¤è®°å½•
   - è§„åˆ™: `user_id = auth.uid()`

5. **new_admins_update_all_attendance** (UPDATE)
   - ç®¡ç†å‘˜å¯ä»¥æ›´æ–°æ‰€æœ‰è€ƒå‹¤è®°å½•
   - è§„åˆ™: `is_admin(auth.uid())`

6. **new_drivers_update_own_attendance** (UPDATE)
   - å¸æœºå¯ä»¥æ›´æ–°è‡ªå·±æœªå®Œæˆçš„è€ƒå‹¤è®°å½•
   - è§„åˆ™: `user_id = auth.uid() AND clock_out_time IS NULL`

7. **new_admins_delete_attendance** (DELETE)
   - ç®¡ç†å‘˜å¯ä»¥åˆ é™¤è€ƒå‹¤è®°å½•
   - è§„åˆ™: `is_admin(auth.uid())`

---

## ğŸ› ï¸ æ•°æ®åº“å‡½æ•°

### 1. æ‰“å¡ä¸Šç­

```sql
clock_in(p_user_id uuid, p_warehouse_id uuid DEFAULT NULL, p_notes text DEFAULT NULL) 
RETURNS uuid
```

**åŠŸèƒ½**: æ‰“å¡ä¸Šç­ï¼Œåˆ›å»ºè€ƒå‹¤è®°å½•

**å‚æ•°**:
- `p_user_id`: ç”¨æˆ· ID
- `p_warehouse_id`: ä»“åº“ IDï¼ˆå¯é€‰ï¼‰
- `p_notes`: å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰

**è¿”å›**: è€ƒå‹¤è®°å½• ID

**å¼‚å¸¸**:
- ä»Šå¤©å·²ç»æ‰“è¿‡å¡äº†

**ç¤ºä¾‹**:
```sql
SELECT clock_in(
  'ç”¨æˆ·ID',
  'ä»“åº“ID',
  'æ­£å¸¸ä¸Šç­'
);
```

---

### 2. æ‰“å¡ä¸‹ç­

```sql
clock_out(p_user_id uuid, p_notes text DEFAULT NULL) 
RETURNS boolean
```

**åŠŸèƒ½**: æ‰“å¡ä¸‹ç­ï¼Œæ›´æ–°è€ƒå‹¤è®°å½•

**å‚æ•°**:
- `p_user_id`: ç”¨æˆ· ID
- `p_notes`: å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰

**è¿”å›**: å¸ƒå°”å€¼ï¼Œtrue è¡¨ç¤ºæˆåŠŸ

**å¼‚å¸¸**:
- ä»Šå¤©è¿˜æ²¡æœ‰æ‰“å¡ä¸Šç­ï¼Œæˆ–è€…å·²ç»æ‰“å¡ä¸‹ç­äº†

**ç¤ºä¾‹**:
```sql
SELECT clock_out(
  'ç”¨æˆ·ID',
  'æ­£å¸¸ä¸‹ç­'
);
```

---

### 3. è·å–ç”¨æˆ·çš„è€ƒå‹¤è®°å½•

```sql
get_user_attendance(p_user_id uuid, p_start_date date DEFAULT NULL, p_end_date date DEFAULT NULL)
RETURNS TABLE (...)
```

**åŠŸèƒ½**: è·å–ç”¨æˆ·çš„è€ƒå‹¤è®°å½•

**å‚æ•°**:
- `p_user_id`: ç”¨æˆ· ID
- `p_start_date`: å¼€å§‹æ—¥æœŸï¼ˆå¯é€‰ï¼‰
- `p_end_date`: ç»“æŸæ—¥æœŸï¼ˆå¯é€‰ï¼‰

**è¿”å›**: è€ƒå‹¤è®°å½•åˆ—è¡¨

**ç¤ºä¾‹**:
```sql
-- è·å–ç”¨æˆ·æœ¬æœˆçš„è€ƒå‹¤è®°å½•
SELECT * FROM get_user_attendance(
  'ç”¨æˆ·ID',
  '2025-12-01',
  '2025-12-31'
);
```

---

### 4. è·å–ç”¨æˆ·ä»Šå¤©çš„è€ƒå‹¤çŠ¶æ€

```sql
get_today_attendance_status(p_user_id uuid)
RETURNS TABLE (has_clocked_in boolean, has_clocked_out boolean, ...)
```

**åŠŸèƒ½**: è·å–ç”¨æˆ·ä»Šå¤©çš„è€ƒå‹¤çŠ¶æ€

**å‚æ•°**:
- `p_user_id`: ç”¨æˆ· ID

**è¿”å›**: ä»Šå¤©çš„è€ƒå‹¤çŠ¶æ€

**ç¤ºä¾‹**:
```sql
SELECT * FROM get_today_attendance_status('ç”¨æˆ·ID');
```

---

### 5. è·å–è€ƒå‹¤ç»Ÿè®¡

```sql
get_attendance_statistics(p_user_id uuid, p_start_date date, p_end_date date)
RETURNS TABLE (total_days integer, present_days integer, ...)
```

**åŠŸèƒ½**: è·å–è€ƒå‹¤ç»Ÿè®¡

**å‚æ•°**:
- `p_user_id`: ç”¨æˆ· ID
- `p_start_date`: å¼€å§‹æ—¥æœŸ
- `p_end_date`: ç»“æŸæ—¥æœŸ

**è¿”å›**: è€ƒå‹¤ç»Ÿè®¡æ•°æ®

**ç¤ºä¾‹**:
```sql
-- è·å–ç”¨æˆ·æœ¬æœˆçš„è€ƒå‹¤ç»Ÿè®¡
SELECT * FROM get_attendance_statistics(
  'ç”¨æˆ·ID',
  '2025-12-01',
  '2025-12-31'
);
```

---

### 6. ç®¡ç†å‘˜è·å–æ‰€æœ‰ç”¨æˆ·çš„è€ƒå‹¤è®°å½•

```sql
get_all_attendance(p_admin_id uuid, p_start_date date DEFAULT NULL, p_end_date date DEFAULT NULL)
RETURNS TABLE (...)
```

**åŠŸèƒ½**: ç®¡ç†å‘˜è·å–æ‰€æœ‰ç”¨æˆ·çš„è€ƒå‹¤è®°å½•

**å‚æ•°**:
- `p_admin_id`: ç®¡ç†å‘˜ ID
- `p_start_date`: å¼€å§‹æ—¥æœŸï¼ˆå¯é€‰ï¼‰
- `p_end_date`: ç»“æŸæ—¥æœŸï¼ˆå¯é€‰ï¼‰

**è¿”å›**: æ‰€æœ‰ç”¨æˆ·çš„è€ƒå‹¤è®°å½•

**å¼‚å¸¸**:
- åªæœ‰ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹æ‰€æœ‰è€ƒå‹¤è®°å½•

**ç¤ºä¾‹**:
```sql
-- è·å–ä»Šå¤©æ‰€æœ‰ç”¨æˆ·çš„è€ƒå‹¤è®°å½•
SELECT * FROM get_all_attendance(
  'ç®¡ç†å‘˜ID',
  CURRENT_DATE,
  CURRENT_DATE
);
```

---

## ğŸ’» å‰ç«¯é›†æˆ

### 1. æ‰“å¡ä¸Šç­

```typescript
import { supabase } from '@/client/supabase';
import Taro from '@tarojs/taro';

async function clockIn(warehouseId?: string, notes?: string) {
  const { data: { user } } = await supabase.auth.getUser();
  
  if (!user) {
    throw new Error('ç”¨æˆ·æœªç™»å½•');
  }
  
  const { data, error } = await supabase
    .rpc('clock_in', {
      p_user_id: user.id,
      p_warehouse_id: warehouseId || null,
      p_notes: notes || null
    });
  
  if (error) {
    throw new Error(`æ‰“å¡å¤±è´¥: ${error.message}`);
  }
  
  return data;
}

// ä½¿ç”¨ç¤ºä¾‹
try {
  const attendanceId = await clockIn('ä»“åº“ID', 'æ­£å¸¸ä¸Šç­');
  console.log('æ‰“å¡æˆåŠŸï¼Œè®°å½•ID:', attendanceId);
  Taro.showToast({
    title: 'æ‰“å¡æˆåŠŸ',
    icon: 'success'
  });
} catch (error) {
  console.error(error);
  Taro.showToast({
    title: error.message,
    icon: 'none'
  });
}
```

---

### 2. æ‰“å¡ä¸‹ç­

```typescript
async function clockOut(notes?: string) {
  const { data: { user } } = await supabase.auth.getUser();
  
  if (!user) {
    throw new Error('ç”¨æˆ·æœªç™»å½•');
  }
  
  const { data, error } = await supabase
    .rpc('clock_out', {
      p_user_id: user.id,
      p_notes: notes || null
    });
  
  if (error) {
    throw new Error(`æ‰“å¡å¤±è´¥: ${error.message}`);
  }
  
  return data;
}

// ä½¿ç”¨ç¤ºä¾‹
try {
  await clockOut('æ­£å¸¸ä¸‹ç­');
  console.log('æ‰“å¡ä¸‹ç­æˆåŠŸ');
  Taro.showToast({
    title: 'æ‰“å¡ä¸‹ç­æˆåŠŸ',
    icon: 'success'
  });
} catch (error) {
  console.error(error);
  Taro.showToast({
    title: error.message,
    icon: 'none'
  });
}
```

---

### 3. è·å–ä»Šå¤©çš„è€ƒå‹¤çŠ¶æ€

```typescript
async function getTodayAttendanceStatus() {
  const { data: { user } } = await supabase.auth.getUser();
  
  if (!user) {
    return null;
  }
  
  const { data, error } = await supabase
    .rpc('get_today_attendance_status', {
      p_user_id: user.id
    });
  
  if (error) {
    console.error('è·å–è€ƒå‹¤çŠ¶æ€å¤±è´¥:', error);
    return null;
  }
  
  return data[0];
}

// ä½¿ç”¨ç¤ºä¾‹
const status = await getTodayAttendanceStatus();
if (status) {
  console.log('ä»Šå¤©æ˜¯å¦å·²æ‰“å¡ä¸Šç­:', status.has_clocked_in);
  console.log('ä»Šå¤©æ˜¯å¦å·²æ‰“å¡ä¸‹ç­:', status.has_clocked_out);
  console.log('ä¸Šç­æ—¶é—´:', status.clock_in_time);
  console.log('ä¸‹ç­æ—¶é—´:', status.clock_out_time);
  console.log('å·¥ä½œæ—¶é•¿:', status.work_hours);
}
```

---

### 4. è·å–ç”¨æˆ·çš„è€ƒå‹¤è®°å½•

```typescript
async function getUserAttendance(startDate?: string, endDate?: string) {
  const { data: { user } } = await supabase.auth.getUser();
  
  if (!user) {
    return [];
  }
  
  const { data, error } = await supabase
    .rpc('get_user_attendance', {
      p_user_id: user.id,
      p_start_date: startDate || null,
      p_end_date: endDate || null
    });
  
  if (error) {
    console.error('è·å–è€ƒå‹¤è®°å½•å¤±è´¥:', error);
    return [];
  }
  
  return data;
}

// ä½¿ç”¨ç¤ºä¾‹
const records = await getUserAttendance('2025-12-01', '2025-12-31');
console.log('æœ¬æœˆè€ƒå‹¤è®°å½•:', records);
```

---

### 5. è·å–è€ƒå‹¤ç»Ÿè®¡

```typescript
async function getAttendanceStatistics(startDate: string, endDate: string) {
  const { data: { user } } = await supabase.auth.getUser();
  
  if (!user) {
    return null;
  }
  
  const { data, error } = await supabase
    .rpc('get_attendance_statistics', {
      p_user_id: user.id,
      p_start_date: startDate,
      p_end_date: endDate
    });
  
  if (error) {
    console.error('è·å–è€ƒå‹¤ç»Ÿè®¡å¤±è´¥:', error);
    return null;
  }
  
  return data[0];
}

// ä½¿ç”¨ç¤ºä¾‹
const stats = await getAttendanceStatistics('2025-12-01', '2025-12-31');
if (stats) {
  console.log('æ€»å¤©æ•°:', stats.total_days);
  console.log('å‡ºå‹¤å¤©æ•°:', stats.present_days);
  console.log('ç¼ºå‹¤å¤©æ•°:', stats.absent_days);
  console.log('æ€»å·¥ä½œæ—¶é•¿:', stats.total_work_hours);
  console.log('å¹³å‡å·¥ä½œæ—¶é•¿:', stats.average_work_hours);
}
```

---

### 6. ç®¡ç†å‘˜è·å–æ‰€æœ‰ç”¨æˆ·çš„è€ƒå‹¤è®°å½•

```typescript
async function getAllAttendance(startDate?: string, endDate?: string) {
  const { data: { user } } = await supabase.auth.getUser();
  
  if (!user) {
    throw new Error('ç”¨æˆ·æœªç™»å½•');
  }
  
  const { data, error } = await supabase
    .rpc('get_all_attendance', {
      p_admin_id: user.id,
      p_start_date: startDate || null,
      p_end_date: endDate || null
    });
  
  if (error) {
    throw new Error(`è·å–è€ƒå‹¤è®°å½•å¤±è´¥: ${error.message}`);
  }
  
  return data;
}

// ä½¿ç”¨ç¤ºä¾‹
try {
  const allRecords = await getAllAttendance('2025-12-01', '2025-12-31');
  console.log('æ‰€æœ‰ç”¨æˆ·çš„è€ƒå‹¤è®°å½•:', allRecords);
} catch (error) {
  console.error(error);
  Taro.showToast({
    title: error.message,
    icon: 'none'
  });
}
```

---

## ğŸ“± å®Œæ•´çš„è€ƒå‹¤ç®¡ç†é¡µé¢ç¤ºä¾‹

### å¸æœºè€ƒå‹¤é¡µé¢

```typescript
import React, { useEffect, useState } from 'react';
import { View, Text, Button } from '@tarojs/components';
import Taro from '@tarojs/taro';
import { supabase } from '@/client/supabase';

interface AttendanceStatus {
  has_clocked_in: boolean;
  has_clocked_out: boolean;
  clock_in_time: string | null;
  clock_out_time: string | null;
  work_hours: number | null;
}

const DriverAttendance: React.FC = () => {
  const [status, setStatus] = useState<AttendanceStatus | null>(null);
  const [loading, setLoading] = useState(true);
  
  useEffect(() => {
    loadTodayStatus();
  }, []);
  
  const loadTodayStatus = async () => {
    try {
      setLoading(true);
      const { data: { user } } = await supabase.auth.getUser();
      
      if (!user) {
        Taro.showToast({
          title: 'è¯·å…ˆç™»å½•',
          icon: 'none'
        });
        return;
      }
      
      const { data, error } = await supabase
        .rpc('get_today_attendance_status', {
          p_user_id: user.id
        });
      
      if (error) throw error;
      
      setStatus(data[0]);
    } catch (error) {
      console.error('åŠ è½½è€ƒå‹¤çŠ¶æ€å¤±è´¥:', error);
      Taro.showToast({
        title: 'åŠ è½½å¤±è´¥',
        icon: 'none'
      });
    } finally {
      setLoading(false);
    }
  };
  
  const handleClockIn = async () => {
    try {
      const { data: { user } } = await supabase.auth.getUser();
      
      if (!user) {
        Taro.showToast({
          title: 'è¯·å…ˆç™»å½•',
          icon: 'none'
        });
        return;
      }
      
      const { error } = await supabase
        .rpc('clock_in', {
          p_user_id: user.id
        });
      
      if (error) throw error;
      
      Taro.showToast({
        title: 'æ‰“å¡æˆåŠŸ',
        icon: 'success'
      });
      
      // é‡æ–°åŠ è½½çŠ¶æ€
      loadTodayStatus();
    } catch (error) {
      console.error('æ‰“å¡å¤±è´¥:', error);
      Taro.showToast({
        title: error.message || 'æ‰“å¡å¤±è´¥',
        icon: 'none'
      });
    }
  };
  
  const handleClockOut = async () => {
    try {
      const { data: { user } } = await supabase.auth.getUser();
      
      if (!user) {
        Taro.showToast({
          title: 'è¯·å…ˆç™»å½•',
          icon: 'none'
        });
        return;
      }
      
      const { error } = await supabase
        .rpc('clock_out', {
          p_user_id: user.id
        });
      
      if (error) throw error;
      
      Taro.showToast({
        title: 'æ‰“å¡ä¸‹ç­æˆåŠŸ',
        icon: 'success'
      });
      
      // é‡æ–°åŠ è½½çŠ¶æ€
      loadTodayStatus();
    } catch (error) {
      console.error('æ‰“å¡ä¸‹ç­å¤±è´¥:', error);
      Taro.showToast({
        title: error.message || 'æ‰“å¡ä¸‹ç­å¤±è´¥',
        icon: 'none'
      });
    }
  };
  
  return (
    <View className="p-4">
      <Text className="text-2xl font-bold mb-4">ä»Šæ—¥è€ƒå‹¤</Text>
      
      {loading ? (
        <Text>åŠ è½½ä¸­...</Text>
      ) : status ? (
        <View className="bg-card p-4 rounded-lg">
          {!status.has_clocked_in ? (
            <View>
              <Text className="text-lg mb-4">ä»Šå¤©è¿˜æ²¡æœ‰æ‰“å¡</Text>
              <Button
                className="w-full bg-primary text-white py-4 rounded"
                onClick={handleClockIn}
              >
                æ‰“å¡ä¸Šç­
              </Button>
            </View>
          ) : !status.has_clocked_out ? (
            <View>
              <Text className="text-lg mb-2">ä¸Šç­æ—¶é—´</Text>
              <Text className="text-muted mb-4">
                {new Date(status.clock_in_time!).toLocaleTimeString()}
              </Text>
              <Button
                className="w-full bg-secondary text-white py-4 rounded"
                onClick={handleClockOut}
              >
                æ‰“å¡ä¸‹ç­
              </Button>
            </View>
          ) : (
            <View>
              <Text className="text-lg mb-2">ä»Šæ—¥è€ƒå‹¤å·²å®Œæˆ</Text>
              <Text className="text-muted">
                ä¸Šç­æ—¶é—´: {new Date(status.clock_in_time!).toLocaleTimeString()}
              </Text>
              <Text className="text-muted">
                ä¸‹ç­æ—¶é—´: {new Date(status.clock_out_time!).toLocaleTimeString()}
              </Text>
              <Text className="text-muted">
                å·¥ä½œæ—¶é•¿: {status.work_hours?.toFixed(2)} å°æ—¶
              </Text>
            </View>
          )}
        </View>
      ) : null}
    </View>
  );
};

export default DriverAttendance;
```

---

### ç®¡ç†å‘˜è€ƒå‹¤ç®¡ç†é¡µé¢

```typescript
import React, { useEffect, useState } from 'react';
import { View, Text } from '@tarojs/components';
import Taro from '@tarojs/taro';
import { supabase } from '@/client/supabase';

interface AttendanceRecord {
  id: string;
  user_name: string;
  warehouse_name: string;
  clock_in_time: string;
  clock_out_time: string | null;
  work_hours: number | null;
  status: string;
}

const AdminAttendance: React.FC = () => {
  const [records, setRecords] = useState<AttendanceRecord[]>([]);
  const [loading, setLoading] = useState(true);
  
  useEffect(() => {
    loadAllAttendance();
  }, []);
  
  const loadAllAttendance = async () => {
    try {
      setLoading(true);
      const { data: { user } } = await supabase.auth.getUser();
      
      if (!user) {
        Taro.showToast({
          title: 'è¯·å…ˆç™»å½•',
          icon: 'none'
        });
        return;
      }
      
      const { data, error } = await supabase
        .rpc('get_all_attendance', {
          p_admin_id: user.id,
          p_start_date: new Date().toISOString().split('T')[0],
          p_end_date: new Date().toISOString().split('T')[0]
        });
      
      if (error) throw error;
      
      setRecords(data || []);
    } catch (error) {
      console.error('åŠ è½½è€ƒå‹¤è®°å½•å¤±è´¥:', error);
      Taro.showToast({
        title: 'åŠ è½½å¤±è´¥',
        icon: 'none'
      });
    } finally {
      setLoading(false);
    }
  };
  
  return (
    <View className="p-4">
      <Text className="text-2xl font-bold mb-4">ä»Šæ—¥è€ƒå‹¤</Text>
      
      {loading ? (
        <Text>åŠ è½½ä¸­...</Text>
      ) : records.length === 0 ? (
        <Text>æš‚æ— è€ƒå‹¤è®°å½•</Text>
      ) : (
        records.map(record => (
          <View key={record.id} className="bg-card p-4 rounded-lg mb-2">
            <Text className="text-lg font-semibold">{record.user_name}</Text>
            <Text className="text-sm text-muted">{record.warehouse_name}</Text>
            <Text className="text-sm">
              ä¸Šç­: {new Date(record.clock_in_time).toLocaleTimeString()}
            </Text>
            {record.clock_out_time && (
              <Text className="text-sm">
                ä¸‹ç­: {new Date(record.clock_out_time).toLocaleTimeString()}
              </Text>
            )}
            {record.work_hours && (
              <Text className="text-sm">
                å·¥ä½œæ—¶é•¿: {record.work_hours.toFixed(2)} å°æ—¶
              </Text>
            )}
          </View>
        ))
      )}
    </View>
  );
};

export default AdminAttendance;
```

---

## ğŸ§ª æµ‹è¯•ç”¨ä¾‹

### æµ‹è¯• 1ï¼šå¸æœºæ‰“å¡ä¸Šç­

```sql
-- å¸æœºæ‰“å¡ä¸Šç­
SELECT clock_in('å¸æœºID', 'ä»“åº“ID', 'æ­£å¸¸ä¸Šç­');

-- é¢„æœŸç»“æœï¼šè¿”å›è€ƒå‹¤è®°å½• ID
```

### æµ‹è¯• 2ï¼šå¸æœºæ‰“å¡ä¸‹ç­

```sql
-- å¸æœºæ‰“å¡ä¸‹ç­
SELECT clock_out('å¸æœºID', 'æ­£å¸¸ä¸‹ç­');

-- é¢„æœŸç»“æœï¼šè¿”å› true
```

### æµ‹è¯• 3ï¼šè·å–ä»Šå¤©çš„è€ƒå‹¤çŠ¶æ€

```sql
-- è·å–ä»Šå¤©çš„è€ƒå‹¤çŠ¶æ€
SELECT * FROM get_today_attendance_status('å¸æœºID');

-- é¢„æœŸç»“æœï¼šè¿”å›ä»Šå¤©çš„è€ƒå‹¤çŠ¶æ€
```

### æµ‹è¯• 4ï¼šè·å–è€ƒå‹¤ç»Ÿè®¡

```sql
-- è·å–æœ¬æœˆçš„è€ƒå‹¤ç»Ÿè®¡
SELECT * FROM get_attendance_statistics(
  'å¸æœºID',
  '2025-12-01',
  '2025-12-31'
);

-- é¢„æœŸç»“æœï¼šè¿”å›è€ƒå‹¤ç»Ÿè®¡æ•°æ®
```

### æµ‹è¯• 5ï¼šç®¡ç†å‘˜æŸ¥çœ‹æ‰€æœ‰è€ƒå‹¤è®°å½•

```sql
-- ç®¡ç†å‘˜æŸ¥çœ‹ä»Šå¤©æ‰€æœ‰è€ƒå‹¤è®°å½•
SELECT * FROM get_all_attendance(
  'ç®¡ç†å‘˜ID',
  CURRENT_DATE,
  CURRENT_DATE
);

-- é¢„æœŸç»“æœï¼šè¿”å›æ‰€æœ‰ç”¨æˆ·çš„è€ƒå‹¤è®°å½•
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æ‰“å¡é™åˆ¶

- æ¯å¤©åªèƒ½æ‰“å¡ä¸Šç­ä¸€æ¬¡
- å¿…é¡»å…ˆæ‰“å¡ä¸Šç­æ‰èƒ½æ‰“å¡ä¸‹ç­
- æ‰“å¡ä¸‹ç­åä¸èƒ½å†æ¬¡æ‰“å¡

### 2. æƒé™æ£€æŸ¥

- å¸æœºåªèƒ½æŸ¥çœ‹å’Œç®¡ç†è‡ªå·±çš„è€ƒå‹¤è®°å½•
- å¸æœºåªèƒ½æ›´æ–°æœªå®Œæˆçš„è€ƒå‹¤è®°å½•ï¼ˆæœªæ‰“å¡ä¸‹ç­ï¼‰
- ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹å’Œç®¡ç†æ‰€æœ‰è€ƒå‹¤è®°å½•

### 3. æ•°æ®å®Œæ•´æ€§

- è€ƒå‹¤è®°å½•å¿…é¡»å…³è”ç”¨æˆ·
- å·¥ä½œæ—¶é•¿è‡ªåŠ¨è®¡ç®—
- è€ƒå‹¤çŠ¶æ€é»˜è®¤ä¸º 'present'

### 4. æ€§èƒ½ä¼˜åŒ–

- å»ºè®®æ·»åŠ ç´¢å¼•ï¼š
  ```sql
  CREATE INDEX IF NOT EXISTS idx_attendance_user_id 
    ON attendance(user_id);
  CREATE INDEX IF NOT EXISTS idx_attendance_work_date 
    ON attendance(work_date);
  CREATE INDEX IF NOT EXISTS idx_attendance_user_date 
    ON attendance(user_id, work_date);
  ```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æƒé™ç³»ç»Ÿé‡æ„å®ŒæˆæŠ¥å‘Š](./æƒé™ç³»ç»Ÿé‡æ„å®ŒæˆæŠ¥å‘Š.md)
- [æƒé™ç³»ç»Ÿæµ‹è¯•æŒ‡å—](./æµ‹è¯•æƒé™ç³»ç»Ÿ.md)
- [æƒé™ç³»ç»Ÿé‡æ„è¯´æ˜](./æƒé™ç³»ç»Ÿé‡æ„è¯´æ˜.md)

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**åˆ›å»ºæ—¶é—´**: 2025-12-01  
**é€‚ç”¨èŒƒå›´**: è½¦é˜Ÿç®¡å®¶å°ç¨‹åºè€ƒå‹¤ç®¡ç†åŠŸèƒ½  
**çŠ¶æ€**: å·²å®Œæˆ
