# 快速测试指南：普通管理员添加司机

## 测试前准备

### 1. 确认账号角色

登录后，在控制台查看当前用户角色：

```javascript
// 在浏览器控制台执行
console.log('当前用户角色:', localStorage.getItem('userRole'))
```

或者在数据库中查询：

```sql
-- 查看所有用户及其角色
SELECT id, name, phone, role FROM profiles ORDER BY role, name;
```

### 2. 准备测试数据

准备一个未使用过的手机号，例如：`13900139999`

## 快速测试步骤

### 测试 1：正常添加司机（最重要）

**步骤**：
1. 使用普通管理员账号登录
2. 进入"司机管理"页面
3. 点击"添加司机"按钮
4. 填写信息：
   - 姓名：测试司机
   - 手机号：13900139999
   - 司机类型：正式司机
5. 点击"添加"按钮

**预期结果**：
- ✅ 显示"添加成功"提示
- ✅ 弹出登录信息对话框，显示：
  - 登录邮箱：13900139999@fleet.com
  - 默认密码：123456
- ✅ 司机列表中显示新添加的司机

**如果失败**：
- 查看浏览器控制台的错误信息
- 查看下面的"常见错误"部分

### 测试 2：重复手机号检测

**步骤**：
1. 使用刚才添加的手机号再次添加司机
2. 点击"添加"按钮

**预期结果**：
- ✅ 显示"添加失败，手机号可能已存在"提示
- ✅ 不创建新记录

### 测试 3：验证登录

**步骤**：
1. 退出当前账号
2. 使用新创建的司机账号登录：
   - 手机号：13900139999
   - 密码：123456
3. 登录成功后，查看界面

**预期结果**：
- ✅ 登录成功
- ✅ 显示司机端界面
- ✅ 可以看到司机工作台

## 常见错误及解决方案

### 错误 1：邮箱重复

**错误信息**：
```
duplicate key value violates unique constraint "users_email_partial_key"
```

**解决方案**：
执行清理函数，删除孤立的 auth.users 记录：

```sql
SELECT * FROM cleanup_orphaned_auth_users();
```

然后重新尝试添加司机。

### 错误 2：RLS 策略错误

**错误信息**：
```
new row violates row-level security policy for table "profiles"
错误代码: 42501
```

**解决方案**：
检查数据库函数的 search_path 是否正确：

```sql
-- 检查 is_manager 函数
SELECT proname, proconfig FROM pg_proc WHERE proname = 'is_manager';
-- 应该显示: ["search_path=public, auth"]

-- 如果不正确，重新执行 migration
-- supabase/migrations/019_fix_is_manager_search_path.sql
```

### 错误 3：权限不足

**错误信息**：
```
relation "public.auth.users" does not exist
```

**解决方案**：
这个错误已经在最新代码中修复。确保使用最新的代码：

```bash
git pull origin master
```

### 错误 4：外键约束错误

**错误信息**：
```
insert or update on table "profiles" violates foreign key constraint "profiles_id_fkey"
```

**解决方案**：
这个错误已经在最新代码中修复（先创建 auth.users，再创建 profiles）。确保使用最新的代码。

## 数据验证

### 验证记录完整性

```sql
-- 验证新创建的司机记录
SELECT 
  au.id as auth_id,
  p.id as profile_id,
  au.email,
  p.phone,
  p.name,
  p.role,
  p.driver_type,
  au.id = p.id as ids_match
FROM auth.users au
JOIN profiles p ON au.id = p.id
WHERE p.phone = '13900139999';

-- 预期结果：
-- - auth_id 和 profile_id 相同
-- - ids_match: true
-- - role: driver
-- - driver_type: 正式司机
```

### 检查孤立记录

```sql
-- 检查是否有孤立的 auth.users 记录
SELECT COUNT(*) as orphaned_count
FROM auth.users au
LEFT JOIN profiles p ON au.id = p.id
WHERE p.id IS NULL;

-- 预期结果：0（没有孤立记录）
```

## 性能测试

### 批量添加测试

**步骤**：
1. 连续添加 10 个司机
2. 观察响应时间和成功率

**预期结果**：
- ✅ 所有司机都创建成功
- ✅ 每次创建时间 < 2 秒
- ✅ 没有错误提示

## 回滚测试数据

如果需要清理测试数据：

```sql
-- 删除测试司机（谨慎操作！）
DELETE FROM profiles WHERE phone = '13900139999';
-- 注意：由于外键约束，auth.users 记录会自动删除
```

## 总结

如果以上所有测试都通过，说明普通管理员添加司机功能已经完全修复！

**关键检查点**：
- ✅ 可以成功添加司机
- ✅ 显示登录信息
- ✅ 重复手机号检测有效
- ✅ 新司机可以登录
- ✅ 没有错误提示

**如果还有问题**：
1. 查看详细文档：`docs/普通管理员添加司机功能完整修复总结.md`
2. 查看错误修复文档：
   - `docs/修复邮箱重复错误.md`
   - `docs/修复RLS策略错误.md`
3. 查看修复记录：`docs/修复记录_普通管理员添加司机.md`
