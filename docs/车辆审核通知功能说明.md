# 车辆审核通知功能说明

## 功能概述

车辆审核通知系统为车辆信息审核流程提供了完善的通知机制，确保相关人员能够及时了解审核状态变化。

## 通知触发场景

### 1. 司机提交审核（pending_review）

**触发条件**：
- 司机完成车辆信息录入并提交审核
- 车辆审核状态从其他状态变更为 `pending_review`

**通知对象**：
- 所有普通管理员（role = 'manager'）
- 所有超级管理员（role = 'super_admin'）

**通知内容**：
- 标题：`新车辆待审核`
- 消息：`司机 [司机姓名] 提交了车辆 [车牌号] 的审核申请`

### 2. 审核通过（approved）

**触发条件**：
- 管理员或超级管理员审核通过车辆信息
- 车辆审核状态变更为 `approved`

**通知对象**：
1. **司机本人**
   - 标题：`车辆审核已通过`
   - 消息：`您的车辆 [车牌号] 已通过审核`

2. **其他管理员**（根据审核人角色）：
   - **普通管理员审核**：额外通知所有超级管理员
     - 标题：`车辆审核动态`
     - 消息：`管理员已通过车辆 [车牌号] 的审核`
   
   - **超级管理员审核**：额外通知管辖该仓库的普通管理员
     - 标题：`车辆审核动态`
     - 消息：`超级管理员已通过车辆 [车牌号] 的审核`

### 3. 需补录（need_supplement）

**触发条件**：
- 管理员或超级管理员要求司机补录车辆信息
- 车辆审核状态变更为 `need_supplement`

**通知对象**：
- 仅通知司机本人

**通知内容**：
- 标题：`车辆信息需补录`
- 消息：`您的车辆 [车牌号] 需要补录信息，请重新提交。原因：[审核备注]`

**注意**：需补录时不通知管理员，待司机重新提交后再次触发审核通知。

## 通知显示规则

### 司机端

| 审核状态 | 通知标题 | 通知消息 | 图标 |
|---------|---------|---------|------|
| 审核通过 | 车辆审核已通过 | 您的车辆 [车牌号] 已通过审核 | ✅ 绿色对勾 |
| 需补录 | 车辆信息需补录 | 您的车辆 [车牌号] 需要补录信息，请重新提交。原因：[审核备注] | ⚠️ 红色警告 |

### 管理员端

| 通知类型 | 通知标题 | 通知消息 | 图标 |
|---------|---------|---------|------|
| 新审核任务 | 新车辆待审核 | 司机 [司机姓名] 提交了车辆 [车牌号] 的审核申请 | 🕐 橙色时钟 |
| 审核动态 | 车辆审核动态 | 管理员/超级管理员已通过车辆 [车牌号] 的审核 | ✅ 绿色对勾 |

## 技术实现

### 数据库触发器

通知系统使用 PostgreSQL 触发器自动发送通知：

```sql
-- 触发器函数
CREATE OR REPLACE FUNCTION send_vehicle_review_notifications()
RETURNS TRIGGER
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
-- 函数实现...
$$;

-- 触发器
CREATE TRIGGER trigger_vehicle_review_notifications
AFTER INSERT OR UPDATE OF review_status
ON vehicles
FOR EACH ROW
EXECUTE FUNCTION send_vehicle_review_notifications();
```

### 通知 API

提供了完整的通知管理 API：

- `getUserNotifications(userId, limit)` - 获取用户通知列表
- `getUnreadNotificationCount(userId)` - 获取未读通知数量
- `markNotificationAsRead(notificationId)` - 标记通知为已读
- `markAllNotificationsAsRead(userId)` - 标记所有通知为已读
- `deleteNotification(notificationId)` - 删除通知
- `deleteReadNotifications(userId)` - 删除所有已读通知
- `subscribeToNotifications(userId, callback)` - 订阅实时通知更新

### 实时推送

使用 Supabase Realtime 实现通知的实时推送：

```typescript
const channel = supabase
  .channel(`notifications:${userId}`)
  .on('postgres_changes', {
    event: 'INSERT',
    schema: 'public',
    table: 'notifications',
    filter: `user_id=eq.${userId}`
  }, (payload) => {
    callback(payload.new as Notification)
  })
  .subscribe()
```

## 使用组件

### NotificationBell 组件

通知铃铛组件，显示未读通知数量：

```tsx
import NotificationBell from '@/components/notification/NotificationBell'

<NotificationBell userId={user.id} className="mr-4" />
```

**功能**：
- 显示未读通知数量徽章
- 点击跳转到通知列表页面
- 实时更新未读数量

### NotificationsPage 页面

通知列表页面，支持查看、标记、删除通知：

**路由**：`/pages/common/notifications/index`

**功能**：
- 显示所有通知列表
- 区分已读/未读状态
- 点击通知跳转到相关页面
- 全部标记为已读
- 清空已读通知
- 删除单个通知
- 实时接收新通知

## 测试场景

### 场景 1：司机提交审核

1. 使用司机账号登录
2. 进入车辆管理页面
3. 添加新车辆并提交审核
4. 切换到管理员账号
5. 查看通知中心，应该收到"新车辆待审核"通知

### 场景 2：管理员审核通过

1. 使用管理员账号登录
2. 进入车辆审核页面
3. 审核通过某个车辆
4. 切换到司机账号
5. 查看通知中心，应该收到"车辆审核已通过"通知
6. 切换到超级管理员账号
7. 查看通知中心，应该收到"车辆审核动态"通知

### 场景 3：超级管理员审核通过

1. 使用超级管理员账号登录
2. 进入车辆审核页面
3. 审核通过某个车辆
4. 切换到司机账号
5. 查看通知中心，应该收到"车辆审核已通过"通知
6. 切换到该仓库的管理员账号
7. 查看通知中心，应该收到"车辆审核动态"通知

### 场景 4：需补录

1. 使用管理员账号登录
2. 进入车辆审核页面
3. 标记某个车辆为"需补录"，填写审核备注
4. 切换到司机账号
5. 查看通知中心，应该收到"车辆信息需补录"通知
6. 管理员账号不应收到通知

## 注意事项

1. **通知去重**：同一审核状态变更只触发一次通知
2. **权限控制**：通知只发送给有权限查看的用户
3. **实时性**：使用 WebSocket 实现实时推送，无需刷新页面
4. **性能优化**：使用数据库触发器，避免应用层轮询
5. **错误处理**：通知发送失败不影响审核流程

## 数据库表结构

### notifications 表

| 字段 | 类型 | 说明 |
|------|------|------|
| id | uuid | 主键 |
| user_id | uuid | 接收通知的用户ID |
| type | notification_type | 通知类型 |
| title | text | 通知标题 |
| message | text | 通知消息 |
| related_id | uuid | 关联的车辆ID |
| is_read | boolean | 是否已读 |
| created_at | timestamptz | 创建时间 |

### notification_type 枚举

- `vehicle_review_pending` - 车辆待审核
- `vehicle_review_approved` - 车辆审核通过
- `vehicle_review_need_supplement` - 车辆需补录

## 相关文件

- 数据库迁移：
  - `/supabase/migrations/00037_create_notifications_system.sql` - 通知系统表结构
  - `/supabase/migrations/00039_add_vehicle_review_fields.sql` - 车辆审核字段
  - `/supabase/migrations/00038_create_vehicle_review_notification_triggers.sql` - 通知触发器

- API 文件：
  - `/src/db/notificationApi.ts` - 通知管理 API

- 组件文件：
  - `/src/components/notification/NotificationBell.tsx` - 通知铃铛组件
  - `/src/pages/common/notifications/index.tsx` - 通知列表页面
