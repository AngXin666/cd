# 超级管理员审批权限优化说明

## 功能概述

优化了超级管理员的请假和离职审批权限逻辑，实现了更合理的权限分层管理。当仓库已经分配了管理员时，超级管理员将不再显示审批按钮，由仓库管理员负责审批该仓库司机的请假和离职申请。

## 业务逻辑

### 权限分层原则

1. **仓库未分配管理员**
   - 超级管理员负责审批该仓库司机的所有请假和离职申请
   - 显示审批按钮（通过/驳回）

2. **仓库已分配管理员**
   - 由仓库管理员负责审批该仓库司机的请假和离职申请
   - 超级管理员不显示审批按钮
   - 超级管理员仍可查看申请详情和审批状态

### 适用场景

此优化适用于以下两个审批场景：

1. **请假申请审批**
   - 司机提交的请假申请
   - 根据申请所属仓库是否有管理员决定审批权限

2. **离职申请审批**
   - 司机提交的离职申请
   - 根据申请所属仓库是否有管理员决定审批权限

## 技术实现

### 数据结构

**warehouseHasManager 状态**
```typescript
const [warehouseHasManager, setWarehouseHasManager] = useState<Record<string, boolean>>({})
```
- 键：仓库ID
- 值：该仓库是否有管理员（true/false）

### 核心逻辑

#### 1. 加载仓库管理员信息

在 `loadData` 函数中，当用户是超级管理员时：

```typescript
// 如果是超级管理员，检查每个仓库是否有管理员
if (userProfile?.role === 'super_admin') {
  const warehouseManagerStatus: Record<string, boolean> = {}
  
  // 获取所有涉及的仓库ID
  const warehouseIds = new Set<string>()
  driverLeaveApps.forEach((app) => {
    if (app.warehouse_id) warehouseIds.add(app.warehouse_id)
  })
  driverResignationApps.forEach((app) => {
    if (app.warehouse_id) warehouseIds.add(app.warehouse_id)
  })

  // 检查每个仓库是否有管理员
  for (const warehouseId of warehouseIds) {
    const managers = await getWarehouseManagers(warehouseId)
    warehouseManagerStatus[warehouseId] = managers.length > 0
  }

  setWarehouseHasManager(warehouseManagerStatus)
}
```

**实现要点**：
- 只在超级管理员登录时执行检查
- 收集所有涉及的仓库ID（请假和离职申请）
- 使用 `getWarehouseManagers` API 检查每个仓库的管理员
- 将结果存储在 `warehouseHasManager` 状态中

#### 2. 条件显示审批按钮

**请假申请审批按钮**：
```typescript
{app.status === 'pending' && 
  // 超级管理员：如果仓库已分配管理员则隐藏审批按钮
  !(currentUserProfile?.role === 'super_admin' && app.warehouse_id && warehouseHasManager[app.warehouse_id]) && (
  <View className="flex gap-2">
    <Button onClick={() => handleApproveLeave(app.id)}>通过</Button>
    <Button onClick={() => handleRejectLeave(app.id)}>驳回</Button>
  </View>
)}
```

**离职申请审批按钮**：
```typescript
{app.status === 'pending' && 
  // 超级管理员：如果仓库已分配管理员则隐藏审批按钮
  !(currentUserProfile?.role === 'super_admin' && app.warehouse_id && warehouseHasManager[app.warehouse_id]) && (
  <View className="flex gap-2">
    <Button onClick={() => handleApproveResignation(app.id)}>通过</Button>
    <Button onClick={() => handleRejectResignation(app.id)}>驳回</Button>
  </View>
)}
```

**显示条件**：
1. 申请状态为待审批（`app.status === 'pending'`）
2. 且不满足以下所有条件：
   - 当前用户是超级管理员
   - 申请有关联的仓库ID
   - 该仓库已分配管理员

### 使用的API

**getWarehouseManagers(warehouseId: string)**
- 功能：获取指定仓库的管理员列表
- 参数：仓库ID
- 返回：管理员Profile数组
- 位置：`src/db/api.ts`

```typescript
export async function getWarehouseManagers(warehouseId: string): Promise<Profile[]> {
  const {data, error} = await supabase
    .from('manager_warehouses')
    .select('manager_id')
    .eq('warehouse_id', warehouseId)

  if (error || !data || data.length === 0) {
    return []
  }

  const managerIds = data.map((item) => item.manager_id)
  const {data: managers, error: managerError} = await supabase
    .from('profiles')
    .select('*')
    .in('id', managerIds)
    .order('name', {ascending: true})

  return Array.isArray(managers) ? managers : []
}
```

## 用户体验

### 超级管理员视角

**场景1：仓库未分配管理员**
1. 进入司机请假详情页面
2. 看到待审批的请假/离职申请
3. 显示"通过"和"驳回"按钮
4. 可以直接审批

**场景2：仓库已分配管理员**
1. 进入司机请假详情页面
2. 看到待审批的请假/离职申请
3. 不显示审批按钮
4. 只能查看申请详情
5. 由仓库管理员负责审批

### 仓库管理员视角

**不受影响**
- 仓库管理员的审批权限不变
- 仍然可以审批所管辖仓库的所有请假和离职申请
- 审批流程保持不变

## 优势分析

### 1. 权限分层更清晰

**明确职责**：
- 超级管理员：负责未分配管理员的仓库
- 仓库管理员：负责所管辖的仓库
- 避免权限重叠和混乱

### 2. 提高管理效率

**减少审批负担**：
- 超级管理员不需要审批所有申请
- 仓库管理员可以更快速地处理本仓库的申请
- 审批流程更加高效

### 3. 符合管理层级

**组织架构对应**：
- 仓库管理员直接管理司机
- 超级管理员负责整体协调
- 权限设置符合实际管理层级

### 4. 灵活性强

**动态调整**：
- 仓库分配管理员后，审批权限自动转移
- 仓库取消管理员后，审批权限自动回归超级管理员
- 无需手动调整权限设置

## 边界情况处理

### 1. 仓库ID为空

**情况**：申请没有关联仓库ID
**处理**：显示审批按钮（超级管理员可以审批）
**原因**：没有仓库信息，无法判断是否有管理员

### 2. 管理员数据未加载

**情况**：`warehouseHasManager` 中没有该仓库的数据
**处理**：显示审批按钮（默认为false）
**原因**：数据未加载时，保持原有功能可用

### 3. 多个管理员

**情况**：一个仓库分配了多个管理员
**处理**：只要有一个管理员，就隐藏超级管理员的审批按钮
**原因**：有管理员负责即可

### 4. 管理员变更

**情况**：仓库管理员被添加或移除
**处理**：页面重新加载时自动更新审批按钮显示
**原因**：使用 `useDidShow` 钩子，页面显示时重新加载数据

## 测试建议

### 功能测试

**测试用例1：仓库未分配管理员**
1. 以超级管理员身份登录
2. 进入未分配管理员的仓库司机详情页
3. 验证待审批申请显示审批按钮
4. 验证可以成功审批

**测试用例2：仓库已分配管理员**
1. 以超级管理员身份登录
2. 进入已分配管理员的仓库司机详情页
3. 验证待审批申请不显示审批按钮
4. 验证可以查看申请详情

**测试用例3：管理员变更**
1. 以超级管理员身份登录
2. 为仓库分配管理员
3. 返回司机详情页
4. 验证审批按钮消失

**测试用例4：仓库管理员审批**
1. 以仓库管理员身份登录
2. 进入所管辖仓库司机详情页
3. 验证显示审批按钮
4. 验证可以成功审批

### 权限测试

**测试用例5：跨仓库权限**
1. 以超级管理员身份登录
2. 查看不同仓库的司机申请
3. 验证审批按钮显示符合预期

**测试用例6：已审批申请**
1. 以超级管理员身份登录
2. 查看已审批的申请
3. 验证不显示审批按钮（无论仓库是否有管理员）

### 数据一致性测试

**测试用例7：数据加载**
1. 以超级管理员身份登录
2. 进入司机详情页
3. 验证仓库管理员信息正确加载
4. 验证审批按钮显示正确

**测试用例8：页面刷新**
1. 以超级管理员身份登录
2. 进入司机详情页
3. 切换到其他页面再返回
4. 验证数据重新加载，审批按钮显示正确

## 未来扩展

### 可能的优化方向

1. **审批权限提示**
   - 当超级管理员看不到审批按钮时
   - 显示提示信息："该仓库已分配管理员，由管理员负责审批"
   - 提升用户体验

2. **审批历史记录**
   - 记录审批权限变更历史
   - 显示是哪个管理员审批的
   - 便于追溯和审计

3. **紧急审批权限**
   - 超级管理员可以开启"紧急审批模式"
   - 在特殊情况下可以审批所有申请
   - 需要记录紧急审批原因

4. **审批权限配置**
   - 在系统设置中配置审批权限规则
   - 支持更灵活的权限分配
   - 适应不同的管理模式

## 相关文件

### 修改的文件

**src/pages/super-admin/driver-leave-detail/index.tsx**
- 添加 `warehouseHasManager` 状态
- 添加 `currentUserProfile` 状态
- 修改 `loadData` 函数，加载仓库管理员信息
- 修改请假申请审批按钮显示条件
- 修改离职申请审批按钮显示条件

### 使用的API

**src/db/api.ts**
- `getWarehouseManagers(warehouseId: string)` - 获取仓库管理员列表

### 相关数据表

**manager_warehouses**
- 存储管理员和仓库的关联关系
- 用于判断仓库是否有管理员

**profiles**
- 存储用户信息
- 包含用户角色信息

## 总结

此次优化实现了更合理的审批权限分层管理，明确了超级管理员和仓库管理员的职责边界。通过动态检查仓库是否有管理员，自动调整审批按钮的显示，提高了管理效率，符合实际的管理层级结构。

**核心价值**：
- ✅ 权限分层更清晰
- ✅ 管理效率更高
- ✅ 符合组织架构
- ✅ 灵活性强
- ✅ 用户体验好

**实现方式**：
- ✅ 使用现有API
- ✅ 最小化代码修改
- ✅ 保持向后兼容
- ✅ 性能影响小
- ✅ 易于维护
