# 通知系统跳转逻辑优化

## 需求描述

### 问题 1：审批后通知栏显示问题
**当前问题**：
- 当请假申请或离职申请被普通管理员审批后
- 超级管理员端的通知栏还继续显示待审批信息
- 这是不对的，应该显示审批结果

**期望行为**：
- 审批后，通知栏应该显示审批结果（已批准/已拒绝）
- 而不是继续显示待审批信息

### 问题 2：通知栏跳转逻辑问题
**当前问题**：
- 普通管理员和超级管理员点击通知栏时
- 直接跳转到审批界面
- 这不符合用户体验

**期望行为**：
- 点击通知栏应该跳转到通知中心
- 从通知中心点击具体通知再跳转到审批界面

## 实现方案

### 1. 修改通知栏跳转逻辑

#### 修改前
```typescript
// 根据通知类型进行智能跳转
const notificationType = currentNotification.type
const relatedId = currentNotification.related_id
const userRole = userProfile?.role || 'driver'

// 确定跳转路径前缀（根据用户角色）
const pathPrefix = userRole === 'super_admin' ? '/pages/super-admin' : '/pages/manager'

// 请假申请相关通知 - 跳转到考勤管理页面
if (
  notificationType === 'leave_application_submitted' ||
  notificationType === 'leave_approved' ||
  notificationType === 'leave_rejected'
) {
  // ... 复杂的跳转逻辑
  Taro.navigateTo({
    url: `${pathPrefix}/leave-approval/index?tab=pending&warehouseId=${leaveApp.warehouse_id}`
  })
  return
}

// 离职申请相关通知 - 跳转到考勤管理页面
if (
  notificationType === 'resignation_application_submitted' ||
  notificationType === 'resignation_approved' ||
  notificationType === 'resignation_rejected'
) {
  // ... 复杂的跳转逻辑
  Taro.navigateTo({
    url: `${pathPrefix}/leave-approval/index?tab=pending&warehouseId=${resignationApp.warehouse_id}`
  })
  return
}

// 其他通知 - 跳转到通知中心
Taro.navigateTo({url: '/pages/common/notifications/index'})
```

**问题**：
- ❌ 逻辑复杂，需要根据通知类型判断
- ❌ 直接跳转到审批界面，跳过通知中心
- ❌ 用户无法查看完整的通知列表

#### 修改后
```typescript
// 点击通知栏
const handleClick = async () => {
  // 标记为已读
  const success = await markNotificationAsRead(currentNotification.id)
  if (success) {
    logger.info('通知已标记为已读', {notificationId: currentNotification.id})
    // 从列表中移除已读通知
    setNotifications((prev) => prev.filter((n) => n.id !== currentNotification.id))
    // 重置索引
    setCurrentIndex(0)
    setScrollCount(0)
  }

  // 所有用户点击通知栏都跳转到通知中心
  // 从通知中心可以再跳转到具体的审批界面
  Taro.navigateTo({url: '/pages/common/notifications/index'})
}
```

**改进**：
- ✅ 逻辑简化，统一跳转到通知中心
- ✅ 用户可以查看完整的通知列表
- ✅ 从通知中心再跳转到具体页面，流程更清晰

### 2. 优化通知中心跳转逻辑

#### 修改前
```typescript
case 'leave_application_submitted':
case 'resignation_application_submitted': {
  // 获取用户角色，根据角色跳转到不同的审批页面
  const userRole = await getCurrentUserRole()
  if (userRole === 'super_admin') {
    // 超级管理员跳转到超级管理员的考勤管理页面（待审批标签）
    Taro.navigateTo({
      url: `/pages/super-admin/leave-approval/index?tab=pending`
    })
  } else {
    // 普通管理员跳转到普通管理员的考勤管理页面（待审批标签）
    Taro.navigateTo({
      url: `/pages/manager/leave-approval/index?tab=pending`
    })
  }
  break
}
```

**问题**：
- ❌ 只处理了提交通知，没有处理审批结果通知
- ❌ 没有携带仓库ID参数
- ❌ 没有根据申请状态切换到对应的标签页

#### 修改后
```typescript
case 'leave_application_submitted':
case 'leave_approved':
case 'leave_rejected':
case 'resignation_application_submitted':
case 'resignation_approved':
case 'resignation_rejected': {
  // 获取用户角色，根据角色跳转到不同的审批页面
  const userRole = await getCurrentUserRole()
  const pathPrefix = userRole === 'super_admin' ? '/pages/super-admin' : '/pages/manager'

  // 根据通知类型确定要查询的表
  const isLeaveNotification =
    notification.type === 'leave_application_submitted' ||
    notification.type === 'leave_approved' ||
    notification.type === 'leave_rejected'
  const tableName = isLeaveNotification ? 'leave_applications' : 'resignation_applications'

  try {
    // 获取申请的仓库ID和状态
    const {data: application} = await supabase
      .from(tableName)
      .select('warehouse_id, status')
      .eq('id', notification.related_id)
      .maybeSingle()

    if (application?.warehouse_id) {
      // 根据申请状态确定要跳转的标签
      let tab = 'pending' // 默认待审核
      if (application.status === 'approved') {
        tab = 'approved' // 已批准
      } else if (application.status === 'rejected') {
        tab = 'rejected' // 已拒绝
      }

      // 跳转到考勤管理页面，并切换到对应标签和仓库
      Taro.navigateTo({
        url: `${pathPrefix}/leave-approval/index?tab=${tab}&warehouseId=${application.warehouse_id}`
      })
      return
    }
  } catch (error) {
    logger.error('获取申请信息失败', error)
  }

  // 如果获取失败，跳转到考勤管理页面（不指定仓库）
  Taro.navigateTo({
    url: `${pathPrefix}/leave-approval/index?tab=pending`
  })
  break
}
```

**改进**：
- ✅ 处理所有类型的请假/离职通知（提交、批准、拒绝）
- ✅ 携带仓库ID参数，自动切换到对应仓库
- ✅ 根据申请状态切换到对应的标签页
- ✅ 用户体验更好，直接定位到相关申请

## 功能特性

### 1. 统一的通知栏跳转

**所有用户**（司机、普通管理员、超级管理员）点击通知栏时：
- ✅ 统一跳转到通知中心
- ✅ 标记通知为已读
- ✅ 从通知栏移除已读通知

### 2. 智能的通知中心跳转

从通知中心点击具体通知时：

#### 请假申请通知
- **提交通知** (`leave_application_submitted`)
  - 跳转到考勤管理页面
  - 切换到"待审核"标签
  - 自动切换到对应仓库

- **批准通知** (`leave_approved`)
  - 跳转到考勤管理页面
  - 切换到"已批准"标签
  - 自动切换到对应仓库

- **拒绝通知** (`leave_rejected`)
  - 跳转到考勤管理页面
  - 切换到"已拒绝"标签
  - 自动切换到对应仓库

#### 离职申请通知
- **提交通知** (`resignation_application_submitted`)
  - 跳转到考勤管理页面
  - 切换到"待审核"标签
  - 自动切换到对应仓库

- **批准通知** (`resignation_approved`)
  - 跳转到考勤管理页面
  - 切换到"已批准"标签
  - 自动切换到对应仓库

- **拒绝通知** (`resignation_rejected`)
  - 跳转到考勤管理页面
  - 切换到"已拒绝"标签
  - 自动切换到对应仓库

### 3. 角色适配

根据用户角色自动选择正确的页面路径：
- **超级管理员**：`/pages/super-admin/leave-approval/index`
- **普通管理员**：`/pages/manager/leave-approval/index`

## 用户体验流程

### 流程 1：管理员查看待审批通知

1. **通知栏显示**
   - 司机提交请假申请
   - 管理员看到通知栏显示："司机张三提交了请假申请"

2. **点击通知栏**
   - 管理员点击通知栏
   - 跳转到通知中心

3. **查看通知列表**
   - 通知中心显示所有通知
   - 可以看到完整的通知详情

4. **点击具体通知**
   - 点击"司机张三提交了请假申请"
   - 跳转到考勤管理页面
   - 自动切换到"待审核"标签
   - 自动切换到对应仓库
   - 可以直接审批

### 流程 2：管理员查看审批结果通知

1. **通知栏显示**
   - 普通管理员审批了请假申请
   - 超级管理员看到通知栏显示："管理员李四批准了司机张三的请假申请"

2. **点击通知栏**
   - 超级管理员点击通知栏
   - 跳转到通知中心

3. **查看通知列表**
   - 通知中心显示所有通知
   - 可以看到审批结果通知

4. **点击具体通知**
   - 点击"管理员李四批准了司机张三的请假申请"
   - 跳转到考勤管理页面
   - 自动切换到"已批准"标签
   - 自动切换到对应仓库
   - 可以查看审批详情

## 测试场景

### 场景 1：管理员点击通知栏

1. 登录管理员账号
2. 司机提交请假申请
3. 通知栏显示待审批通知
4. 点击通知栏
5. **预期结果**：
   - ✅ 跳转到通知中心
   - ✅ 通知被标记为已读
   - ✅ 通知从通知栏移除

### 场景 2：从通知中心点击待审批通知

1. 登录管理员账号
2. 进入通知中心
3. 点击"司机张三提交了请假申请"
4. **预期结果**：
   - ✅ 跳转到考勤管理页面
   - ✅ 切换到"待审核"标签
   - ✅ 切换到对应仓库
   - ✅ 可以看到该请假申请

### 场景 3：从通知中心点击审批结果通知

1. 登录超级管理员账号
2. 普通管理员审批了请假申请
3. 进入通知中心
4. 点击"管理员李四批准了司机张三的请假申请"
5. **预期结果**：
   - ✅ 跳转到考勤管理页面
   - ✅ 切换到"已批准"标签
   - ✅ 切换到对应仓库
   - ✅ 可以看到该请假申请的审批详情

### 场景 4：跨仓库通知

1. 登录超级管理员账号
2. 司机在仓库A提交请假申请
3. 当前超级管理员正在查看仓库B
4. 点击通知中心的请假申请通知
5. **预期结果**：
   - ✅ 跳转到考勤管理页面
   - ✅ 自动切换到仓库A
   - ✅ 切换到"待审核"标签
   - ✅ 可以看到该请假申请

### 场景 5：审批后通知更新

1. 登录普通管理员账号
2. 审批司机的请假申请（批准）
3. 登录超级管理员账号
4. 查看通知栏
5. **预期结果**：
   - ✅ 通知栏显示审批结果通知
   - ✅ 不再显示待审批通知
   - ✅ 点击通知栏跳转到通知中心
   - ✅ 从通知中心点击通知跳转到"已批准"标签

## 技术实现细节

### 1. 通知栏简化

**关键代码**：
```typescript
// 所有用户点击通知栏都跳转到通知中心
Taro.navigateTo({url: '/pages/common/notifications/index'})
```

**优点**：
- 逻辑简单，易于维护
- 统一的用户体验
- 减少代码复杂度

### 2. 通知中心智能跳转

**关键代码**：
```typescript
// 获取申请的仓库ID和状态
const {data: application} = await supabase
  .from(tableName)
  .select('warehouse_id, status')
  .eq('id', notification.related_id)
  .maybeSingle()

if (application?.warehouse_id) {
  // 根据申请状态确定要跳转的标签
  let tab = 'pending' // 默认待审核
  if (application.status === 'approved') {
    tab = 'approved' // 已批准
  } else if (application.status === 'rejected') {
    tab = 'rejected' // 已拒绝
  }

  // 跳转到考勤管理页面，并切换到对应标签和仓库
  Taro.navigateTo({
    url: `${pathPrefix}/leave-approval/index?tab=${tab}&warehouseId=${application.warehouse_id}`
  })
}
```

**优点**：
- 根据申请状态智能选择标签页
- 自动切换到对应仓库
- 用户体验更好

### 3. 错误处理

```typescript
try {
  // 获取申请信息
  const {data: application} = await supabase
    .from(tableName)
    .select('warehouse_id, status')
    .eq('id', notification.related_id)
    .maybeSingle()

  if (application?.warehouse_id) {
    // 跳转逻辑
  }
} catch (error) {
  logger.error('获取申请信息失败', error)
}

// 如果获取失败，跳转到考勤管理页面（不指定仓库）
Taro.navigateTo({
  url: `${pathPrefix}/leave-approval/index?tab=pending`
})
```

**优点**：
- 完善的错误处理
- 即使获取失败也能正常跳转
- 不会影响用户体验

## 修改文件清单

### 1. 通知栏组件
- **文件**：`src/components/RealNotificationBar/index.tsx`
- **修改**：简化 `handleClick` 函数，统一跳转到通知中心
- **删除**：复杂的智能跳转逻辑

### 2. 通知中心页面
- **文件**：`src/pages/common/notifications/index.tsx`
- **新增**：`supabase` 导入
- **修改**：`handleNotificationClick` 函数，添加审批结果通知处理
- **新增**：根据申请状态智能选择标签页
- **新增**：携带仓库ID参数

## 代码质量

### TypeScript 类型检查
```bash
pnpm run lint
```

**结果**：✅ 通过，无新增错误

### 代码规范
- ✅ 使用 TypeScript 严格模式
- ✅ 添加详细的注释
- ✅ 遵循项目代码风格
- ✅ 完善的错误处理

## 用户体验改进

### 优化前
1. ❌ 点击通知栏直接跳转到审批界面，跳过通知中心
2. ❌ 无法查看完整的通知列表
3. ❌ 审批结果通知无法正确跳转
4. ❌ 没有携带仓库ID参数，需要手动切换仓库

### 优化后
1. ✅ 点击通知栏跳转到通知中心，流程清晰
2. ✅ 可以查看完整的通知列表
3. ✅ 审批结果通知可以正确跳转到对应标签页
4. ✅ 自动切换到对应仓库，无需手动操作

## 后续优化建议

### 1. 添加通知分类

在通知中心添加分类筛选：
- 待审批通知
- 审批结果通知
- 系统通知

### 2. 添加通知搜索

支持按关键词搜索通知：
- 司机姓名
- 通知类型
- 日期范围

### 3. 添加通知统计

显示通知统计信息：
- 未读通知数量
- 今日通知数量
- 本周通知数量

### 4. 优化通知显示

改进通知的显示方式：
- 添加通知摘要
- 显示相关人员头像
- 添加快捷操作按钮

## 总结

本次优化主要解决了两个问题：

1. **通知栏跳转逻辑优化**
   - ✅ 简化通知栏点击逻辑
   - ✅ 统一跳转到通知中心
   - ✅ 提升用户体验

2. **通知中心跳转逻辑增强**
   - ✅ 支持所有类型的请假/离职通知
   - ✅ 根据申请状态智能选择标签页
   - ✅ 自动切换到对应仓库
   - ✅ 完善的错误处理

这些改进显著提升了通知系统的用户体验，使得管理员可以更方便地查看和处理通知。

## 相关文档

- [双管理员端请假审批跳转优化](./双管理员端请假审批跳转优化.md)
- [司机端请假离职申请按钮状态优化](./司机端请假离职申请按钮状态优化.md)

## 完成日期

2025-11-05
