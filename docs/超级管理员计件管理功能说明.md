# 超级管理员计件管理功能说明

## 功能概述

超级管理员计件管理功能是车队管家小程序的核心管理功能之一，为超级管理员提供了全局的计件记录管理能力。该功能支持查看所有仓库和所有司机的计件数据、多维度筛选、记录添加、详情查看和删除等操作，确保超级管理员能够全面监控和管理整个车队的计件工作。

## 功能特点

### 1. 全局数据访问
- ✅ 可查看所有仓库的计件记录
- ✅ 可查看所有司机的计件数据
- ✅ 不受仓库管辖权限限制
- ✅ 全面掌握车队运营情况

### 2. 多维度数据筛选
- ✅ 支持按仓库筛选
- ✅ 支持按司机筛选
- ✅ 支持日期范围筛选
- ✅ 提供快捷筛选功能

### 3. 记录管理功能
- ✅ 支持为任意司机添加计件记录
- ✅ 支持查看记录详细信息
- ✅ 支持删除任意记录
- ✅ 实时数据同步更新

### 4. 统计分析能力
- ✅ 实时显示总件数统计
- ✅ 实时显示总金额统计
- ✅ 支持按筛选条件汇总
- ✅ 数据准确可靠

## 功能入口

### 主页入口
1. 登录超级管理员账号
2. 在超级管理员控制台页面
3. 找到"其他系统功能"区域
4. 点击"计件管理"图标

### 入口位置
- **位置**：其他系统功能区域第一个
- **图标**：橙色背景，剪贴板编辑图标
- **文字**：计件管理

## 主要功能

### 1. 仓库筛选

**功能说明**：
- 超级管理员可以选择查看特定仓库或所有仓库的计件记录
- 支持快速切换不同仓库的数据视图
- 不受仓库管辖权限限制

**操作步骤**：
1. 在筛选条件区域找到"仓库"选择器
2. 点击选择器打开仓库列表
3. 选择"所有仓库"或特定仓库名称
4. 数据自动更新显示

**选项说明**：
- **所有仓库**：显示系统中所有仓库的计件记录
- **特定仓库**：只显示选中仓库的计件记录

### 2. 司机筛选

**功能说明**：
- 可以筛选特定司机的计件记录
- 支持查看所有司机的汇总数据
- 覆盖所有司机用户

**操作步骤**：
1. 在筛选条件区域找到"司机"选择器
2. 点击选择器打开司机列表
3. 选择"所有司机"或特定司机名称
4. 数据自动更新显示

**选项说明**：
- **所有司机**：显示所有司机的计件记录
- **特定司机**：只显示选中司机的计件记录

### 3. 日期范围筛选

**功能说明**：
- 支持自定义日期范围查询
- 提供快捷筛选按钮
- 灵活的时间维度分析

**操作步骤**：
1. **自定义日期**：
   - 点击"开始日期"选择器，选择起始日期
   - 点击"结束日期"选择器，选择结束日期
   - 数据自动更新

2. **快捷筛选**：
   - **前一天**：查看前一天的记录（蓝色按钮）
   - **本周**：查看本周的记录（绿色按钮）
   - **本月**：查看本月的记录（橙色按钮，默认选中）

**快捷筛选说明**：
- 点击快捷筛选按钮后，日期范围自动设置
- 当前激活的筛选按钮会高亮显示
- 手动修改日期后，快捷筛选状态变为"自定义"

### 4. 统计数据展示

**功能说明**：
- 实时显示当前筛选条件下的统计数据
- 包含总件数和总金额
- 数据动态更新

**统计卡片**：
1. **总件数**：
   - 显示所有记录的数量总和
   - 蓝色图标和数字
   - 单位：件

2. **总金额**：
   - 显示所有记录的金额总和
   - 橙色图标和数字
   - 单位：元（保留两位小数）

### 5. 添加计件记录

**功能说明**：
- 超级管理员可以为任意司机添加计件记录
- 可以选择任意仓库
- 支持完整的费用明细录入

**操作步骤**：
1. 点击"添加计件记录"按钮
2. 填写表单信息：
   - **司机**：选择要添加记录的司机（必填）
   - **仓库**：选择工作仓库（必填）
   - **品类**：选择计件品类（必填）
   - **工作日期**：选择工作日期（必填）
   - **工作时间**：选择工作时间（必填）
   - **数量**：输入计件数量（必填）
   - **单价**：输入单价（必填）
   - **是否需要上楼**：开关选择
   - **上楼费**：如需上楼，输入上楼费（必填）
   - **是否需要分拣**：开关选择
   - **分拣数量**：如需分拣，输入分拣数量（必填）
   - **分拣单价**：如需分拣，输入分拣单价（必填）
   - **备注**：输入备注信息（可选）
3. 查看预计总金额
4. 点击"保存"按钮提交

**费用计算规则**：
```
总金额 = (数量 × 单价) + 上楼费 + (分拣数量 × 分拣单价)
```

**表单验证**：
- 所有必填字段必须填写
- 数量和单价必须大于0
- 如果选择需要上楼，上楼费必须大于0
- 如果选择需要分拣，分拣数量和单价必须大于0

### 6. 查看记录详情

**功能说明**：
- 点击任意计件记录可查看完整详情
- 弹窗展示所有信息
- 包含完整的费用明细

**操作步骤**：
1. 在记录列表中点击任意记录卡片
2. 弹窗自动打开显示详情
3. 查看完毕后点击"关闭"按钮或弹窗外部区域

**详情内容**：
1. **司机信息**：司机姓名或手机号
2. **工作日期**：记录的工作日期
3. **仓库**：工作仓库名称
4. **品类**：计件品类名称和是否需要上楼/分拣标识
5. **费用明细**：
   - 数量（件）
   - 单价（元）
   - 基础费用（数量 × 单价）
   - 上楼费（如有）
   - 分拣费（如有，分拣数量 × 分拣单价）
   - **总金额**（加粗显示）
6. **备注**：备注信息（如有）
7. **创建时间**：记录创建的时间

**详情弹窗特点**：
- 清晰的视觉层级
- 不同费用类型用不同颜色区分
- 总金额突出显示
- 支持点击外部区域关闭

### 7. 删除记录

**功能说明**：
- 超级管理员可以删除任意计件记录
- 删除前需要确认
- 操作权限最高

**操作步骤**：
1. 在记录列表中找到要删除的记录
2. 点击记录右上角的红色删除图标
3. 在确认对话框中点击"确定"
4. 系统显示删除成功提示
5. 记录列表自动更新

**注意事项**：
- ⚠️ 删除操作不可恢复
- ⚠️ 请谨慎操作
- ⚠️ 删除前请确认记录信息
- ⚠️ 超级管理员拥有最高权限

### 8. 排序功能

**功能说明**：
- 支持按日期升序或降序排列
- 快速切换排序方式
- 便于查找特定时间的记录

**操作步骤**：
1. 在记录列表标题栏找到排序按钮
2. 点击排序按钮切换排序方式
3. 记录列表自动重新排列

**排序选项**：
- **降序**：最新的记录在前（默认）
- **升序**：最早的记录在前

## 界面布局

### 页面结构

```
┌─────────────────────────────────────┐
│         计件管理                     │
│    管理和查看计件记录                │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│  筛选条件                            │
│                                     │
│  仓库: [所有仓库 ▼]                  │
│  司机: [所有司机 ▼]                  │
│                                     │
│  开始日期: [2025-01-01 📅]           │
│  结束日期: [2025-01-31 📅]           │
│                                     │
│  [前一天] [本周] [本月]              │
└─────────────────────────────────────┘

┌──────────────────┬──────────────────┐
│  总件数          │  总金额           │
│  📦 500          │  💰 ¥10,000.00   │
└──────────────────┴──────────────────┘

┌─────────────────────────────────────┐
│  ➕ 添加计件记录                     │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│  计件记录                共 50 条    │
│                         [排序 ▼]    │
│                                     │
│  ┌─────────────────────────────┐   │
│  │ 👤 张三        2025-01-15   │🗑│ │
│  │ 🏢 北京仓库                  │   │
│  │ 🏷️ 标准件  [需上楼]          │   │
│  │ 数量: 10  单价: ¥20  上楼: ¥5│   │
│  │ 总计: ¥205.00                │   │
│  └─────────────────────────────┘   │
│                                     │
│  [更多记录...]                       │
└─────────────────────────────────────┘
```

## 数据流程

### 1. 数据加载流程

```
用户打开页面
    ↓
加载超级管理员信息
    ↓
加载所有仓库列表
    ↓
加载所有司机列表
    ↓
加载所有品类列表
    ↓
根据筛选条件加载计件记录
    ↓
计算统计数据
    ↓
显示页面内容
```

### 2. 筛选更新流程

```
用户修改筛选条件
    ↓
更新筛选状态
    ↓
重新加载计件记录
    ↓
重新计算统计数据
    ↓
更新页面显示
```

### 3. 添加记录流程

```
用户点击添加按钮
    ↓
跳转到表单页面
    ↓
用户填写表单
    ↓
实时计算总金额
    ↓
用户点击保存
    ↓
验证表单数据
    ↓
提交到数据库
    ↓
显示成功提示
    ↓
返回列表页面
    ↓
自动刷新数据
```

### 4. 删除记录流程

```
用户点击删除按钮
    ↓
显示确认对话框
    ↓
用户确认删除
    ↓
从数据库删除记录
    ↓
显示成功提示
    ↓
自动刷新列表
    ↓
更新统计数据
```

## 技术实现

### 1. 全局数据访问

**实现方式**：
- 使用 `getAllWarehouses()` 获取所有仓库
- 使用 `getDriverProfiles()` 获取所有司机
- 不受管辖权限限制

**代码示例**：
```typescript
// 加载所有仓库
const warehousesData = await getAllWarehouses()
setWarehouses(warehousesData)

// 加载所有司机
const driversData = await getDriverProfiles()
setDrivers(driversData)

// 加载记录时根据仓库筛选
if (selectedWarehouseIndex === 0) {
  // 加载所有仓库的记录
  const allRecords = await Promise.all(
    warehouses.map((w) => getPieceWorkRecordsByWarehouse(w.id, startDate, endDate))
  )
  data = allRecords.flat()
} else {
  // 加载特定仓库的记录
  const warehouse = warehouses[selectedWarehouseIndex - 1]
  data = await getPieceWorkRecordsByWarehouse(warehouse.id, startDate, endDate)
}
```

### 2. 多维度筛选

**实现方式**：
- 支持仓库、司机、日期范围的组合筛选
- 使用数组过滤实现司机筛选
- 使用快捷筛选按钮快速设置日期

**代码示例**：
```typescript
// 司机筛选
if (selectedDriverIndex > 0) {
  const selectedDriver = drivers[selectedDriverIndex - 1]
  data = data.filter((r) => r.user_id === selectedDriver.id)
}

// 快捷筛选
const handleQuickFilter = (type: 'yesterday' | 'week' | 'month') => {
  const now = new Date()
  let start: Date
  let end: Date

  switch (type) {
    case 'yesterday':
      start = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1)
      end = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1)
      break
    case 'week':
      start = new Date(now.getFullYear(), now.getMonth(), now.getDate() - now.getDay())
      end = now
      break
    case 'month':
      start = new Date(now.getFullYear(), now.getMonth(), 1)
      end = new Date(now.getFullYear(), now.getMonth() + 1, 0)
      break
  }

  setStartDate(start.toISOString().split('T')[0])
  setEndDate(end.toISOString().split('T')[0])
  setQuickFilter(type)
}
```

### 3. 实时数据更新

**实现方式**：
- 使用 `useEffect` 监听筛选条件变化
- 使用 `useDidShow` 在页面显示时刷新数据
- 使用 `useCallback` 优化函数性能

**代码示例**：
```typescript
// 监听筛选条件变化
useEffect(() => {
  loadRecords()
}, [loadRecords])

// 页面显示时刷新
useDidShow(() => {
  loadData()
})

// 使用 useCallback 优化
const loadRecords = useCallback(async () => {
  // 加载数据逻辑
}, [startDate, endDate, warehouses, drivers, selectedWarehouseIndex, selectedDriverIndex, sortOrder])
```

### 4. 统计数据计算

**实现方式**：
- 使用 reduce 函数计算总件数和总金额
- 实时更新统计数据

**代码示例**：
```typescript
// 计算统计数据
const totalQuantity = records.reduce((sum, r) => sum + r.quantity, 0)
const totalAmount = records.reduce((sum, r) => sum + Number(r.total_amount), 0)
```

## 使用场景

### 场景1：查看全局计件情况

**需求**：超级管理员想查看所有仓库本月的计件情况

**操作步骤**：
1. 打开计件管理页面
2. 仓库选择"所有仓库"
3. 司机选择"所有司机"
4. 点击"本月"快捷筛选按钮
5. 查看统计数据和记录列表

### 场景2：分析特定仓库的运营情况

**需求**：超级管理员想分析"北京仓库"本周的运营情况

**操作步骤**：
1. 打开计件管理页面
2. 在仓库选择器中选择"北京仓库"
3. 司机选择"所有司机"
4. 点击"本周"快捷筛选按钮
5. 查看统计数据
6. 浏览记录列表分析详细情况

### 场景3：监控特定司机的工作情况

**需求**：超级管理员想监控司机"张三"本月的工作情况

**操作步骤**：
1. 打开计件管理页面
2. 仓库选择"所有仓库"
3. 在司机选择器中选择"张三"
4. 点击"本月"快捷筛选按钮
5. 查看该司机的总件数和总金额
6. 查看详细记录列表

### 场景4：为司机补录计件记录

**需求**：司机"李四"忘记录入某天的计件记录，超级管理员帮忙补录

**操作步骤**：
1. 打开计件管理页面
2. 点击"添加计件记录"按钮
3. 选择司机"李四"
4. 选择对应的仓库和品类
5. 选择工作日期和时间
6. 输入数量、单价等信息
7. 查看预计总金额
8. 点击"保存"按钮

### 场景5：删除错误记录

**需求**：发现某条记录录入错误，需要删除

**操作步骤**：
1. 在记录列表中找到错误记录
2. 点击记录右上角的删除图标
3. 在确认对话框中点击"确定"
4. 等待删除成功提示
5. 确认记录已从列表中移除

### 场景6：跨仓库数据对比

**需求**：对比"北京仓库"和"上海仓库"本月的计件情况

**操作步骤**：
1. 打开计件管理页面
2. 选择"北京仓库"，查看统计数据并记录
3. 选择"上海仓库"，查看统计数据并记录
4. 对比两个仓库的总件数和总金额
5. 分析差异原因

## 注意事项

### 1. 权限说明
- ⚠️ 只有超级管理员角色才能访问此功能
- ⚠️ 超级管理员拥有最高权限，可查看和管理所有数据
- ⚠️ 需要先登录才能使用

### 2. 数据准确性
- ⚠️ 添加记录时请仔细核对所有信息
- ⚠️ 特别注意司机、仓库的选择
- ⚠️ 删除操作不可恢复，请谨慎操作
- ⚠️ 建议定期核对数据准确性

### 3. 网络要求
- ⚠️ 需要网络连接才能加载和保存数据
- ⚠️ 网络不稳定可能导致数据加载失败
- ⚠️ 保存失败时请检查网络后重试

### 4. 操作建议
- 💡 建议定期查看和核对计件记录
- 💡 使用快捷筛选可以提高查询效率
- 💡 添加记录时建议填写备注信息
- 💡 重要数据建议导出备份（功能开发中）
- 💡 发现异常数据及时处理

### 5. 性能优化
- 💡 避免选择过长的日期范围
- 💡 大量数据时建议使用筛选功能
- 💡 定期清理不需要的历史记录

### 6. 数据安全
- 💡 超级管理员权限较高，请妥善保管账号
- 💡 删除操作前请再次确认
- 💡 重要操作建议记录日志

## 常见问题

### Q1：为什么看不到某个仓库的数据？

**A**：可能的原因：
1. 该仓库在选定日期范围内没有记录
2. 筛选条件设置不正确
3. 数据加载失败

**解决方法**：
- 调整日期范围重新查询
- 检查筛选条件设置
- 刷新页面重新加载数据

### Q2：为什么统计数据与预期不符？

**A**：可能的原因：
1. 筛选条件限制了数据范围
2. 日期范围设置不正确
3. 存在未显示的记录

**解决方法**：
- 检查仓库和司机筛选条件
- 确认日期范围设置
- 尝试选择"所有仓库"和"所有司机"查看全部数据

### Q3：如何查看某个时间段的汇总数据？

**A**：操作步骤：
1. 设置开始日期和结束日期
2. 选择"所有仓库"和"所有司机"
3. 查看统计卡片中的总件数和总金额
4. 这就是该时间段的汇总数据

### Q4：删除记录后能恢复吗？

**A**：
- 不能。删除操作是永久性的，无法恢复
- 建议删除前仔细确认
- 重要记录建议先截图保存

### Q5：如何导出计件数据？

**A**：
- 数据导出功能正在开发中
- 目前可以通过截图方式保存重要数据
- 后续版本将提供Excel导出功能

### Q6：为什么添加记录时找不到某个司机？

**A**：可能的原因：
1. 该用户不是司机角色
2. 该司机账号已被停用
3. 数据加载失败

**解决方法**：
- 在用户管理中确认该用户的角色
- 检查账号状态
- 刷新页面重新加载数据

## 功能对比

### 与普通管理员计件管理的区别

| 功能项 | 普通管理员 | 超级管理员 |
|--------|-----------|-----------|
| 查看范围 | 只能查看管辖仓库的记录 | 可查看所有仓库的记录 |
| 仓库选择 | 限于管辖的仓库 | 所有仓库 |
| 司机查看 | 所有司机 | 所有司机 |
| 添加记录 | 可为任意司机添加 | 可为任意司机添加 |
| 删除记录 | 支持 | 支持 |
| 详情查看 | 支持 | 支持 |
| 统计数据 | 管辖范围内统计 | 全局统计 |
| 权限级别 | 中等 | 最高 |

### 与司机端计件记录的区别

| 功能项 | 司机端 | 超级管理员端 |
|--------|--------|-------------|
| 查看范围 | 只能查看自己的记录 | 可查看所有记录 |
| 添加记录 | 只能为自己添加 | 可为任意司机添加 |
| 仓库筛选 | 无 | 支持所有仓库筛选 |
| 司机筛选 | 无 | 支持所有司机筛选 |
| 编辑记录 | 支持 | 暂不支持 |
| 删除记录 | 支持 | 支持 |
| 详情查看 | 支持 | 支持 |
| 统计数据 | 个人统计 | 全局统计 |

## 更新日志

### v1.0.0 (2025-01-15)
- ✅ 初始版本发布
- ✅ 实现全局数据访问
- ✅ 实现多维度筛选功能
- ✅ 实现添加记录功能
- ✅ 实现详情查看弹窗
- ✅ 实现删除记录功能
- ✅ 实现快捷筛选功能
- ✅ 实现排序功能
- ✅ 实现实时数据更新
- ✅ 实现统计数据展示

### 计划功能
- 📋 编辑记录功能
- 📋 批量删除功能
- 📋 数据导出功能（Excel）
- 📋 记录审核功能
- 📋 异常记录标记
- 📋 数据分析图表
- 📋 操作日志记录

## 技术支持

如果您在使用过程中遇到问题，请：
1. 查看本文档的"常见问题"部分
2. 联系系统管理员
3. 提交问题反馈

## 总结

超级管理员计件管理功能为超级管理员提供了全局的计件记录管理能力，具有以下核心优势：

1. **全局视野**：可查看所有仓库和所有司机的数据
2. **灵活筛选**：支持多维度筛选和快捷筛选
3. **实时更新**：数据实时同步，确保准确性
4. **直观易用**：界面清晰，操作简单
5. **详细展示**：完整的费用明细展示
6. **最高权限**：拥有最高的数据访问和管理权限

该功能与普通管理员和司机端的计件管理功能保持一致的界面风格和交互方式，确保了系统的统一性和易用性，为车队的全局管理和决策提供了强有力的数据支持。
