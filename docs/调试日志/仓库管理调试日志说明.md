# 仓库管理调试日志说明

## 📋 概述

已为仓库管理功能的所有关键模块添加详细的调试日志,便于开发和测试阶段追踪功能执行流程和定位问题。

## 🎯 涉及功能模块

### 1. 编辑仓库 (warehouse-edit/index.tsx)

#### 已添加日志的功能点:

##### 1.1 加载仓库信息 (loadWarehouse)
- **日志标签**: `[仓库管理-编辑仓库]`
- **关键日志**:
  - 开始加载仓库信息 (包含warehouseId)
  - 加载仓库数据成功 (输出仓库完整数据)
  - 仓库状态设置完成 (输出关键字段: name, isActive, maxLeaveDays, dailyTarget)
  - 未找到仓库数据警告
  - 加载失败错误

##### 1.2 加载品类和价格 (loadCategoriesAndPrices)
- **日志标签**: `[仓库管理-品类价格]`
- **关键日志**:
  - 开始加载品类和价格 (包含warehouseId)
  - 加载所有品类成功 (输出品类数量和详细列表)
  - 加载仓库品类价格成功 (输出价格数量和详细数据)
  - 品类价格映射完成 (输出已选品类数量、品类列表、价格Map大小)
  - 加载失败错误

##### 1.3 加载管理员 (loadManagers)
- **日志标签**: `[仓库管理-仓库分配]`
- **关键日志**:
  - 开始加载管理员 (包含warehouseId和当前用户ID)
  - 加载管理员成功 (输出总用户数和管理员数量)
  - 当前用户是管理员 (输出用户ID、姓名和角色)
  - 当前用户不是管理员警告
  - 加载仓库已分配管理员 (输出管理员数量和详细列表)
  - 已分配管理员ID集合
  - 加载失败错误

##### 1.4 创建新品类 (handleCreateCategory)
- **日志标签**: `[仓库管理-品类操作]`
- **关键日志**:
  - 开始创建新品类 (输出品类名称和价格)
  - 品类名称为空警告
  - 调用创建品类API
  - 创建品类失败返回null错误
  - 品类创建成功 (输出categoryId和名称)
  - 创建品类价格记录 (输出priceInput)
  - 品类价格创建成功
  - 品类已自动选中并设置价格
  - 品类价格创建失败错误
  - 创建品类异常

##### 1.5 导入品类 (handleImportCategories)
- **日志标签**: `[仓库管理-导入品类]`
- **关键日志**:
  - 未选择仓库警告
  - 开始导入品类配置 (输出源仓库ID和目标仓库ID)
  - 获取源仓库品类价格 (输出数量和详细数据)
  - 源仓库没有品类配置警告
  - 品类配置合并完成 (输出合并前后数量和导入的品类列表)
  - 品类导入成功
  - 导入失败错误

##### 1.6 保存仓库信息 (handleSave)
- **日志标签**: `[仓库管理-保存操作]`
- **关键日志**:
  - 开始保存仓库信息 (输出warehouseId, name, isActive)
  - 仓库名称为空警告
  - 未选择管理员警告
  - 每日指标格式不正确警告
  - 开始验证品类价格 (输出已选品类数量)
  - 品类纯司机单价无效警告
  - 品类带车司机单价无效警告
  - 验证通过,开始保存
  - **步骤1**: 更新仓库基本信息 (输出所有字段)
  - 更新仓库基本信息失败错误
  - 步骤1完成
  - **步骤2**: 开始更新品类价格
  - 品类价格输入数据 (输出数量和详细数据)
  - 更新品类价格失败错误
  - 步骤2完成/跳过
  - **步骤3**: 开始更新管理员分配
  - 管理员分配变更 (输出旧/新管理员ID、待添加/删除列表)
  - 添加管理员 (每个)
  - 移除管理员 (每个)
  - 步骤3完成
  - **步骤4**: 开始更新考勤规则
  - 更新现有考勤规则/创建新考勤规则 (输出ruleInput)
  - 考勤规则更新/创建成功/失败
  - 步骤4完成
  - 清除缓存
  - 所有步骤完成,保存成功
  - 保存失败错误

### 2. 司机仓库分配 (driver-warehouse-assignment/index.tsx)

#### 已添加日志的功能点:

##### 2.1 加载司机的仓库分配 (loadDriverWarehouses)
- **日志标签**: `[仓库管理-司机仓库分配]`
- **关键日志**:
  - 加载司机的仓库分配 (输出driverId)
  - 司机已分配仓库 (输出driverId, warehouseIds, count)

##### 2.2 选择司机 (handleSelectDriver)
- **日志标签**: `[仓库管理-司机仓库分配]`
- **关键日志**:
  - 选择司机 (输出driverId, driverName)

##### 2.3 仓库选择变化 (handleCheckboxChange)
- **日志标签**: `[仓库管理-司机仓库分配]`
- **关键日志**:
  - 仓库选择变化 (输出selectedWarehouseIds, count)

##### 2.4 保存仓库分配 (handleSave)
- **日志标签**: `[仓库管理-司机仓库分配]`
- **关键日志**:
  - 未选择司机警告
  - 开始保存仓库分配 (输出司机信息、选择的仓库)
  - 之前的仓库分配 (输出previousWarehouseIds)
  - 仓库分配保存成功 (输出result)
  - 准备发送通知
  - 保存失败错误 (输出error)

### 3. 管理员仓库分配 (manager-warehouse-assignment/index.tsx)

#### 已添加日志的功能点:

##### 3.1 加载管理员的仓库分配 (loadManagerWarehouses)
- **日志标签**: `[仓库管理-管理员仓库分配]`
- **关键日志**:
  - 加载管理员的仓库分配 (输出managerId)
  - 管理员已分配仓库 (输出managerId, warehouses, warehouseIds, count)

##### 3.2 选择管理员 (handleSelectManager)
- **日志标签**: `[仓库管理-管理员仓库分配]`
- **关键日志**:
  - 选择管理员 (输出managerId, managerName, role)

##### 3.3 仓库选择变化 (handleWarehouseChange)
- **日志标签**: `[仓库管理-管理员仓库分配]`
- **关键日志**:
  - 仓库选择变化 (输出selectedWarehouseIds, count)

##### 3.4 保存分配 (handleSave)
- **日志标签**: `[仓库管理-管理员仓库分配]`
- **关键日志**:
  - 未选择管理员警告
  - 开始保存仓库分配 (输出管理员信息、选择的仓库)
  - 保存成功
  - 保存失败错误

## 🔍 如何使用调试日志

### 1. 查看日志

在浏览器开发者工具的 Console 面板中查看:

```javascript
// 筛选仓库管理相关日志
filter: [仓库管理

// 筛选特定功能日志
filter: [仓库管理-编辑仓库]
filter: [仓库管理-品类价格]
filter: [仓库管理-仓库分配]
filter: [仓库管理-司机仓库分配]
filter: [仓库管理-管理员仓库分配]
```

### 2. 日志级别

- `console.log()` - 正常流程日志 (蓝色/黑色)
- `console.warn()` - 警告日志 (黄色)
- `console.error()` - 错误日志 (红色)

### 3. 测试流程建议

#### 测试编辑仓库功能:

1. 打开编辑仓库页面
2. 在Console中输入 `[仓库管理-编辑仓库]` 进行筛选
3. 观察加载流程:
   - 是否成功加载仓库信息
   - 是否成功加载品类和价格
   - 是否成功加载管理员列表
4. 修改仓库信息后保存
5. 观察保存流程的4个步骤是否都成功执行

#### 测试品类管理:

1. 在Console中输入 `[仓库管理-品类` 进行筛选
2. 测试创建新品类:
   - 观察品类创建流程
   - 检查价格记录是否成功创建
   - 验证品类是否自动选中
3. 测试导入品类:
   - 观察导入流程
   - 检查品类配置合并情况

#### 测试仓库分配:

1. 测试司机仓库分配:
   - 在Console中输入 `[仓库管理-司机仓库分配]`
   - 选择司机并观察已分配仓库加载
   - 修改选择后保存,观察变更日志

2. 测试管理员仓库分配:
   - 在Console中输入 `[仓库管理-管理员仓库分配]`
   - 选择管理员并观察已分配仓库加载
   - 修改选择后保存,观察变更日志

## 📊 日志数据示例

### 加载仓库信息示例:

```javascript
[仓库管理-编辑仓库] 开始加载仓库信息 {warehouseId: "abc-123"}
[仓库管理-编辑仓库] 加载仓库数据成功 {id: "abc-123", name: "北京仓库", is_active: true, ...}
[仓库管理-编辑仓库] 仓库状态设置完成 {name: "北京仓库", isActive: true, maxLeaveDays: 7, dailyTarget: 100}
```

### 保存仓库信息示例:

```javascript
[仓库管理-保存操作] 开始保存仓库信息 {warehouseId: "abc-123", name: "北京仓库", isActive: true}
[仓库管理-保存操作] 验证通过,开始保存
[仓库管理-保存操作] 步骤1: 更新仓库基本信息 {name: "北京仓库", isActive: true, maxLeaveDays: 7, ...}
[仓库管理-保存操作] 步骤1完成: 仓库基本信息更新成功
[仓库管理-保存操作] 步骤2: 开始更新品类价格
[仓库管理-保存操作] 品类价格输入数据 {count: 5, priceInputs: [{...}, {...}, ...]}
[仓库管理-保存操作] 步骤2完成: 品类价格更新成功
[仓库管理-保存操作] 步骤3: 开始更新管理员分配
[仓库管理-保存操作] 管理员分配变更 {oldManagerIds: ["user1"], newManagerIds: ["user1", "user2"], toAdd: ["user2"], toRemove: []}
[仓库管理-保存操作] 添加管理员 {managerId: "user2"}
[仓库管理-保存操作] 步骤3完成: 管理员分配更新成功
[仓库管理-保存操作] 步骤4: 开始更新考勤规则
[仓库管理-保存操作] 更新现有考勤规则 {ruleId: "rule-123", ruleInput: {...}}
[仓库管理-保存操作] 考勤规则更新成功
[仓库管理-保存操作] 步骤4完成: 考勤规则更新成功
[仓库管理-保存操作] 清除缓存
[仓库管理-保存操作] 所有步骤完成,保存成功
```

## 🐛 常见问题排查

### 问题1: 仓库信息加载失败

**排查步骤**:
1. 查看日志中的错误信息
2. 检查 warehouseId 是否正确
3. 检查网络请求是否成功
4. 检查数据库权限配置

### 问题2: 品类价格保存失败

**排查步骤**:
1. 查看步骤2的日志
2. 检查 priceInputs 数据是否正确
3. 检查品类ID和仓库ID是否有效
4. 检查价格数值格式是否正确

### 问题3: 管理员分配不生效

**排查步骤**:
1. 查看步骤3的日志
2. 检查 toAdd 和 toRemove 列表
3. 确认API调用是否成功
4. 检查缓存是否正确清除

### 问题4: 仓库分配保存后司机看不到

**排查步骤**:
1. 查看保存成功日志
2. 检查通知是否发送
3. 提示司机重新进入页面或重新登录
4. 检查缓存是否需要清除

## 📝 注意事项

1. **生产环境**: 建议在生产环境中关闭或减少详细日志输出,可以使用环境变量控制
2. **敏感信息**: 日志中不包含密码等敏感信息,但包含用户ID和仓库ID等业务数据
3. **性能影响**: 大量日志输出可能影响性能,建议仅在开发和测试环境使用
4. **日志保留**: 浏览器Console日志会在页面刷新后清除,如需长期保留可以使用浏览器的"保留日志"功能

## 🔧 扩展建议

如需添加更多调试功能,可以考虑:

1. 添加日志时间戳
2. 添加日志序号(追踪操作顺序)
3. 将关键日志发送到日志服务器
4. 添加性能监控(记录每个步骤的耗时)
5. 添加用户行为追踪(点击、输入等)

## 📋 修改文件清单

1. `/src/pages/super-admin/warehouse-edit/index.tsx` - 编辑仓库页面
2. `/src/pages/super-admin/driver-warehouse-assignment/index.tsx` - 司机仓库分配页面
3. `/src/pages/super-admin/manager-warehouse-assignment/index.tsx` - 管理员仓库分配页面

---

**文档生成时间**: 2025-12-11  
**版本**: v1.0  
**维护人**: AI Assistant
