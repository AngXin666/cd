# 请假审批功能优化说明

## 一、优化概述

本次优化针对超级管理员和普通管理员的请假审批功能进行了全面重构，解决了数据可见性问题，简化了操作流程，提升了用户体验。

## 二、主要问题修复

### 2.1 数据可见性问题
**问题描述：**
- 超级管理员无法查看历史审批数据
- 超级管理员无法查看实时数据

**解决方案：**
- 使用`getAllLeaveApplications()`和`getAllResignationApplications()`获取所有数据（包括历史数据）
- 移除了之前的数据过滤限制
- 确保所有状态的申请（待审批、已通过、已驳回）都能被查看

### 2.2 功能简化
**优化内容：**
- 移除了复杂的"高级筛选"功能模块
- 简化筛选条件，仅保留"选择仓库"一项
- 移除了以下筛选项：
  - 请假类型筛选
  - 司机筛选
  - 审批人筛选
  - 时间范围筛选
  - 关键字搜索

## 三、新功能设计

### 3.1 两层数据展示架构

#### 第一层：司机列表视图
**功能：**
- 显示所有司机的请假天数总览
- 按仓库筛选司机
- 显示每个司机的统计数据：
  - 请假总天数（仅统计已通过的申请）
  - 请假次数
  - 离职申请次数
  - 待审批数量

**交互：**
- 点击司机卡片进入详情页

#### 第二层：司机详情页
**功能：**
- 显示该司机的所有请假申请记录
- 显示该司机的所有离职申请记录
- 显示完整的审批历史
- 支持直接审批操作

**交互：**
- 查看详细的申请信息
- 审批待审批的申请
- 返回司机列表

### 3.2 权限控制

#### 超级管理员权限
- 可以查看所有仓库的数据
- 可以选择任意仓库进行筛选
- 可以查看所有司机的请假记录
- 可以审批所有申请

#### 普通管理员权限
- 只能查看其管辖仓库的数据
- 只能选择其管辖的仓库进行筛选
- 只能查看其管辖仓库下司机的请假记录
- 只能审批其管辖范围内的申请

**注意：** 普通管理员和超级管理员在数据查看和交互功能上完全一致，唯一区别是数据范围。

## 四、页面结构

### 4.1 超级管理员页面

#### 请假审批管理页面
**路径：** `/pages/super-admin/leave-approval/index`

**布局：**
```
┌─────────────────────────────────────┐
│  请假审批管理                        │
│  超级管理员工作台                    │
├─────────────────────────────────────┤
│  [司机总数] [请假总天数] [待审批]   │
├─────────────────────────────────────┤
│  选择仓库                            │
│  [全部仓库 ▼]                       │
├─────────────────────────────────────┤
│  司机请假统计                        │
│  ┌─────────────────────────────┐   │
│  │ 👤 张三 - 东区仓库           │   │
│  │ 🔴 2 待审批                  │   │
│  │ [15天] [5次] [0次]          │   │
│  │ 查看详细记录 →               │   │
│  └─────────────────────────────┘   │
│  ┌─────────────────────────────┐   │
│  │ 👤 李四 - 西区仓库           │   │
│  │ [10天] [3次] [1次]          │   │
│  │ 查看详细记录 →               │   │
│  └─────────────────────────────┘   │
└─────────────────────────────────────┘
```

#### 司机详情页面
**路径：** `/pages/super-admin/driver-leave-detail/index`

**布局：**
```
┌─────────────────────────────────────┐
│  ← 返回                              │
├─────────────────────────────────────┤
│  👤 张三                             │
│  司机详细记录                        │
│  [15天] [5次] [0次]                 │
├─────────────────────────────────────┤
│  ⚠️ 有待审批的申请                  │
│  请假申请 2 条，离职申请 0 条        │
├─────────────────────────────────────┤
│  [请假申请 (5)] [离职申请 (0)]      │
├─────────────────────────────────────┤
│  📅 病假 - 待审批                   │
│  所属仓库：东区仓库                  │
│  请假时间：2024-01-15 至 2024-01-17 │
│  共 3 天                             │
│  请假事由：感冒需要休息              │
│  申请时间：2024-01-14 10:30         │
│  [通过] [驳回]                      │
├─────────────────────────────────────┤
│  📅 事假 - 已通过                   │
│  所属仓库：东区仓库                  │
│  请假时间：2024-01-10 至 2024-01-12 │
│  共 3 天                             │
│  请假事由：家中有事                  │
│  申请时间：2024-01-09 09:00         │
│  ✅ 审批记录                         │
│  审批人：李经理                      │
│  审批时间：2024-01-09 14:20         │
│  审批意见：已通过                    │
└─────────────────────────────────────┘
```

### 4.2 普通管理员页面

#### 请假审批管理页面
**路径：** `/pages/manager/leave-approval/index`

**说明：** 界面与超级管理员完全一致，但只显示其管辖仓库的数据。

#### 司机详情页面
**路径：** `/pages/manager/driver-leave-detail/index`

**说明：** 界面与超级管理员完全一致，但只能查看其管辖仓库下司机的数据。

## 五、核心功能实现

### 5.1 数据加载

```typescript
// 加载所有数据（包括历史数据）
const loadData = useCallback(async () => {
  // 获取所有仓库信息
  const allWarehouses = await getAllWarehouses()
  
  // 获取所有用户信息
  const allProfiles = await getAllProfiles()
  
  // 获取所有请假申请（包括历史数据）
  const allLeaveApps = await getAllLeaveApplications()
  
  // 获取所有离职申请（包括历史数据）
  const allResignationApps = await getAllResignationApplications()
  
  // 如果是普通管理员，获取其管辖的仓库
  if (userProfile?.role === 'manager') {
    const managedWarehouses = await getManagerWarehouses(user.id)
    setManagerWarehouses(managedWarehouses.map((w) => w.id))
  }
}, [user])
```

### 5.2 权限过滤

```typescript
// 获取可见的仓库列表（根据权限）
const getVisibleWarehouses = () => {
  if (currentUserProfile?.role === 'super_admin') {
    // 超级管理员可以看到所有仓库
    return warehouses
  } else if (currentUserProfile?.role === 'manager') {
    // 普通管理员只能看到自己管辖的仓库
    return warehouses.filter((w) => managerWarehouses.includes(w.id))
  }
  return []
}

// 获取可见的申请数据（根据权限和仓库筛选）
const getVisibleApplications = () => {
  let visibleLeave = leaveApplications
  let visibleResignation = resignationApplications

  // 如果是普通管理员，只显示其管辖仓库的数据
  if (currentUserProfile?.role === 'manager') {
    visibleLeave = leaveApplications.filter((app) => 
      managerWarehouses.includes(app.warehouse_id)
    )
    visibleResignation = resignationApplications.filter((app) => 
      managerWarehouses.includes(app.warehouse_id)
    )
  }

  // 按仓库筛选
  if (filterWarehouse !== 'all') {
    visibleLeave = visibleLeave.filter((app) => 
      app.warehouse_id === filterWarehouse
    )
    visibleResignation = visibleResignation.filter((app) => 
      app.warehouse_id === filterWarehouse
    )
  }

  return {visibleLeave, visibleResignation}
}
```

### 5.3 司机统计计算

```typescript
// 计算司机统计数据
const calculateDriverStats = (): DriverStats[] => {
  const {visibleLeave, visibleResignation} = getVisibleApplications()
  
  // 获取所有司机
  const drivers = profiles.filter((p) => p.role === 'driver')
  
  const statsMap = new Map<string, DriverStats>()

  // 处理请假申请
  for (const app of visibleLeave) {
    const driver = drivers.find((d) => d.id === app.user_id)
    if (!driver) continue

    if (!statsMap.has(driver.id)) {
      statsMap.set(driver.id, {
        driverId: driver.id,
        driverName: getUserName(driver.id),
        warehouseId: app.warehouse_id,
        warehouseName: getWarehouseName(app.warehouse_id),
        totalLeaveDays: 0,
        leaveCount: 0,
        resignationCount: 0,
        pendingCount: 0
      })
    }

    const stats = statsMap.get(driver.id)!
    stats.leaveCount++
    
    // 只统计已通过的请假天数
    if (app.status === 'approved') {
      stats.totalLeaveDays += calculateLeaveDays(app.start_date, app.end_date)
    }
    
    // 统计待审批数量
    if (app.status === 'pending') {
      stats.pendingCount++
    }
  }

  // 处理离职申请
  for (const app of visibleResignation) {
    // 类似处理...
  }

  return Array.from(statsMap.values())
    .sort((a, b) => b.totalLeaveDays - a.totalLeaveDays)
}
```

### 5.4 页面导航

```typescript
// 跳转到司机详情页
const navigateToDriverDetail = (driverId: string) => {
  Taro.navigateTo({
    url: `/pages/super-admin/driver-leave-detail/index?driverId=${driverId}`
  })
}

// 返回上一页
const goBack = () => {
  Taro.navigateBack()
}
```

### 5.5 审批操作

```typescript
// 审批请假申请
const handleApproveLeave = async (applicationId: string) => {
  if (!user) return

  const result = await Taro.showModal({
    title: '确认通过',
    content: '确定要通过这个请假申请吗？'
  })

  if (!result.confirm) return

  const success = await reviewLeaveApplication(applicationId, {
    status: 'approved',
    reviewer_id: user.id,
    review_comment: '已通过',
    reviewed_at: new Date().toISOString()
  })

  if (success) {
    Taro.showToast({title: '已通过', icon: 'success'})
    loadData()
  } else {
    Taro.showToast({title: '操作失败', icon: 'none'})
  }
}
```

## 六、关键改进点

### 改进前
- ❌ 无法查看历史审批数据
- ❌ 无法查看实时数据
- ❌ 筛选功能过于复杂（8种筛选条件）
- ❌ 直接显示所有申请记录，数据量大时难以查看
- ❌ 无法快速了解司机的整体请假情况

### 改进后
- ✅ 可以查看所有历史审批数据
- ✅ 可以查看实时数据
- ✅ 筛选功能简化（仅保留仓库筛选）
- ✅ 两层架构，先看总览再看详情
- ✅ 清晰展示每个司机的请假统计
- ✅ 支持点击查看详细记录
- ✅ 权限控制清晰明确

## 七、使用场景

### 场景1：查看所有司机的请假情况
1. 进入请假审批管理页面
2. 查看司机列表，了解每个司机的请假天数
3. 点击司机卡片查看详细记录

### 场景2：按仓库查看司机请假情况
1. 进入请假审批管理页面
2. 选择特定仓库
3. 查看该仓库下所有司机的请假统计
4. 点击司机卡片查看详细记录

### 场景3：审批待审批的申请
1. 进入请假审批管理页面
2. 找到有待审批标记的司机
3. 点击进入司机详情页
4. 查看待审批的申请详情
5. 点击"通过"或"驳回"按钮
6. 确认操作

### 场景4：查看历史审批记录
1. 进入请假审批管理页面
2. 点击任意司机卡片
3. 在司机详情页查看所有历史申请
4. 查看已审批申请的审批记录

### 场景5：普通管理员查看管辖范围内的数据
1. 普通管理员登录
2. 进入请假审批管理页面
3. 自动只显示其管辖仓库的司机
4. 选择仓库筛选
5. 查看司机详情和审批申请

## 八、技术实现亮点

### 8.1 数据完整性
- 使用`getAllLeaveApplications()`确保获取所有数据
- 不再有数据过滤限制
- 支持查看所有状态的申请

### 8.2 权限控制
- 基于用户角色的数据过滤
- 超级管理员和普通管理员使用相同的代码
- 通过数据过滤实现权限控制

### 8.3 性能优化
- 客户端计算统计数据
- 使用Map数据结构提高查询效率
- 避免重复计算

### 8.4 用户体验
- 两层架构，先总览后详情
- 清晰的视觉层次
- 直观的统计数据展示
- 便捷的导航和操作

## 九、代码质量

### 9.1 类型安全
- ✅ 完整的TypeScript类型定义
- ✅ 严格的类型检查
- ✅ 无类型错误

### 9.2 代码规范
- ✅ 通过ESLint检查
- ✅ 通过Biome格式化
- ✅ 符合项目代码规范

### 9.3 可维护性
- ✅ 清晰的代码结构
- ✅ 合理的函数拆分
- ✅ 详细的注释说明

## 十、文件清单

### 新增文件
1. `/pages/super-admin/driver-leave-detail/index.tsx` - 超级管理员司机详情页
2. `/pages/super-admin/driver-leave-detail/index.config.ts` - 超级管理员司机详情页配置
3. `/pages/manager/driver-leave-detail/index.tsx` - 普通管理员司机详情页
4. `/pages/manager/driver-leave-detail/index.config.ts` - 普通管理员司机详情页配置

### 修改文件
1. `/pages/super-admin/leave-approval/index.tsx` - 超级管理员请假审批页（完全重写）
2. `/pages/manager/leave-approval/index.tsx` - 普通管理员请假审批页（完全重写）
3. `/app.config.ts` - 注册新页面路由

## 十一、测试验证

### 11.1 功能测试
- ✅ 超级管理员可以查看所有数据
- ✅ 普通管理员只能查看管辖范围内的数据
- ✅ 仓库筛选功能正常
- ✅ 司机统计数据准确
- ✅ 页面导航正常
- ✅ 审批操作正常

### 11.2 代码质量测试
- ✅ 通过pnpm run lint检查
- ✅ 无TypeScript类型错误
- ✅ 无ESLint警告

### 11.3 用户体验测试
- ✅ 界面清晰易懂
- ✅ 操作流畅便捷
- ✅ 信息展示完整

## 十二、总结

本次优化成功解决了数据可见性问题，简化了操作流程，提升了用户体验。通过两层数据展示架构，用户可以先查看司机的整体请假情况，再深入查看详细记录，大大提高了审批工作的效率。

### 核心价值
1. **数据完整性**：可以查看所有历史和实时数据
2. **功能简化**：移除复杂的筛选功能，只保留必要的仓库筛选
3. **层次清晰**：两层架构，先总览后详情
4. **权限明确**：超级管理员和普通管理员权限清晰
5. **体验优化**：直观的统计数据展示，便捷的操作流程

### 技术亮点
1. **类型安全**：完整的TypeScript支持
2. **性能优化**：高效的数据计算和渲染
3. **代码质量**：规范的代码结构和注释
4. **可维护性**：清晰的架构设计

该实现完全满足用户需求，并为未来的功能扩展奠定了良好的基础。
