# 通知中心分组显示问题修复

## 问题描述

用户反馈：通知中心的通知信息不显示了

## 问题原因

在添加未读信息筛选功能时，修改了分组逻辑，但使用了错误的日期分类键值：

### 错误的代码

```typescript
// 按照今天、昨天、历史的顺序排列
const order = ['今天', '昨天', '历史']  // ❌ 使用了中文字符串
order.forEach((title) => {
  const notifs = groupMap.get(title)  // ❌ 无法匹配到数据
  if (notifs && notifs.length > 0) {
    groups.push({title, notifications: notifs})
  }
})
```

### 问题分析

1. **`getDateCategory` 函数返回值**
   - 返回类型：`'today' | 'yesterday' | 'history'`
   - 返回的是英文字符串

2. **分组逻辑使用的键值**
   - 使用的键值：`['今天', '昨天', '历史']`
   - 使用的是中文字符串

3. **结果**
   - `groupMap.get('今天')` 无法匹配到 `groupMap.set('today', ...)`
   - 所有分组都为空
   - 通知列表不显示任何内容

## 修复方案

修改分组逻辑，使用正确的英文键值，并添加映射表将英文键值转换为中文标题：

### 修复后的代码

```typescript
// 按照今天、昨天、历史的顺序排列
const order: Array<'today' | 'yesterday' | 'history'> = ['today', 'yesterday', 'history']  // ✅ 使用英文字符串
const titleMap = {
  today: '今天',
  yesterday: '昨天',
  history: '更早'
}

order.forEach((key) => {
  const notifs = groupMap.get(key)  // ✅ 可以正确匹配到数据
  if (notifs && notifs.length > 0) {
    groups.push({title: titleMap[key], notifications: notifs})  // ✅ 使用映射表转换为中文标题
  }
})
```

## 修复效果

### 修复前
- ❌ 通知列表为空
- ❌ 显示"暂无通知"
- ❌ 无法查看任何通知

### 修复后
- ✅ 通知列表正常显示
- ✅ 按日期分组（今天、昨天、更早）
- ✅ 未读信息筛选功能正常工作

## 技术细节

### 1. 类型安全

使用 TypeScript 的类型定义确保键值正确：

```typescript
const order: Array<'today' | 'yesterday' | 'history'> = ['today', 'yesterday', 'history']
```

### 2. 映射表

使用映射表将英文键值转换为中文标题：

```typescript
const titleMap = {
  today: '今天',
  yesterday: '昨天',
  history: '更早'
}
```

### 3. 一致性

确保整个代码库中使用一致的键值：
- `getDateCategory` 返回英文字符串
- `groupMap` 使用英文字符串作为键
- 显示时通过 `titleMap` 转换为中文

## 测试验证

### 测试场景 1：查看所有通知
- ✅ 通知列表正常显示
- ✅ 按日期分组（今天、昨天、更早）
- ✅ 未读通知有红色圆点标识

### 测试场景 2：筛选未读信息
- ✅ 点击"未读信息"按钮
- ✅ 只显示未读通知
- ✅ 按日期分组正常

### 测试场景 3：切换显示模式
- ✅ 第一次点击：只显示未读通知
- ✅ 第二次点击：显示所有通知
- ✅ 分组显示正常

## 代码质量

### Lint 检查
```bash
pnpm run lint
```
**结果**：✅ 通过，无新增错误

## 经验教训

### 1. 类型一致性

在使用 Map 或对象作为数据结构时，确保键值类型一致：
- 如果使用英文字符串作为键，所有地方都应该使用英文字符串
- 如果需要显示中文，使用映射表转换

### 2. TypeScript 类型定义

使用 TypeScript 的类型定义可以帮助发现这类问题：
```typescript
const order: Array<'today' | 'yesterday' | 'history'> = ['今天', '昨天', '历史']  // ❌ TypeScript 会报错
```

### 3. 测试覆盖

在修改关键逻辑后，应该立即测试：
- 测试基本功能是否正常
- 测试边界情况
- 测试用户常见操作

## Git 提交记录

```bash
commit f45dd4d
修复通知中心分组显示问题

问题：通知信息不显示
原因：分组逻辑中使用了错误的日期分类键值
修复：使用正确的英文键值，添加 titleMap 映射
```

## 相关文档

- [通知中心未读信息筛选功能](./通知中心未读信息筛选功能.md)
- [通知系统跳转逻辑优化](./通知系统跳转逻辑优化.md)

## 完成日期

2025-11-05

## 总结

这是一个典型的键值不匹配问题：
- **问题根源**：使用了错误的键值类型（中文 vs 英文）
- **修复方法**：统一使用英文键值，通过映射表转换为中文显示
- **预防措施**：使用 TypeScript 类型定义，确保类型一致性

修复后，通知中心的所有功能恢复正常，未读信息筛选功能也可以正常使用。
