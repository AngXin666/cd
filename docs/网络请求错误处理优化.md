# 网络请求错误处理优化方案

## 问题描述

用户报告了一个网络请求失败的错误：

```
获取所有请假申请失败: {
  message: 'TypeError: Failed to fetch',
  details: 'TypeError: Failed to fetch\n    at _request...',
  hint: '',
  code: ''
}
```

## 错误分析

### 错误类型

`Failed to fetch` 是一个浏览器原生错误，通常由以下原因导致：

1. **网络连接问题**
   - 用户网络中断
   - 服务器暂时不可达
   - DNS 解析失败

2. **CORS 配置问题**
   - 跨域请求被浏览器阻止
   - 服务器未正确配置 CORS 头

3. **请求超时**
   - 请求时间过长
   - 服务器响应缓慢

4. **浏览器限制**
   - 浏览器扩展阻止请求
   - 浏览器安全策略限制

### 当前实现

当前的错误处理比较简单，只是打印错误日志并返回空数组：

```typescript
export async function getAllLeaveApplications(): Promise<LeaveApplication[]> {
  const {data, error} = await supabase
    .from('leave_applications')
    .select('*')
    .order('created_at', {ascending: false})

  if (error) {
    console.error('获取所有请假申请失败:', error)
    return []
  }

  return Array.isArray(data) ? data : []
}
```

**问题**：
- ❌ 用户看不到错误提示
- ❌ 没有重试机制
- ❌ 无法区分错误类型
- ❌ 调试信息不足

## 优化方案

### 方案 1：添加用户友好的错误提示

在页面级别添加错误提示，让用户知道发生了什么：

```typescript
const loadData = useCallback(async () => {
  try {
    Taro.showLoading({title: '加载中...'})
    
    const applications = await getAllLeaveApplications()
    setLeaveApplications(applications)
    
  } catch (error) {
    console.error('加载数据失败:', error)
    
    // 显示用户友好的错误提示
    Taro.showToast({
      title: '网络连接失败，请检查网络后重试',
      icon: 'none',
      duration: 3000
    })
  } finally {
    Taro.hideLoading()
  }
}, [])
```

### 方案 2：添加重试机制

实现自动重试功能，提高请求成功率：

```typescript
/**
 * 带重试的请求函数
 */
async function fetchWithRetry<T>(
  fetchFn: () => Promise<T>,
  maxRetries: number = 3,
  delay: number = 1000
): Promise<T> {
  let lastError: any
  
  for (let i = 0; i < maxRetries; i++) {
    try {
      return await fetchFn()
    } catch (error) {
      lastError = error
      console.warn(`请求失败，第 ${i + 1} 次重试...`, error)
      
      if (i < maxRetries - 1) {
        // 等待一段时间后重试
        await new Promise(resolve => setTimeout(resolve, delay * (i + 1)))
      }
    }
  }
  
  throw lastError
}

// 使用示例
export async function getAllLeaveApplications(): Promise<LeaveApplication[]> {
  try {
    const result = await fetchWithRetry(async () => {
      const {data, error} = await supabase
        .from('leave_applications')
        .select('*')
        .order('created_at', {ascending: false})
      
      if (error) throw error
      return data
    })
    
    return Array.isArray(result) ? result : []
  } catch (error) {
    console.error('获取所有请假申请失败:', error)
    return []
  }
}
```

### 方案 3：添加网络状态检测

在请求前检测网络状态：

```typescript
/**
 * 检查网络连接状态
 */
async function checkNetworkStatus(): Promise<boolean> {
  try {
    const networkInfo = await Taro.getNetworkType()
    return networkInfo.networkType !== 'none'
  } catch (error) {
    console.error('获取网络状态失败:', error)
    return true // 默认认为有网络
  }
}

const loadData = useCallback(async () => {
  // 检查网络状态
  const hasNetwork = await checkNetworkStatus()
  if (!hasNetwork) {
    Taro.showToast({
      title: '当前无网络连接',
      icon: 'none',
      duration: 2000
    })
    return
  }
  
  try {
    Taro.showLoading({title: '加载中...'})
    const applications = await getAllLeaveApplications()
    setLeaveApplications(applications)
  } catch (error) {
    console.error('加载数据失败:', error)
    Taro.showToast({
      title: '加载失败，请稍后重试',
      icon: 'none',
      duration: 2000
    })
  } finally {
    Taro.hideLoading()
  }
}, [])
```

### 方案 4：添加手动刷新按钮

当自动加载失败时，提供手动刷新的选项：

```typescript
const [loadError, setLoadError] = useState<boolean>(false)

const loadData = useCallback(async () => {
  try {
    setLoadError(false)
    Taro.showLoading({title: '加载中...'})
    
    const applications = await getAllLeaveApplications()
    setLeaveApplications(applications)
    
  } catch (error) {
    console.error('加载数据失败:', error)
    setLoadError(true)
    
    Taro.showToast({
      title: '加载失败',
      icon: 'none',
      duration: 2000
    })
  } finally {
    Taro.hideLoading()
  }
}, [])

// UI 中显示错误提示和刷新按钮
{loadError && (
  <View className="flex flex-col items-center justify-center py-8">
    <View className="i-mdi-alert-circle text-6xl text-muted-foreground mb-4" />
    <Text className="text-muted-foreground mb-4">加载失败，请检查网络连接</Text>
    <Button
      className="bg-primary text-white px-6 py-2 rounded"
      size="default"
      onClick={loadData}>
      重新加载
    </Button>
  </View>
)}
```

## 推荐实现

结合以上方案，推荐实现以下优化：

### 1. 在 API 层添加统一的错误处理

创建一个统一的错误处理工具函数：

```typescript
// src/utils/errorHandler.ts

/**
 * 统一的错误处理函数
 */
export function handleApiError(error: any, context: string): void {
  console.error(`${context}失败:`, error)
  
  // 判断错误类型
  if (error.message?.includes('Failed to fetch')) {
    console.error('网络请求失败，可能的原因：')
    console.error('1. 网络连接中断')
    console.error('2. 服务器不可达')
    console.error('3. CORS 配置问题')
  } else if (error.code === 'PGRST116') {
    console.error('数据库查询错误：记录不存在')
  } else if (error.code?.startsWith('42')) {
    console.error('数据库权限错误：RLS 策略限制')
  }
}

/**
 * 显示用户友好的错误提示
 */
export function showUserFriendlyError(error: any): void {
  let message = '操作失败，请稍后重试'
  
  if (error.message?.includes('Failed to fetch')) {
    message = '网络连接失败，请检查网络后重试'
  } else if (error.code === 'PGRST116') {
    message = '数据不存在'
  } else if (error.code?.startsWith('42')) {
    message = '权限不足，请联系管理员'
  }
  
  Taro.showToast({
    title: message,
    icon: 'none',
    duration: 3000
  })
}
```

### 2. 在页面级别使用错误处理

```typescript
import {handleApiError, showUserFriendlyError} from '@/utils/errorHandler'

const loadData = useCallback(async () => {
  try {
    Taro.showLoading({title: '加载中...'})
    
    const applications = await getAllLeaveApplications()
    setLeaveApplications(applications)
    
  } catch (error) {
    handleApiError(error, '加载请假申请')
    showUserFriendlyError(error)
  } finally {
    Taro.hideLoading()
  }
}, [])
```

## 临时解决方案

如果这是一个临时的网络问题，用户可以尝试以下操作：

1. **刷新页面**
   - 下拉刷新页面
   - 或者退出后重新进入

2. **检查网络连接**
   - 确认手机/电脑已连接到网络
   - 尝试切换 WiFi 或移动数据

3. **清除缓存**
   - 清除浏览器缓存
   - 或者清除小程序缓存

4. **重启应用**
   - 完全关闭应用后重新打开

## 调试建议

如果问题持续存在，可以通过以下方式调试：

### 1. 检查 Supabase 连接

```typescript
// 在浏览器控制台执行
console.log('Supabase URL:', process.env.TARO_APP_SUPABASE_URL)
console.log('Supabase Key:', process.env.TARO_APP_SUPABASE_ANON_KEY?.substring(0, 20) + '...')
```

### 2. 测试简单的查询

```typescript
// 测试最简单的查询
const {data, error} = await supabase.from('profiles').select('id').limit(1)
console.log('测试查询结果:', {data, error})
```

### 3. 检查浏览器控制台

查看浏览器控制台的 Network 标签，检查：
- 请求是否发送成功
- 响应状态码
- 响应内容
- 是否有 CORS 错误

### 4. 检查 Supabase 服务状态

访问 Supabase 控制台，确认：
- 项目是否正常运行
- 数据库是否可访问
- API 是否可用

## 总结

`Failed to fetch` 错误通常是临时的网络问题，不是代码错误。建议：

1. **短期方案**：刷新页面或重试
2. **中期方案**：添加用户友好的错误提示
3. **长期方案**：实现自动重试机制和完善的错误处理

如果问题持续存在，需要进一步调查：
- 检查 Supabase 服务状态
- 检查网络配置
- 检查 CORS 设置
- 检查 RLS 策略

## 相关文件

- `src/db/api.ts` - API 函数定义
- `src/pages/manager/leave-approval/index.tsx` - 管理员考勤管理页面
- `src/pages/super-admin/leave-approval/index.tsx` - 超级管理员考勤管理页面

## 完成日期

2025-11-05
