# 车辆历史记录页面修复说明

## 问题描述

超级管理员端车辆管理页面，点击"查看历史记录"按钮后显示"未找到车辆信息"，但车辆已完成一个还车周期。

## 问题分析

### 根本原因

历史记录页面使用了错误的 API 和数据模型：

1. **错误的 API 调用**
   - 页面调用了 `getVehicleBaseByPlateNumber()` 函数
   - 该函数尝试从 `vehicles_base` 表查询数据
   - 但数据库中**不存在** `vehicles_base` 表

2. **数据模型不匹配**
   - 代码中使用了 `vehicles_base` + `vehicle_records` 的分离设计
   - 但实际数据库只有 `vehicles` 表，采用单表设计
   - 所有提车、还车信息都存储在 `vehicles` 表的字段中

3. **数据结构**
   - `vehicles` 表包含：
     - `pickup_time`: 提车时间
     - `return_time`: 还车时间
     - `left_front_photo`, `right_front_photo` 等：提车照片
     - `return_photos`: 还车照片数组
     - `driver_id`: 司机ID（外键关联 `profiles` 表）

### 查询结果

```sql
-- 查询车牌号为 粤AC83702 的车辆
SELECT * FROM vehicles WHERE plate_number = '粤AC83702';

-- 结果：
-- vehicle_id: c855d15c-036c-4ada-b89b-03380683dbac
-- plate_number: 粤AC83702
-- status: inactive
-- pickup_time: 2025-11-22 22:13:30.259+08
-- return_time: 2025-11-22 23:57:12.4+08
-- record_count: 0 (vehicle_records 表中没有记录)
```

## 解决方案

### 1. 创建新的 API 函数

在 `src/db/api.ts` 中添加 `getVehicleByPlateNumber()` 函数：

```typescript
/**
 * 根据车牌号获取车辆信息（用于历史记录页面）
 * @param plateNumber 车牌号
 * @returns 车辆信息，包含司机信息
 */
export async function getVehicleByPlateNumber(plateNumber: string): Promise<VehicleWithDriver | null> {
  logger.db('查询', 'vehicles', {plateNumber})
  try {
    const {data, error} = await supabase
      .from('vehicles')
      .select(
        `
        *,
        driver:driver_id (
          id,
          name,
          phone,
          email
        )
      `
      )
      .eq('plate_number', plateNumber)
      .maybeSingle()

    if (error) {
      logger.error('根据车牌号获取车辆信息失败', {error, plateNumber})
      return null
    }

    if (!data) {
      logger.warn('车辆不存在', {plateNumber})
      return null
    }

    logger.info('成功获取车辆信息', {plateNumber, vehicleId: data.id})
    return data as VehicleWithDriver
  } catch (error) {
    logger.error('根据车牌号获取车辆信息异常', {error, plateNumber})
    return null
  }
}
```

**关键点：**
- 直接从 `vehicles` 表查询
- 使用 Supabase 的关联查询获取司机信息
- 返回 `VehicleWithDriver` 类型

### 2. 更新类型定义

在 `src/db/types.ts` 中更新 `VehicleWithDriver` 接口：

```typescript
export interface VehicleWithDriver extends Vehicle {
  driver_id?: string | null
  driver_name?: string | null
  driver_phone?: string | null
  driver_email?: string | null
  driver?: {
    id: string
    name: string | null
    phone: string | null
    email: string | null
  } | null
}
```

**关键点：**
- 添加 `driver` 对象属性
- 支持 Supabase 关联查询返回的嵌套对象

### 3. 重写历史记录页面

完全重写 `src/pages/super-admin/vehicle-history/index.tsx`：

**主要改动：**

1. **导入新的 API**
   ```typescript
   import {getVehicleByPlateNumber} from '@/db/api'
   ```

2. **简化状态管理**
   ```typescript
   const [vehicle, setVehicle] = useState<VehicleWithDriver | null>(null)
   const [activeTab, setActiveTab] = useState<'pickup' | 'return'>('pickup')
   ```

3. **加载车辆信息**
   ```typescript
   const loadVehicleInfo = useCallback(async () => {
     const data = await getVehicleByPlateNumber(plateNumber)
     if (data) {
       setVehicle(data)
     } else {
       Taro.showToast({title: '未找到车辆信息', icon: 'none'})
     }
   }, [plateNumber])
   ```

4. **显示提车和还车信息**
   - 提车信息：显示 `pickup_time`、司机信息、提车照片
   - 还车信息：显示 `return_time`、还车照片

5. **照片处理**
   ```typescript
   const getVehiclePhotos = (type: 'pickup' | 'return'): string[] => {
     if (type === 'pickup') {
       // 提车照片：从单独的字段获取
       if (vehicle.left_front_photo) photos.push(vehicle.left_front_photo)
       // ... 其他照片字段
     } else {
       // 还车照片：从数组字段获取
       if (vehicle.return_photos && Array.isArray(vehicle.return_photos)) {
         photos.push(...vehicle.return_photos)
       }
     }
     return photos
   }
   ```

## 修复效果

修复后，历史记录页面将：

1. ✅ 正确查询到车辆信息
2. ✅ 显示车辆基本信息（车牌号、品牌、型号、颜色、车架号、状态）
3. ✅ 显示提车信息（提车时间、司机信息、提车照片）
4. ✅ 显示还车信息（还车时间、还车照片）
5. ✅ 支持照片预览功能

## 测试验证

### 测试步骤

1. 登录超级管理员账号
2. 进入"车辆管理"页面
3. 找到已还车的车辆（状态为"已停用"）
4. 点击"查看历史记录"按钮
5. 验证页面显示：
   - 车辆基本信息
   - 提车信息（时间、司机、照片）
   - 还车信息（时间、照片）

### 预期结果

- 页面正常显示车辆信息
- 不再显示"未找到车辆信息"错误
- 可以切换查看提车和还车信息
- 可以点击照片预览

## 相关文件

### 修改的文件

1. `src/db/api.ts`
   - 添加 `getVehicleByPlateNumber()` 函数

2. `src/db/types.ts`
   - 更新 `VehicleWithDriver` 接口

3. `src/pages/super-admin/vehicle-history/index.tsx`
   - 完全重写，使用新的 API 和数据模型

### 未修改的文件

- `src/db/vehicleRecordsApi.ts`（保留原有代码，但不再使用）
- 数据库表结构（无需修改）

## 注意事项

1. **历史记录的局限性**
   - 当前设计只能查看最近一次的提车和还车信息
   - 如果需要查看完整的历史记录，需要实现 `vehicle_records` 表的记录功能

2. **数据一致性**
   - 每次提车/还车会覆盖之前的数据
   - 如果需要保留历史记录，建议在提车/还车时同时创建 `vehicle_records` 记录

3. **类型安全**
   - 使用 TypeScript 类型确保数据结构正确
   - 避免使用 `as any` 类型断言

## 后续优化建议

1. **实现完整的历史记录功能**
   - 在提车时创建 `vehicle_records` 记录
   - 在还车时更新对应的记录
   - 历史记录页面显示所有记录

2. **数据迁移**
   - 将现有的 `vehicles` 表数据迁移到 `vehicle_records` 表
   - 保留历史数据

3. **统一数据模型**
   - 决定使用单表设计还是分离设计
   - 更新所有相关代码以保持一致性

## 总结

本次修复解决了历史记录页面无法显示车辆信息的问题，根本原因是代码使用了不存在的数据表。通过创建新的 API 函数和重写页面代码，现在可以正确显示车辆的提车和还车信息。

修复日期：2025-11-23
修复人员：AI Assistant
