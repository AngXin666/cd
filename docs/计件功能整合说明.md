# 计件功能整合说明文档

## 概述

本次更新将原有的"计件管理"和"计件报表"两个独立模块整合为统一的"件数报表"模块，并实现了基于角色的权限控制。

## 更新内容

### 1. 功能合并

#### 原有结构
- **普通管理员**
  - 计件管理页面：`/pages/manager/piece-work`
  - 计件表单页面：`/pages/manager/piece-work-form`
  - 计件报表页面：`/pages/manager/data-summary`

- **超级管理员**
  - 计件管理页面：`/pages/super-admin/piece-work`
  - 计件表单页面：`/pages/super-admin/piece-work-form`

#### 新结构
- **普通管理员**
  - 件数报表页面：`/pages/manager/piece-work-report`（只读）

- **超级管理员**
  - 件数报表页面：`/pages/super-admin/piece-work-report`（完整权限）
  - 计件表单页面：`/pages/super-admin/piece-work-report-form`（添加/编辑）

### 2. 权限控制

#### 普通管理员权限
- ✅ 查看管辖仓库的计件记录
- ✅ 按仓库、司机、日期筛选数据
- ✅ 查看统计数据（总件数、总金额、司机数量）
- ✅ 查看记录详情
- ❌ 添加新记录
- ❌ 编辑现有记录
- ❌ 删除记录

#### 超级管理员权限
- ✅ 查看所有仓库的计件记录
- ✅ 按仓库、司机、日期筛选数据
- ✅ 查看统计数据（总件数、总金额、司机数量）
- ✅ 查看记录详情
- ✅ 添加新记录
- ✅ 编辑现有记录
- ✅ 删除记录

### 3. 界面变化

#### 普通管理员主页
**变更前：**
- 计件管理按钮
- 计件报表按钮

**变更后：**
- 件数报表按钮（合并后的统一入口）

#### 超级管理员主页
**变更前：**
- 件数报表按钮（指向旧页面）

**变更后：**
- 件数报表按钮（指向新页面）

## 功能特性

### 1. 数据筛选

#### 仓库筛选
- 支持选择"所有仓库"或特定仓库
- 普通管理员只能看到管辖的仓库
- 超级管理员可以看到所有仓库

#### 司机筛选
- 支持搜索司机姓名或手机号
- 支持选择"所有司机"或特定司机
- 搜索结果实时过滤

#### 日期筛选
- **快捷筛选**
  - 前一天
  - 本周（周一至今）
  - 本月（月初至今）
- **自定义日期范围**
  - 开始日期
  - 结束日期

#### 排序
- 按日期升序排列
- 按日期降序排列（默认）

### 2. 统计功能

页面顶部显示三个统计卡片：

1. **总件数**
   - 筛选条件下所有记录的数量总和
   - 图标：包裹图标
   - 颜色：深蓝色

2. **总金额**
   - 包含基础金额、上楼费用、分拣费用
   - 格式：¥xxx.xx
   - 图标：货币图标
   - 颜色：橙色

3. **司机数量**
   - 去重后的司机数量
   - 图标：用户组图标
   - 颜色：深蓝色

### 3. 记录列表

#### 记录卡片显示
- 司机姓名/手机号
- 仓库名称
- 工作日期
- 品类和数量
- 总金额（高亮显示）

#### 操作按钮
**普通管理员：**
- 查看详情（蓝色按钮）

**超级管理员：**
- 查看详情（蓝色按钮）
- 编辑（橙色按钮）
- 删除（红色按钮）

### 4. 详情弹窗

显示完整的记录信息：
- 司机信息
- 仓库信息
- 品类信息
- 工作日期
- 数量和单价
- 基础金额
- 上楼信息（如有）
  - 上楼单价
  - 上楼金额
- 分拣信息（如有）
  - 分拣数量
  - 分拣单价
  - 分拣金额
- 总金额（高亮显示）
- 备注（如有）

### 5. 添加/编辑功能（仅超级管理员）

#### 添加记录
1. 点击页面顶部"添加计件记录"按钮
2. 填写表单信息
3. 提交保存

#### 编辑记录
1. 点击记录卡片的"编辑"按钮
2. 修改表单信息
3. 提交保存

#### 表单字段
- **必填字段**
  - 司机（下拉选择）
  - 仓库（下拉选择）
  - 品类（下拉选择）
  - 工作日期（日期选择器）
  - 数量（数字输入）
  - 单价（数字输入）

- **可选字段**
  - 需要上楼（开关）
    - 上楼单价（数字输入）
  - 需要分拣（开关）
    - 分拣数量（数字输入）
    - 分拣单价（数字输入）
  - 备注（文本输入，最多200字）

#### 表单验证
- 所有必填字段不能为空
- 数量必须大于0
- 单价必须大于0
- 如果选择"需要上楼"，上楼单价必须大于0
- 如果选择"需要分拣"，分拣数量和单价必须大于0

#### 自动计算
系统自动计算总金额：
```
总金额 = 基础金额 + 上楼金额 + 分拣金额
基础金额 = 数量 × 单价
上楼金额 = 数量 × 上楼单价（如果需要上楼）
分拣金额 = 分拣数量 × 分拣单价（如果需要分拣）
```

### 6. 删除功能（仅超级管理员）

1. 点击记录卡片的"删除"按钮
2. 确认删除操作
3. 系统删除记录并刷新列表

**注意：** 删除操作不可恢复，请谨慎操作。

## 技术实现

### 权限控制实现方式

本次更新采用**UI层面的权限控制**，通过完全隐藏操作按钮来实现：

```typescript
// 普通管理员页面：只显示查看详情按钮
<View className="flex gap-2 mt-2">
  <View onClick={() => handleViewDetail(record)} className="flex-1 bg-blue-900 text-white text-center py-2 rounded-lg">
    <Text className="text-xs text-white">查看详情</Text>
  </View>
</View>

// 超级管理员页面：显示所有操作按钮
<View className="flex gap-2 mt-2">
  <View onClick={() => handleViewDetail(record)} className="flex-1 bg-blue-900 text-white text-center py-2 rounded-lg">
    <Text className="text-xs text-white">查看详情</Text>
  </View>
  <View onClick={() => handleEditRecord(record)} className="flex-1 bg-orange-600 text-white text-center py-2 rounded-lg">
    <Text className="text-xs text-white">编辑</Text>
  </View>
  <View onClick={() => handleDeleteRecord(record)} className="flex-1 bg-red-600 text-white text-center py-2 rounded-lg">
    <Text className="text-xs text-white">删除</Text>
  </View>
</View>
```

### 数据加载逻辑

#### 普通管理员
```typescript
// 只加载管辖的仓库
const warehousesData = await getManagerWarehouses(user.id)

// 加载仓库的计件记录
const data = await getPieceWorkRecordsByWarehouse(warehouse.id, startDate, endDate)
```

#### 超级管理员
```typescript
// 加载所有仓库
const warehousesData = await getAllWarehouses()

// 加载所有仓库的计件记录
const allRecords = await Promise.all(
  warehouses.map((w) => getPieceWorkRecordsByWarehouse(w.id, startDate, endDate))
)
const data = allRecords.flat()
```

### 路由配置

```typescript
// app.config.ts
const pages = [
  // ... 其他页面
  'pages/manager/piece-work-report/index',
  'pages/super-admin/piece-work-report/index',
  'pages/super-admin/piece-work-report-form/index',
  // ... 其他页面
]
```

## 迁移指南

### 对于用户

1. **普通管理员**
   - 原来的"计件管理"和"计件报表"按钮已合并为"件数报表"
   - 点击"件数报表"即可查看所有计件数据
   - 不再能够添加、编辑或删除记录
   - 如需修改数据，请联系超级管理员

2. **超级管理员**
   - 原来的"件数报表"按钮现在指向新的统一页面
   - 新页面提供完整的增删改查功能
   - 添加记录：点击页面顶部的"添加计件记录"按钮
   - 编辑记录：点击记录卡片的"编辑"按钮
   - 删除记录：点击记录卡片的"删除"按钮

### 对于开发者

1. **旧页面已移除**
   - `/pages/manager/piece-work`
   - `/pages/manager/piece-work-form`
   - `/pages/super-admin/piece-work`
   - `/pages/super-admin/piece-work-form`

2. **新页面路径**
   - `/pages/manager/piece-work-report`
   - `/pages/super-admin/piece-work-report`
   - `/pages/super-admin/piece-work-report-form`

3. **导航更新**
   - `src/pages/manager/index.tsx`：移除`handlePieceWorkManagement`，更新`handlePieceWorkReport`
   - `src/pages/super-admin/index.tsx`：更新`handlePieceWorkReport`

4. **数据库**
   - 数据库结构保持不变
   - 数据库权限策略保持不变
   - 所有现有数据完全兼容

## 注意事项

1. **权限控制**
   - 权限控制在UI层面实现，通过隐藏按钮来限制操作
   - 数据库层面的权限策略保持不变，提供额外的安全保障

2. **数据兼容性**
   - 新页面完全兼容现有数据
   - 不需要进行数据迁移
   - 所有历史记录都可以正常查看

3. **用户体验**
   - 普通管理员界面更简洁，只显示必要的查看功能
   - 超级管理员界面功能完整，操作便捷
   - 所有操作都有明确的视觉反馈

4. **性能优化**
   - 数据按需加载，减少不必要的请求
   - 筛选和排序在前端进行，响应速度快
   - 统计数据实时计算，确保准确性

## 常见问题

### Q1: 普通管理员为什么不能添加/编辑/删除记录？
**A:** 根据业务需求，普通管理员只需要查看和分析数据，不需要修改权限。这样可以：
- 避免误操作导致数据错误
- 确保数据的一致性和准确性
- 简化普通管理员的操作流程

### Q2: 如何恢复旧的计件管理功能？
**A:** 旧的计件管理功能已完全整合到新的"件数报表"中，不建议恢复。如有特殊需求，请联系开发团队。

### Q3: 数据筛选后统计数据是否准确？
**A:** 是的，统计数据会根据当前的筛选条件实时计算，确保准确性。

### Q4: 删除记录后能否恢复？
**A:** 不能。删除操作是永久性的，无法恢复。删除前系统会弹出确认对话框，请谨慎操作。

### Q5: 编辑记录时总金额如何计算？
**A:** 总金额由系统自动计算，公式为：
```
总金额 = (数量 × 单价) + (数量 × 上楼单价) + (分拣数量 × 分拣单价)
```

## 更新日期

2025-11-05

## 版本信息

- 版本号：v2.0.0
- 更新类型：功能整合与优化
- 影响范围：计件管理模块

## 联系方式

如有问题或建议，请联系开发团队。
