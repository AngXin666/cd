# 车队管家权限管理系统说明

## 1. 权限层级定义

### 1.1 超级管理员 (super_admin)
- **权限范围**：拥有系统的完整权限
- **数据访问**：可以查看、新增、修改、删除所有数据
- **管理功能**：
  - 用户管理：查看、编辑所有用户信息，分配角色
  - 仓库管理：创建、编辑、删除仓库及考勤规则
  - 司机仓库分配：为司机分配所属仓库
  - 管理员仓库分配：为普通管理员分配管辖仓库
  - 计件品类管理：创建、编辑、删除计件品类
  - 数据报表：查看所有仓库的计件、考勤和工资数据
- **安全机制**：所有删除操作必须经过二次确认

### 1.2 普通管理员 (manager)
- **权限范围**：仅限于查看管辖仓库的数据
- **数据访问**：
  - 只能查看被分配管辖的仓库数据
  - 不能新增、修改或删除任何数据
- **管理功能**：
  - 数据汇总：查看管辖仓库的计件和考勤统计
  - 司机管理：查看管辖仓库的司机列表
- **限制**：
  - 无法修改计件记录
  - 无法修改考勤记录
  - 无法删除任何数据
  - 无法访问系统管理功能

### 1.3 用户/司机 (user)
- **权限范围**：只能管理自己的数据
- **数据访问**：
  - 可以查看、新增、修改、删除自己的计件记录
  - 可以查看、新增、修改、删除自己的考勤记录
- **功能**：
  - 计件录入：录入和管理自己的计件数据
  - 考勤打卡：上下班打卡
  - 数据查看：查看自己的计件和考勤统计
- **限制**：
  - 无法查看或修改其他用户的数据
  - 无法访问管理功能

## 2. 数据权限控制

### 2.1 计件记录 (piece_work_records)

#### 超级管理员权限
```sql
-- 完整权限（查看、新增、修改、删除）
CREATE POLICY "超级管理员拥有完整权限" ON piece_work_records
    FOR ALL TO authenticated
    USING (is_super_admin(auth.uid()))
    WITH CHECK (is_super_admin(auth.uid()));
```

#### 普通管理员权限
```sql
-- 只读权限（仅查看管辖仓库的数据）
CREATE POLICY "管理员可以查看管辖仓库的计件记录" ON piece_work_records
    FOR SELECT TO authenticated
    USING (
        is_manager(auth.uid()) AND
        EXISTS (
            SELECT 1 FROM manager_warehouses mw
            WHERE mw.manager_id = auth.uid()
            AND mw.warehouse_id = piece_work_records.warehouse_id
        )
    );
```

#### 用户权限
```sql
-- 完整权限（仅限自己的数据）
CREATE POLICY "用户可以查看自己的计件记录" ON piece_work_records
    FOR SELECT TO authenticated
    USING (auth.uid() = user_id);

CREATE POLICY "用户可以插入自己的计件记录" ON piece_work_records
    FOR INSERT TO authenticated
    WITH CHECK (auth.uid() = user_id);

CREATE POLICY "用户可以更新自己的计件记录" ON piece_work_records
    FOR UPDATE TO authenticated
    USING (auth.uid() = user_id)
    WITH CHECK (auth.uid() = user_id);

CREATE POLICY "用户可以删除自己的计件记录" ON piece_work_records
    FOR DELETE TO authenticated
    USING (auth.uid() = user_id);
```

### 2.2 考勤记录 (attendance_records)

权限策略与计件记录相同：
- 超级管理员：完整权限
- 普通管理员：只读权限（仅管辖仓库）
- 用户：完整权限（仅自己的数据）

## 3. 删除操作安全机制

### 3.1 二次确认流程
所有删除操作都必须经过二次确认，使用统一的确认对话框：

```typescript
import {confirmDelete} from '@/utils/confirm'

// 删除操作示例
const handleDelete = async (id: string, name: string) => {
  const confirmed = await confirmDelete(
    '确认删除',
    `确定要删除"${name}"吗？\n\n此操作无法恢复。`
  )

  if (confirmed) {
    // 执行删除操作
  }
}
```

### 3.2 确认对话框特点
- 标题：明确显示"确认删除"
- 内容：详细说明删除的对象和后果
- 确认按钮：红色（#EF4444），文字为"删除"
- 取消按钮：灰色，文字为"取消"
- 警告提示：明确说明"此操作无法恢复"

### 3.3 已实施的删除确认
- ✅ 计件记录删除（司机端）
- ✅ 仓库删除（超级管理端）
- ✅ 考勤规则删除（超级管理端）
- ✅ 计件品类删除（超级管理端）

## 4. 前端权限控制

### 4.1 页面访问控制
使用 `useAuth` Hook 进行页面级别的权限控制：

```typescript
import {useAuth} from 'miaoda-auth-taro'

const MyPage: React.FC = () => {
  const {user} = useAuth({guard: true}) // 需要登录才能访问
  // 页面内容
}
```

### 4.2 功能按钮显示控制
根据用户角色动态显示或隐藏操作按钮：

```typescript
// 示例：只有超级管理员才能看到删除按钮
{profile?.role === 'super_admin' && (
  <Button onClick={handleDelete}>删除</Button>
)}
```

### 4.3 数据筛选
- 超级管理员：可以查看所有仓库的数据
- 普通管理员：只能查看管辖仓库的数据
- 用户：只能查看自己的数据

## 5. 权限验证流程

### 5.1 后端验证（数据库层）
1. 用户登录后，Supabase Auth 生成 JWT Token
2. 每次数据库操作时，RLS 策略自动验证用户权限
3. 如果权限不足，操作被拒绝

### 5.2 前端验证（应用层）
1. 页面加载时，检查用户登录状态
2. 根据用户角色显示相应的功能
3. 操作前进行权限检查
4. 删除操作触发二次确认

## 6. 安全最佳实践

### 6.1 数据库层面
- ✅ 启用 Row Level Security (RLS)
- ✅ 为每个表创建细粒度的权限策略
- ✅ 使用辅助函数检查用户角色
- ✅ 禁止匿名访问敏感数据

### 6.2 应用层面
- ✅ 所有页面都需要登录才能访问
- ✅ 根据角色动态显示功能
- ✅ 删除操作必须二次确认
- ✅ 敏感操作显示加载状态和结果反馈

### 6.3 用户体验
- ✅ 清晰的权限提示信息
- ✅ 友好的错误提示
- ✅ 明确的操作确认对话框
- ✅ 实时的数据更新

## 7. 权限管理界面

### 7.1 超级管理端
- 位置：超级管理员主页 → 权限管理板块
- 功能：
  - 用户管理：查看和编辑所有用户
  - 仓库管理：管理所有仓库
  - 司机仓库分配：为司机分配仓库
  - 管理员仓库分配：为管理员分配管辖仓库
  - 计件品类管理：管理计件品类

### 7.2 数据报表
- 位置：超级管理员主页 → 数据报表
- 功能：
  - 按仓库筛选数据
  - 查看总体统计（司机总数、计件总额、考勤统计）
  - 查看按司机统计的详细数据
  - 导出数据（开发中）

## 8. 常见问题

### Q1: 普通管理员为什么不能修改数据？
A: 根据权限设计，普通管理员只负责查看和监督，数据录入由用户本人完成，确保数据的准确性和责任明确。

### Q2: 用户可以删除自己的历史数据吗？
A: 可以。用户有权管理自己的计件和考勤记录，包括删除操作。但删除操作会触发二次确认，防止误删。

### Q3: 超级管理员删除数据后可以恢复吗？
A: 不可以。所有删除操作都是永久性的，因此系统会在删除前进行二次确认，并明确提示"此操作无法恢复"。

### Q4: 如何查看我的权限？
A: 登录后，在个人信息页面可以看到您的角色。不同角色会看到不同的功能菜单。

### Q5: 如何申请更高的权限？
A: 请联系超级管理员，由超级管理员在用户管理页面修改您的角色。

## 9. 更新日志

### 2025-11-06
- ✅ 优化权限管理系统
- ✅ 恢复超级管理员完整权限（包括删除）
- ✅ 确保普通管理员只有查看权限
- ✅ 统一所有删除操作的二次确认对话框
- ✅ 创建 `confirmDelete` 工具函数
- ✅ 更新所有删除操作使用统一确认函数
- ✅ 完善权限策略文档

### 2025-11-05
- ✅ 创建基础权限系统
- ✅ 实现三级权限控制
- ✅ 添加 RLS 策略
- ✅ 实现角色检查函数
