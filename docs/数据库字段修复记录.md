# 数据库字段修复记录

## 修复日期
2025-11-22

## 问题描述
在车辆添加功能测试过程中，发现数据库 `vehicles` 表缺少多个字段，导致车辆信息保存失败。

## 缺失字段列表

### 1. damage_photos
- **字段类型**: `text[]`
- **用途**: 存储车损特写照片URL数组
- **迁移文件**: `00042_add_damage_photos_field.sql`
- **错误信息**: `Column 'damage_photos' of relation 'vehicles' does not exist`

### 2. driving_license_sub_back_photo
- **字段类型**: `text`
- **用途**: 存储行驶证副页背页照片URL
- **迁移文件**: `00043_add_driving_license_sub_back_photo.sql`
- **错误信息**: `Column 'driving_license_sub_back_photo' of relation 'vehicles' does not exist`

### 3. pickup_photos
- **字段类型**: `text[]`
- **用途**: 存储提车照片URL数组
- **迁移文件**: `00044_add_pickup_and_registration_fields.sql`

### 4. pickup_time
- **字段类型**: `timestamptz`
- **用途**: 记录提车时间
- **迁移文件**: `00044_add_pickup_and_registration_fields.sql`

### 5. registration_photos
- **字段类型**: `text[]`
- **用途**: 存储行驶证照片URL数组
- **迁移文件**: `00044_add_pickup_and_registration_fields.sql`

### 6. return_photos
- **字段类型**: `text[]`
- **用途**: 存储还车照片URL数组
- **迁移文件**: `00044_add_pickup_and_registration_fields.sql`

### 7. return_time
- **字段类型**: `timestamptz`
- **用途**: 记录还车时间
- **迁移文件**: `00044_add_pickup_and_registration_fields.sql`

## 修复措施

### 迁移文件创建
创建了以下迁移文件来添加缺失的字段：

1. **00042_add_damage_photos_field.sql**
   - 添加 `damage_photos` 字段

2. **00043_add_driving_license_sub_back_photo.sql**
   - 添加 `driving_license_sub_back_photo` 字段

3. **00044_add_pickup_and_registration_fields.sql**
   - 添加 `pickup_photos` 字段
   - 添加 `pickup_time` 字段
   - 添加 `registration_photos` 字段
   - 添加 `return_photos` 字段
   - 添加 `return_time` 字段

### 迁移应用
所有迁移文件已成功应用到数据库，字段已添加完成。

## 验证结果
- ✅ 所有缺失字段已添加到 `vehicles` 表
- ✅ 字段类型和约束符合业务需求
- ✅ 添加了字段注释，便于维护
- ✅ 车辆添加功能现在应该可以正常工作

## 相关文件
- 迁移文件目录: `/supabase/migrations/`
- 类型定义文件: `/src/db/types.ts`
- 车辆添加页面: `/src/pages/driver/add-vehicle/index.tsx`

## 注意事项
1. 这些字段都是可选字段（nullable），不会影响现有数据
2. 数组类型字段（text[]）可以存储多个URL
3. 时间戳字段使用 `timestamptz` 类型，包含时区信息

## RLS 策略修复

### 问题描述
在添加完缺失字段后，测试发现新的错误：
```
new row violates row-level security policy for table "vehicles"
```

这是因为 vehicles 表的 RLS 策略不完整，只允许超级管理员管理车辆，司机无法插入自己的车辆。

### 修复措施
创建迁移文件 `00045_fix_vehicles_rls_policies.sql`，添加以下策略：

1. **司机可以插入自己的车辆**
   - 策略名: `Drivers can insert their own vehicles`
   - 操作: INSERT
   - 条件: `auth.uid() = user_id`

2. **司机可以更新自己的车辆**
   - 策略名: `Drivers can update their own vehicles`
   - 操作: UPDATE
   - 条件: `auth.uid() = user_id`

3. **管理员可以更新自己负责仓库的车辆**
   - 策略名: `Managers can update vehicles in their warehouses`
   - 操作: UPDATE
   - 条件: 管理员负责该车辆所属的仓库

4. **管理员可以查看自己负责仓库的车辆**
   - 策略名: `Managers can view vehicles in their warehouses`
   - 操作: SELECT
   - 条件: 管理员负责该车辆所属的仓库

### 验证结果
- ✅ 司机现在可以添加自己的车辆
- ✅ 司机可以更新自己的车辆信息
- ✅ 管理员可以查看和审核自己负责仓库的车辆
- ✅ 超级管理员保持对所有车辆的完全访问权限

## 后续建议
1. 在开发新功能时，确保数据库迁移文件与类型定义保持同步
2. 建议在代码审查时检查类型定义和数据库结构的一致性
3. 考虑添加自动化测试来验证数据库字段的完整性
4. **重要**：在创建新表时，务必同时设计完整的 RLS 策略，包括所有角色的权限
