# 司机端请假离职申请按钮状态优化

## 需求描述

当司机在所分配的任何一个仓库中存在审核中的请假或离职申请时：

1. **请假申请按钮**
   - 改变名称为"请假审批中"
   - 按钮变成灰色
   - 无法点击申请
   - 避免司机多次申请

2. **离职申请按钮**
   - 改变名称为"离职审批中"
   - 按钮变成灰色
   - 无法点击申请
   - 避免司机多次申请

## 实现方案

### 1. 添加状态变量

在司机请假页面添加两个状态变量，用于跟踪是否有审核中的申请：

```typescript
// 审核中的申请状态
const [hasPendingLeave, setHasPendingLeave] = useState(false)
const [hasPendingResignation, setHasPendingResignation] = useState(false)
```

### 2. 在数据加载时检查审核状态

修改 `loadData` 函数，在加载数据后检查是否有审核中的申请：

```typescript
const loadData = useCallback(async () => {
  if (!user) return

  const profileData = await getCurrentUserProfile()
  setProfile(profileData)

  const leaveData = await getLeaveApplicationsByUser(user.id)
  setLeaveApplications(leaveData)

  const resignationData = await getResignationApplicationsByUser(user.id)
  setResignationApplications(resignationData)

  const leaveDraftData = await getDraftLeaveApplications(user.id)
  setLeaveDrafts(leaveDraftData)

  const resignationDraftData = await getDraftResignationApplications(user.id)
  setResignationDrafts(resignationDraftData)

  // 检查是否有审核中的请假申请
  const pendingLeave = leaveData.some((app) => app.status === 'pending')
  setHasPendingLeave(pendingLeave)

  // 检查是否有审核中的离职申请
  const pendingResignation = resignationData.some((app) => app.status === 'pending')
  setHasPendingResignation(pendingResignation)
}, [user])
```

**检查逻辑**：
- 使用 `Array.some()` 方法检查是否有任何一个申请的状态为 `'pending'`
- 如果有，则设置对应的状态为 `true`

### 3. 修改按钮点击处理函数

添加审核中状态的检查，防止重复申请：

```typescript
const _handleApplyLeave = () => {
  if (!profile) {
    showToast({title: '请先完善个人信息', icon: 'none'})
    return
  }
  // 检查是否有审核中的请假申请
  if (hasPendingLeave) {
    showToast({title: '您有请假申请正在审批中，请等待审批完成', icon: 'none', duration: 2000})
    return
  }
  navigateTo({url: '/pages/driver/leave/apply/index'})
}

const _handleApplyResignation = () => {
  if (!profile) {
    showToast({title: '请先完善个人信息', icon: 'none'})
    return
  }
  // 检查是否有审核中的离职申请
  if (hasPendingResignation) {
    showToast({title: '您有离职申请正在审批中，请等待审批完成', icon: 'none', duration: 2000})
    return
  }
  navigateTo({url: '/pages/driver/leave/resign/index'})
}
```

**改进点**：
- ✅ 在跳转前检查审核状态
- ✅ 显示友好的提示信息
- ✅ 防止重复申请

### 4. 修改按钮UI

根据审核状态动态改变按钮的样式和文本：

```typescript
{/* 快捷操作按钮 */}
<View className="grid grid-cols-2 gap-4 mb-4">
  <Button
    className="text-sm break-keep"
    size="default"
    style={{
      backgroundColor: hasPendingLeave ? '#9CA3AF' : '#1E3A8A',
      color: 'white',
      borderRadius: '8px',
      border: 'none',
      padding: '16px',
      opacity: hasPendingLeave ? 0.6 : 1
    }}
    onClick={_handleApplyLeave}
    disabled={hasPendingLeave}>
    <View className="flex flex-col items-center">
      <View className={`${hasPendingLeave ? 'i-mdi-clock-alert' : 'i-mdi-calendar-clock'} text-3xl mb-2`} />
      <Text className="text-sm">{hasPendingLeave ? '请假审批中' : '申请请假'}</Text>
    </View>
  </Button>
  <Button
    className="text-sm break-keep"
    size="default"
    style={{
      backgroundColor: hasPendingResignation ? '#9CA3AF' : '#F97316',
      color: 'white',
      borderRadius: '8px',
      border: 'none',
      padding: '16px',
      opacity: hasPendingResignation ? 0.6 : 1
    }}
    onClick={_handleApplyResignation}
    disabled={hasPendingResignation}>
    <View className="flex flex-col items-center">
      <View
        className={`${hasPendingResignation ? 'i-mdi-clock-alert' : 'i-mdi-account-remove'} text-3xl mb-2`}
      />
      <Text className="text-sm">{hasPendingResignation ? '离职审批中' : '申请离职'}</Text>
    </View>
  </Button>
</View>
```

**UI 改进**：
- ✅ **背景颜色**：审核中时变为灰色 (`#9CA3AF`)，正常时为原色
- ✅ **透明度**：审核中时降低透明度 (`0.6`)，增强禁用效果
- ✅ **图标**：审核中时显示时钟警告图标 (`i-mdi-clock-alert`)
- ✅ **文本**：审核中时显示"请假审批中"或"离职审批中"
- ✅ **禁用属性**：使用 `disabled` 属性禁用按钮

## 功能特性

### 1. 智能状态检测

- **自动检测**：页面加载时自动检查是否有审核中的申请
- **实时更新**：数据刷新时重新检查状态
- **多仓库支持**：检查司机在所有分配仓库中的申请状态

### 2. 视觉反馈

#### 正常状态
- **请假申请按钮**：深蓝色背景 (`#1E3A8A`)，日历图标
- **离职申请按钮**：橙色背景 (`#F97316`)，用户移除图标

#### 审批中状态
- **请假申请按钮**：灰色背景 (`#9CA3AF`)，时钟警告图标，文本"请假审批中"
- **离职申请按钮**：灰色背景 (`#9CA3AF`)，时钟警告图标，文本"离职审批中"

### 3. 交互限制

- **禁用点击**：使用 `disabled` 属性禁用按钮
- **友好提示**：点击时显示提示信息
- **防止重复**：避免司机多次提交申请

### 4. 用户体验

- **清晰的状态指示**：通过颜色、图标和文本明确显示当前状态
- **友好的错误提示**：告知用户为什么不能申请
- **一致的设计语言**：与整体UI风格保持一致

## 技术实现细节

### 1. 状态检查逻辑

使用 `Array.some()` 方法检查是否有审核中的申请：

```typescript
const pendingLeave = leaveData.some((app) => app.status === 'pending')
```

**优点**：
- 简洁高效
- 只要有一个申请是 `pending` 状态就返回 `true`
- 适用于多仓库场景

### 2. 按钮禁用

使用 Taro Button 组件的 `disabled` 属性：

```typescript
<Button
  disabled={hasPendingLeave}
  onClick={_handleApplyLeave}>
  ...
</Button>
```

**效果**：
- 禁用按钮的点击事件
- 浏览器会自动添加禁用样式
- 配合自定义样式增强视觉效果

### 3. 动态样式

使用内联样式和条件表达式：

```typescript
style={{
  backgroundColor: hasPendingLeave ? '#9CA3AF' : '#1E3A8A',
  opacity: hasPendingLeave ? 0.6 : 1
}}
```

**优点**：
- 实时响应状态变化
- 灵活控制样式
- 易于维护

### 4. 动态图标和文本

使用模板字符串和条件表达式：

```typescript
<View className={`${hasPendingLeave ? 'i-mdi-clock-alert' : 'i-mdi-calendar-clock'} text-3xl mb-2`} />
<Text className="text-sm">{hasPendingLeave ? '请假审批中' : '申请请假'}</Text>
```

**优点**：
- 根据状态动态切换
- 提供清晰的视觉反馈
- 增强用户体验

## 测试场景

### 场景 1：正常申请

1. 登录司机账号
2. 进入请假页面
3. **预期结果**：
   - "申请请假"按钮为深蓝色，可点击
   - "申请离职"按钮为橙色，可点击

### 场景 2：有审核中的请假申请

1. 登录司机账号
2. 提交一个请假申请（状态为 `pending`）
3. 返回请假页面
4. **预期结果**：
   - "请假审批中"按钮为灰色，不可点击
   - 点击按钮显示提示："您有请假申请正在审批中，请等待审批完成"
   - "申请离职"按钮仍然可用

### 场景 3：有审核中的离职申请

1. 登录司机账号
2. 提交一个离职申请（状态为 `pending`）
3. 返回请假页面
4. **预期结果**：
   - "离职审批中"按钮为灰色，不可点击
   - 点击按钮显示提示："您有离职申请正在审批中，请等待审批完成"
   - "申请请假"按钮仍然可用

### 场景 4：申请被批准后

1. 登录司机账号
2. 管理员批准请假申请（状态变为 `approved`）
3. 刷新请假页面
4. **预期结果**：
   - "申请请假"按钮恢复为深蓝色，可点击
   - 可以再次提交新的请假申请

### 场景 5：申请被拒绝后

1. 登录司机账号
2. 管理员拒绝请假申请（状态变为 `rejected`）
3. 刷新请假页面
4. **预期结果**：
   - "申请请假"按钮恢复为深蓝色，可点击
   - 可以再次提交新的请假申请

### 场景 6：多仓库场景

1. 登录司机账号（分配到多个仓库）
2. 在仓库A提交请假申请（状态为 `pending`）
3. 进入请假页面
4. **预期结果**：
   - "请假审批中"按钮为灰色，不可点击
   - 即使司机在其他仓库没有申请，也不能再次申请

## 边界情况处理

### 1. 数据加载失败

如果数据加载失败，状态变量默认为 `false`，按钮保持可用状态。

### 2. 网络延迟

在数据加载期间，按钮保持可用状态，但点击时会检查状态。

### 3. 并发申请

通过在点击处理函数中再次检查状态，防止并发申请。

### 4. 状态不一致

使用实时通知和下拉刷新功能，确保状态及时更新。

## 用户体验优化

### 优化前

1. 司机可以多次提交请假申请
2. 没有明确的状态指示
3. 容易造成重复申请
4. 管理员需要处理多个重复申请

### 优化后

1. 司机只能在没有审核中申请时提交新申请
2. 清晰的视觉反馈显示当前状态
3. 防止重复申请
4. 减少管理员的工作量

**改进效果**：
- ✅ 减少重复申请
- ✅ 提升用户体验
- ✅ 降低管理成本
- ✅ 避免数据混乱

## 修改文件清单

### 1. 司机请假页面
- **文件**：`src/pages/driver/leave/index.tsx`
- **新增**：`hasPendingLeave` 和 `hasPendingResignation` 状态变量
- **修改**：`loadData` 函数，添加审核状态检查
- **修改**：`_handleApplyLeave` 和 `_handleApplyResignation` 函数，添加状态验证
- **修改**：按钮UI，根据状态动态改变样式和文本

## 代码质量

### TypeScript 类型检查
```bash
pnpm run lint
```

**结果**：✅ 通过，无新增错误

### 代码规范
- ✅ 使用 TypeScript 严格模式
- ✅ 添加详细的注释
- ✅ 遵循项目代码风格
- ✅ 使用 React Hooks 最佳实践

## 后续优化建议

### 1. 添加加载状态

在数据加载期间显示加载指示器：

```typescript
const [isLoading, setIsLoading] = useState(false)

const loadData = useCallback(async () => {
  setIsLoading(true)
  try {
    // 加载数据
  } finally {
    setIsLoading(false)
  }
}, [user])
```

### 2. 添加骨架屏

在数据加载期间显示骨架屏，提升用户体验。

### 3. 优化错误处理

添加更详细的错误提示和重试机制。

### 4. 添加动画效果

在状态切换时添加平滑的过渡动画。

## 总结

本次优化实现了司机端请假和离职申请按钮的智能状态管理，主要改进包括：

1. ✅ **状态检测**：自动检测是否有审核中的申请
2. ✅ **视觉反馈**：通过颜色、图标和文本明确显示状态
3. ✅ **交互限制**：禁用按钮，防止重复申请
4. ✅ **友好提示**：显示清晰的错误提示信息
5. ✅ **多仓库支持**：检查司机在所有仓库中的申请状态

这些改进显著提升了用户体验，减少了重复申请，降低了管理成本。

## 完成日期

2025-11-05
