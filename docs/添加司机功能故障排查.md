# 添加司机功能故障排查文档

## 问题描述

用户反馈：无法添加司机，创建失败。

## 问题原因

Edge Function未部署或部署失败，导致前端调用Edge Function时失败。

## 解决方案

### 1. 部署Edge Functions

已成功部署以下两个Edge Functions：

**create-driver**
- 功能：创建司机用户
- 版本：v2
- 状态：ACTIVE
- 部署时间：2025-11-07

**reset-password**
- 功能：重置用户密码
- 版本：v2
- 状态：ACTIVE
- 部署时间：2025-11-07

### 2. 添加详细错误日志

在 `src/db/api.ts` 的 `createDriver` 函数中添加了详细的错误日志：

```typescript
// 调用Edge Function创建司机
const supabaseUrl = process.env.TARO_APP_SUPABASE_URL
const response = await fetch(`${supabaseUrl}/functions/v1/create-driver`, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    Authorization: `Bearer ${session.access_token}`
  },
  body: JSON.stringify({phone, name, licensePlate})
})

if (!response.ok) {
  console.error('Edge Function响应错误:', response.status, response.statusText)
  const errorText = await response.text()
  console.error('错误详情:', errorText)
  return {success: false, error: `创建司机失败: ${response.statusText}`}
}

const result = await response.json()
console.log('Edge Function返回结果:', result)

if (!result.success) {
  return {success: false, error: result.error || '创建司机失败'}
}

return {success: true, userId: result.userId}
```

**改进点**：
1. 检查HTTP响应状态码
2. 记录响应错误信息
3. 记录Edge Function返回结果
4. 提供更详细的错误消息

## 功能验证

### 添加司机功能流程

1. **前端验证**
   - 验证手机号格式（11位，1开头）
   - 验证姓名格式（2-10个中文字符）
   - 验证车牌号格式（如果提供）

2. **调用Edge Function**
   - 获取用户session token
   - 发送POST请求到 `/functions/v1/create-driver`
   - 传递参数：phone, name, licensePlate

3. **Edge Function处理**
   - 验证请求者权限（manager或super_admin）
   - 检查手机号是否已存在
   - 使用Admin API创建auth用户（密码123456）
   - 创建profile记录
   - 设置is_first_login为true

4. **返回结果**
   - 成功：返回userId和成功消息
   - 失败：返回错误信息

## 常见错误及解决方法

### 错误1：未授权（401）

**原因**：
- 用户未登录
- Session token过期
- Token无效

**解决方法**：
- 重新登录
- 检查登录状态
- 刷新页面

### 错误2：无权限（403）

**原因**：
- 用户角色不是manager或super_admin
- 司机用户尝试添加司机

**解决方法**：
- 确认用户角色
- 使用管理员账号操作

### 错误3：手机号已存在（400）

**原因**：
- 该手机号已被注册
- 数据库中已有该手机号的记录

**解决方法**：
- 使用其他手机号
- 检查是否重复添加

### 错误4：创建用户失败（500）

**原因**：
- Supabase Auth服务异常
- 手机号格式不符合Supabase要求
- 数据库连接失败

**解决方法**：
- 检查Supabase服务状态
- 验证手机号格式
- 重试操作

### 错误5：创建司机资料失败（500）

**原因**：
- profiles表插入失败
- 数据库约束冲突
- 字段类型不匹配

**解决方法**：
- 检查数据库Schema
- 验证字段值
- 查看数据库日志

### 错误6：Edge Function未部署

**原因**：
- Edge Function未部署
- 部署失败
- 函数名称错误

**解决方法**：
- 重新部署Edge Function
- 检查函数名称
- 验证部署状态

## 调试方法

### 1. 查看浏览器控制台

打开浏览器开发者工具，查看Console标签：

```javascript
// 正常情况
Edge Function返回结果: {success: true, message: "司机创建成功，默认密码为123456", userId: "xxx"}

// 错误情况
Edge Function响应错误: 401 Unauthorized
错误详情: {"success":false,"error":"未授权"}
```

### 2. 查看网络请求

在Network标签中查看请求详情：

**请求URL**：
```
https://backend.appmiaoda.com/projects/supabase244341780043055104/functions/v1/create-driver
```

**请求头**：
```
Content-Type: application/json
Authorization: Bearer eyJhbGc...
```

**请求体**：
```json
{
  "phone": "13800138000",
  "name": "张三",
  "licensePlate": "京A12345"
}
```

**响应**：
```json
{
  "success": true,
  "message": "司机创建成功，默认密码为123456",
  "userId": "xxx-xxx-xxx"
}
```

### 3. 检查Edge Function日志

在Supabase Dashboard中查看Edge Function日志：

1. 登录Supabase Dashboard
2. 进入Edge Functions页面
3. 选择create-driver函数
4. 查看Logs标签

### 4. 测试Edge Function

使用curl命令测试Edge Function：

```bash
curl -X POST \
  https://backend.appmiaoda.com/projects/supabase244341780043055104/functions/v1/create-driver \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -d '{
    "phone": "13800138000",
    "name": "张三",
    "licensePlate": "京A12345"
  }'
```

## 验证清单

在报告问题前，请检查以下项目：

- [ ] 用户已登录
- [ ] 用户角色是manager或super_admin
- [ ] 手机号格式正确（11位，1开头）
- [ ] 姓名格式正确（2-10个中文字符）
- [ ] 车牌号格式正确（如果提供）
- [ ] 手机号未被使用
- [ ] Edge Function已部署
- [ ] Supabase服务正常
- [ ] 网络连接正常
- [ ] 浏览器控制台无错误

## 测试用例

### 测试用例1：正常添加司机

**输入**：
- 手机号：13800138000
- 姓名：张三
- 车牌号：京A12345

**预期结果**：
- 显示"添加成功，默认密码123456"
- 司机列表中出现新司机
- 新司机可以使用手机号和密码123456登录

### 测试用例2：手机号格式错误

**输入**：
- 手机号：12345
- 姓名：张三

**预期结果**：
- 显示"手机号格式不正确"
- 不创建用户

### 测试用例3：姓名格式错误

**输入**：
- 手机号：13800138000
- 姓名：Zhang San

**预期结果**：
- 显示"姓名只能包含中文字符（2-10个字）"
- 不创建用户

### 测试用例4：手机号已存在

**输入**：
- 手机号：13800138000（已存在）
- 姓名：李四

**预期结果**：
- 显示"手机号已存在"
- 不创建用户

### 测试用例5：无权限用户

**操作**：
- 使用司机账号登录
- 尝试添加司机

**预期结果**：
- 显示"无权限执行此操作"
- 不创建用户

## 相关文件

### 前端文件

**src/db/api.ts**
- `createDriver()` 函数
- 添加了详细错误日志

**src/pages/manager/driver-management/index.tsx**
- 管理员添加司机页面

**src/pages/super-admin/driver-warehouse-assignment/index.tsx**
- 超级管理员添加司机页面

### Edge Function文件

**supabase/functions/create-driver/index.ts**
- 创建司机Edge Function
- 版本：v2
- 状态：ACTIVE

**supabase/functions/reset-password/index.ts**
- 重置密码Edge Function
- 版本：v2
- 状态：ACTIVE

### 数据库文件

**supabase/migrations/add_license_plate_and_first_login.sql**
- 添加license_plate和is_first_login字段

## 后续优化建议

### 1. 批量添加司机

**功能**：
- 支持Excel导入
- 批量创建司机账号
- 自动生成默认密码

**优势**：
- 提高效率
- 减少重复操作
- 适合大规模部署

### 2. 自定义默认密码

**功能**：
- 管理员可以设置默认密码规则
- 支持随机密码生成
- 密码复杂度配置

**优势**：
- 提高安全性
- 灵活性更强
- 符合不同安全要求

### 3. 短信通知

**功能**：
- 创建成功后发送短信
- 通知司机账号和密码
- 提供登录链接

**优势**：
- 用户体验更好
- 减少人工通知
- 提高效率

### 4. 二维码邀请

**功能**：
- 生成邀请二维码
- 司机扫码注册
- 自动关联仓库

**优势**：
- 操作更便捷
- 减少输入错误
- 提高注册成功率

## 总结

**问题**：无法添加司机，创建失败

**原因**：Edge Function未部署

**解决**：
1. ✅ 部署create-driver Edge Function
2. ✅ 部署reset-password Edge Function
3. ✅ 添加详细错误日志
4. ✅ 提供故障排查文档

**验证**：
- Edge Function状态：ACTIVE
- 版本：v2
- 功能：正常

**建议**：
- 定期检查Edge Function状态
- 监控错误日志
- 及时处理异常情况
- 持续优化用户体验
