# 普通管理员计件管理功能说明

## 功能概述

普通管理员计件管理功能是车队管家小程序的核心功能之一，为普通管理员提供了完整的计件记录管理能力。该功能支持多仓库数据处理、司机筛选、记录添加、详情查看和删除等操作，确保管理员能够高效地管理和监控司机的计件工作。

## 功能特点

### 1. 功能一致性
- ✅ 与司机端计件记录页面功能对等
- ✅ 精确的时间记录功能
- ✅ 详细的费用明细组成展示
- ✅ 完整的数据验证机制

### 2. 多仓库数据处理
- ✅ 支持管理员管辖多个仓库
- ✅ 提供仓库选择功能
- ✅ 选择仓库后数据实时动态更新
- ✅ 支持查看所有仓库的汇总数据

### 3. 记录详情查看优化
- ✅ 每条计件记录支持点击查看
- ✅ 弹窗展示完整详细信息
- ✅ 包含所有费用明细组成
- ✅ 直观易用的界面设计

### 4. 技术要求
- ✅ 数据实时同步更新
- ✅ 弹窗设计直观易用
- ✅ 页面响应速度快
- ✅ 满足实时操作需求

## 功能入口

### 主页入口
1. 登录普通管理员账号
2. 在管理员工作台页面
3. 找到"管理功能"区域
4. 点击"计件管理"图标

### 入口位置
- **位置**：管理功能区域第二行第一个
- **图标**：橙色背景，剪贴板编辑图标
- **文字**：计件管理

## 主要功能

### 1. 仓库筛选

**功能说明**：
- 管理员可以选择查看特定仓库或所有仓库的计件记录
- 支持快速切换不同仓库的数据视图

**操作步骤**：
1. 在筛选条件区域找到"仓库"选择器
2. 点击选择器打开仓库列表
3. 选择"所有仓库"或特定仓库名称
4. 数据自动更新显示

**选项说明**：
- **所有仓库**：显示管理员管辖的所有仓库的计件记录
- **特定仓库**：只显示选中仓库的计件记录

### 2. 司机筛选

**功能说明**：
- 可以筛选特定司机的计件记录
- 支持查看所有司机的汇总数据

**操作步骤**：
1. 在筛选条件区域找到"司机"选择器
2. 点击选择器打开司机列表
3. 选择"所有司机"或特定司机名称
4. 数据自动更新显示

**选项说明**：
- **所有司机**：显示所有司机的计件记录
- **特定司机**：只显示选中司机的计件记录

### 3. 日期范围筛选

**功能说明**：
- 支持自定义日期范围查询
- 提供快捷筛选按钮

**操作步骤**：
1. **自定义日期**：
   - 点击"开始日期"选择器，选择起始日期
   - 点击"结束日期"选择器，选择结束日期
   - 数据自动更新

2. **快捷筛选**：
   - **前一天**：查看前一天的记录（蓝色按钮）
   - **本周**：查看本周的记录（绿色按钮）
   - **本月**：查看本月的记录（橙色按钮，默认选中）

**快捷筛选说明**：
- 点击快捷筛选按钮后，日期范围自动设置
- 当前激活的筛选按钮会高亮显示
- 手动修改日期后，快捷筛选状态变为"自定义"

### 4. 统计数据展示

**功能说明**：
- 实时显示当前筛选条件下的统计数据
- 包含总件数和总金额

**统计卡片**：
1. **总件数**：
   - 显示所有记录的数量总和
   - 蓝色图标和数字
   - 单位：件

2. **总金额**：
   - 显示所有记录的金额总和
   - 橙色图标和数字
   - 单位：元（保留两位小数）

### 5. 添加计件记录

**功能说明**：
- 管理员可以为任意司机添加计件记录
- 支持完整的费用明细录入

**操作步骤**：
1. 点击"添加计件记录"按钮
2. 填写表单信息：
   - **司机**：选择要添加记录的司机（必填）
   - **仓库**：选择工作仓库（必填）
   - **品类**：选择计件品类（必填）
   - **工作日期**：选择工作日期（必填）
   - **工作时间**：选择工作时间（必填）
   - **数量**：输入计件数量（必填）
   - **单价**：输入单价（必填）
   - **是否需要上楼**：开关选择
   - **上楼费**：如需上楼，输入上楼费（必填）
   - **是否需要分拣**：开关选择
   - **分拣数量**：如需分拣，输入分拣数量（必填）
   - **分拣单价**：如需分拣，输入分拣单价（必填）
   - **备注**：输入备注信息（可选）
3. 查看预计总金额
4. 点击"保存"按钮提交

**费用计算规则**：
```
总金额 = (数量 × 单价) + 上楼费 + (分拣数量 × 分拣单价)
```

**表单验证**：
- 所有必填字段必须填写
- 数量和单价必须大于0
- 如果选择需要上楼，上楼费必须大于0
- 如果选择需要分拣，分拣数量和单价必须大于0

### 6. 查看记录详情

**功能说明**：
- 点击任意计件记录可查看完整详情
- 弹窗展示所有信息

**操作步骤**：
1. 在记录列表中点击任意记录卡片
2. 弹窗自动打开显示详情
3. 查看完毕后点击"关闭"按钮或弹窗外部区域

**详情内容**：
1. **司机信息**：司机姓名或手机号
2. **工作日期**：记录的工作日期
3. **仓库**：工作仓库名称
4. **品类**：计件品类名称和是否需要上楼标识
5. **费用明细**：
   - 数量（件）
   - 单价（元）
   - 基础费用（数量 × 单价）
   - 上楼费（如有）
   - 分拣费（如有，分拣数量 × 分拣单价）
   - **总金额**（加粗显示）
6. **备注**：备注信息（如有）
7. **创建时间**：记录创建的时间

**详情弹窗特点**：
- 清晰的视觉层级
- 不同费用类型用不同颜色区分
- 总金额突出显示
- 支持点击外部区域关闭

### 7. 删除记录

**功能说明**：
- 管理员可以删除任意计件记录
- 删除前需要确认

**操作步骤**：
1. 在记录列表中找到要删除的记录
2. 点击记录右上角的红色删除图标
3. 在确认对话框中点击"确定"
4. 系统显示删除成功提示
5. 记录列表自动更新

**注意事项**：
- ⚠️ 删除操作不可恢复
- ⚠️ 请谨慎操作
- ⚠️ 删除前请确认记录信息

### 8. 排序功能

**功能说明**：
- 支持按日期升序或降序排列
- 快速切换排序方式

**操作步骤**：
1. 在记录列表标题栏找到排序按钮
2. 点击排序按钮切换排序方式
3. 记录列表自动重新排列

**排序选项**：
- **降序**：最新的记录在前（默认）
- **升序**：最早的记录在前

## 界面布局

### 页面结构

```
┌─────────────────────────────────────┐
│         计件管理                     │
│    管理和查看计件记录                │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│  筛选条件                            │
│                                     │
│  仓库: [所有仓库 ▼]                  │
│  司机: [所有司机 ▼]                  │
│                                     │
│  开始日期: [2025-01-01 📅]           │
│  结束日期: [2025-01-31 📅]           │
│                                     │
│  [前一天] [本周] [本月]              │
└─────────────────────────────────────┘

┌──────────────────┬──────────────────┐
│  总件数          │  总金额           │
│  📦 120          │  💰 ¥2,400.00    │
└──────────────────┴──────────────────┘

┌─────────────────────────────────────┐
│  ➕ 添加计件记录                     │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│  计件记录                共 10 条    │
│                         [排序 ▼]    │
│                                     │
│  ┌─────────────────────────────┐   │
│  │ 👤 张三        2025-01-15   │🗑│ │
│  │ 🏢 北京仓库                  │   │
│  │ 🏷️ 标准件  [需上楼]          │   │
│  │ 数量: 10  单价: ¥20  上楼: ¥5│   │
│  │ 总计: ¥205.00                │   │
│  └─────────────────────────────┘   │
│                                     │
│  [更多记录...]                       │
└─────────────────────────────────────┘
```

### 详情弹窗布局

```
┌─────────────────────────────────────┐
│  计件记录详情                    ✕  │
├─────────────────────────────────────┤
│                                     │
│  司机                                │
│  张三                                │
│                                     │
│  工作日期                            │
│  2025-01-15                         │
│                                     │
│  仓库                                │
│  北京仓库                            │
│                                     │
│  品类                                │
│  标准件  [需上楼]                    │
│                                     │
│  费用明细                            │
│  ┌─────────────────────────────┐   │
│  │ 数量              10 件      │   │
│  │ 单价              ¥20.00     │   │
│  │ 基础费用          ¥200.00    │   │
│  │ 上楼费            ¥5.00      │   │
│  │ ─────────────────────────── │   │
│  │ 总金额            ¥205.00    │   │
│  └─────────────────────────────┘   │
│                                     │
│  备注                                │
│  无                                  │
│                                     │
│  创建时间                            │
│  2025-01-15 14:30                   │
│                                     │
│  ┌─────────────────────────────┐   │
│  │          关闭                │   │
│  └─────────────────────────────┘   │
└─────────────────────────────────────┘
```

### 添加记录表单布局

```
┌─────────────────────────────────────┐
│         添加计件记录                 │
│    填写计件信息                      │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│  司机 *                              │
│  [请选择司机 ▼]                      │
│                                     │
│  仓库 *                              │
│  [请选择仓库 ▼]                      │
│                                     │
│  品类 *                              │
│  [请选择品类 ▼]                      │
│                                     │
│  工作日期 *                          │
│  [2025-01-15 📅]                    │
│                                     │
│  工作时间 *                          │
│  [14:30 🕐]                         │
│                                     │
│  数量 *                              │
│  [请输入数量]                        │
│                                     │
│  单价（元）*                         │
│  [请输入单价]                        │
│                                     │
│  是否需要上楼          [开关]        │
│                                     │
│  上楼费（元）*                       │
│  [请输入上楼费]                      │
│                                     │
│  是否需要分拣          [开关]        │
│                                     │
│  分拣数量 *                          │
│  [请输入分拣数量]                    │
│                                     │
│  分拣单价（元）*                     │
│  [请输入分拣单价]                    │
│                                     │
│  备注                                │
│  [请输入备注信息（可选）]            │
│                                     │
│  ┌─────────────────────────────┐   │
│  │ 预计总金额      ¥205.00      │   │
│  └─────────────────────────────┘   │
└─────────────────────────────────────┘

┌──────────────────┬──────────────────┐
│      取消        │      保存        │
└──────────────────┴──────────────────┘
```

## 数据流程

### 1. 数据加载流程

```
用户打开页面
    ↓
加载管理员信息
    ↓
加载管辖的仓库列表
    ↓
加载所有司机列表
    ↓
加载所有品类列表
    ↓
根据筛选条件加载计件记录
    ↓
计算统计数据
    ↓
显示页面内容
```

### 2. 筛选更新流程

```
用户修改筛选条件
    ↓
更新筛选状态
    ↓
重新加载计件记录
    ↓
重新计算统计数据
    ↓
更新页面显示
```

### 3. 添加记录流程

```
用户点击添加按钮
    ↓
跳转到表单页面
    ↓
用户填写表单
    ↓
实时计算总金额
    ↓
用户点击保存
    ↓
验证表单数据
    ↓
提交到数据库
    ↓
显示成功提示
    ↓
返回列表页面
    ↓
自动刷新数据
```

### 4. 删除记录流程

```
用户点击删除按钮
    ↓
显示确认对话框
    ↓
用户确认删除
    ↓
从数据库删除记录
    ↓
显示成功提示
    ↓
自动刷新列表
    ↓
更新统计数据
```

## 技术实现

### 1. 多仓库数据处理

**实现方式**：
- 使用 `getManagerWarehouses()` 获取管理员管辖的仓库
- 支持选择单个仓库或所有仓库
- 根据选择动态加载对应的计件记录

**代码示例**：
```typescript
// 加载管辖的仓库
const warehousesData = await getManagerWarehouses(user.id)
setWarehouses(warehousesData)

// 加载记录时根据仓库筛选
if (selectedWarehouseIndex > 0) {
  // 加载特定仓库的记录
  const warehouse = warehouses[selectedWarehouseIndex - 1]
  data = await getPieceWorkRecordsByWarehouse(warehouse.id, startDate, endDate)
} else {
  // 加载所有仓库的记录
  const allRecords = await Promise.all(
    warehouses.map((w) => getPieceWorkRecordsByWarehouse(w.id, startDate, endDate))
  )
  data = allRecords.flat()
}
```

### 2. 实时数据更新

**实现方式**：
- 使用 `useEffect` 监听筛选条件变化
- 使用 `useDidShow` 在页面显示时刷新数据
- 使用 `useCallback` 优化函数性能

**代码示例**：
```typescript
// 监听筛选条件变化
useEffect(() => {
  loadRecords()
}, [loadRecords])

// 页面显示时刷新
useDidShow(() => {
  loadData()
})

// 使用 useCallback 优化
const loadRecords = useCallback(async () => {
  // 加载数据逻辑
}, [startDate, endDate, warehouses, drivers, selectedWarehouseIndex, selectedDriverIndex, sortOrder])
```

### 3. 详情弹窗实现

**实现方式**：
- 使用固定定位的遮罩层
- 点击记录时设置选中状态并显示弹窗
- 支持点击外部区域关闭

**代码示例**：
```typescript
// 查看详情
const handleViewDetail = (record: PieceWorkRecord) => {
  setSelectedRecord(record)
  setShowDetailModal(true)
}

// 关闭详情
const handleCloseDetail = () => {
  setShowDetailModal(false)
  setSelectedRecord(null)
}

// 弹窗组件
{showDetailModal && selectedRecord && (
  <View
    className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
    onClick={handleCloseDetail}>
    <View
      className="bg-white rounded-lg p-6 m-4 max-w-md w-full"
      onClick={(e) => e.stopPropagation()}>
      {/* 详情内容 */}
    </View>
  </View>
)}
```

### 4. 表单验证

**实现方式**：
- 在保存前进行完整的数据验证
- 使用 Toast 提示验证错误
- 实时计算总金额预览

**代码示例**：
```typescript
// 验证必填字段
if (!quantity || Number(quantity) <= 0) {
  Taro.showToast({
    title: '请输入有效的数量',
    icon: 'none',
    duration: 2000
  })
  return
}

// 计算总金额
const calculateTotalAmount = () => {
  const qty = Number(quantity) || 0
  const price = Number(unitPrice) || 0
  const upstairs = needUpstairs ? Number(upstairsPrice) || 0 : 0
  const sortingQty = needSorting ? Number(sortingQuantity) || 0 : 0
  const sortingPrice = needSorting ? Number(sortingUnitPrice) || 0 : 0

  return qty * price + upstairs + sortingQty * sortingPrice
}
```

## 使用场景

### 场景1：查看特定仓库的计件情况

**需求**：管理员想查看"北京仓库"本月的计件情况

**操作步骤**：
1. 打开计件管理页面
2. 在仓库选择器中选择"北京仓库"
3. 点击"本月"快捷筛选按钮
4. 查看统计数据和记录列表

### 场景2：为司机添加计件记录

**需求**：管理员需要为司机"张三"添加一条计件记录

**操作步骤**：
1. 打开计件管理页面
2. 点击"添加计件记录"按钮
3. 选择司机"张三"
4. 选择仓库"北京仓库"
5. 选择品类"标准件"
6. 选择工作日期和时间
7. 输入数量"10"，单价"20"
8. 开启"需要上楼"，输入上楼费"5"
9. 查看预计总金额"¥205.00"
10. 点击"保存"按钮

### 场景3：查看记录详细信息

**需求**：管理员想查看某条记录的完整费用明细

**操作步骤**：
1. 在记录列表中找到目标记录
2. 点击记录卡片
3. 在弹窗中查看完整信息
4. 查看费用明细组成
5. 点击"关闭"按钮

### 场景4：删除错误记录

**需求**：管理员发现一条记录录入错误，需要删除

**操作步骤**：
1. 在记录列表中找到错误记录
2. 点击记录右上角的删除图标
3. 在确认对话框中点击"确定"
4. 等待删除成功提示
5. 确认记录已从列表中移除

### 场景5：查看所有司机的汇总数据

**需求**：管理员想查看所有仓库、所有司机本周的汇总情况

**操作步骤**：
1. 打开计件管理页面
2. 仓库选择"所有仓库"
3. 司机选择"所有司机"
4. 点击"本周"快捷筛选按钮
5. 查看统计卡片中的总件数和总金额
6. 浏览记录列表查看详细情况

## 注意事项

### 1. 权限要求
- ⚠️ 只有普通管理员角色才能访问此功能
- ⚠️ 管理员只能查看和管理自己管辖仓库的记录
- ⚠️ 需要先登录才能使用

### 2. 数据准确性
- ⚠️ 添加记录时请仔细核对所有信息
- ⚠️ 特别注意数量和单价的准确性
- ⚠️ 删除操作不可恢复，请谨慎操作

### 3. 网络要求
- ⚠️ 需要网络连接才能加载和保存数据
- ⚠️ 网络不稳定可能导致数据加载失败
- ⚠️ 保存失败时请检查网络后重试

### 4. 操作建议
- 💡 建议定期查看和核对计件记录
- 💡 使用快捷筛选可以提高查询效率
- 💡 添加记录时建议填写备注信息
- 💡 重要记录建议截图保存

### 5. 性能优化
- 💡 避免选择过长的日期范围
- 💡 大量数据时建议使用筛选功能
- 💡 定期清理不需要的历史记录

## 常见问题

### Q1：为什么看不到某个仓库的数据？

**A**：可能的原因：
1. 您没有该仓库的管理权限
2. 该仓库在选定日期范围内没有记录
3. 筛选条件设置不正确

**解决方法**：
- 检查仓库选择器中是否有该仓库
- 调整日期范围重新查询
- 联系超级管理员分配仓库权限

### Q2：添加记录时为什么无法选择某个司机？

**A**：可能的原因：
1. 该用户不是司机角色
2. 该司机账号已被停用
3. 数据加载失败

**解决方法**：
- 确认该用户的角色是"司机"
- 联系超级管理员检查账号状态
- 刷新页面重新加载数据

### Q3：为什么删除记录后统计数据没有更新？

**A**：可能的原因：
1. 页面数据未刷新
2. 网络延迟

**解决方法**：
- 等待几秒钟让数据自动刷新
- 手动切换筛选条件触发刷新
- 退出页面重新进入

### Q4：如何查看某个司机在某个仓库的记录？

**A**：操作步骤：
1. 在仓库选择器中选择目标仓库
2. 在司机选择器中选择目标司机
3. 设置合适的日期范围
4. 查看筛选后的记录列表

### Q5：总金额计算不正确怎么办？

**A**：检查项目：
1. 确认数量和单价输入正确
2. 检查是否需要上楼及上楼费
3. 检查是否需要分拣及分拣费用
4. 计算公式：总金额 = (数量 × 单价) + 上楼费 + (分拣数量 × 分拣单价)

**解决方法**：
- 在添加记录页面查看预计总金额
- 如发现错误，删除记录后重新添加
- 联系技术支持检查系统问题

## 功能对比

### 与司机端计件记录的区别

| 功能项 | 司机端 | 管理员端 |
|--------|--------|----------|
| 查看范围 | 只能查看自己的记录 | 可查看所有司机的记录 |
| 添加记录 | 只能为自己添加 | 可为任意司机添加 |
| 仓库筛选 | 无（只显示自己的仓库） | 支持多仓库筛选 |
| 司机筛选 | 无 | 支持司机筛选 |
| 编辑记录 | 支持 | 暂不支持 |
| 删除记录 | 支持 | 支持 |
| 详情查看 | 支持 | 支持 |
| 统计数据 | 个人统计 | 汇总统计 |

### 与计件报表的区别

| 功能项 | 计件管理 | 计件报表 |
|--------|----------|----------|
| 主要用途 | 记录管理 | 数据分析 |
| 添加记录 | 支持 | 不支持 |
| 删除记录 | 支持 | 不支持 |
| 详情查看 | 支持 | 支持 |
| 数据统计 | 基础统计 | 详细统计 |
| 图表展示 | 无 | 有 |
| 导出功能 | 无 | 有（计划中） |

## 更新日志

### v1.0.0 (2025-01-15)
- ✅ 初始版本发布
- ✅ 实现多仓库数据处理
- ✅ 实现司机筛选功能
- ✅ 实现添加记录功能
- ✅ 实现详情查看弹窗
- ✅ 实现删除记录功能
- ✅ 实现快捷筛选功能
- ✅ 实现排序功能
- ✅ 实现实时数据更新

### 计划功能
- 📋 编辑记录功能
- 📋 批量删除功能
- 📋 数据导出功能
- 📋 记录审核功能
- 📋 异常记录标记
- 📋 记录备注编辑

## 技术支持

如果您在使用过程中遇到问题，请：
1. 查看本文档的"常见问题"部分
2. 联系系统管理员
3. 提交问题反馈

## 总结

普通管理员计件管理功能为管理员提供了完整的计件记录管理能力，具有以下核心优势：

1. **功能完整**：支持添加、查看、删除等完整操作
2. **灵活筛选**：支持多维度筛选和快捷筛选
3. **实时更新**：数据实时同步，确保准确性
4. **直观易用**：界面清晰，操作简单
5. **详细展示**：完整的费用明细展示
6. **多仓库支持**：适应复杂的管理场景

该功能与司机端计件记录功能保持一致，确保了系统的统一性和易用性，为车队管理提供了强有力的支持。
