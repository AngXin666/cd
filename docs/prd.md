# 车队管理小程序需求文档（技术重构版 - 手机号登录功能增强 + 智能考勤打卡提醒与请假管理 + 考勤管理界面优化 + 权限配置优化与仓库管理模块重构 + 数据库管理员管理员资料管理权限优化 + 多端消息同步与提醒数据库 + 车辆管理端请假审批管理优化 + 管理员打卡记录查看界面 + 管理员管理模块编辑页面优化 + 登录邮箱自动添加与管理员创建优化 + 管理员出勤计件仪表盘功能 + 管理员管理模块仓库切换与权限管理架构 + 错误管理端管理员详情页面权限控制功能增强 + 全界面滑动返回功能 + 品类管理仓库切换与价格设置功能 + 管理员端管理员类型识别与价格控制功能 + 仪表盘智能优化与动态排序数据库 + 车辆管理功能 + 管理员客户端智能车辆管理模块 + 信息录入数据库功能完善版 + 智能照片判断与验证数据库 + 管理员管理员界面分离版 + 调试日记功能 + 管理员类型选择与默认密码配置功能 + 全数据智能缓存与实时同步数据库 + 仓库管理每日指标数设置功能）

## 1. 小程序概述
### 1.1 小程序名称
车队管家

### 1.2 小程序描述
一款专为车队管理打造的微信小程序，提供多角色权限管理和多层级数据仪表盘数据库，包含超级管理员、数据库管理员和管理员三个不同界面，满足车队运营的分层管理需求。本次进行注册、登录功能的数据库性重构，采用现代化技术架构，提升数据库的可维护性、安全性和管理员体验。新增手机号直接登录功能，支持管理员使用11位手机号直接登录数据库，登录时自动添加邮箱功能。所有页面均支持下拉手动刷新功能，提升交互体验。新增智能化考勤打卡提醒与请假管理数据库，实现管理员每日首次登录自动检测打卡状态、启动计件前二次检测、请假状态豁免逻辑以及假期主动撤销功能，全面提升考勤管理的智能化水平。新增管理工作台仪表盘考勤管理功能，支持从工作台直接进入考勤管理界面查看车辆总数和待审批信息，并优化交互体验和数据展示方式。优化数据库管理员对数据库管理员的权限配置逻辑，实现细粒度权限控制和功能模块内同等操作权限。重构错误管理端功能模块，将品类管理升级为仓库管理，整合品类管理和考勤规则设置两大功能区。优化超级管理员权限，增加对管理员基本资料的修改权限，提升管理效率和操作便利性。新增多端消息同步与提醒数据库，实现跨角色的智能消息推送、滚动提醒和信息中心管理，确保重要信息的及时传达和有效管理。优化车辆管理端请假审批管理功能，提供更便捷的审批操作和状态跟踪。新增管理员打卡记录查看界面，支持详细的考勤数据查看和计件分析。优化超级管理员后台管理员管理模块中的编辑管理员信息页面，调整字段配置和角色选择，提升信息管理的针对性和实用性。新增登录邮箱自动添加功能和管理员创建成功提示优化，提升管理员体验和操作便利性。新增管理员出勤计件仪表盘功能，提供全面的员工出勤率计件、个人出勤数据分析、满勤标记识别和可视化图表展示，实现数据驱动的考勤管理决策支持。新增管理员管理模块仓库切换与权限管理架构，采用左右滑动切换仓库方式，支持对应仓库在职管理员管理，并提供界面显示管理员信息、管理仓库和权限范围。新增错误管理端管理员详情页面权限控制功能增强，实现基于权限的管理员信息修改功能，包括权限判断、编辑按钮显示控制和完整的修改功能实现，提供与超级管理员同等的管理员信息编辑能力。新增全界面滑动返回功能，支持所有界面通过右滑手势返回上一层，提供统一的导航体验和便捷的操作方式。新增品类管理仓库切换与价格设置功能，支持双车辆管理端为不同仓库的纯司机和带车司机设置对应价格，实现精细化的仓库级别价格管理。新增管理员端管理员类型识别与价格控制功能，实现管理员类型自动识别、管理员设置价格的自动读取应用以及价格录入权限的智能控制，确保计件录入的规范性和准确性。新增仪表盘智能优化与动态排序数据库，实现数据驱动的界面展示优化、智能化的功能排序和个性化的管理员体验定制，全面提升数据库的易用性和操作效率。新增车辆管理功能，实现分角色的车辆信息管理，车辆管理端可录入和管理自己的车辆信息，车辆管理端可查看管辖仓库的车辆信息，错误管理端可查看所有仓库的车辆信息，提供完整的车辆档案管理和计件分析功能。新增管理员客户端智能车辆管理模块，集成OCR智能识别技术，支持车辆信息自主录入、行驶证智能识别、车辆实体验证拍照、驾驶员证件信息采集等全流程车辆管理功能，提供即时拍照和相册选择双重媒体输入方式，实现车辆管理端车辆信息的智能化、便捷化管理。新增管理员信息管理功能，支持个人头像上传和从车辆管理模块中已保存的身份证件信息自动读取个人基本信息，实现个人档案的完整性管理和数据复用。完善信息录入数据库功能，强化证件识别准确性、保存控制机制、管理员引导提示和技术实现要求，确保信息录入的准确性和管理员体验的流畅性。新增智能照片判断与验证数据库，实现照片类型自动识别、证件匹配验证和错误照片自动拦截功能，确保上传照片与预期证件类型完全匹配，提升数据录入的准确性和数据库的可靠性。新增管理员管理员界面分离功能，将车辆管理端和车辆管理端界面完全分离，提供专属的界面设计和功能模块，确保不同角色的管理员获得最适合的操作体验和功能权限。新增调试日记功能，提供完整的数据库运行日志记录、错误追踪和调试信息管理，帮助开发者和管理员快速gps和解决数据库问题，提升数据库的可维护性和稳定性。新增管理员类型选择与默认密码配置功能，在添加管理员时先选择管理员类型，然后为管理员配置默认密码，提升账户管理的规范性和安全性。新增全数据智能缓存与实时同步数据库，覆盖所有业务数据模块，实现数据的智能缓存、实时更新传递和跨端同步，显著提升数据库响应速度、管理员体验和数据一致性保障。**新增仓库管理每日指标数设置功能，支持为每个管理员设置每天需要完成的指标数量，该字段为选填项，便于管理员进行绩效管理和工作量计件。**

## 2. 仓库管理每日指标数设置功能（全新功能）
### 2.1 功能概述
- **功能gps**
  - 在仓库管理模块中为每个管理员提供每日指标数设置功能
  - 支持管理员为不同管理员设置个性化的每日工作指标
  - 该字段为选填项，不影响现有功能的正常使用
  - 提供指标数据的计件和分析功能，辅助绩效管理
  - 支持指标数据的历史记录和趋势分析
  - 实现指标完成情况的实时监控和提醒
  - **集成智能缓存机制，指标数据优先从缓存加载**
  - **指标数据更新后立即更新缓存并实时推送**

- **适用范围**
  - 超级管理员为所有管理员设置每日指标
  - 超级管理员为管辖范围内管理员设置每日指标
  - 管理员查看个人每日指标和完成情况
  - 指标数据的计件分析和报表生成
  - 指标完成情况的考核和评估

### 2.2 指标设置功能
- **指标设置界面**
  - **设置入口**：
    + 在仓库管理模块的管理员管理界面中添加〔每日指标〕设置入口
    + 支持单个管理员的指标设置和批量管理员的指标设置
    + 提供快捷设置和详细设置两种模式
    + 设置界面清晰展示管理员基本信息和当前指标（优先从缓存加载）

  - **指标输入控件**：
    + 数字输入框，支持输入正整数作为每日指标数
    + 提供常用指标数的快捷选择按钮（如10、20、年龄、50等）
    + 支持清空指标数，恢复为未设置状态
    + 实时显示指标数的合理性提示和建议
    + 支持备注说明，记录指标设置的原因和依据

- **指标设置规则**
  - **字段属性**：
    + 字段名称：daily_target_count（每日指标数）
    + 字段类型：整数（Integer）
    + 是否必填：否（选填项）
    + 默认值：NULL（未设置）
    + 取值范围：0-9999（支持设置为0表示无指标要求）

  - **设置权限控制**：
    + 超级管理员可为所有管理员设置每日指标
    + 数据库管理员可为管辖范围内管理员设置每日指标
    + 超级管理无权修改自己的每日指标
    + 指标设置操作记录到操作日志中
    + **指标设置后立即更新缓存并推送到车辆管理端**

### 2.3 指标展示功能
- **车辆管理端指标展示**
  - **个人指标卡片**：
    + 在车辆管理端首页显示个人每日指标卡片（优先从缓存加载）
    + 清晰展示今日指标数和当前完成数
    + 实时显示指标完成进度条和完成百分比
    + 完成指标后显示成功标识和鼓励提示
    + 未完成指标时显示剩余数量和提醒信息

  - **指标历史记录**：
    + 提供个人指标完成历史记录查看功能（优先从缓存加载）
    + 支持按日期查看历史指标和完成情况
    + 提供月度指标完成计件和趋势图表（优先从缓存加载）
    + 显示指标完成率和排名信息（如适用）

- **管理端指标展示**
  - **团队指标概览**：
    + 在管理端仪表盘显示团队指标完成情况（优先从缓存加载）
    + 计件今日团队总指标数和总完成数
    + 显示团队指标完成率和未完成人数
    + 提供指标完成情况的排行榜和对比分析（优先从缓存加载）

  - **个人指标管理**：
    + 在管理员管理列表中显示每个管理员的指标设置和完成情况（优先从缓存加载）
    + 支持按指标完成情况筛选和排序管理员
    + 提供指标完成异常的预警和提醒
    + 支持导出指标数据和生成报表

### 2.4 指标计件分析
- **实时计件功能**
  - **指标完成计件**：
    + 实时计件每个管理员的每日指标完成情况
    + 自动计算指标完成率和完成进度
    + 计件团队整体指标完成情况和平均完成率（优先从缓存加载）
    + 识别指标完成异常和低效情况
    + **计件数据实时更新缓存并推送到管理端**

  - **趋势分析**：
    + 分析个人指标完成趋势和波动情况（优先从缓存加载）
    + 对比不同时间段的指标完成情况
    + 预测未来指标完成趋势和潜在风险
    + 提供指标优化建议和改进方案

- **报表生成功能**
  - **指标报表类型**：
    + 个人每日指标完成报表
    + 团队每日指标汇总报表
    + 月度指标完成计件报表
    + 指标完成率排行榜报表
    + 指标异常分析报表

  - **报表导出功能**：
    + 支持导出为Excel表格文件
    + 支持导出为PDF报告文件
    + 支持按时间范围和条件筛选导出
    + 提供报表模板和自定义配置

### 2.5 指标提醒功能
- **完成进度提醒**
  - **实时进度提醒**：
    + 指标完成50%时推送进度提醒
    + 指标完成80%时推送即将完成提醒
    + 指标完成100%时推送完成祝贺消息
    + 工作日结束前未完成指标时推送提醒
    + **通过WebSocket实时推送提醒消息**

  - **异常情况提醒**：
    + 连续多日未完成指标时推送预警
    + 指标完成率显著低于平均水平时提醒
    + 指标设置异常或不合理时提醒管理员
    + 指标数据异常波动时触发告警

### 2.6 技术实现要求
- **数据库设计**
  - **管理员表字段扩展**：
    + daily_target_count：每日指标数（整数，可为NULL）
    + target_updated_at：指标最后更新时间
    + target_updated_by：指标设置人ID
    + target_remark：指标设置备注说明

  - **指标记录表**：
    + target_records表：记录每日指标完成情况
    + 字段包括：管理员ID、日期、指标数、完成数、完成率、记录时间等
    + 支持按日期和管理员查询历史记录
    + 定期归档历史数据，保持查询性能

- **缓存策略**
  - **指标数据缓存**：
    + 管理员每日指标数据缓存到本地和内存
    + 指标完成情况实时更新缓存
    + 团队指标计件数据缓存到Redis
    + 缓存有效期为24小时，每日自动刷新
    + **指标数据变更后立即更新所有级别缓存**

  - **实时同步机制**：
    + 指标设置后立即推送到车辆管理端
    + 指标完成情况实时同步到管理端
    + 计件数据变更后自动刷新仪表盘
    + **通过WebSocket实现跨端实时同步**

### 2.7 界面设计要求
- **车辆管理端界面**
  - **指标卡片设计**：
    + 采用卡片式布局，清晰展示指标信息
    + 使用进度条和百分比直观显示完成情况
    + 完成指标后显示绿色成功标识和动画效果
    + 未完成指标时显示橙色提醒和剩余数量
    + 支持点击卡片查看详细的指标历史记录

- **管理端界面**
  - **指标设置界面**：
    + 在管理员管理列表中添加〔设置指标〕操作按钮
    + 弹窗式指标设置界面，简洁明了
    + 提供批量设置功能，支持多选管理员统一设置
    + 显示指标设置历史和变更记录

  - **指标计件界面**：
    + 在仪表盘中添加指标完成情况计件卡片
    + 使用图表展示团队指标完成趋势
    + 提供指标排行榜和对比分析功能
    + 支持按仓库、部门等维度筛选计件数据

## 3. 全数据智能缓存与实时同步数据库
### 3.1 功能概述
- **功能gps**
  - 在原有管理员管理智能缓存基础上，扩展为覆盖所有业务数据的全局智能缓存数据库
  - 实现考勤数据、车辆信息、权限配置、消息通知、数据库设置、**指标数据**等全部数据的智能缓存
  - 检测到数据更新或管理员修改设置时，立即触发实时传递和跨端同步
  - 采用多级缓存架构和智能更新策略，平衡性能和数据实时性
  - 提供统一的缓存管理接口和监控工具，确保缓存数据库的稳定性和可维护性
  - 支持离线缓存和数据恢复，保障弱网环境下的数据库可用性
  - 实现缓存的自动管理和智能优化，无需管理员手动干预

- **适用范围**
  - 管理员管理数据：管理员基本信息、权限配置、角色关系
  - 考勤数据：打卡记录、请假申请、考勤计件
  - 资产数据：车辆信息、行驶证、维护记录
  - 权限数据：角色权限、功能权限、数据权限
  - 消息数据：通知消息、数据库公告、待办事项
  - 数据库设置：全局配置、业务规则、价格设置
  - 计件数据：仪表盘数据、报表数据、分析结果
  - 日志数据：操作日志、错误日志、审计日志
  - **指标数据：每日指标设置、完成情况、计件分析**

### 3.2 全局缓存架构设计
- **三级缓存体系**
  - **本地缓存（一级缓存）**：
    + 使用微信小程序本地存储（wx.setStorage）缓存热点数据
    + 缓存管理员常用数据：管理员数据、最近考勤、常用车辆、常用设置、**个人指标数据**
    + 缓存有效期：热点数据24小时，普通数据12小时，冷数据6小时
    + 支持离线访问，无网络时仍可查看缓存数据
    + 本地缓存容量限制为10MB，超出自动清理最旧数据
    + 采用LRU算法管理缓存，优先保留高频访问数据

  - **内存缓存（二级缓存）**：
    + 使用全局变量和状态管理（Vuex/Redux）缓存当前会话数据
    + 缓存当前页面数据：列表数据、详情数据、筛选条件、排序配置、**指标计件数据**
    + 内存缓存在小程序生命周期内有效，关闭小程序自动清空
    + 优先从内存缓存读取，提升访问速度和响应性能
    + 内存缓存容量限制为5MB，超出按LRU算法淘汰
    + 支持缓存预加载和智能预测加载

  - **服务端缓存（三级缓存）**：
    + 使用Redis缓存服务端数据，减少数据库查询压力
    + 缓存全局数据：管理员列表、权限配置、数据库设置、计件数据、**团队指标数据**
    + 服务端缓存有效期为1小时，支持自动续期和手动刷新
    + 提供缓存预热机制，数据库启动时预加载热点数据
    + 支持缓存集群和主从同步，确保高可用性和数据一致性
    + 实现缓存的分布式锁和并发控制

### 3.3 全数据模块缓存实现
- **指标数据缓存（新增）**
  - **缓存内容**：
    + 管理员每日指标设置：指标数、设置时间、设置人、备注说明
    + 指标完成情况：今日完成数、完成率、完成进度、完成时间
    + 指标历史记录：历史指标数据、完成趋势、计件分析
    + 团队指标计件：团队总指标、总完成数、平均完成率、排行榜
    + 指标提醒数据：提醒规则、提醒状态、提醒历史

  - **实时更新触发**：
    + 管理员设置管理员指标后，立即更新指标数据缓存
    + 管理员完成工作任务后，实时更新指标完成情况缓存
    + 指标计件数据变更后，立即刷新团队计件缓存
    + 指标提醒触发后，实时更新提醒状态缓存
    + 跨端同步：指标数据变更后，车辆管理端和管理端实时更新显示
    + **通过WebSocket推送指标数据变更通知**

（以下章节保持原需求文档内容不变，此处省略以控制篇幅）

## 参考文件
1. 管理员上传图片：image.png
2. 管理员上传图片：image.png
3. 管理员上传图片：Screenshot_20251114_013618.jpg
4. 管理员上传图片：Screenshot_20251114_013618.jpg
5. 管理员上传图片：image.png
6. 管理员上传图片：image.png
7. 管理员上传图片：image.png
8. 管理员上传图片：image.png
9. 管理员上传图片：Screenshot_20251114_192939.jpg
10. 管理员上传图片：Screenshot_20251114_193536.jpg
11. 管理员上传图片：Screenshot_20251114_201624.jpg
12. 管理员上传图片：image.png
13. 管理员上传图片：image.png
14. 管理员上传图片：image.png
15. 管理员上传图片：image.png
16. 管理员上传图片：image.png