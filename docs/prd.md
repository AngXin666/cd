# 车队管理小程序需求文档（技术重构版 - 手机号登录功能增强 + 智能考勤打卡提醒与请假管理 + 考勤管理界面优化 + 权限配置优化与仓库管理模块重构 + 数据库管理员管理员资料管理权限优化 + 多端消息同步与提醒数据库 + 车辆管理端请假审批管理优化 + 管理员打卡记录查看界面 + 管理员管理模块编辑页面优化 + 登录邮箱自动添加与管理员创建优化 + 管理员出勤计件仪表盘功能 + 管理员管理模块仓库切换与权限管理架构 + 错误管理端管理员详情页面权限控制功能增强 + 全界面滑动返回功能 + 品类管理仓库切换与价格设置功能 + 车辆管理端管理员类型识别与价格控制功能 + 仪表盘智能优化与动态排序数据库 + 车辆管理功能 + 管理员客户端智能车辆管理模块 + 信息录入数据库功能完善版 + 智能照片判断与验证数据库 + 管理员管理员界面分离版 + 调试日记功能 + 管理员类型选择与默认密码配置功能 + 全数据智能缓存与实时同步数据库 + 仓库管理每日指标数设置功能 + 计件报表UI功能优化版 + 手机号一键拨号功能 + 环形图达标率可视化展示功能 + 请假天数与达标率计算逻辑优化 + 新司机标签自动移除功能 + 车辆管理端车辆管理功能迭代升级版）

## 1. 小程序概述
### 1.1 小程序名称
车队管家

### 1.2 小程序描述
一款专为车队管理打造的微信小程序，提供多角色权限管理和多层级数据仪表盘数据库，包含超级管理员、数据库管理员和管理员三个不同界面，满足车队运营的分层管理需求。本次进行注册、登录功能的数据库性重构，采用现代化技术架构，提升数据库的可维护性、安全性和管理员体验。新增手机号直接登录功能，支持管理员使用11位手机号直接登录数据库，登录时自动添加邮箱功能。所有页面均支持下拉手动刷新功能，提升交互体验。新增智能化考勤打卡提醒与请假管理数据库，实现管理员每日首次登录自动检测打卡状态、启动计件前二次检测、请假状态豁免逻辑以及假期主动撤销功能，全面提升考勤管理的智能化水平。新增管理工作台仪表盘考勤管理功能，支持从工作台直接进入考勤管理界面查看车辆总数和待审批信息，并优化交互体验和数据展示方式。优化数据库管理员对数据库管理员的权限配置逻辑，实现细粒度权限控制和功能模块内同等操作权限。重构错误管理端功能模块，将品类管理升级为仓库管理，整合品类管理和考勤规则设置两大功能区。优化超级管理员权限，增加对管理员基本资料的修改权限，提升管理效率和操作便利性。新增多端消息同步与提醒数据库，实现跨角色的智能消息推送、滚动提醒和信息中心管理，确保重要信息的及时传达和有效管理。优化车辆管理端请假审批管理功能，提供更便捷的审批操作和状态跟踪。新增管理员打卡记录查看界面，支持详细的考勤数据查看和计件分析。优化数据库管理员后台管理员管理模块中的编辑管理员信息页面，调整字段配置和角色选择，提升信息管理的针对性和实用性。新增登录邮箱自动添加功能和管理员创建成功提示优化，提升管理员体验和操作便利性。新增管理员出勤计件仪表盘功能，提供全面的员工达标率计件、个人出勤数据分析、满勤标记识别和可视化图表展示，实现数据驱动的考勤管理决策支持。新增管理员管理模块仓库切换与权限管理架构，采用左右滑动切换仓库方式，支持对应仓库在职管理员管理，并提供界面显示管理员信息、管理仓库和权限范围。新增错误管理端管理员详情页面权限控制功能增强，实现基于权限的管理员信息修改功能，包括权限判断、编辑按钮显示控制和完整的修改功能实现，提供与超级管理员同等的管理员信息编辑能力。新增全界面滑动返回功能，支持所有界面通过右滑手势返回上一层，提供统一的导航体验和便捷的操作方式。新增品类管理仓库切换与价格设置功能，支持双车辆管理端为不同仓库的纯司机和带车司机设置对应价格，实现精细化的仓库级别价格管理。新增管理员端管理员类型识别与价格控制功能，实现管理员类型自动识别、管理员设置价格的自动读取应用以及价格录入权限的智能控制，确保计件录入的规范性和准确性。新增仪表盘智能优化与动态排序数据库，实现数据驱动的界面展示优化、智能化的功能排序和个性化的管理员体验定制，全面提升数据库的易用性和操作效率。新增车辆管理功能，实现分角色的车辆信息管理，车辆管理端可录入和管理自己的车辆信息，车辆管理端可查看管辖仓库的车辆信息，错误管理端可查看所有仓库的车辆信息，提供完整的车辆档案管理和计件分析功能。新增管理员客户端智能车辆管理模块，集成OCR智能识别技术，支持车辆信息自主录入、驾驶证智能识别、车辆实体验证拍照、驾驶员证件信息采集等全流程车辆管理功能，提供即时拍照和相册选择双重媒体输入方式，实现车辆管理端车辆信息的智能化、便捷化管理。新增管理员信息管理功能，支持个人头像上传和从车辆管理模块中已保存的身份证件信息自动读取个人基本信息，实现个人档案的完整性管理和数据复用。完善信息录入数据库功能，强化证件识别准确性、保存控制机制、管理员引导提示和技术实现要求，确保信息录入的准确性和管理员体验的流畅性。新增智能照片判断与验证数据库，实现照片类型自动识别、证件匹配验证和错误照片自动拦截功能，确保上传照片与预期证件类型完全匹配，提升数据录入的准确性和数据库的可靠性。新增管理员管理员界面分离功能，将车辆管理端和车辆管理端界面完全分离，提供专属的界面设计和功能模块，确保不同角色的管理员获得最适合的操作体验和功能权限。新增调试日记功能，提供完整的数据库运行日志记录、错误追踪和调试信息管理，帮助开发者和管理员快速gps和解决数据库问题，提升数据库的可维护性和稳定性。新增管理员类型选择与默认密码配置功能，在添加管理员时先选择管理员类型，然后为管理员配置默认密码，提升账号管理的规范性和安全性。新增全数据智能缓存与实时同步数据库，覆盖所有业务数据模块，实现数据的智能缓存、实时更新传递和跨端同步，显著提升数据库响应速度、管理员体验和数据一致性保障。新增仓库管理每日指标数设置功能，支持为每个管理员设置每天需要完成的指标数量，该字段为选填项，便于管理员进行绩效管理和工作量计件。新增计件报表UI功能优化，去除总金额显示，新增目标完成率计算与展示，实现双车辆管理端统一的数据计件和可视化分析功能。新增手机号一键拨号功能，在双车辆管理端的管理员管理列表和管理员信息详情页面中，为手机号字段添加一键拨号按钮，支持点击直接调起数据库拨号界面，提升联系效率和操作便利性。新增环形图达标率可视化展示功能，通过三个独立环形图分别展示当天、本周和本月的达标率，提供直观的绩效数据可视化和达标情况分析。新增请假天数与达标率计算逻辑优化，实现基于仓库配置的允许请假天数的智能计算，区分合规请假与超标请假，确保达标率计算的准确性和公平性。新增新司机标签自动移除功能，实现入职超过7天后自动移除新司机标识，优化管理员身份管理和界面展示逻辑。**本次对车辆管理端车辆管理功能进行迭代升级，优化车辆录入流程、新增操作时间自动记录、重构车辆详情页面、调整操作状态与前态逻辑，提升车辆管理的便捷性和规范性。**

## 2. 车辆管理端车辆管理功能迭代升级（全新功能）
### 2.1 功能概述
- **功能gps**
  - 为管理员管理员提供两种明确的车辆录入操作起点
  - 当管理员没有车辆信息时，添加车辆默认为提车录入
  - 数据库自动记录管理员执行〔提车录入〕与〔还车录入〕操作的具体时间
  - 重构车辆详情页面，采用标签页（Tab）形式组织关键影像资料
  - 根据车辆当前状态，动态管理〔我的车辆〕列表页的操作入口与功能可见性
  - 提升车辆管理的便捷性、规范性和可追溯性

- **适用范围**
  - 车辆管理端〔我的车辆〕模块
  - 车辆录入、还车录入、车辆详情查看等功能
  - 所有管理员管理员

### 2.2 车辆录入流程优化
- **录入操作起点**
  - **情况A：管理员没有车辆信息**
    + 进入〔我的车辆〕界面时，显示空状态提示：〔您还没有添加车辆信息〕
    + 界面中央显示〔添加车辆〕按钮
    + 点击〔添加车辆〕按钮后，默认进入〔提车录入〕流程
    + 录入流程包括：车辆基本信息填写、行驶证拍照识别、车辆实体验证拍照等

  - **情况B：管理员已有车辆信息**
    + 进入〔我的车辆〕界面时，显示车辆列表
    + 根据车辆状态显示不同的操作按钮（详见2.5节）
    + 当所有车辆均处于〔已还车〕状态时，显示〔添加车辆〕按钮
    + 点击〔添加车辆〕按钮后，进入〔提车录入〕流程

- **录入流程说明**
  - **步骤1：车辆基本信息填写**
    + 填写车牌号、车辆品牌、车辆型号等基本信息
    + 支持手动输入或从历史记录中选择

  - **步骤2：行驶证拍照识别**
    + 拍摄或上传行驶证照片
    + 数据库自动识别行驶证信息并填充到对应字段
    + 支持手动修正识别错误的信息

  - **步骤3：车辆实体验证拍照**
    + 拍摄车辆正面、侧面、后面等多角度照片
    + 数据库自动保存照片到〔提车照片〕标签页
    + 照片数量要求：至少3张，最多10张

  - **步骤4：确认提交**
    + 检查填写信息和上传照片的完整性
    + 点击〔提交〕按钮完成提车录入
    + 数据库自动记录提车录入时间

### 2.3 操作时间自动记录
- **记录内容**
  - **提车录入时间**
    + 记录管理员完成提车录入操作的精确时间
    + 格式：YYYY-MM-DD HH:MM:SS
    + 示例：2025-11-16 14:年龄:25

  - **还车录入时间**
    + 记录管理员完成还车录入操作的精确时间
    + 格式：YYYY-MM-DD HH:MM:SS
    + 示例：2025-11-18 09:15:42

- **记录逻辑**
  - **提车录入时间记录**
    + 管理员点击〔提交〕按钮完成提车录入时，数据库自动记录当前时间
    + 时间记录到车辆信息表（vehicle_info表）的pickup_time字段
    + 记录后立即更新车辆状态为〔已提车未还车〕

  - **还车录入时间记录**
    + 管理员点击〔确认还车〕按钮完成还车录入时，数据库自动记录当前时间
    + 时间记录到车辆信息表（vehicle_info表）的return_time字段
    + 记录后立即更新车辆状态为〔已还车〕

- **时间展示**
  - **车辆详情页面**
    + 在〔提车照片〕标签页中显示提车录入时间
    + 在〔还车照片〕标签页中显示还车录入时间
    + 时间显示格式：〔录入时间：2025-11-16 14:年龄:25〕

  - **车辆列表页面**
    + 在车辆条目下方显示最近一次操作时间
    + 示例：〔最近操作：2025-11-16 14:年龄 提车录入〕

### 2.4 车辆详情页面重构
- **标签页设计**
  - **标签页1：提车照片**
    + 展示提车录入时拍摄的车辆照片
    + 照片数量：至少3张，最多10张
    + 照片排列方式：网格式布局，每行3张
    + 支持点击照片查看大图
    + 在标签页顶部醒目位置显示提车录入时间
    + 时间显示格式：〔录入时间：2025-11-16 14:年龄:25〕
    + 时间字体加粗，颜色为主题蓝色，字号为16px

  - **标签页2：还车照片**
    + 展示还车录入时拍摄的车辆照片
    + 照片数量：至少3张，最多10张
    + 照片排列方式：网格式布局，每行3张
    + 支持点击照片查看大图
    + 在标签页顶部醒目位置显示还车录入时间
    + 时间显示格式：〔还车时间：2025-11-18 09:15:42〕
    + 时间字体加粗，颜色为主题绿色，字号为16px
    + 若车辆尚未还车，显示提示：〔该车辆尚未还车，暂无还车照片〕

  - **标签页3：行驶证照片**
    + 展示其他相关照片（如车辆维修照片、事故照片等）
    + 照片数量：不限
    + 照片排列方式：网格式布局，每行3张
    + 支持点击照片查看大图
    + 支持管理员手动上传照片
    + 在标签页顶部显示照片上传时间
    + 时间显示格式：〔上传时间：2025-11-17 16:20:10〕

- **标签页切换**
  - **切换方式**
    + 支持点击标签页标题切换
    + 支持左右滑动手势切换
    + 当前激活的标签页标题下方显示蓝色下划线

  - **默认显示**
    + 进入车辆详情页面时，默认显示〔提车照片〕标签页
    + 若车辆已还车，默认显示〔还车照片〕标签页

- **页面布局**
  - **顶部区域**
    + 显示车辆基本信息：车牌号、车辆品牌、车辆型号
    + 显示车辆状态标签：〔使用中〕或〔已还车〕

  - **标签页区域**
    + 占据页面主体部分
    + 标签页标题固定在顶部，内容区域可滚动

  - **底部操作区域**
    + 根据车辆状态显示不同的操作按钮
    + 若车辆处于〔已提车未还车〕状态，显示〔还车〕按钮
    + 若车辆处于〔已还车〕状态，不显示操作按钮

### 2.5 操作状态与前态逻辑调整
- **车辆状态定义**
  - **状态1：已提车未还车**
    + 管理员已完成提车录入，但尚未进行还车录入
    + 车辆信息表（vehicle_info表）中的status字段值为〔in_use〕

  - **状态2：已还车**
    + 管理员已完成还车录入
    + 车辆信息表（vehicle_info表）中的status字段值为〔returned〕

- **列表页操作按钮显示逻辑**
  - **情况A：车辆处于〔已提车未还车〕状态**
    + 在该车辆的条目下显示两个操作按钮：
      * 〔查看详情〕按钮：点击后进入车辆详情页面
      * 〔还车〕按钮：点击后进入还车录入流程
    + 按钮排列方式：左右并排，〔查看详情〕在左，〔还车〕在右
    + 按钮样式：〔查看详情〕为白色背景+蓝色边框+蓝色文字，〔还车〕为蓝色背景+白色文字

  - **情况B：车辆处于〔已还车〕状态**
    + 在该车辆的条目下仅显示一个操作按钮：
      * 〔查看详情〕按钮：点击后进入车辆详情页面
    + 按钮样式：白色背景+蓝色边框+蓝色文字

- **〔添加车辆〕按钮显示逻辑**
  - **显示条件**
    + 所有现有车辆均处于〔已还车〕状态
    + 或管理员没有任何车辆信息

  - **隐藏条件**
    + 存在至少一辆车辆处于〔已提车未还车〕状态
    + 隐藏〔添加车辆〕按钮，防止管理员重复添加车辆

  - **按钮位置**
    + 位于车辆列表底部
    + 按钮样式：蓝色背景+白色文字+圆角矩形
    + 按钮文案：〔添加车辆〕

- **还车录入流程**
  - **步骤1：拍摄还车照片**
    + 拍摄车辆还车时的多角度照片
    + 照片数量要求：至少3张，最多10张
    + 数据库自动保存照片到〔还车照片〕标签页

  - **步骤2：填写还车说明**
    + 填写车辆还车时的备注信息（选填）
    + 示例：〔车辆状况良好，无损坏〕

  - **步骤3：确认还车**
    + 检查还车照片和说明的完整性
    + 点击〔确认还车〕按钮完成还车录入
    + 数据库自动记录还车录入时间
    + 更新车辆状态为〔已还车〕

### 2.6 数据库设计
- **车辆信息表（vehicle_info表）字段调整**
  - **新增字段**：
    + pickup_time（日期时间型）：提车录入时间
    + return_time（日期时间型）：还车录入时间
    + status（字符串型）：车辆状态（in_use已提车未还车/returned已还车）
    + pickup_photos（JSON数组）：提车录入时拍摄的照片路径列表
    + return_photos（JSON数组）：还车录入时拍摄的照片路径列表
    + other_photos（JSON数组）：其他照片路径列表
    + return_remark（文本型）：还车说明

- **操作日志表（vehicle_operation_log表）**
  - **表结构**：
    + id（主键）：日志ID
    + vehicle_id（外键）：车辆ID
    + driver_id（外键）：管理员ID
    + operation_type（字符串型）：操作类型（pickup提车录入/return还车录入）
    + operation_time（日期时间型）：操作时间
    + remark（文本型）：备注说明

### 2.7 技术实现要求
- **前端实现**
  - **标签页组件**
    + 使用微信小程序原生组件swiper实现标签页切换
    + 支持点击标题和滑动手势两种切换方式
    + 标签页内容区域支持滚动查看

  - **照片上传**
    + 使用wx.chooseImage API选择照片
    + 使用wx.uploadFile API上传照片到服务器
    + 上传成功后显示照片缩略图

  - **时间显示**
    + 使用moment.js库格式化时间显示
    + 时间显示位置醒目，字体加粗

- **后端实现**
  - **时间记录**
    + 在提车录入和还车录入接口中自动记录当前时间
    + 时间格式统一为YYYY-MM-DD HH:MM:SS

  - **状态更新**
    + 提车录入后自动更新车辆状态为〔in_use〕
    + 还车录入后自动更新车辆状态为〔returned〕

  - **照片存储**
    + 照片上传到云存储服务（如腾讯云COS）
    + 照片路径保存到车辆信息表的对应字段

- **缓存更新**
  - **实时同步**
    + 提车录入和还车录入操作完成后立即更新车辆信息缓存
    + 通过WebSocket推送更新通知到车辆管理端
    + 确保所有端的数据一致性

## 3. 新司机标签自动移除功能
（保持原需求文档内容不变）

## 4. 环形图打卡率可视化展示功能
（保持原需求文档内容不变）

## 5. 手机号一键拨号功能
（保持原需求文档内容不变）

## 6. 计件报表UI功能优化
（保持原需求文档内容不变）

## 7. 仓库管理每日指标数设置功能
（保持原需求文档内容不变）

## 8. 全数据智能缓存与实时同步数据库
（保持原需求文档内容不变）

## 参考文件
1. 管理员上传图片：image.png
2. 管理员上传图片：image.png
3. 管理员上传图片：image.png
4. 管理员上传图片：image.png
5. 管理员上传图片：image.png
6. 管理员上传图片：image.png
7. 管理员上传图片：image.png
8. 管理员上传图片：image-2.png
9. 管理员上传图片：image.png
10. 管理员上传图片：image.png