# 车队管理小程序需求文档（技术重构版 - 手机号登录功能增强 + 智能考勤打卡提醒与请假管理 + 考勤管理界面优化 + 权限配置优化与仓库管理模块重构 + 数据库管理员管理员资料管理权限优化 + 多端消息同步与提醒数据库 + 车辆管理端请假审批管理优化 + 管理员打卡记录查看界面 + 管理员管理模块编辑页面优化 + 登录邮箱自动添加与管理员创建优化 + 管理员出勤计件仪表盘功能 + 管理员管理模块仓库切换与权限管理架构 + 错误管理端管理员详情页面权限控制功能增强 + 全界面滑动返回功能 + 品类管理仓库切换与价格设置功能 + 车辆管理端管理员类型识别与价格控制功能 + 仪表盘智能优化与动态排序数据库 + 车辆管理功能 + 管理员客户端智能车辆管理模块 + 信息录入数据库功能完善版 + 智能照片判断与验证数据库 + 管理员管理员界面分离版 + 调试日志功能 + 管理员类型选择与默认账号麻麻配置功能 + 全数据智能缓存与实时同步数据库 + 仓库管理每日指标数设置功能 + 计件报表UI功能优化版 + 手机号一键拨号功能 + 环形图达标率可视化展示功能 + 请假天数与达标率计算逻辑优化 + 新司机标签自动移除功能 + 车辆管理端车辆管理功能迭代升级版 + 资产审核闭环管理数据库 + 车辆管理端车辆删除功能 + 审核端一键锁定功能 + 车辆管理照片要求优化与车损特写功能 + 照片位置标注与补录界面优化 + 车辆多次录入记录管理数据库 + 车辆管理端车辆信息集中管理优化版）

## 1. 小程序概述
### 1.1 小程序名称
车队管家

### 1.2 小程序描述
一款专为车队管理打造的微信小程序，提供多角色权限管理和多层级数据仪表盘数据库，包含超级管理员、数据库管理员和管理员三个不同界面，满足车队运营的分层管理需求。本次进行注册、登录功能的数据库性重构，采用现代化技术架构，提升数据库的可维护性、安全性和管理员体验。新增手机号直接登录功能，支持管理员使用11位手机号直接登录数据库，登录时自动添加邮箱功能。所有页面均支持下拉手动刷新功能，提升交互体验。新增智能化考勤打卡提醒与请假管理数据库，实现管理员每日首次登录自动检测打卡状态、启动计件前二次检测、请假状态豁免逻辑以及假期主动撤销功能，全面提升考勤管理的智能化水平。新增管理工作台仪表盘考勤管理功能，支持从工作台直接进入考勤管理界面查看车辆总数和待审批信息，并优化交互体验和数据展示方式。优化数据库管理员对数据库管理员的权限配置逻辑，实现细粒度权限控制和功能模块内同等操作权限。重构错误管理端功能模块，将品类管理升级为仓库管理，整合品类管理和考勤规则设置两大功能区。优化超级管理员权限，增加对管理员基本资料的修改权限，提升管理效率和操作便利性。新增多端消息同步与提醒数据库，实现跨角色的智能消息推送、滚动提醒和信息中心管理，确保重要信息的及时传达和有效管理。优化车辆管理端请假审批管理功能，提供更便捷的审批操作和状态跟踪。新增管理员打卡记录查看界面，支持详细的考勤数据查看和计件分析。优化超级管理员后台管理员管理模块中的编辑管理员信息页面，调整字段配置和角色选择，提升信息管理的针对性和实用性。新增登录邮箱自动添加功能和管理员创建成功提示优化，提升管理员体验和操作便利性。新增管理员出勤计件仪表盘功能，提供全面的员工达标率计件、个人出勤数据分析、满勤标记识别和可视化图表展示，实现数据驱动的考勤管理决策支持。新增管理员管理模块仓库切换与权限管理架构，采用左右滑动切换仓库方式，支持对应仓库在职管理员管理，并提供界面显示管理员信息、管理仓库和权限范围。新增错误管理端管理员详情页面权限控制功能增强，实现基于权限的管理员信息修改功能，包括权限判断、编辑按钮显示控制和完整的修改功能实现，提供与超级管理员同等的管理员信息编辑能力。新增全界面滑动返回功能，支持所有界面通过右滑手势返回上一层，提供统一的导航体验和便捷的操作方式。新增品类管理仓库切换与价格设置功能，支持双车辆管理端为不同仓库的纯司机和带车司机设置对应价格，实现精细化的仓库级别价格管理。新增管理员端管理员类型识别与价格控制功能，实现管理员类型自动识别、管理员设置价格的自动读取应用以及价格录入权限的智能控制，确保计件录入的规范性和准确性。新增仪表盘智能优化与动态排序数据库，实现数据驱动的界面展示优化、智能化的功能排序和个性化的管理员体验定制，全面提升数据库的易用性和操作效率。新增车辆管理功能，实现分角色的车辆信息管理，车辆管理端可录入和管理自己的车辆信息，车辆管理端可查看管辖仓库的车辆信息，错误管理端可查看所有仓库的车辆信息，提供完整的车辆档案管理和计件分析功能。新增管理员客户端智能车辆管理模块，集成OCR智能识别技术，支持车辆信息自主录入、驾驶证智能识别、车辆实体验证拍照、驾驶员证件信息采集等全流程车辆管理功能，提供即时拍照和相册选择双重媒体输入方式，实现车辆管理端车辆信息的智能化、便捷化管理。新增管理员信息管理功能，支持个人头像上传和从车辆管理模块中已保存的身份证件信息自动读取个人基本信息，实现个人档案的完整性管理和数据复用。完善信息录入数据库功能，强化证件识别准确性、保存控制机制、管理员引导提示和技术实现要求，确保信息录入的准确性和管理员体验的流畅性。新增智能照片判断与验证数据库，实现照片类型自动识别、证件匹配验证和错误照片自动拦截功能，确保上传照片与预期证件类型完全匹配，提升数据录入的准确性和数据库的可靠性。新增管理员管理员界面分离功能，将车辆管理端和车辆管理端界面完全分离，提供专属的界面设计和功能模块，确保不同角色的管理员获得最适合的操作体验和功能权限。新增调试日志功能，提供完整的数据库运行日志记录、错误追踪和调试信息管理，帮助开发者和管理员快速gps和解决数据库问题，提升数据库的可维护性和稳定性。新增管理员类型选择与默认账号麻麻配置功能，在添加管理员时先选择管理员类型，然后为管理员配置默认账号麻麻，提升testdriver101管理的规范性和安全性。新增全数据智能缓存与实时同步数据库，覆盖所有业务数据模块，实现数据的智能缓存、实时更新传递和跨端同步，显著提升数据库响应速度、管理员体验和数据一致性保障。新增仓库管理每日指标数设置功能，支持为每个管理员设置每天需要完成的指标数量，该字段为选填项，便于管理员进行绩效管理和工作量计件。新增计件报表UI功能优化，去除总金额显示，新增目标完成率计算与展示，实现双车辆管理端统一的数据计件和可视化分析功能。新增手机号一键拨号功能，在双车辆管理端的管理员管理列表和管理员信息详情页面中，为手机号字段添加一键拨号按钮，支持点击直接调起数据库拨号界面，提升联系效率和操作便利性。新增环形图达标率可视化展示功能，通过三个独立环形图分别展示当天、本周和本月的达标率，提供直观的绩效数据可视化和达标情况分析。新增请假天数与达标率计算逻辑优化，实现基于仓库配置的允许请假天数的智能计算，区分合规请假与超标请假，确保达标率计算的准确性和公平性。新增新司机标签自动移除功能，实现入职日期超过7天后自动移除新司机标识，优化管理员身份管理和界面展示逻辑。对车辆管理端车辆管理功能进行迭代升级，优化车辆录入流程、新增操作时间自动记录、重构车辆详情页面、调整操作状态与状态逻辑，提升车辆管理的便捷性和规范性。新增资产审核闭环管理数据库，建立从管理员录入到数据库管理员审核的完整流程，强化图片审核机制，实现状态流转闭环管理，提升车辆信息的准确性和规范性。新增车辆管理端车辆删除功能，方便测试优化过程中的多次录入操作。新增审核端一键锁定功能，支持管理员在审核时除了标记为需补录的图片外，一键锁定其他所有图片，提升审核效率。优化车辆管理照片要求，统一提车和还车场景均需要7张照片，并新增车损特写图片上传功能，支持添加多张车损特写照片。同时优化照片上传与审核界面，在管理员补录界面和审核页面中清晰标注每张照片对应的标准位置，简化操作流程，去除不必要的照片编辑功能。**本次新增车辆多次录入记录管理数据库，实现每个车辆存储多个录入记录，方便追溯车辆的长期使用记录，录入驾驶证时自动读取车牌号码并归类到对应车辆，按时间倒序排列最新记录。同时优化车辆管理端车辆信息管理功能，实现同一辆车的所有录入信息集中管理，提供当前活跃车辆列表和车辆历史信息追溯功能，确保信息的连贯性和完整性。**

## 2. 车辆多次录入记录管理数据库（全新功能 + 车辆管理端车辆信息集中管理优化版）
### 2.1 功能概述
- **功能gps**
  - 实现每个车辆存储多个录入记录，支持车辆的长期使用追溯
  - 录入驾驶证时自动读取车牌号码，数据库自动归类到对应车辆档案
  - 按时间倒序排列，最新的录入记录显示在最前面
  - 提供清晰的车辆调用记录查看界面，便于管理和追溯
  - **新增车辆管理端车辆信息集中管理功能**，实现同一辆车的所有录入信息集中展示，提供当前活跃车辆列表和车辆历史信息追溯功能

- **适用范围**
  - 车辆管理端〔我的车辆〕模块
  - 管理员端〔车辆管理〕模块
  - 所有管理员和超级管理员

### 2.2 数据架构设计
#### 2.2.1 车辆档案表（vehicle_profile表）
- **表结构**
  - id（主键）：车辆档案ID
  - plate_number（字符串型）：车牌号码（唯一标识）
  - vehicle_brand（字符串型）：车辆品牌
  - vehicle_model（字符串型）：车辆型号
  - vin_code（字符串型）：车架号
  - current_status（字符串型）：当前状态（active已启动/inactive未启动）
  - first_record_time（日期时间型）：首次录入时间
  - latest_record_time（日期时间型）：最新录入时间
  - total_records（整数型）：总录入次数
  - created_at（日期时间型）：创建时间
  - updated_at（日期时间型）：更新时间

#### 2.2.2 车辆录入记录表（vehicle_record表）
- **表结构**
  - id（主键）：录入记录ID
  - vehicle_profile_id（外键）：关联车辆档案ID
  - driver_id（外键）：录入人ID
  - record_type（字符串型）：记录类型（pickup提车/return还车）
  - record_time（日期时间型）：录入时间
  - operator_name（字符串型）：操作人姓名
  - change_details（文本型）：具体变更内容描述
  - audit_status（字符串型）：审核状态（drafting录入中/pending待审核/need_reupload需补录/approved审核通过）
  - submit_time（日期时间型）：提交审核时间
  - audit_time（日期时间型）：审核完成时间
  - auditor_id（外键）：审核人ID
  - reupload_items（JSON数组）：需补录的图片项列表
  - locked_photos（JSON数组）：已锁定的图片路径列表
  - damage_photos（JSON数组）：车损特写照片路径列表
  - photo_positions（JSON对象）：7张必拍照片的位置标注和路径映射
  - driving_license_photo（字符串型）：驾驶证照片路径
  - return_note（文本型）：还车说明（仅还车记录）
  - created_at（日期时间型）：创建时间
  - updated_at（日期时间型）：更新时间

### 2.3 车辆管理端功能需求
#### 2.3.1 车辆录入流程优化
- **驾驶证识别与自动归类**
  - **步骤1：拍摄驾驶证**
    + 管理员拍摄或上传驾驶证照片
    + 数据库自动识别车牌号码、车辆品牌、车辆型号、车架号等信息

  - **步骤2：自动归类到车辆档案**
    + 数据库根据识别的车牌号码，自动查询车辆档案表（vehicle_profile表）
    + **情况A：车辆档案已存在**
      * 数据库自动关联到现有车辆档案
      * 提示管理员：〔检测到车辆【京AC83702】已存在档案，本次录入将作为新的使用记录〕
      * 自动填充车辆品牌、车辆型号等基本信息
    + **情况B：车辆档案不存在**
      * 数据库自动创建新的车辆档案
      * 提示管理员：〔检测到车辆【京AC83702】为首次录入，已自动创建车辆档案〕
      * 自动填充车辆品牌、车辆型号等基本信息

  - **步骤3：完成录入流程**
    + 管理员继续完成车辆实体验证拍照、车损特写照片上传等步骤
    + 提交审核后，数据库自动将本次录入记录保存到车辆录入记录表（vehicle_record表）
    + 数据库自动更新车辆档案表的latest_record_time、total_records和current_status字段
    + 数据库自动记录操作时间、操作人姓名和具体变更内容

#### 2.3.2 当前活跃车辆列表页面（全新功能）
- **界面入口**
  - 车辆管理端〔我的车辆〕模块首页显示〔我的车辆〕卡片
  - 点击卡片进入当前活跃车辆列表页面

- **当前活跃车辆列表页面**
  - **功能gps**
    + 默认展示所有状态标注为〔已启动〕（current_status=active）的车辆
    + 每辆车显示其最新的完整信息记录
    + 提供快速查看和管理当前正在使用的车辆

  - **布局设计**
    + 采用卡片式布局，每个车辆显示为一个独立卡片
    + 卡片内容包括：
      * 车辆照片（显示最新录入记录的第一张照片，参考image.png中的车辆照片展示）
      * 车牌号码（大号字体，蓝色背景+白色文字，参考image.png中的京AC83702样式）
      * 车辆品牌和型号（灰色字体，如〔宏远牌 KMT50年龄XXYBEV3〕，参考image.png）
      * 当前状态标签（如〔使用中〕〔已还车〕，参考image.png中的〔使用中〕标签）
      * 最新录入时间（如〔提车本入时间：2025-11-16 12:43〕，参考image.png）
      * 操作按钮：〔查看详情〕〔查看历史记录〕（参考image.png中的〔查看详情〕和〔送车〕按钮布局）

  - **排序规则**
    + 按最新录入时间倒序排列，最新的车辆显示在最前面
    + 支持按车牌号码搜索和筛选

  - **点击交互**
    + 点击〔查看详情〕按钮，进入车辆最新录入记录详情页面
    + 点击〔查看历史记录〕按钮，进入车辆历史信息追溯页面

#### 2.3.3 车辆历史信息追溯页面（全新功能）
- **页面入口**
  - 从当前活跃车辆列表页面点击〔查看历史记录〕按钮进入
  - 从车辆档案列表页面点击车辆卡片进入

- **页面布局**
  - **顶部车辆基本信息区域**
    + 显示车牌号码、车辆品牌、车辆型号、车架号等基本信息（参考Screenshot_20251116_141609.jpg中的车辆基本信息展示）
    + 显示总录入次数和首次录入时间
    + 显示当前状态标签（如〔已启动〕〔未启动〕）

  - **录入记录列表区域**
    + 采用时间轴式布局，按时间倒序排列所有录入记录（参考Screenshot_20251116_141609.jpg中的时间轴布局）
    + 每个录入记录显示为一个独立卡片，包含：
      * 录入时间（如〔提车本入时间：2025-11-16 12:43〕，参考Screenshot_20251116_141609.jpg）
      * 记录类型标签（如〔提车〕〔还车〕）
      * 审核状态标签（如〔待审核〕〔审核通过〕〔需补录〕）
      * 操作人信息（如〔录入人：邱吉兴〕，参考Screenshot_20251116_141609.jpg中的〔使用人 邱吉兴 15766121960〕）
      * 操作时间标注（如〔操作时间：2025-11-16 12:43〕）
      * 具体变更内容（如〔变更内容：提车录入，上传7张车辆照片和驾驶证〕）
      * 车辆照片缩略图（显示7张必拍照片的缩略图）
      * 操作按钮（如〔查看详情〕〔补录图片〕〔删除记录〕等，参考Screenshot_20251116_141609.jpg中的〔查看详情〕〔查看司机〕〔查看历史记录〕按钮布局）

  - **界面参考**
    + 参考Screenshot_20251116_141609.jpg，采用类似的卡片式布局和时间轴展示方式
    + 每个录入记录卡片清晰展示录入时间、操作人、状态和操作入口
    + 确保从当前活跃车辆列表到车辆历史信息详情页有清晰、便捷的导航入口

- **录入记录详情查看**
  - 点击〔查看详情〕按钮，进入录入记录详情页面
  - 详情页面包含：
    + 提车照片标签页：显示7张必拍照片和车损特写照片（参考image.png中的照片展示布局）
    + 驾驶证照片标签页：显示驾驶证照片和识别信息
    + 还车照片标签页（仅还车记录）：显示还车照片和还车说明
    + 车辆特号标签页：显示车架号等车辆标识信息

#### 2.3.4 录入记录管理功能
- **删除录入记录**
  - 在录入记录卡片右上角显示〔删除〕按钮
  - 点击删除按钮，数据库弹出二次确认弹窗：〔确认删除该录入记录吗？删除后数据将无法恢复〕
  - 确认删除后，数据库删除该录入记录及关联的所有照片
  - 数据库自动更新车辆档案表的total_records字段
  - 如果删除的是最新录入记录，数据库自动更新latest_record_time为次新记录的时间

- **补录图片**
  - 对于状态为〔需补录〕的录入记录，显示〔补录图片〕按钮
  - 点击按钮进入补录界面，管理员只能上传被管理员删除的图片
  - 补录完成后重新提交审核

- **删除车辆档案**
  - 在车辆历史信息追溯页面底部显示〔删除车辆档案〕按钮
  - 点击删除按钮，数据库弹出二次确认弹窗：〔确认删除车辆【京AC83702】的所有记录吗？删除后数据将无法恢复〕
  - 确认删除后，数据库删除车辆档案及关联的所有录入记录和照片

### 2.4 车辆管理端功能需求
#### 2.4.1 车辆管理界面优化
- **车辆档案列表查看**
  - 车辆管理端〔车辆管理〕模块显示所有管辖仓库的车辆档案列表
  - 采用与车辆管理端相同的卡片式布局
  - 支持按仓库、车牌号码、状态等条件筛选
  - 默认展示所有状态标注为〔已启动〕的车辆，提供〔全部车辆〕和〔已启动车辆〕切换标签

- **车辆详情查看**
  - 点击车辆档案卡片，进入车辆历史信息追溯页面
  - 显示车辆的所有录入记录，按时间倒序排列
  - 支持查看每个录入记录的详细信息和照片
  - 每个录入记录清晰标注操作时间、操作人及具体变更内容

#### 2.4.2 审核功能优化
- **按录入记录审核**
  - 审核时以录入记录为单位进行审核，而非以车辆档案为单位
  - 每个录入记录独立审核，互不影响
  - 审核通过后，该录入记录状态更新为〔审核通过〕

- **审核记录关联**
  - 审核记录表（vehicle_audit_log表）关联到具体的录入记录ID
  - 支持查看每个录入记录的完整审核历史

### 2.5 数据库设计
#### 2.5.1 数据关联逻辑
- **车辆档案与录入记录的关联**
  - 车辆档案表（vehicle_profile表）与车辆录入记录表（vehicle_record表）通过vehicle_profile_id字段关联
  - 一个车辆档案可以关联多个录入记录
  - 录入记录表的vehicle_profile_id字段为外键，关联到车辆档案表的id字段

- **自动归类逻辑**
  - 管理员录入驾驶证时，数据库自动识别车牌号码
  - 数据库根据车牌号码查询车辆档案表，判断车辆档案是否存在
  - 如果存在，自动关联到现有车辆档案；如果不存在，自动创建新的车辆档案
  - 数据库自动更新车辆档案表的latest_record_time、total_records和current_status字段

- **当前状态管理逻辑**
  - 提车录入提交审核后，数据库自动将车辆档案的current_status更新为〔active已启动〕
  - 还车录入审核通过后，数据库自动将车辆档案的current_status更新为〔inactive未启动〕
  - 当前活跃车辆列表仅展示current_status=active的车辆

#### 2.5.2 时间排序逻辑
- **车辆档案列表排序**
  - 按latest_record_time字段倒序排列，最新的车辆档案显示在最前面

- **录入记录列表排序**
  - 按record_time字段倒序排列，最新的录入记录显示在最前面

#### 2.5.3 数据同步与缓存
- **实时同步**
  - 车辆管理端录入新记录后，数据库立即更新车辆档案表和录入记录表
  - 通过WebSocket推送更新通知到车辆管理端和车辆管理端
  - 确保所有端的数据一致性

- **缓存更新**
  - 录入记录提交审核后立即更新车辆信息缓存
  - 审核操作完成后立即更新缓存
  - 删除操作完成后立即清除相关缓存

### 2.6 技术实现要求
#### 2.6.1 前端实现
- **当前活跃车辆列表组件**
  - 使用微信小程序原生组件实现卡片式布局
  - 支持下拉刷新和上拉加载更多
  - 支持按车牌号码搜索和筛选
  - 提供〔查看详情〕和〔查看历史记录〕两个操作入口

- **车辆历史信息追溯页面组件**
  - 采用时间轴式布局展示录入记录列表
  - 每个录入记录卡片显示录入时间、操作人、操作时间、具体变更内容、状态、操作按钮等信息
  - 支持点击查看录入记录详情
  - 提供清晰的导航入口，确保从当前活跃车辆列表到历史信息详情页的便捷跳转

- **录入记录详情组件**
  - 使用标签页（Tab）组件展示不同类型的照片
  - 支持图片点击查看大图
  - 支持图片删除和补录操作

#### 2.6.2 后端实现
- **车辆档案自动归类接口**
  - 提供车辆档案查询接口，根据车牌号码查询车辆档案
  - 提供车辆档案创建接口，自动创建新的车辆档案
  - 提供车辆档案更新接口，自动更新latest_record_time、total_records和current_status字段

- **录入记录管理接口**
  - 提供录入记录创建接口，保存新的录入记录，自动记录操作时间、操作人姓名和具体变更内容
  - 提供录入记录查询接口，支持按车辆档案ID查询所有录入记录
  - 提供录入记录删除接口，删除指定的录入记录及关联照片
  - 提供当前活跃车辆列表查询接口，仅返回current_status=active的车辆及其最新录入记录

- **审核功能接口**
  - 提供录入记录审核接口，支持按录入记录ID进行审核
  - 审核通过后自动更新录入记录的audit_status字段
  - 审核操作自动生成审核记录

#### 2.6.3 数据库设计
- **车辆档案表索引**
  - 为plate_number字段创建唯一索引，确保车牌号码唯一性
  - 为latest_record_time字段创建索引，优化排序查询性能
  - 为current_status字段创建索引，优化状态筛选查询性能

- **录入记录表索引**
  - 为vehicle_profile_id字段创建索引，优化关联查询性能
  - 为record_time字段创建索引，优化排序查询性能
  - 为audit_status字段创建索引，优化状态筛选查询性能

## 3. 资产审核闭环管理数据库（照片位置标注与补录界面优化版）
（保持原需求文档内容不变）

## 4. 车辆管理端车辆管理功能迭代升级
（保持原需求文档内容不变）

## 5. 新司机标签自动移除功能
（保持原需求文档内容不变）

## 6. 环形图打卡率可视化展示功能
（保持原需求文档内容不变）

## 7. 手机号一键拨号功能
（保持原需求文档内容不变）

## 8. 计件报表UI功能优化
（保持原需求文档内容不变）

## 9. 仓库管理每日指标数设置功能
（保持原需求文档内容不变）

## 10. 全数据智能缓存与实时同步数据库
（保持原需求文档内容不变）

## 参考文件
1. 管理员管理界面截图：image.png
2. 管理员详情页面截图：image.png
3. 数据仪表盘截图：image.png
4. 管理员汇总界面截图：image.png
5. 司机详情页面截图：image.png
6. 计件记录界面截图：image.png
7. 考勤管理界面截图：image.png
8. 管理员出勤计件截图：image-2.png
9. 提车本入界面截图：image.png
10. 车辆档案界面截图：image.png
11. 提车照片界面截图：image.png
12. 提车照片界面截图：image.png
13. 提车照片界面截图：image.png
14. 车辆档案详情截图：image.png
15. 车辆录入记录列表截图：image.png
16. 车辆历史信息追溯页面截图：Screenshot_20251116_141609.jpg