# 车队管家小程序管理系统需求文档

## 1. 系统概述

### 1.1 系统名称\n车队管家小程序管理系统

### 1.2 系统描述
专为车队管理打造的微信小程序管理系统，提供基础的车队运营管理和数据统计功能，支持便捷的移动管理和操作。升级版系统采用增强型多租户架构，为不同老板客户提供完全独立的数据库环境，确保数据彻底隔离。租赁系统作为独立管理端，专门用于管理租用车队管理小程序的租赁业务。每个老板支持创建多个平级账号，所有平级账号需绑定主号ID，实现灵活的账号管理。

### 1.3 项目目标
快速开发一个可登录的车队管理小程序，实现基础的车辆、司机管理和数据统计功能，并基于增强型多租户架构确保数据完全隔离。新增租赁系统管理功能，专门用于租赁业务的管理功能，为每个老板分配独立数据库，支持每个老板创建多个平级账号并绑定主号ID。

## 2. 核心功能模块

### 2.1 用户管理功能
- **用户登录**：账号密码登录验证
- **用户注册**：基础用户信息注册
- **用户信息管理**：个人信息编辑和更新
- **角色管理**：管理员、司机、车队长、老板、租赁老板等角色分配
- **租赁端登录**：15766121960为租赁端终极登陆账号，必须通过验证码方式进行登录验证

#### 2.1.1 老板账号权限管理
- **平级账号创建**：老板账号可创建最多3个平级账号
- **权限模板配置**：为平级账号提供两种预置权限模板
  - **完整权限**：允许对『车队长』和『司机』账号执行查看、增加、修改、停用操作
  - **仅查看权限**：仅允许查看相关数据，无权进行任何修改操作
- **管理范围**：老板账号只能管辖名下平级车队长、司机账号，无权干预其他老板账号

#### 2.1.2 平级账号权限管理
- **默认权限**：平级账号（同为老板角色）默认只能管辖自己名下创建的『车队长』与『司机』账号
- **权限继承**：平级账号权限基于创建时选择的老板账号权限模板
- **数量限制**：每个老板账号可创建的平级账号数量上限为3个

#### 2.1.3 车队长账号权限管理
- **管理范围限制**：车队长只能管理其管辖范围内的『司机』账号
- **权限开关**：用户信息修改权限开关
  - **开启时**：车队长可以对其管辖的司机账号执行查看、增加、修改、停用操作
  - **关闭时**：车队长仅能查看司机信息，无权进行任何修改
- **操作记录**：系统记录车队长的所有操作日志

### 2.2 车辆管理功能
- **车辆信息管理**：车辆基本信息录入和查询
- **车辆状态监控**：车辆使用状态跟踪
- **车辆分配管理**：司机与车辆匹配管理

### 2.3 司机管理功能
- **司机档案管理**：司机个人信息录入和管理
- **司机状态管理**：出勤状态和工作排班
- **绩效查看**：司机工作效率统计

### 2.4 数据统计功能
- **关键数据统计**：出勤人数、总件数、完成件数等统计
- **车辆使用率统计**：车辆使用情况分析
- **司机工作效率统计**：司机绩效数据展示

### 2.5 租赁系统管理功能
租赁系统是一个管理租用车队管理小程序的独立管理端，提供以下功能：

#### 2.5.1 租赁系统用户管理
- **创建租赁系统用户**：新增租赁系统的管理用户
- **查看所有租赁系统用户**：列表展示所有租赁系统用户信息
- **编辑租赁系统用户信息**：修改租赁系统用户的基本信息和权限

#### 2.5.2 租赁核销功能
- **核销操作**：对租赁业务进行核销处理
- **核销记录查询**：查看历史核销记录

#### 2.5.3 老板账号管理
每个老板账号视为单独的租赁用户，仅需管理老板账号，不需要查看每个老板下面的所有用户。
- **新增老板账号**：创建新的老板账号，自动为该老板创建独立的数据库
- **修改老板账号**：编辑老板账号的基本信息
- **停用老板账号**：暂时停用老板账号的使用权限
- **删除老板账号**：永久删除老板账号及相关数据库
- **老板账号列表**：查看所有老板账号的基本信息和状态

#### 2.5.4 平级账号管理（新增）
每个老板可以创建多个平级账号，所有平级账号需要绑定主号ID，确保账号归属清晰。
- **创建平级账号**：为指定老板创建新的平级账号，自动绑定该老板的主号ID
- **查看平级账号列表**：展示某个老板下所有平级账号的信息，包括账号名称、绑定的主号ID、创建时间等
- **编辑平级账号**：修改平级账号的基本信息（保持主号ID绑定不变）
- **删除平级账号**：删除指定的平级账号
- **主号ID绑定验证**：确保每个平级账号必须绑定有效的主号ID，防止孤立账号存在

### 2.6 老板唯一标识系统

#### 2.6.1 唯一标识生成策略
- **标识格式**：BOSS_{timestamp}_{random8digits}
- **生成规则**：
  - BOSS_前缀标识老板身份
  - timestamp为当前时间戳确保时间唯一性
  - random8digits为8位随机数字保证随机性
- **生成算法**：采用分布式安全生成算法，确保跨节点环境下的唯一性

#### 2.6.2 数据隔离架构
- **数据库设计**：为每个老板创建独立的数据库实例
- **数据库分片**：基于boss_id实现数据库分片策略
- **缓存层标识**：采用boss_id作为key的前缀标识\n- **分区策略**：物理隔离不同boss_id的数据库实例

#### 2.6.3 接口验证机制
- **验证位置**：在所有业务接口入口处增加老板标识验证过滤器
- **验证流程**：
  - 从请求头/Token中提取boss_id
  - 验证boss_id的有效性和权限状态
  - 将验证通过的boss_id注入线程上下文
- **安全策略**：实施IP白名单和频率限制

#### 2.6.4 数据操作规范
- **SQL规范**：所有数据库操作必须基于正确的数据库实例
- **示例SQL**：SELECT * FROM table WHERE condition
- **权限校验**：业务逻辑执行前必须校验操作者与目标数据的归属关系
- **数据完整性**：确保所有操作都基于正确的boss_id上下文

#### 2.6.5 权限控制系统
- **层级关系**：建立老板-员工层级关系映射表
- **细粒度控制**：基于boss_id的细粒度权限控制
- **归属验证**：所有功能操作验证操作者与目标数据的归属关系
- **角色分离**：明确不同角色的访问权限边界

#### 2.6.6 异常处理
- **异常类型**：定义标识缺失或无效的具体异常类型
- **错误码**：统一异常返回格式和错误码
- **日志审计**：记录标识验证失败的详细日志用于审计
- **安全报警**：异常访问模式触发安全警报

## 3. 系统逻辑流程

### 3.1 小程序登录流程
1. 用户打开小程序
2. 进入登录页面
3. 输入账号和密码
4. 系统验证账号有效性
5. 验证密码正确性
6. 检查用户角色
7. 自动获取当前用户ID作为租户标识
8. 跳转到对应管理首页

### 3.2 租赁端登录特殊流程
1. 用户使用15766121960账号登录
2. 系统强制要求进行验证码验证
3. 验证通过后自动识别为租赁端角色
4. 跳转到租赁系统管理首页

### 3.3 仪表盘访问流程
1. 用户登录成功后自动跳转到仪表盘
2. 系统基于当前用户ID过滤数据
3. 显示对应租户的关键数据概览\n4. 支持数据详情查看

### 3.4 租赁系统管理流程
1. 租赁端管理员登录后进入租赁系统管理首页
2. 可选择进入租赁系统用户管理、核销功能或老板账号管理
3. 执行相应的创建、查看、编辑、停用、删除等操作
4. 系统记录操作日志并更新数据状态

### 3.5 平级账号管理流程（新增）
1. 租赁端管理员进入老板账号管理页面
2. 选择某个老板账号，进入平级账号管理界面
3. 点击〖创建平级账号〗按钮
4. 输入平级账号信息（账号名称、密码等），系统自动绑定该老板的主号ID
5. 选择权限模板（完整权限/仅查看权限）
6. 保存后，新平级账号出现在平级账号列表中
7. 支持对平级账号进行编辑或删除操作
8. 系统验证所有平级账号均已正确绑定主号ID
\n### 3.6 车队长权限管理流程
1. 车队长登录系统后自动进入管理界面
2. 系统识别车队长的管理范围和权限级别
3. 根据权限开关状态决定车队长的操作权限
4. 所有操作均记录详细日志

### 3.7 老板标识验证流程
1. 请求到达系统接口
2. 从请求头/Token中提取boss_id
3. 验证boss_id格式的有效性
4. 检查boss_id在系统中的注册状态
5. 验证通过后将boss_id注入线程上下文
6. 继续后续业务逻辑处理
7. 验证失败返回相应错误响应

## 4. 用户界面布局

### 4.1 登录页面布局
- **账号输入框**：支持邮箱或手机号登录
- **密码输入框**
- **验证码输入框**（租赁端专用）
- **登录按钮**
- **注册入口**

### 4.2 仪表盘界面布局
- **顶部导航栏**：包含用户信息和基础菜单
- **数据看板区域**：关键指标卡片展示
- **统计图表区**：基础图表展示

### 4.3 车辆管理界面
- **车辆列表**：显示车辆基本信息
- **筛选功能**
- **详情页面**：查看车辆完整档案

### 4.4 司机管理界面
- **司机列表**：显示司机基本信息
- **筛选功能**
- **详情页面**：查看司机完整档案

### 4.5 租赁系统管理界面

#### 4.5.1 老板账号管理界面
- **老板账号列表**：显示所有老板账号的基本信息和状态（正常/停用）
- **新增按钮**：创建新的老板账号，自动创建独立数据库
- **操作菜单**：每个老板账号提供修改、停用、删除操作入口
- **平级账号管理入口**：点击某个老板账号可进入平级账号管理页面
- **搜索筛选**：支持按账号名称、状态等条件筛选

#### 4.5.2 平级账号管理界面（新增）
- **平级账号列表**：显示当前老板下所有平级账号的信息，包括账号名称、绑定的主号ID、创建时间等
- **创建平级账号按钮**：新增平级账号入口
- **编辑功能**：点击平级账号可进入编辑页面
- **删除功能**：支持删除指定的平级账号
- **主号ID显示**：界面顶部或侧栏明确显示当前老板的主号ID
- **权限模板显示**：显示每个平级账号的当前权限配置（完整权限/仅查看权限）
- **搜索筛选**：支持按账号名称、创建时间等条件筛选

#### 4.5.3 车队长管理界面
- **车队长列表**：显示所有车队长的基本信息和管理范围\n- **权限开关**：为每个车队长提供用户信息修改权限的开关控制
- **操作记录**：展示车队长的历史操作日志
- **查看详情**：点击车队长可查看其管辖的司机列表

### 4.6 老板标识显示规范
- **界面顶部**：在导航栏右侧显示当前登录用户的boss_id
- **管理页面**：在操作区域显示当前操作的boss_id上下文
- **数据列表**：在数据项中显示对应的boss_id标识
- **权限提示**：在敏感操作时弹出boss_id归属验证提示

## 5. 安全配置要求

### 5.1 用户认证
- **登录机制**：基于用户名密码的用户认证
- **密码安全**：密码加密存储\n- **登录失败处理**：登录失败次数限制
- **验证码验证**：租赁端强制要求验证码验证

### 5.2 权限校验
- **角色权限**：基于角色的权限控制
- **功能授权**：粗粒度的功能访问控制
- **租赁端权限**：15766121960账号拥有最高租赁管理权限
- **平级账号权限**：平级账号仅能访问绑定主号ID对应老板的数据，无法跨老板访问
- **车队长权限**：基于权限开关的动态权限控制

### 5.3 增强型多租户安全隔离
- **独立数据库**：为每个老板创建独立的数据库实例
- **数据完全隔离**：确保老板间数据彻底隔离，无任何交叉访问
- **多层次隔离机制**：在数据库层、应用层实现多重数据隔离防护
- **平级账号数据隔离**：所有平级账号共享绑定主号ID的数据环境，但不能访问其他老板的数据

### 5.4 老板标识安全控制
- **标识验证**：在每次请求中验证boss_id的有效性和完整性
- **跨域保护**：防止伪造或篡改boss_id的跨域攻击
- **会话绑定**：将boss_id与用户会话绑定，防止会话劫持
- **审计追踪**：记录所有涉及boss_id的操作日志

## 6. 增强型多租户架构设计

### 6.1 核心目标
为每个老板客户提供完全独立的数据库环境，确保所有租户数据在存储和访问时实现彻底隔离，防止数据泄露和越权访问。支持每个老板创建多个平级账号，所有平级账号共享主号ID的数据环境。

### 6.2 数据隔离策略
采用独立数据库的物理隔离机制，在数据库层面为每个老板的数据建立完全独立的存储空间。平级账号通过主号ID绑定实现数据共享，但仅限于同一老板账号下。

### 6.3 实现层面要求
- **独立数据库**：为每个老板创建独立的数据库实例
- **数据完全隔离**：确保老板间数据无任何共享和交叉
- **租户上下文管理**：在应用层实现老板级租户上下文管理机制
- **请求识别**：确保在每次请求中能正确识别并提供当前请求的老板标识
- **平级账号绑定**：所有平级账号必须绑定主号ID，系统根据主号ID确定数据访问权限
- **数据迁移**：现有租户数据迁移到对应的独立数据库

### 6.4 技术实现步骤

#### 6.4.1 租户上下文管理
- 在应用启动时初始化老板级租户上下文管理模块
- 基于用户登录信息自动加载当前老板标识
- 为每个HTTP请求绑定老板租户上下文信息
- 实现在不同中间件间传递老板ID
- 平级账号登录时，自动获取绑定的主号ID并加载对应租户上下文

#### 6.4.2 数据访问层改造
- 为每个老板创建独立的数据库实例
- 修改数据库连接配置，自动适配不同老板的数据库
- 实现数据访问的默认安全策略
- 测试数据隔离的有效性
- 确保平级账号只能访问绑定主号ID的数据库
- 迁移现有租户数据到对应的独立数据库

#### 6.4.3 安全验证增强
- 在控制器层验证数据归属
- 实施细粒度的权限检查
- 监控并阻止潜在的越权访问尝试
- 定期审计数据访问日志
- 验证平级账号的主号ID绑定有效性，防止孤立账号或越权访问

#### 6.4.4 租户数据迁移
- 设计老板级数据迁移流程
- 实现数据从原有存储结构迁移到独立数据库
- 确保数据迁移过程中的完整性
- 验证迁移后数据的正确性和可用性
- 为现有租户分配对应的独立数据库
\n#### 6.4.5 平级账号绑定机制（新增