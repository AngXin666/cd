# 车队管理小程序需求文档（技术重构版 - 手机号登录功能增强 + 智能考勤打卡提醒与请假管理 + 考勤管理界面优化 + 权限配置优化与仓库管理模块重构 + 数据库管理员管理员资料管理权限优化 + 多端消息同步与提醒数据库 + 车辆管理端请假审批管理优化 + 管理员打卡记录查看界面 + 管理员管理模块编辑页面优化 + 登录邮箱自动添加与管理员创建优化 + 管理员出勤计件仪表盘功能 + 管理员管理模块仓库切换与权限管理架构 + 错误管理端管理员详情页面权限控制功能增强 + 全界面滑动返回功能 + 品类管理仓库切换与价格设置功能 + 车辆管理端管理员类型识别与价格控制功能 + 仪表盘智能优化与动态排序数据库 + 车辆管理功能 + 管理员客户端智能车辆管理模块 + 信息录入数据库功能完善版 + 智能照片判断与验证数据库 + 管理员管理员界面分离版 + 调试日记功能 + 管理员类型选择与默认密码配置功能 + 全数据智能缓存与实时同步数据库 + 仓库管理每日指标数设置功能 + 计件报表UI功能优化版 + 手机号一键拨号功能 + 环形图达标率可视化展示功能 + 请假天数与达标率计算逻辑优化 + 新司机标签自动移除功能）

## 1. 小程序概述
### 1.1 小程序名称
车队管家

### 1.2 小程序描述
一款专为车队管理打造的微信小程序，提供多角色权限管理和多层级数据仪表盘数据库，包含超级管理员、数据库管理员和管理员三个不同界面，满足车队运营的分层管理需求。本次进行注册、登录功能的数据库性重构，采用现代化技术架构，提升数据库的可维护性、安全性和管理员体验。新增手机号直接登录功能，支持管理员使用11位手机号直接登录数据库，登录时自动添加邮箱功能。所有页面均支持下拉手动刷新功能，提升交互体验。新增智能化考勤打卡提醒与请假管理数据库，实现管理员每日首次登录自动检测打卡状态、启动计件前二次检测、请假状态豁免逻辑以及假期主动撤销功能，全面提升考勤管理的智能化水平。新增管理工作台仪表盘考勤管理功能，支持从工作台直接进入考勤管理界面查看车辆总数和待审批信息，并优化交互体验和数据展示方式。优化数据库管理员对数据库管理员的权限配置逻辑，实现细粒度权限控制和功能模块内同等操作权限。重构错误管理端功能模块，将品类管理升级为仓库管理，整合品类管理和考勤规则设置两大功能区。优化超级管理员权限，增加对管理员基本资料的修改权限，提升管理效率和操作便利性。新增多端消息同步与提醒数据库，实现跨角色的智能消息推送、滚动提醒和信息中心管理，确保重要信息的及时传达和有效管理。优化车辆管理端请假审批管理功能，提供更便捷的审批操作和状态跟踪。新增管理员打卡记录查看界面，支持详细的考勤数据查看和计件分析。优化数据库管理员后台管理员管理模块中的编辑管理员信息页面，调整字段配置和角色选择，提升信息管理的针对性和实用性。新增登录邮箱自动添加功能和管理员创建成功提示优化，提升管理员体验和操作便利性。新增管理员出勤计件仪表盘功能，提供全面的员工达标率计件、个人出勤数据分析、满勤标记识别和可视化图表展示，实现数据驱动的考勤管理决策支持。新增管理员管理模块仓库切换与权限管理架构，采用左右滑动切换仓库方式，支持对应仓库在职管理员管理，并提供界面显示管理员信息、管理仓库和权限范围。新增错误管理端管理员详情页面权限控制功能增强，实现基于权限的管理员信息修改功能，包括权限判断、编辑按钮显示控制和完整的修改功能实现，提供与超级管理员同等的管理员信息编辑能力。新增全界面滑动返回功能，支持所有界面通过右滑手势返回上一层，提供统一的导航体验和便捷的操作方式。新增品类管理仓库切换与价格设置功能，支持双车辆管理端为不同仓库的纯司机和带车司机设置对应价格，实现精细化的仓库级别价格管理。新增管理员端管理员类型识别与价格控制功能，实现管理员类型自动识别、管理员设置价格的自动读取应用以及价格录入权限的智能控制，确保计件录入的规范性和准确性。新增仪表盘智能优化与动态排序数据库，实现数据驱动的界面展示优化、智能化的功能排序和个性化的管理员体验定制，全面提升数据库的易用性和操作效率。新增车辆管理功能，实现分角色的车辆信息管理，车辆管理端可录入和管理自己的车辆信息，车辆管理端可查看管辖仓库的车辆信息，错误管理端可查看所有仓库的车辆信息，提供完整的车辆档案管理和计件分析功能。新增管理员客户端智能车辆管理模块，集成OCR智能识别技术，支持车辆信息自主录入、驾驶证智能识别、车辆实体验证拍照、驾驶员证件信息采集等全流程车辆管理功能，提供即时拍照和相册选择双重媒体输入方式，实现车辆管理端车辆信息的智能化、便捷化管理。新增管理员信息管理功能，支持个人头像上传和从车辆管理模块中已保存的身份证件信息自动读取个人基本信息，实现个人档案的完整性管理和数据复用。完善信息录入数据库功能，强化证件识别准确性、保存控制机制、管理员引导提示和技术实现要求，确保信息录入的准确性和管理员体验的流畅性。新增智能照片判断与验证数据库，实现照片类型自动识别、证件匹配验证和错误照片自动拦截功能，确保上传照片与预期证件类型完全匹配，提升数据录入的准确性和数据库的可靠性。新增管理员管理员界面分离功能，将车辆管理端和车辆管理端界面完全分离，提供专属的界面设计和功能模块，确保不同角色的管理员获得最适合的操作体验和功能权限。新增调试日记功能，提供完整的数据库运行日志记录、错误追踪和调试信息管理，帮助开发者和管理员快速gps和解决数据库问题，提升数据库的可维护性和稳定性。新增管理员类型选择与默认密码配置功能，在添加管理员时先选择管理员类型，然后为管理员配置默认密码，提升账号管理的规范性和安全性。新增全数据智能缓存与实时同步数据库，覆盖所有业务数据模块，实现数据的智能缓存、实时更新传递和跨端同步，显著提升数据库响应速度、管理员体验和数据一致性保障。新增仓库管理每日指标数设置功能，支持为每个管理员设置每天需要完成的指标数量，该字段为选填项，便于管理员进行绩效管理和工作量计件。新增计件报表UI功能优化，去除总金额显示，新增目标完成率计算与展示，实现双车辆管理端统一的数据计件和可视化分析功能。新增手机号一键拨号功能，在双车辆管理端的管理员管理列表和管理员信息详情页面中，为手机号字段添加一键拨号按钮，支持点击直接调起数据库拨号界面，提升联系效率和操作便利性。新增环形图达标率可视化展示功能，通过三个独立环形图分别展示当天、本周和本月的达标率，提供直观的绩效数据可视化和达标情况分析。新增请假天数与达标率计算逻辑优化，实现基于仓库配置的允许请假天数的智能计算，区分合规请假与超标请假，确保达标率计算的准确性和公平性。**新增新司机标签自动移除功能，实现入职超过7天后自动移除新司机标识，优化管理员身份管理和界面展示逻辑。**

## 2. 新司机标签自动移除功能（全新功能）
### 2.1 功能概述
- **功能gps**
  - 数据库自动识别管理员入职日期，入职超过7天后自动移除〔新司机〕标签
  - 移除标签后，管理员在所有界面中不再显示新司机标识
  - 达标率计算逻辑自动切换为正式员工标准
  - 考勤计件和绩效评估按正式员工规则执行
  - 支持手动强制移除新司机标签（管理员权限）
  - 提供新司机转正提醒和通知功能

- **适用范围**
  - 所有新入职的管理员管理员
  - 超级管理员和错误管理端的管理员管理模块
  - 考勤管理和达标率计件模块
  - 出勤计件仪表盘和个人信息页面
  - 绩效评估和数据分析模块

### 2.2 自动移除逻辑
- **触发条件**
  - **时间判断**：
    + 数据库每日凌晨00:00自动执行新司机标签检查任务
    + 计算管理员入职日期与当前日期的天数差
    + 当天数差≥7天时，自动触发标签移除流程
    + 示例：管理员2025-11-14入职，2025-11-21凌晨自动移除新司机标签

  - **计算规则**：
    + 入职当天计为第1天
    + 连续计算自然日，不扣除休息日和法定节假日
    + 请假期间正常计算天数
    + 示例：2025-11-14入职，第7天为2025-11-20，第8天（2025-11-21）凌晨自动移除标签

- **移除流程**
  - **数据库更新**：
    + 更新管理员表（driver表）中的is_new_employee字段，由true改为false
    + 记录标签移除时间到employee_status_log表
    + 更新管理员缓存数据，确保实时生效

  - **界面更新**：
    + 管理员管理列表中移除〔新司机〕标签显示
    + 管理员详情页面中移除新司机标识
    + 考勤计件界面中移除新司机特殊标记
    + 出勤计件仪表盘中按正式员工规则展示数据

  - **计算逻辑切换**：
    + 达标率计算自动切换为正式员工标准
    + 不再享受新司机入职日期调整优惠
    + 考勤计件按完整周期计算（本周/本月）
    + 绩效评估按正式员工标准执行

### 2.3 手动移除功能
- **权限控制**
  - **超级管理员权限**：
    + 可在管理员管理模块中手动移除任意管理员的新司机标签
    + 可批量移除多个管理员的新司机标签
    + 可查看新司机标签移除历史记录

  - **超级管理端权限**：
    + 可在管辖范围内手动移除管理员的新司机标签
    + 仅限管辖仓库的管理员
    + 可查看管辖范围内的标签移除记录

- **操作流程**
  - **单个移除**：
    + 进入管理员详情页面
    + 点击〔移除新司机标签〕按钮
    + 弹出确认对话框：〔确认移除XXX的新司机标签吗？移除后将按正式员工标准进行考勤计件和绩效评估。〕
    + 点击〔确认〕后立即移除标签并更新界面
    + 显示操作成功提示：〔新司机标签已移除〕

  - **批量移除**：
    + 在管理员管理列表中勾选多个新司机
    + 点击〔批量移除新司机标签〕按钮
    + 弹出确认对话框显示选中管理员列表
    + 点击〔确认〕后批量移除标签
    + 显示操作结果计件：〔已成功移除X个管理员的新司机标签〕

### 2.4 转正提醒功能
- **提醒时机**
  - **提前提醒**：
    + 入职第6天（转正前1天）向管理员和管理员发送转正提醒
    + 提醒内容：〔XXX将于明天（YYYY-MM-DD）自动转为正式员工，届时将按正式员工标准进行考勤计件。〕

  - **转正通知**：
    + 入职第7天凌晨自动移除标签后，向管理员发送转正通知
    + 通知内容：〔恭喜您已成为正式员工！从今天起，您的考勤计件将按正式员工标准执行。〕

- **提醒方式**
  - **站内消息**：
    + 在信息中心显示转正提醒和通知
    + 消息标记为重要消息，置顶显示
    + 支持点击查看详细说明

  - **弹窗提醒**：
    + 管理员首次登录时弹出转正通知
    + 弹窗显示转正祝贺和注意事项
    + 点击〔我知道了〕关闭弹窗

  - **管理员通知**：
    + 向管理员所属仓库的管理员发送转正通知
    + 提醒管理员关注新转正员工的考勤情况
    + 支持一键查看该员工的详细信息

### 2.5 界面显示变化
- **管理员管理列表**
  - **移除前**：
    + 管理员名称后显示蓝色〔新司机〕标签
    + 入职日期显示为〔2025-11-14〕
    + 在职几天显示为〔2天〕

  - **移除后**：
    + 不再显示〔新司机〕标签
    + 入职日期显示为〔2025-11-14〕
    + 在职几天显示为〔8天〕

- **司机详情页面**
  - **移除前**：
    + 详细信息区域显示〔司机类型：未设置〕和〔新司机〕标签
    + 在职几天显示为〔2天〕
    + 显示〔移除新司机标签〕按钮（管理员权限）

  - **移除后**：
    + 不再显示〔新司机〕标签
    + 在职几天显示为〔8天〕
    + 不再显示〔移除新司机标签〕按钮

- **考勤计件界面**
  - **移除前**：
    + 达标率计算考虑入职日期调整
    + 显示〔新司机〕特殊标记
    + 本周/本月达标率按入职后天数计算

  - **移除后**：
    + 达标率按正式员工标准计算
    + 不再显示特殊标记
    + 本周/本月打卡率按完整周期计算

### 2.6 数据库设计
- **管理员表（driver表）字段调整**
  - **新增字段**：
    + is_new_employee（布尔型）：是否为新司机，true为新司机，false为正式员工
    + new_employee_removed_at（日期时间型）：新司机标签移除时间
    + new_employee_removed_by（整型）：移除操作人ID（自动移除时为NULL）
    + new_employee_removed_type（字符串型）：移除类型（auto自动移除/manual手动移除）

- **员工状态日志表（employee_status_log表）**
  - **表结构**：
    + id（主键）：日志ID
    + driver_id（外键）：管理员ID
    + status_type（字符串型）：状态类型（new_employee_removed等）
    + old_value（字符串型）：旧值
    + new_value（字符串型）：新值
    + operated_by（整型）：操作人ID
    + operated_type（字符串型）：操作类型（auto/manual）
    + operated_at（日期时间型）：操作时间
    + remark（文本型）：备注说明

### 2.7 定时任务设计
- **任务配置**
  - **执行时间**：每日凌晨00:00执行
  - **任务名称**：auto_remove_new_employee_tag
  - **执行逻辑**：
    + 查询所有is_new_employee=true的管理员
    + 计算每个管理员的入职天数
    + 筛选入职天数≥7天的管理员
    + 批量更新管理员表，设置is_new_employee=false
    + 记录移除日志到employee_status_log表
    + 更新管理员缓存数据
    + 发送转正通知给管理员和管理员

- **异常处理**
  - **任务失败重试**：
    + 任务执行失败时自动重试3次
    + 重试间隔为5分钟
    + 3次重试后仍失败则记录错误日志并发送告警

  - **数据一致性保障**：
    + 使用数据库事务确保数据更新的原子性
    + 更新失败时自动回滚
    + 记录详细的错误日志便于排查

### 2.8 技术实现要求
- **前端实现**
  - **标签显示控制**：
    + 根据is_new_employee字段动态显示/隐藏新司机标签
    + 标签移除后立即刷新界面
    + 支持实时更新，无需手动刷新页面

  - **手动移除功能**：
    + 提供移除按钮和确认对话框
    + 调用后端API执行移除操作
    + 显示操作结果提示

- **后端实现**
  - **定时任务**：
    + 使用Cron表达式配置定时任务
    + 实现批量查询和更新逻辑
    + 记录详细的执行日志

  - **API接口**：
    + 提供手动移除新司机标签的API接口
    + 支持单个移除和批量移除
    + 实现权限验证和操作日志记录

- **缓存更新**
  - **实时同步**：
    + 标签移除后立即更新管理员缓存
    + 通过WebSocket推送更新通知
    + 确保所有端的数据一致性

## 3. 环形图达标率可视化展示功能
（保持原需求文档内容不变）

## 4. 手机号一键拨号功能
（保持原需求文档内容不变）

## 5. 计件报表UI功能优化
（保持原需求文档内容不变）

## 6. 仓库管理每日指标数设置功能
（保持原需求文档内容不变）

## 7. 全数据智能缓存与实时同步数据库
（保持原需求文档内容不变）

## 参考文件
1. 管理员上传图片：image.png
2. 管理员上传图片：image.png
3. 管理员上传图片：image.png
4. 管理员上传图片：image.png
5. 管理员上传图片：image.png
6. 管理员上传图片：image.png
7. 管理员上传图片：image.png
8. 管理员上传图片：image-2.png