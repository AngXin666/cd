# 车队管家小程序管理系统需求文档

## 1. 系统概述

### 1.1 系统名称\n车队管家小程序管理系统

### 1.2 系统描述
专为车队管理打造的微信小程序管理系统，采用独立数据库模式为每个老板提供完全隔离的数据环境，支持车辆、司机管理和数据统计功能。

### 1.3 项目目标
快速开发一个可登录的车队管理小程序，实现基础的车辆、司机管理和数据统计功能，基于独立数据库模式确保数据完全隔离。

## 2. 核心功能模块

### 2.1 用户管理功能
- **用户登录**：账号密码登录验证
- **用户注册**：基础用户信息注册
- **用户信息管理**：个人信息编辑和更新
- **角色管理**：管理员、司机、车队长、老板等角色分配

#### 2.1.1 老板账号管理
- **平级账号管理**：老板账号可创建和平级账号共享相同权限
- **平级账号限制**：每个老板最多可创建3个平级账号
- **管理权限**：老板可查看、修改、停用、删除平级账号
- **数据共享**：平级账号使用老板账号的同一数据库环境

#### 2.1.2 车队长账号权限管理
- **管理范围限制**：车队长只能管理其管辖范围内的『司机』账号
- **权限开关**：用户信息修改权限开关
  - **开启时**：车队长可以对其管辖的司机账号执行查看、增加、修改、停用操作
  - **关闭时**：车队长仅能查看司机信息，无权进行任何修改
- **操作记录**：系统记录车队长的所有操作日志

### 2.2 车辆管理功能
- **车辆信息管理**：车辆基本信息录入和查询
- **车辆状态监控**：车辆使用状态跟踪
- **车辆分配管理**：司机与车辆匹配管理

### 2.3 司机管理功能
- **司机档案管理**：司机个人信息录入和管理
- **司机状态管理**：出勤状态和工作排班
- **绩效查看**：司机工作效率统计

### 2.4 数据统计功能
- **关键数据统计**：出勤人数、总件数、完成件数等统计
- **车辆使用率统计**：车辆使用情况分析
- **司机工作效率统计**：司机绩效数据展示

## 3. 系统逻辑流程

### 3.1 小程序登录流程
1. 用户打开小程序
2. 进入登录页面
3. 输入账号和密码\n4. 系统验证账号有效性
5. 验证密码正确性
6. 检查用户角色
7. 自动获取当前用户ID作为租户标识
8. 跳转到对应管理首页

### 3.2 仪表盘访问流程
1. 用户登录成功后自动跳转到仪表盘
2. 系统基于当前用户ID过滤数据
3. 显示对应租户的关键数据概览
4. 支持数据详情查看

### 3.3 车队长权限管理流程
1. 车队长登录系统后自动进入管理界面
2. 系统识别车队长的管理范围和权限级别
3. 根据权限开关状态决定车队长的操作权限
4. 所有操作均记录详细日志

### 3.4 平级账号管理流程
1. 老板登录系统后可进入账号管理界面
2. 老板可创建新的平级账号（最多3个）
3. 平级账号与老板账号共享同一数据库
4. 老板可管理所有平级账号的状态和权限

## 4. 用户界面布局

### 4.1 登录页面布局
- **账号输入框**：支持邮箱或手机号登录
- **密码输入框**
- **登录按钮**
- **注册入口**

### 4.2 仪表盘界面布局
- **顶部导航栏**：包含用户信息和基础菜单
- **数据看板区域**：关键指标卡片展示
- **统计图表区**：基础图表展示

### 4.3 车辆管理界面
- **车辆列表**：显示车辆基本信息
- **筛选功能**
- **详情页面**：查看车辆完整档案

### 4.4 司机管理界面
- **司机列表**：显示司机基本信息
- **筛选功能**
- **详情页面**：查看司机完整档案

### 4.5 权限管理界面
- **权限配置页面**：参考用户提供的image.png
- **仓库分配功能**：为管理员分配管理的仓库
- **功能权限设置**：配置用户信息修改权等功能操作权限
- **保存配置按钮**：蓝色主色调按钮

### 4.6 用户信息页面
- **用户基本信息**：显示姓名、实名状态、角色等
- **账号信息**：显示登录账号
- **管理功能按钮**：仓库分配、权限管理等操作入口
- **箭头指示**：突出重要操作区域
- **参考界面**：参考用户提供的image-2.png

### 4.7 账号管理界面
- **账号列表**：显示所有平级账号的信息
- **创建账号**：老板可创建新的平级账号（限制3个）
- **账号操作**：查看、修改、停用、删除平级账号
- **权限显示**：标识哪些账号是平级关系

## 5. 独立数据库架构设计

### 5.1 核心目标
为每个老板客户提供完全独立的数据库环境，确保所有租户数据在存储和访问时实现彻底隔离，防止数据泄露和越权访问。

### 5.2 数据隔离策略
采用独立数据库的物理隔离机制，在数据库层面为每个老板的数据建立完全独立的存储空间。

### 5.3 实现层面要求
- **独立数据库**：为每个老板创建独立的数据库实例
- **数据完全隔离**：确保老板间数据无任何共享和交叉
- **租户上下文管理**：在应用层实现老板级租户上下文管理机制
- **请求识别**：确保在每次请求中能正确识别并提供当前请求的老板标识
- **平级账号共享**：平级账号与老板账号共享同一数据库环境

### 5.4 技术实现步骤

#### 5.4.1 租户上下文管理
- 在应用启动时初始化老板级租户上下文管理模块
- 基于用户登录信息自动加载当前老板标识
- 为每个HTTP请求绑定老板租户上下文信息
- 实现在不同中间件间传递老板ID
- **平级账号识别**：在上下文中标识平级账号归属的老板

#### 5.4.2 数据访问层改造
- 为每个老板创建独立的数据库实例
- 修改数据库连接配置，自动适配不同老板的数据库
- 实现数据访问的默认安全策略
- 测试数据隔离的有效性
- 迁移现有租户数据到对应的独立数据库
- **平级账号数据共享**：确保平级账号访问老板账号的同一数据库

#### 5.4.3 安全验证增强
- 在控制器层验证数据归属
- 实施细粒度的权限检查
- 监控并阻止潜在的越权访问尝试
- 定期审计数据访问日志
- **平级账号验证**：确保平级账号操作受限于其老板的数据库范围

#### 5.4.4 租户数据迁移
- 设计老板级数据迁移流程
- 实现数据从原有存储结构迁移到独立数据库
- 确保数据迁移过程中的完整性
- 验证迁移后数据的正确性和可用性
- 为现有租户分配对应的独立数据库
- **平级账号数据同步**：确保平级账号与老板账号数据的一致性

## 6. 安全配置要求

### 6.1 用户认证
- **登录机制**：基于用户名密码的用户认证
- **密码安全**：密码加密存储
- **登录失败处理**：登录失败次数限制

### 6.2 权限校验
- **角色权限**：基于角色的权限控制
- **功能授权**：粗粒度的功能访问控制
- **车队长权限**：基于权限开关的动态权限控制
- **平级账号权限**：平级账号与老板账号权限相同
- **独立数据库权限**：确保每个老板只能访问自己的独立数据库
- **平级账号管理**：老板账号有权管理其创建的平级账号

### 6.3 独立数据库安全隔离
- **独立数据库**：为每个老板创建独立的数据库实例
- **数据完全隔离**：确保老板间数据彻底隔离，无任何交叉访问
- **多层次隔离机制**：在数据库层、应用层实现多重数据隔离防护
- **平级账号共享**：平级账号与老板账号共享同一数据库环境

### 6.4 数据访问安全控制
- **标识验证**：在每次请求中验证老板标识的有效性和完整性
- **跨域保护**：防止伪造或篡改标识的跨域攻击
- **会话绑定**：将老板标识与用户会话绑定，防止会话劫持
- **审计追踪**：记录所有涉及老板标识的操作日志
- **平级账号追踪**：单独记录平级账号的操作日志并关联到老板

## 7. 界面设计风格

### 7.1 配色方案
- 主色调：蓝色系（#1890FF），体现专业可靠
- 辅助色：绿色（#52C41A）用于成功状态，红色（#FF4D4F）用于警告或错误
- 背景色：浅灰色（#F5F5F5）营造清爽感

### 7.2 视觉细节
- 圆角设计：统一使用4px圆角，增加亲和力
- 卡片式布局：数据展示采用卡片形式，层次分明
- 图标风格：线性图标风格，简洁现代

### 7.3 整体布局
- 采用卡片式布局，内容分区清晰
- 左右分栏结构，便于数据对比查看
- 顶部导航栏固定，底部标签栏便于快速切换

## 8. 参考界面

### 8.1 权限配置页面
使用用户提供的图片image.png作为权限管理界面参考

### 8.2 用户信息页面
使用用户提供的图片image-2.png作为用户信息管理界面参考