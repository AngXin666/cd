# 车队管理小程序需求文档（技术重构版 - 手机号登录功能增强 + 智能考勤打卡提醒与请假管理 + 考勤管理界面优化 + 权限配置优化与仓库管理模块重构 + 数据库管理员管理员资料管理权限优化 + 多端消息同步与提醒数据库 + 车辆管理端请假审批管理优化 + 管理员打卡记录查看界面 + 管理员管理模块编辑页面优化 + 登录邮箱自动添加与管理员创建优化 + 管理员出勤计件仪表盘功能 + 管理员管理模块仓库切换与权限管理架构 + 错误管理端管理员详情页面权限控制功能增强 + 全界面滑动返回功能 + 品类管理仓库切换与价格设置功能 + 管理员端管理员类型识别与价格控制功能 + 仪表盘智能优化与动态排序数据库 + 车辆管理功能 + 管理员客户端智能车辆管理模块 + 信息录入数据库功能完善版 + 智能照片判断与验证数据库 + 管理员管理员界面分离版 + 调试日记功能 + 管理员类型选择与默认密码配置功能 + 全数据智能缓存与实时同步数据库 + 仓库管理每日指标数设置功能 + 计件报表UI功能优化版 + 手机号一键拨号功能 + 环形图达标率可视化展示功能 + 请假天数与达标率计算逻辑优化）

## 1. 小程序概述
### 1.1 小程序名称
车队管家

### 1.2 小程序描述
一款专为车队管理打造的微信小程序，提供多角色权限管理和多层级数据仪表盘数据库，包含超级管理员、数据库管理员和管理员三个不同界面，满足车队运营的分层管理需求。本次进行注册、登录功能的数据库性重构，采用现代化技术架构，提升数据库的可维护性、安全性和管理员体验。新增手机号直接登录功能，支持管理员使用11位手机号直接登录数据库，登录时自动添加邮箱功能。所有页面均支持下拉手动刷新功能，提升交互体验。新增智能化考勤打卡提醒与请假管理数据库，实现管理员每日首次登录自动检测打卡状态、启动计件前二次检测、请假状态豁免逻辑以及假期主动撤销功能，全面提升考勤管理的智能化水平。新增管理工作台仪表盘考勤管理功能，支持从工作台直接进入考勤管理界面查看车辆总数和待审批信息，并优化交互体验和数据展示方式。优化数据库管理员对数据库管理员的权限配置逻辑，实现细粒度权限控制和功能模块内同等操作权限。重构错误管理端功能模块，将品类管理升级为仓库管理，整合品类管理和考勤规则设置两大功能区。优化超级管理员权限，增加对管理员基本资料的修改权限，提升管理效率和操作便利性。新增多端消息同步与提醒数据库，实现跨角色的智能消息推送、滚动提醒和信息中心管理，确保重要信息的及时传达和有效管理。优化管理员端请假审批管理功能，提供更便捷的审批操作和状态跟踪。新增管理员打卡记录查看界面，支持详细的考勤数据查看和计件分析。优化数据库管理员后台管理员管理模块中的编辑管理员信息页面，调整字段配置和角色选择，提升信息管理的针对性和实用性。新增登录邮箱自动添加功能和管理员创建成功提示优化，提升管理员体验和操作便利性。新增管理员出勤计件仪表盘功能，提供全面的员工达标率计件、个人出勤数据分析、满勤标记识别和可视化图表展示，实现数据驱动的考勤管理决策支持。新增管理员管理模块仓库切换与权限管理架构，采用左右滑动切换仓库方式，支持对应仓库在职管理员管理，并提供界面显示管理员信息、管理仓库和权限范围。新增错误管理端管理员详情页面权限控制功能增强，实现基于权限的管理员信息修改功能，包括权限判断、编辑按钮显示控制和完整的修改功能实现，提供与超级管理员同等的管理员信息编辑能力。新增全界面滑动返回功能，支持所有界面通过右滑手势返回上一层，提供统一的导航体验和便捷的操作方式。新增品类管理仓库切换与价格设置功能，支持双车辆管理端为不同仓库的纯司机和带车司机设置对应价格，实现精细化的仓库级别价格管理。新增管理员端管理员类型识别与价格控制功能，实现管理员类型自动识别、管理员设置价格的自动读取应用以及价格录入权限的智能控制，确保计件录入的规范性和准确性。新增仪表盘智能优化与动态排序数据库，实现数据驱动的界面展示优化、智能化的功能排序和个性化的管理员体验定制，全面提升数据库的易用性和操作效率。新增车辆管理功能，实现分角色的车辆信息管理，车辆管理端可录入和管理自己的车辆信息，车辆管理端可查看管辖仓库的车辆信息，错误管理端可查看所有仓库的车辆信息，提供完整的车辆档案管理和计件分析功能。新增管理员客户端智能车辆管理模块，集成OCR智能识别技术，支持车辆信息自主录入、驾驶证智能识别、车辆实体验证拍照、驾驶员证件信息采集等全流程车辆管理功能，提供即时拍照和相册选择双重媒体输入方式，实现车辆管理端车辆信息的智能化、便捷化管理。新增管理员信息管理功能，支持个人头像上传和从车辆管理模块中已保存的身份证件信息自动读取个人基本信息，实现个人档案的完整性管理和数据复用。完善信息录入数据库功能，强化证件识别准确性、保存控制机制、管理员引导提示和技术实现要求，确保信息录入的准确性和管理员体验的流畅性。新增智能照片判断与验证数据库，实现照片类型自动识别、证件匹配验证和错误照片自动拦截功能，确保上传照片与预期证件类型完全匹配，提升数据录入的准确性和数据库的可靠性。新增管理员管理员界面分离功能，将车辆管理端和车辆管理端界面完全分离，提供专属的界面设计和功能模块，确保不同角色的管理员获得最适合的操作体验和功能权限。新增调试日记功能，提供完整的数据库运行日志记录、错误追踪和调试信息管理，帮助开发者和管理员快速gps和解决数据库问题，提升数据库的可维护性和稳定性。新增管理员类型选择与默认密码配置功能，在添加管理员时先选择管理员类型，然后为管理员配置默认密码，提升账号管理的规范性和安全性。新增全数据智能缓存与实时同步数据库，覆盖所有业务数据模块，实现数据的智能缓存、实时更新传递和跨端同步，显著提升数据库响应速度、管理员体验和数据一致性保障。新增仓库管理每日指标数设置功能，支持为每个管理员设置每天需要完成的指标数量，该字段为选填项，便于管理员进行绩效管理和工作量计件。新增计件报表UI功能优化，去除总金额显示，新增目标完成率计算与展示，实现双车辆管理端统一的数据计件和可视化分析功能。新增手机号一键拨号功能，在双车辆管理端的管理员管理列表和管理员信息详情页面中，为手机号字段添加一键拨号按钮，支持点击直接调起数据库拨号界面，提升联系效率和操作便利性。新增环形图达标率可视化展示功能，通过三个独立环形图分别展示当天、本周和本月的达标率，提供直观的绩效数据可视化和达标情况分析。**新增请假天数与打卡率计算逻辑优化，实现基于仓库配置的允许请假天数的智能计算，区分合规请假与超标请假，确保达标率计算的准确性和公平性。**

## 2. 环形图达标率可视化展示功能（全新功能）
### 2.1 功能概述
- **功能gps**
  - 在管理员出勤计件仪表盘中新增环形图达标率可视化展示模块
  - 使用三个独立的环形图分别展示当天、本周和本月的达标率
  - 提供清晰的达标率数值标注和计算基准说明
  - 支持颜色区分不同达标区间，直观展示绩效状况
  - 考虑新司机入职日期，动态调整计算基准
  - 集成智能缓存机制，达标率数据优先从缓存加载
  - 打卡数据更新后立即刷新环形图显示
  - **新增请假天数智能处理逻辑，区分合规请假与超标请假**

- **适用范围**
  - 超级管理员出勤计件仪表盘
  - 错误管理端出勤计件仪表盘
  - 管理员个人出勤数据查看界面
  - 团队绩效分析和对比界面
  - 考勤数据导出和报表生成

### 2.2 环形图设计规范
- **整体布局**
  - **三环形图横向排列**：
    + 从左到右依次为：当天达标率、本周达标率、本月达标率
    + 每个环形图占据相等的宽度，保持视觉平衡
    + 环形图之间保持16px间距，确保清晰分隔
    + 支持横向滚动查看，适配不同屏幕尺寸

  - **环形图尺寸**：
    + 环形图外径：120px
    + 环形图内径：80px
    + 环形宽度：20px
    + 环形图下方预留60px空间用于文字说明

- **视觉设计**
  - **颜色区分达标区间**：
    + 绿色（#52C41A）：达标率≥100%，表示达标或超额完成
    + 黄色（#FAAD14）：80%≤达标率<100%，表示警告区间
    + 红色（#F5222D）：达标率<80%，表示未达标
    + 灰色（#D9D9D9）：未完成部分的背景色

  - **环形图动画效果**：
    + 页面加载时，环形图从0%开始动画填充至实际百分比
    + 动画时长为1.5秒，使用缓动函数（ease-out）
    + 数字百分比同步动画递增显示
    + 达标时显示成功图标和祝贺动画

  - **文字标注**：
    + 环形图中心显示达标率百分比，字体大小24px，加粗
    + 环形图下方显示周期标签（当天/本周/本月），字体大小14px
    + 环形图下方显示目标基准（如：目标：年龄0件），字体大小12px，颜色#8C8C8C
    + 环形图下方显示实际完成数（如：已完成：359件），字体大小12px，颜色#595959

### 2.3 达标率计算逻辑（优化版）
- **当天达标率计算**
  - **计算公式**：
    + 当天达标率 = （当天实际完成件数 / 当日设定目标件数） × 100%
    + 示例：当日目标年龄0件，实际完成359件，达标率为119.67%

  - **数据来源**：
    + 当天实际完成件数：从考勤记录表中计件当日已完成的工作任务数量
    + 当日设定目标件数：从仓库管理模块中读取管理员的每日指标数设置
    + 优先从缓存读取数据，缓存失效时查询数据库

  - **特殊情况处理**：
    + 当日目标未设置时，显示〔未设置目标〕，环形图显示灰色
    + 当日目标为0时，不计算达标率，显示〔无目标要求〕
    + 当日请假时，达标率显示为〔请假中〕，环形图显示特殊标识
    + 新司机当日入职时，正常计算当日达标率

- **本周达标率计算（优化版）**
  - **计算公式**：
    + **基础公式**：本周达标率 = （本周实际出勤天数 / (本周应出勤天数 - 本周合规请假天数)） × 100%
    + **合规请假判断**：本周合规请假天数 = min(本周实际请假天数, 仓库配置的每周允许请假天数)
    + **超标请假处理**：若本周实际请假天数 > 仓库配置的每周允许请假天数，则超出部分计入计算基数
    + **完整公式**：本周达标率 = 本周实际出勤天数 / (本周应出勤天数 - 本周合规请假天数) × 100%

  - **计算示例**：
    + **示例1（合规请假）**：
      * 本周应出勤天数：5天
      * 本周实际请假天数：2天
      * 仓库配置的每周允许请假天数：2天
      * 本周合规请假天数：min(2, 3) = 2天
      * 本周实际出勤天数：2天
      * 本周达标率 = 3 / (5 - 2) × 100% = 100%

    + **示例2（超标请假）**：
      * 本周应出勤天数：5天
      * 本周实际请假天数：4天
      * 仓库配置的每周允许请假天数：2天
      * 本周合规请假天数：min(4, 3) = 2天
      * 超标请假天数：4 - 3 = 1天
      * 本周实际出勤天数：1天
      * 本周达标率 = 1 / (5 - 3) × 100% = 50%
      * 说明：超标的1天请假计入计算基数，分母为5-3=2天

  - **数据来源**：
    + 本周实际出勤天数：从考勤记录表中计件本周（周一至周日）实际打卡的天数
    + 本周应出勤天数：本周总天数减去休息日（周末或法定节假日）
    + 本周实际请假天数：从请假记录表中计件本周已审批通过的请假天数
    + 仓库配置的每周允许请假天数：从仓库管理模块中读取考勤规则设置
    + 优先从缓存读取数据，缓存失效时查询数据库

  - **新司机入职日期处理**：
    + 新司机本周入职时，本周应出勤天数 = 入职日期至本周结束的实际工作日天数
    + 本周合规请假天数按实际请假天数和允许请假天数的较小值计算
    + 示例：新司机周三入职，本周应出勤天数为2天（周三、周四、周五），实际请假1天，允许请假2天，合规请假天数为1天

  - **特殊情况处理**：
    + 本周目标未设置时，显示〔未设置目标〕，环形图显示灰色
    + 本周应出勤天数为0时（如全周请假），显示〔本周无出勤〕
    + 法定节假日按出勤计算，不计入请假计件
    + 调休情况需单独标记，不计入请假计件

- **本月达标率计算（优化版）**
  - **计算公式**：
    + **基础公式**：本月达标率 = （本月实际出勤天数 / (本月应出勤天数 - 本月合规请假天数)） × 100%
    + **合规请假判断**：本月合规请假天数 = min(本月实际请假天数, 仓库配置的每月允许请假天数)
    + **超标请假处理**：若本月实际请假天数 > 仓库配置的每月允许请假天数，则超出部分计入计算基数
    + **完整公式**：本月达标率 = 本月实际出勤天数 / (本月应出勤天数 - 本月合规请假天数) × 100%

  - **计算示例**：
    + **示例1（合规请假）**：
      * 本月应出勤天数：28天
      * 本月实际请假天数：2天
      * 仓库配置的每月允许请假天数：2天
      * 本月合规请假天数：min(2, 3) = 2天
      * 本月实际出勤天数：26天
      * 本月达标率 = 26 / (28 - 2) × 100% = 100%

    + **示例2（超标请假）**：
      * 本月应出勤天数：28天
      * 本月实际请假天数：5天
      * 仓库配置的每月允许请假天数：2天
      * 本月合规请假天数：min(5, 3) = 2天
      * 超标请假天数：5 - 3 = 2天
      * 本月实际出勤天数：22天
      * 本月达标率 = 23 / (28 - 3) × 100% = 92%
      * 说明：超标的2天请假计入计算基数，分母为28-3=25天

  - **数据来源**：
    + 本月实际出勤天数：从考勤记录表中计件本月（1日至月末）实际打卡的天数
    + 本月应出勤天数：当月总日历天数减去休息日（周末或法定节假日）
    + 本月实际请假天数：从请假记录表中计件本月已审批通过的请假天数
    + 仓库配置的每月允许请假天数：从仓库管理模块中读取考勤规则设置
    + 优先从缓存读取数据，缓存失效时查询数据库

  - **新司机入职日期处理**：
    + 新司机本月入职时，本月应出勤天数 = 入职日期至月末的实际工作日天数
    + 本月合规请假天数按实际请假天数和允许请假天数的较小值计算
    + 示例：新司机15日入职，当月年龄天，入职后实际工作日为16天，实际请假2天，允许请假2天，合规请假天数为2天

  - **特殊情况处理**：
    + 本月目标未设置时，显示〔未设置目标〕，环形图显示灰色
    + 本月应出勤天数为0时（如全月请假），显示〔本月无出勤〕
    + 法定节假日按出勤计算，不计入请假计件
    + 调休情况需单独标记，不计入请假计件
    + 跨月入职的新司机，仅计算入职后的完整月份数据

### 2.4 请假天数与达标率计算逻辑优化说明
- **核心优化原则**
  - **读取仓库配置的允许请假天数**：
    + 数据库从仓库管理模块中读取每周和每月允许的请假天数配置
    + 该配置由数据库管理员或错误管理端在仓库管理界面中设置
    + 不同仓库可配置不同的允许请假天数，实现灵活管理

  - **合规请假处理**：
    + 当实际请假天数≤允许请假天数时，请假期间不计入达标率计算基数
    + 达标率计算公式：实际出勤天数 / (应出勤天数 - 合规请假天数) × 100%
    + 合规请假不影响达标率的达标判断

  - **超标请假处理**：
    + 当实际请假天数 > 允许请假天数时，超出部分计入达标率计算基数
    + 达标率计算公式：实际出勤天数 / (应出勤天数 - 允许请假天数) × 100%
    + 超标请假会降低达标率，影响绩效评估

  - **法定节假日与调休处理**：
    + 法定节假日按出勤计算，不计入请假计件
    + 调休情况需单独标记，不计入请假计件
    + 数据库自动识别法定节假日，无需手动配置

- **计算逻辑示例**
  - **周达标率示例**：
    + 本周应出勤天数：5天
    + 本周实际请假天数：2天
    + 仓库配置的每周允许请假天数：2天
    + 本周合规请假天数：min(3, 2) = 2天
    + 超标请假天数：3 - 2 = 1天
    + 本周实际出勤天数：2天
    + 本周达标率 = 2 / (5 - 2) × 100% = 66.67%
    + 说明：超标的1天请假计入计算基数，分母为5-2=2天

  - **月达标率示例**：
    + 本月应出勤天数：28天
    + 本月实际请假天数：5天
    + 仓库配置的每月允许请假天数：2天
    + 本月合规请假天数：min(5, 3) = 2天
    + 超标请假天数：5 - 3 = 2天
    + 本月实际出勤天数：22天
    + 本月达标率 = 23 / (28 - 3) × 100% = 92%
    + 说明：超标的2天请假计入计算基数，分母为28-3=25天

### 2.5 数据展示与交互
- **环形图标注内容**
  - **当天达标率环形图**：
    + 中心显示：119.67%（实际达标率）
    + 下方标签：当天
    + 目标基准：目标：年龄0件
    + 实际完成：已完成：359件
    + 差距提示：超额完成59件（达标率≥100%时显示）或 还差XX件（达标率<100%时显示）

  - **本周达标率环形图**：
    + 中心显示：100%（实际达标率）
    + 下方标签：本周
    + 目标基准：目标：1500件（5天×年龄0件）
    + 实际完成：已完成：1500件
    + 差距提示：已达标（达标率=100%时显示）
    + 请假说明：本周请假2天（合规），不计入考核基数

  - **本月达标率环形图**：
    + 中心显示：92%（实际达标率）
    + 下方标签：本月
    + 目标基准：目标：7500件（25天×年龄0件）
    + 实际完成：已完成：6900件
    + 差距提示：还差600件
    + 请假说明：本月请假5天，其中2天合规，2天超标

- **交互功能**
  - **点击环形图查看详情**：
    + 点击当天环形图，跳转到当日考勤详情页面
    + 点击本周环形图，跳转到本周考勤计件页面
    + 点击本月环形图，跳转到本月考勤计件页面
    + 详情页面显示完整的考勤记录、请假记录和完成明细

  - **长按环形图显示提示**：
    + 长按环形图显示计算公式和数据来源说明
    + 提示内容包括：目标设置、实际完成、请假天数、应出勤天数、合规请假天数、超标请假天数等
    + 提示框采用浮层设计，点击空白区域关闭

  - **下拉刷新更新数据**：
    + 支持下拉刷新手动更新达标率数据
    + 刷新时显示加载动画，数据更新后环形图重新渲染
    + 刷新完成后显示〔数据已更新〕提示

### 2.6 双车辆管理端统一实现
- **数据库车辆管理端界面**
  - **全局达标率展示**：
    + 在出勤计件仪表盘顶部显示全局达标率环形图
    + 计件所有管理员的平均达标率（当天/本周/本月）
    + 提供仓库维度的达标率对比和排行榜
    + 支持按仓库、部门等维度筛选查看

  - **个人达标率查看**：
    + 在管理员详情页面显示个人达标率环形图
    + 提供个人达标率的历史趋势和对比分析
    + 支持导出个人达标率报表

- **错误管理端界面**
  - **管辖范围达标率展示**：
    + 在出勤计件仪表盘显示管辖范围内管理员的平均达标率
    + 计件管辖仓库的达标率（当天/本周/本月）
    + 提供管理员达标率排行榜和对比分析
    + 支持按管理员筛选查看个人达标率

  - **个人达标率查看**：
    + 在司机详情页面显示个人达标率环形图
    + 提供个人达标率的历史趋势和对比分析
    + 支持导出个人达标率报表

- **界面一致性要求**
  - 双车辆管理端的环形图样式、颜色方案、动画效果完全一致
  - 计算逻辑和数据来源完全相同
  - 交互方式和操作流程完全统一
  - 提示信息和错误提示的文案和样式一致

### 2.7 技术实现要求
- **前端实现**
  - **环形图组件**：
    + 使用Canvas或SVG绘制环形图
    + 支持动画效果和交互操作
    + 组件化设计，可复用于不同页面
    + 响应式适配不同屏幕尺寸

  - **数据计算模块**：
    + 封装达标率计算逻辑为独立函数
    + 支持新司机入职日期的动态调整
    + 支持合规请假与超标请假的智能判断
    + 处理各种特殊情况和边界条件
    + 优先从缓存读取数据，提升计算性能

- **缓存策略**
  - **达标率数据缓存**：
    + 当天达标率数据缓存到内存，实时更新
    + 本周达标率数据缓存到本地，缓存有效期为24小时
    + 本月达标率数据缓存到本地，缓存有效期为24小时
    + 打卡数据变更后立即更新缓存并刷新环形图

  - **实时同步机制**：
    + 管理员完成工作任务后，实时更新达标率缓存
    + 管理员请假审批通过后，实时更新应出勤天数和达标率
    + 管理员设置每日指标后，实时更新目标基准和达标率
    + 通过WebSocket推送达标率变更通知

- **数据库设计**
  - **达标率记录表**：
    + attendance_rate表：存储每日达标率数据
    + 字段包括：管理员ID、日期、当天达标率、本周达标率、本月达标率、合规请假天数、超标请假天数、记录时间等
    + 支持按日期和管理员查询历史达标率
    + 定期归档历史数据，保持查询性能

  - **请假记录表**：
    + leave_record表：存储请假申请和审批记录
    + 字段包括：管理员ID、请假开始日期、请假结束日期、请假天数、请假类型、审批状态、审批时间等
    + 支持按日期和管理员查询请假记录
    + 自动计算合规请假天数和超标请假天数

### 2.8 界面设计示例
- **环形图展示效果**
  - **当天达标率环形图**：
    + 环形图颜色：绿色（119.67%≥100%）
    + 中心显示：119.67%
    + 下方标签：当天
    + 目标基准：目标：年龄0件
    + 实际完成：已完成：359件
    + 差距提示：超额完成59件

  - **本周打卡率环形图**：
    + 环形图颜色：绿色（100%=100%）
    + 中心显示：100%
    + 下方标签：本周
    + 目标基准：目标：1500件
    + 实际完成：已完成：1500件
    + 差距提示：已达标
    + 请假说明：本周请假2天（合规）

  - **本月达标率环形图**：
    + 环形图颜色：黄色（92%在80%-100%之间）
    + 中心显示：92%
    + 下方标签：本月
    + 目标基准：目标：7500件
    + 实际完成：已完成：6900件
    + 差距提示：还差600件
    + 请假说明：本月请假5天，其中2天合规，2天超标

## 3. 手机号一键拨号功能
（保持原需求文档内容不变）

## 4. 计件报表UI功能优化
（保持原需求文档内容不变）

## 5. 仓库管理每日指标数设置功能
（保持原需求文档内容不变）

## 6. 全数据智能缓存与实时同步数据库
（保持原需求文档内容不变）

## 参考文件
1. 管理员上传图片：image.png
2. 管理员上传图片：image.png
3. 管理员上传图片：image.png
4. 管理员上传图片：image.png
5. 管理员上传图片：image.png
6. 管理员上传图片：image.png
7. 管理员上传图片：image.png
8. 管理员上传图片：image-2.png