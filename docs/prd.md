# 车队管家小程序管理系统需求文档

## 1. 系统概述

### 1.1 系统名称\n车队管家小程序管理系统

### 1.2 系统描述
专为车队管理打造的微信小程序管理系统，采用单数据库架构，支持车辆、司机管理和数据统计功能。系统简化为单用户模式，取消多租户隔离和中央管理系统。

### 1.3 项目目标
快速开发一个可登录的车队管理小程序，实现基础的车辆、司机管理和数据统计功能，基于单数据库简化系统架构，优化查询逻辑，完善账号权限管理，并重构权限系统为策略模板驱动的动态权限引擎。

## 2. 核心功能模块

### 2.1 用户管理功能
- **用户登录**：账号密码登录验证
- **用户注册**：基础用户信息注册
- **用户信息管理**：个人信息编辑和更新
- **角色管理**：老板、平级账号、车队长、司机等角色分配

#### 2.1.1 账号角色定义
- **老板账号**：系统的最高权限所有者，可访问所有数据
- **平级账号（PEER_ADMIN）**：由老板创建的同级管理员
  - **完整权限**：与老板权限相同，可增改停删
  - **查看权限**：仅能查看，无权修改
- **车队长账号**：管理权限受限于管辖范围
  - **完整权限**：在管辖范围内拥有最高操作权限，可增改停删
  - **查看权限**：仅能查看管辖范围内数据
- **司机账号**：基础操作权限，只能查看个人相关信息
- **调度账号**：负责任务调度和运输管理
  - **完整权限**：可调度任务、分配车辆司机
  - **查看权限**：仅能查看任务状态和进度

#### 2.1.2 老板账号管理
- **平级账号管理**：老板账号可创建和平级账号共享相同权限
- **平级账号限制**：每个老板最多可创建3个平级账号
- **管理权限**：老板可查看、修改、停用、删除平级账号
- **数据共享**：平级账号使用老板账号的同一数据库环境
- **权限分配**：老板可为平级账号分配完整控制权或仅查看权

#### 2.1.3 车队长账号权限管理
- **管理范围限制**：车队长只能管理其管辖范围内的『司机』账号
- **权限开关**：用户信息修改权限开关
  - **开启时**：车队长可以对其管辖的司机账号执行查看、增加、修改、停用操作
  - **关闭时**：车队长仅能查看司机信息，无权进行任何修改
- **操作记录**：系统记录车队长的所有操作日志

#### 2.1.4 新用户创建与仓库分配规则
-**仓库分配必填**：在创建司机或管理员账户时，「仓库分配」为必填步骤
-**强制仓库选择**：系统强制要求为新账户选择至少一个可访问的仓库
-**验证机制**：未分配仓库时阻止账户创建并给出明确提示
- **分配记录**：记录用户与仓库的关联关系

#### 2.1.5 调度账号管理
- **调度范围设定**：为调度账号分配负责的仓库或运输线路
- **权限级别**：可设置为完整调度权或仅查看权
- **任务管理**：在授权范围内进行任务调度和状态跟踪

### 2.2 车辆管理功能
- **车辆信息管理**：车辆基本信息录入和查询
- **车辆状态监控**：车辆使用状态跟踪
- **车辆分配管理**：司机与车辆匹配管理

### 2.3 司机管理功能
- **司机档案管理**：司机个人信息录入和管理
- **司机状态管理**：出勤状态和工作排班
- **绩效查看**：司机工作效率统计

### 2.4 数据统计功能
- **关键数据统计**：出勤人数、总件数、完成件数等统计
- **车辆使用率统计**：车辆使用情况分析
- **司机工作效率统计**：司机绩效数据展示

### 2.5 通知管理功能
- **通知发送机制**：基于业务操作自动触发通知
- **接收对象管理**：根据不同角色和业务场景确定通知接收人
- **通知内容模板**：包含操作类型、操作对象、执行者和时间戳等上下文信息
- **通知记录管理**：记录所有已发送的通知日志

### 2.6 仓库管理功能
- **仓库信息管理**：仓库基本信息录入和查询
- **仓库状态管理**：仓库使用状态跟踪\n- **仓库分配管理**：司机与仓库匹配管理
- **仓库统计分析**：仓库相关数据统计

#### 2.6.1 仓库自动创建规则
-**默认仓库创建**：系统自动创建一个预设的「默认仓库」
-**初始仓库状态**：默认仓库包含必要初始信息，处于可用状态且可修改

#### 2.6.2 仓库删除限制规则
-**操作限制**：禁止删除操作导致系统下剩余可用仓库数量少于1个

### 2.7 测试账号数据
- **老板账号**：admin1，密码123456
- **平级账号**：admin11，密码123456
- **车队长账号**：admin111，密码123456
- **司机账号**：admin1111，密码123456
- **调度账号**：admin1112，密码123456

#### 2.7.1 测试账号快捷登录功能
- **登录页面集成**：在小程序登录页面添加测试账号快捷登录入口
- **账号列表**：
  - admin1（老板账号）
  - admin11（平级账号）
  - admin111（车队长账号）
  - admin1111（司机账号）
  - admin1112（调度账号）
- **统一密码**：所有测试账号密码均为123456
- **快速登录**：点击对应账号直接登录系统，无需输入密码，便于测试人员快速切换不同角色进行功能验证

## 3. 系统逻辑流程

### 3.1 小程序登录流程
1. 用户打开小程序
2. 进入登录页面
3. 输入账号和密码
4. 系统验证账号有效性
5. 验证密码正确性
6. 系统根据用户角色完成权限上下文初始化
7. 跳转到对应管理首页

### 3.2 仪表盘访问流程
1. 用户登录成功后自动跳转到仪表盘
2. 系统显示当前用户对应的角色数据概览
3. 支持数据详情查看

### 3.3 车队长权限管理流程
1. 车队长登录系统后自动进入管理界面
2. 系统识别车队长的管理范围和权限级别
3. 根据权限开关状态决定车队长的操作权限
4. 所有操作均记录详细日志

### 3.4 平级账号管理流程
1. 老板登录系统后可进入账号管理界面
2. 老板可创建新的平级账号（最多3个）
3. 平级账号与老板账号共享同一数据库实例
4. 老板可管理所有平级账号的状态和权限
5. 老板为平级账号分配完整控制权或仅查看权

### 3.5 数据查询权限流程
1. 系统识别当前登录用户的角色
2. 根据角色确定可访问的数据范围
3. 司机账号仅能查询个人相关信息，不能查看其他司机信息
4. 车队长账号可查询管辖范围内的司机数据
5. 老板和平级账号可查询所有数据

### 3.6 通知触发流程

#### 3.6.1 司机操作通知
- **触发场景**：司机提交请假申请、离职申请、车辆信息审核申请、实名认证审核申请
- **通知接收对象**：
  - 老板
  - 所有平级账号
  - 该司机所属管辖权区域的车队长（若存在）
  - 相关调度账号
- **通知内容**：申请类型、申请人信息、申请详情、申请时间

#### 3.6.2 车队长操作通知
- **触发场景**：
  - 增加司机账号
  - 修改司机信息（分配仓库、修改类型）
  - 停用司机账号
  - 删除司机账号（如果被授权）
  - 任何审核操作（通过/驳回）
- **通知接收对象**：
  - 老板\n  - 所有平级账号
  - 被操作的司机本人
  - 相关调度账号
- **通知内容**：操作类型、操作对象、操作详情、操作时间

#### 3.6.3 老板操作通知
- **触发场景**：
  - 调整车队长的管辖仓库范围
  - 调整司机分配
  - 调整司机类型
  - 审批请假、离职或车辆申请
  - 任何审核操作（通过/驳回）
- **通知接收对象**：
  - 相关操作所涉及管辖权区域内的所有车队长
  - 被操作的司机本人（如操作涉及具体司机）
  - 相关调度账号
- **通知内容**：操作类型、操作对象、操作详情、操作时间

#### 3.6.4 平级账号操作通知
- **触发场景**：与老板相同的操作范围
- **通知接收对象**：
  - 相关操作所涉及管辖权区域内的所有车队长
  - 被操作的司机本人（如操作涉及具体司机）
  - 老板
  - 相关调度账号
- **通知内容**：操作类型、操作对象、操作详情、操作时间

### 3.7 调度管理流程

#### 3.7.1 任务调度通知
- **触发场景**：创建运输任务、分配车辆司机、变更任务状态
- **通知接收对象**：
  - 相关司机
  - 车队长
  - 老板和平级账号
- **通知内容**：任务详情、车辆信息、司机信息、预计时间

#### 3.7.2 异常情况通知
- **触发场景**：任务延误、车辆故障、司机反馈问题
- **通知接收对象**：
  - 调度员本人
  - 上级车队长
  - 老板和平级账号
- **通知内容**：异常描述、发生时间、涉及资源

### 3.8 仓库管理流程

#### 3.8.1 仓库自动创建流程
- **系统初始化**：系统自动创建预设的「默认仓库」
- **仓库初始化**：包含必要初始信息，设置为可用状态，支持修改

#### 3.8.2 仓库删除校验流程
- **数量检查**：系统自动检查剩余可用仓库数量
- **删除限制**：确保删除后至少保留1个可用仓库
-**异常处理**：如果删除会导致仓库数量不足，系统阻止操作并给出提示

#### 3.8.3 用户创建仓库分配流程
- **创建新用户**：在创建司机或管理员账户时
- **仓库选择**：系统强制要求选择至少一个可访问的仓库
-**验证机制**：未分配仓库时阻止账户创建并显示明确提示
- **分配记录**：记录用户与仓库的关联关系

### 3.9 权限上下文初始化流程

#### 3.9.1 司机登录权限初始化
- **权限模式**：own_data_only
- **自动注入数据**：
  - 直属车队长：获取该司机所属的车队长用户ID及基本信息
  - 调度账号列表：获取该司机所在仓库/线路对应的调度账号列表
  - 老板账号：获取系统中的老板账号（BOSS）用户ID

#### 3.9.2 车队长登录权限初始化
- **权限级别判断**：
  - 完整权：可进行增删改操作
  - 仅查看权：仅可查询数据
- **自动注入数据**：
  - 管辖仓库列表：获取该车队长所管理的仓库ID及基本信息
  - 下属司机列表：获取该车队长管辖下的所有司机用户ID
  - 调度账号列表：获取与管辖仓库关联的调度账号
  - 老板账号：获取BOSS角色用户ID
- **权限模式**：managed_resources，并绑定其管辖范围（仓库、司机）

#### 3.9.3 调度登录权限初始化
- **权限级别判断**：
  - 完整权：可调度、修改任务
  - 仅查看权：仅可查看任务状态
- **自动注入数据**：
  - 管辖仓库/线路：获取该调度员负责的仓库或运输线路
  - 关联司机与车辆：获取其调度范围内的司机与车辆列表
  - 老板账号：获取BOSS用户ID
- **权限模式**：scheduled_resources，并绑定调度范围

#### 3.9.4 老板与平级管理员登录
- **权限模式**：all_access
- **无需注入具体管辖数据**，但可缓存全系统资源索引以提升访问效率

**所有权限上下文应在登录后一次性加载并存入用户会话（Session）或令牌（Token）中，后续接口通过上下文直接获取数据边界，实现「权限即数据」的一体化模型。**

## 4. 权限重构设计方案

### 4.1 权限映射表重构
在原有用户角色关联表基础上新增关键字段，用于关联策略模板：

#### 4.1.1 角色策略映射表（role_strategy_mapping）
字段：
- **角色ID**（外键）：关联角色表
- **策略模板**：对应的具体策略类型（all_access/managed_resources/own_data_only/scheduled_resources）
- **资源归属字段**：关联数据表中的归属字段名称（如manager_id/driver_id/warehouse_id）
- **适用场景说明**：策略应用场景描述

**角色策略配置示例**：

| 角色     | 策略模板      | 资源归属字段 | 适用场景说明                          |
|----------|---------------|-------------|---------------------------------------|
| BOSS     | all_access    | -           | 所有数据表的完全控制权               |
| PEER_ADMIN | all_access    | -           | 同BOSS权限                           |
| MANAGER  | managed_resources | manager_id | 仅能管理自己管辖的司机/车辆         |
| DRIVER   | own_data_only  | driver_id   | 仅能操作自己相关的数据               |
| SCHEDULER | scheduled_resources | warehouse_id | 负责指定仓库/线路的任务调度         |

### 4.2 策略模板定义
将权限逻辑抽象为可复用的策略模板，避免重复配置：

#### 4.2.1 all_access策略
- **规则**：允许所有操作（增删改查）
- **适用角色**：BOSS、PEER_ADMIN
- **校验逻辑**：直接放行所有操作请求

#### 4.2.2 managed_resources策略（车队长专用）
- **规则**：
  - **查看**：管辖范围内的司机/车辆数据（通过manager_id匹配）
  - **修改**：仅限自己管理的仓库、车辆
- **校验逻辑**：操作资源时自动校验manager_id是否等于当前用户ID

#### 4.2.3 own_data_only策略（司机专用）
- **规则**：
  - **查看**：自己的通知、考勤记录等
  - **修改**：仅限驾驶证、车辆信息等个人数据
- **校验逻辑**：强制校验driver_id是否等于当前用户ID

#### 4.2.4 scheduled_resources策略（调度专用）
- **规则**：
  - **查看**：管辖仓库/线路内的所有任务和资源
  - **调度操作**：在授权范围内分配车辆司机、修改任务状态
  - **受限修改**：根据权限级别决定可修改的内容
- **校验逻辑**：校验warehouse_id或line_id是否在授权范围内

### 4.3 权限验证流程

#### 4.3.1 登录时策略加载
用户登录后，根据角色从权限映射表中查询对应策略模板：
1. 获取用户角色ID
2. 查询role_strategy_mapping表获取对应的策略模板和资源归属字段
3. 将策略模板及资源归属字段缓存到内存中
4. 初始化权限上下文数据并注入会话

#### 4.3.2 操作时动态校验
当用户请求操作某资源时：
1. 提取资源中的归属字段值（如车辆表的driver_id）
2. 调用对应策略模板校验函数
3. 根据策略规则验证操作合法性
4. 记