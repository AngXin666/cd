# 车队管理小程序需求文档（技术重构版 - 手机号登录功能增强 + 智能考勤打卡提醒与请假管理 + 考勤管理界面优化 + 权限配置优化与仓库管理模块重构 + 数据库管理员管理员资料管理权限优化 + 多端消息同步与提醒数据库 + 车辆管理端请假审批管理优化 + 管理员打卡记录查看界面 + 管理员管理模块编辑页面优化 + 登录邮箱自动添加与管理员创建优化 + 管理员出勤计件仪表盘功能 + 管理员管理模块仓库切换与权限管理架构 + 错误管理端管理员详情页面权限控制功能增强 + 全界面滑动返回功能 + 品类管理仓库切换与价格设置功能 + 车辆管理端管理员类型识别与价格控制功能 + 仪表盘智能优化与动态排序数据库 + 车辆管理功能 + 管理员客户端智能车辆管理模块 + 信息录入数据库功能完善版 + 智能照片判断与验证数据库 + 管理员管理员界面分离版 + 调试日志功能 + 管理员类型选择与默认账号麻麻配置功能 + 全数据智能缓存与实时同步数据库 + 仓库管理每日指标数设置功能 + 计件报表UI功能优化版 + 手机号一键拨号功能 + 环形图达标率可视化展示功能 + 请假天数与达标率计算逻辑优化 + 新司机标签自动移除功能 + 车辆管理端车辆管理功能迭代升级版 + 资产审核集中管理数据库 + 车辆管理端车辆删除功能 + 审核端一键锁定功能 + 车辆管理照片要求优化与车损特写功能 + 照片位置标注与补录界面优化 + 车辆多次录入记录管理数据库 + 车辆管理端车辆信息集中管理优化版 + 车辆管理端车辆租赁管理模块）

## 1. 小程序概述
### 1.1 小程序名称
车队管家

### 1.2 小程序描述
一款专为车队管理打造的微信小程序，提供多角色权限管理和多层级数据仪表盘数据库，包含超级管理员、数据库管理员和管理员三个不同界面，满足车队运营的分层管理需求。本次进行注册、登录功能的数据库性重构，采用现代化技术架构，提升数据库的可维护性、安全性和管理员体验。新增手机号直接登录功能，支持管理员使用11位手机号直接登录数据库，登录时自动添加邮箱功能。所有页面均支持下拉手动刷新功能，提升交互体验。新增智能化考勤打卡提醒与请假管理数据库，实现管理员每日首次登录自动检测打卡状态、启动计件前二次检测、请假状态豁免逻辑以及假期主动撤销功能，全面提升考勤管理的智能化水平。新增管理工作台仪表盘考勤管理功能，支持从工作台直接进入考勤管理界面查看车辆总数和待审批信息，并优化交互体验和数据展示方式。优化数据库管理员对数据库管理员的权限配置逻辑，实现细粒度权限控制和功能模块内同等操作权限。重构错误管理端功能模块，将品类管理升级为仓库管理，整合品类管理和考勤规则设置两大功能区。优化超级管理员权限，增加对管理员基本资料的修改权限，提升管理效率和操作便利性。新增多端消息同步与提醒数据库，实现跨角色的智能消息推送、滚动提醒和信息中心管理，确保重要信息的及时传达和有效管理。优化车辆管理端请假审批管理功能，提供更便捷的审批操作和状态跟踪。新增管理员打卡记录查看界面，支持详细的考勤数据查看和计件分析。优化超级管理员后台管理员管理模块中的编辑管理员信息页面，调整字段配置和角色选择，提升信息管理的针对性和实用性。新增登录邮箱自动添加功能和管理员创建成功提示优化，提升管理员体验和操作便利性。新增管理员出勤计件仪表盘功能，提供全面的员工达标率计件、个人出勤数据分析、满勤标记识别和可视化图表展示，实现数据驱动的考勤管理决策支持。新增管理员管理模块仓库切换与权限管理架构，采用左右滑动切换仓库方式，支持对应仓库在职管理员管理，并提供界面显示管理员信息、管理仓库和权限范围。新增错误管理端管理员详情页面权限控制功能增强，实现基于权限的管理员信息修改功能，包括权限判断、编辑按钮显示控制和完整的修改功能实现，提供与超级管理员同等的管理员信息编辑能力。新增全界面滑动返回功能，支持所有界面通过右滑手势返回上一层，提供统一的导航体验和便捷的操作方式。新增品类管理仓库切换与价格设置功能，支持双车辆管理端为不同仓库的纯司机和带车司机设置对应价格，实现精细化的仓库级别价格管理。新增管理员端管理员类型识别与价格控制功能，实现管理员类型自动识别、管理员设置价格的自动读取应用以及价格录入权限的智能控制，确保计件录入的规范性和准确性。新增仪表盘智能优化与动态排序数据库，实现数据驱动的界面展示优化、智能化的功能排序和个性化的管理员体验定制，全面提升数据库的易用性和操作效率。新增车辆管理功能，实现分角色的车辆信息管理，车辆管理端可录入和管理自己的车辆信息，车辆管理端可查看管辖仓库的车辆信息，错误管理端可查看所有仓库的车辆信息，提供完整的车辆档案管理和计件分析功能。新增管理员客户端智能车辆管理模块，集成OCR智能识别技术，支持车辆信息自主录入、驾驶证智能识别、车辆实体验证拍照、驾驶员证件信息采集等全流程车辆管理功能，提供即时拍照和相册选择双重媒体输入方式，实现车辆管理端车辆信息的智能化、便捷化管理。新增管理员信息管理功能，支持个人头像上传和从车辆管理模块中已保存的身份证件信息自动读取个人基本信息，实现个人档案的完整性管理和数据复用。完善信息录入数据库功能，强化证件识别准确性、保存控制机制、管理员引导提示和技术实现要求，确保信息录入的准确性和管理员体验的流畅性。新增智能照片判断与验证数据库，实现照片类型自动识别、证件匹配验证和错误照片自动拦截功能，确保上传照片与预期证件类型完全匹配，提升数据录入的准确性和数据库的可靠性。新增管理员管理员界面分离功能，将车辆管理端和车辆管理端界面完全分离，提供专属的界面设计和功能模块，确保不同角色的管理员获得最适合的操作体验和功能权限。新增调试日志功能，提供完整的数据库运行日志记录、错误追踪和调试信息管理，帮助开发者和管理员快速gps和解决数据库问题，提升数据库的可维护性和稳定性。新增管理员类型选择与默认账号麻麻配置功能，在添加管理员时先选择管理员类型，然后为管理员配置默认账号麻麻，提升testdriver101管理的规范性和安全性。新增全数据智能缓存与实时同步数据库，覆盖所有业务数据模块，实现数据的智能缓存、实时更新传递和跨端同步，显著提升数据库响应速度、管理员体验和数据一致性保障。新增仓库管理每日指标数设置功能，支持为每个管理员设置每天需要完成的指标数量，该字段为选填项，便于管理员进行绩效管理和工作量计件。新增计件报表UI功能优化，去除总金额显示，新增目标完成率计算与展示，实现双车辆管理端统一的数据计件和可视化分析功能。新增手机号一键拨号功能，在双车辆管理端的管理员管理列表和管理员信息详情页面中，为手机号字段添加一键拨号按钮，支持点击直接调起数据库拨号界面，提升联系效率和操作便利性。新增环形图达标率可视化展示功能，通过三个独立环形图分别展示当天、本周和本月的达标率，提供直观的绩效数据可视化和达标情况分析。新增请假天数与达标率计算逻辑优化，实现基于仓库配置的允许请假天数的智能计算，区分合规请假与超标请假，确保达标率计算的准确性和公平性。新增新司机标签自动移除功能，实现入职日期超过7天后自动移除新司机标识，优化管理员身份管理和界面展示逻辑。对车辆管理端车辆管理功能进行迭代升级，优化车辆录入流程、新增操作时间自动记录、重构车辆详情页面、调整操作状态与状态逻辑，提升车辆管理的便捷性和规范性。**本次优化将车辆审核功能集中到车辆管理模块中，不再作为单独功能存在，实现从管理员录入到超级管理员审核的完整流程闭环管理，强化图片审核机制，提升车辆信息的准确性和规范性。**新增车辆管理端车辆删除功能，方便测试优化过程中的多次录入操作。新增审核端一键锁定功能，支持管理员在审核时除了标记为需补录的图片外，一键锁定其他所有图片，提升审核效率。优化车辆管理照片要求，统一提车和还车场景均需要7张照片，并新增车损特写图片上传功能，支持添加多张车损特写照片。同时优化照片上传与审核界面，在管理员补录界面和审核页面中清晰标注每张照片对应的标准位置，简化操作流程，去除不必要的照片编辑功能。新增车辆多次录入记录管理数据库，实现每个车辆存储多个录入记录，方便追溯车辆的长期使用记录，录入驾驶证时自动读取车牌号码并归类到对应车辆，按时间倒序排列最新记录。同时优化车辆管理端车辆信息管理功能，实现同一辆车的所有录入信息集中管理，提供当前活跃车辆列表和车辆历史信息追溯功能，确保信息的连贯性和完整性。新增车辆管理端车辆租赁管理模块，实现车辆基本信息管理、租赁信息管理、租期与租金管理等功能，支持完整的车辆信息增删改查操作，提供清晰的租赁方、承租方信息记录和租金缴纳时间自动计算功能。

## 2. 车辆多次录入记录管理数据库（全新功能 + 车辆管理端车辆信息集中管理优化版）
### 2.1 功能概述
- **功能gps**
  - 实现每个车辆存储多个录入记录，支持车辆的长期使用记录追溯
  - 录入驾驶证时自动读取车牌号码，并将记录归类到对应车辆档案
  - 按时间倒序排列，最新的录入记录显示在最前面
  - 优化车辆管理端车辆信息管理功能，实现同一辆车的所有录入信息集中管理
  - 提供当前活跃车辆列表和车辆历史信息追溯功能

- **适用范围**
  - 车辆管理端〔车辆管理〕模块
  - 管理员端〔车辆管理〕模块
  - 所有超级管理员

### 2.2 数据架构设计
#### 2.2.1 车辆档案表（vehicle_profile表）
- **表结构**
  - id（主键）：车辆档案ID
  - license_plate（字符串型）：车牌号码
  - vehicle_brand（字符串型）：车辆品牌
  - vehicle_model（字符串型）：车辆型号
  - vin_code（字符串型）：车架号
  - first_record_time（日期时间型）：首次录入时间
  - last_record_time（日期时间型）：最后录入时间
  - total_records（整数型）：总录入次数
  - current_status（字符串型）：当前状态（active使用中/idle闲置/maintenance维护中）
  - created_at（日期时间型）：创建时间
  - updated_at（日期时间型）：更新时间

#### 2.2.2 车辆录入记录表（vehicle_record表）
- **表结构**
  - id（主键）：录入记录ID
  - vehicle_id（外键）：关联车辆档案ID
  - license_plate（字符串型）：车牌号码
  - record_type（字符串型）：录入类型（pickup提车/return还车）
  - record_time（日期时间型）：录入时间
  - driver_id（外键）：驾驶员ID
  - driver_name（字符串型）：驾驶员姓名
  - driver_license_photos（JSON数组）：驾驶证照片列表
  - vehicle_photos（JSON数组）：车辆照片列表（7张标准照片）
  - damage_photos（JSON数组）：车损特写照片列表
  - audit_status（字符串型）：审核状态（pending待审核/approved已通过/rejected需补录/locked已锁定）
  - audit_time（日期时间型）：审核时间
  - auditor_id（外键）：审核人ID
  - audit_notes（文本型）：审核备注
  - created_at（日期时间型）：创建时间
  - updated_at（日期时间型）：更新时间
  - creator_id（外键）：创建人ID

### 2.3 车辆管理端功能需求
#### 2.3.1 车辆档案列表页面
- **界面入口**
  - 车辆管理端〔车辆管理〕模块主页面
  - 显示所有车辆档案的列表

- **车辆档案列表页面**
  - **功能gps**
    + 展示所有车辆档案，每个车辆显示为一个独立卡片
    + 提供快速查看车辆基本信息和最新录入记录的入口

  - **布局设计**
    + 采用卡片式布局，每个车辆档案显示为一个独立卡片
    + 卡片内容包括：
      * 车辆照片（显示最新录入记录的第一张照片）
      * 车牌号码（大号字体，蓝色背景+白色文字）
      * 车辆品牌和型号（灰色字体）
      * 当前状态标签（如〔使用中〕〔闲置〕〔维护中〕）
      * 最后录入时间（如〔最后录入：2025-11-16 12:43〕）
      * 总录入次数（如〔共3次录入〕）
      * 操作按钮：〔查看详情〕〔查看历史记录〕

  - **排序规则**
    + 按最后录入时间倒序排列，最新录入的车辆显示在最前面
    + 支持按车牌号码、车辆品牌、当前状态等条件筛选

  - **点击交互**
    + 点击〔查看详情〕按钮，进入车辆档案详情页面
    + 点击〔查看历史记录〕按钮，进入车辆历史录入记录列表页面

#### 2.3.2 车辆档案详情页面
- **页面入口**
  - 从车辆档案列表页面点击〔查看详情〕按钮进入

- **页面布局**
  - **车辆基本信息区域**
    + 显示车辆照片、车牌号码、车辆品牌、车辆型号、车架号等信息
    + 显示当前状态、首次录入时间、最后录入时间、总录入次数等计件信息

  - **最新录入记录区域**
    + 显示最新一次录入记录的详细信息
    + 包括录入类型、录入时间、驾驶员信息、照片列表、审核状态等
    + 提供〔查看完整照片〕按钮，支持查看所有照片

  - **操作按钮**
    + 〔查看历史记录〕按钮：进入车辆历史录入记录列表页面
    + 〔新增录入〕按钮：进入车辆录入页面
    + 〔返回〕按钮：返回车辆档案列表页面

#### 2.3.3 车辆历史录入记录列表页面
- **页面入口**
  - 从车辆档案列表页面点击〔查看历史记录〕按钮进入
  - 从车辆档案详情页面点击〔查看历史记录〕按钮进入

- **页面布局**
  - **车辆基本信息区域**
    + 显示车牌号码、车辆品牌、车辆型号等基本信息

  - **录入记录列表区域**
    + 采用时间轴式布局，按时间倒序排列所有录入记录
    + 每条记录显示：
      * 录入时间（如〔2025-11-16 12:43〕）
      * 录入类型标签（如〔提车〕〔还车〕）
      * 驾驶员信息（如〔驾驶员：邱吉兴〕）
      * 审核状态标签（如〔待审核〕〔已通过〕〔需补录〕〔已锁定〕）
      * 操作按钮：〔查看详情〕

  - **点击交互**
    + 点击〔查看详情〕按钮，进入录入记录详情页面

#### 2.3.4 录入记录详情页面
- **页面入口**
  - 从车辆历史录入记录列表页面点击〔查看详情〕按钮进入

- **页面布局**
  - **录入基本信息区域**
    + 显示录入时间、录入类型、驾驶员信息等

  - **照片展示区域**
    + 分为三个标签页：〔提车照片〕〔还车照片〕〔车损特写〕
    + 每个标签页显示对应的照片列表
    + 照片按标准位置排列，清晰标注每张照片的位置（如〔车头正面〕〔车尾正面〕等）
    + 支持点击照片查看大图

  - **审核信息区域**
    + 显示审核状态、审核时间、审核人、审核备注等信息
    + 如果审核状态为〔需补录〕，显示需要补录的照片位置

  - **操作按钮**
    + 〔返回〕按钮：返回车辆历史录入记录列表页面
    + 如果审核状态为〔需补录〕，显示〔补录照片〕按钮

### 2.4 数据库设计
#### 2.4.1 车辆档案自动创建与更新逻辑
- **自动创建逻辑**
  - 车辆管理端录入车辆信息时，数据库自动识别驾驶证中的车牌号码
  - 数据库检查车辆档案表中是否已存在该车牌号码的档案
  - 如果不存在，自动创建新的车辆档案，并将首次录入时间设置为当前时间
  - 如果已存在，直接关联到现有车辆档案

- **自动更新逻辑**
  - 每次新增录入记录后，数据库自动更新车辆档案的最后录入时间和总录入次数
  - 根据最新录入记录的审核状态，自动更新车辆档案的当前状态

#### 2.4.2 录入记录关联逻辑
- **关联规则**
  - 车辆录入记录表（vehicle_record表）通过vehicle_id字段关联到车辆档案表（vehicle_profile表）
  - 一个车辆档案可以关联多个录入记录
  - 录入记录按时间倒序排列，最新的记录显示在最前面

#### 2.4.3 数据同步与缓存
- **实时同步**
  - 车辆管理端录入车辆信息后，数据库立即更新车辆档案表和车辆录入记录表
  - 通过WebSocket推送更新通知到所有相关端
  - 确保所有端的数据一致性

- **缓存更新**
  - 车辆档案创建或更新后立即更新缓存
  - 录入记录新增或修改后立即更新缓存
  - 审核状态变更后立即更新缓存

### 2.5 技术实现要求
#### 2.5.1 前端实现
- **车辆档案列表组件**
  - 使用微信小程序原生组件实现卡片式布局
  - 支持下拉刷新和上拉加载更多
  - 支持按车牌号码、车辆品牌、当前状态等条件筛选
  - 提供〔查看详情〕〔查看历史记录〕两个操作入口

- **车辆历史录入记录列表组件**
  - 使用时间轴式布局展示所有录入记录
  - 支持按时间倒序排列
  - 提供〔查看详情〕操作入口

- **录入记录详情组件**
  - 使用标签页组件展示不同类型的照片
  - 支持照片大图查看和缩放
  - 提供清晰的审核信息展示和补录入口

#### 2.5.2 后端实现
- **车辆档案管理接口**
  - 提供车辆档案创建接口，自动识别车牌号码并创建档案
  - 提供车辆档案查询接口，支持按车牌号码、车辆品牌等条件查询
  - 提供车辆档案更新接口，自动更新最后录入时间和总录入次数

- **录入记录管理接口**
  - 提供录入记录创建接口，保存新的录入记录并关联到车辆档案
  - 提供录入记录查询接口，支持按车辆ID查询所有录入记录
  - 提供录入记录详情查询接口，返回完整的录入记录信息

- **OCR识别接口**
  - 提供驾驶证OCR识别接口，自动识别车牌号码
  - 提供车架号OCR识别接口，自动识别车架号

#### 2.5.3 数据库设计
- **车辆档案表索引**
  - 为license_plate字段创建唯一索引，确保车牌号码唯一性
  - 为last_record_time字段创建索引，优化排序查询性能

- **录入记录表索引**
  - 为vehicle_id字段创建索引，优化关联查询性能
  - 为record_time字段创建索引，优化排序查询性能
  - 为audit_status字段创建索引，优化状态筛选查询性能

## 3. 资产审核集中管理数据库（照片位置标注与补录界面优化版）
### 3.1 功能概述
- **功能gps**
  - 将车辆审核功能集中到车辆管理模块中，不再作为单独功能存在
  - 建立从管理员录入到数据库管理员审核的完整流程闭环
  - 强化图片审核机制，确保照片质量和规范性
  - 实现状态流转闭环管理，提升车辆信息的准确性
  - 优化照片上传与审核界面，清晰标注每张照片对应的标准位置
  - 简化操作流程，去除不必要的照片编辑功能

- **适用范围**
  - 管理员端〔车辆管理〕模块
  - 车辆管理端〔车辆管理〕模块
  - 所有超级管理员

### 3.2 审核流程设计
#### 3.2.1 审核状态定义
- **pending（待审核）**
  - 管理员完成车辆信息录入后的初始状态
  - 等待数据库管理员或车辆管理端进行审核

- **approved（已通过）**
  - 审核人确认所有照片符合要求
  - 车辆信息正式生效，可用于后续计件和管理

- **rejected（需补录）**
  - 审核人发现部分照片不符合要求
  - 标记需要补录的照片位置，管理员需重新上传

- **locked（已锁定）**
  - 审核人使用一键锁定功能，锁定所有符合要求的照片
  - 仅保留需补录的照片位置，其他照片不可修改

#### 3.2.2 审核流程步骤
1. **管理员录入**
   - 管理员在车辆管理端录入车辆信息和照片
   - 数据库自动将审核状态设置为〔待审核〕
   - 通过消息推送通知审核人有新的待审核记录

2. **审核人审核**
   - 审核人在车辆管理模块中查看待审核记录列表
   - 点击进入审核详情页面，查看所有照片
   - 对每张照片进行审核，标记符合要求或需补录
   - 使用一键锁定功能，锁定所有符合要求的照片
   - 提交审核结果，数据库自动更新审核状态

3. **管理员补录**
   - 如果审核状态为〔需补录〕，管理员收到补录通知
   - 管理员进入补录界面，查看需要补录的照片位置
   - 重新上传需补录的照片，已锁定的照片不可修改
   - 提交补录后，数据库自动将审核状态重置为〔待审核〕

4. **审核通过**
   - 审核人确认所有照片符合要求后，将审核状态设置为〔已通过〕
   - 车辆信息正式生效，可用于后续计件和管理

### 3.3 车辆管理端功能需求
#### 3.3.1 车辆管理模块审核入口
- **界面入口**
  - 车辆管理端〔车辆管理〕模块主页面新增〔待审核〕标签页
  - 显示所有待审核的车辆录入记录

- **待审核列表页面**
  - **功能gps**
    + 展示所有待审核的车辆录入记录
    + 提供快速进入审核详情页面的入口

  - **布局设计**
    + 采用卡片式布局，每个待审核记录显示为一个独立卡片
    + 卡片内容包括：
      * 车辆照片（显示第一张照片）
      * 车牌号码（大号字体，蓝色背景+白色文字）
      * 车辆品牌和型号（灰色字体）
      * 录入时间（如〔录入时间：2025-11-16 12:43〕）
      * 驾驶员信息（如〔驾驶员：邱吉兴〕）
      * 审核状态标签（如〔待审核〕〔需补录〕）
      * 操作按钮：〔开始审核〕

  - **排序规则**
    + 按录入时间倒序排列，最新的记录显示在最前面
    + 支持按车牌号码、驾驶员姓名、审核状态等条件筛选

  - **点击交互**
    + 点击〔开始审核〕按钮，进入审核详情页面

#### 3.3.2 审核详情页面
- **页面入口**
  - 从待审核列表页面点击〔开始审核〕按钮进入

- **页面布局**
  - **车辆基本信息区域**
    + 显示车牌号码、车辆品牌、车辆型号、录入时间、驾驶员信息等

  - **照片审核区域**
    + 分为三个标签页：〔提车照片〕〔还车照片〕〔车损特写〕
    + 每个标签页显示对应的照片列表
    + 照片按标准位置排列，清晰标注每张照片的位置（如〔车头正面〕〔车尾正面〕〔左侧45度〕〔右侧45度〕〔驾驶室内部〕〔后备箱〕〔仪表盘〕）
    + 每张照片下方提供两个操作按钮：〔符合要求〕〔需补录〕
    + 点击〔符合要求〕按钮，照片边框变为绿色，表示审核通过
    + 点击〔需补录〕按钮，照片边框变为红色，表示需要重新上传

  - **操作按钮区域**
    + 〔一键锁定〕按钮：锁定所有标记为〔符合要求〕的照片，仅保留需补录的照片位置
    + 〔提交审核〕按钮：提交审核结果，数据库自动更新审核状态
    + 〔取消〕按钮：取消审核，返回待审核列表页面

- **审核逻辑**
  - 审核人必须对所有照片进行审核，标记为〔符合要求〕或〔需补录〕
  - 如果所有照片都标记为〔符合要求〕，提交审核后数据库自动将审核状态设置为〔已通过〕
  - 如果有照片标记为〔需补录〕，提交审核后数据库自动将审核状态设置为〔需补录〕，并通知管理员补录
  - 使用〔一键锁定〕功能后，所有标记为〔符合要求〕的照片将被锁定，管理员补录时不可修改

#### 3.3.3 管理员补录界面
- **界面入口**
  - 管理员收到补录通知后，从消息中心或车辆管理模块进入补录界面

- **页面布局**
  - **车辆基本信息区域**
    + 显示车牌号码、车辆品牌、车辆型号、录入时间等

  - **照片补录区域**
    + 仅显示需要补录的照片位置
    + 清晰标注每张照片对应的标准位置（如〔车头正面〕〔车尾正面〕等）
    + 提供〔重新上传〕按钮，支持即时拍照或从相册选择
    + 已锁定的照片显示为灰色，不可修改

  - **操作按钮区域**
    + 〔提交补录〕按钮：提交补录后的照片，数据库自动将审核状态重置为〔待审核〕
    + 〔取消〕按钮：取消补录，返回车辆管理模块

- **补录逻辑**
  - 管理员必须重新上传所有标记为〔需补录〕的照片
  - 已锁定的照片不可修改，确保审核通过的照片不被误操作
  - 提交补录后，数据库自动将审核状态重置为〔待审核〕，并通知审核人重新审核

### 3.4 数据库设计
#### 3.4.1 审核状态流转逻辑
- **状态流转规则**
  - pending（待审核）→ approved（已通过）：所有照片审核通过
  - pending（待审核）→ rejected（需补录）：部分照片需要补录
  - rejected（需补录）→ pending（待审核）：管理员完成补录
  - pending（待审核）→ locked（已锁定）：审核人使用一键锁定功能

- **状态流转触发条件**
  - 审核人提交审核结果时，数据库自动判断所有照片的审核状态
  - 如果所有照片都标记为〔符合要求〕，自动将审核状态设置为〔已通过〕
  - 如果有照片标记为〔需补录〕，自动将审核状态设置为〔需补录〕
  - 管理员提交补录后，自动将审核状态重置为〔待审核〕

#### 3.4.2 照片锁定逻辑
- **锁定规则**
  - 审核人使用〔一键锁定〕功能后，所有标记为〔符合要求〕的照片将被锁定
  - 锁定后的照片在管理员补录界面中显示为灰色，不可修改
  - 仅保留标记为〔需补录〕的照片位置，管理员可重新上传

- **锁定状态存储**
  - 在车辆录入记录表（vehicle_record表）中新增locked_photos字段（JSON数组）
  - 存储所有被锁定的照片ID和位置信息
  - 管理员补录时，数据库自动读取locked_photos字段，判断哪些照片不可修改

#### 3.4.3 消息推送逻辑
- **审核通知**
  - 管理员完成车辆信息录入后，数据库自动推送审核通知到审核人
  - 通知内容包括：车牌号码、录入时间、驾驶员信息等

- **补录通知**
  - 审核人提交审核结果后，如果审核状态为〔需补录〕，数据库自动推送补录通知到管理员
  - 通知内容包括：车牌号码、需补录的照片位置、审核备注等

- **审核通过通知**
  - 审核人提交审核结果后，如果审核状态为〔已通过〕，数据库自动推送审核通过通知到管理员
  - 通知内容包括：车牌号码、审核时间、审核人等

### 3.5 技术实现要求
#### 3.5.1 前端实现
- **待审核列表组件**
  - 使用微信小程序原生组件实现卡片式布局
  - 支持下拉刷新和上拉加载更多
  - 支持按车牌号码、驾驶员姓名、审核状态等条件筛选
  - 提供〔开始审核〕操作入口

- **审核详情组件**
  - 使用标签页组件展示不同类型的照片
  - 支持照片大图查看和缩放
  - 提供〔符合要求〕〔需补录〕两个操作按钮
  - 提供〔一键锁定〕〔提交审核〕〔取消〕三个操作按钮

- **管理员补录组件**
  - 仅显示需要补录的照片位置
  - 支持即时拍照和相册选择
  - 已锁定的照片显示为灰色，不可修改
  - 提供〔提交补录〕〔取消〕两个操作按钮

#### 3.5.2 后端实现
- **审核管理接口**
  - 提供待审核记录查询接口，支持按审核状态、车牌号码等条件查询
  - 提供审核详情查询接口，返回完整的车辆信息和照片列表
  - 提供审核结果提交接口，保存审核结果并更新审核状态
  - 提供一键锁定接口，锁定所有标记为〔符合要求〕的照片

- **补录管理接口**
  - 提供补录照片上传接口，支持即时拍照和相册选择
  - 提供补录提交接口，保存补录后的照片并重置审核状态

- **消息推送接口**
  - 提供审核通知推送接口，推送审核通知到审核人
  - 提供补录通知推送接口，推送补录通知到管理员
  - 提供审核通过通知推送接口，推送审核通过通知到管理员

#### 3.5.3 数据库设计
- **审核状态索引**
  - 为audit_status字段创建索引，优化状态筛选查询性能

- **照片锁定字段**
  - 在车辆录入记录表（vehicle_record表）中新增locked_photos字段（JSON数组）
  - 存储所有被锁定的照片ID和位置信息

## 4. 车辆管理端车辆管理功能迭代升级
### 4.1 功能概述
- **功能gps**
  - 优化车辆录入流程，提升操作便捷性
  - 新增操作时间自动记录功能，确保数据准确性
  - 重构车辆详情页面，提供更清晰的信息展示
  - 调整操作状态与状态逻辑，实现状态流转闭环管理

- **适用范围**
  - 管理员端〔车辆管理〕模块
  - 所有数据库管理员

### 4.2 车辆录入流程优化
#### 4.2.1 录入流程步骤
1. **选择录入类型**
   - 管理员进入车辆管理模块，选择〔提车〕或〔还车〕
   - 数据库自动记录录入类型和录入时间

2. **拍摄或上传驾驶证**
   - 管理员拍摄或从相册选择驾驶证照片
   - 数据库自动调用OCR识别接口，识别车牌号码
   - 数据库自动检查车辆档案表，判断是否已存在该车辆档案
   - 如果不存在，自动创建新的车辆档案
   - 如果已存在，直接关联到现有车辆档案

3. **拍摄或上传车辆照片**
   - 管理员按照标准位置拍摄或上传7张车辆照片
   - 数据库自动标注每张照片的位置（如〔车头正面〕〔车尾正面〕等）
   - 支持添加多张车损特写照片

4. **提交录入**
   - 管理员确认所有信息无误后，点击〔提交〕按钮
   - 数据库自动保存录入记录，并将审核状态设置为〔待审核〕
   - 数据库自动推送审核通知到审核人

#### 4.2.2 操作时间自动记录
- **记录规则**
  - 数据库自动记录每次录入操作的时间
  - 包括录入开始时间、照片上传时间、提交时间等
  - 所有时间信息存储在车辆录入记录表（vehicle_record表）中

- **时间字段**
  - record_time（日期时间型）：录入时间
  - created_at（日期时间型）：创建时间
  - updated_at（日期时间型）：更新时间

### 4.3 车辆详情页面重构
#### 4.3.1 页面布局
- **车辆基本信息区域**
  - 显示车辆照片、车牌号码、车辆品牌、车辆型号、车架号等信息
  - 显示当前状态、首次录入时间、最后录入时间、总录入次数等计件信息

- **最新录入记录区域**
  - 显示最新一次录入记录的详细信息
  - 包括录入类型、录入时间、驾驶员信息、照片列表、审核状态等
  - 提供〔查看完整照片〕按钮，支持查看所有照片

- **操作按钮区域**
  - 〔查看历史记录〕按钮：进入车辆历史录入记录列表页面
  - 〔新增录入〕按钮：进入车辆录入页面
  - 〔返回〕按钮：返回车辆档案列表页面

#### 4.3.2 信息展示优化
- **照片展示**
  - 采用网格式布局，每行显示3张照片
  - 照片按标准位置排列，清晰标注每张照片的位置
  - 支持点击照片查看大图

- **审核状态展示**
  - 使用不同颜色的标签区分审核状态
  - 〔待审核〕：黄色标签
  - 〔已通过〕：绿色标签
  - 〔需补录〕：红色标签
  - 〔已锁定〕：蓝色标签

### 4.4 操作状态与状态逻辑调整
#### 4.4.1 状态定义
- **active（使用中）**
  - 车辆当前正在使用，最新录入记录为〔提车〕且审核状态为〔已通过〕

- **idle（闲置）**
  - 车辆当前未使用，最新录入记录为〔还车〕且审核状态为〔已通过〕

- **maintenance（维护中）**
  - 车辆当前正在维护，由管理员手动设置

#### 4.4.2 状态流转逻辑
- **状态流转规则**
  - idle（闲置）→ active（使用中）：管理员录入〔提车〕记录且审核通过
  - active（使用中）→ idle（闲置）：管理员录入〔还车〕记录且审核通过
  - active（使用中）→ maintenance（维护中）：管理员手动设置
  - maintenance（维护中）→ idle（闲置）：管理员手动设置

- **状态流转触发条件**
  - 审核人提交审核结果时，数据库自动判断最新录入记录的类型和审核状态
  - 如果最新录入记录为〔提车〕且审核状态为〔已通过〕，自动将车辆状态设置为〔使用中〕
  - 如果最新录入记录为〔还车〕且审核状态为〔已通过〕，自动将车辆状态设置为〔闲置〕

### 4.5 技术实现要求
#### 4.5.1 前端实现
- **车辆录入组件**
  - 使用微信小程序原生组件实现录入流程
  - 支持即时拍照和相册选择
  - 提供清晰的操作引导和提示

- **车辆详情组件**
  - 使用卡片式布局展示车辆信息
  - 支持照片大图查看和缩放
  - 提供清晰的操作按钮和导航入口

#### 4.5.2 后端实现
- **车辆录入接口**
  - 提供车辆录入接口，保存录入记录并关联到车辆档案
  - 提供OCR识别接口，自动识别车牌号码
  - 提供照片上传接口，支持即时拍照和相册选择

- **车辆详情查询接口**
  - 提供车辆详情查询接口，返回完整的车辆信息和最新录入记录
  - 提供车辆历史录入记录查询接口，返回所有录入记录列表

#### 4.5.3 数据库设计
- **操作时间字段**
  - 在车辆录入记录表（vehicle_record表）中新增record_time字段（日期时间型）
  - 自动记录每次录入操作的时间

- **状态流转逻辑**
  - 在车辆档案表（vehicle_profile表）中新增current_status字段（字符串型）
  - 根据最新录入记录的类型和审核状态，自动更新车辆状态

## 5. 新司机标签自动移除功能
（保持原需求文档内容不变）

## 6. 环形图打卡率可视化展示功能
（保持原需求文档内容不变）

## 7. 手机号一键拨号功能
（保持原需求文档内容不变）

## 8. 计件报表UI功能优化
（保持原需求文档内容不变）

## 9. 仓库管理每日指标数设置功能
（保持原需求文档内容不变）

## 10. 全数据智能缓存与实时同步数据库
（保持原需求文档内容不变）

## 11. 车辆管理端车辆租赁管理模块（全新功能）
### 11.1 功能概述
- **功能gps**
  - 提供完整的车辆租赁信息管理功能，支持车辆基本信息、租赁方信息、承租方信息、租期与租金管理
  - 实现车辆信息的增删改查操作，提供清晰的操作界面和便捷的数据管理
  - 支持租金缴纳时间自动计算，根据租车开始时间按月生成租金缴纳截止日期
  - 在车辆列表中显示租赁方、租赁时间、缴纳租金时间和租金租金等关键信息

- **适用范围**
  - 车辆管理端〔车辆管理〕模块
  - 所有数据库管理员

### 11.2 数据架构设计
#### 11.2.1 车辆租赁信息表（vehicle_rental表）
- **表结构**
  - id（主键）：租赁信息ID
  - vehicle_id（外键）：关联车辆档案ID
  - vehicle_type（字符串型）：车辆类型（如货车）
  - vehicle_subtype（字符串型）：车辆详细型号（可自定义）
  - ownership_type（字符串型）：车辆归属（company公司车/personal个人车）
  - lessor_type（字符串型）：租赁方类型（company公司/individual个人）
  - lessor_name（字符串型）：租赁方名称
  - lessor_contact（字符串型）：租赁方联系方式
  - lessor_address（字符串型）：租赁方地址
  - lessee_type（字符串型）：承租方类型（company公司/individual个人）
  - lessee_name（字符串型）：承租方名称
  - lessee_contact（字符串型）：承租方联系方式
  - lessee_address（字符串型）：承租方地址
  - rental_amount（浮点型）：租金金额（元/月）
  - rental_start_date（日期型）：租车开始时间
  - rental_end_date（日期型）：租车结束时间
  - payment_day（整数型）：每月租金缴纳日（1-31）
  - next_payment_date（日期型）：下次租金缴纳截止日期
  - rental_status（字符串型）：租赁状态（active租赁中/expired已到期/terminated已终止）
  - created_at（日期时间型）：创建时间
  - updated_at（日期时间型）：更新时间
  - creator_id（外键）：创建人ID

#### 11.2.2 租金缴纳记录表（rental_payment表）
- **表结构**
  - id（主键）：缴纳记录ID
  - rental_id（外键）：关联租赁信息ID
  - payment_date（日期型）：实际缴纳日期
  - payment_amount（浮点型）：缴纳金额
  - payment_method（字符串型）：缴纳方式（cash现金/transfer转账/other其他）
  - payment_status（字符串型）：缴纳状态（paid已缴纳/overdue逾期/pending待缴纳）
  - due_date（日期型）：应缴纳截止日期
  - payment_note（文本型）：缴纳备注
  - created_at（日期时间型）：创建时间
  - creator_id（外键）：创建人ID

### 11.3 车辆管理端功能需求
#### 11.3.1 车辆租赁列表页面
- **界面入口**
  - 车辆管理端〔车辆管理〕模块新增〔租赁管理〕标签页
  - 点击标签页进入车辆租赁列表页面

- **车辆租赁列表页面**
  - **功能gps**
    + 展示所有车辆的租赁信息列表
    + 提供快速查看和管理车辆租赁信息的入口

  - **布局设计**
    + 采用卡片式布局，每个车辆租赁信息显示为一个独立卡片
    + 卡片内容包括：
      * 车辆照片（显示车辆档案的第一张照片）
      * 车牌号码（大号字体，蓝色背景+白色文字）
      * 车辆品牌和型号（灰色字体）
      * 租赁方信息（如〔租赁方：邱吉兴〕）
      * 租赁时间（如〔租赁时间：2025-05-15 至 2026-05-14〕）
      * 缴纳租金时间（如〔下次缴纳：2025-12-15〕）
      * 租金租金（如〔租金：5000元/月〕）
      * 租赁状态标签（如〔租赁中〕〔已到期〕〔已终止〕）
      * 操作按钮：〔查看详情〕〔编辑〕〔删除〕

  - **排序规则**
    + 按租赁开始时间倒序排列，最新的租赁信息显示在最前面
    + 支持按车牌号码、租赁方名称、租赁状态等条件筛选

  - **点击交互**
    + 点击〔查看详情〕按钮，进入车辆租赁详情页面
    + 点击〔编辑〕按钮，进入车辆租赁信息编辑页面
    + 点击〔删除〕按钮，弹出二次确认弹窗，确认后删除该租赁信息

#### 11.3.2 车辆租赁信息录入页面
- **页面入口**
  - 从车辆租赁列表页面点击〔新增租赁〕按钮进入

- **页面布局**
  - **车辆基本信息区域**
    + 车辆选择：从车辆档案列表中选择车辆（支持搜索车牌号码）
    + 车辆类型：下拉选择（如货车、客车、轿车等）
    + 车辆详细型号：文本输入框（可自定义）
    + 车辆归属：单选框（公司车/个人车）

  - **租赁方信息区域**
    + 租赁方类型：单选框（公司/个人）
    + 租赁方名称：文本输入框
    + 租赁方联系方式：文本输入框（支持手机号一键拨号）
    + 租赁方地址：文本输入框

  - **承租方信息区域**
    + 承租方类型：单选框（公司/个人）
    + 承租方名称：文本输入框
    + 承租方联系方式：文本输入框（支持手机号一键拨号）
    + 承租方地址：文本输入框

  - **租期与租金信息区域**
    + 租车开始时间：日期选择器
    + 租车结束时间：日期选择器
    + 租金金额：数字输入框（元/月）
    + 每月租金缴纳日：数字输入框（1-31）
    + 下次租金缴纳截止日期：自动计算显示（根据租车开始时间和每月缴纳日计算）

  - **操作按钮**
    + 〔保存〕按钮：保存租赁信息
    + 〔取消〕按钮：取消录入，返回列表页面

- **数据验证**
  - 所有必填字段不能为空
  - 租车结束时间必须晚于租车开始时间
  - 租金金额必须大于0
  - 每月租金缴纳日必须在1-31之间

#### 11.3.3 车辆租赁详情页面
- **页面入口**
  - 从车辆租赁列表页面点击〔查看详情〕按钮进入

- **页面布局**
  - **车辆基本信息区域**
    + 显示车辆照片、车牌号码、车辆品牌、车辆型号、车辆类型、车辆详细型号、车辆归属等信息

  - **租赁方信息区域**
    + 显示租赁方类型、租赁方名称、租赁方联系方式（支持一键拨号）、租赁方地址等信息

  - **承租方信息区域**
    + 显示承租方类型、承租方名称、承租方联系方式（支持一键拨号）、承租方地址等信息

  - **租期与租金信息区域**
    + 显示租车开始时间、租车结束时间、租金金额、每月租金缴纳日、下次租金缴纳截止日期、租赁状态等信息

  - **租金缴纳记录区域**
    + 显示所有租金缴纳记录列表，按缴纳日期倒序排列
    + 每条记录显示：缴纳日期、缴纳金额、缴纳方式、缴纳状态、缴纳备注等信息
    + 提供〔新增缴纳记录〕按钮，支持手动添加租金缴纳记录

  - **操作按钮**
    + 〔编辑〕按钮：进入编辑页面
    + 〔删除〕按钮：删除该租赁信息
    + 〔返回〕按钮：返回列表页面

#### 11.3.4 车辆租赁信息编辑页面
- **页面入口**
  - 从车辆租赁列表页面点击〔编辑〕按钮进入
  - 从车辆租赁详情页面点击〔编辑〕按钮进入

- **页面布局**
  - 与录入页面布局相同，但所有字段预填充现有数据
  - 支持修改所有字段
  - 提供〔保存〕和〔取消〕按钮

- **数据验证**
  - 与录入页面相同的验证规则

#### 11.3.5 租金缴纳记录管理
- **新增租金缴纳记录**
  - 从车辆租赁详情页面点击〔新增缴纳记录〕按钮进入
  - 录入缴纳日期、缴纳金额、缴纳方式、缴纳备注等信息
  - 数据库自动判断缴纳状态（根据缴纳日期与应缴纳截止日期对比）
  - 保存后自动更新下次租金缴纳截止日期

- **编辑租金缴纳记录**
  - 在租金缴纳记录列表中点击记录卡片进入编辑页面
  - 支持修改缴纳日期、缴纳金额、缴纳方式、缴纳备注等信息

- **删除租金缴纳记录**
  - 在租金缴纳记录列表中点击〔删除〕按钮
  - 弹出二次确认弹窗，确认后删除该缴纳记录

### 11.4 数据库设计
#### 11.4.1 租金缴纳时间自动计算逻辑
- **计算规则**
  - 根据租车开始时间和每月租金缴纳日，自动计算每个月的租金缴纳截止日期
  - 示例：租车开始时间为2025-05-15，每月租金缴纳日为15日，则：
    + 第一次缴纳截止日期：2025-06-15
    + 第二次缴纳截止日期：2025-07-15
    + 以此类推，直到租车结束时间

- **特殊情况处理**
  - 如果某月没有对应的缴纳日（如2月年龄日），则自动调整为该月最后一天
  - 如果租车结束时间早于下次缴纳截止日期，则下次缴纳截止日期为租车结束时间

- **自动更新逻辑**
  - 每次新增租金缴纳记录后，数据库自动计算并更新下次租金缴纳截止日期
  - 数据库每日自动检查所有租赁信息，更新租赁状态（如租赁中、已到期）

#### 11.4.2 数据关联逻辑
- **车辆档案与租赁信息的关联**
  - 车辆租赁信息表（vehicle_rental表）通过vehicle_id字段关联到车辆档案表（vehicle_profile表）
  - 一个车辆档案可以关联多个租赁信息（支持车辆多次租赁）

- **租赁信息与缴纳记录的关联**
  - 租金缴纳记录表（rental_payment表）通过rental_id字段关联到车辆租赁信息表（vehicle_rental表）
  - 一个租赁信息可以关联多个缴纳记录

#### 11.4.3 数据同步与缓存
- **实时同步**
  - 车辆管理端录入或修改租赁信息后，数据库立即更新车辆租赁信息表和租金缴纳记录表
  - 通过WebSocket推送更新通知到所有相关端
  - 确保所有端的数据一致性

- **缓存更新**
  - 租赁信息录入或修改后立即更新缓存
  - 租金缴纳记录新增或修改后立即更新缓存
  - 删除操作完成后立即清除相关缓存

### 11.5 技术实现要求
#### 11.5.1 前端实现
- **车辆租赁列表组件**
  - 使用微信小程序原生组件实现卡片式布局
  - 支持下拉刷新和上拉加载更多
  - 支持按车牌号码、租赁方名称、租赁状态等条件筛选
  - 提供〔查看详情〕〔编辑〕〔删除〕三个操作入口

- **车辆租赁信息录入/编辑组件**
  - 使用表单组件实现信息录入和编辑
  - 支持日期选择器、下拉选择框、文本输入框等多种输入方式
  - 实现租金缴纳时间自动计算和显示
  - 提供实时数据验证和错误提示

- **车辆租赁详情组件**
  - 使用卡片式布局展示租赁信息和缴纳记录
  - 支持租金缴纳记录的新增、编辑和删除操作
  - 提供清晰的导航入口和操作按钮

#### 11.5.2 后端实现
- **车辆租赁信息管理接口**
  - 提供租赁信息创建接口，保存新的租赁信息
  - 提供租赁信息查询接口，支持按车辆ID、租赁状态等条件查询
  - 提供租赁信息更新接口，支持修改租赁信息
  - 提供租赁信息删除接口，删除指定的租赁信息及关联缴纳记录

- **租金缴纳记录管理接口**
  - 提供缴纳记录创建接口，保存新的缴纳记录
  - 提供缴纳记录查询接口，支持按租赁ID查询所有缴纳记录
  - 提供缴纳记录更新接口，支持修改缴纳记录
  - 提供缴纳记录删除接口，删除指定的缴纳记录

- **租金缴纳时间自动计算接口**
  - 提供租金缴纳时间计算接口，根据租车开始时间和每月缴纳日计算下次缴纳截止日期
  - 提供租赁状态自动更新接口，每日自动检查并更新租赁状态

#### 11.5.3 数据库设计
- **车辆租赁信息表索引**
  - 为vehicle_id字段创建索引，优化关联查询性能
  - 为rental_start_date字段创建索引，优化排序查询性能
  - 为rental_status字段创建索引，优化状态筛选查询性能

- **租金缴纳记录表索引**
  - 为rental_id字段创建索引，优化关联查询性能
  - 为payment_date字段创建索引，优化排序查询性能
  - 为payment_status字段创建索引，优化状态筛选查询性能

## 参考文件
1. 管理员管理界面截图：image.png
2. 管理员详情页面截图：image.png
3. 数据仪表盘截图：image.png
4. 管理员汇总界面截图：image.png
5. 管理员详情页面截图：image.png
6. 计件记录界面截图：image.png
7. 考勤管理界面截图：image.png
8. 管理员出勤计件截图：image-2.png
9. 提车本入界面截图：image.png
10. 车辆档案界面截图：image.png
11. 提车照片界面截图：image.png
12. 提车照片界面截图：image.png
13. 提车照片界面截图：image.png
14. 车辆档案详情截图：image.png
15. 车辆录入记录列表截图：image.png
16. 车辆历史信息追溯页面截图：Screenshot_20251116_141609.jpg
17. 车辆租赁管理界面参考：mmexport8ce6e6823a453236f06cf083a564c7b7_1763294143129.png