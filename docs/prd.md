# 车队管家小程序管理系统需求文档

## 1. 系统概述

### 1.1 系统名称
车队管家小程序管理系统

### 1.2 系统描述
专为车队管理打造的微信小程序管理系统，采用独立数据库架构为每个租户提供物理隔离的数据环境，支持车辆、司机管理和数据统计功能。系统新增中央管理系统来统一管理所有租户配置。

### 1.3 项目目标
快速开发一个可登录的车队管理小程序，实现基础的车辆、司机管理和数据统计功能，基于独立数据库确保租户数据隔离，并优化数据库结构和查询逻辑，完善账号权限管理。新增中央管理系统实现租户自动化开通和动态参数管理。

## 2. 核心功能模块
\n### 2.1 用户管理功能
- **用户登录**：账号密码登录验证
- **用户注册**：基础用户信息注册
- **用户信息管理**：个人信息编辑和更新
- **角色管理**：老板、平级账号、车队长、司机等角色分配
\n#### 2.1.1 账号角色定义
- **老板账号**：所租用系统的最高权限所有者，可访问所有数据\n- **平级账号**：由老板创建的同级管理员\n  - **完整权限**：与老板权限相同，可增改停删\n  - **查看权限**：仅能查看，无修改权限
- **车队长账号**：管理权限受限于管辖范围
  - **完整权限**：在管辖范围内拥有最高操作权限，可增改停删
  - **查看权限**：仅能查看管辖范围内数据\n- **司机账号**：基础操作权限，只能查看个人相关信息
\n#### 2.1.2 租户有效期管理
- **到期检测**：系统自动检测租户有效期
- **自动停用**：租户到期的第二天自动停用所有相关账号
- **重新启用**：需在管理端手动重新启用
- **司机例外**：司机账号不受租户到期影响，可正常登录

#### 2.1.3 老板账号管理
- **平级账号管理**：老板账号可创建和平级账号共享相同权限
- **平级账号限制**：每个老板最多可创建3个平级账号
- **管理权限**：老板可查看、修改、停用、删除平级账号
- **数据共享**：平级账号使用老板账号的同一数据库环境

#### 2.1.4 车队长账号权限管理
- **管理范围限制**：车队长只能管理其管辖范围内的『司机』账号
- **权限开关**：用户信息修改权限开关
  - **开启时**：车队长可以对其管辖的司机账号执行查看、增加、修改、停用操作
  - **关闭时**：车队长仅能查看司机信息，无权进行任何修改
- **操作记录**：系统记录车队长的所有操作日志

#### 2.1.5 新用户创建与仓库分配规则
- **仓库分配必填**：在创建司机或管理员账户时，「仓库分配」为必填步骤
- **强制仓库选择**：系统强制要求为新账户选择至少一个可访问的仓库
- **无仓库阻止创建**：如果未分配任何仓库，系统阻止账户创建并给出明确提示

### 2.2 车辆管理功能
- **车辆信息管理**：车辆基本信息录入和查询
- **车辆状态监控**：车辆使用状态跟踪
- **车辆分配管理**：司机与车辆匹配管理
\n### 2.3 司机管理功能
- **司机档案管理**：司机个人信息录入和管理
- **司机状态管理**：出勤状态和工作排班
- **绩效查看**：司机工作效率统计\n\n### 2.4 数据统计功能
- **关键数据统计**：出勤人数、总件数、完成件数等统计
- **车辆使用率统计**：车辆使用情况分析
- **司机工作效率统计**：司机绩效数据展示

### 2.5 通知管理功能
- **通知发送机制**：基于业务操作自动触发通知
- **接收对象管理**：根据不同角色和业务场景确定通知接收人
- **通知内容模板**：包含操作类型、操作对象、执行者和时间戳等上下文信息
- **通知记录管理**：记录所有已发送的通知日志

### 2.6 仓库管理功能
- **仓库信息管理**：仓库基本信息录入和查询\n- **仓库状态管理**：仓库使用状态跟踪\n- **仓库分配管理**：司机与仓库匹配管理
- **仓库统计分析**：仓库相关数据统计
\n#### 2.6.1 仓库自动创建规则
- **新租户默认仓库**：通过自动部署流程成功添加新租户后，系统自动在该租户下创建一个预设的「默认仓库」
- **初始仓库状态**：默认仓库包含必要初始信息，处于可用状态且可修改
\n#### 2.6.2 仓库删除限制规则
- **租户内操作限制**：老板或其授予同等权限的管理员在删除仓库时，系统进行校验\n- **最少仓库保留**：禁止删除操作导致该租户下剩余可用仓库数量少于1个
- **超级管理员特权**：此限制不适用于超级管理员\n
### 2.7 中央管理系统功能
- **租户自动化开通**：支持管理员一键创建新租户并自动完成独立数据库创建
- **动态参数管理**：为每个租户提供独立的配置管理界面
- **租户配置查询**：支持查询和管理各租户的配置信息\n- **初始管理员账号**：中央管理系统预置管理员账号admin，密码hye19911206
- **租户初始化**：系统启动时删除所有现有租户，基于中央管理系统重新构建租户体系
- **前端页面开发**：开发中央管理系统前端页面（租户列表页、创建租户页）
- **后端 API 开发**：开发支持中央管理系统功能的后端 API\n
#### 2.7.1 超级管理员权限范围
- **管理对象限定**：超级管理员仅管理租户（老板账号），无权管理老板账号的下属（平级账号、车队长、司机等）
- **租户删除权限**：超级管理员执行删除整个老板账号（租户）时不受任何限制
- **关联数据处理**：执行删除租户操作时，系统关联删除该老板账号下的所有数据（包括但不限于仓库、子账户等），或按预定策略进行数据归档
\n### 2.8 Supabase用户管理
- **用户创建**：为系统创建5个Supabase（免费版）用户账户
- **用户信息**：\n  - 用户1：张伟，管理员角色\n  - 用户2：李华，开发者角色
  - 用户3：王明，数据分析师角色
  - 用户4：赵雷，测试工程师角色
  - 用户5：陈丹，技术支持角色
- **权限配置**：根据各自角色分配相应的Supabase访问权限
- **账户管理**：在Supabase控制台中完成用户创建和配置

## 3. 系统逻辑流程

### 3.1 小程序登录流程
1. 用户打开小程序\n2. 进入登录页面
3. 输入账号和密码
4. 系统验证账号有效性
5. 验证密码正确性
6. 检查用户角色\n7. 自动识别当前用户归属的独立数据库实例
8. 检测租户有效期状态
9. 根据账号类型显示不同到期提示
10. 跳转到对应管理首页

### 3.2 仪表盘访问流程
1. 用户登录成功后自动跳转到仪表盘
2. 系统基于当前用户归属的独立数据库显示数据
3. 显示对应租户的关键数据概览
4. 支持数据详情查看
\n### 3.3 车队长权限管理流程
1. 车队长登录系统后自动进入管理界面
2. 系统识别车队长的管理范围和权限级别
3. 根据权限开关状态决定车队长的操作权限\n4. 所有操作均记录详细日志
\n### 3.4 平级账号管理流程\n1. 老板登录系统后可进入账号管理界面
2. 老板可创建新的平级账号（最多3个）
3. 平级账号与老板账号共享同一独立数据库实例
4. 老板可管理所有平级账号的状态和权限
\n### 3.5 租户到期处理流程
1. 系统自动检测租户有效期
2. 租户到期后第二天自动停用所有相关账号
3. 老板账号登录时显示「您的账号已过期，请续费使用」\n4. 平级账号和车队长账号登录时显示「您的账号已过期，请联系老板续费使用」
5. 司机账号不受影响，可正常登录系统
6. 管理端可手动重新启用已停用的租户账号

### 3.6 数据查询权限流程
1. 系统识别当前登录用户的角色
2. 根据角色确定可访问的数据范围
3. 所有查询均基于用户归属的独立数据库实例
4. 司机账号仅能查询个人相关信息，不能查看其他司机信息
5. 车队长账号可查询管辖范围内的司机数据
6. 老板和平级账号可查询所有数据

### 3.7 通知触发流程
\n#### 3.7.1 司机操作通知
- **触发场景**：司机提交请假申请、离职申请、车辆信息审核申请、实名认证审核申请\n- **通知接收对象**：\n  - 老板\n  - 所有平级账号
  - 该司机所属管辖权区域的车队长（若存在）
- **通知内容**：申请类型、申请人信息、申请详情、申请时间
\n#### 3.7.2 车队长操作通知
- **触发场景**：\n  - 增加司机账号
  - 修改司机信息（分配仓库、修改类型）
  - 停用司机账号
  - 删除司机账号（如果被授权）
  - 任何审核操作（通过/驳回）
- **通知接收对象**：\n  - 老板
  - 所有平级账号
  - 被操作的司机本人
- **通知内容**：操作类型、操作对象、操作详情、操作时间

#### 3.7.3 老板操作通知
- **触发场景**：\n  - 调整车队长的管辖仓库范围
  - 调整司机分配\n  - 调整司机类型\n  - 审批请假、离职或车辆申请
  - 任何审核操作（通过/驳回）\n- **通知接收对象**：
  - 相关操作所涉及管辖权区域内的所有车队长
  - 被操作的司机本人（如操作涉及具体司机）
- **通知内容**：操作类型、操作对象、操作详情、操作时间

#### 3.7.4 平级账号操作通知\n- **触发场景**：与老板相同的操作范围\n- **通知接收对象**：
  - 相关操作所涉及管辖权区域内的所有车队长
  - 被操作的司机本人（如操作涉及具体司机）
  - 老板
- **通知内容**：操作类型、操作对象、操作详情、操作时间

### 3.8 仓库管理流程
\n#### 3.8.1 仓库自动创建流程
- **新租户部署**：通过自动部署流程成功添加新租户后\n- **默认仓库创建**：系统自动为该租户创建预设的「默认仓库」
- **仓库初始化**：包含必要初始信息，设置为可用状态，支持修改
\n#### 3.8.2 仓库删除校验流程
- **操作发起**：老板或同等权限管理员尝试删除仓库\n- **数量检查**：系统自动检查该租户下剩余可用仓库数量
- **删除限制**：确保删除后至少保留1个可用仓库
- **异常处理**：如果删除会导致仓库数量不足，系统阻止操作并给出提示
- **超级管理员例外**：超级管理员不受此限制

#### 3.8.3 用户创建仓库分配流程
- **创建新用户**：在创建司机或管理员账户时\n- **仓库选择**：系统强制要求选择至少一个可访问的仓库
- **验证机制**：未分配仓库时阻止账户创建并显示明确提示
- **分配记录**：记录用户与仓库的关联关系

### 3.9 中央管理系统流程\n- **租户自动化开通**：管理员点击创建按钮后\n  - 系统自动为租户创建独立数据库实例
  - 执行数据库初始化脚本创建基础表结构
  - 初始化标准权限与角色体系（老板、平级、管理员、普通用户）
- **动态参数管理**：为每个租户提供独立的配置管理界面
  - 动态控制数据库内功能模块所需数据表的创建、启用或禁用
  - 支持灵活配置各项功能参数
- **初始配置**：系统启动时删除所有现有租户，创建中央管理系统管理员账号admin，密码hye19911206\n- **前端页面开发**：开发租户列表页和创建租户页的前端界面
- **后端 API 开发**：开发支持租户管理、数据库创建、配置管理的后端 API

#### 3.9.1 超级管理员特权流程
- **管理范围明确**：超级管理员仅对租户（老板账号）层面进行管理，不涉及老板下属账号的管理
- **租户删除操作**：超级管理员执行删除老板账号（租户）操作时\n- **数据清理**：系统自动删除该老板账号下的所有相关数据\n  - 包括仓库、子账户、车辆、司机等所有关联信息
  - 或按预定策略进行数据归档处理
- **操作确认**：提供安全校验机制确保操作意图明确

### 3.10 Supabase用户创建流程
- **用户创建步骤**：
  - 访问Supabase控制台
  - 依次创建5个用户账户
  - 分配对应的角色和权限
  - 记录用户信息和权限配置
- **用户管理**：在Supabase中统一管理这5个用户账户
- **权限同步**：确保用户权限与系统角色匹配

## 4. 用户界面布局

### 4.1 登录页面布局
- **账号输入框**：支持邮箱或手机号登录
- **密码输入框**\n- **登录按钮**
- **注册入口**
- **到期提示区域**：显示不同的过期提示信息
\n### 4.2 仪表盘界面布局
- **顶部导航栏**：包含用户信息和基础菜单
- **数据看板区域**：关键指标卡片展示
- **统计图表区**：基础图表展示
\n### 4.3 车辆管理界面\n- **车辆列表**：显示车辆基本信息
- **筛选功能**\n- **详情页面**：查看车辆完整档案\n\n### 4.4 司机管理界面
- **司机列表**：显示司机基本信息\n- **筛选功能**
- **详情页面**：查看司机完整档案

### 4.5 仓库管理界面
- **仓库列表**：显示仓库基本信息
- **筛选功能**
- **详情页面**：查看仓库完整档案\n- **删除确认弹窗**：包含仓库删除限制规则提示

### 4.6 权限管理界面
- **权限配置页面**：参考用户提供的image.png\n- **仓库分配功能**：为管理员分配管理的仓库
- **功能权限设置**：配置用户信息修改权等功能操作权限
- **保存配置按钮**：蓝色主色调按钮\n
### 4.7 用户信息页面
- **用户基本信息**：显示姓名、实名状态、角色等\n- **账号信息**：显示登录账号\n- **管理功能按钮**：仓库分配、权限管理等操作入口
- **箭头指示**：突出重要操作区域
- **参考界面**：参考用户提供的image-2.png

### 4.8 账号管理界面
- **账号列表**：显示所有平级账号的信息
- **创建账号**：老板可创建新的平级账号（限制3个）
- **账号操作**：查看、修改、停用、删除平级账号
- **权限显示**：标识哪些账号是平级关系
- **到期状态显示**：标识账号是否因租户到期被停用
- **重新启用功能**：管理端可手动重新启用已停用的账号
\n### 4.9 登录状态提示
- **老板账号到期提示**：「您的账号已过期，请续费使用」
- **平级账号到期提示**：「您的账号已过期，请联系老板续费使用」\n- **车队长账号到期提示**：「您的账号已过期，请联系老板续费使用」
- **提示显示位置**：登录页面中央显眼位置

### 4.10 通知管理界面
- **通知列表**：显示已发送的通知记录
- **通知详情**：查看具体的通知内容和接收对象
- **通知统计**：按时间段统计通知数量
- **通知设置**：配置通知接收偏好\n\n### 4.11 中央管理系统界面\n- **租户管理页面**：\n  - **租户列表页**：显示所有租户的基本信息和状态
  - **创建租户页**：填写公司名称、联系人、联系电话、联系邮箱、租期设置、老板账号信息（参考image.png中的创建租户表单）
- **租户详情页面**：显示租户的详细信息和配置
- **租户操作按钮**：编辑租户、停用、删除\n- **测试账号快速登录**：参考Screenshot_20251128_184123.jpg提供的测试账号快速登录功能
\n## 5. 参考界面图片
- **权限配置界面参考**：image.png
- **用户信息页面参考**：image-2.png
- **创建租户表单参考**：image.png（创建新租户表单设计）
- **老板账号信息表单参考**：image.png（老板账号信息表单设计）
- **品类列表参考**：image.png\n- **请假申请参考**：Screenshot_20251128_140555.jpg
- **创建失败提示参考**：Screenshot_20251128_144708.jpg和Screenshot_20251128_145453.jpg
- **测试账号快速登录参考**：Screenshot_20251128_184123.jpg
- **租户管理界面参考**：Screenshot_20251128_184041.jpg
- **开发测试快速登录参考**：Screenshot_20251128_190123.jpg
- **登录页面参考**：image.png