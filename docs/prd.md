# 车队管家小程序管理系统需求文档

## 1. 系统概述

### 1.1 系统名称
车队管家小程序管理系统

### 1.2 系统描述
专为车队管理打造的微信小程序管理系统，提供基础的车队运营管理和数据统计功能，支持便捷的移动管理和操作。升级版系统采用增强型多租户架构，为不同老板客户提供完全独立的数据库或数据表环境，确保数据彻底隔离。租赁系统作为独立管理端，专门用于管理租用车队管理小程序的租赁业务。每个老板支持创建多个平级账号，所有平级账号需绑定主号ID，实现灵活的账号管理。

### 1.3 项目目标
快速开发一个可登录的车队管理小程序，实现基础的车辆、司机管理和数据统计功能，并基于增强型多租户架构确保数据完全隔离。新增租赁系统管理端，专门用于租赁业务的管理功能，为每个老板分配独立数据库或数据表，支持每个老板创建多个平级账号并绑定主号ID。\n
## 2. 核心功能模块
\n### 2.1 用户管理功能
- **用户登录**：账号密码登录验证
- **用户注册**：基础用户信息注册
- **用户信息管理**：个人信息编辑和更新
- **角色管理**：管理员、司机、车队长、老板、租赁老板等角色分配
- **租赁端登录**：15766121960为租赁端终极登陆账号，必须通过验证码方式进行登录验证
\n### 2.2 车辆管理功能
- **车辆信息管理**：车辆基本信息录入和查询
- **车辆状态监控**：车辆使用状态跟踪\n- **车辆分配管理**：司机与车辆匹配管理
\n### 2.3 司机管理功能
- **司机档案管理**：司机个人信息录入和管理
- **司机状态管理**：出勤状态和工作排班\n- **绩效查看**：司机工作效率统计

### 2.4 数据统计功能
- **关键数据统计**：出勤人数、总件数、完成件数等统计
- **车辆使用率统计**：车辆使用情况分析
- **司机工作效率统计**：司机绩效数据展示

### 2.5 租赁系统管理功能
租赁系统是一个管理租用车队管理小程序的独立管理端，提供以下功能：
\n#### 2.5.1 租赁系统用户管理
- **创建租赁系统用户**：新增租赁系统的管理用户
- **查看所有租赁系统用户**：列表展示所有租赁系统用户信息
- **编辑租赁系统用户信息**：修改租赁系统用户的基本信息和权限
\n#### 2.5.2 租赁核销功能
- **核销操作**：对租赁业务进行核销处理
- **核销记录查询**：查看历史核销记录
\n#### 2.5.3 老板账号管理
每个老板账号视为单独的租赁用户，仅需管理老板账号，不需要查看每个老板下面的所有用户。
- **新增老板账号**：创建新的老板账号，自动为该老板创建独立的数据库和数据表
- **修改老板账号**：编辑老板账号的基本信息\n- **停用老板账号**：暂时停用老板账号的使用权限
- **删除老板账号**：永久删除老板账号及相关数据库和数据表
- **老板账号列表**：查看所有老板账号的基本信息和状态

#### 2.5.4 平级账号管理（新增）
每个老板可以创建多个平级账号，所有平级账号需要绑定主号ID，确保账号归属清晰。
- **创建平级账号**：为指定老板创建新的平级账号，自动绑定该老板的主号ID
- **查看平级账号列表**：展示某个老板下所有平级账号的信息，包括账号名称、绑定的主号ID、创建时间等
- **编辑平级账号**：修改平级账号的基本信息（保持主号ID绑定不变）
- **删除平级账号**：删除指定的平级账号\n- **主号ID绑定验证**：确保每个平级账号必须绑定有效的主号ID，防止孤立账号存在

## 3. 系统逻辑流程

### 3.1 小程序登录流程
1. 用户打开小程序\n2. 进入登录页面
3. 输入账号和密码
4. 系统验证账号有效性
5. 验证密码正确性
6. 检查用户角色\n7. 自动获取当前用户ID作为租户标识
8. 跳转到对应管理首页

### 3.2 租赁端登录特殊流程
1. 用户使用15766121960账号登录
2. 系统强制要求进行验证码验证
3. 验证通过后自动识别为租赁端角色
4. 跳转到租赁系统管理首页

### 3.3 仪表盘访问流程
1. 用户登录成功后自动跳转到仪表盘
2. 系统基于当前用户ID过滤数据
3. 显示对应租户的关键数据概览
4. 支持数据详情查看

### 3.4 租赁系统管理流程
1. 租赁端管理员登录后进入租赁系统管理首页
2. 可选择进入租赁系统用户管理、核销功能或老板账号管理
3. 执行相应的创建、查看、编辑、停用、删除等操作
4. 系统记录操作日志并更新数据状态

### 3.5 平级账号管理流程（新增）
1. 租赁端管理员进入老板账号管理页面\n2. 选择某个老板账号，进入平级账号管理界面\n3. 点击〖创建平级账号〗按钮
4. 输入平级账号信息（账号名称、密码等），系统自动绑定该老板的主号ID
5. 保存后，新平级账号出现在平级账号列表中
6. 支持对平级账号进行编辑或删除操作
7. 系统验证所有平级账号均已正确绑定主号ID\n
## 4. 用户界面布局

### 4.1 登录页面布局
- **账号输入框**：支持邮箱或手机号登录
- **密码输入框**\n- **验证码输入框**（租赁端专用）
- **登录按钮**
- **注册入口**
\n### 4.2 仪表盘界面布局
- **顶部导航栏**：包含用户信息和基础菜单
- **数据看板区域**：关键指标卡片展示
- **统计图表区**：基础图表展示
\n### 4.3 车辆管理界面\n- **车辆列表**：显示车辆基本信息
- **筛选功能**\n- **详情页面**：查看车辆完整档案
\n### 4.4 司机管理界面
- **司机列表**：显示司机基本信息
- **筛选功能**
- **详情页面**：查看司机完整档案

### 4.5 租赁系统管理界面
\n#### 4.5.1 租赁系统用户管理界面
- **用户列表**：显示所有租赁系统用户的基本信息
- **创建用户按钮**：新增租赁系统用户入口
- **编辑功能**：点击用户可进入编辑页面
- **搜索筛选**：支持按用户名、角色等条件筛选
\n#### 4.5.2 租赁核销界面
- **核销操作区**：输入核销信息并提交
- **核销记录列表**：展示历史核销记录\n- **筛选功能**：按时间、状态等条件筛选核销记录

#### 4.5.3 老板账号管理界面\n- **老板账号列表**：显示所有老板账号的基本信息和状态（正常/停用）
- **新增按钮**：创建新的老板账号，自动创建独立数据库和数据表
- **操作菜单**：每个老板账号提供修改、停用、删除操作入口
- **平级账号管理入口**：点击某个老板账号可进入平级账号管理页面
- **搜索筛选**：支持按账号名称、状态等条件筛选\n
#### 4.5.4 平级账号管理界面（新增）
- **平级账号列表**：显示当前老板下所有平级账号的信息，包括账号名称、绑定的主号ID、创建时间等
- **创建平级账号按钮**：新增平级账号入口\n- **编辑功能**：点击平级账号可进入编辑页面
- **删除功能**：支持删除指定的平级账号
- **主号ID显示**：界面顶部或侧栏明确显示当前老板的主号ID
- **搜索筛选**：支持按账号名称、创建时间等条件筛选

## 5. 安全配置要求

### 5.1 用户认证\n- **登录机制**：基于用户名密码的用户认证
- **密码安全**：密码加密存储
- **登录失败处理**：登录失败次数限制
- **验证码验证**：租赁端强制要求验证码验证

### 5.2 权限校验
- **角色权限**：基于角色的权限控制
- **功能授权**：粗粒度的功能访问控制
- **租赁端权限**：15766121960账号拥有最高租赁管理权限
- **平级账号权限**：平级账号仅能访问绑定主号ID对应老板的数据，无法跨老板访问

### 5.3 增强型多租户安全隔离
- **独立数据库/数据表**：为每个老板创建独立的数据库和数据表
- **数据完全隔离**：确保老板间数据彻底隔离，无任何交叉访问
- **多层次隔离机制**：在数据库层、应用层实现多重数据隔离防护
- **平级账号数据隔离**：所有平级账号共享绑定主号ID的数据环境，但不能访问其他老板的数据

## 6. 增强型多租户架构设计

### 6.1 核心目标
为每个老板客户提供完全独立的数据库和数据表环境，确保所有租户数据在存储和访问时实现彻底隔离，防止数据泄露和越权访问。支持每个老板创建多个平级账号，所有平级账号共享主号ID的数据环境。

### 6.2 数据隔离策略
采用独立数据库和数据表的物理隔离机制，在数据库层面为每个老板的数据建立完全独立的存储空间。平级账号通过主号ID绑定实现数据共享，但仅限于同一老板账号下。

### 6.3 实现层面要求
- **独立数据库/数据表**：为每个老板创建独立的数据库和数据表
- **数据完全隔离**：确保老板间数据无任何共享和交叉\n- **租户上下文管理**：在应用层实现老板级租户上下文管理机制
- **请求识别**：确保在每次请求中能正确识别并提供当前请求的老板标识
- **平级账号绑定**：所有平级账号必须绑定主号ID，系统根据主号ID确定数据访问权限

### 6.4 技术实现步骤
\n#### 6.4.1 租户上下文管理
-在应用启动时初始化老板级租户上下文管理模块
- 基于用户登录信息自动加载当前老板标识
- 为每个HTTP请求绑定老板租户上下文信息
- 实现在不同中间件间传递老板ID\n- 平级账号登录时，自动获取绑定的主号ID并加载对应租户上下文

#### 6.4.2 数据访问层改造
- 为每个老板创建独立的数据库和数据表
- 修改数据库查询模板，自动适应不同老板的数据存储结构
- 实现数据访问的默认安全策略
- 测试数据隔离的有效性
- 确保平级账号只能访问绑定主号ID的数据表

#### 6.4.3 安全验证增强
- 在控制器层验证数据归属\n- 实施细粒度的权限检查
- 监控并阻止潜在的越权访问尝试
- 定期审计数据访问日志
- 验证平级账号的主号ID绑定有效性，防止孤立账号或越权访问

#### 6.4.4 租户数据迁移
- 设计老板级数据初始化流程
- 实现数据导入导出功能
- 确保数据迁移过程中的完整性
\n#### 6.4.5 平级账号绑定机制（新增）
- 在创建平级账号时，强制要求输入主号ID
- 系统验证主号ID的有效性
- 将平级账号与主号ID建立持久化绑定关系
- 平级账号登录后，自动加载主号ID对应的数据环境

### 6.5 关键技术点

#### 6.5.1 全局老板ID管理
- 请求拦截器自动提取老板ID
- 中央服务提供老板信息\n- 跨服务老板上下文传播
- 平级账号登录时，自动映射到主号ID

#### 6.5.2 数据库查询增强
- 自动适配不同老板的数据存储结构
- 支持批量操作的安全性
- 查询性能优化策略
- 平级账号查询时，自动过滤为主号ID的数据

#### 6.5.3 安全防护机制
- 老板间数据隔离验证
- 异常访问日志记录
- 定期安全扫描
- 平级账号跨主号访问拦截
\n## 7. 系统部署要求

### 7.1 多租户环境配置
- **独立数据库实例**：为每个老板创建独立的数据库实例
- **独立数据表架构**：普通租户采用独立数据表方案
- **配置管理**：统一管理不同老板的环境参数
- **平级账号配置**：记录平级账号与主号ID的绑定关系

### 7.2 性能优化\n- **缓存策略**：基于老板ID的缓存分区\n- **索引优化**：针对老板数据表建立高效索引
- **查询优化**：减少不必要的数据扫描
\n### 7.3 监控与运维
- **老板用量统计**：监控各老板资源使用情况
- **告警系统**：异常访问和性能问题实时通知
- **备份恢复**：定期数据备份和快速恢复机制
- **平级账号审计**：记录平级账号的创建、修改、删除操作日志

## 8. 小程序特性

### 8.1 微信生态集成
- **消息推送**：支持微信消息通知
- **小程序分享**：支持好友分享和群分享
- **收藏功能**：支持小程序收藏\n\n### 8.2 移动端优化
- **适配屏幕**：支持多种手机屏幕尺寸\n- **手势操作**：优化滑动和点击体验
- **下拉刷新**：列表页面支持下拉刷新
\n## 9. 设计风格\n
### 9.1 配色方案
- **主色调**：蓝色系渐变（#1890ff到#4a90e2）
- **强调色**：橙色（#ff7a45）
- **背景色**：浅灰色（#f5f5f5）
\n### 9.2 视觉细节
- **圆角设计**：统一使用4px圆角
- **卡片阴影**：轻微阴影效果
- **图标风格**：线性图标配合填充图标

### 9.3 整体布局
- **布局方式**：卡片式布局
- **导航结构**：底部标签栏导航
- **数据展示**：表格和卡片形式\n
## 10. 参考界面

### 10.1 司机工作台界面
使用用户提供的图片image.png作为司机工作台界面参考

### 10.2 数据仪表盘界面
使用用户提供的图片image.png作为数据仪表盘界面参考

### 10.3 管理员信息界面
使用用户提供的图片image.png作为管理员信息界面参考

### 10.4 用户管理界面
使用用户提供的图片image.png作为用户管理界面参考

### 10.5 技术调试界面
使用用户提供的图片image.png作为技术调试界面参考

### 10.6 错误页面界面
使用用户提供的图片image.png作为错误页面界面参考

### 10.7 通知中心界面
使用用户提供的图片image.png作为通知中心界面参考

### 10.8 租赁系统管理界面
使用用户提供的图片image.png作为租赁系统管理界面参考

### 10.9 平级账号管理界面（新增）
使用用户提供的图片image.png作为平级账号管理界面参考