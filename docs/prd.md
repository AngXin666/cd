# 车队管家小程序管理系统需求文档

## 1. 系统概述

### 1.1 系统名称\n车队管家小程序管理系统

### 1.2 系统描述
专为车队管理打造的微信小程序管理系统，采用物理隔离的独立数据库模式为每个老板提供完全隔离的数据环境，支持车辆、司机管理和数据统计功能。

### 1.3 项目目标
快速开发一个可登录的车队管理小程序，实现基础的车辆、司机管理和数据统计功能，基于物理隔离的独立数据库模式确保数据完全隔离，并优化数据库结构和查询逻辑，完善账号权限管理和通知系统。

## 2. 核心功能模块

### 2.1 用户管理功能
- **用户登录**：账号密码登录验证
- **用户注册**：基础用户信息注册
- **用户信息管理**：个人信息编辑和更新
- **角色管理**：管理员、司机、车队长、老板等角色分配

#### 2.1.1 账号角色定义
- **老板账号**：最高管理权限，可访问所有数据
- **平级账号**：与老板权限相同，共享老板数据库
- **车队长账号**：管理权限受限于管辖范围
- **司机账号**：基础操作权限，只能查看个人相关信息

#### 2.1.2 租户有效期管理
- **到期检测**：系统自动检测租户有效期
- **自动停用**：租户到期的第二天自动停用所有相关账号
- **重新启用**：需在管理端手动重新启用
- **司机例外**：司机账号不受租户到期影响，可正常登录

#### 2.1.3 老板账号管理
- **平级账号管理**：老板账号可创建和平级账号共享相同权限
- **平级账号限制**：每个老板最多可创建3个平级账号
- **管理权限**：老板可查看、修改、停用、删除平级账号
- **数据共享**：平级账号使用老板账号的同一数据库环境

#### 2.1.4 车队长账号权限管理
- **管理范围限制**：车队长只能管理其管辖范围内的『司机』账号
- **权限开关**：用户信息修改权限开关
  - **开启时**：车队长可以对其管辖的司机账号执行查看、增加、修改、停用操作
  - **关闭时**：车队长仅能查看司机信息，无权进行任何修改
- **操作记录**：系统记录车队长的所有操作日志

### 2.2 车辆管理功能
- **车辆信息管理**：车辆基本信息录入和查询
- **车辆状态监控**：车辆使用状态跟踪
- **车辆分配管理**：司机与车辆匹配管理

### 2.3 司机管理功能
- **司机档案管理**：司机个人信息录入和管理
- **司机状态管理**：出勤状态和工作排班
- **绩效查看**：司机工作效率统计

### 2.4 数据统计功能
- **关键数据统计**：出勤人数、总件数、完成件数等统计
- **车辆使用率统计**：车辆使用情况分析
- **司机工作效率统计**：司机绩效数据展示

### 2.5 通知管理功能
- **通知发送机制**：基于业务操作自动触发通知
- **接收对象管理**：根据不同角色和业务场景确定通知接收人
- **通知内容模板**：包含操作类型、操作对象、执行者和时间戳等上下文信息
- **通知记录管理**：记录所有已发送的通知日志

## 3. 系统逻辑流程

### 3.1 小程序登录流程
1. 用户打开小程序
2. 进入登录页面
3. 输入账号和密码
4. 系统验证账号有效性
5. 验证密码正确性
6. 检查用户角色
7. 自动识别当前用户归属的独立数据库项目
8. 检测租户有效期状态
9. 根据账号类型显示不同到期提示
10. 跳转到对应管理首页

### 3.2 仪表盘访问流程
1. 用户登录成功后自动跳转到仪表盘
2. 系统基于当前用户归属的独立数据库显示数据
3. 显示对应租户的关键数据概览
4. 支持数据详情查看

### 3.3 车队长权限管理流程
1. 车队长登录系统后自动进入管理界面
2. 系统识别车队长的管理范围和权限级别
3. 根据权限开关状态决定车队长的操作权限
4. 所有操作均记录详细日志

### 3.4 平级账号管理流程
1. 老板登录系统后可进入账号管理界面
2. 老板可创建新的平级账号（最多3个）
3. 平级账号与老板账号共享同一独立数据库项目
4. 老板可管理所有平级账号的状态和权限

### 3.5 租户到期处理流程
1. 系统自动检测租户有效期
2. 租户到期后第二天自动停用所有相关账号
3. 老板账号登录时显示「您的账号已过期，请续费使用」
4. 平级账号和车队长账号登录时显示「您的账号已过期，请联系老板续费使用」
5. 司机账号不受影响，可正常登录系统
6. 管理端可手动重新启用已停用的租户账号

### 3.6 数据查询权限流程
1. 系统识别当前登录用户的角色
2. 根据角色确定可访问的数据范围
3. 所有查询均基于用户归属的独立数据库项目
4. 司机账号仅能查询个人相关信息，不能查看其他司机信息
5. 车队长账号可查询管辖范围内的司机数据
6. 老板和平级账号可查询所有数据

### 3.7 通知触发流程

#### 3.7.1 司机操作通知
- **触发场景**：司机提交请假申请、离职申请、车辆信息审核申请、实名认证审核申请
- **通知接收对象**：
  - 老板
  - 所有平级账号
  - 该司机所属管辖权区域的车队长（若存在）
- **通知内容**：申请类型、申请人信息、申请详情、申请时间

#### 3.7.2 车队长操作通知
- **触发场景**：
  - 增加司机账号
  - 修改司机信息（分配仓库、修改类型）
  - 停用司机账号
  - 删除司机账号（如果被授权）
  - 任何审核操作（通过/驳回）
- **通知接收对象**：
  - 老板
  - 所有平级账号\n  - 被操作的司机本人
- **通知内容**：操作类型、操作对象、操作详情、操作时间

#### 3.7.3 老板操作通知
- **触发场景**：
  - 调整车队长的管辖仓库范围
  - 调整司机分配
  - 调整司机类型
  - 审批请假、离职或车辆申请
  - 任何审核操作（通过/驳回）
- **通知接收对象**：
  - 相关操作所涉及管辖权区域内的所有车队长
  - 被操作的司机本人（如操作涉及具体司机）
- **通知内容**：操作类型、操作对象、操作详情、操作时间\n
#### 3.7.4 平级账号操作通知
- **触发场景**：与老板相同的操作范围
- **通知接收对象**：
  - 相关操作所涉及管辖权区域内的所有车队长
  - 被操作的司机本人（如操作涉及具体司机）
  - 老板
- **通知内容**：操作类型、操作对象、操作详情、操作时间

## 4. 用户界面布局

### 4.1 登录页面布局
- **账号输入框**：支持邮箱或手机号登录
- **密码输入框**
- **登录按钮**
- **注册入口**
- **到期提示区域**：显示不同的过期提示信息

### 4.2 仪表盘界面布局
- **顶部导航栏**：包含用户信息和基础菜单
- **数据看板区域**：关键指标卡片展示
- **统计图表区**：基础图表展示

### 4.3 车辆管理界面
- **车辆列表**：显示车辆基本信息
- **筛选功能**
- **详情页面**：查看车辆完整档案

### 4.4 司机管理界面
- **司机列表**：显示司机基本信息
- **筛选功能**
- **详情页面**：查看司机完整档案

### 4.5 权限管理界面
- **权限配置页面**：参考用户提供的image.png
- **仓库分配功能**：为管理员分配管理的仓库
- **功能权限设置**：配置用户信息修改权等功能操作权限
- **保存配置按钮**：蓝色主色调按钮

### 4.6 用户信息页面
- **用户基本信息**：显示姓名、实名状态、角色等
- **账号信息**：显示登录账号
- **管理功能按钮**：仓库分配、权限管理等操作入口
- **箭头指示**：突出重要操作区域
- **参考界面**：参考用户提供的image-2.png

### 4.7 账号管理界面
- **账号列表**：显示所有平级账号的信息
- **创建账号**：老板可创建新的平级账号（限制3个）
- **账号操作**：查看、修改、停用、删除平级账号
- **权限显示**：标识哪些账号是平级关系
- **到期状态显示**：标识账号是否因租户到期被停用
- **重新启用功能**：管理端可手动重新启用已停用的账号

### 4.8 登录状态提示
- **老板账号到期提示**：「您的账号已过期，请续费使用」
- **平级账号到期提示**：「您的账号已过期，请联系老板续费使用」
- **车队长账号到期提示**：「您的账号已过期，请联系老板续费使用」
- **提示显示位置**：登录页面中央显眼位置

### 4.9 通知管理界面
- **通知列表**：显示已发送的通知记录
- **通知详情**：查看具体的通知内容和接收对象
- **通知统计**：按时间段统计通知数量
- **通知设置**：配置通知接收偏好

## 5. 优化数据库架构设计

### 5.1 物理隔离架构
采用物理隔离的独立数据库模式，为每个老板创建独立的Supabase项目和数据库：
- 老板A → Supabase项目A → 数据库A
- 老板B → Supabase项目B → 数据库B
- 老板C → Supabase项目C → 数据库C

### 5.2 数据库架构优化
- **删除boss_id字段**：移除所有表中的boss_id字段
- **重构表结构**：优化表关系和数据模型适配独立数据库
- **数据安全性**：确保跨数据库隔离，防止数据泄露
- **查询优化**：针对独立数据库场景优化查询性能

### 5.3 角色权限映射
- **老板账号**：full_access_role
- **平级账号**：peer_access_role
- **车队长账号**：supervisor_access_role
- **司机账号**：driver_access_role

### 5.4 数据访问权限控制
- **老板和平级账号**：拥有完整数据库查询权限
- **车队长账号**：限定查询管辖范围内的数据
- **司机账号**：仅能查询个人相关信息
- **统一数据库上下文**：所有查询自动关联当前用户的独立数据库

### 5.5 查询逻辑优化
- **默认数据库绑定**：系统自动识别并绑定当前用户的独立数据库
- **角色权限过滤**：根据用户角色自动添加查询条件
- **简化查询语法**：开发者无需手动拼接复杂的权限条件
- **统一数据源**：所有账号查询基于各自的独立数据库

### 5.6 技术实现改进

#### 5.6.1 多数据库管理
- 实现自动化的数据库项目创建和配置
- 管理多个独立的Supabase项目实例
- 确保数据库间的完全隔离

#### 5.6.2 数据访问层重构
- 重构数据访问接口适配独立数据库模式
- 移除所有基于boss_id的RLS策略
- 优化跨数据库的操作逻辑

#### 5.6.3 缓存策略
- 实施按数据库隔离的查询结果缓存
- 优化频繁查询的响应速度
- 确保缓存数据的安全性和隔离性

#### 5.6.4 日志监控
- 记录所有数据库查询操作
- 监控查询性能和异常
- 便于问题定位和优化

## 6. 安全配置要求

### 6.1 用户认证
- **登录机制**：基于用户名密码的用户认证
- **密码安全**：密码加密存储
- **登录失败处理**：登录失败次数限制
- **账号状态验证**：登录时检查账号启用状态
- **租户有效期验证**：登录时检查独立数据库项目的有效期

### 6.2 权限校验
- **角色权限**：基于角色的权限控制
- **功能授权**：粗粒度的功能访问控制
- **车队长权限**：基于权限开关的动态权限控制
- **平级账号权限**：平级账号与老板账号权限相同
- **独立数据库权限**：确保每个用户只能访问自己归属的独立数据库
- **平级账号管理**：老板账号有权管理其创建的平级账号
- **到期权限控制**：过期账号无法登录系统
- **司机例外权限**：司机账号不受租户到期影响
- **通知权限**：基于角色配置的通知接收权限控制

### 6.3 物理数据库安全隔离
- **独立数据库项目**：为每个老板创建独立的Supabase项目
- **数据完全隔离**：确保老板间数据彻底隔离，无任何交叉访问
- **多层次隔离机制**：在数据库层、应用层实现多重数据隔离防护
- **平级账号共享**：平级账号与老板账号共享同一独立数据库项目
- **到期数据隔离**：过期租户的数据库在管理端控制下可恢复访问
- **通知数据隔离**：每个租户的通知系统独立运行和存储

### 6.4 数据访问安全控制
- **身份验证**：在每次请求中验证用户归属数据库的有效性和完整性
- **跨域保护**：防止伪造或篡改身份的跨域攻击
- **会话绑定**：将用户身份与用户会话绑定，防止会话劫持
- **审计追踪**：记录所有涉及用户数据库的操作日志
- **平级账号追踪**：单独记录平级账号的操作日志并关联到老板
- **到期访问控制**：过期账号无法建立有效会话
- **司机访问控制**：司机账号访问范围限制在司机相关功能
- **通知访问控制**：确保通知操作在正确的租户范围内执行

## 7. RLS策略重构要求

### 7.1 数据库层面变更
- **删除所有表的boss_id过滤条件**：更新所有表的RLS策略，移除boss_id相关的WHERE条件
- **基于角色权限控制**：仅保留角色相关的访问控制逻辑
- **重构前后对比**：
  - 旧策略：SELECT * FROM users WHERE boss_id = current_setting('supabase.auth.uid')::uuid AND role = 'driver'
  - 新策略：SELECT * FROM users WHERE role = 'driver'

### 7.2 前端代码更新
- **重构 src/db/api.ts**：删除所有 boss_id 相关代码
- **更新其他数据库 API 文件**：tenantQuery.ts、batchQuery.ts 等
- **更新页面组件中的 boss_id 逻辑**：全面移除前端代码中的boss_id相关逻辑
- **删除API调用中的boss_id参数**：src/db/api.ts
- **移除通知API中的boss_id逻辑**：src/db/notificationApi.ts
- **请假申请中删除boss_id相关代码**：src/pages/driver/leave/apply/index.tsx
- **其他10+个文件的boss_id清理**：全面移除前端代码中的boss_id相关逻辑

### 7.3 后端代码重构
- **API接口重构**：移除所有boss_id参数和过滤条件
- **数据库查询优化**：基于角色权限的简化查询逻辑
- **通知系统升级**：重构通知发送和接收逻辑，仅基于角色权限

## 8. 界面设计风格

### 8.1 配色方案
- 主色调：蓝色系（#1890FF），体现专业可靠
- 辅助色：绿色（#52C41A）用于成功状态，红色（#FF4D4F）用于警告或错误
- 背景色：浅灰色（#F5F5F5）营造清爽感
- 过期提示色：橙红色（#FF7875）用于到期提醒信息
- 通知提醒色：橙色（#FF8C00）用于新通知标识

###