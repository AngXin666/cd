# 仓库切换功能优化说明

## 功能概述

为双管理员端（普通管理员和超级管理员）的司机管理和用户管理页面添加了仓库切换功能，使管理员可以按仓库查看和管理司机，解决了之前无法区分不同仓库司机的问题。

## 优化内容

### 1. 普通管理员端 - 司机管理页面

**文件路径**: `src/pages/manager/driver-management/index.tsx`

**新增功能**:
- ✅ 添加仓库切换器（Swiper滑动切换，参考司机端首页风格）
- ✅ 根据选中的仓库过滤显示司机列表
- ✅ 显示每个仓库下的司机数量
- ✅ 仓库切换时自动更新司机列表

**实现细节**:
1. **状态管理**:
   - `currentWarehouseIndex`: 当前选中的仓库索引
   - `driverWarehouseMap`: 存储每个司机的仓库分配信息（Map<司机ID, 仓库ID列表>）

2. **数据加载优化**:
   - 在加载司机列表时，批量并行加载每个司机的仓库分配信息
   - 使用缓存机制，减少重复查询
   - 新增缓存键：`MANAGER_DRIVER_WAREHOUSES`

3. **过滤逻辑**:
   ```typescript
   // 仓库过滤（当有多个仓库时）
   if (warehouses.length > 1 && warehouses[currentWarehouseIndex]) {
     const currentWarehouseId = warehouses[currentWarehouseIndex].id
     result = result.filter((driver) => {
       const driverWarehouses = driverWarehouseMap.get(driver.id) || []
       return driverWarehouses.includes(currentWarehouseId)
     })
   }
   ```

4. **UI设计**:
   - 仓库切换器位于搜索框之前
   - 使用 Swiper 组件实现滑动切换
   - 显示仓库名称、当前索引、总数量和该仓库的司机数量
   - 渐变背景（from-blue-50 to-blue-100）
   - 指示点显示当前位置

### 2. 超级管理员端 - 用户管理页面

**文件路径**: `src/pages/super-admin/user-management/index.tsx`

**新增功能**:
- ✅ 在司机管理标签页添加仓库切换器
- ✅ 根据选中的仓库过滤显示司机列表
- ✅ 显示每个仓库下的司机数量
- ✅ 仓库切换时自动更新司机列表
- ✅ 管理员管理标签页不显示仓库切换器

**实现细节**:
1. **状态管理**:
   - `currentWarehouseIndex`: 当前选中的仓库索引
   - `userWarehouseIdsMap`: 存储每个用户的仓库ID列表（Map<用户ID, 仓库ID列表>）

2. **数据加载优化**:
   - 在加载用户列表时，批量并行加载每个司机的仓库分配信息
   - 使用缓存机制，减少重复查询
   - 新增缓存键：`SUPER_ADMIN_USER_WAREHOUSES`

3. **过滤逻辑**:
   ```typescript
   // 仓库过滤（仅对司机标签页生效，且有多个仓库时）
   if (activeTab === 'driver' && warehouses.length > 1 && warehouses[warehouseIndex]) {
     const currentWarehouseId = warehouses[warehouseIndex].id
     filtered = filtered.filter((u) => {
       const userWarehouseIds = userWarehouseIdsMap.get(u.id) || []
       return userWarehouseIds.includes(currentWarehouseId)
     })
   }
   ```

4. **UI设计**:
   - 仓库切换器位于搜索框之后、添加用户按钮之前
   - 仅在司机管理标签页且有多个仓库时显示
   - 使用 Swiper 组件实现滑动切换
   - 显示仓库名称、当前索引、总数量和该仓库的司机数量
   - 渐变背景（from-blue-50 to-blue-100）
   - 指示点显示当前位置

### 3. 缓存管理优化

**文件路径**: `src/utils/cache.ts`

**新增缓存键**:
- `MANAGER_DRIVER_WAREHOUSES`: 普通管理员端司机仓库分配缓存
- `SUPER_ADMIN_USER_WAREHOUSES`: 超级管理员端用户仓库分配缓存

**缓存清除优化**:
- `clearManagerDriversCache()`: 清除普通管理员端司机缓存时，同时清除仓库分配缓存
- `clearSuperAdminUsersCache()`: 清除超级管理员端用户缓存时，同时清除仓库分配缓存

## UI设计特点

### 仓库切换器样式
- **高度**: 64px (h-16)
- **背景**: 白色卡片，圆角阴影
- **内容区**: 渐变背景（from-blue-50 to-blue-100）
- **图标**: 仓库图标（i-mdi-warehouse），蓝色主题
- **文字**: 仓库名称（大号粗体），司机数量（小号灰色）
- **指示点**: 底部居中，深蓝色激活状态

### 信息显示
- **顶部标签**: 显示"选择仓库"、当前索引/总数、司机数量
- **仓库卡片**: 显示仓库名称和该仓库的司机数量

## 性能优化

1. **批量并行加载**: 使用 `Promise.all` 批量加载所有司机的仓库分配信息
2. **缓存机制**: 5分钟有效期的版本化缓存，减少重复查询
3. **按需过滤**: 只在有多个仓库时才进行仓库过滤
4. **状态管理**: 使用 Map 数据结构，提高查询效率

## 用户体验优化

1. **滑动切换**: 参考司机端首页的滑动切换风格，操作流畅自然
2. **实时反馈**: 切换仓库时立即更新司机列表
3. **数量显示**: 清晰显示每个仓库的司机数量，方便管理员了解分布情况
4. **条件显示**: 只在有多个仓库时显示切换器，避免单仓库时的冗余UI

## 技术实现要点

### 1. 数据结构
```typescript
// 司机仓库映射
const driverWarehouseMap = new Map<string, string[]>()
// 用户仓库映射
const userWarehouseIdsMap = new Map<string, string[]>()
```

### 2. 过滤函数签名变化
```typescript
// 之前
filterUsers(users, keyword, roleFilter)

// 现在
filterUsers(users, keyword, roleFilter, currentWarehouseIndex)
```

### 3. 仓库切换处理
```typescript
const handleWarehouseChange = useCallback((e: any) => {
  const index = e.detail.current
  setCurrentWarehouseIndex(index)
  // 重新过滤用户列表
  filterUsers(users, searchKeyword, roleFilter, index)
}, [warehouses, users, searchKeyword, roleFilter, filterUsers])
```

## 测试建议

### 功能测试
1. ✅ 测试仓库切换是否正常工作
2. ✅ 测试司机列表是否按仓库正确过滤
3. ✅ 测试司机数量统计是否准确
4. ✅ 测试搜索功能是否与仓库过滤兼容
5. ✅ 测试缓存机制是否正常工作

### 边界测试
1. ✅ 测试只有一个仓库时，切换器是否隐藏
2. ✅ 测试没有仓库时的显示
3. ✅ 测试司机没有分配仓库时的显示
4. ✅ 测试切换标签页时的状态保持

### 性能测试
1. ✅ 测试大量司机时的加载速度
2. ✅ 测试切换仓库时的响应速度
3. ✅ 测试缓存命中率

## 后续优化建议

1. **仓库排序**: 可以考虑按司机数量或名称排序仓库
2. **快速跳转**: 添加仓库列表快速跳转功能
3. **统计信息**: 在仓库切换器上显示更多统计信息（如在岗司机数、请假司机数等）
4. **动画优化**: 添加切换动画，提升视觉体验

## 相关文件

- `src/pages/manager/driver-management/index.tsx` - 普通管理员司机管理页面
- `src/pages/super-admin/user-management/index.tsx` - 超级管理员用户管理页面
- `src/utils/cache.ts` - 缓存管理工具
- `src/db/api.ts` - 数据库API（使用 getDriverWarehouseIds 函数）

## 更新日期

2025-11-05
