# 测试租户创建功能

## 测试目标

验证租户创建功能是否正常工作，包括：
1. 第一个租户的创建
2. 后续租户的克隆
3. 草稿自动保存功能
4. 错误处理和回滚机制

## 测试步骤

### 测试1：创建第一个租户

**目的**：验证第一个租户能否正常创建

**步骤**：
1. 登录中央管理系统
2. 进入"租户管理"页面
3. 点击"创建租户"按钮
4. 填写租户信息：
   - 公司名称：秒哒-无代码应用
   - 老板姓名：张三
   - 老板电话：13900000001
   - 登录账号：admin1
   - 登录密码：123456
   - 确认密码：123456
5. 点击"创建租户"按钮

**预期结果**：
- ✅ 显示"创建中..."加载提示
- ✅ 创建成功后显示成功提示
- ✅ 提示中包含登录账号和密码
- ✅ 自动返回租户列表页面
- ✅ 租户列表中显示新创建的租户

**实际结果**：
- [ ] 通过
- [ ] 失败（原因：_____________）

---

### 测试2：创建第二个租户（克隆测试）

**目的**：验证后续租户能否正确克隆第一个租户的架构

**步骤**：
1. 登录中央管理系统
2. 进入"租户管理"页面
3. 点击"创建租户"按钮
4. 填写租户信息：
   - 公司名称：测试公司2
   - 老板姓名：李四
   - 老板电话：13900000002
   - 登录账号：admin2
   - 登录密码：123456
   - 确认密码：123456
5. 点击"创建租户"按钮

**预期结果**：
- ✅ 显示"创建中..."加载提示
- ✅ 系统自动检测到第一个租户
- ✅ 自动克隆第一个租户的 Schema 结构
- ✅ 创建成功后显示成功提示
- ✅ 自动返回租户列表页面
- ✅ 租户列表中显示新创建的租户

**实际结果**：
- [ ] 通过
- [ ] 失败（原因：_____________）

---

### 测试3：草稿自动保存（失败场景）

**目的**：验证创建失败时草稿是否自动保存

**步骤**：
1. 登录中央管理系统
2. 进入"租户管理"页面
3. 点击"创建租户"按钮
4. 填写租户信息（使用已存在的手机号或账号，故意触发失败）
5. 点击"创建租户"按钮
6. 等待失败提示
7. 关闭提示，返回租户列表
8. 再次点击"创建租户"按钮

**预期结果**：
- ✅ 创建失败后显示错误提示
- ✅ 提示中说明"您填写的内容已自动保存为草稿"
- ✅ 再次打开页面时，自动恢复之前填写的内容
- ✅ 页面头部显示"已恢复草稿"标签
- ✅ 显示草稿提示卡片

**实际结果**：
- [ ] 通过
- [ ] 失败（原因：_____________）

---

### 测试4：草稿手动清除

**目的**：验证用户能否手动清除草稿

**步骤**：
1. 确保页面中有草稿（参考测试3）
2. 点击草稿提示卡片中的"清除草稿"按钮
3. 在确认对话框中点击"确定"

**预期结果**：
- ✅ 显示确认对话框
- ✅ 确认后草稿被清除
- ✅ 表单恢复为空白状态
- ✅ 草稿提示卡片消失
- ✅ 页面头部的"已恢复草稿"标签消失

**实际结果**：
- [ ] 通过
- [ ] 失败（原因：_____________）

---

### 测试5：取消时保留草稿

**目的**：验证取消时能否选择保留草稿

**步骤**：
1. 打开创建租户页面
2. 填写部分信息
3. 点击"取消"按钮
4. 在弹出的对话框中选择"保留"
5. 返回租户列表
6. 再次打开创建租户页面

**预期结果**：
- ✅ 点击取消后显示确认对话框
- ✅ 对话框询问是否保留草稿
- ✅ 选择"保留"后返回列表
- ✅ 再次打开页面时，自动恢复之前填写的内容

**实际结果**：
- [ ] 通过
- [ ] 失败（原因：_____________）

---

### 测试6：取消时清除草稿

**目的**：验证取消时能否选择清除草稿

**步骤**：
1. 打开创建租户页面
2. 填写部分信息
3. 点击"取消"按钮
4. 在弹出的对话框中选择"清除"
5. 返回租户列表
6. 再次打开创建租户页面

**预期结果**：
- ✅ 点击取消后显示确认对话框
- ✅ 对话框询问是否保留草稿
- ✅ 选择"清除"后返回列表
- ✅ 再次打开页面时，显示空白表单

**实际结果**：
- [ ] 通过
- [ ] 失败（原因：_____________）

---

### 测试7：创建成功后自动清除草稿

**目的**：验证创建成功后草稿是否自动清除

**步骤**：
1. 确保页面中有草稿
2. 修改信息，确保能够创建成功
3. 点击"创建租户"按钮
4. 等待创建成功
5. 返回租户列表
6. 再次打开创建租户页面

**预期结果**：
- ✅ 创建成功后显示成功提示
- ✅ 自动返回租户列表
- ✅ 再次打开页面时，显示空白表单
- ✅ 没有草稿恢复提示

**实际结果**：
- [ ] 通过
- [ ] 失败（原因：_____________）

---

## 测试结果汇总

| 测试项 | 状态 | 备注 |
|--------|------|------|
| 测试1：创建第一个租户 | ⬜ 待测试 | |
| 测试2：创建第二个租户（克隆测试） | ⬜ 待测试 | |
| 测试3：草稿自动保存（失败场景） | ⬜ 待测试 | |
| 测试4：草稿手动清除 | ⬜ 待测试 | |
| 测试5：取消时保留草稿 | ⬜ 待测试 | |
| 测试6：取消时清除草稿 | ⬜ 待测试 | |
| 测试7：创建成功后自动清除草稿 | ⬜ 待测试 | |

## 已知问题

### 问题1：V2 版本克隆失败
- **现象**：使用 `CREATE TABLE LIKE ... INCLUDING ALL` 克隆时失败
- **原因**：可能是外键约束、触发器或 RLS 策略中的跨 Schema 引用问题
- **解决方案**：使用 V3 简化版，只克隆表结构和基本约束

### 问题2：Edge Function 返回非 2xx 状态码
- **现象**：创建租户时返回错误
- **原因**：克隆函数执行失败
- **解决方案**：简化克隆逻辑，避免复杂依赖

## 注意事项

1. **第一个租户很重要**：第一个租户的架构会作为模板，后续租户都会克隆它
2. **克隆失败不降级**：如果克隆失败，不会使用默认创建方式，而是直接报错
3. **草稿包含密码**：草稿存储在本地，包含密码信息，请注意安全
4. **简化版克隆**：V3 版本只克隆表结构和基本约束，不克隆外键、触发器等复杂功能

## 测试环境

- **测试时间**：2025-11-28
- **测试人员**：_____________
- **系统版本**：V3 简化版
- **克隆函数版本**：create_tenant_schema_clone_v3
- **Edge Function 版本**：11
