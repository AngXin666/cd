# 🔍 调试H5更新功能

## 问题：APP没有显示更新对话框

### 原因分析

当前APP的版本是 **1.0.0**（package.json）  
数据库中的版本也是 **1.0.0**  
→ 版本相同，不会触发更新！

---

## 🎯 解决方案：测试更新功能

### 方法1：在数据库添加更高版本（推荐）

1. **打开Supabase SQL编辑器**  
   https://supabase.com/dashboard/project/wxvrwkpkioalqdsfswwu/sql

2. **执行以下SQL**：

```sql
-- 添加一个1.0.1版本来触发更新
INSERT INTO h5_versions (version, h5_url, release_notes, is_force_update, is_active)
VALUES (
  '1.0.1',
  'https://wxvrwkpkioalqdsfswwu.supabase.co/storage/v1/object/public/h5-app/v1.0.0/',
  '测试更新功能 - 这是一个测试版本',
  false,
  true
);
```

3. **重新打开APP**  
   应该会看到更新对话框，显示版本1.0.1

---

### 方法2：查看控制台日志

如果还是没有看到，检查APP的控制台日志：

1. 打开Chrome DevTools（如果是H5）
2. 或者使用Android Studio的Logcat（如果是APK）
3. 查找以下日志：
   - `检查H5更新失败:` - 说明网络或API有问题
   - `获取H5版本信息失败:` - 说明Supabase查询失败
   - 如果没有任何日志 - 说明代码可能没有执行

---

### 方法3：手动测试更新检查

在浏览器控制台或APP中执行：

```javascript
import { checkForH5Update } from '@/services/h5UpdateService'

// 测试更新检查
checkForH5Update().then(result => {
  console.log('更新检查结果:', result)
}).catch(error => {
  console.error('更新检查失败:', error)
})
```

---

## 🔍 常见问题排查

### 问题1：网络问题
- 检查APP是否能访问Supabase
- 检查网络连接

### 问题2：RLS策略问题
- 确认h5_versions表的RLS策略允许公开读取
- 执行SQL查看策略：
```sql
SELECT * FROM pg_policies WHERE tablename = 'h5_versions';
```

### 问题3：版本比较逻辑
- 当前版本：1.0.0
- 数据库版本：1.0.0
- 结果：不会更新（版本相同）

- 当前版本：1.0.0
- 数据库版本：1.0.1
- 结果：会提示更新 ✅

---

## ✅ 验证更新功能正常

执行上面的SQL后，重新打开APP，应该看到：

```
┌─────────────────────────────┐
│   发现新版本 1.0.1          │
│                             │
│   测试更新功能 - 这是一个   │
│   测试版本                  │
│                             │
│   [立即更新]  [稍后更新]    │
└─────────────────────────────┘
```

---

## 📝 下次真正更新时

1. 修改代码
2. 运行 `npm run build:h5`
3. 运行 `.\scripts\check-and-upload.ps1`
4. 在数据库添加新版本记录（版本号要大于当前版本）
5. 用户打开APP就会看到更新提示

---

**现在执行 `测试更新.sql` 来测试功能！** 🚀
