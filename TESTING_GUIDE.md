# 车队管家小程序 - 测试指南

## 快速测试清单

修复了 migration 文件编号冲突后，需要测试以下核心功能确保系统正常运行。

---

## 🔴 第一优先级：仓库分配功能（核心问题）

### 测试场景 1：普通管理端分配仓库

**测试步骤**：
1. 使用普通管理员账号登录（手机号：13800000002，密码：123456）
2. 进入"员工管理"页面
3. 找到一个司机，点击"分配仓库"
4. 选择一个或多个仓库
5. 点击"保存"
6. 观察是否显示成功提示

**预期结果**：
- ✅ 显示"仓库分配成功"提示
- ✅ 提示信息说明"司机需要重新登录才能看到新分配的仓库"
- ✅ 没有任何错误信息（特别是关于 notifications 的错误）

**如果失败**：
- 检查浏览器控制台是否有错误
- 截图错误信息
- 记录具体的错误代码

---

### 测试场景 2：超级管理端分配仓库

**测试步骤**：
1. 使用超级管理员账号登录（手机号：13800000000，密码：123456）
2. 进入"司机仓库分配"页面
3. 选择一个司机
4. 选择一个或多个仓库
5. 点击"保存"
6. 观察是否显示成功提示

**预期结果**：
- ✅ 显示"仓库分配成功"提示
- ✅ 提示信息说明"司机需要重新登录才能看到新分配的仓库"
- ✅ 没有任何错误信息

---

### 测试场景 3：司机端查看分配的仓库

**测试步骤**：
1. 使用司机账号登录（手机号：13800000001，密码：123456）
2. 进入"计件录入"页面
3. 查看"选择仓库"下拉框

**预期结果**：
- ✅ 能看到管理员分配的仓库列表
- ✅ 仓库名称显示正确
- ✅ 可以选择仓库
- ✅ 选择仓库后可以继续录入计件数据

**如果看不到仓库**：
1. 先退出登录
2. 重新登录
3. 再次检查

---

### 测试场景 4：司机端录入计件数据

**测试步骤**：
1. 在"计件录入"页面
2. 选择一个仓库
3. 选择一个价格分类
4. 输入数量（例如：100）
5. 点击"提交"

**预期结果**：
- ✅ 显示"提交成功"
- ✅ 数据保存到数据库
- ✅ 可以在记录列表中看到刚才录入的数据

---

## 🟡 第二优先级：权限验证

### 测试场景 5：角色权限隔离

**测试内容**：

1. **司机权限**：
   - ✅ 只能看到自己的考勤记录
   - ✅ 只能看到自己的计件记录
   - ✅ 只能看到自己的请假记录
   - ❌ 不能看到其他司机的数据
   - ❌ 不能访问管理功能

2. **普通管理员权限**：
   - ✅ 可以看到自己负责仓库的所有司机
   - ✅ 可以管理这些司机的仓库分配
   - ❌ 不能看到其他仓库的司机
   - ❌ 不能修改其他管理员的权限

3. **超级管理员权限**：
   - ✅ 可以看到所有数据
   - ✅ 可以管理所有仓库
   - ✅ 可以管理所有用户
   - ✅ 可以分配管理员权限

---

## 🟢 第三优先级：其他核心功能

### 测试场景 6：考勤打卡

**司机端**：
1. 进入"考勤打卡"页面
2. 点击"上班打卡"
3. 观察是否成功

**预期结果**：
- ✅ 显示打卡成功
- ✅ 记录当前时间
- ✅ 可以在考勤记录中看到

---

### 测试场景 7：请假申请

**司机端**：
1. 进入"请假申请"页面
2. 填写请假信息（开始时间、结束时间、原因）
3. 提交申请

**管理端**：
1. 进入"请假审批"页面
2. 查看待审批的请假申请
3. 批准或拒绝

**预期结果**：
- ✅ 司机可以成功提交申请
- ✅ 管理员可以看到申请
- ✅ 管理员可以审批
- ✅ 司机可以看到审批结果

---

### 测试场景 8：仓库管理

**超级管理端**：
1. 进入"仓库管理"页面
2. 创建新仓库
3. 编辑仓库信息
4. 禁用仓库
5. 启用仓库

**预期结果**：
- ✅ 可以创建新仓库
- ✅ 可以修改仓库信息
- ✅ 禁用的仓库不能分配给司机
- ✅ 启用后可以正常分配

---

## 📊 数据库状态检查

在开始测试前，建议先检查数据库状态：

### 方法 1：使用 Supabase 控制台

1. 登录 Supabase 控制台
2. 进入 SQL Editor
3. 复制 `check_database_status.sql` 文件的内容
4. 执行查询
5. 查看结果

### 方法 2：使用应用内置的数据库查询

如果应用有数据库管理界面，可以直接在应用中查询。

### 关键检查项

1. **RLS 状态**：
   - driver_warehouses 表的 RLS 应该是禁用的
   - profiles 表的 RLS 状态（根据最后的 migration）

2. **测试账号**：
   - 确认存在三个测试账号（司机、管理员、超级管理员）
   - 确认账号的角色正确

3. **仓库数据**：
   - 至少有 2-3 个测试仓库
   - 仓库状态为启用

4. **现有分配**：
   - 检查是否有现有的仓库分配记录
   - 检查数据是否一致

---

## ⚠️ 常见问题排查

### 问题 1：登录失败

**可能原因**：
- 测试账号不存在
- 密码错误
- 数据库连接问题

**解决方法**：
1. 检查数据库中是否存在测试账号
2. 尝试重置密码
3. 检查 Supabase 连接配置

---

### 问题 2：分配仓库后司机看不到

**可能原因**：
- 司机没有重新登录
- 数据库写入失败
- RLS 策略阻止读取

**解决方法**：
1. 司机退出并重新登录
2. 检查数据库中是否有 driver_warehouses 记录
3. 检查 RLS 状态和策略

---

### 问题 3：权限错误

**可能原因**：
- RLS 策略配置错误
- 用户角色不正确
- Migration 执行顺序问题

**解决方法**：
1. 检查用户的 role 字段
2. 检查 RLS 策略
3. 可能需要重新执行关键的 migration

---

### 问题 4：出现 "notifications" 相关错误

**可能原因**：
- 代码中有残留的通知功能
- 数据库触发器引用了不存在的表

**解决方法**：
1. 检查错误堆栈，找到具体的代码位置
2. 搜索代码中是否有 "notifications" 相关的引用
3. 检查数据库触发器

---

## 📝 测试记录模板

建议使用以下格式记录测试结果：

```markdown
## 测试日期：2025-11-05

### 测试场景 1：普通管理端分配仓库
- 状态：✅ 通过 / ❌ 失败
- 测试人：
- 备注：

### 测试场景 2：超级管理端分配仓库
- 状态：✅ 通过 / ❌ 失败
- 测试人：
- 备注：

### 测试场景 3：司机端查看分配的仓库
- 状态：✅ 通过 / ❌ 失败
- 测试人：
- 备注：

...（继续其他场景）

### 发现的问题
1. 问题描述
   - 严重程度：高/中/低
   - 复现步骤：
   - 错误信息：
   - 截图：

### 总体评估
- 核心功能是否正常：是/否
- 是否可以上线：是/否
- 需要修复的问题数量：
```

---

## 🎯 测试完成标准

所有测试通过的标准：

1. ✅ 所有角色都能正常登录
2. ✅ 管理端可以成功分配仓库（无错误）
3. ✅ 司机端可以看到分配的仓库
4. ✅ 司机端可以正常录入计件数据
5. ✅ 权限隔离正常（司机看不到其他人的数据）
6. ✅ 考勤、请假等基础功能正常
7. ✅ 没有任何数据库错误或权限错误

如果以上 7 项全部通过，说明 migration 修复成功，系统可以正常使用。

---

## 📞 需要帮助？

如果测试中遇到问题：

1. 记录详细的错误信息（截图、日志）
2. 记录复现步骤
3. 检查 `MIGRATION_FIX_REPORT.md` 中的"潜在风险"部分
4. 如果问题严重，可能需要重建数据库

---

**文档版本**: 1.0  
**最后更新**: 2025-11-05  
**相关文档**: 
- `MIGRATION_FIX_REPORT.md` - 详细的修复报告
- `check_database_status.sql` - 数据库状态检查脚本
- `WAREHOUSE_SYNC_FIX.md` - 仓库同步问题修复文档
