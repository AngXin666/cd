# 通知功能测试指南

## 测试准备

### 测试账号准备

需要准备以下类型的测试账号：

1. **超级管理员账号** (super_admin)
2. **普通管理员账号** (manager) - 至少2个，分别管理不同仓库
3. **司机账号** (driver) - 至少2个，包括带车司机和纯司机

### 测试环境

- 确保数据库迁移已应用（00051_add_warehouse_and_driver_type_notification_types.sql）
- 确保至少有2个仓库，分别分配给不同的普通管理员

## 测试场景

### 场景1：普通管理员分配仓库给司机

**测试步骤**：
1. 使用普通管理员账号登录
2. 进入"司机管理"页面
3. 选择一个司机，点击"仓库分配"
4. 勾选一个或多个仓库
5. 点击"保存"

**预期结果**：
- ✅ 司机收到通知："您已被分配到新的仓库：[仓库名称]"
- ✅ 所有超级管理员收到通知："管理员 [管理员名] 分配了新仓库：司机 [司机名]，仓库 [仓库名称]"
- ✅ 通知显示在通知中心，未读数量增加

### 场景2：超级管理员分配仓库给司机

**测试步骤**：
1. 使用超级管理员账号登录
2. 进入"仓库分配"页面
3. 选择一个司机
4. 勾选一个或多个仓库
5. 点击"保存"

**预期结果**：
- ✅ 司机收到通知："您已被分配到新的仓库：[仓库名称]"
- ✅ 相关仓库的普通管理员收到通知："超级管理员 [管理员名] 分配了新仓库：司机 [司机名]，仓库 [仓库名称]"
- ✅ 通知显示在通知中心，未读数量增加

### 场景3：取消司机的仓库分配

**测试步骤**：
1. 使用管理员账号登录（普通或超级）
2. 进入相应的仓库分配页面
3. 选择一个已有仓库分配的司机
4. 取消勾选一个或多个仓库
5. 点击"保存"

**预期结果**：
- ✅ 司机收到通知："您已被取消以下仓库的分配：[仓库名称]"
- ✅ 相关管理员收到通知（根据操作者角色）
- ✅ 通知显示在通知中心

### 场景4：普通管理员切换司机类型

**测试步骤**：
1. 使用普通管理员账号登录
2. 进入"司机管理"页面
3. 找到一个司机，点击"切换类型"按钮
4. 确认切换（例如：从"纯司机"切换为"带车司机"）

**预期结果**：
- ✅ 司机收到通知："您的司机类型已从【纯司机】变更为【带车司机】"
- ✅ 所有超级管理员收到通知："管理员 [管理员名] 修改了司机类型：[司机名]，从【纯司机】变更为【带车司机】"
- ✅ 通知显示在通知中心

### 场景5：超级管理员切换司机类型

**测试步骤**：
1. 使用超级管理员账号登录
2. 进入"用户管理"页面
3. 找到一个司机，点击"切换类型"按钮
4. 确认切换（例如：从"带车司机"切换为"纯司机"）

**预期结果**：
- ✅ 司机收到通知："您的司机类型已从【带车司机】变更为【纯司机】"
- ✅ 该司机所属仓库的普通管理员收到通知："超级管理员 [管理员名] 修改了司机类型：[司机名]，从【带车司机】变更为【纯司机】"
- ✅ 通知显示在通知中心

### 场景6：同时修改仓库分配（新增+取消）

**测试步骤**：
1. 使用管理员账号登录
2. 选择一个已有仓库分配的司机
3. 同时勾选新仓库和取消旧仓库
4. 点击"保存"

**预期结果**：
- ✅ 司机收到两条通知：
  - "您已被分配到新的仓库：[新仓库名称]"
  - "您已被取消以下仓库的分配：[旧仓库名称]"
- ✅ 相关管理员收到通知，包含新增和取消的仓库信息
- ✅ 通知显示在通知中心

## 验证检查点

### 通知内容验证

- [ ] 通知标题清晰明确
- [ ] 通知消息包含完整信息（操作者、司机、仓库/类型）
- [ ] 通知时间正确
- [ ] 通知类型正确（warehouse_assigned/warehouse_unassigned/driver_type_changed）

### 通知接收验证

- [ ] 司机本人能收到通知
- [ ] 相关管理员能收到通知
- [ ] 不相关的用户不会收到通知
- [ ] 通知未读数量正确更新

### 通知中心验证

- [ ] 通知在通知中心正确显示
- [ ] 点击通知可以查看详情
- [ ] 标记已读功能正常
- [ ] 通知列表按时间倒序排列

### 边界情况测试

- [ ] 司机没有分配任何仓库时切换类型
- [ ] 司机分配多个仓库时切换类型
- [ ] 同一操作快速重复执行
- [ ] 网络异常时的处理

## 常见问题排查

### 问题1：通知没有发送

**排查步骤**：
1. 检查浏览器控制台是否有错误日志
2. 检查数据库 notifications 表是否有新记录
3. 检查操作者的 profile 信息是否正确加载
4. 检查通知类型是否在数据库枚举中存在

### 问题2：通知发送给了错误的用户

**排查步骤**：
1. 检查操作者的角色（role）是否正确
2. 检查仓库管理员分配是否正确
3. 检查司机的仓库分配是否正确
4. 查看控制台日志，确认通知发送逻辑

### 问题3：通知内容不正确

**排查步骤**：
1. 检查仓库名称是否正确加载
2. 检查司机名称是否正确
3. 检查操作者名称是否正确
4. 检查通知消息模板是否正确

## 性能测试

### 批量操作测试

1. 同时为多个司机分配仓库
2. 同时切换多个司机的类型
3. 观察通知发送的性能和响应时间

### 预期性能指标

- 单次操作通知发送时间 < 2秒
- 批量操作（10个司机）通知发送时间 < 5秒
- 通知列表加载时间 < 1秒

## 测试报告模板

```
测试日期：[日期]
测试人员：[姓名]
测试环境：[开发/测试/生产]

| 场景 | 测试结果 | 备注 |
|------|---------|------|
| 场景1：普通管理员分配仓库 | ✅/❌ | |
| 场景2：超级管理员分配仓库 | ✅/❌ | |
| 场景3：取消仓库分配 | ✅/❌ | |
| 场景4：普通管理员切换类型 | ✅/❌ | |
| 场景5：超级管理员切换类型 | ✅/❌ | |
| 场景6：同时修改仓库分配 | ✅/❌ | |

发现的问题：
1. [问题描述]
2. [问题描述]

建议改进：
1. [改进建议]
2. [改进建议]
```
