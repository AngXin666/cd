# 车队管家小程序

一款专为车队管理打造的微信小程序，提供多角色权限管理，包含司机端、普通管理端和超级管理端三个不同界面，满足车队运营的分层管理需求。

---

## 快速开始

### 登录界面 🔐
小程序提供了优化的登录体验：

#### 登录方式
- **密码登录**：支持手机号或账号名 + 密码
- **验证码登录**：支持手机号 + 短信验证码

#### 界面特性
- **优化的输入框**：
  - 大尺寸输入区域，易于点击和输入
  - 16px 字体大小，清晰易读
  - 一键清除按钮，快速删除内容
  - 聚焦时边框高亮，状态清晰
- **智能登录按钮**：
  - 当前激活的按钮点击即可登录
  - 未激活的按钮点击切换登录方式
  - 一键完成切换和登录，操作流畅
- **记住账号密码**：
  - 勾选后自动保存账号密码
  - 下次打开自动填充
  - 提升重复登录效率

详细优化说明请查看：[LOGIN_OPTIMIZATION.md](LOGIN_OPTIMIZATION.md)

### 底部导航栏
小程序底部有两个标签：
- **工作台**：智能入口，根据用户角色自动跳转到对应的工作台
  - 司机 → 司机工作台
  - 管理员 → 管理员工作台
  - 超级管理员 → 超级管理员控制台
- **我的**：个人中心，所有角色共享统一的个人信息和设置页面

---

## 功能特性

### 滑动返回功能 ✨
小程序支持多种返回方式，提供流畅的导航体验：

#### 系统默认滑动返回
- **微信小程序原生支持**：在所有非 tabBar 页面，用户可以从屏幕右侧向左滑动返回上一页
- **自动启用**：无需额外配置，所有页面默认支持
- **系统级手势**：与微信小程序的系统手势一致，用户体验熟悉

#### 自定义滑动返回组件
为需要特殊返回逻辑的页面提供了 `SwipeBack` 组件：

- **从左侧边缘滑动**：从屏幕左侧 50px 内开始滑动触发返回
- **实时视觉反馈**：
  - 页面随手指移动
  - 左侧显示返回图标指示器
  - 背景显示半透明黑色遮罩
- **智能返回逻辑**：
  - 页面栈深度 > 1：返回上一页
  - 页面栈深度 = 1：跳转到工作台
- **可自定义**：
  - 支持自定义返回回调函数
  - 支持禁用滑动返回功能
  - 适合需要确认的返回场景（如表单编辑）

**使用示例**：
```tsx
import SwipeBack from '@/components/SwipeBack'

const MyPage: React.FC = () => {
  return (
    <SwipeBack>
      <View className="p-4">
        {/* 页面内容 */}
      </View>
    </SwipeBack>
  )
}
```

详细使用说明请查看：[src/components/SwipeBack/README.md](src/components/SwipeBack/README.md)

### 多角色权限管理
- **司机端**：个人工作台、**滑动切换仓库**（支持左右滑动快速切换所属仓库，查看不同仓库数据）、**综合数据统计**（当日件数、当日收入、本月件数、本月收入、出勤天数、请假天数）、**快捷功能**（计件录入、考勤打卡、请假申请、数据统计）、仓库打卡、查看所属仓库、仓库统计详情（考勤+计件）、计件录入（录入、编辑、删除个人计件记录）、我的计件（查看个人计件记录和收入）、**快捷请假**（滚轮选择天数）、**补请假**（补录历史记录）、**离职申请**（提前天数控制）、**草稿管理**（保存、编辑、提交、删除草稿）、**智能天数计算**（自动计算请假天数）、**退出登录**（页面底部）
- **普通管理端**：管理员工作台、**滑动切换仓库**（支持左右滑动快速切换管辖仓库，查看不同仓库数据）、**司机管理**（根据权限控制：有权限时可编辑司机信息（姓名、手机号、车牌号），无权限时只能查看）、**司机仓库分配**（多选对话框，可一次性选择多个仓库并保存）、基础管理功能、数据统计（查看管辖仓库的计件和考勤数据报表，支持按司机和仓库筛选，显示出勤天数、迟到天数、请假天数，仅可查看）、请假离职审批（**仅审批管辖仓库的申请**）
- **超级管理端**：超级管理员控制台、系统管理、**员工管理**（司机管理：按仓库左右滑动切换查看各仓库在职司机，支持编辑司机信息和重置密码；管理员管理：查看所有管理员信息、所管理的仓库和拥有的权限，支持编辑信息、**权限设置**（多选对话框，控制管理员是否能修改司机信息、修改计件记录、管理考勤规则、品类管理）、变更角色、重置密码、**管理员仓库分配**（多选对话框，可一次性选择多个仓库并保存））、**用户权限管理**（用户列表、角色升降级、权限配置）、**仓库信息管理**（统一编辑仓库基本信息、考勤规则、请假与离职设置，所有修改操作需密码验证）、司机仓库分配、计件品类管理、数据统计（查看所有仓库的计件和考勤数据报表，显示出勤天数、迟到天数、请假天数）、请假离职审批（**仅审批未分配管理员的仓库申请**）

### 仓库切换功能（司机端和管理端通用）
- **智能显示**：
  - 只有一个仓库时：不显示切换器，直接显示仓库数据
  - 多个仓库时：显示滑动切换器，支持快速切换
- **滑动切换**：左右滑动即可快速切换不同仓库
- **位置提示**：显示当前仓库位置，如"(1/3)"
- **智能缓存**：切换仓库时优先使用缓存，响应速度 < 50ms
- **实时更新**：数据变化时仪表板自动刷新（WebSocket监听）
- **数据隔离**：每个仓库的数据独立显示，不会混淆
- **视觉反馈**：底部指示点显示当前位置，切换动画流畅
- 详细说明请查看：[docs/管理员仓库切换功能说明.md](docs/管理员仓库切换功能说明.md)

### 仪表盘缓存与实时更新优化 ✨
- **智能缓存机制**：
  - 5分钟缓存有效期，切换仓库时优先使用缓存数据
  - 缓存命中时响应速度 < 50ms，大幅提升切换流畅度
  - 自动清理过期缓存，确保数据准确性
- **实时数据监听**：
  - 使用WebSocket监听数据库变更（计件、考勤、请假）
  - 数据变更时自动刷新缓存，无需手动刷新
  - 静默更新机制，不影响用户操作
- **性能优化**：
  - 减少70%以上的重复网络请求
  - 防抖节流避免并发请求
  - 离线模式支持，网络异常时显示缓存数据
- **UI加载优化** 🎨：
  - 切换仓库时数据卡片始终显示，不会消失或闪烁
  - 标题旁边显示小的旋转加载图标，提供清晰的加载反馈
  - 数据加载完成后平滑更新数字，无需重新渲染整个UI
  - 视觉稳定连贯，提供流畅的用户体验
- **用户体验**：
  - 即时响应，流畅切换
  - 数据实时性与响应速度完美平衡
  - 加载状态清晰，操作反馈及时
  - 无闪烁、无跳动，视觉体验优秀
- 详细技术方案请查看：
  - [DASHBOARD_CACHE_OPTIMIZATION.md](DASHBOARD_CACHE_OPTIMIZATION.md) - 缓存机制详解
  - [UI_LOADING_OPTIMIZATION.md](UI_LOADING_OPTIMIZATION.md) - UI优化详解



### 司机端快捷功能
- **标题右侧**：个人中心快捷按钮（蓝色圆角按钮，点击跳转到个人中心页面）
- **2x2网格布局**：
  - 左上：计件录入（蓝色）
  - 右上：考勤打卡（橙色）
  - 左下：请假申请（紫色）
  - 右下：数据统计（绿色）
- **页面底部**：退出登录按钮（红色渐变，点击后弹出确认对话框）
- 所有按钮都有点击缩放动画效果，提升用户体验

### 司机端智能数据跳转
- **数据统计卡片交互**：点击数据仪表盘中的统计卡片，自动跳转到对应功能页面
  - **当日件数/当日收入**：点击后跳转到数据统计页面，自动显示当天的计件数据
  - **本月件数/本月收入**：点击后跳转到数据统计页面，自动显示本月的计件数据
  - **出勤天数/请假天数**：点击后跳转到请假申请页面，查看详细的考勤和请假信息
- **时间范围标识**：数据统计页面标题处显示清晰的时间范围标识（📅 当天数据 或 📊 本月数据）
- **统一交互体验**：所有可点击卡片都有缩放动画效果，提供一致的视觉反馈
- **流畅体验**：页面切换流畅，数据加载即时，提升数据查看效率

### 请假管理系统（新增功能）
- **数据仪表盘**：
  - 在请假申请页面顶部显示本月数据统计
  - **本月出勤天数**：显示当月已打卡的出勤天数（绿色卡片）
  - **本月请假天数**：显示当月已批准的请假天数（橙色卡片）
  - **剩余申请天数**：显示本月还可以申请的请假天数（蓝色卡片）
  - **月度上限提示**：底部显示仓库设置的月度请假上限
  - 数据实时更新，页面显示时自动刷新

- **快捷请假**：
  - 通过滚轮快速选择请假天数（1-上限天数）
  - 起始日期自动设置为明天
  - 结束日期自动计算
  - 3步完成请假申请（选类型→选天数→填事由）
  - 不能超过仓库设置的请假天数上限
  - **月度请假统计**：实时显示本月已批准、待审批和本次申请的天数
  - **月度上限校验**：自动校验月度请假天数，超限时禁止提交并给出明确提示
  
- **补请假**：
  - 允许选择当天及之前的日期进行补假申请
  - 灵活补录历史请假记录
  - 超过仓库上限时显示警告提示
  - 超限申请需要管理员手动审批
  - **月度请假统计**：实时显示本月已批准、待审批和本次申请的天数
  - **月度上限校验**：自动校验月度请假天数，超限时禁止提交并给出明确提示
  
- **离职申请优化**：
  - 离职日期只能选择距当前日期指定天数后的日期
  - 提前天数由仓库设置决定
  - 显示最早可选日期提示
  - 实时验证离职日期是否符合要求
  
- **仓库信息管理**（超级管理员）：
  - **统一编辑界面**：在一个对话框中同时编辑仓库基本信息、考勤规则、请假与离职设置
  - **基本信息**：仓库名称、启用状态
  - **考勤规则**：上班时间、下班时间、迟到阈值、早退阈值、是否需要打下班卡、启用状态
  - **请假设置**：月度请假天数上限（1-365天），司机每月请假总天数不能超过此上限
  - **离职设置**：离职申请需提前的天数（1-365天）
  - **密码验证**：所有保存操作都需要输入登录密码进行二次验证，确保操作安全
  - **仓库详情页面**：查看仓库完整信息，包括绑定司机数量、主要管理员、考勤规则、请假规则
  - 不同仓库可以有不同的规则，设置立即生效
  
- **草稿管理**：
  - 支持保存未完成的请假/离职申请为草稿
  - 草稿箱统一管理所有草稿
  - 可随时编辑、提交或删除草稿
  - 草稿不会进入审批流程，只有提交后才会被管理员看到
  
- **智能计算**：
  - 自动计算请假天数（结束日期 - 开始日期 + 1）
  - 实时显示计算结果
  - 醒目的蓝色卡片展示
  
- **分层审批权限**：
  - **超级管理员**：只能审批未分配管理员的仓库申请
  - **仓库管理员**：只能审批自己管辖仓库的申请
  - 权限在数据库层面强制执行，确保数据安全
  - 请假和离职审批采用相同的权限规则

### 个人中心与设置（新增功能）

#### 个人信息管理
- **个人中心主页**：
  - 显示用户头像、姓名、昵称和角色标签
  - 展示个人基本信息（手机号、邮箱、居住地、紧急联系人）
  - 手机号中间4位自动隐藏保护隐私
  - 快速入口：编辑资料、设置、帮助与反馈
  - 退出登录功能

- **编辑资料**：
  - **头像上传**：支持从相册选择或拍照上传，自动压缩至1MB以内
  - **基本信息**：姓名（必填）、昵称、邮箱（格式验证）
  - **居住地址**：省份选择器、城市、区县、详细地址
  - **紧急联系人**：姓名、电话（格式验证）
  - 手机号只读显示，不可修改
  - 实时表单验证和错误提示

#### 账户安全
- **修改密码**：
  - 原密码验证
  - 新密码强度校验（至少8位，包含字母和数字）
  - 密码强度可视化指示器（实时显示强度）
  - 密码匹配提示（确认密码时实时验证）
  - 安全提示：修改后需重新登录

- **账户安全等级**：
  - 显示当前账户安全等级
  - 提供安全建议和提示

#### 帮助与反馈
- **使用说明**：
  - 司机端功能介绍
  - 管理员功能介绍
  - 超级管理员功能介绍
  - 分步骤操作指南

- **常见问题**：
  - 可展开/收起的FAQ列表
  - 涵盖考勤打卡、计件录入、请假申请等常见问题
  - 提供详细的解答和操作步骤

- **意见反馈**：
  - **提交反馈**：选择反馈类型（功能建议、问题反馈、功能需求、投诉建议、其他）
  - **反馈内容**：至少10个字，最多500字
  - **联系方式**：选填，方便回复
  - **历史反馈**：查看已提交的反馈记录
  - **反馈状态**：待处理、处理中、已解决（带颜色标签）
  - Tab切换：提交反馈/历史反馈

- **联系我们**：
  - 客服邮箱、电话
  - 服务时间说明
  - 快速入口：意见反馈、联系客服

#### 应用设置
- **关于我们**：
  - 应用版本信息
  - 用户协议入口
  - 隐私政策入口
  - 版权信息展示

#### 系统设置入口
- **司机端**：通过底部导航栏"我的"进入个人中心
- **普通管理员**：在管理员工作台的"管理功能"区域点击"系统设置"按钮
- **超级管理员**：在超级管理员控制台的"其他系统功能"区域点击"系统设置"按钮
- 所有角色的系统设置都跳转到统一的个人中心页面，提供一致的用户体验

### 数据统计功能

#### 司机端数据统计
- **综合仪表盘（3列2行布局）**：
  - **今日数据**：当日件数、当日收入（实时更新）
  - **本月数据**：本月件数、本月收入（累计统计）
  - **考勤数据**：出勤天数、请假天数（本月统计）
  - 采用3x2网格布局，6个核心数据指标一目了然
  - 每个数据卡片使用渐变色背景和专属图标
  - 数据分类清晰，使用不同颜色和图标区分
  - 自动计算分拣费、上楼费等附加收入
  - 页面进入时自动刷新数据
  - 加载状态提示，提升用户体验

#### 管理端数据统计
- **综合数据报表**：
  - 整合计件数据和考勤数据，提供全面的司机工作统计
  - 支持按时间范围筛选（本周、本月、自定义日期）
  - 支持按仓库筛选（全部仓库或指定仓库）
  - 支持按司机姓名或手机号搜索
  
- **计件统计**：
  - 总件数：统计期间内的总计件数量
  - 总金额：包含基础计件、上楼费、分拣费的总收入
  - 记录数：计件记录的总条数
  - 关联仓库：显示司机在哪些仓库有计件记录
  
- **司机类型与价格配置**：
  - **司机类型识别**：系统自动识别司机类型（纯司机/带车司机）
  - **智能价格填充**：计件录入时，根据管理员设置的品类价格自动填充
    - 管理员已设置价格：自动填充对应司机类型的价格，不允许修改
    - 管理员未设置价格：允许司机手动输入价格
  - **价格锁定机制**：已设置的价格显示锁定状态，确保价格统一性
  - **动态价格更新**：切换仓库或品类时，自动更新价格配置
  
- **考勤统计**：
  - 出勤天数：统计期间内的正常出勤天数
  - 迟到天数：统计期间内的迟到次数
  - 请假天数：统计期间内已批准的请假天数
  - 数据来源于考勤打卡记录和请假申请记录
  
- **详细数据查看**：
  - 点击司机卡片可查看详细的计件和考勤记录
  - 按日期、品类、仓库维度展示详细数据
  - 支持数据导出和打印（超级管理员）
  
- **权限控制**：
  - **普通管理员**：只能查看管辖仓库的数据统计
  - **超级管理员**：可以查看所有仓库的数据统计

### 用户认证系统
- 基于 Supabase Auth 的登录认证
- 支持手机号+验证码登录
- 支持账号/手机号+密码登录（可使用账号名或手机号登录）
- 首位注册用户自动成为超级管理员

### 登录方式
登录界面提供两种登录方式，可自由切换：

1. **密码登录**（默认，推荐）
   - 支持账号名登录（如：admin、admin1、admin2）
   - 支持手机号登录（11位手机号格式）
   - 输入密码后点击登录按钮
   - 系统会自动识别输入类型并使用对应的认证方式

2. **验证码登录**
   - 仅支持手机号登录
   - 输入手机号后点击"发送验证码"按钮
   - 输入收到的验证码
   - 点击登录按钮

### 测试账号
系统已预置3个测试账号，可直接使用密码登录：

| 账号 | 密码 | 角色 | 邮箱 | 说明 |
|------|------|------|------|------|
| admin | 123456 | 超级管理员 | admin@fleet.com | 拥有所有权限 |
| admin2 | 123456 | 普通管理员 | admin2@fleet.com | 可管理司机 |
| admin1 | 123456 | 司机 | admin1@fleet.com | 基础权限 |

**快速登录步骤**：
1. 在登录页面选择"密码登录"（默认已选中）
2. 在账号输入框中输入账号名（如：`admin`）
3. 在密码输入框中输入密码：`123456`
4. 点击"登录"按钮
5. 登录成功后自动跳转到对应角色的工作台

**重要提示**：
- ✅ 密码已使用 PostgreSQL 的 `crypt()` 函数正确加密
- ✅ 所有测试账号均可正常登录
- ✅ 支持使用账号名（admin）或邮箱（admin@fleet.com）登录
- 📖 详细登录指南请查看：[docs/LOGIN_GUIDE.md](docs/LOGIN_GUIDE.md)

### 权限控制
- 超级管理员：拥有所有权限，可管理所有用户和修改任何角色，可管理仓库和考勤规则，可为司机分配仓库，可为管理员分配仓库和权限，可管理计件品类，可查看所有仓库的计件数据
- 普通管理员：可查看所有用户，权限受超级管理员配置控制（包括：修改司机信息、修改计件记录、管理考勤规则、品类管理），可查看管辖仓库的计件数据
- 司机：只能查看和修改自己的信息，只能在被分配的仓库打卡，可查看所属仓库的考勤和计件统计，可录入、编辑、删除自己的计件记录

### 用户权限管理系统（超级管理员）

#### 用户列表与角色管理
- **用户列表展示**：显示所有用户的基本信息（姓名、手机号、邮箱、角色、所属仓库）
- **角色筛选**：支持按角色筛选用户（全部/超级管理员/管理员/司机）
- **关键词搜索**：支持按姓名（含拼音搜索）、手机号、邮箱搜索用户
- **角色升降级**：
  - 超级管理员不可修改（按钮置灰）
  - 管理员可降级为司机
  - 司机可升级为管理员
  - 操作前需确认，防止误操作

#### 管理员权限配置
- **管辖仓库分配**：
  - 从全部仓库列表中勾选管理员可管理的仓库
  - 支持多选，灵活配置管理范围
  - 管理员只能查看和管理被分配的仓库数据
- **功能权限开关**（点击"权限设置"按钮配置，多选对话框）：
  - **修改司机信息**：控制是否可以编辑司机的基本信息（姓名、手机号、车牌号）和重置司机密码
  - **修改计件记录**：控制是否可以修改司机的计件数据
  - **管理考勤规则**：控制是否可以修改考勤规则
  - **品类管理**：控制是否可以管理计件品类配置
- **权限实时生效**：配置保存后立即生效，无需重新登录
- **权限控制效果**：
  - 有权限：显示"编辑信息"和"重置密码"按钮，可修改司机信息和重置司机密码
  - 无权限：不显示任何操作按钮，只能查看司机卡片上的信息（姓名、手机、账号、车牌、入职日期等）
- **司机信息展示**：
  - 所有司机卡片都显示完整信息，包括车牌号
  - 没有车牌的司机显示"车牌：无"

#### 仓库品类配置（管理员）
- **仓库选择**：管理员可选择其管辖的仓库
- **品类分配**：为仓库分配可操作的计件品类
- **多选支持**：支持为仓库分配多个品类
- **数据隔离**：不同仓库可配置不同的品类组合

#### 仓库分配功能（超级管理端和普通管理端）
- **多选对话框**：
  - 点击"分配仓库"按钮打开多选对话框
  - 显示所有可分配的仓库列表
  - 支持复选框多选，可一次性选择多个仓库
  - 实时显示已选择的仓库数量
- **智能保存**：
  - 自动计算需要添加和移除的仓库
  - 批量处理仓库分配变更
  - 保存成功后自动刷新数据
- **超级管理端**：
  - 为管理员分配仓库：管理员只能管理被分配的仓库
  - 为司机分配仓库：司机只能在被分配的仓库打卡和录入计件
- **普通管理端**：
  - 为司机分配仓库：只能分配管理员自己管辖的仓库
  - 权限范围限制：无法分配超出管辖范围的仓库
- **用户体验优化**：
  - 已选择的仓库显示蓝色高亮和勾选标记
  - 未选择的仓库显示灰色边框
  - 点击仓库项即可切换选择状态
  - 取消按钮：关闭对话框，不保存修改
  - 保存按钮：保存所有修改并刷新数据

#### 权限校验机制
- **接口级校验**：所有数据修改接口都进行权限验证
- **数据范围过滤**：管理员只能访问其管辖仓库的数据
- **操作权限控制**：根据权限配置显示/隐藏功能按钮
- **安全防护**：防止越权访问和数据泄露

#### 仪表板数据更新与同步（新增功能）
- **实时数据更新**：
  - 司机提交计件记录、考勤打卡、请假申请时，管理员仪表板自动刷新
  - 管理员修改数据时，超级管理员仪表板自动刷新
  - 使用 Supabase Realtime 实现多端实时同步
  - 数据变化延迟 < 3秒

- **智能缓存机制**：
  - 仓库列表缓存：10分钟有效期
  - 仪表板数据缓存：5分钟有效期
  - 切换仓库时优先使用缓存，提升响应速度
  - 缓存过期或数据变化时自动刷新

- **多仓库数据隔离**：
  - 每个仓库的数据独立缓存
  - 切换仓库时自动加载对应数据
  - 避免数据混淆和错误显示

- **性能优化**：
  - 防止重复加载，避免不必要的网络请求
  - 首次加载后缓存数据，切换仓库时优先使用缓存
  - 页面显示时检查缓存有效性，按需刷新
  - 登录时自动加载所有必要数据

- **技术实现**：
  - 使用自定义 Hooks 管理数据状态（useDashboardData、useWarehousesData、useSuperAdminDashboard）
  - Supabase Realtime 订阅数据库变化
  - Taro Storage API 实现本地缓存
  - 详细技术方案请查看：[docs/仪表板数据更新与同步方案.md](docs/仪表板数据更新与同步方案.md)

### 考勤打卡系统
- **仓库选择打卡**：司机选择所在仓库进行打卡（仅限被分配的仓库）
- **考勤状态判定**：根据管理员设置的考勤规则自动判定迟到、早退等状态
- **工时自动计算**：下班打卡时自动计算工作时长
- **考勤统计分析**：查看当月出勤天数、正常天数、迟到次数、总工时等统计数据
- **灵活打卡设置**：支持设置是否需要打下班卡

### 仓库管理系统（超级管理员）
- **仓库信息管理**：添加、编辑、删除仓库信息
- **专用编辑页面**：点击编辑按钮跳转到专门的仓库编辑页面，提供完整的配置功能
- **品类配置**：
  - 为仓库选择可用的计件品类
  - 设置纯司机单价和带车司机单价
  - 未配置品类的仓库，司机无法提交计件工作报告
- **管理员分配**：
  - 必须为仓库指定至少一个管理员才能保存
  - 支持选择多个管理员
  - 超级管理员可以将自己设置为仓库管理员
  - 快速添加功能，一键将自己设为管理员
- **考勤规则配置**：设置上下班时间、迟到阈值、早退阈值
- **下班卡设置**：设置是否需要打下班卡
- **仓库状态管理**：启用或禁用仓库
- **实时预览**：查看仓库考勤规则
- **智能说明**：编辑页面提供详细的设置说明和作用解释

### 司机仓库分配系统（超级管理员）
- **司机仓库分配**：为司机分配可以工作的仓库
- **多仓库支持**：支持一个司机分配到多个仓库
- **灵活管理**：可随时调整司机的仓库分配
- **权限控制**：司机只能在被分配的仓库打卡

### 仓库统计系统（司机端）
- **仓库入口**：司机工作台显示所属仓库列表，点击进入统计详情
- **考勤统计**：查看指定仓库的考勤记录、出勤天数、正常天数、迟到次数、总工时
- **计件统计**：查看完成订单数、总数量、总金额、按品类统计
- **日期筛选**：支持按最近一周、本月、全部时间范围筛选数据
- **详细记录**：展示每条考勤记录和计件记录的详细信息（包含品类、上楼信息）
- **数据可视化**：清晰的卡片式布局，直观展示统计数据

### 计件管理系统
- **品类管理**（超级管理员）：添加、编辑、删除计件品类，启用或禁用品类
- **计件录入**（司机）：
  - 司机可以录入自己的计件工作数据
  - 选择仓库、品类、工作日期、数量、单价
  - 支持设置是否需要上楼及上楼单价
  - 可添加备注信息
  - 自动计算预计金额（基础金额+上楼费用）
- **计件管理**（司机）：
  - 司机可以查看、编辑、删除自己录入的计件记录
  - 显示本月所有计件记录
  - 支持按仓库和日期筛选
  - 查看个人计件收入统计
- **数据汇总**（管理员/超级管理员）：
  - 支持按仓库和司机两个维度筛选查看计件数据
  - 可查看指定单个司机的计件数据
  - 可查看所有司机的汇总计件数据
  - 显示总件数、总金额、按品类统计等数据报表
  - 普通管理员仅能查看其管辖仓库范围内的数据
  - 超级管理员可查看所有仓库的数据
- **权限控制**：
  - 司机：可以录入、修改、删除自己的计件记录，可以查看自己的计件统计
  - 普通管理员：仅可查看其管辖仓库的计件记录，不能修改或删除
  - 超级管理员：可查看所有仓库的计件记录，不能修改或删除
- **数据统计**：自动计算总金额（基础金额+上楼费用），按品类统计数量和金额
- **灵活配置**：支持设置是否需要上楼，上楼单价可单独设置

### 车辆管理审核流程（新增功能）

#### 核心功能
建立从司机录入到超级管理员审核的闭环车辆管理流程，重点强化图片审核机制。

#### 司机端功能
- **车辆录入**：
  - 支持"提车录入"与"还车录入"两种场景
  - 提交车辆信息（含图片）后，系统自动记录并更新车辆状态
  - 支持保存草稿和提交审核两种模式
- **审核状态显示**：
  - **录入中**：信息尚未提交，可以继续编辑
  - **待审核**：信息已提交，等待管理员审核
  - **需补录**：管理员审核后发现部分图片不符合要求，需要补充
  - **审核通过**：所有信息符合要求，可以进行后续操作（如还车）
- **图片补录**：
  - 在"需补录"状态下，只能重新上传被管理员标记的图片
  - 无法修改已锁定的图片
  - 对比显示原图和新图
  - 显示补录进度统计
  - 补录完成后自动重新提交审核

#### 超级管理端功能
- **车辆信息审核页面**：
  - 集中展示所有状态为"待审核"的车辆记录
  - 显示司机信息和车辆基本信息
  - 点击进入详细审核页面
- **图片审核操作**：
  - 逐张审查车辆图片
  - **锁定功能**：对符合要求的图片进行锁定，防止被误删，司机端不可再修改
  - **标记需补录**：对不符合要求的图片标记需补录，将其从记录中移除
  - 系统自动记录需补拍项
- **审核结果处理**：
  - 若存在被标记的图片，将车辆状态置为"需补录"，并通知司机端补传
  - 当所有图片均符合要求后，执行"通过审核"操作，更新为"审核通过"
  - 支持填写审核备注
- **车辆租赁信息管理**（新增功能）：
  - 在车辆管理页面查看所有车辆的租赁信息
  - 支持编辑车辆租赁信息，包括：
    - 车辆归属类型（公司车/个人车）
    - 租赁方信息（名称、联系方式）
    - 承租方信息（名称、联系方式）
    - 租赁期限（开始日期、结束日期）
    - 租金信息（月租金、租金缴纳日）
  - 司机端不显示任何租赁信息，确保信息安全

#### 流程协同
- 司机提交审核 → 状态变为"待审核"
- 管理员审核发现问题 → 标记需补录 → 状态变为"需补录"
- 司机补录图片 → 重新提交 → 状态变回"待审核"
- 管理员审核通过 → 状态变为"审核通过"
- 审核通过后才能进行还车等后续操作

#### 数据结构
- **审核状态枚举**：drafting（录入中）、pending_review（待审核）、need_supplement（需补录）、approved（审核通过）
- **图片锁定**：使用 JSON 格式存储已锁定的图片索引
- **需补录列表**：使用数组格式存储需要补录的图片标识（如 `pickup_photos_0`）

### 请假与离职管理系统
- **请假申请**（司机）：
  - 司机可以提交请假申请
  - 支持多种请假类型（事假、病假、年假、其他）
  - 选择请假时间段（开始日期和结束日期）
  - 填写详细的请假事由
  - 查看申请状态（待审批、已通过、已驳回）
  - 查看审批意见和审批人信息
- **离职申请**（司机）：
  - 司机可以提交离职申请
  - 选择预计离职日期
  - 填写离职原因
  - 查看申请状态和审批结果
- **审批管理**（管理员）：
  - 普通管理员可以审批管辖仓库的请假和离职申请
  - 超级管理员可以审批所有仓库的请假和离职申请
  - **审批入口**：在司机详细记录页面的"请假记录"标签中进行审批
  - 支持通过或驳回申请
  - 驳回时可填写驳回理由
  - 查看申请详情和申请人信息
  - **待审批状态显示**：待审批的请假记录显示"批准"和"拒绝"按钮
  - **审批确认机制**：审批前需要确认，防止误操作
  - **实时反馈**：审批成功后自动刷新数据并显示提示信息
- **搜索筛选**：
  - 支持按状态筛选（全部、待审批、已通过、已驳回）
  - 支持按姓名或仓库搜索
  - 分类查看请假申请和离职申请
- **数据统计**（超级管理员）：
  - **考勤管理仪表盘**：显示司机总数和待审核请假申请数量
  - **司机信息卡片**：
    - 有待审核请假时，显示"请假审核"和待审核数量（如"3条"）
    - 无待审核请假时，显示"请假天数"和已批准的请假天数
  - 显示请假申请总数和各状态数量
  - 显示离职申请总数和各状态数量
  - 实时更新统计数据
- **权限控制**：
  - 司机：只能查看和创建自己的申请，不能修改已提交的申请
  - 普通管理员：只能审批管辖仓库的申请
  - 超级管理员：可以审批所有申请
  - 审批操作不可撤销

---

## 页面路由

| 路由 | 页面名称 | 说明 |
|------|---------|------|
| `/pages/login/index` | 登录页 | 用户登录入口 |
| `/pages/driver/index` | 司机工作台 | 司机端主页（tabBar） |
| `/pages/driver/clock-in/index` | 上下班打卡 | 仓库选择打卡功能 |
| `/pages/driver/attendance/index` | 当月考勤 | 查看当月考勤记录和统计 |
| `/pages/driver/warehouse-stats/index` | 仓库统计详情 | 查看指定仓库的考勤和计件统计 |
| `/pages/driver/piece-work-entry/index` | 计件录入 | 录入、编辑、删除个人计件记录 |
| `/pages/driver/piece-work/index` | 我的计件 | 查看个人计件工作记录和收入统计 |
| `/pages/driver/leave/index` | 请假与离职 | 司机请假离职申请主页 |
| `/pages/driver/leave/apply/index` | 申请请假 | 提交请假申请 |
| `/pages/driver/leave/resign/index` | 申请离职 | 提交离职申请 |
| `/pages/driver/vehicle-list/index` | 车辆列表 | 查看个人车辆列表和审核状态 |
| `/pages/driver/add-vehicle/index` | 提车录入 | 录入提车信息和照片 |
| `/pages/driver/vehicle-detail/index` | 车辆详情 | 查看车辆详细信息和照片 |
| `/pages/driver/return-vehicle/index` | 还车录入 | 录入还车信息和照片 |
| `/pages/driver/supplement-photos/index` | 补录图片 | 补录被管理员标记的图片 |
| `/pages/manager/index` | 管理员工作台 | 普通管理端主页（tabBar） |
| `/pages/manager/warehouse-categories/index` | 仓库品类配置 | 为管辖仓库配置可操作的计件品类 |
| `/pages/manager/data-summary/index` | 数据汇总 | 查看计件数据报表和统计分析 |
| `/pages/manager/piece-work/index` | 计件管理 | 查看管辖仓库的计件记录 |
| `/pages/manager/leave-approval/index` | 请假离职审批 | 审批管辖仓库的请假离职申请 |
| `/pages/super-admin/index` | 超级管理员控制台 | 超级管理端主页（tabBar） |
| `/pages/super-admin/user-management/index` | 用户管理 | 用户列表、角色管理、权限配置入口 |
| `/pages/super-admin/staff-management/index` | 员工管理 | 司机管理（按仓库切换）和管理员管理（权限查看） |
| `/pages/super-admin/permission-config/index` | 权限配置 | 管理员权限和仓库分配配置 |
| `/pages/super-admin/warehouse-management/index` | 仓库管理 | 仓库和考勤规则管理 |
| `/pages/super-admin/warehouse-edit/index` | 编辑仓库 | 专用仓库编辑页面（品类配置、管理员分配） |
| `/pages/super-admin/warehouse-detail/index` | 仓库详情 | 查看仓库完整信息（司机数量、管理员、规则等） |
| `/pages/super-admin/driver-warehouse-assignment/index` | 司机仓库分配 | 为司机分配工作仓库 |
| `/pages/super-admin/manager-warehouse-assignment/index` | 管理员仓库分配 | 为管理员分配管辖仓库 |
| `/pages/super-admin/category-management/index` | 计件品类管理 | 管理计件工作的品类设置 |
| `/pages/super-admin/piece-work-report/index` | 数据统计 | 查看所有仓库的计件和考勤数据报表 |
| `/pages/super-admin/piece-work-report-detail/index` | 司机数据详情 | 查看司机的详细计件和考勤数据 |
| `/pages/manager/piece-work-report/index` | 数据统计 | 查看管辖仓库的计件和考勤数据报表 |
| `/pages/manager/piece-work-report-detail/index` | 司机数据详情 | 查看司机的详细计件和考勤数据 |
| `/pages/super-admin/leave-approval/index` | 请假离职审批 | 审批所有请假离职申请 |
| `/pages/super-admin/vehicle-review/index` | 车辆审核列表 | 查看待审核车辆列表 |
| `/pages/super-admin/vehicle-review-detail/index` | 车辆详细审核 | 审核车辆图片，锁定或标记需补录 |
| `/pages/profile/index` | 个人中心 | 用户个人信息管理（tabBar） |
| `/pages/profile/edit/index` | 编辑资料 | 编辑个人信息、头像、地址等 |
| `/pages/profile/settings/index` | 设置 | 账户安全、关于我们等设置 |
| `/pages/profile/change-password/index` | 修改密码 | 修改登录密码 |
| `/pages/profile/help/index` | 帮助与反馈 | 使用说明、常见问题、联系我们 |
| `/pages/profile/feedback/index` | 意见反馈 | 提交反馈、查看历史反馈 |
| `/pages/admin-dashboard/index` | 用户管理 | 超级管理员用户管理页面 |

---

## 技术栈

- **前端框架**：Taro + React + TypeScript
- **样式方案**：Tailwind CSS
- **后端服务**：Supabase（数据库 + 认证）
- **状态管理**：React Hooks
- **包管理器**：pnpm

---

## 项目结构

```
├── src/
│   ├── app.config.ts               # Taro应用配置，定义路由和tabBar
│   ├── app.tsx                     # 应用入口，配置AuthProvider
│   ├── app.scss
│   ├── assets/
│   │   └── images/                 # 图片资源
│   │       ├── selected/           # tabBar选中态图标
│   │       └── unselected/         # tabBar未选中态图标
│   ├── client/
│   │   └── supabase.ts             # Supabase客户端配置
│   ├── db/                         # 数据库操作
│   │   ├── api.ts                  # 数据库API封装
│   │   └── types.ts                # 数据库类型定义
│   ├── pages/                      # 页面目录
│   │   ├── login/                  # 登录页
│   │   ├── driver/                 # 司机端
│   │   │   ├── index.tsx           # 司机工作台
│   │   │   ├── clock-in/           # 上下班打卡
│   │   │   └── attendance/         # 当月考勤
│   │   ├── manager/                # 管理员工作台
│   │   ├── super-admin/            # 超级管理员控制台
│   │   ├── profile/                # 个人中心
│   │   └── admin-dashboard/        # 用户管理
│   └── types/                      # TypeScript类型定义
└── supabase/
    └── migrations/                 # 数据库迁移文件
        ├── 01_create_profiles_table.sql
        ├── 02_create_test_accounts.sql
        ├── 03_create_auth_test_users.sql
        ├── 04_fix_test_accounts_password.sql
        ├── 05_create_attendance_table.sql
        ├── 06_create_warehouse_and_attendance_rules.sql
        ├── 07_simplify_attendance_system.sql
        ├── 08_create_driver_warehouses.sql
        ├── 09_create_piece_work_records.sql
        └── 10_enhance_piece_work_system.sql
```

---

## 数据库设计

### profiles 表（用户档案）
| 字段 | 类型 | 说明 |
|------|------|------|
| id | uuid | 主键，用户ID |
| phone | text | 手机号（唯一） |
| email | text | 邮箱（唯一） |
| name | text | 用户姓名 |
| nickname | text | 昵称 |
| avatar_url | text | 头像URL |
| address_province | text | 省份 |
| address_city | text | 城市 |
| address_district | text | 区县 |
| address_detail | text | 详细地址 |
| emergency_contact_name | text | 紧急联系人姓名 |
| emergency_contact_phone | text | 紧急联系人电话 |
| role | user_role | 用户角色（driver/manager/super_admin） |
| created_at | timestamptz | 创建时间 |
| updated_at | timestamptz | 更新时间 |

### attendance_records 表（考勤记录）
| 字段 | 类型 | 说明 |
|------|------|------|
| id | uuid | 主键，记录ID |
| user_id | uuid | 用户ID（外键） |
| warehouse_id | uuid | 仓库ID（外键） |
| clock_in_time | timestamptz | 上班打卡时间 |
| clock_out_time | timestamptz | 下班打卡时间 |
| work_date | date | 工作日期 |
| work_hours | numeric | 工作时长（小时） |
| status | text | 状态（normal/late/early/absent） |
| notes | text | 备注 |
| created_at | timestamptz | 创建时间 |

### warehouses 表（仓库信息）
| 字段 | 类型 | 说明 |
|------|------|------|
| id | uuid | 主键，仓库ID |
| name | text | 仓库名称 |
| is_active | boolean | 是否启用 |
| created_at | timestamptz | 创建时间 |
| updated_at | timestamptz | 更新时间 |

### attendance_rules 表（考勤规则）
| 字段 | 类型 | 说明 |
|------|------|------|
| id | uuid | 主键，规则ID |
| warehouse_id | uuid | 仓库ID（外键） |
| work_start_time | time | 上班时间 |
| work_end_time | time | 下班时间 |
| late_threshold | integer | 迟到阈值（分钟） |
| early_threshold | integer | 早退阈值（分钟） |
| require_clock_out | boolean | 是否需要打下班卡 |
| is_active | boolean | 是否启用 |
| created_at | timestamptz | 创建时间 |
| updated_at | timestamptz | 更新时间 |

### driver_warehouses 表（司机仓库关联）
| 字段 | 类型 | 说明 |
|------|------|------|
| id | uuid | 主键，关联ID |
| driver_id | uuid | 司机ID（外键 -> profiles.id） |
| warehouse_id | uuid | 仓库ID（外键 -> warehouses.id） |
| created_at | timestamptz | 创建时间 |
| 唯一约束 | (driver_id, warehouse_id) | 防止重复分配 |

### piece_work_records 表（计件记录）
| 字段 | 类型 | 说明 |
|------|------|------|
| id | uuid | 主键，记录ID |
| user_id | uuid | 用户ID（外键 -> profiles.id） |
| warehouse_id | uuid | 仓库ID（外键 -> warehouses.id） |
| category_id | uuid | 品类ID（外键 -> piece_work_categories.id） |
| work_date | date | 工作日期 |
| quantity | integer | 数量 |
| unit_price | numeric | 单价 |
| need_upstairs | boolean | 是否需要上楼 |
| upstairs_price | numeric | 上楼单价 |
| total_amount | numeric | 总金额（基础金额+上楼费用） |
| notes | text | 备注 |
| created_at | timestamptz | 创建时间 |

### piece_work_categories 表（计件品类）
| 字段 | 类型 | 说明 |
|------|------|------|
| id | uuid | 主键，品类ID |
| name | text | 品类名称（唯一） |
| is_active | boolean | 是否启用 |
| created_at | timestamptz | 创建时间 |
| updated_at | timestamptz | 更新时间 |

### manager_warehouses 表（管理员仓库关联）
| 字段 | 类型 | 说明 |
|------|------|------|
| id | uuid | 主键，关联ID |
| manager_id | uuid | 管理员ID（外键 -> profiles.id） |
| warehouse_id | uuid | 仓库ID（外键 -> warehouses.id） |
| created_at | timestamptz | 创建时间 |
| 唯一约束 | (manager_id, warehouse_id) | 防止重复分配 |

### feedback 表（意见反馈）
| 字段 | 类型 | 说明 |
|------|------|------|
| id | uuid | 主键，反馈ID |
| user_id | uuid | 用户ID（外键 -> profiles.id） |
| type | feedback_type | 反馈类型（suggestion/bug/feature/complaint/other） |
| content | text | 反馈内容 |
| contact | text | 联系方式（可选） |
| status | feedback_status | 状态（pending/processing/resolved） |
| created_at | timestamptz | 创建时间 |
| updated_at | timestamptz | 更新时间 |

### vehicles 表（车辆信息）
| 字段 | 类型 | 说明 |
|------|------|------|
| id | uuid | 主键，车辆ID |
| driver_id | uuid | 司机ID（外键 -> profiles.id） |
| plate_number | text | 车牌号 |
| brand | text | 品牌 |
| model | text | 型号 |
| color | text | 颜色 |
| status | vehicle_status | 车辆状态（picked_up/returned） |
| pickup_time | timestamptz | 提车时间 |
| return_time | timestamptz | 还车时间 |
| pickup_photos | text[] | 提车照片路径数组 |
| return_photos | text[] | 还车照片路径数组 |
| registration_photos | text[] | 行驶证照片路径数组 |
| review_status | review_status | 审核状态（drafting/pending_review/need_supplement/approved） |
| locked_photos | jsonb | 已锁定的图片（JSON格式，存储各类型照片的索引） |
| required_photos | text[] | 需要补录的图片列表（格式：`pickup_photos_0`） |
| review_notes | text | 审核备注 |
| reviewed_by | uuid | 审核人ID（外键 -> profiles.id） |
| reviewed_at | timestamptz | 审核时间 |
| created_at | timestamptz | 创建时间 |
| updated_at | timestamptz | 更新时间 |

### Supabase Storage Buckets
- **avatars**：用户头像存储
  - 文件大小限制：1MB
  - 支持格式：JPEG、PNG、WEBP
  - 访问权限：公开读取
- **app-7cdqf07mbu9t_vehicles**：车辆照片存储
  - 文件大小限制：5MB
  - 支持格式：JPEG、PNG、WEBP
  - 访问权限：公开读取
  - 用途：存储提车照片、还车照片、行驶证照片

---

## 安装和运行

```bash
# 安装依赖
pnpm install

# 代码检查
pnpm run lint

# 开发环境运行（微信小程序）
pnpm run dev:weapp

# 开发环境运行（H5）
pnpm run dev:h5

# 构建生产版本
pnpm run build:weapp
pnpm run build:h5
```

---

## 设计风格

- **主色调**：深蓝色 (#1E3A8A)
- **辅助色**：橙色 (#F97316)
- **背景色**：浅灰色 (#F8FAFC)
- **圆角**：8px
- **布局**：卡片式布局，轻微阴影效果
- **图标**：Material Design Icons (mdi)

---

## 环境变量

在 `.env` 文件中配置以下变量：

```
TARO_APP_SUPABASE_URL=your_supabase_url
TARO_APP_SUPABASE_ANON_KEY=your_supabase_anon_key
TARO_APP_NAME=车队管家
TARO_APP_APP_ID=app-7cdqf07mbu9t
```

---

## 相关文档

- 📖 [登录指南](docs/LOGIN_GUIDE.md) - 详细的登录功能说明和测试账号
- 📖 [仓库考勤系统使用指南](docs/WAREHOUSE_ATTENDANCE_GUIDE.md) - 仓库管理和打卡功能说明
- 📖 [快速开始指南](docs/QUICK_START.md) - 快速体验打卡功能

---

## 版本历史

### v2.3.4 (2025-11-05) - 快速筛选增强
- ✅ **新增"后一天"筛选**：添加后一天快速筛选按钮
- ✅ 快速筛选按钮布局优化：前一天、本周、本月、后一天（4列布局）
- ✅ 按钮样式调整：改为垂直布局，图标和文字上下排列
- ✅ 使用紫色渐变配色方案为"后一天"按钮
- ✅ 使用 calendar-plus 图标表示后一天
- ✅ 提升日期筛选的灵活性和便捷性

### v2.3.3 (2025-11-05) - 司机端界面优化
- ✅ **优化数据统计界面**：重新设计快速筛选布局
- ✅ 将快速筛选按钮（前一天、本周、本月）移到筛选条件外面
- ✅ 隐藏详细筛选条件，简化界面操作
- ✅ 快速筛选按钮更加醒目，操作更便捷
- ✅ 提升司机端用户体验

### v2.3.2 (2025-11-05) - 用户界面优化
- ✅ **修复标签重复问题**：解决用户管理中司机标签重复显示的问题
- ✅ 优化标签显示逻辑：司机角色只显示具体类型（带车司机/纯司机）
- ✅ 避免同时显示"司机"和"纯司机"两个标签
- ✅ 提升用户界面的清晰度和专业性

### v2.3.1 (2025-11-05) - 智能预加载
- ✅ **智能预加载功能**：添加数据预加载机制
- ✅ 在程序空闲时自动预加载其他仓库数据
- ✅ 延迟1秒后开始预加载，不影响当前页面加载
- ✅ 预加载数据存入缓存，切换仓库时秒开
- ✅ 预加载失败静默处理，不影响正常使用
- ✅ 管理端和超级管理端同步支持
- ✅ 显著提升仓库切换体验

### v2.3.0 (2025-11-05) - 性能优化
- ✅ **重大性能优化**：优化计件报表数据加载速度
- ✅ 新增批量查询考勤数据API（`getBatchDriverAttendanceStats`）
- ✅ 将原来的N次数据库查询优化为2次批量查询
- ✅ 管理端和超级管理端加载速度提升约10-20倍
- ✅ 优化前：每个司机2次查询（20个司机=40次查询）
- ✅ 优化后：所有司机共2次批量查询
- ✅ 添加错误处理，提升系统稳定性

### v2.2.9 (2025-11-05)
- ✅ 在排序按钮中添加升序/降序文字提示
- ✅ 每个排序按钮显示格式：今天 (降序)、本周 (升序) 等
- ✅ 让用户更直观地了解当前的排序方向
- ✅ 同时优化管理端和超级管理端的显示

### v2.2.8 (2025-11-05)
- ✅ 优化排序按钮视觉效果和交互体验
- ✅ 所有排序按钮始终显示箭头图标，增强视觉识别度
- ✅ 当前选中的按钮根据排序方向显示向上/向下箭头
- ✅ 添加点击反馈效果（active:scale-95），让用户清楚知道按钮被点击
- ✅ 添加过渡动画效果（transition-all），提升交互流畅度
- ✅ 同时优化管理端和超级管理端的排序按钮

### v2.2.7 (2025-11-05)
- ✅ 优化计件报表排序功能
- ✅ 移除"按达标率排序"和"按件数排序"选项
- ✅ 新增"今天"、"本周"、"本月"三个排序选项
- ✅ 每个排序选项支持升序/降序切换
- ✅ 点击当前选中的排序按钮可切换升降序
- ✅ 同时优化管理端和超级管理端的排序功能
- ✅ 使用日历图标增强视觉识别度

### v2.2.6 (2025-11-05)
- ✅ 修复计件报表日均件数计算逻辑
- ✅ 日均件数现在正确计算为：本月总件数 / 本月天数
- ✅ 显示"本月 N 天平均"，更清晰地说明计算方式
- ✅ 同时修复管理端和超级管理端的计算逻辑
- ✅ 移除了之前错误的"今天件数 / 今天司机数"计算方式

### v2.2.5 (2025-11-05)
- ✅ 修复计件报表今日状态计算错误
- ✅ 修复 `driverRecords is not defined` 错误
- ✅ 正确从 records 数组中过滤当前司机今天的记录
- ✅ 添加调试日志，便于追踪计件次数计算
- ✅ 确保计件次数只计算今天的记录，不包含历史记录

### v2.2.4 (2025-11-05)
- ✅ 优化计件报表今日状态标签显示
- ✅ 状态标签现在显示具体的计件次数（已记1次、已记2次等）
- ✅ 根据司机实际计件次数动态显示
- ✅ 同时优化管理端和超级管理端的显示逻辑

### v2.2.3 (2025-11-05)
- ✅ 修复计件报表今天达标率计算逻辑
- ✅ 达标率现在基于应出勤司机数计算（总司机数 - 请假司机数）
- ✅ 今天总目标 = 每日指标 × 应出勤司机数
- ✅ 达标率 = 今天完成件数 / 今天总目标 × 100%
- ✅ 同时修复管理端和超级管理端的计算逻辑

### v2.2.2 (2025-11-05)
- ✅ 计件报表新增今日状态标签
- ✅ 显示司机今日状态：已计次数/休假/未记录
- ✅ 状态标签使用醒目的颜色区分（绿色/蓝色/红色）
- ✅ 优化标签布局，状态标签显示在最右边
- ✅ 统一标签样式，与考勤管理保持一致

### v2.2.1 (2025-11-05)
- ✅ 计件报表新增出勤率显示
- ✅ 普通管理端计件报表显示出勤率百分比
- ✅ 超级管理端计件报表显示出勤率百分比
- ✅ 出勤率自动计算并四舍五入
- ✅ 优化当日出勤信息展示

### v2.2.0 (2025-11-06)
- ✅ 新增计件记录系统
- ✅ 创建计件记录表（piece_work_records）
- ✅ 新增仓库统计详情页面
- ✅ 支持查看指定仓库的考勤和计件统计
- ✅ 支持按时间范围筛选数据（最近一周、本月、全部）
- ✅ 司机工作台仓库列表可点击进入统计详情
- ✅ 展示考勤统计（出勤天数、正常天数、迟到次数、总工时）
- ✅ 展示计件统计（完成订单数、总数量、总金额、按类型统计）
- ✅ 详细记录列表展示

### v2.1.0 (2025-11-06)
- ✅ 新增司机仓库分配功能
- ✅ 支持一个司机分配到多个仓库
- ✅ 司机端显示所属仓库列表
- ✅ 打卡时只显示司机被分配的仓库
- ✅ 创建司机仓库关联表（driver_warehouses）
- ✅ 新增司机仓库分配管理页面

### v2.0.0 (2025-11-06)
- ✅ 简化考勤系统，移除GPS定位功能
- ✅ 改为仓库选择打卡方式
- ✅ 新增"是否需要打下班卡"设置
- ✅ 优化仓库管理界面
- ✅ 简化数据库表结构

### v1.3.1 (2025-11-05)
- ✅ 添加完整的位置权限检查机制
- ✅ 实现智能权限引导和用户提示
- ✅ 优化权限拒绝后的处理流程
- ✅ 添加GPS状态检查功能
- ✅ 改进权限说明和用户体验

### v1.3.0 (2025-11-05)
- ✅ 实现智能定位系统，支持多重GPS调用
- ✅ 支持百度地图API和本机GPS定位自动切换
- ✅ 添加定位方式标识和用户提示
- ✅ 提高打卡成功率和系统可用性
- ✅ 优化容错机制和降级策略

### v1.2.1 (2025-11-05)
- ✅ 集成百度地图逆地理编码API
- ✅ 打卡地址从GPS坐标升级为详细地址
- ✅ 优化错误处理和用户提示
- ✅ 添加位置权限配置

### v1.2.0 (2025-11-05)
- ✅ 新增仓库管理功能
- ✅ 新增GPS定位范围限制
- ✅ 新增考勤规则配置
- ✅ 新增自动选择最近仓库
- ✅ 新增考勤状态自动判定

### v1.1.0 (2025-11-05)
- ✅ 新增考勤打卡功能
- ✅ 新增考勤记录查询
- ✅ 新增考勤统计分析

### v1.0.0 (2025-11-05)
- ✅ 基础用户认证系统
- ✅ 多角色权限管理
- ✅ 司机、管理员、超级管理员三端界面

---

## 故障排查

### 缓存问题

如果遇到以下情况，可能是缓存问题：
- 页面显示旧的内容
- 出现 `ReferenceError: xxx is not defined` 错误
- 代码更新后没有生效

#### 快速解决方案

**方法 1：使用清理脚本（推荐）**
```bash
./clear-cache.sh
```

**方法 2：手动清理**
```bash
# 1. 停止开发服务器（Ctrl+C）
# 2. 清理缓存
rm -rf dist .temp node_modules/.cache
# 3. 重新启动
pnpm run dev:h5
```

**方法 3：清理浏览器缓存**
- 按 `F12` 打开开发者工具
- 右键点击刷新按钮
- 选择"清空缓存并硬性重新加载"

详细说明请查看：[CACHE_CLEAR_GUIDE.md](CACHE_CLEAR_GUIDE.md)

### 考勤缓存优化

考勤系统使用了智能缓存机制：
- 考勤记录缓存30分钟
- 仓库分配缓存30分钟
- 减少频繁的数据库查询
- 提升页面加载速度

详细说明请查看：[ATTENDANCE_CACHE_OPTIMIZATION.md](ATTENDANCE_CACHE_OPTIMIZATION.md)

### 其他问题

如果遇到其他问题，请查看：
- [ISSUE_RESOLUTION.md](ISSUE_RESOLUTION.md) - 问题解决报告
- [CACHE_AND_UI_UPDATES.md](CACHE_AND_UI_UPDATES.md) - 缓存优化和界面更新日志
