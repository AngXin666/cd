# æ•°æ®æ’å…¥è¯¦ç»†è¯´æ˜

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜è½¦é˜Ÿç®¡å®¶å°ç¨‹åºä¸­æ·»åŠ å¸æœºåŠŸèƒ½çš„æ•°æ®æ’å…¥æµç¨‹ï¼ŒåŒ…æ‹¬æ•°æ®æµå‘ã€è¡¨ç»“æ„ã€å­—æ®µè¯´æ˜ã€è§¦å‘å™¨é€»è¾‘ç­‰ã€‚

---

## ğŸ”„ æ•°æ®æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ·»åŠ å¸æœºæµç¨‹                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤1: å‰ç«¯è¾“å…¥éªŒè¯                                             â”‚
â”‚  - éªŒè¯æ‰‹æœºå·æ ¼å¼ï¼ˆ11ä½æ•°å­—ï¼‰                                    â”‚
â”‚  - éªŒè¯å§“åä¸ä¸ºç©º                                                â”‚
â”‚  - æ˜¾ç¤ºåŠ è½½æç¤º                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤2: è°ƒç”¨ createDriver å‡½æ•°                                   â”‚
â”‚  - è¾“å…¥å‚æ•°: phone, name                                         â”‚
â”‚  - å‡½æ•°ä½ç½®: src/db/api.ts                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤3: æ£€æŸ¥æ‰‹æœºå·æ˜¯å¦å·²å­˜åœ¨                                     â”‚
â”‚  - æŸ¥è¯¢ profiles è¡¨                                              â”‚
â”‚  - æ¡ä»¶: phone = è¾“å…¥çš„æ‰‹æœºå·                                    â”‚
â”‚  - å¦‚æœå­˜åœ¨: è¿”å› nullï¼Œæ˜¾ç¤ºé”™è¯¯æç¤º                             â”‚
â”‚  - å¦‚æœä¸å­˜åœ¨: ç»§ç»­ä¸‹ä¸€æ­¥                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤4: æ’å…¥ profiles è¡¨è®°å½•                                     â”‚
â”‚  - è¡¨å: profiles                                                â”‚
â”‚  - æ’å…¥å­—æ®µ:                                                     â”‚
â”‚    * phone: æ‰‹æœºå·                                               â”‚
â”‚    * name: å§“å                                                  â”‚
â”‚    * role: 'driver'ï¼ˆå›ºå®šå€¼ï¼‰                                    â”‚
â”‚    * login_account: '{phone}@fleet.com'                          â”‚
â”‚    * email: '{phone}@fleet.com'                                  â”‚
â”‚  - è‡ªåŠ¨ç”Ÿæˆå­—æ®µ:                                                 â”‚
â”‚    * id: UUIDï¼ˆæ•°æ®åº“è‡ªåŠ¨ç”Ÿæˆï¼‰                                  â”‚
â”‚    * created_at: å½“å‰æ—¶é—´ï¼ˆæ•°æ®åº“è‡ªåŠ¨ç”Ÿæˆï¼‰                      â”‚
â”‚    * updated_at: å½“å‰æ—¶é—´ï¼ˆæ•°æ®åº“è‡ªåŠ¨ç”Ÿæˆï¼‰                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤5: è°ƒç”¨ update_user_email å‡½æ•°                              â”‚
â”‚  - å‡½æ•°ç±»å‹: PostgreSQL å­˜å‚¨è¿‡ç¨‹ï¼ˆRPCï¼‰                          â”‚
â”‚  - è¾“å…¥å‚æ•°:                                                     â”‚
â”‚    * target_user_id: æ­¥éª¤4ç”Ÿæˆçš„ç”¨æˆ·ID                           â”‚
â”‚    * new_email: '{phone}@fleet.com'                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤6: æ’å…¥ auth.users è¡¨è®°å½•                                   â”‚
â”‚  - è¡¨å: auth.usersï¼ˆSupabase è®¤è¯è¡¨ï¼‰                           â”‚
â”‚  - æ’å…¥å­—æ®µ:                                                     â”‚
â”‚    * id: ä¸ profiles è¡¨ç›¸åŒçš„ UUID                               â”‚
â”‚    * email: '{phone}@fleet.com'                                  â”‚
â”‚    * encrypted_password: crypt('123456', gen_salt('bf'))         â”‚
â”‚    * phone: æ‰‹æœºå·                                               â”‚
â”‚    * email_confirmed_at: å½“å‰æ—¶é—´                                â”‚
â”‚    * phone_confirmed_at: å½“å‰æ—¶é—´ï¼ˆå¦‚æœæœ‰æ‰‹æœºå·ï¼‰                â”‚
â”‚    * created_at: å½“å‰æ—¶é—´                                        â”‚
â”‚    * updated_at: å½“å‰æ—¶é—´                                        â”‚
â”‚    * aud: 'authenticated'                                        â”‚
â”‚    * role: 'authenticated'                                       â”‚
â”‚    * raw_app_meta_data: '{"provider":"email","providers":["email"]}'â”‚
â”‚    * raw_user_meta_data: '{}'                                    â”‚
â”‚    * is_super_admin: false                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤7: è§¦å‘å™¨æ£€æŸ¥ï¼ˆhandle_new_userï¼‰                            â”‚
â”‚  - è§¦å‘æ—¶æœº: auth.users è¡¨ UPDATE æ“ä½œ                           â”‚
â”‚  - è§¦å‘æ¡ä»¶: confirmed_at ä» NULL å˜ä¸ºé NULL                    â”‚
â”‚  - æ“ä½œ:                                                         â”‚
â”‚    * æ£€æŸ¥ profiles è¡¨ä¸­æ˜¯å¦å·²å­˜åœ¨è¯¥ç”¨æˆ·ID                        â”‚
â”‚    * å¦‚æœå·²å­˜åœ¨: è·³è¿‡æ’å…¥ï¼Œé¿å…ä¸»é”®å†²çª                          â”‚
â”‚    * å¦‚æœä¸å­˜åœ¨: æ’å…¥ profiles è¡¨è®°å½•                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤8: è¿”å›ç»“æœ                                                 â”‚
â”‚  - æˆåŠŸ: è¿”å› Profile å¯¹è±¡                                       â”‚
â”‚  - å¤±è´¥: è¿”å› null                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤9: å‰ç«¯æ˜¾ç¤ºç»“æœ                                             â”‚
â”‚  - æˆåŠŸ: æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯å¼¹çª—                                        â”‚
â”‚    * å§“å                                                        â”‚
â”‚    * æ‰‹æœºå·ç                                                     â”‚
â”‚    * å¸æœºç±»å‹                                                    â”‚
â”‚    * ç™»å½•è´¦å·                                                    â”‚
â”‚    * é»˜è®¤å¯†ç                                                     â”‚
â”‚    * è½¦ç‰Œå·ç                                                     â”‚
â”‚  - å¤±è´¥: æ˜¾ç¤ºé”™è¯¯æç¤º                                            â”‚
â”‚  - åˆ·æ–°å¸æœºåˆ—è¡¨                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š æ•°æ®åº“è¡¨ç»“æ„

### 1. profiles è¡¨

#### è¡¨è¯´æ˜
å­˜å‚¨ç”¨æˆ·çš„åŸºæœ¬ä¿¡æ¯å’Œæ‰©å±•ä¿¡æ¯ã€‚

#### è¡¨ç»“æ„

| å­—æ®µå | ç±»å‹ | çº¦æŸ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|--------|------|
| id | uuid | PRIMARY KEY | gen_random_uuid() | ç”¨æˆ·å”¯ä¸€æ ‡è¯† |
| phone | text | UNIQUE | NULL | æ‰‹æœºå· |
| email | text | UNIQUE | NULL | é‚®ç®± |
| name | text | | NULL | å§“å |
| role | user_role | NOT NULL | 'driver' | ç”¨æˆ·è§’è‰² |
| avatar_url | text | | NULL | å¤´åƒURL |
| nickname | text | | NULL | æ˜µç§° |
| address_province | text | | NULL | çœä»½ |
| address_city | text | | NULL | åŸå¸‚ |
| address_district | text | | NULL | åŒºå¿ |
| address_detail | text | | NULL | è¯¦ç»†åœ°å€ |
| emergency_contact_name | text | | NULL | ç´§æ€¥è”ç³»äººå§“å |
| emergency_contact_phone | text | | NULL | ç´§æ€¥è”ç³»äººç”µè¯ |
| login_account | text | UNIQUE | NULL | ç™»å½•è´¦å· |
| vehicle_plate | text | | NULL | è½¦ç‰Œå· |
| join_date | date | | NULL | å…¥èŒæ—¥æœŸ |
| created_at | timestamptz | NOT NULL | now() | åˆ›å»ºæ—¶é—´ |
| updated_at | timestamptz | NOT NULL | now() | æ›´æ–°æ—¶é—´ |

#### ç”¨æˆ·è§’è‰²æšä¸¾ï¼ˆuser_roleï¼‰

```sql
CREATE TYPE user_role AS ENUM ('driver', 'manager', 'super_admin');
```

- `driver`: å¸æœº
- `manager`: æ™®é€šç®¡ç†å‘˜
- `super_admin`: è¶…çº§ç®¡ç†å‘˜

#### æ·»åŠ å¸æœºæ—¶æ’å…¥çš„å­—æ®µ

```typescript
{
  phone: '13800138000',              // æ‰‹æœºå·ï¼ˆå¿…å¡«ï¼‰
  name: 'å¼ ä¸‰',                      // å§“åï¼ˆå¿…å¡«ï¼‰
  role: 'driver',                    // è§’è‰²ï¼ˆå›ºå®šå€¼ï¼‰
  login_account: '13800138000@fleet.com',  // ç™»å½•è´¦å·ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
  email: '13800138000@fleet.com'     // é‚®ç®±ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
}
```

#### æ•°æ®åº“è‡ªåŠ¨ç”Ÿæˆçš„å­—æ®µ

```typescript
{
  id: '550e8400-e29b-41d4-a716-446655440000',  // UUIDï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
  created_at: '2025-01-10T10:30:45.456Z',      // åˆ›å»ºæ—¶é—´ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
  updated_at: '2025-01-10T10:30:45.456Z'       // æ›´æ–°æ—¶é—´ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
}
```

#### å®Œæ•´çš„æ’å…¥è®°å½•ç¤ºä¾‹

```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "phone": "13800138000",
  "email": "13800138000@fleet.com",
  "name": "å¼ ä¸‰",
  "role": "driver",
  "avatar_url": null,
  "nickname": null,
  "address_province": null,
  "address_city": null,
  "address_district": null,
  "address_detail": null,
  "emergency_contact_name": null,
  "emergency_contact_phone": null,
  "login_account": "13800138000@fleet.com",
  "vehicle_plate": null,
  "join_date": null,
  "created_at": "2025-01-10T10:30:45.456Z",
  "updated_at": "2025-01-10T10:30:45.456Z"
}
```

---

### 2. auth.users è¡¨

#### è¡¨è¯´æ˜
Supabase è®¤è¯ç³»ç»Ÿçš„ç”¨æˆ·è¡¨ï¼Œå­˜å‚¨ç™»å½•å‡­è¯å’Œè®¤è¯ä¿¡æ¯ã€‚

#### è¡¨ç»“æ„ï¼ˆä¸»è¦å­—æ®µï¼‰

| å­—æ®µå | ç±»å‹ | çº¦æŸ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|--------|------|
| id | uuid | PRIMARY KEY | | ç”¨æˆ·å”¯ä¸€æ ‡è¯†ï¼ˆä¸ profiles.id ç›¸åŒï¼‰ |
| instance_id | uuid | | | å®ä¾‹ID |
| email | text | UNIQUE | | é‚®ç®± |
| encrypted_password | text | | | åŠ å¯†åçš„å¯†ç  |
| email_confirmed_at | timestamptz | | | é‚®ç®±ç¡®è®¤æ—¶é—´ |
| phone | text | UNIQUE | | æ‰‹æœºå· |
| phone_confirmed_at | timestamptz | | | æ‰‹æœºå·ç¡®è®¤æ—¶é—´ |
| created_at | timestamptz | NOT NULL | now() | åˆ›å»ºæ—¶é—´ |
| updated_at | timestamptz | NOT NULL | now() | æ›´æ–°æ—¶é—´ |
| aud | text | | | å—ä¼—ï¼ˆaudienceï¼‰ |
| role | text | | | è§’è‰² |
| raw_app_meta_data | jsonb | | | åº”ç”¨å…ƒæ•°æ® |
| raw_user_meta_data | jsonb | | | ç”¨æˆ·å…ƒæ•°æ® |
| is_super_admin | boolean | | false | æ˜¯å¦ä¸ºè¶…çº§ç®¡ç†å‘˜ |

#### æ·»åŠ å¸æœºæ—¶æ’å…¥çš„å­—æ®µ

```typescript
{
  id: '550e8400-e29b-41d4-a716-446655440000',  // ä¸ profiles.id ç›¸åŒ
  instance_id: '00000000-0000-0000-0000-000000000000',
  email: '13800138000@fleet.com',
  encrypted_password: '$2a$10$...',  // bcrypt åŠ å¯†åçš„å¯†ç ï¼ˆ123456ï¼‰
  email_confirmed_at: '2025-01-10T10:30:45.456Z',
  phone: '13800138000',
  phone_confirmed_at: '2025-01-10T10:30:45.456Z',
  created_at: '2025-01-10T10:30:45.456Z',
  updated_at: '2025-01-10T10:30:45.456Z',
  aud: 'authenticated',
  role: 'authenticated',
  raw_app_meta_data: {
    provider: 'email',
    providers: ['email']
  },
  raw_user_meta_data: {},
  is_super_admin: false
}
```

#### å¯†ç åŠ å¯†è¯´æ˜

é»˜è®¤å¯†ç  `123456` ä½¿ç”¨ bcrypt ç®—æ³•åŠ å¯†ï¼š

```sql
extensions.crypt('123456', extensions.gen_salt('bf'))
```

- ç®—æ³•ï¼šbcrypt
- ç›å€¼ï¼šè‡ªåŠ¨ç”Ÿæˆ
- åŠ å¯†åçš„å¯†ç æ ¼å¼ï¼š`$2a$10$...`ï¼ˆ60ä¸ªå­—ç¬¦ï¼‰

---

## ğŸ”§ æ•°æ®åº“å‡½æ•°å’Œè§¦å‘å™¨

### 1. createDriver å‡½æ•°ï¼ˆå‰ç«¯ï¼‰

#### å‡½æ•°ç­¾å

```typescript
export async function createDriver(
  phone: string, 
  name: string
): Promise<Profile | null>
```

#### å‡½æ•°ä½ç½®
`src/db/api.ts`

#### å‡½æ•°é€»è¾‘

```typescript
// 1. æ£€æŸ¥æ‰‹æœºå·æ˜¯å¦å·²å­˜åœ¨
const {data: existingProfiles, error: checkError} = await supabase
  .from('profiles')
  .select('*')
  .eq('phone', phone)
  .maybeSingle()

if (existingProfiles) {
  return null  // æ‰‹æœºå·å·²å­˜åœ¨
}

// 2. æ’å…¥ profiles è¡¨è®°å½•
const {data, error} = await supabase
  .from('profiles')
  .insert({
    phone,
    name,
    role: 'driver',
    login_account: `${phone}@fleet.com`,
    email: `${phone}@fleet.com`
  })
  .select()
  .maybeSingle()

if (error || !data) {
  return null  // æ’å…¥å¤±è´¥
}

// 3. åˆ›å»º auth.users è¡¨è®°å½•
const {error: authError} = await supabase.rpc('update_user_email', {
  target_user_id: data.id,
  new_email: `${phone}@fleet.com`
})

// 4. è¿”å›ç»“æœ
return data as Profile
```

---

### 2. update_user_email å‡½æ•°ï¼ˆæ•°æ®åº“ï¼‰

#### å‡½æ•°ç­¾å

```sql
CREATE OR REPLACE FUNCTION update_user_email(
  target_user_id uuid,
  new_email text
)
RETURNS void
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public, auth, extensions
```

#### å‡½æ•°ä½ç½®
`supabase/migrations/38_update_user_email_with_default_password.sql`

#### å‡½æ•°é€»è¾‘

```sql
BEGIN
  -- 1. æ£€æŸ¥è°ƒç”¨è€…æ˜¯å¦ä¸ºè¶…çº§ç®¡ç†å‘˜
  IF NOT is_super_admin(auth.uid()) THEN
    RAISE EXCEPTION 'åªæœ‰è¶…çº§ç®¡ç†å‘˜å¯ä»¥ä¿®æ”¹ç”¨æˆ·é‚®ç®±';
  END IF;

  -- 2. æ£€æŸ¥æ–°é‚®ç®±æ˜¯å¦å·²è¢«å…¶ä»–ç”¨æˆ·ä½¿ç”¨
  IF EXISTS (
    SELECT 1 FROM auth.users 
    WHERE email = new_email 
    AND id != target_user_id
  ) THEN
    RAISE EXCEPTION 'è¯¥é‚®ç®±å·²è¢«å…¶ä»–ç”¨æˆ·ä½¿ç”¨';
  END IF;

  -- 3. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦åœ¨ auth.users è¡¨ä¸­å­˜åœ¨
  SELECT EXISTS (
    SELECT 1 FROM auth.users WHERE id = target_user_id
  ) INTO user_exists;

  IF user_exists THEN
    -- ç”¨æˆ·å­˜åœ¨ï¼Œç›´æ¥æ›´æ–°é‚®ç®±
    UPDATE auth.users
    SET 
      email = new_email,
      email_confirmed_at = now(),
      updated_at = now()
    WHERE id = target_user_id;
  ELSE
    -- ç”¨æˆ·ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°çš„ auth.users è®°å½•
    INSERT INTO auth.users (
      id,
      instance_id,
      email,
      encrypted_password,
      email_confirmed_at,
      phone,
      phone_confirmed_at,
      created_at,
      updated_at,
      aud,
      role,
      raw_app_meta_data,
      raw_user_meta_data,
      is_super_admin
    ) VALUES (
      target_user_id,
      '00000000-0000-0000-0000-000000000000',
      new_email,
      extensions.crypt('123456', extensions.gen_salt('bf')),  -- é»˜è®¤å¯†ç 
      now(),
      user_phone,
      CASE WHEN user_phone IS NOT NULL THEN now() ELSE NULL END,
      now(),
      now(),
      'authenticated',
      'authenticated',
      '{"provider":"email","providers":["email"]}',
      '{}',
      false
    )
    ON CONFLICT (id) DO UPDATE SET
      email = EXCLUDED.email,
      email_confirmed_at = EXCLUDED.email_confirmed_at,
      updated_at = EXCLUDED.updated_at;
  END IF;
END;
```

---

### 3. handle_new_user è§¦å‘å™¨

#### è§¦å‘å™¨å®šä¹‰

```sql
CREATE TRIGGER on_auth_user_confirmed
    AFTER UPDATE ON auth.users
    FOR EACH ROW
    EXECUTE FUNCTION handle_new_user();
```

#### è§¦å‘æ—¶æœº
- è¡¨ï¼š`auth.users`
- æ“ä½œï¼š`UPDATE`
- æ¡ä»¶ï¼š`confirmed_at` ä» `NULL` å˜ä¸ºé `NULL`

#### è§¦å‘å™¨å‡½æ•°

```sql
CREATE OR REPLACE FUNCTION handle_new_user()
RETURNS trigger
LANGUAGE plpgsql
SECURITY DEFINER SET search_path = public
AS $$
DECLARE
    user_count int;
    profile_exists boolean;
BEGIN
    -- åªåœ¨ confirmed_at ä» NULL â†’ é NULL æ—¶æ‰§è¡Œ
    IF OLD.confirmed_at IS NULL AND NEW.confirmed_at IS NOT NULL THEN
        -- æ£€æŸ¥ profiles è¡¨ä¸­æ˜¯å¦å·²å­˜åœ¨è¯¥ç”¨æˆ·
        SELECT EXISTS (
            SELECT 1 FROM profiles WHERE id = NEW.id
        ) INTO profile_exists;
        
        -- å¦‚æœ profiles å·²å­˜åœ¨ï¼Œè·³è¿‡æ’å…¥
        IF profile_exists THEN
            RAISE NOTICE 'âœ… profiles è®°å½•å·²å­˜åœ¨ï¼Œè·³è¿‡æ’å…¥ (id: %)', NEW.id;
            RETURN NEW;
        END IF;
        
        -- åˆ¤æ–­ profiles è¡¨é‡Œæœ‰å¤šå°‘ç”¨æˆ·
        SELECT COUNT(*) INTO user_count FROM profiles;
        
        -- æ’å…¥ profilesï¼Œé¦–ä½ç”¨æˆ·ç»™ super_admin è§’è‰²
        INSERT INTO profiles (id, phone, email, role)
        VALUES (
            NEW.id,
            NEW.phone,
            NEW.email,
            CASE WHEN user_count = 0 THEN 'super_admin'::user_role ELSE 'driver'::user_role END
        )
        ON CONFLICT (id) DO NOTHING;
        
        RAISE NOTICE 'âœ… profiles è®°å½•åˆ›å»ºæˆåŠŸ (id: %)', NEW.id;
    END IF;
    RETURN NEW;
END;
$$;
```

#### è§¦å‘å™¨é€»è¾‘è¯´æ˜

1. **è§¦å‘æ¡ä»¶æ£€æŸ¥**
   - åªåœ¨ `confirmed_at` ä» `NULL` å˜ä¸ºé `NULL` æ—¶æ‰§è¡Œ
   - è¿™é€šå¸¸å‘ç”Ÿåœ¨ç”¨æˆ·é¦–æ¬¡ç¡®è®¤é‚®ç®±æˆ–æ‰‹æœºå·æ—¶

2. **profiles å­˜åœ¨æ€§æ£€æŸ¥**
   - æ£€æŸ¥ `profiles` è¡¨ä¸­æ˜¯å¦å·²å­˜åœ¨è¯¥ç”¨æˆ·ID
   - å¦‚æœå·²å­˜åœ¨ï¼Œè·³è¿‡æ’å…¥ï¼Œé¿å…ä¸»é”®å†²çª
   - è¿™æ˜¯ä¸ºäº†è§£å†³ `createDriver` å‡½æ•°å…ˆåˆ›å»º `profiles` è®°å½•çš„æƒ…å†µ

3. **è§’è‰²åˆ†é…é€»è¾‘**
   - å¦‚æœ `profiles` è¡¨ä¸ºç©ºï¼ˆç¬¬ä¸€ä¸ªç”¨æˆ·ï¼‰ï¼Œåˆ†é… `super_admin` è§’è‰²
   - å¦åˆ™åˆ†é… `driver` è§’è‰²

4. **å†²çªå¤„ç†**
   - ä½¿ç”¨ `ON CONFLICT (id) DO NOTHING` ä½œä¸ºé¢å¤–ä¿æŠ¤
   - å³ä½¿æ£€æŸ¥å¤±è´¥ï¼Œä¹Ÿä¸ä¼šå¯¼è‡´é”™è¯¯

---

## ğŸ” æ•°æ®éªŒè¯æ–¹æ³•

### æ–¹æ³•1ï¼šæŸ¥è¯¢ profiles è¡¨

```sql
-- æŸ¥è¯¢æœ€æ–°åˆ›å»ºçš„å¸æœº
SELECT * FROM profiles 
WHERE role = 'driver' 
ORDER BY created_at DESC 
LIMIT 10;

-- æŸ¥è¯¢ç‰¹å®šæ‰‹æœºå·çš„å¸æœº
SELECT * FROM profiles 
WHERE phone = '13800138000';

-- æŸ¥è¯¢ç‰¹å®šIDçš„å¸æœº
SELECT * FROM profiles 
WHERE id = '550e8400-e29b-41d4-a716-446655440000';
```

### æ–¹æ³•2ï¼šæŸ¥è¯¢ auth.users è¡¨

```sql
-- æŸ¥è¯¢ç‰¹å®šé‚®ç®±çš„ç”¨æˆ·
SELECT id, email, phone, created_at, email_confirmed_at, phone_confirmed_at
FROM auth.users 
WHERE email = '13800138000@fleet.com';

-- æŸ¥è¯¢ç‰¹å®šIDçš„ç”¨æˆ·
SELECT id, email, phone, created_at
FROM auth.users 
WHERE id = '550e8400-e29b-41d4-a716-446655440000';
```

### æ–¹æ³•3ï¼šè”åˆæŸ¥è¯¢

```sql
-- æŸ¥è¯¢å¸æœºçš„å®Œæ•´ä¿¡æ¯ï¼ˆprofiles + auth.usersï¼‰
SELECT 
  p.id,
  p.phone,
  p.name,
  p.role,
  p.login_account,
  p.email,
  p.created_at as profile_created_at,
  a.email as auth_email,
  a.phone as auth_phone,
  a.email_confirmed_at,
  a.phone_confirmed_at,
  a.created_at as auth_created_at
FROM profiles p
LEFT JOIN auth.users a ON p.id = a.id
WHERE p.phone = '13800138000';
```

---

## âš ï¸ å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### é—®é¢˜1ï¼šæ‰‹æœºå·å·²å­˜åœ¨

#### é”™è¯¯ä¿¡æ¯
```
âš ï¸ æ‰‹æœºå·å·²å­˜åœ¨
å·²å­˜åœ¨çš„ç”¨æˆ·ID: xxx
å·²å­˜åœ¨çš„ç”¨æˆ·å§“å: xxx
âŒ åˆ›å»ºå¤±è´¥ï¼šæ‰‹æœºå·é‡å¤
```

#### åŸå› 
- æ‰‹æœºå·å·²è¢«å…¶ä»–ç”¨æˆ·ä½¿ç”¨
- `profiles` è¡¨çš„ `phone` å­—æ®µæœ‰ `UNIQUE` çº¦æŸ

#### è§£å†³æ–¹æ³•
- ä½¿ç”¨å…¶ä»–æ‰‹æœºå·
- æˆ–åˆ é™¤å·²å­˜åœ¨çš„ç”¨æˆ·ï¼ˆå¦‚æœæ˜¯æµ‹è¯•æ•°æ®ï¼‰

---

### é—®é¢˜2ï¼šprofiles ä¸»é”®å†²çª

#### é”™è¯¯ä¿¡æ¯
```
âŒ åˆ›å»º auth.users è®°å½•å¤±è´¥
é”™è¯¯ä»£ç : 23505
é”™è¯¯æ¶ˆæ¯: duplicate key value violates unique constraint "profiles_pkey"
```

#### åŸå› 
- `handle_new_user` è§¦å‘å™¨å°è¯•æ’å…¥å·²å­˜åœ¨çš„ `profiles` è®°å½•
- è§¦å‘å™¨æ²¡æœ‰æ­£ç¡®æ£€æŸ¥è®°å½•æ˜¯å¦å·²å­˜åœ¨

#### è§£å†³æ–¹æ³•
- ç¡®ä¿ `handle_new_user` è§¦å‘å™¨å·²æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬
- å‚è€ƒ `supabase/migrations/36_fix_update_user_email_check_profile_exists.sql`

---

### é—®é¢˜3ï¼šNULL åˆ—æ‰«æé”™è¯¯

#### é”™è¯¯ä¿¡æ¯
```
Scan error on column index 8, name 'email_change': 
converting NULL to string is unsupported
```

#### åŸå› 
- `auth.users` è¡¨çš„æŸäº›åˆ—ä¸èƒ½ä½¿ç”¨ç©ºå­—ç¬¦ä¸² `''`
- å¿…é¡»ä½¿ç”¨ `NULL` å€¼

#### è§£å†³æ–¹æ³•
- ç¡®ä¿ `update_user_email` å‡½æ•°å·²æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬
- å‚è€ƒ `supabase/migrations/37_fix_update_user_email_null_columns.sql`

---

### é—®é¢˜4ï¼šæƒé™ä¸è¶³

#### é”™è¯¯ä¿¡æ¯
```
âŒ æ’å…¥å¤±è´¥
é”™è¯¯ä»£ç : 42501
é”™è¯¯æ¶ˆæ¯: new row violates row-level security policy for table "profiles"
```

#### åŸå› 
- å½“å‰ç”¨æˆ·æ²¡æœ‰æ’å…¥ `profiles` è¡¨çš„æƒé™
- RLSï¼ˆRow Level Securityï¼‰ç­–ç•¥é™åˆ¶

#### è§£å†³æ–¹æ³•
- ç¡®ä¿å½“å‰ç”¨æˆ·æ˜¯è¶…çº§ç®¡ç†å‘˜
- æ£€æŸ¥ RLS ç­–ç•¥é…ç½®

---

## ğŸ“Š æ•°æ®å®Œæ•´æ€§æ£€æŸ¥

### æ£€æŸ¥1ï¼šprofiles å’Œ auth.users æ•°æ®ä¸€è‡´æ€§

```sql
-- æŸ¥æ‰¾ profiles ä¸­å­˜åœ¨ä½† auth.users ä¸­ä¸å­˜åœ¨çš„è®°å½•
SELECT p.id, p.phone, p.name, p.email
FROM profiles p
LEFT JOIN auth.users a ON p.id = a.id
WHERE a.id IS NULL
AND p.role = 'driver';

-- æŸ¥æ‰¾ auth.users ä¸­å­˜åœ¨ä½† profiles ä¸­ä¸å­˜åœ¨çš„è®°å½•
SELECT a.id, a.email, a.phone
FROM auth.users a
LEFT JOIN profiles p ON a.id = p.id
WHERE p.id IS NULL;
```

### æ£€æŸ¥2ï¼šé‚®ç®±å’Œç™»å½•è´¦å·ä¸€è‡´æ€§

```sql
-- æŸ¥æ‰¾é‚®ç®±å’Œç™»å½•è´¦å·ä¸ä¸€è‡´çš„è®°å½•
SELECT id, phone, email, login_account
FROM profiles
WHERE email != login_account
AND role = 'driver';
```

### æ£€æŸ¥3ï¼šæ‰‹æœºå·æ ¼å¼éªŒè¯

```sql
-- æŸ¥æ‰¾æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®çš„è®°å½•
SELECT id, phone, name
FROM profiles
WHERE phone !~ '^1[3-9]\d{9}$'
AND phone IS NOT NULL
AND role = 'driver';
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [è°ƒè¯•æ—¥å¿—ä½¿ç”¨æŒ‡å—](./DEBUG_LOG_GUIDE.md)
- [ç”¨æˆ·åˆ›å»ºå’Œç™»å½•æµç¨‹ä¼˜åŒ–æ€»ç»“](./USER_CREATION_AND_LOGIN_OPTIMIZATION.md)
- [å¿«é€Ÿæµ‹è¯•æŒ‡å—](./QUICK_TEST_GUIDE.md)

---

## ğŸ’¡ æœ€ä½³å®è·µ

1. **æ•°æ®éªŒè¯**
   - å‰ç«¯éªŒè¯ï¼šæ‰‹æœºå·æ ¼å¼ã€å§“åéç©º
   - åç«¯éªŒè¯ï¼šæ‰‹æœºå·å”¯ä¸€æ€§ã€æƒé™æ£€æŸ¥

2. **é”™è¯¯å¤„ç†**
   - æ•è·æ‰€æœ‰å¯èƒ½çš„é”™è¯¯
   - æä¾›æ¸…æ™°çš„é”™è¯¯æç¤º
   - è®°å½•è¯¦ç»†çš„é”™è¯¯æ—¥å¿—

3. **æ•°æ®ä¸€è‡´æ€§**
   - ç¡®ä¿ `profiles` å’Œ `auth.users` æ•°æ®åŒæ­¥
   - ä½¿ç”¨äº‹åŠ¡ä¿è¯æ•°æ®å®Œæ•´æ€§
   - å®šæœŸæ£€æŸ¥æ•°æ®ä¸€è‡´æ€§

4. **å®‰å…¨æ€§**
   - ä½¿ç”¨ bcrypt åŠ å¯†å¯†ç 
   - å®æ–½ RLS ç­–ç•¥
   - é™åˆ¶æ•æ„Ÿæ“ä½œæƒé™

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜æˆ–éœ€è¦å¸®åŠ©ï¼Œè¯·ï¼š
1. æŸ¥çœ‹è°ƒè¯•æ—¥å¿—
2. æ£€æŸ¥æ•°æ®åº“è®°å½•
3. å‚è€ƒç›¸å…³æ–‡æ¡£
4. è”ç³»å¼€å‘å›¢é˜Ÿ
