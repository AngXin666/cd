# 行驶证副页背页检验有效期识别优化

## 问题描述

用户反馈：如果行驶证副页正面的检验有效期已经过期，就需要识别副页背面的其他内容，通过背面识别最新的有效期。

## 问题分析

### 行驶证年检机制
1. **副页正面**：显示初始的检验有效期
2. **副页背面**：记录每次年检的记录
3. **过期情况**：当副页正面的检验有效期过期后，车辆进行新的年检，新的检验有效期会记录在副页背面

### 原有问题
- 只识别副页正面的检验有效期
- 不识别副页背面的最新检验有效期
- 导致已年检车辆显示过期状态

## 解决方案

### 1. 数据结构优化

#### 更新DrivingLicenseSubBackOcrResult接口
```typescript
export interface DrivingLicenseSubBackOcrResult {
  mandatory_scrap_date?: string // 强制报废期
  inspection_date?: string // 年检时间（最近一次年检日期）
  inspection_valid_until?: string // 检验有效期（最新的有效期，优先使用此字段）
}
```

**新增字段**：
- `inspection_valid_until`: 最新的检验有效期，从副页背面识别

### 2. OCR识别优化

#### 更新副页背页OCR提示词
```
请识别这张行驶证副页背页，提取以下信息并以JSON格式返回：
{
  "mandatory_scrap_date": "强制报废期(YYYY-MM-DD格式)",
  "inspection_date": "年检时间(YYYY-MM-DD格式)",
  "inspection_valid_until": "检验有效期(YYYY-MM-DD格式)"
}
注意：
1. 年检时间通常在副页背页的检验记录中，是最近一次年检的日期
2. 检验有效期是最新的检验有效期至日期，通常在年检记录的"检验有效期至"栏
3. 如果副页正面的检验有效期已过期，副页背面会有新的年检记录和新的检验有效期
4. 请优先识别最新（最下方）的年检记录
5. 如果某个字段无法识别，请返回null
6. 只返回JSON数据，不要其他说明文字
```

**关键改进**：
- 明确说明需要识别"检验有效期至"字段
- 强调识别最新（最下方）的年检记录
- 说明副页背面的有效期是最新的

### 3. 识别结果处理优化

#### 更新副页背页识别处理逻辑
```typescript
if (result) {
  setFormData((prev) => ({
    ...prev,
    mandatory_scrap_date: result.mandatory_scrap_date || prev.mandatory_scrap_date,
    inspection_date: result.inspection_date || prev.inspection_date,
    // 优先使用副页背面的检验有效期（因为它是最新的）
    inspection_valid_until: result.inspection_valid_until || prev.inspection_valid_until
  }))
  Taro.showToast({title: '副页背页识别成功', icon: 'success'})
}
```

**处理逻辑**：
- 如果副页背面识别到检验有效期，优先使用它
- 如果没有识别到，保留副页正面的检验有效期
- 确保始终使用最新的有效期

### 4. 用户提示优化

#### 更新拍照提示
```typescript
<PhotoCapture
  title="行驶证副页背页"
  description="请拍摄行驶证副页背页，包含最新的年检记录和检验有效期"
  tips={[
    '确保照片清晰',
    '包含最新的年检记录',
    '包含检验有效期至日期',
    '包含强制报废期信息',
    '如果副页正面的检验有效期已过期，背面会有新的有效期'
  ]}
/>
```

**提示改进**：
- 明确说明需要包含"检验有效期至"
- 提示用户关注最新的年检记录
- 说明过期情况下背面的重要性

## 识别流程

### 完整的识别流程
```
1. 拍摄副页正面 → 识别基本信息和初始检验有效期
   ↓
2. 拍摄副页背面 → 识别年检记录和最新检验有效期
   ↓
3. 数据合并 → 优先使用副页背面的检验有效期
   ↓
4. 显示结果 → 显示最新的检验有效期和剩余天数
```

### 数据优先级
1. **检验有效期**：副页背面 > 副页正面
2. **年检时间**：副页背面（最新记录）
3. **强制报废期**：副页背面

## 使用场景

### 场景1：新车或未过期车辆
- 副页正面的检验有效期未过期
- 副页背面可能没有年检记录
- 使用副页正面的检验有效期

### 场景2：已年检车辆（检验有效期已过期）
- 副页正面的检验有效期已过期
- 副页背面有新的年检记录
- **使用副页背面的最新检验有效期**（本次优化重点）

### 场景3：多次年检车辆
- 副页背面有多条年检记录
- OCR识别最新（最下方）的记录
- 使用最新的检验有效期

## 技术实现

### 修改的文件

#### 1. src/utils/ocrUtils.ts
- 更新`DrivingLicenseSubBackOcrResult`接口
- 添加`inspection_valid_until`字段
- 更新OCR提示词

#### 2. src/pages/driver/add-vehicle/index.tsx
- 更新副页背页识别处理逻辑
- 添加检验有效期的优先级处理
- 更新拍照提示文字

## 测试建议

### 测试用例1：新车
- 拍摄副页正面和背面
- 验证使用正面的检验有效期
- 验证剩余天数计算正确

### 测试用例2：已过期并已年检
- 拍摄副页正面（显示过期日期）
- 拍摄副页背面（显示新的年检记录）
- **验证使用背面的最新检验有效期**
- 验证剩余天数计算正确

### 测试用例3：多次年检
- 拍摄有多条年检记录的副页背面
- 验证识别最新的年检记录
- 验证使用最新的检验有效期

## 预期效果

### 识别准确性
- ✅ 正确识别副页背面的检验有效期
- ✅ 优先使用最新的检验有效期
- ✅ 准确计算剩余年检天数

### 用户体验
- ✅ 清晰的拍照提示
- ✅ 准确的识别结果
- ✅ 正确的有效期显示

### 数据完整性
- ✅ 同时保存年检时间和检验有效期
- ✅ 数据来源清晰（正面/背面）
- ✅ 支持多次年检记录

## 注意事项

### OCR识别
1. **照片质量**：确保副页背面照片清晰
2. **光线条件**：避免反光和阴影
3. **完整性**：确保年检记录完整可见
4. **最新记录**：确保最新的年检记录在照片中

### 数据处理
1. **日期格式**：统一使用YYYY-MM-DD格式
2. **空值处理**：如果识别失败，保留原有值
3. **优先级**：背面有效期 > 正面有效期
4. **验证**：识别后建议用户核对

### 边界情况
1. **无年检记录**：使用副页正面的有效期
2. **识别失败**：提示用户重新拍摄
3. **日期异常**：提示用户手动确认
4. **多条记录**：优先使用最新的

## 后续优化方向

### 智能判断
- [ ] 自动判断副页正面有效期是否过期
- [ ] 如果过期，强制要求拍摄副页背面
- [ ] 自动选择最新的有效期

### 数据验证
- [ ] 验证检验有效期的合理性
- [ ] 检查年检时间和有效期的逻辑关系
- [ ] 提示异常数据

### 用户引导
- [ ] 根据副页正面的有效期，动态调整提示
- [ ] 如果已过期，特别提示需要拍摄背面
- [ ] 显示识别到的有效期来源（正面/背面）

## 总结

本次优化解决了行驶证副页正面检验有效期过期后，无法识别副页背面最新有效期的问题。通过以下改进：

1. **数据结构**：添加副页背面的检验有效期字段
2. **OCR识别**：优化提示词，明确识别最新的检验有效期
3. **数据处理**：优先使用副页背面的有效期
4. **用户提示**：清晰说明拍摄要求

确保系统能够正确识别和显示车辆的最新检验有效期，提供准确的年检状态信息。
