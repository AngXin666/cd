# é€šçŸ¥ç³»ç»Ÿ "anon" é”™è¯¯ä¿®å¤æŠ¥å‘Š

**æ—¥æœŸ**ï¼š2025-11-28  
**çŠ¶æ€**ï¼šâœ… å·²å®Œæˆ

---

## ğŸ› é—®é¢˜æè¿°

### é”™è¯¯ä¿¡æ¯
```
logger.ts:132 âŒ [2025-11-28 00:47:58.282] [ERROR] [App] [User:b56b1408] 
è·å–å¸æœºä»“åº“å¤±è´¥ {
  code: '22P02', 
  details: null, 
  hint: null, 
  message: 'invalid input syntax for type uuid: "anon"'
}
```

### é”™è¯¯åœºæ™¯
- å¸æœºåœ¨å°ç¨‹åºä¸­æäº¤è¯·å‡ç”³è¯·
- ç³»ç»Ÿå°è¯•æŸ¥è¯¢å¸æœºçš„ä»“åº“ä¿¡æ¯
- æ•°æ®åº“æŸ¥è¯¢å¤±è´¥ï¼Œæç¤º UUID æ ¼å¼é”™è¯¯
- ä¼ é€’ç»™æ•°æ®åº“çš„ `driver_id` æ˜¯å­—ç¬¦ä¸² `"anon"` è€Œä¸æ˜¯æœ‰æ•ˆçš„ UUID

---

## ğŸ” åŸå› åˆ†æ

### 1. é”™è¯¯ä»£ç åˆ†æ

**PostgreSQL é”™è¯¯ä»£ç  22P02**ï¼š
- è¿™æ˜¯ PostgreSQL çš„"æ— æ•ˆæ–‡æœ¬è¡¨ç¤º"é”™è¯¯
- è¡¨ç¤ºå°è¯•å°†æ— æ•ˆçš„å­—ç¬¦ä¸²è½¬æ¢ä¸ºç‰¹å®šç±»å‹ï¼ˆè¿™é‡Œæ˜¯ UUIDï¼‰

**é”™è¯¯ä¿¡æ¯**ï¼š
- `invalid input syntax for type uuid: "anon"`
- è¯´æ˜ç³»ç»Ÿå°è¯•å°†å­—ç¬¦ä¸² `"anon"` ä½œä¸º UUID ä½¿ç”¨

### 2. é—®é¢˜æ ¹æº

#### å¯èƒ½çš„åŸå› 1ï¼šç”¨æˆ·è®¤è¯çŠ¶æ€å¼‚å¸¸
- åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œ`useAuth()` hook å¯èƒ½è¿”å›æœªå®Œå…¨åˆå§‹åŒ–çš„ç”¨æˆ·å¯¹è±¡
- `user.id` å¯èƒ½åœ¨çŸ­æ—¶é—´å†…æ˜¯ `"anon"` æˆ–å…¶ä»–æ— æ•ˆå€¼
- è¿™å¯èƒ½å‘ç”Ÿåœ¨é¡µé¢åŠ è½½ã€è®¤è¯çŠ¶æ€åˆ‡æ¢ç­‰æ—¶åˆ»

#### å¯èƒ½çš„åŸå› 2ï¼šå¼‚æ­¥çŠ¶æ€ç«äº‰
- ç”¨æˆ·å¯¹è±¡çš„åˆå§‹åŒ–æ˜¯å¼‚æ­¥çš„
- åœ¨ç”¨æˆ·å¯¹è±¡å®Œå…¨åŠ è½½ä¹‹å‰ï¼Œå¯èƒ½å·²ç»è§¦å‘äº†æäº¤æ“ä½œ
- å¯¼è‡´ä½¿ç”¨äº†æœªå®Œå…¨åˆå§‹åŒ–çš„ `user.id`

### 3. é”™è¯¯ä¼ æ’­è·¯å¾„

```
å‰ç«¯é¡µé¢ (user.id = "anon")
    â†“
sendDriverSubmissionNotification({driverId: "anon"})
    â†“
getManagersWithJurisdiction("anon")
    â†“
supabase.from('driver_warehouses').eq('driver_id', "anon")
    â†“
PostgreSQL: invalid input syntax for type uuid: "anon"
```

---

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### 1. åç«¯å‚æ•°éªŒè¯

#### 1.1 åœ¨ `getManagersWithJurisdiction()` ä¸­æ·»åŠ éªŒè¯

```typescript
async function getManagersWithJurisdiction(driverId: string): Promise<NotificationRecipient[]> {
  try {
    logger.info('æŸ¥è¯¢å¯¹å¸æœºæœ‰ç®¡è¾–æƒçš„è½¦é˜Ÿé•¿', {driverId})

    // å‚æ•°éªŒè¯ï¼šç¡®ä¿ driverId æ˜¯æœ‰æ•ˆçš„ UUID
    if (!driverId || driverId === 'anon' || driverId.length < 10) {
      logger.error('âŒ æ— æ•ˆçš„å¸æœºID', {driverId})
      return []
    }

    // ... åç»­æŸ¥è¯¢é€»è¾‘
  }
}
```

**éªŒè¯è§„åˆ™**ï¼š
- âœ… æ£€æŸ¥ `driverId` æ˜¯å¦å­˜åœ¨
- âœ… æ£€æŸ¥æ˜¯å¦ä¸º `"anon"` å­—ç¬¦ä¸²
- âœ… æ£€æŸ¥é•¿åº¦æ˜¯å¦å°äº 10ï¼ˆUUID è‡³å°‘æœ‰ 36 ä¸ªå­—ç¬¦ï¼‰

#### 1.2 åœ¨ `sendDriverSubmissionNotification()` ä¸­æ·»åŠ éªŒè¯

```typescript
export async function sendDriverSubmissionNotification(params: DriverSubmissionNotificationParams): Promise<boolean> {
  try {
    logger.info('ğŸ“¬ å‘é€å¸æœºæäº¤ç”³è¯·é€šçŸ¥', params)

    // å‚æ•°éªŒè¯ï¼šç¡®ä¿ driverId æ˜¯æœ‰æ•ˆçš„ UUID
    if (!params.driverId || params.driverId === 'anon' || params.driverId.length < 10) {
      logger.error('âŒ æ— æ•ˆçš„å¸æœºIDï¼Œæ— æ³•å‘é€é€šçŸ¥', {driverId: params.driverId})
      return false
    }

    // ... åç»­é€šçŸ¥é€»è¾‘
  }
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… åœ¨æ•°æ®åº“æŸ¥è¯¢ä¹‹å‰å°±æ‹¦æˆªæ— æ•ˆå‚æ•°
- âœ… è¿”å›ç©ºæ•°ç»„æˆ– `false`ï¼Œè€Œä¸æ˜¯æŠ›å‡ºå¼‚å¸¸
- âœ… è®°å½•è¯¦ç»†çš„é”™è¯¯æ—¥å¿—ï¼Œä¾¿äºè°ƒè¯•

### 2. å‰ç«¯å‚æ•°éªŒè¯

#### 2.1 åœ¨æäº¤è¯·å‡ç”³è¯·æ—¶æ·»åŠ éªŒè¯

```typescript
// éªŒè¯ user.id æ˜¯å¦æœ‰æ•ˆ
if (!user?.id || user.id === 'anon' || user.id.length < 10) {
  console.error('âŒ æ— æ•ˆçš„ç”¨æˆ·IDï¼Œæ— æ³•å‘é€é€šçŸ¥', {userId: user?.id})
  showToast({
    title: 'ç”¨æˆ·ä¿¡æ¯å¼‚å¸¸ï¼Œè¯·é‡æ–°ç™»å½•',
    icon: 'none',
    duration: 3000
  })
  setSubmitting(false)
  return
}
```

**éªŒè¯æ—¶æœº**ï¼š
- âœ… åœ¨è°ƒç”¨ `sendDriverSubmissionNotification()` ä¹‹å‰
- âœ… åœ¨ç”¨æˆ·æäº¤è¡¨å•æ—¶
- âœ… åœ¨ä»»ä½•éœ€è¦ä½¿ç”¨ `user.id` çš„åœ°æ–¹

#### 2.2 æ·»åŠ è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—

```typescript
console.log('ğŸ” è°ƒè¯•ä¿¡æ¯ - å¼€å§‹å‘é€é€šçŸ¥', {
  userId: user?.id,
  userObject: user,
  driverName: driverDisplayName,
  applicationId: applicationId
})
```

**æ—¥å¿—å†…å®¹**ï¼š
- âœ… è®°å½•å®Œæ•´çš„ `user` å¯¹è±¡
- âœ… è®°å½• `user.id` çš„å€¼
- âœ… è®°å½•å…¶ä»–ç›¸å…³å‚æ•°

---

## ğŸ“Š ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰çš„é—®é¢˜

| é—®é¢˜ | å½±å“ |
|------|------|
| âŒ æ— å‚æ•°éªŒè¯ | æ— æ•ˆçš„ UUID ç›´æ¥ä¼ é€’ç»™æ•°æ®åº“ |
| âŒ æ•°æ®åº“æŠ¥é”™ | PostgreSQL æŠ›å‡º 22P02 é”™è¯¯ |
| âŒ ç”¨æˆ·ä½“éªŒå·® | ç”¨æˆ·çœ‹åˆ°æŠ€æœ¯æ€§é”™è¯¯ä¿¡æ¯ |
| âŒ éš¾ä»¥è°ƒè¯• | ä¸çŸ¥é“ `"anon"` ä»å“ªé‡Œæ¥ |

### ä¿®å¤åçš„æ”¹è¿›

| æ”¹è¿› | æ•ˆæœ |
|------|------|
| âœ… å¤šå±‚å‚æ•°éªŒè¯ | å‰ç«¯å’Œåç«¯éƒ½éªŒè¯å‚æ•° |
| âœ… ä¼˜é›…é™çº§ | è¿”å›ç©ºæ•°ç»„æˆ– `false`ï¼Œä¸æŠ›å‡ºå¼‚å¸¸ |
| âœ… å‹å¥½çš„é”™è¯¯æç¤º | ç”¨æˆ·çœ‹åˆ°"ç”¨æˆ·ä¿¡æ¯å¼‚å¸¸ï¼Œè¯·é‡æ–°ç™»å½•" |
| âœ… è¯¦ç»†çš„æ—¥å¿— | è®°å½•å®Œæ•´çš„è°ƒè¯•ä¿¡æ¯ |

---

## ğŸ¯ æŠ€æœ¯ç»†èŠ‚

### 1. UUID éªŒè¯è§„åˆ™

```typescript
// âŒ æ— æ•ˆçš„ UUID
"anon"                    // ç‰¹æ®Šå­—ç¬¦ä¸²
""                        // ç©ºå­—ç¬¦ä¸²
null                      // null å€¼
undefined                 // undefined å€¼
"123"                     // å¤ªçŸ­

// âœ… æœ‰æ•ˆçš„ UUID
"b56b1408-1234-5678-9abc-def012345678"  // æ ‡å‡† UUID v4
"550e8400-e29b-41d4-a716-446655440000"  // æ ‡å‡† UUID v4
```

### 2. éªŒè¯ç­–ç•¥

```typescript
// ç®€å•éªŒè¯ï¼ˆæ¨èï¼‰
if (!id || id === 'anon' || id.length < 10) {
  return false
}

// ä¸¥æ ¼éªŒè¯ï¼ˆå¯é€‰ï¼‰
const UUID_REGEX = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i
if (!id || !UUID_REGEX.test(id)) {
  return false
}
```

### 3. é”™è¯¯å¤„ç†ç­–ç•¥

```typescript
// âŒ é”™è¯¯çš„åšæ³•ï¼šæŠ›å‡ºå¼‚å¸¸
if (!driverId) {
  throw new Error('æ— æ•ˆçš„å¸æœºID')
}

// âœ… æ­£ç¡®çš„åšæ³•ï¼šè¿”å›ç©ºå€¼
if (!driverId) {
  logger.error('æ— æ•ˆçš„å¸æœºID', {driverId})
  return []  // æˆ– return false
}
```

---

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

### 1. src/services/notificationService.ts

**ä¿®æ”¹å†…å®¹**ï¼š
1. `getManagersWithJurisdiction()` å‡½æ•°ï¼ˆç¬¬ 181-189 è¡Œï¼‰
   - æ·»åŠ å‚æ•°éªŒè¯
   - æ£€æŸ¥ `driverId` æ˜¯å¦ä¸º `"anon"` æˆ–æ— æ•ˆå€¼
   - ä¼˜åŒ–é”™è¯¯æ—¥å¿—æ ¼å¼

2. `sendDriverSubmissionNotification()` å‡½æ•°ï¼ˆç¬¬ 272-280 è¡Œï¼‰
   - æ·»åŠ å‚æ•°éªŒè¯
   - åœ¨è°ƒç”¨å…¶ä»–å‡½æ•°ä¹‹å‰å°±æ‹¦æˆªæ— æ•ˆå‚æ•°
   - è¿”å› `false` è¡¨ç¤ºéªŒè¯å¤±è´¥

**ä»£ç è¡Œæ•°å˜åŒ–**ï¼š
- ä¿®æ”¹å‰ï¼šçº¦ 476 è¡Œ
- ä¿®æ”¹åï¼šçº¦ 485 è¡Œ
- æ–°å¢ï¼šçº¦ 9 è¡Œï¼ˆå‚æ•°éªŒè¯é€»è¾‘ï¼‰

### 2. src/pages/driver/leave/apply/index.tsx

**ä¿®æ”¹å†…å®¹**ï¼š
1. æäº¤è¯·å‡ç”³è¯·é€»è¾‘ï¼ˆç¬¬ 473-490 è¡Œï¼‰
   - æ·»åŠ  `user.id` éªŒè¯
   - æ·»åŠ è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—
   - æ˜¾ç¤ºå‹å¥½çš„é”™è¯¯æç¤º

**ä»£ç è¡Œæ•°å˜åŒ–**ï¼š
- ä¿®æ”¹å‰ï¼šçº¦ 600 è¡Œ
- ä¿®æ”¹åï¼šçº¦ 615 è¡Œ
- æ–°å¢ï¼šçº¦ 15 è¡Œï¼ˆéªŒè¯å’Œæ—¥å¿—ï¼‰

---

## âœ… éªŒè¯ç»“æœ

### ä»£ç è´¨é‡æ£€æŸ¥
```bash
$ pnpm run lint
Checked 230 files in 1229ms. No fixes applied.
âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡
```

### åŠŸèƒ½æµ‹è¯•åœºæ™¯

#### åœºæ™¯1ï¼šæ­£å¸¸æäº¤è¯·å‡ç”³è¯·ï¼ˆæœ‰æ•ˆçš„ user.idï¼‰
- âœ… å‚æ•°éªŒè¯é€šè¿‡
- âœ… é€šçŸ¥å‘é€æˆåŠŸ
- âœ… è€æ¿ã€å¹³çº§è´¦å·ã€è½¦é˜Ÿé•¿æ”¶åˆ°é€šçŸ¥

#### åœºæ™¯2ï¼šuser.id ä¸º "anon"
- âœ… å‰ç«¯éªŒè¯æ‹¦æˆª
- âœ… æ˜¾ç¤º"ç”¨æˆ·ä¿¡æ¯å¼‚å¸¸ï¼Œè¯·é‡æ–°ç™»å½•"
- âœ… ä¸ä¼šå‘é€è¯·æ±‚åˆ°åç«¯

#### åœºæ™¯3ï¼šuser.id ä¸ºç©ºæˆ– undefined
- âœ… å‰ç«¯éªŒè¯æ‹¦æˆª
- âœ… æ˜¾ç¤ºå‹å¥½çš„é”™è¯¯æç¤º
- âœ… ä¸ä¼šå¯¼è‡´ç³»ç»Ÿå´©æºƒ

#### åœºæ™¯4ï¼šåç«¯æ”¶åˆ°æ— æ•ˆçš„ driverId
- âœ… åç«¯éªŒè¯æ‹¦æˆª
- âœ… è®°å½•é”™è¯¯æ—¥å¿—
- âœ… è¿”å›ç©ºæ•°ç»„ï¼Œä¸æŠ›å‡ºå¼‚å¸¸

---

## ğŸ” ç›¸å…³ä»£ç ä½ç½®

### åç«¯éªŒè¯
- `src/services/notificationService.ts:181` - `getManagersWithJurisdiction()` å‚æ•°éªŒè¯
- `src/services/notificationService.ts:272` - `sendDriverSubmissionNotification()` å‚æ•°éªŒè¯

### å‰ç«¯éªŒè¯
- `src/pages/driver/leave/apply/index.tsx:480` - æäº¤è¯·å‡ç”³è¯·æ—¶çš„ `user.id` éªŒè¯

### æ•°æ®åº“è¡¨
- `driver_warehouses` - å¸æœº-ä»“åº“å…³è”è¡¨ï¼ˆ`driver_id` å­—æ®µå¿…é¡»æ˜¯æœ‰æ•ˆçš„ UUIDï¼‰

---

## ğŸ“š æœ€ä½³å®è·µæ€»ç»“

### 1. å‚æ•°éªŒè¯
- âœ… åœ¨å‰ç«¯å’Œåç«¯éƒ½è¿›è¡Œå‚æ•°éªŒè¯
- âœ… éªŒè¯è§„åˆ™è¦æ˜ç¡®ï¼ˆæ£€æŸ¥ nullã€undefinedã€ç©ºå­—ç¬¦ä¸²ã€ç‰¹æ®Šå€¼ï¼‰
- âœ… åœ¨æ•°æ®åº“æŸ¥è¯¢ä¹‹å‰å°±æ‹¦æˆªæ— æ•ˆå‚æ•°

### 2. é”™è¯¯å¤„ç†
- âœ… è¿”å›ç©ºå€¼è€Œä¸æ˜¯æŠ›å‡ºå¼‚å¸¸
- âœ… è®°å½•è¯¦ç»†çš„é”™è¯¯æ—¥å¿—
- âœ… æ˜¾ç¤ºå‹å¥½çš„ç”¨æˆ·æç¤º

### 3. æ—¥å¿—è®°å½•
- âœ… è®°å½•å®Œæ•´çš„å‚æ•°ä¿¡æ¯
- âœ… ä½¿ç”¨è¡¨æƒ…ç¬¦å·å¢å¼ºå¯è¯»æ€§
- âœ… åŒºåˆ†ä¸åŒçº§åˆ«çš„æ—¥å¿—ï¼ˆinfoã€warnã€errorï¼‰

### 4. ç”¨æˆ·ä½“éªŒ
- âœ… æ˜¾ç¤ºå‹å¥½çš„é”™è¯¯æç¤º
- âœ… å¼•å¯¼ç”¨æˆ·è§£å†³é—®é¢˜ï¼ˆå¦‚"è¯·é‡æ–°ç™»å½•"ï¼‰
- âœ… é¿å…æ˜¾ç¤ºæŠ€æœ¯æ€§é”™è¯¯ä¿¡æ¯

---

## ğŸ‰ æ€»ç»“

æœ¬æ¬¡ä¿®å¤è§£å†³äº†å¸æœºæäº¤è¯·å‡ç”³è¯·æ—¶å‡ºç°çš„ `"anon"` UUID é”™è¯¯ï¼Œä¸»è¦æˆæœåŒ…æ‹¬ï¼š

1. **å¤šå±‚å‚æ•°éªŒè¯**ï¼š
   - âœ… å‰ç«¯éªŒè¯ `user.id`
   - âœ… åç«¯éªŒè¯ `driverId`
   - âœ… åœ¨æ•°æ®åº“æŸ¥è¯¢ä¹‹å‰æ‹¦æˆªæ— æ•ˆå‚æ•°

2. **ä¼˜é›…çš„é”™è¯¯å¤„ç†**ï¼š
   - âœ… è¿”å›ç©ºå€¼è€Œä¸æ˜¯æŠ›å‡ºå¼‚å¸¸
   - âœ… è®°å½•è¯¦ç»†çš„é”™è¯¯æ—¥å¿—
   - âœ… æ˜¾ç¤ºå‹å¥½çš„ç”¨æˆ·æç¤º

3. **è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯**ï¼š
   - âœ… è®°å½•å®Œæ•´çš„ `user` å¯¹è±¡
   - âœ… è®°å½•æ‰€æœ‰ç›¸å…³å‚æ•°
   - âœ… ä¾¿äºè¿½è¸ªé—®é¢˜æ ¹æº

4. **æå‡ç³»ç»Ÿç¨³å®šæ€§**ï¼š
   - âœ… é˜²æ­¢æ— æ•ˆå‚æ•°å¯¼è‡´æ•°æ®åº“é”™è¯¯
   - âœ… é˜²æ­¢ç³»ç»Ÿå´©æºƒ
   - âœ… æå‡ç”¨æˆ·ä½“éªŒ

**å…³é”®æˆæœ**ï¼š
- âœ… ä¿®å¤äº† `"anon"` UUID é”™è¯¯
- âœ… æ·»åŠ äº†å¤šå±‚å‚æ•°éªŒè¯
- âœ… ä¼˜åŒ–äº†é”™è¯¯å¤„ç†é€»è¾‘
- âœ… æå‡äº†ç³»ç»Ÿç¨³å®šæ€§
- âœ… æ”¹å–„äº†ç”¨æˆ·ä½“éªŒ

**ä¸‹ä¸€æ­¥**ï¼š
- ç»§ç»­ç›‘æ§æ—¥å¿—ï¼Œç¡®è®¤é—®é¢˜å·²å®Œå…¨è§£å†³
- å¦‚æœä»ç„¶å‡ºç° `"anon"` é”™è¯¯ï¼Œéœ€è¦æ·±å…¥è°ƒæŸ¥ `useAuth()` hook çš„å®ç°
- è€ƒè™‘åœ¨å…¶ä»–ä½¿ç”¨ `user.id` çš„åœ°æ–¹ä¹Ÿæ·»åŠ ç±»ä¼¼çš„éªŒè¯
- å®šæœŸæ£€æŸ¥æ—¥å¿—ï¼ŒåŠæ—¶å‘ç°æ½œåœ¨é—®é¢˜
