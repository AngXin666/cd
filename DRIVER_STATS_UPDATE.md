# 司机统计功能更新说明

## 更新概述

根据需求，对老板端和车队长端的司机统计显示进行了优化，将原有的"新司机"、"纯司机"、"带车司机"分类合并为更细致的分类。

## 主要变更

### 1. 新的司机分类逻辑

**原有分类：**
- 新司机
- 纯司机
- 带车司机

**新的分类：**
- **新纯司机**：注册≤7天的纯司机
- **新带车司机**：注册≤7天的带车司机
- **纯司机**：注册>7天的纯司机
- **带车司机**：注册>7天的带车司机

### 2. 判断标准

- **新司机标准**：注册时间距今≤7天
- **司机类型**：基于 `users.driver_type` 字段
  - `pure`：纯司机（不带车）
  - `with_vehicle`：带车司机

### 3. 修改的文件

#### 3.1 数据层

**文件：** `src/hooks/useDriverStats.ts`

**修改内容：**
- 扩展 `DriverStats` 接口，添加新的统计字段：
  ```typescript
  export interface DriverStats {
    totalDrivers: number
    onlineDrivers: number
    busyDrivers: number
    idleDrivers: number
    // 新增字段
    newPureDrivers: number        // 新纯司机
    newWithVehicleDrivers: number // 新带车司机
    pureDrivers: number           // 纯司机
    withVehicleDrivers: number    // 带车司机
  }
  ```

- 修改统计逻辑：
  1. 获取所有司机的详细信息（包括 `created_at` 和 `driver_type`）
  2. 计算7天前的时间戳
  3. 根据注册时间和司机类型进行分类统计

#### 3.2 UI层

**文件：** 
- `src/pages/super-admin/index.tsx`（老板端）
- `src/pages/manager/index.tsx`（车队长端）

**修改内容：**
- 在"司机实时状态"下方添加"司机分类统计"板块
- 使用不同的颜色和图标区分各类司机：
  - 新纯司机：青色（cyan）+ 星标图标
  - 新带车司机：琥珀色（amber）+ 快速卡车图标
  - 纯司机：靛蓝色（indigo）+ 账户图标
  - 带车司机：玫瑰色（rose）+ 卡车图标

#### 3.3 数据库层

**文件：** `supabase/migrations/00526_add_driver_type_to_users.sql`

**修改内容：**
- 为 `users` 表添加 `driver_type` 字段
- 设置默认值为 `'pure'`（纯司机）
- 为现有司机设置默认类型

## 视觉效果

### 司机实时状态（保持不变）
- 总数：蓝色
- 在线：绿色
- 已计件：橙色
- 未计件：紫色

### 司机分类统计（新增）
- 新纯司机：青色
- 新带车司机：琥珀色
- 纯司机：靛蓝色
- 带车司机：玫瑰色

## 使用说明

### 对于老板端
1. 登录老板账号
2. 在首页"统计概览"板块中查看
3. 可以通过仓库切换器查看不同仓库的司机统计

### 对于车队长端
1. 登录车队长账号
2. 在首页"统计概览"板块中查看
3. 可以通过仓库切换器查看不同仓库的司机统计

## 技术细节

### 统计查询优化
- 使用单次查询获取所有司机信息
- 在内存中进行分类统计，避免多次数据库查询
- 支持按仓库过滤
- 支持实时更新和缓存

### 性能考虑
- 缓存时间：30秒
- 支持手动刷新
- 实时监听数据变化（可选）

## 测试建议

1. **新司机测试**：
   - 添加新司机（注册时间≤7天）
   - 验证是否正确显示在"新纯司机"或"新带车司机"中

2. **老司机测试**：
   - 修改司机的注册时间（>7天）
   - 验证是否正确显示在"纯司机"或"带车司机"中

3. **类型切换测试**：
   - 在司机管理页面切换司机类型
   - 验证统计数据是否实时更新

4. **仓库过滤测试**：
   - 切换不同仓库
   - 验证统计数据是否正确过滤

## 注意事项

1. **数据迁移**：首次部署时，所有现有司机的 `driver_type` 将默认设置为 `'pure'`
2. **实时更新**：统计数据支持实时更新，但有30秒的缓存时间
3. **权限控制**：只有老板和车队长可以查看司机统计
4. **仓库过滤**：车队长只能看到自己管理的仓库的司机统计

## 后续优化建议

1. 添加司机类型的批量修改功能
2. 添加司机分类的趋势图表
3. 添加司机分类的导出功能
4. 添加司机分类的筛选和排序功能
