# 车辆历史记录 - 司机实名信息显示功能

## 功能概述

在车辆历史记录页面的"实名信息"标签页中，完整显示使用该车辆的司机的实名信息，包括身份证上的详细信息。

## 功能特性

### 1. 信息分类展示

历史记录页面的"实名信息"标签页现在分为三个独立区域：

#### 📱 司机基本信息
- **姓名**：司机在系统中的注册姓名
- **电话**：司机的联系电话
- **邮箱**：司机的电子邮箱（如有）

#### 🆔 身份证实名信息
- **姓名**：身份证上的真实姓名
- **身份证号**：完整的18位身份证号码
- **出生日期**：从身份证识别的出生日期
- **地址**：身份证上的户籍地址

#### 📸 证件照片
- **身份证照片**：正面和背面照片
- **驾驶证照片**：驾驶证照片

### 2. 数据来源

```
司机基本信息 ← profiles 表
身份证实名信息 ← driver_licenses 表
证件照片 ← driver_licenses 表
```

### 3. 显示逻辑

- ✅ 仅当有对应数据时才显示相应卡片
- ✅ 每个字段独立判断是否显示
- ✅ 身份证号使用小字体，支持自动换行
- ✅ 地址信息自动换行显示，适应长文本
- ✅ 使用不同颜色图标区分不同信息类型

### 4. UI 设计

```
┌─────────────────────────────────────┐
│ 🔵 司机基本信息                      │
│ ├─ 姓名: 张三                        │
│ ├─ 电话: 13800138000                │
│ └─ 邮箱: zhangsan@example.com       │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│ 🟠 身份证实名信息                    │
│ ├─ 姓名: 张三                        │
│ ├─ 身份证号: 110101199001011234     │
│ ├─ 出生日期: 1990-01-01             │
│ └─ 地址: 北京市东城区XX街道XX号     │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│ 📸 身份证照片                        │
│ [照片网格显示]                       │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│ 📸 驾驶证照片                        │
│ [照片网格显示]                       │
└─────────────────────────────────────┘
```

## 技术实现

### 1. 数据库查询优化

修改了 `getVehicleByPlateNumber()` 函数，从 `driver_licenses` 表查询完整的实名信息：

```typescript
const {data: licenseData} = await supabase
  .from('driver_licenses')
  .select(
    'id_card_photo_front, id_card_photo_back, driving_license_photo, ' +
    'id_card_name, id_card_number, id_card_address, id_card_birth_date'
  )
  .eq('driver_id', driverId)
  .maybeSingle()
```

### 2. 类型定义扩展

扩展了 `VehicleWithDriver` 接口，添加实名信息字段：

```typescript
export interface VehicleWithDriver extends Vehicle {
  driver_license?: {
    id_card_photo_front: string | null
    id_card_photo_back: string | null
    driving_license_photo: string | null
    id_card_name: string | null        // 新增
    id_card_number: string | null      // 新增
    id_card_address: string | null     // 新增
    id_card_birth_date: string | null  // 新增
  } | null
}
```

### 3. UI 组件实现

在历史记录页面中添加了独立的身份证实名信息卡片：

```tsx
{/* 身份证实名信息 */}
{vehicle.driver_license && (
  vehicle.driver_license.id_card_name ||
  vehicle.driver_license.id_card_number ||
  vehicle.driver_license.id_card_birth_date ||
  vehicle.driver_license.id_card_address
) && (
  <View className="bg-card rounded-lg p-4 shadow-sm">
    <View className="flex items-center mb-3">
      <View className="i-mdi-card-account-details text-xl text-orange-600 mr-2"></View>
      <Text className="text-lg font-bold text-foreground">身份证实名信息</Text>
    </View>
    {/* 显示各个字段 */}
  </View>
)}
```

## 使用场景

### 1. 车辆管理
- 查看使用车辆的司机真实身份信息
- 核对司机身份证信息与系统注册信息是否一致
- 满足实名制管理要求

### 2. 合规审查
- 提供完整的司机实名信息记录
- 便于监管部门核查
- 支持车队合规运营

### 3. 纠纷处理
- 发生事故或纠纷时，快速获取司机真实身份信息
- 完整的证件照片记录
- 便于联系和追溯

## 数据安全

### 隐私保护
- ⚠️ 身份证号码完整显示（未脱敏）
- ⚠️ 仅超级管理员可访问此页面
- ⚠️ 建议在生产环境中考虑添加访问日志

### 访问控制
- ✅ 需要登录认证
- ✅ 需要超级管理员权限
- ✅ 通过 RLS 策略保护数据

## 测试验证

### 测试步骤

1. **登录超级管理员账号**
   ```
   手机号: 13800000001
   验证码: 任意6位数字
   ```

2. **进入车辆管理页面**
   - 点击底部导航栏"车辆"标签

3. **查看车辆历史记录**
   - 点击任意车辆卡片
   - 进入历史记录页面

4. **切换到实名信息标签**
   - 点击"实名信息"标签
   - 查看司机基本信息
   - 查看身份证实名信息
   - 查看证件照片

### 预期结果

✅ 显示司机基本信息（姓名、电话、邮箱）  
✅ 显示身份证实名信息（姓名、身份证号、出生日期、地址）  
✅ 显示身份证照片（正面、背面）  
✅ 显示驾驶证照片  
✅ 信息布局清晰，易于阅读  
✅ 长文本自动换行显示  

## 后续优化建议

### 1. 隐私保护增强
- [ ] 身份证号中间位脱敏显示（如：110101****01011234）
- [ ] 添加"显示完整身份证号"按钮，需要二次确认
- [ ] 记录身份证号查看日志

### 2. 信息验证
- [ ] 添加身份证号格式验证
- [ ] 显示身份证号是否有效
- [ ] 显示年龄（根据身份证号计算）

### 3. 数据导出
- [ ] 支持导出司机实名信息为 PDF
- [ ] 支持打印司机信息
- [ ] 支持批量导出多个司机信息

### 4. 信息对比
- [ ] 对比系统注册姓名与身份证姓名
- [ ] 高亮显示不一致的信息
- [ ] 提供信息更新入口

## 相关文件

### 修改的文件
- `src/db/api.ts` - 数据库查询函数
- `src/db/types.ts` - 类型定义
- `src/pages/super-admin/vehicle-history/index.tsx` - 历史记录页面

### 相关数据表
- `profiles` - 司机基本信息
- `driver_licenses` - 司机证件信息
- `vehicles` - 车辆信息

## 更新日志

### 2025-11-05
- ✅ 新增身份证实名信息显示功能
- ✅ 优化信息分类展示
- ✅ 添加独立的实名信息卡片
- ✅ 完善数据查询逻辑
- ✅ 更新类型定义

---

**注意事项**：
1. 此功能涉及敏感个人信息，请确保符合当地隐私法规
2. 建议在生产环境中添加访问日志和审计功能
3. 考虑对身份证号进行脱敏处理
