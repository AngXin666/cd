# 司机类型编辑修复验证指南

## 修复内容总结

本次修复解决了超级管理端编辑用户时，选择"纯司机"或"带车司机"保存失败的问题。

### 问题根源

1. **加载用户信息时的问题**：
   - 只根据 `role` 字段判断角色
   - "纯司机"和"带车司机"的 `role` 都是 `'driver'`
   - 没有根据 `vehicle_plate` 字段来区分这两种司机类型

2. **保存用户信息时的问题**：
   - 使用空字符串 `''` 来清空车牌号
   - 数据库会将空字符串保存为空字符串，而不是 `null`
   - 导致无法正确区分"纯司机"（无车牌）和"带车司机"（有车牌）

### 修复方案

1. **加载用户信息时**：
   ```typescript
   // 根据 role 和 vehicle_plate 来判断角色索引
   if (data.role === 'driver') {
     if (data.vehicle_plate) {
       roleIndex = 1  // 带车司机
     } else {
       roleIndex = 0  // 纯司机
     }
   } else if (data.role === 'manager') {
     roleIndex = 2  // 管理员
   }
   ```

2. **保存用户信息时**：
   ```typescript
   // 使用 null 而不是空字符串
   if (selectedLabel === '纯司机') {
     finalVehiclePlate = null  // 清空车牌号
   } else if (selectedLabel === '带车司机') {
     finalVehiclePlate = vehiclePlate.trim() || null  // 保留车牌号
   } else if (selectedLabel === '管理员') {
     finalVehiclePlate = null  // 清空车牌号
   }
   ```

## 验证步骤

### 测试场景 1：编辑纯司机

1. **登录超级管理员账号**
   - 账号：`admin`
   - 密码：`123456`

2. **进入用户管理页面**
   - 点击底部导航栏的"超级管理"
   - 点击"用户管理"卡片

3. **选择一个司机用户进行编辑**
   - 找到一个司机用户（角色显示为"司机"）
   - 点击该用户的"编辑"按钮

4. **修改为纯司机**
   - 在"角色"下拉框中选择"纯司机"
   - 确保车牌号输入框为空或清空车牌号
   - 点击"保存"按钮

5. **验证结果**
   - 应该显示"保存成功"提示
   - 返回用户管理页面后，该用户的车牌号应该为空（显示"-"）
   - 再次点击"编辑"，角色应该显示为"纯司机"

### 测试场景 2：编辑带车司机

1. **选择一个司机用户进行编辑**
   - 找到一个司机用户
   - 点击该用户的"编辑"按钮

2. **修改为带车司机**
   - 在"角色"下拉框中选择"带车司机"
   - 在车牌号输入框中输入车牌号，例如：`京A12345`
   - 点击"保存"按钮

3. **验证结果**
   - 应该显示"保存成功"提示
   - 返回用户管理页面后，该用户的车牌号应该显示为输入的车牌号
   - 再次点击"编辑"，角色应该显示为"带车司机"，车牌号应该显示为输入的车牌号

### 测试场景 3：纯司机 ↔ 带车司机 切换

1. **将纯司机改为带车司机**
   - 编辑一个纯司机用户
   - 选择"带车司机"
   - 输入车牌号：`京B67890`
   - 保存并验证车牌号已保存

2. **将带车司机改为纯司机**
   - 编辑同一个用户
   - 选择"纯司机"
   - 保存并验证车牌号已清空

3. **再次改为带车司机**
   - 编辑同一个用户
   - 选择"带车司机"
   - 输入新的车牌号：`京C11111`
   - 保存并验证新车牌号已保存

### 测试场景 4：管理员角色

1. **将司机改为管理员**
   - 编辑一个带车司机用户（有车牌号）
   - 选择"管理员"
   - 保存并验证车牌号已清空

2. **将管理员改为带车司机**
   - 编辑同一个用户
   - 选择"带车司机"
   - 输入车牌号
   - 保存并验证车牌号已保存

## 调试日志

如果遇到问题，请查看浏览器控制台的日志输出：

### 加载用户信息时的日志
```
加载用户信息 - role: driver, vehicle_plate: 京A12345, 设置角色索引: 1
```

### 保存用户信息时的日志
```
=== 开始保存用户信息 ===
用户ID: xxx
选中的角色索引: 0
选中的角色标签: 纯司机
选中的角色值: driver
纯司机 - 清空车牌号（设为 null）
准备更新的数据: {
  name: "张三",
  phone: "13800138000",
  login_account: "zhangsan",
  vehicle_plate: null,
  join_date: "2024-01-01",
  role: "driver"
}
updateUserInfo 返回结果: true
✅ 保存成功！
```

## 预期行为

1. **纯司机**：
   - `role` = `'driver'`
   - `vehicle_plate` = `null`
   - 用户管理列表中车牌号显示为 `-`

2. **带车司机**：
   - `role` = `'driver'`
   - `vehicle_plate` = 实际车牌号（如 `'京A12345'`）
   - 用户管理列表中车牌号显示为实际车牌号

3. **管理员**：
   - `role` = `'manager'`
   - `vehicle_plate` = `null`
   - 用户管理列表中车牌号显示为 `-`

## 常见问题

### Q1: 保存后角色没有变化？
**A**: 请检查浏览器控制台的日志，查看 `updateUserInfo` 返回的结果。如果返回 `false`，说明数据库更新失败。

### Q2: 车牌号没有清空？
**A**: 请确认修复后的代码已经部署。检查控制台日志，应该看到"清空车牌号（设为 null）"的日志。

### Q3: 编辑页面显示的角色不正确？
**A**: 请检查控制台日志中"加载用户信息"的输出，确认 `role` 和 `vehicle_plate` 的值，以及计算出的角色索引是否正确。

## 修改的文件

1. **src/db/api.ts**
   - 更新 `updateUserInfo` 函数的类型定义
   - `vehicle_plate` 字段类型从 `string` 改为 `string | null`

2. **src/pages/super-admin/edit-user/index.tsx**
   - 修复加载用户信息时的角色判断逻辑
   - 修复保存用户信息时的车牌号处理逻辑
   - 使用 `null` 而不是空字符串来清空车牌号

## 提交记录

- **第一次提交**：修复超级管理端编辑用户时司机类型保存失败的问题
  - 提交 ID: b8aa3cf
  - 修复了角色加载和保存的基本逻辑

- **第二次提交**：修复司机类型保存问题：使用 null 而不是空字符串
  - 提交 ID: da968bd
  - 修复了车牌号清空的问题，使用 `null` 而不是空字符串
