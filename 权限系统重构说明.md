# 车队管家权限系统重构说明

## 📋 重构概述

### 重构目标
将硬编码的 RLS 策略重构为基于策略模板的动态权限引擎，提高系统的可维护性和扩展性。

### 重构时间
2025-12-01

### 备份位置
`backup/rls_policies_backup_20251201_161110/`

---

## 🏗️ 新架构设计

### 1. 核心表结构

#### permission_strategies（策略模板表）
定义可复用的权限策略模板

**字段**:
- `id`: 策略ID
- `strategy_name`: 策略名称（如：boss_full_access）
- `strategy_type`: 策略类型（all_access, managed_resources, own_data_only）
- `description`: 策略描述
- `select_rule`: SELECT 操作规则
- `insert_rule`: INSERT 操作规则
- `update_rule`: UPDATE 操作规则
- `delete_rule`: DELETE 操作规则
- `is_active`: 是否启用
- `created_at`: 创建时间
- `updated_at`: 更新时间

#### role_permission_mappings（角色权限映射表）
将角色与策略模板关联

**字段**:
- `id`: 映射ID
- `role`: 用户角色（BOSS, PEER_ADMIN, MANAGER, DRIVER）
- `strategy_id`: 关联的策略模板ID
- `resource_field`: 资源归属字段名（如：manager_id, driver_id）
- `priority`: 优先级（数字越大优先级越高）
- `is_active`: 是否启用
- `created_at`: 创建时间
- `updated_at`: 更新时间

#### resource_permissions（资源权限配置表）
为每个数据表配置权限规则

**字段**:
- `id`: 配置ID
- `table_name`: 表名
- `owner_field`: 所有者字段名（如：driver_id）
- `manager_field`: 管理者字段名（如：manager_id）
- `require_approval_status`: 是否需要审批状态检查
- `approval_status_field`: 审批状态字段名（如：status）
- `custom_rules`: 自定义规则（JSON 格式）
- `is_active`: 是否启用
- `created_at`: 创建时间
- `updated_at`: 更新时间

---

### 2. 策略模板类型

#### all_access（完全访问权限）
**适用角色**: BOSS, PEER_ADMIN

**规则**:
```sql
SELECT: is_admin(auth.uid())
INSERT: is_admin(auth.uid())
UPDATE: is_admin(auth.uid())
DELETE: is_admin(auth.uid())
```

**说明**: 允许所有操作，无任何限制

#### managed_resources（管辖资源权限）
**适用角色**: MANAGER

**规则**:
```sql
SELECT: {{manager_field}} = auth.uid() OR EXISTS (
  SELECT 1 FROM driver_warehouses dw
  JOIN warehouses w ON dw.warehouse_id = w.id
  WHERE dw.driver_id = {{owner_field}}
    AND w.manager_id = auth.uid()
)
INSERT: {{manager_field}} = auth.uid()
UPDATE: {{manager_field}} = auth.uid()
DELETE: {{manager_field}} = auth.uid()
```

**说明**: 只能操作自己管理的仓库和司机

#### own_data_only（仅自己数据权限）
**适用角色**: DRIVER

**规则**:
```sql
SELECT: {{owner_field}} = auth.uid()
INSERT: {{owner_field}} = auth.uid()
UPDATE: {{owner_field}} = auth.uid() {{approval_check}}
DELETE: {{owner_field}} = auth.uid() {{approval_check}}
```

**说明**: 只能操作自己的数据，修改和删除需要检查审批状态

---

### 3. 占位符说明

#### {{owner_field}}
资源所有者字段，从 `resource_permissions.owner_field` 获取

**示例**:
- `users` 表: `id`
- `leave_applications` 表: `driver_id`
- `vehicles` 表: `driver_id`

#### {{manager_field}}
资源管理者字段，从 `resource_permissions.manager_field` 获取

**示例**:
- `warehouses` 表: `manager_id`

#### {{approval_check}}
审批状态检查，根据 `resource_permissions.require_approval_status` 动态生成

**示例**:
```sql
-- 需要审批状态检查
AND status = 'pending'

-- 不需要审批状态检查
（空字符串）
```

---

## 🔧 核心函数

### 1. get_user_strategy(uid uuid)
**功能**: 获取用户的策略模板

**返回**:
- `strategy_name`: 策略名称
- `strategy_type`: 策略类型
- `select_rule`: SELECT 规则
- `insert_rule`: INSERT 规则
- `update_rule`: UPDATE 规则
- `delete_rule`: DELETE 规则
- `resource_field`: 资源归属字段

**示例**:
```sql
SELECT * FROM get_user_strategy('user-uuid-here');
```

### 2. build_permission_rule(p_table_name text, p_operation text, p_user_id uuid)
**功能**: 构建权限规则 SQL，替换策略模板中的占位符

**参数**:
- `p_table_name`: 表名
- `p_operation`: 操作类型（SELECT, INSERT, UPDATE, DELETE）
- `p_user_id`: 用户ID

**返回**: 权限规则 SQL 字符串

**示例**:
```sql
SELECT build_permission_rule('leave_applications', 'UPDATE', 'user-uuid-here');
-- 返回: driver_id = auth.uid() AND status = 'pending'
```

### 3. check_permission(p_user_id uuid, p_table_name text, p_operation text, p_record_id uuid)
**功能**: 检查用户是否有权限执行某个操作

**参数**:
- `p_user_id`: 用户ID
- `p_table_name`: 表名
- `p_operation`: 操作类型
- `p_record_id`: 记录ID（可选）

**返回**: boolean

**示例**:
```sql
-- 检查用户是否可以更新某条请假申请
SELECT check_permission(
  'user-uuid-here',
  'leave_applications',
  'UPDATE',
  'leave-application-uuid-here'
);
```

### 4. get_accessible_resources(p_user_id uuid, p_table_name text)
**功能**: 获取用户可访问的资源ID列表

**参数**:
- `p_user_id`: 用户ID
- `p_table_name`: 表名

**返回**: 资源ID列表

**示例**:
```sql
-- 获取用户可访问的所有请假申请
SELECT * FROM get_accessible_resources('user-uuid-here', 'leave_applications');
```

### 5. get_user_permissions_summary(p_user_id uuid)
**功能**: 获取用户在所有表上的权限摘要

**参数**:
- `p_user_id`: 用户ID

**返回**:
- `table_name`: 表名
- `can_select`: 是否可以查询
- `can_insert`: 是否可以插入
- `can_update`: 是否可以更新
- `can_delete`: 是否可以删除
- `strategy_type`: 策略类型

**示例**:
```sql
SELECT * FROM get_user_permissions_summary('user-uuid-here');
```

---

## 📊 权限映射表

| 角色 | 策略模板 | 资源归属字段 | 优先级 | 适用场景说明 |
|------|---------|-------------|--------|-------------|
| BOSS | boss_full_access | - | 100 | 所有数据表的完全控制权 |
| PEER_ADMIN | boss_full_access | - | 100 | 同BOSS权限 |
| MANAGER | manager_managed_resources | manager_id | 50 | 仅能管理自己管辖的司机/车辆 |
| DRIVER | driver_own_data_only | driver_id | 10 | 仅能操作自己相关的数据 |

---

## 🗂️ 资源权限配置

| 表名 | 所有者字段 | 管理者字段 | 需要审批检查 | 审批状态字段 |
|------|-----------|-----------|-------------|-------------|
| users | id | - | ❌ | - |
| user_roles | user_id | - | ❌ | - |
| warehouses | - | manager_id | ❌ | - |
| driver_warehouses | driver_id | - | ❌ | - |
| notifications | recipient_id | - | ❌ | - |
| leave_applications | driver_id | - | ✅ | status |
| resignation_applications | driver_id | - | ✅ | status |
| attendance_records | driver_id | - | ❌ | - |
| piece_work_records | driver_id | - | ❌ | - |
| vehicles | driver_id | - | ✅ | review_status |
| driver_licenses | driver_id | - | ❌ | - |

---

## 🚀 使用方法

### 1. 前端权限判断

```typescript
// 获取用户权限摘要
const { data: permissions } = await supabase
  .rpc('get_user_permissions_summary', {
    p_user_id: currentUserId
  });

// 检查是否可以编辑某条记录
const { data: canEdit } = await supabase
  .rpc('check_permission', {
    p_user_id: currentUserId,
    p_table_name: 'leave_applications',
    p_operation: 'UPDATE',
    p_record_id: leaveApplicationId
  });

if (canEdit) {
  // 显示编辑按钮
}
```

### 2. 获取可访问的资源

```typescript
// 获取用户可访问的所有请假申请
const { data: accessibleLeaves } = await supabase
  .rpc('get_accessible_resources', {
    p_user_id: currentUserId,
    p_table_name: 'leave_applications'
  });

// 然后查询这些记录的详细信息
const { data: leaves } = await supabase
  .from('leave_applications')
  .select('*')
  .in('id', accessibleLeaves.map(r => r.resource_id));
```

### 3. 批量检查权限

```typescript
// 批量检查多个记录的权限
const { data: batchPermissions } = await supabase
  .rpc('check_permissions_batch', {
    p_user_id: currentUserId,
    p_table_name: 'leave_applications',
    p_record_ids: leaveApplicationIds
  });

// 根据权限显示不同的操作按钮
batchPermissions.forEach(perm => {
  if (perm.can_update) {
    // 显示编辑按钮
  }
  if (perm.can_delete) {
    // 显示删除按钮
  }
});
```

---

## 🔄 迁移步骤

### 步骤1：创建核心表
执行迁移文件：`00531_refactor_permission_system_step1_create_tables.sql`

**内容**:
- 创建 `permission_strategies` 表
- 创建 `role_permission_mappings` 表
- 创建 `resource_permissions` 表
- 启用 RLS 并创建基础策略

### 步骤2：插入策略数据
执行迁移文件：`00532_refactor_permission_system_step2_insert_strategies.sql`

**内容**:
- 插入三种策略模板
- 插入角色权限映射
- 插入资源权限配置

### 步骤3：创建权限函数
执行迁移文件：`00533_refactor_permission_system_step3_create_functions.sql`

**内容**:
- 创建 `get_user_strategy` 函数
- 创建 `build_permission_rule` 函数
- 创建 `check_permission` 函数
- 创建 `get_accessible_resources` 函数
- 创建 `get_user_permissions_summary` 函数

### 步骤4：应用动态 RLS 策略（待实现）
**说明**: 这一步需要为每个表动态生成 RLS 策略，替换现有的硬编码策略

---

## ✅ 优势

### 1. 可维护性
- ✅ 权限规则集中管理，易于修改
- ✅ 策略模板可复用，减少重复代码
- ✅ 配置化管理，无需修改 SQL 代码

### 2. 扩展性
- ✅ 新增角色只需添加映射关系
- ✅ 新增表只需添加资源配置
- ✅ 新增策略模板支持更复杂的权限逻辑

### 3. 灵活性
- ✅ 支持动态调整权限规则
- ✅ 支持优先级控制
- ✅ 支持自定义规则

### 4. 可测试性
- ✅ 权限函数可独立测试
- ✅ 策略模板可验证有效性
- ✅ 权限摘要便于调试

---

## ⚠️ 注意事项

### 1. 性能考虑
- 权限函数使用 `SECURITY DEFINER` 和 `STABLE` 标记
- 建议为常用查询添加索引
- 考虑缓存用户权限摘要

### 2. 安全考虑
- 权限配置表本身需要 RLS 保护
- 只有管理员可以修改权限配置
- 所有认证用户可以查看权限配置（用于前端判断）

### 3. 兼容性考虑
- 保留原有的 `is_admin` 函数
- 逐步迁移，新功能使用新架构
- 旧功能保持兼容

### 4. 测试要求
- 测试所有角色的权限
- 测试审批状态检查
- 测试管辖范围隔离
- 测试边界情况

---

## 📝 后续工作

### 1. 应用动态 RLS 策略
为每个表动态生成 RLS 策略，替换现有的硬编码策略

### 2. 前端集成
在前端集成权限判断逻辑，根据权限显示/隐藏操作按钮

### 3. 权限审计
记录权限变更历史，便于审计和回溯

### 4. 性能优化
监控权限函数的性能，优化慢查询

### 5. 文档完善
编写详细的使用文档和最佳实践

---

## 🔙 回滚方案

如果重构后出现问题，可以执行以下步骤回滚：

### 1. 恢复原有策略
```sql
\i backup/rls_policies_backup_20251201_161110/current_rls_policies.sql
```

### 2. 删除新增表
```sql
DROP TABLE IF EXISTS role_permission_mappings CASCADE;
DROP TABLE IF EXISTS permission_strategies CASCADE;
DROP TABLE IF EXISTS resource_permissions CASCADE;
```

### 3. 删除新增函数
```sql
DROP FUNCTION IF EXISTS get_user_strategy CASCADE;
DROP FUNCTION IF EXISTS build_permission_rule CASCADE;
DROP FUNCTION IF EXISTS check_permission CASCADE;
DROP FUNCTION IF EXISTS get_accessible_resources CASCADE;
DROP FUNCTION IF EXISTS get_user_permissions_summary CASCADE;
```

---

**文档版本**: 1.0  
**创建时间**: 2025-12-01  
**适用范围**: 车队管家小程序权限系统重构  
**状态**: 进行中
