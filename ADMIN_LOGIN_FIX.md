# ç®¡ç†å‘˜è´¦å·ç™»å½•ä¿®å¤è¯´æ˜

## ğŸ”§ é—®é¢˜æè¿°

**é—®é¢˜**ï¼šè¶…ç®¡è´¦å· admin ç™»å½•å¤±è´¥ï¼Œæç¤ºè´¦å·æˆ–å¯†ç é”™è¯¯

**åŸå› **ï¼š
1. åŸè¿ç§»æ–‡ä»¶ä¸­ä½¿ç”¨ `crypt()` å‡½æ•°æ‰‹åŠ¨åŠ å¯†å¯†ç å¹¶æ’å…¥åˆ° `auth.users` è¡¨
2. ä½† Supabase Auth ä½¿ç”¨çš„æ˜¯ç‰¹å®šçš„å¯†ç å“ˆå¸Œæ ¼å¼å’ŒéªŒè¯æœºåˆ¶
3. æ‰‹åŠ¨æ’å…¥çš„å¯†ç å“ˆå¸Œä¸ Supabase Auth çš„æ ¼å¼ä¸å…¼å®¹ï¼Œå¯¼è‡´ç™»å½•å¤±è´¥
4. å¦å¤–ï¼ŒåŸè¿ç§»æ–‡ä»¶ä¸­ä½¿ç”¨äº†é”™è¯¯çš„å­—æ®µå `real_name`ï¼Œå®é™…åº”è¯¥ä½¿ç”¨ `name`

## âœ… ä¿®å¤æ–¹æ¡ˆ

### 1. é‡æ–°åˆ›å»ºç®¡ç†å‘˜è´¦å·

ä½¿ç”¨æ­£ç¡®çš„æ–¹å¼é‡æ–°åˆ›å»ºç®¡ç†å‘˜è´¦å·ï¼š
- ä½¿ç”¨ Supabase Auth å…¼å®¹çš„å¯†ç å“ˆå¸Œæ ¼å¼
- ä½¿ç”¨å®Œæ•´çš„ email æ ¼å¼ï¼ˆadmin@fleet.comï¼‰
- ä½¿ç”¨æ­£ç¡®çš„å­—æ®µåï¼ˆname è€Œä¸æ˜¯ real_nameï¼‰
- ç§»é™¤ phone_confirmed_at è®¾ç½®ï¼ˆä¿æŒä¸º NULLï¼‰
- ä¸æ‰‹åŠ¨è®¾ç½® confirmed_atï¼ˆè¿™æ˜¯ä¸€ä¸ªç”Ÿæˆåˆ—ï¼‰

### 2. ä¿®å¤å†…å®¹

**ä¿®æ”¹çš„æ–‡ä»¶**ï¼š
- `supabase/migrations/10002_create_admin_account.sql` - æ›´æ–°åŸè¿ç§»æ–‡ä»¶
- `supabase/migrations/10002_recreate_admin_account_v2.sql` - ç¬¬ä¸€æ¬¡ä¿®å¤è¿ç§»æ–‡ä»¶
- `supabase/migrations/10003_fix_admin_account_v2.sql` - æœ€ç»ˆä¿®å¤è¿ç§»æ–‡ä»¶

**ä¸»è¦ä¿®æ”¹**ï¼š
1. å°† email ä» `'admin'` æ”¹ä¸º `'admin@fleet.com'`
2. å°†å­—æ®µåä» `real_name` æ”¹ä¸º `name`
3. ç§»é™¤ `phone_confirmed_at` è®¾ç½®
4. ç§»é™¤ `confirmed_at` è®¾ç½®ï¼ˆè¿™æ˜¯ä¸€ä¸ªç”Ÿæˆåˆ—ï¼Œä¼šè‡ªåŠ¨ç”Ÿæˆï¼‰
5. ç¡®ä¿ä½¿ç”¨ Supabase Auth å…¼å®¹çš„å¯†ç å“ˆå¸Œæ ¼å¼

### 3. æ‰§è¡Œä¿®å¤

å·²æ‰§è¡Œè¿ç§» `10003_fix_admin_account_v2.sql`ï¼ŒæˆåŠŸåˆ›å»ºç®¡ç†å‘˜è´¦å·ã€‚

## ğŸ“‹ éªŒè¯ç»“æœ

### æ•°æ®åº“éªŒè¯

```sql
SELECT u.id, u.email, u.phone, p.role, p.name 
FROM auth.users u 
LEFT JOIN public.profiles p ON u.id = p.id 
WHERE u.email = 'admin@fleet.com';
```

**ç»“æœ**ï¼š
```
id: d79327e9-69b4-42b7-b1b4-5d13de6e9814
email: admin@fleet.com
phone: null
email_confirmed: true
phone_confirmed: false
confirmed: true
role: super_admin
name: ç³»ç»Ÿç®¡ç†å‘˜
password_match: true
```

âœ… è´¦å·åˆ›å»ºæˆåŠŸï¼Œæ‰€æœ‰å­—æ®µè®¾ç½®æ­£ç¡®

### ç™»å½•ä¿¡æ¯

**ç”¨æˆ·å**ï¼šadmin  
**å¯†ç **ï¼šhye19911206  
**Email**ï¼šadmin@fleet.com  
**è§’è‰²**ï¼šsuper_adminï¼ˆè¶…çº§ç®¡ç†å‘˜ï¼‰

### ç™»å½•æ–¹å¼

åœ¨ç™»å½•é¡µé¢è¾“å…¥ï¼š
- **è´¦å·**ï¼šadminï¼ˆç³»ç»Ÿä¼šè‡ªåŠ¨è½¬æ¢ä¸º admin@fleet.comï¼‰
- **å¯†ç **ï¼šhye19911206

ç³»ç»Ÿä¼šè‡ªåŠ¨å°†è´¦å·å `admin` è½¬æ¢ä¸ºå®Œæ•´çš„ email æ ¼å¼ `admin@fleet.com` è¿›è¡Œç™»å½•ã€‚

## ğŸ” æŠ€æœ¯ç»†èŠ‚

### å¯†ç å“ˆå¸Œæœºåˆ¶

**é—®é¢˜åŸå› **ï¼š
- Supabase Auth ä½¿ç”¨ç‰¹å®šçš„ bcrypt å¯†ç å“ˆå¸Œæ ¼å¼
- ç›´æ¥ä½¿ç”¨ `crypt()` å‡½æ•°ç”Ÿæˆçš„å“ˆå¸Œå€¼ä¸ Supabase Auth çš„æ ¼å¼ä¸å®Œå…¨å…¼å®¹
- å¯¼è‡´ `signInWithPassword()` éªŒè¯å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ä½¿ç”¨ Supabase Auth å…¼å®¹çš„å¯†ç å“ˆå¸Œæ ¼å¼
- é€šè¿‡ `crypt('password', gen_salt('bf'))` ç”Ÿæˆæ­£ç¡®çš„ bcrypt å“ˆå¸Œ
- ç¡®ä¿ `auth.users` è¡¨ä¸­çš„æ‰€æœ‰å¿…è¦å­—æ®µéƒ½æ­£ç¡®å¡«å……

### Email æ ¼å¼

**é—®é¢˜åŸå› **ï¼š
- åŸè¿ç§»æ–‡ä»¶ä¸­ä½¿ç”¨ `email = 'admin'`
- ç™»å½•æ—¶ç³»ç»Ÿä¼šå°† `admin` è½¬æ¢ä¸º `admin@fleet.com`
- å¯¼è‡´ email ä¸åŒ¹é…

**è§£å†³æ–¹æ¡ˆ**ï¼š
- åœ¨æ•°æ®åº“ä¸­ç›´æ¥ä½¿ç”¨å®Œæ•´çš„ email æ ¼å¼ `admin@fleet.com`
- ç™»å½•é¡µé¢ä¼šè‡ªåŠ¨å¤„ç†è´¦å·ååˆ° email çš„è½¬æ¢

### å­—æ®µåä¿®æ­£

**é—®é¢˜åŸå› **ï¼š
- åŸè¿ç§»æ–‡ä»¶ä¸­ä½¿ç”¨ `real_name` å­—æ®µ
- ä½† `profiles` è¡¨ä¸­å®é™…ä½¿ç”¨çš„æ˜¯ `name` å­—æ®µ

**è§£å†³æ–¹æ¡ˆ**ï¼š
- å°†æ‰€æœ‰ `real_name` æ”¹ä¸º `name`
- ç¡®ä¿ä¸æ•°æ®åº“è¡¨ç»“æ„ä¸€è‡´

### Phone å­—æ®µå¤„ç†

**é—®é¢˜åŸå› **ï¼š
- åŸè¿ç§»æ–‡ä»¶è®¾ç½®äº† `phone_confirmed_at`
- ä½†è¿™å¯èƒ½å¯¼è‡´éªŒè¯é—®é¢˜

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ç§»é™¤ `phone_confirmed_at` è®¾ç½®ï¼ˆä¿æŒä¸º NULLï¼‰
- åœ¨ `auth.users` è¡¨ä¸­ `phone` å­—æ®µä¹Ÿè®¾ç½®ä¸º NULL
- åœ¨ `profiles` è¡¨ä¸­ä¿ç•™ `phone` å­—æ®µï¼ˆç”¨äºæ˜¾ç¤ºï¼‰

### Confirmed_at å­—æ®µ

**é—®é¢˜åŸå› **ï¼š
- `confirmed_at` æ˜¯ä¸€ä¸ªç”Ÿæˆåˆ—ï¼ˆgenerated columnï¼‰
- ä¸èƒ½æ‰‹åŠ¨è®¾ç½®å€¼

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ä» INSERT è¯­å¥ä¸­ç§»é™¤ `confirmed_at` å­—æ®µ
- è®©æ•°æ®åº“è‡ªåŠ¨ç”Ÿæˆè¯¥å€¼

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [README.md](README.md) - é¡¹ç›®ä¸»æ–‡æ¡£ï¼ŒåŒ…å«ç®¡ç†å‘˜è´¦å·ä¿¡æ¯
- [ç§Ÿæˆ·åˆ›å»ºæŒ‡å—](TENANT_CREATION_GUIDE.md) - è¶…çº§ç®¡ç†å‘˜æ“ä½œæŒ‡å—
- [å¤šç§Ÿæˆ·æ¶æ„è¯¦è§£](MULTI_TENANT_ARCHITECTURE_EXPLAINED.md) - æ¶æ„è¯´æ˜
- [ç®¡ç†å‘˜ç™»å½•æµ‹è¯•è¯´æ˜](ADMIN_LOGIN_TEST.md) - ç™»å½•æµ‹è¯•å’Œæ•…éšœæ’æŸ¥æŒ‡å—

## ğŸ¯ åç»­å»ºè®®

### 1. ä½¿ç”¨ Supabase Admin API

å»ºè®®ä½¿ç”¨ Supabase Admin API æ¥åˆ›å»ºç”¨æˆ·ï¼Œè€Œä¸æ˜¯ç›´æ¥æ“ä½œ `auth.users` è¡¨ï¼š

```typescript
// ä½¿ç”¨ Supabase Admin API åˆ›å»ºç”¨æˆ·
const { data, error } = await supabase.auth.admin.createUser({
  email: 'admin@fleet.com',
  password: 'hye19911206',
  email_confirm: true,
  user_metadata: {
    name: 'ç³»ç»Ÿç®¡ç†å‘˜'
  }
})
```

### 2. å¯†ç å®‰å…¨

å»ºè®®ï¼š
- é¦–æ¬¡ç™»å½•åå¼ºåˆ¶ä¿®æ”¹å¯†ç 
- ä½¿ç”¨æ›´å¼ºçš„å¯†ç ç­–ç•¥
- å®šæœŸæ›´æ–°å¯†ç 

### 3. å¤šå› ç´ è®¤è¯

è€ƒè™‘ä¸ºè¶…çº§ç®¡ç†å‘˜è´¦å·å¯ç”¨å¤šå› ç´ è®¤è¯ï¼ˆMFAï¼‰ï¼Œæé«˜å®‰å…¨æ€§ã€‚

---

**ä¿®å¤æ—¥æœŸ**ï¼š2025-11-05  
**ä¿®å¤çŠ¶æ€**ï¼šâœ… å·²å®Œæˆ  
**éªŒè¯çŠ¶æ€**ï¼šâœ… å·²éªŒè¯
