# 普通管理端司机管理功能说明

## 功能概述

为普通管理端添加了司机管理功能，允许普通管理员为司机分配自己负责的仓库。该功能与超级管理端的司机分配功能类似，但具有权限限制，确保普通管理员只能管理自己负责的仓库。

---

## 功能特点

### 1. 权限控制

普通管理员的司机管理功能具有以下权限限制：

- **仓库范围限制**：只能看到和分配自己负责的仓库
- **数据隔离**：不影响其他管理员对同一司机的仓库分配
- **保留其他分配**：保存时会保留司机在其他仓库的分配关系

#### 权限对比

| 功能 | 超级管理员 | 普通管理员 |
|------|-----------|-----------|
| 查看所有仓库 | ✅ | ❌ |
| 查看负责的仓库 | ✅ | ✅ |
| 分配所有仓库 | ✅ | ❌ |
| 分配负责的仓库 | ✅ | ✅ |
| 覆盖其他管理员的分配 | ✅ | ❌ |

---

## 使用流程

### 1. 进入司机管理

在普通管理端首页，点击"快捷功能"板块中的"司机管理"按钮：

```
快捷功能
├── 件数报表
├── 请假审批
├── 品类配置
└── 司机管理 ← 点击这里
```

### 2. 选择司机

在司机列表中选择要分配仓库的司机：

- 显示所有司机的列表
- 每个司机显示姓名和联系方式
- 点击司机卡片进行选择
- 选中的司机会高亮显示

### 3. 分配仓库

选择司机后，为其分配仓库：

- 显示管理员负责的所有仓库
- 使用复选框勾选要分配的仓库
- 可以同时选择多个仓库
- 显示仓库的启用/禁用状态

### 4. 保存分配

点击"保存分配"按钮完成操作：

- 系统会合并司机在其他仓库的分配
- 只更新管理员负责的仓库分配
- 显示保存成功或失败的提示

---

## 页面结构

### 页面标题区域

```tsx
┌─────────────────────────────────────┐
│ 司机管理                             │
│ 为司机分配您负责的仓库                │
└─────────────────────────────────────┘
```

- 使用蓝色渐变背景
- 显示页面标题和说明文字

### 司机列表区域

```tsx
┌─────────────────────────────────────┐
│ 👥 选择司机                          │
├─────────────────────────────────────┤
│ ┌─────────────────────────────────┐ │
│ │ 👤 张三                          │ │
│ │    13800138000                   │ │
│ └─────────────────────────────────┘ │
│ ┌─────────────────────────────────┐ │
│ │ 👤 李四                    ✓     │ │
│ │    13900139000                   │ │
│ └─────────────────────────────────┘ │
└─────────────────────────────────────┘
```

- 显示所有司机列表
- 选中的司机高亮显示
- 显示选中标记

### 仓库分配区域

```tsx
┌─────────────────────────────────────┐
│ 🏢 分配仓库                          │
├─────────────────────────────────────┤
│ 当前司机：李四                       │
├─────────────────────────────────────┤
│ ☑ 北京仓库              [启用]      │
│ ☐ 上海仓库              [启用]      │
│ ☑ 广州仓库              [禁用]      │
└─────────────────────────────────────┘
```

- 显示管理员负责的仓库
- 使用复选框进行选择
- 显示仓库状态

### 保存按钮区域

```tsx
┌─────────────────────────────────────┐
│        💾 保存分配                   │
└─────────────────────────────────────┘
```

- 蓝色背景按钮
- 点击时有缩放效果
- 加载时显示禁用状态

### 操作提示区域

```tsx
┌─────────────────────────────────────┐
│ ℹ️ 操作提示                          │
│ 1. 先选择要分配仓库的司机             │
│ 2. 勾选该司机可以工作的仓库           │
│ 3. 点击保存按钮完成分配               │
│ 4. 您只能分配自己负责的仓库           │
└─────────────────────────────────────┘
```

- 黄色背景提示框
- 显示操作步骤
- 强调权限限制

---

## 技术实现

### 1. 页面文件

**主页面**：`src/pages/manager/driver-management/index.tsx`

```tsx
// 主要功能
- 加载司机列表
- 加载管理员负责的仓库
- 加载司机当前的仓库分配
- 保存仓库分配（合并其他管理员的分配）
```

**页面配置**：`src/pages/manager/driver-management/index.config.ts`

```tsx
export default definePageConfig({
  navigationBarTitleText: '司机管理',
  enableShareAppMessage: false
})
```

### 2. 路由配置

在 `src/app.config.ts` 中添加路由：

```tsx
const pages = [
  // ... 其他路由
  'pages/manager/driver-management/index',
  // ...
]
```

### 3. 入口配置

在 `src/pages/manager/index.tsx` 中添加入口：

```tsx
// 处理函数
const handleDriverManagement = () => {
  navigateTo({url: '/pages/manager/driver-management/index'})
}

// UI入口
<View
  onClick={handleDriverManagement}
  className="bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg p-4 flex flex-col items-center active:scale-95 transition-all">
  <View className="i-mdi-account-group text-3xl text-purple-600 mb-2" />
  <Text className="text-xs text-gray-700 font-medium">司机管理</Text>
</View>
```

### 4. 数据库操作

使用以下API函数：

```tsx
// 获取所有用户资料
getAllProfiles()

// 获取管理员负责的仓库
getManagerWarehouses(managerId)

// 获取司机的仓库分配
getDriverWarehouseIds(driverId)

// 设置司机的仓库分配
setDriverWarehouses(driverId, warehouseIds)
```

### 5. 权限控制逻辑

```tsx
// 1. 加载管理员负责的仓库
const loadWarehouses = async () => {
  const data = await getManagerWarehouses(user.id)
  setWarehouses(data)
}

// 2. 过滤司机的仓库分配
const loadDriverWarehouses = async (driverId) => {
  const warehouseIds = await getDriverWarehouseIds(driverId)
  const managerWarehouseIds = warehouses.map(w => w.id)
  const filteredIds = warehouseIds.filter(id => 
    managerWarehouseIds.includes(id)
  )
  setSelectedWarehouseIds(filteredIds)
}

// 3. 保存时合并其他管理员的分配
const handleSave = async () => {
  // 获取司机当前所有的仓库分配
  const allWarehouseIds = await getDriverWarehouseIds(selectedDriver.id)
  
  // 移除管理员负责的仓库
  const managerWarehouseIds = warehouses.map(w => w.id)
  const otherWarehouseIds = allWarehouseIds.filter(id => 
    !managerWarehouseIds.includes(id)
  )
  
  // 合并：其他仓库 + 管理员新分配的仓库
  const finalWarehouseIds = [...otherWarehouseIds, ...selectedWarehouseIds]
  
  // 保存
  await setDriverWarehouses(selectedDriver.id, finalWarehouseIds)
}
```

---

## 使用场景

### 场景1：新司机入职

**情况**：新司机加入车队，需要分配工作仓库

**操作流程**：
1. 管理员进入司机管理页面
2. 选择新入职的司机
3. 勾选该司机可以工作的仓库
4. 点击保存完成分配

**结果**：司机可以在被分配的仓库进行打卡和工作

### 场景2：司机调整工作仓库

**情况**：司机需要调整工作仓库，增加或减少仓库

**操作流程**：
1. 管理员进入司机管理页面
2. 选择需要调整的司机
3. 修改仓库勾选状态
4. 点击保存更新分配

**结果**：司机的工作仓库范围得到调整

### 场景3：多管理员协作

**情况**：一个司机同时在多个管理员负责的仓库工作

**操作流程**：
1. 管理员A为司机分配仓库A1、A2
2. 管理员B为司机分配仓库B1、B2
3. 两个管理员的分配互不影响

**结果**：司机可以在A1、A2、B1、B2四个仓库工作

### 场景4：管理员权限变更

**情况**：管理员负责的仓库发生变化

**操作流程**：
1. 超级管理员调整管理员负责的仓库
2. 管理员重新进入司机管理页面
3. 只能看到新负责的仓库
4. 只能分配新负责的仓库

**结果**：管理员的权限范围得到更新

---

## 与超级管理端的区别

### 功能对比

| 功能项 | 超级管理端 | 普通管理端 |
|--------|-----------|-----------|
| 页面路径 | `/pages/super-admin/driver-warehouse-assignment/index` | `/pages/manager/driver-management/index` |
| 页面标题 | 司机仓库分配 | 司机管理 |
| 仓库范围 | 所有仓库 | 管理员负责的仓库 |
| 分配权限 | 可以分配所有仓库 | 只能分配负责的仓库 |
| 数据操作 | 直接覆盖所有分配 | 合并其他管理员的分配 |
| 提示信息 | "司机只能在被分配的仓库打卡" | "您只能分配自己负责的仓库" |

### 代码差异

**超级管理端**：
```tsx
// 直接加载所有仓库
const loadWarehouses = async () => {
  const data = await getAllWarehouses()
  setWarehouses(data)
}

// 直接保存所有分配
const handleSave = async () => {
  await setDriverWarehouses(selectedDriver.id, selectedWarehouseIds)
}
```

**普通管理端**：
```tsx
// 只加载管理员负责的仓库
const loadWarehouses = async () => {
  const data = await getManagerWarehouses(user.id)
  setWarehouses(data)
}

// 保存时合并其他管理员的分配
const handleSave = async () => {
  const allWarehouseIds = await getDriverWarehouseIds(selectedDriver.id)
  const managerWarehouseIds = warehouses.map(w => w.id)
  const otherWarehouseIds = allWarehouseIds.filter(id => 
    !managerWarehouseIds.includes(id)
  )
  const finalWarehouseIds = [...otherWarehouseIds, ...selectedWarehouseIds]
  await setDriverWarehouses(selectedDriver.id, finalWarehouseIds)
}
```

---

## 视觉设计

### 配色方案

- **主色调**：蓝色（#1E3A8A）
- **辅助色**：紫色（用于入口按钮）
- **状态色**：
  - 绿色：启用状态
  - 灰色：禁用状态
  - 黄色：提示信息

### 图标使用

- **司机管理入口**：`i-mdi-account-group`（紫色）
- **选择司机标题**：`i-mdi-account-group`（蓝色）
- **司机头像**：`i-mdi-account`（蓝色）
- **选中标记**：`i-mdi-check-circle`（蓝色）
- **分配仓库标题**：`i-mdi-warehouse`（蓝色）
- **保存按钮**：`i-mdi-content-save`（白色）
- **提示信息**：`i-mdi-information`（黄色）

### 交互效果

- **卡片点击**：`active:scale-95`
- **按钮点击**：`active:scale-98`
- **过渡动画**：`transition-all`
- **选中状态**：边框变蓝，背景变浅蓝

---

## 错误处理

### 1. 无仓库权限

**情况**：管理员还没有被分配任何仓库

**提示**：
```
⚠️ 暂无仓库
您还没有被分配任何仓库，无法管理司机
```

**处理**：隐藏司机列表和分配功能

### 2. 无司机数据

**情况**：系统中还没有司机用户

**提示**：
```
暂无司机
```

**处理**：显示空状态图标和文字

### 3. 未选择司机

**情况**：用户直接点击保存按钮

**提示**：
```
请先选择司机
```

**处理**：显示Toast提示，不执行保存操作

### 4. 保存失败

**情况**：网络错误或数据库错误

**提示**：
```
保存失败
```

**处理**：显示错误Toast，保持当前状态

---

## 最佳实践

### 1. 权限管理

- 始终检查管理员的仓库权限
- 不要显示管理员无权访问的数据
- 保存时合并其他管理员的分配

### 2. 用户体验

- 提供清晰的操作提示
- 显示加载状态
- 提供即时反馈
- 使用视觉反馈增强交互

### 3. 数据一致性

- 页面显示时刷新数据
- 保存前验证数据
- 保存后显示结果
- 处理并发修改

### 4. 性能优化

- 使用useCallback缓存函数
- 避免不必要的重新渲染
- 合理使用useEffect依赖

---

## 测试场景

### 1. 基本功能测试

- [ ] 页面正常加载
- [ ] 司机列表正常显示
- [ ] 仓库列表正常显示
- [ ] 选择司机功能正常
- [ ] 勾选仓库功能正常
- [ ] 保存功能正常

### 2. 权限测试

- [ ] 只显示管理员负责的仓库
- [ ] 不显示其他管理员的仓库
- [ ] 保存时不影响其他仓库的分配
- [ ] 无仓库权限时显示提示

### 3. 边界测试

- [ ] 无司机时显示空状态
- [ ] 无仓库时显示提示
- [ ] 未选择司机时保存提示
- [ ] 网络错误时显示错误

### 4. 交互测试

- [ ] 点击司机卡片高亮显示
- [ ] 复选框状态正确切换
- [ ] 保存按钮点击效果正常
- [ ] 加载状态正确显示

---

## 常见问题

### Q1: 为什么我看不到某些仓库？

**A**: 普通管理员只能看到自己负责的仓库。如果需要管理其他仓库的司机，请联系超级管理员分配仓库权限。

### Q2: 我的分配会影响其他管理员吗？

**A**: 不会。系统会自动合并所有管理员的分配，您的操作只会影响您负责的仓库。

### Q3: 如何取消司机的仓库分配？

**A**: 选择司机后，取消勾选对应的仓库，然后点击保存即可。

### Q4: 司机可以在多个仓库工作吗？

**A**: 可以。司机可以被分配到多个仓库，可以在任何被分配的仓库进行打卡和工作。

### Q5: 保存失败怎么办？

**A**: 请检查网络连接，然后重试。如果问题持续，请联系系统管理员。

---

## 更新日志

### 2025-11-05

**新增功能**：
- ✅ 创建司机管理页面
- ✅ 添加司机列表展示
- ✅ 添加仓库分配功能
- ✅ 实现权限控制逻辑
- ✅ 添加操作提示
- ✅ 在管理端首页添加入口

**技术实现**：
- ✅ 使用getManagerWarehouses获取管理员仓库
- ✅ 保存时合并其他管理员的分配
- ✅ 添加加载状态和错误处理
- ✅ 实现响应式交互效果

**文档**：
- ✅ 创建功能说明文档
- ✅ 添加使用流程说明
- ✅ 添加技术实现说明
- ✅ 添加常见问题解答

---

## 总结

普通管理端的司机管理功能为管理员提供了便捷的司机仓库分配工具，同时通过权限控制确保了数据安全和管理规范。

### 核心价值

1. **权限隔离**：管理员只能管理自己负责的仓库
2. **数据安全**：不影响其他管理员的分配
3. **操作简便**：直观的界面和清晰的流程
4. **视觉统一**：与整体设计风格保持一致

### 技术亮点

1. **智能合并**：自动合并多个管理员的分配
2. **权限过滤**：只显示和操作有权限的数据
3. **实时刷新**：页面显示时自动刷新数据
4. **错误处理**：完善的错误提示和处理

### 用户价值

1. **提高效率**：快速为司机分配仓库
2. **降低错误**：清晰的提示减少操作失误
3. **增强体验**：流畅的交互和即时反馈
4. **保障安全**：严格的权限控制保护数据

---

**功能状态**：✅ 已完成并验证通过  
**实现时间**：2025-11-05  
**适用角色**：普通管理员  
**相关页面**：司机管理、管理端首页
