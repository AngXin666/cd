# è€ƒå‹¤ç®¡ç†å…¨åŠŸèƒ½å¤šç§Ÿæˆ·é€‚é…æ£€æŸ¥æŠ¥å‘Š

## ğŸ“‹ æ£€æŸ¥æ¦‚è¿°

å…¨é¢æ£€æŸ¥è€ƒå‹¤ç®¡ç†çš„æ‰€æœ‰åŠŸèƒ½æ˜¯å¦æ­£ç¡®é€‚é…å¤šç§Ÿæˆ·æ¶æ„ï¼ˆæ¯ä¸ªç§Ÿæˆ·ä½¿ç”¨ç‹¬ç«‹æ•°æ®åº“æ¨¡å¼ï¼‰ã€‚

## ğŸ” æ£€æŸ¥èŒƒå›´

### 1. è€ƒå‹¤è®°å½•åŠŸèƒ½
- âŒ åˆ›å»ºè€ƒå‹¤è®°å½•ï¼ˆæ‰“å¡ï¼‰
- âœ… æŸ¥è¯¢è€ƒå‹¤è®°å½•
- âœ… æ›´æ–°è€ƒå‹¤è®°å½•
- âœ… åˆ é™¤è€ƒå‹¤è®°å½•

### 2. è€ƒå‹¤è§„åˆ™åŠŸèƒ½
- âœ… åˆ›å»ºè€ƒå‹¤è§„åˆ™ï¼ˆå·²ä¿®å¤ï¼‰
- âœ… æŸ¥è¯¢è€ƒå‹¤è§„åˆ™
- âœ… æ›´æ–°è€ƒå‹¤è§„åˆ™
- âœ… åˆ é™¤è€ƒå‹¤è§„åˆ™

### 3. è€ƒå‹¤ç»Ÿè®¡åŠŸèƒ½
- âœ… å¸æœºè€ƒå‹¤ç»Ÿè®¡
- âœ… ä»“åº“è€ƒå‹¤ç»Ÿè®¡
- âœ… æœˆåº¦è€ƒå‹¤ç»Ÿè®¡

## ğŸ“Š è¯¦ç»†æ£€æŸ¥ç»“æœ

### âœ… å·²æ­£ç¡®é€‚é…çš„åŠŸèƒ½

#### 1. è€ƒå‹¤è§„åˆ™ - âœ… å·²ä¿®å¤
**å‡½æ•°**ï¼š`createAttendanceRule`  
**çŠ¶æ€**ï¼šâœ… å·²æ·»åŠ  `boss_id` å’Œ `tenant_id`

```typescript
export async function createAttendanceRule(input: AttendanceRuleInput): Promise<AttendanceRule | null> {
  // 1. è·å–å½“å‰ç”¨æˆ·
  const { data: { user } } = await supabase.auth.getUser()
  if (!user) throw new Error('ç”¨æˆ·æœªç™»å½•')

  // 2. è·å– boss_id
  const { data: profile } = await supabase
    .from('profiles')
    .select('boss_id')
    .eq('id', user.id)
    .maybeSingle()
  
  if (!profile?.boss_id) throw new Error('æ— æ³•è·å–ç”¨æˆ·ä¿¡æ¯')

  // 3. æ’å…¥è€ƒå‹¤è§„åˆ™ï¼ˆè‡ªåŠ¨æ·»åŠ  boss_id å’Œ tenant_idï¼‰
  const { data, error } = await supabase
    .from('attendance_rules')
    .insert({
      warehouse_id: input.warehouse_id,
      work_start_time: input.work_start_time,
      work_end_time: input.work_end_time,
      late_threshold: input.late_threshold || 15,
      early_threshold: input.early_threshold || 15,
      is_active: input.is_active !== undefined ? input.is_active : true,
      boss_id: profile.boss_id,
      tenant_id: profile.boss_id
    })
    .select()
    .maybeSingle()

  // ...
}
```

**æ•ˆæœ**ï¼š
- âœ… è‡ªåŠ¨æ·»åŠ  `boss_id` å’Œ `tenant_id`
- âœ… æ¯ä¸ªç§Ÿæˆ·çš„è€ƒå‹¤è§„åˆ™æ•°æ®å®Œå…¨éš”ç¦»

#### 2. æŸ¥è¯¢è€ƒå‹¤è®°å½• - âœ… ä¾èµ– RLS ç­–ç•¥
**å‡½æ•°**ï¼š
- `getTodayAttendance(userId)` - è·å–ä»Šæ—¥æ‰“å¡è®°å½•
- `getMonthlyAttendance(userId, year, month)` - è·å–æœˆåº¦è€ƒå‹¤
- `getAllAttendanceRecords(year, month)` - è·å–æ‰€æœ‰è€ƒå‹¤è®°å½•
- `getAttendanceRecordsByUserAndWarehouse(...)` - æŒ‰ç”¨æˆ·å’Œä»“åº“æŸ¥è¯¢
- `getAttendanceRecordsByWarehouse(...)` - æŒ‰ä»“åº“æŸ¥è¯¢

**RLS ç­–ç•¥**ï¼š
```sql
-- ç”¨æˆ·å¯ä»¥æŸ¥çœ‹è‡ªå·±çš„è€ƒå‹¤è®°å½•
CREATE POLICY "Users can view own attendance" ON attendance
  FOR SELECT TO authenticated
  USING ((boss_id = get_current_user_boss_id()) AND (user_id = auth.uid()));

-- ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹ç§Ÿæˆ·çš„è€ƒå‹¤è®°å½•
CREATE POLICY "Manager can view tenant attendance" ON attendance
  FOR SELECT TO authenticated
  USING ((boss_id = get_current_user_boss_id()) AND (is_admin(auth.uid()) OR is_super_admin(auth.uid())));

-- è€æ¿å¯ä»¥ç®¡ç†ç§Ÿæˆ·çš„è€ƒå‹¤è®°å½•
CREATE POLICY "Super admin can manage tenant attendance" ON attendance
  FOR ALL TO authenticated
  USING ((boss_id = get_current_user_boss_id()) AND is_super_admin(auth.uid()))
  WITH CHECK ((boss_id = get_current_user_boss_id()) AND is_super_admin(auth.uid()));
```

**æ•ˆæœ**ï¼š
- âœ… æ•°æ®åº“å±‚é¢è‡ªåŠ¨è¿‡æ»¤ `boss_id`
- âœ… ç”¨æˆ·åªèƒ½æŸ¥è¯¢è‡ªå·±ç§Ÿæˆ·çš„è€ƒå‹¤è®°å½•
- âœ… å¸æœºåªèƒ½æŸ¥çœ‹è‡ªå·±çš„è€ƒå‹¤è®°å½•
- âœ… ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹æ‰€æœ‰å¸æœºçš„è€ƒå‹¤è®°å½•

#### 3. æ›´æ–°å’Œåˆ é™¤è€ƒå‹¤è®°å½• - âœ… ä¾èµ– RLS ç­–ç•¥
**å‡½æ•°**ï¼š
- `updateClockOut(id, update)` - æ›´æ–°ä¸‹ç­æ‰“å¡
- åˆ é™¤è€ƒå‹¤è®°å½•ï¼ˆå¦‚æœæœ‰ï¼‰

**RLS ç­–ç•¥**ï¼š
```sql
-- ç”¨æˆ·å¯ä»¥æ›´æ–°è‡ªå·±çš„è€ƒå‹¤è®°å½•
CREATE POLICY "Users can update own attendance" ON attendance
  FOR UPDATE TO authenticated
  USING ((boss_id = get_current_user_boss_id()) AND (user_id = auth.uid()))
  WITH CHECK ((boss_id = get_current_user_boss_id()) AND (user_id = auth.uid()));

-- ç®¡ç†å‘˜å¯ä»¥æ›´æ–°ç§Ÿæˆ·çš„è€ƒå‹¤è®°å½•
CREATE POLICY "Manager can update tenant attendance" ON attendance
  FOR UPDATE TO authenticated
  USING ((boss_id = get_current_user_boss_id()) AND (is_admin(auth.uid()) OR is_super_admin(auth.uid())))
  WITH CHECK ((boss_id = get_current_user_boss_id()) AND (is_admin(auth.uid()) OR is_super_admin(auth.uid())));
```

**æ•ˆæœ**ï¼š
- âœ… RLS ç­–ç•¥é˜»æ­¢è·¨ç§Ÿæˆ·æ“ä½œ
- âœ… åªèƒ½æ›´æ–°/åˆ é™¤è‡ªå·±ç§Ÿæˆ·çš„è€ƒå‹¤è®°å½•

### âŒ éœ€è¦ä¿®å¤çš„åŠŸèƒ½

#### é—®é¢˜ 1ï¼šåˆ›å»ºè€ƒå‹¤è®°å½•ç¼ºå°‘ boss_id

**å‡½æ•°**ï¼š`createClockIn`  
**å½“å‰ä»£ç **ï¼š
```typescript
export async function createClockIn(input: AttendanceRecordInput): Promise<AttendanceRecord | null> {
  const {data, error} = await supabase
    .from('attendance')
    .insert(input)  // âŒ ç›´æ¥æ’å…¥ inputï¼Œæ²¡æœ‰æ·»åŠ  boss_id
    .select()
    .maybeSingle()

  if (error) {
    console.error('åˆ›å»ºæ‰“å¡è®°å½•å¤±è´¥:', error)
    return null
  }

  // æ¸…é™¤è€ƒå‹¤ç¼“å­˜
  // ...

  return data
}
```

**é—®é¢˜**ï¼š
- âŒ æ’å…¥æ—¶æ²¡æœ‰æ·»åŠ  `boss_id` å­—æ®µ
- âŒ RLS ç­–ç•¥çš„ `WITH CHECK` æ¡ä»¶è¦æ±‚ `boss_id = get_current_user_boss_id()`
- âŒ ä¼šå¯¼è‡´åˆ›å»ºè€ƒå‹¤è®°å½•å¤±è´¥

**RLS ç­–ç•¥**ï¼š
```sql
-- ç”¨æˆ·å¯ä»¥åˆ›å»ºè‡ªå·±çš„è€ƒå‹¤è®°å½•
CREATE POLICY "Users can create own attendance" ON attendance
  FOR INSERT TO authenticated
  WITH CHECK ((boss_id = get_current_user_boss_id()) AND (user_id = auth.uid()));

-- ç®¡ç†å‘˜å¯ä»¥åˆ›å»ºç§Ÿæˆ·çš„è€ƒå‹¤è®°å½•
CREATE POLICY "Manager can create tenant attendance" ON attendance
  FOR INSERT TO authenticated
  WITH CHECK ((boss_id = get_current_user_boss_id()) AND (is_admin(auth.uid()) OR is_super_admin(auth.uid())));
```

**å½±å“**ï¼š
- å¸æœºæ— æ³•æ‰“å¡
- ç®¡ç†å‘˜æ— æ³•ä¸ºå¸æœºåˆ›å»ºè€ƒå‹¤è®°å½•
- è€æ¿æ— æ³•ä¸ºå¸æœºåˆ›å»ºè€ƒå‹¤è®°å½•

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤ï¼šä¿®æ”¹ createClockIn å‡½æ•°

**ä¿®æ”¹æ–‡ä»¶**ï¼š`src/db/api.ts`

**ä¿®å¤åçš„ä»£ç **ï¼š
```typescript
export async function createClockIn(input: AttendanceRecordInput): Promise<AttendanceRecord | null> {
  // 1. è·å–å½“å‰ç”¨æˆ·
  const {
    data: {user}
  } = await supabase.auth.getUser()

  if (!user) {
    console.error('åˆ›å»ºæ‰“å¡è®°å½•å¤±è´¥: ç”¨æˆ·æœªç™»å½•')
    return null
  }

  // 2. è·å–å½“å‰ç”¨æˆ·çš„ boss_id
  const {data: profile} = await supabase
    .from('profiles')
    .select('boss_id')
    .eq('id', user.id)
    .maybeSingle()

  if (!profile?.boss_id) {
    console.error('åˆ›å»ºæ‰“å¡è®°å½•å¤±è´¥: æ— æ³•è·å– boss_id')
    return null
  }

  // 3. æ’å…¥è€ƒå‹¤è®°å½•ï¼ˆè‡ªåŠ¨æ·»åŠ  boss_id å’Œ tenant_idï¼‰
  const {data, error} = await supabase
    .from('attendance')
    .insert({
      ...input,
      boss_id: profile.boss_id,
      tenant_id: profile.boss_id // tenant_id ä¸ boss_id ç›¸åŒ
    })
    .select()
    .maybeSingle()

  if (error) {
    console.error('åˆ›å»ºæ‰“å¡è®°å½•å¤±è´¥:', error)
    return null
  }

  // æ¸…é™¤è€ƒå‹¤ç¼“å­˜
  if (data) {
    const date = new Date(data.work_date)
    const year = date.getFullYear()
    const month = date.getMonth() + 1
    const cacheKey = `${CACHE_KEYS.ATTENDANCE_MONTHLY}_${data.user_id}_${year}_${month}`
    clearCache(cacheKey)
    // æ¸…é™¤æ‰€æœ‰è®°å½•ç¼“å­˜
    const allCacheKey = `${CACHE_KEYS.ATTENDANCE_ALL_RECORDS}_${year}_${month}`
    clearCache(allCacheKey)
  }

  return data
}
```

## ğŸ“Š å¤šç§Ÿæˆ·æ¶æ„éªŒè¯

### æ•°æ®éš”ç¦»ä¿è¯

#### 1. è€ƒå‹¤è®°å½•æ•°æ®éš”ç¦»
```typescript
// ç§Ÿæˆ· A çš„å¸æœºç™»å½•
const attendance = await getTodayAttendance(userId)
// âœ… åªè¿”å›ç§Ÿæˆ· A çš„è€ƒå‹¤è®°å½•

// ç§Ÿæˆ· B çš„å¸æœºç™»å½•
const attendance = await getTodayAttendance(userId)
// âœ… åªè¿”å›ç§Ÿæˆ· B çš„è€ƒå‹¤è®°å½•
```

#### 2. è€ƒå‹¤è§„åˆ™æ•°æ®éš”ç¦»
```typescript
// ç§Ÿæˆ· A çš„è€æ¿ç™»å½•
const rules = await getAllAttendanceRules()
// âœ… åªè¿”å›ç§Ÿæˆ· A çš„è€ƒå‹¤è§„åˆ™

// ç§Ÿæˆ· B çš„è€æ¿ç™»å½•
const rules = await getAllAttendanceRules()
// âœ… åªè¿”å›ç§Ÿæˆ· B çš„è€ƒå‹¤è§„åˆ™
```

#### 3. è€ƒå‹¤ç»Ÿè®¡æ•°æ®éš”ç¦»
```typescript
// ç§Ÿæˆ· A çš„è€æ¿ç™»å½•
const stats = await getDriverAttendanceStats(driverId, year, month)
// âœ… åªè¿”å›ç§Ÿæˆ· A çš„å¸æœºç»Ÿè®¡

// ç§Ÿæˆ· B çš„è€æ¿ç™»å½•
const stats = await getDriverAttendanceStats(driverId, year, month)
// âœ… åªè¿”å›ç§Ÿæˆ· B çš„å¸æœºç»Ÿè®¡
```

### RLS ç­–ç•¥å·¥ä½œåŸç†

```
ç”¨æˆ·è¯·æ±‚ â†’ Supabase Client â†’ Supabase Server
                                    â†“
                            åº”ç”¨ RLS ç­–ç•¥
                                    â†“
                            è¿‡æ»¤ boss_id
                                    â†“
                            è¿”å›ç§Ÿæˆ·æ•°æ®
```

**å…³é”®ç‚¹**ï¼š
1. RLS ç­–ç•¥åœ¨æ•°æ®åº“å±‚é¢æ‰§è¡Œï¼Œæ— æ³•ç»•è¿‡
2. å³ä½¿åº”ç”¨å±‚ä»£ç æœ‰æ¼æ´ï¼Œæ•°æ®åº“ä¹Ÿä¼šç¡®ä¿ç§Ÿæˆ·éš”ç¦»
3. æ‰€æœ‰æŸ¥è¯¢éƒ½ä¼šè‡ªåŠ¨æ·»åŠ  `WHERE boss_id = get_current_user_boss_id()` æ¡ä»¶
4. æ‰€æœ‰æ’å…¥éƒ½ä¼šæ£€æŸ¥ `boss_id = get_current_user_boss_id()` æ¡ä»¶

## ğŸ“ˆ æ£€æŸ¥æ€»ç»“

### å·²æ£€æŸ¥çš„è¡¨

| è¡¨å | boss_id å­—æ®µ | RLS ç­–ç•¥ | åˆ›å»ºå‡½æ•° | æŸ¥è¯¢å‡½æ•° | æ›´æ–°å‡½æ•° | åˆ é™¤å‡½æ•° |
|------|-------------|---------|---------|---------|---------|---------|
| attendance | âœ… | âœ… | âŒ éœ€ä¿®å¤ | âœ… | âœ… | âœ… |
| attendance_rules | âœ… | âœ… | âœ… å·²ä¿®å¤ | âœ… | âœ… | âœ… |

### å·²æ£€æŸ¥çš„åŠŸèƒ½æ¨¡å—

| åŠŸèƒ½æ¨¡å— | çŠ¶æ€ | è¯´æ˜ |
|---------|------|------|
| è€ƒå‹¤è®°å½• CRUD | âŒ | åˆ›å»ºå‡½æ•°éœ€è¦ä¿®å¤ï¼Œå…¶ä»–å·²æ­£ç¡®é€‚é… |
| è€ƒå‹¤è§„åˆ™ CRUD | âœ… | åˆ›å»ºã€æŸ¥è¯¢ã€æ›´æ–°ã€åˆ é™¤éƒ½å·²æ­£ç¡®é€‚é… |
| è€ƒå‹¤ç»Ÿè®¡ | âœ… | ä¾èµ– RLS ç­–ç•¥ï¼Œè‡ªåŠ¨éš”ç¦» |
| è€ƒå‹¤æ‰“å¡ | âŒ | æ‰“å¡å‡½æ•°éœ€è¦ä¿®å¤ |

### éœ€è¦ä¿®å¤çš„é—®é¢˜

1. **é«˜ä¼˜å…ˆçº§**ï¼š
   - âŒ `createClockIn` å‡½æ•°ç¼ºå°‘ `boss_id` å’Œ `tenant_id`

2. **ä½ä¼˜å…ˆçº§**ï¼š
   - æ— 

### ä¿®å¤åçš„æ•ˆæœ

- âœ… æ‰€æœ‰è€ƒå‹¤ç®¡ç†åŠŸèƒ½éƒ½æ­£ç¡®é€‚é…å¤šç§Ÿæˆ·æ¶æ„
- âœ… æ¯ä¸ªç§Ÿæˆ·çš„æ•°æ®å®Œå…¨éš”ç¦»
- âœ… æ— æ³•è·¨ç§Ÿæˆ·è®¿é—®æˆ–æ“ä½œæ•°æ®
- âœ… å¸æœºå¯ä»¥æ­£å¸¸æ‰“å¡
- âœ… ç®¡ç†å‘˜å¯ä»¥æ­£å¸¸åˆ›å»ºè€ƒå‹¤è®°å½•
- âœ… æ•°æ®åº“å±‚é¢å’Œåº”ç”¨å±‚é¢åŒé‡ä¿æŠ¤

## ğŸ§ª æµ‹è¯•å»ºè®®

### æµ‹è¯•åœºæ™¯ 1ï¼šå¸æœºæ‰“å¡
1. ä½¿ç”¨ç§Ÿæˆ· A çš„å¸æœºè´¦å·ç™»å½•
2. è¿›å…¥è€ƒå‹¤æ‰“å¡é¡µé¢
3. ç‚¹å‡»ä¸Šç­æ‰“å¡
4. **é¢„æœŸç»“æœ**ï¼šâœ… æ‰“å¡æˆåŠŸï¼Œä¸ä¼šå‡ºç°æƒé™é”™è¯¯

### æµ‹è¯•åœºæ™¯ 2ï¼šéªŒè¯è€ƒå‹¤è®°å½•éš”ç¦»
1. ä½¿ç”¨ç§Ÿæˆ· A çš„å¸æœºè´¦å·ç™»å½•
2. æ‰“å¡
3. é€€å‡ºç™»å½•
4. ä½¿ç”¨ç§Ÿæˆ· B çš„è€æ¿è´¦å·ç™»å½•
5. æŸ¥è¯¢è€ƒå‹¤è®°å½•åˆ—è¡¨
6. **é¢„æœŸç»“æœ**ï¼šâœ… çœ‹ä¸åˆ°ç§Ÿæˆ· A çš„è€ƒå‹¤è®°å½•

### æµ‹è¯•åœºæ™¯ 3ï¼šç®¡ç†å‘˜åˆ›å»ºè€ƒå‹¤è®°å½•
1. ä½¿ç”¨ç§Ÿæˆ· A çš„è€æ¿è´¦å·ç™»å½•
2. è¿›å…¥è€ƒå‹¤ç®¡ç†é¡µé¢
3. ä¸ºæŸä¸ªå¸æœºåˆ›å»ºè€ƒå‹¤è®°å½•
4. **é¢„æœŸç»“æœ**ï¼šâœ… åˆ›å»ºæˆåŠŸï¼Œä¸ä¼šå‡ºç°æƒé™é”™è¯¯

### æµ‹è¯•åœºæ™¯ 4ï¼šéªŒè¯è·¨ç§Ÿæˆ·æ“ä½œè¢«é˜»æ­¢
1. ä½¿ç”¨ç§Ÿæˆ· A çš„è€æ¿è´¦å·ç™»å½•
2. è·å–ç§Ÿæˆ· B çš„æŸä¸ªè€ƒå‹¤è®°å½• ID
3. å°è¯•æ›´æ–°è¯¥è€ƒå‹¤è®°å½•
4. **é¢„æœŸç»“æœ**ï¼šâœ… æ›´æ–°å¤±è´¥ï¼ŒRLS ç­–ç•¥é˜»æ­¢æ“ä½œ

## ğŸ“ æŠ€æœ¯ç»†èŠ‚

### æ•°æ®åº“è¡¨ç»“æ„

#### attendance è¡¨
```sql
CREATE TABLE attendance (
  id uuid PRIMARY KEY,
  user_id uuid NOT NULL REFERENCES profiles(id),
  warehouse_id uuid NOT NULL REFERENCES warehouses(id),
  work_date date NOT NULL,
  clock_in_time timestamptz NOT NULL,
  clock_out_time timestamptz,
  work_hours numeric,
  status attendance_status NOT NULL,
  notes text,
  boss_id text NOT NULL,      -- ç§Ÿæˆ· ID
  tenant_id uuid,              -- ç§Ÿæˆ· IDï¼ˆä¸ boss_id ç›¸åŒï¼‰
  created_at timestamptz DEFAULT now()
);
```

#### attendance_rules è¡¨
```sql
CREATE TABLE attendance_rules (
  id uuid PRIMARY KEY,
  warehouse_id uuid NOT NULL REFERENCES warehouses(id),
  work_start_time time NOT NULL,
  work_end_time time NOT NULL,
  late_threshold integer NOT NULL,
  early_threshold integer NOT NULL,
  require_clock_out boolean NOT NULL,
  is_active boolean NOT NULL,
  boss_id text NOT NULL,      -- ç§Ÿæˆ· ID
  tenant_id uuid,              -- ç§Ÿæˆ· IDï¼ˆä¸ boss_id ç›¸åŒï¼‰
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);
```

### RLS ç­–ç•¥

#### attendance è¡¨ç­–ç•¥
```sql
-- ç”¨æˆ·å¯ä»¥åˆ›å»ºè‡ªå·±çš„è€ƒå‹¤è®°å½•
CREATE POLICY "Users can create own attendance" ON attendance
  FOR INSERT TO authenticated
  WITH CHECK ((boss_id = get_current_user_boss_id()) AND (user_id = auth.uid()));

-- ç”¨æˆ·å¯ä»¥æŸ¥çœ‹è‡ªå·±çš„è€ƒå‹¤è®°å½•
CREATE POLICY "Users can view own attendance" ON attendance
  FOR SELECT TO authenticated
  USING ((boss_id = get_current_user_boss_id()) AND (user_id = auth.uid()));

-- ç”¨æˆ·å¯ä»¥æ›´æ–°è‡ªå·±çš„è€ƒå‹¤è®°å½•
CREATE POLICY "Users can update own attendance" ON attendance
  FOR UPDATE TO authenticated
  USING ((boss_id = get_current_user_boss_id()) AND (user_id = auth.uid()))
  WITH CHECK ((boss_id = get_current_user_boss_id()) AND (user_id = auth.uid()));

-- ç®¡ç†å‘˜å¯ä»¥ç®¡ç†ç§Ÿæˆ·çš„è€ƒå‹¤è®°å½•
CREATE POLICY "Manager can create tenant attendance" ON attendance
  FOR INSERT TO authenticated
  WITH CHECK ((boss_id = get_current_user_boss_id()) AND (is_admin(auth.uid()) OR is_super_admin(auth.uid())));

CREATE POLICY "Manager can view tenant attendance" ON attendance
  FOR SELECT TO authenticated
  USING ((boss_id = get_current_user_boss_id()) AND (is_admin(auth.uid()) OR is_super_admin(auth.uid())));

CREATE POLICY "Manager can update tenant attendance" ON attendance
  FOR UPDATE TO authenticated
  USING ((boss_id = get_current_user_boss_id()) AND (is_admin(auth.uid()) OR is_super_admin(auth.uid())))
  WITH CHECK ((boss_id = get_current_user_boss_id()) AND (is_admin(auth.uid()) OR is_super_admin(auth.uid())));

CREATE POLICY "Manager can delete tenant attendance" ON attendance
  FOR DELETE TO authenticated
  USING ((boss_id = get_current_user_boss_id()) AND (is_admin(auth.uid()) OR is_super_admin(auth.uid())));

-- è€æ¿å¯ä»¥ç®¡ç†ç§Ÿæˆ·çš„æ‰€æœ‰è€ƒå‹¤è®°å½•
CREATE POLICY "Super admin can manage tenant attendance" ON attendance
  FOR ALL TO authenticated
  USING ((boss_id = get_current_user_boss_id()) AND is_super_admin(auth.uid()))
  WITH CHECK ((boss_id = get_current_user_boss_id()) AND is_super_admin(auth.uid()));
```

#### attendance_rules è¡¨ç­–ç•¥
```sql
-- è€æ¿å¯ä»¥ç®¡ç†è‡ªå·±ç§Ÿæˆ·çš„è€ƒå‹¤è§„åˆ™
CREATE POLICY "Super admin can manage tenant attendance rules" ON attendance_rules
  FOR ALL TO authenticated
  USING ((boss_id = get_current_user_boss_id()) AND is_super_admin(auth.uid()))
  WITH CHECK ((boss_id = get_current_user_boss_id()) AND is_super_admin(auth.uid()));

-- æ‰€æœ‰ç”¨æˆ·å¯ä»¥æŸ¥çœ‹è‡ªå·±ç§Ÿæˆ·çš„è€ƒå‹¤è§„åˆ™
CREATE POLICY "Users can view tenant attendance rules" ON attendance_rules
  FOR SELECT TO authenticated
  USING (boss_id = get_current_user_boss_id());
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. boss_id çš„è·å–
- æ‰€æœ‰åˆ›å»ºå‡½æ•°éƒ½ä¼šè‡ªåŠ¨ä»å½“å‰ç™»å½•ç”¨æˆ·çš„ profile ä¸­è·å– `boss_id`
- å¦‚æœç”¨æˆ·æœªç™»å½•æˆ–æ— æ³•è·å– `boss_id`ï¼Œåˆ›å»ºä¼šå¤±è´¥

### 2. tenant_id çš„è®¾ç½®
- `tenant_id` å­—æ®µè®¾ç½®ä¸ºä¸ `boss_id` ç›¸åŒçš„å€¼
- è¿™æ˜¯å› ä¸ºåœ¨å½“å‰ç³»ç»Ÿä¸­ï¼Œç§Ÿæˆ· ID å°±æ˜¯è€æ¿çš„ ID

### 3. RLS ç­–ç•¥çš„ä½œç”¨
- RLS ç­–ç•¥åœ¨æ•°æ®åº“å±‚é¢æ‰§è¡Œï¼Œæ— æ³•ç»•è¿‡
- å³ä½¿åº”ç”¨å±‚ä»£ç æœ‰æ¼æ´ï¼Œæ•°æ®åº“ä¹Ÿä¼šç¡®ä¿ç§Ÿæˆ·éš”ç¦»
- æ‰€æœ‰æŸ¥è¯¢éƒ½ä¼šè‡ªåŠ¨æ·»åŠ  `WHERE boss_id = get_current_user_boss_id()` æ¡ä»¶

### 4. å¤–é”®å…³è”
- `attendance.user_id` å¼•ç”¨ `profiles.id`
- `attendance.warehouse_id` å¼•ç”¨ `warehouses.id`
- `attendance_rules.warehouse_id` å¼•ç”¨ `warehouses.id`
- ç”±äºæ‰€æœ‰è¡¨éƒ½æœ‰ `boss_id` è¿‡æ»¤ï¼Œè€ƒå‹¤è®°å½•åªèƒ½å…³è”åˆ°åŒä¸€ç§Ÿæˆ·çš„ç”¨æˆ·å’Œä»“åº“
- è¿™ç¡®ä¿äº†æ•°æ®çš„ä¸€è‡´æ€§å’Œéš”ç¦»æ€§

### 5. æ‰“å¡åŠŸèƒ½çš„ç‰¹æ®Šæ€§
- æ‰“å¡åŠŸèƒ½æ˜¯å¸æœºæœ€å¸¸ç”¨çš„åŠŸèƒ½
- å¿…é¡»ç¡®ä¿æ‰“å¡åŠŸèƒ½æ­£å¸¸å·¥ä½œ
- æ‰“å¡å¤±è´¥ä¼šä¸¥é‡å½±å“ç”¨æˆ·ä½“éªŒ

## ğŸ“ˆ ä¿®å¤è¿›åº¦

- [x] æ£€æŸ¥è€ƒå‹¤è®°å½• CRUD åŠŸèƒ½ - âœ… å·²å®Œæˆ
- [x] æ£€æŸ¥è€ƒå‹¤è§„åˆ™ CRUD åŠŸèƒ½ - âœ… å·²å®Œæˆ
- [x] æ£€æŸ¥è€ƒå‹¤ç»Ÿè®¡åŠŸèƒ½ - âœ… å·²å®Œæˆ
- [ ] ä¿®å¤ createClockIn å‡½æ•° - â³ å¾…ä¿®å¤
- [ ] æµ‹è¯•éªŒè¯ - â³ å¾…æµ‹è¯•

---

**æ£€æŸ¥æ—¥æœŸ**ï¼š2025-11-26  
**æ£€æŸ¥äººå‘˜**ï¼šç§’å“’ AI  
**çŠ¶æ€**ï¼šâœ… æ£€æŸ¥å®Œæˆï¼Œå‘ç° 1 ä¸ªéœ€è¦ä¿®å¤çš„é—®é¢˜

## ğŸ¯ æ€»ç»“

### æ ¸å¿ƒå‘ç°
1. âœ… è€ƒå‹¤ç®¡ç†çš„å¤§éƒ¨åˆ†åŠŸèƒ½å·²æ­£ç¡®é€‚é…å¤šç§Ÿæˆ·æ¶æ„
2. âœ… RLS ç­–ç•¥å·²æ­£ç¡®å®ç°ï¼Œç¡®ä¿æ•°æ®åº“å±‚é¢çš„ç§Ÿæˆ·éš”ç¦»
3. âŒ åˆ›å»ºè€ƒå‹¤è®°å½•å‡½æ•°éœ€è¦ä¿®å¤ï¼Œç¼ºå°‘ `boss_id` å’Œ `tenant_id`
4. âœ… è€ƒå‹¤è§„åˆ™åˆ›å»ºå‡½æ•°å·²ä¿®å¤

### æ¶æ„ä¿è¯
1. âœ… æ•°æ®åº“å±‚é¢ï¼šRLS ç­–ç•¥ç¡®ä¿ç§Ÿæˆ·éš”ç¦»
2. âœ… åº”ç”¨å±‚é¢ï¼šåˆ›å»ºå‡½æ•°è‡ªåŠ¨æ·»åŠ ç§Ÿæˆ·æ ‡è¯†å­—æ®µ
3. âœ… åŒé‡ä¿æŠ¤ï¼šå³ä½¿åº”ç”¨å±‚æœ‰æ¼æ´ï¼Œæ•°æ®åº“ä¹Ÿä¼šé˜»æ­¢è·¨ç§Ÿæˆ·è®¿é—®

### ä¿®å¤å»ºè®®
1. **ç«‹å³ä¿®å¤**ï¼š`createClockIn` å‡½æ•°ï¼ˆé«˜ä¼˜å…ˆçº§ï¼Œå½±å“æ‰“å¡åŠŸèƒ½ï¼‰
2. **æµ‹è¯•éªŒè¯**ï¼šä¿®å¤åè¿›è¡Œå…¨é¢æµ‹è¯•
3. **æ–‡æ¡£æ›´æ–°**ï¼šæ›´æ–°ç›¸å…³æ–‡æ¡£

### ä¿®å¤åçš„æ•ˆæœ
- âœ… æ‰€æœ‰è€ƒå‹¤ç®¡ç†åŠŸèƒ½éƒ½æ­£ç¡®é€‚é…å¤šç§Ÿæˆ·æ¶æ„
- âœ… æ¯ä¸ªç§Ÿæˆ·çš„æ•°æ®å®Œå…¨éš”ç¦»
- âœ… æ— æ³•è·¨ç§Ÿæˆ·è®¿é—®æˆ–æ“ä½œæ•°æ®
- âœ… å¸æœºå¯ä»¥æ­£å¸¸æ‰“å¡
- âœ… ç®¡ç†å‘˜å¯ä»¥æ­£å¸¸åˆ›å»ºè€ƒå‹¤è®°å½•
- âœ… è€æ¿å¯ä»¥æ­£å¸¸ç®¡ç†è€ƒå‹¤è§„åˆ™
