# é€šçŸ¥ç³»ç»Ÿæµ‹è¯•æŒ‡å—

## âœ… å·²å®Œæˆçš„ä¿®å¤

### 1. æ•°æ®æ¸…ç†
æ‚¨å·²ç»æ‰§è¡Œäº†æ•°æ®æ¸…ç† SQLï¼Œåˆ é™¤äº†æ‰€æœ‰æ— æ•ˆæ•°æ®ï¼ˆ`id` æˆ– `user_id` ä¸º `'anon'` çš„è®°å½•ï¼‰ã€‚

### 2. ä»£ç ä¿®å¤
- âœ… ä¿®å¤é€šçŸ¥ç±»å‹ä¸åŒ¹é…é—®é¢˜
- âœ… æ·»åŠ æ•°æ®éªŒè¯é€»è¾‘ï¼ˆå¸æœºç«¯å’Œè€æ¿ç«¯ï¼‰
- âœ… æ·»åŠ è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—
- âœ… ä¿®å¤ RLS ç­–ç•¥

## ğŸ“‹ æµ‹è¯•æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šæ£€æŸ¥ç”¨æˆ·è®¤è¯çŠ¶æ€

1. **æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°**ï¼ˆæŒ‰ F12 é”®ï¼‰
2. **è¿è¡Œä»¥ä¸‹ä»£ç **ï¼š
```javascript
const { data: { user } } = await supabase.auth.getUser()
console.log('å½“å‰ç”¨æˆ·ID:', user?.id)

if (user?.id === 'anon' || !user?.id || user?.id.length < 10) {
  console.error('âŒ ç”¨æˆ·IDæ— æ•ˆï¼è¯·é‡æ–°ç™»å½•')
} else {
  console.log('âœ… ç”¨æˆ·IDæœ‰æ•ˆï¼Œå¯ä»¥ç»§ç»­æµ‹è¯•')
}
```

3. **ç¡®è®¤ç»“æœ**ï¼š
   - âœ… å¦‚æœæ˜¾ç¤º"ç”¨æˆ·IDæœ‰æ•ˆ"ï¼Œç»§ç»­ä¸‹ä¸€æ­¥
   - âŒ å¦‚æœæ˜¾ç¤º"ç”¨æˆ·IDæ— æ•ˆ"ï¼Œè¯·å…ˆé€€å‡ºç™»å½•ï¼Œç„¶åé‡æ–°ç™»å½•

### ç¬¬äºŒæ­¥ï¼šå¸æœºæäº¤è¯·å‡ç”³è¯·

1. **ä½¿ç”¨å¸æœºè´¦å·ç™»å½•**
2. **æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°**ï¼ˆF12ï¼‰
3. **æäº¤ä¸€ä¸ªè¯·å‡ç”³è¯·**
4. **æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—**ï¼Œåº”è¯¥çœ‹åˆ°ï¼š
   ```
   âœ… è¯·å‡ç”³è¯·åˆ›å»ºæˆåŠŸ: {
     applicationId: "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
     userId: "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
     ...
   }
   ```

5. **è®°å½• `applicationId`**ï¼ˆåé¢éœ€è¦ç”¨åˆ°ï¼‰

**é¢„æœŸç»“æœ**ï¼š
- âœ… æäº¤æˆåŠŸ
- âœ… `applicationId` æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ UUIDï¼ˆä¸æ˜¯ `'anon'`ï¼‰
- âœ… æ§åˆ¶å°æ²¡æœ‰é”™è¯¯ä¿¡æ¯

**å¦‚æœå‡ºç°é”™è¯¯**ï¼š
- å¦‚æœçœ‹åˆ°"åˆ›å»ºç”³è¯·å¤±è´¥ï¼šæ— æ•ˆçš„ç”³è¯·ID"ï¼Œè¯´æ˜æ•°æ®åº“æˆ–è®¤è¯æœ‰é—®é¢˜
- è¯·æ£€æŸ¥ç”¨æˆ·è®¤è¯çŠ¶æ€ï¼ˆç¬¬ä¸€æ­¥ï¼‰
- è¯·ç¡®è®¤æ•°æ®æ¸…ç†æ˜¯å¦æˆåŠŸ

### ç¬¬ä¸‰æ­¥ï¼šè€æ¿å®¡æ‰¹è¯·å‡ç”³è¯·

1. **ä½¿ç”¨è€æ¿è´¦å·ç™»å½•**
2. **æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°**ï¼ˆF12ï¼‰
3. **è¿›å…¥"è¯·å‡å®¡æ‰¹"é¡µé¢**
4. **æ‰¾åˆ°åˆšæ‰æäº¤çš„è¯·å‡ç”³è¯·**
5. **ç‚¹å‡»"æ‰¹å‡†"æˆ–"æ‹’ç»"æŒ‰é’®**
6. **æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—**ï¼Œåº”è¯¥çœ‹åˆ°ï¼š

```
ğŸ” å¼€å§‹æŸ¥è¯¢åŸå§‹ç”³è¯·é€šçŸ¥: {
  related_id: "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
  type: "leave_application_submitted",
  current_user: "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
}

ğŸ” æŸ¥è¯¢åˆ° X æ¡åŸå§‹ç”³è¯·é€šçŸ¥

ğŸ“‹ é€šçŸ¥è¯¦æƒ…:
  [1] ID: xxx
      æ¥æ”¶è€…: xxx
      ç±»å‹: leave_application_submitted
      å…³è”ID: xxx
      å®¡æ‰¹çŠ¶æ€: pending
      ...

ğŸ“ å‡†å¤‡æ›´æ–°é€šçŸ¥ xxx:
  - æ¥æ”¶è€…: xxx
  - æ˜¯å¦ä¸ºå®¡æ‰¹äºº: true
  - æ–°çŠ¶æ€: approved/rejected
  ...

âœ… æˆåŠŸæ›´æ–°é€šçŸ¥ xxx

ğŸ“Š é€šçŸ¥æ›´æ–°ç»“æœ: æˆåŠŸ X æ¡, å¤±è´¥ 0 æ¡

âœ… å·²å‘é€å®¡æ‰¹ç»“æœé€šçŸ¥ç»™å¸æœº: xxx
```

**é¢„æœŸç»“æœ**ï¼š
- âœ… æŸ¥è¯¢åˆ°åŸå§‹é€šçŸ¥ï¼ˆè‡³å°‘ 1 æ¡ï¼‰
- âœ… æ‰€æœ‰é€šçŸ¥æ›´æ–°æˆåŠŸ
- âœ… æ²¡æœ‰é”™è¯¯ä¿¡æ¯

**å¦‚æœå‡ºç°é”™è¯¯**ï¼š
- å¦‚æœçœ‹åˆ°"æ— æ•ˆçš„ç”³è¯·IDï¼Œæ— æ³•å®¡æ‰¹"ï¼Œè¯´æ˜ `applicationId` æ˜¯ `'anon'`
- å¦‚æœçœ‹åˆ°"æŸ¥è¯¢åˆ° 0 æ¡åŸå§‹ç”³è¯·é€šçŸ¥"ï¼Œè¯´æ˜é€šçŸ¥æ²¡æœ‰åˆ›å»ºæˆ–ç±»å‹ä¸åŒ¹é…
- å¦‚æœçœ‹åˆ°"æŸ¥è¯¢åŸå§‹é€šçŸ¥å¤±è´¥"ï¼Œè¯·æŸ¥çœ‹å…·ä½“çš„é”™è¯¯ä¿¡æ¯

### ç¬¬å››æ­¥ï¼šæ£€æŸ¥é€šçŸ¥ä¸­å¿ƒ

1. **ä½¿ç”¨è€æ¿è´¦å·æŸ¥çœ‹é€šçŸ¥ä¸­å¿ƒ**
2. **æŸ¥æ‰¾åˆšæ‰å®¡æ‰¹çš„è¯·å‡ç”³è¯·é€šçŸ¥**
3. **ç¡®è®¤é€šçŸ¥çŠ¶æ€**ï¼š
   - âœ… åº”è¯¥åªæœ‰**ä¸€æ¡**é€šçŸ¥
   - âœ… é€šçŸ¥æ ‡é¢˜åº”è¯¥æ˜¯"è¯·å‡å®¡æ‰¹é€šçŸ¥"
   - âœ… é€šçŸ¥å†…å®¹åº”è¯¥åŒ…å«å®¡æ‰¹ç»“æœï¼ˆ"å·²æ‰¹å‡†"æˆ–"å·²æ‹’ç»"ï¼‰
   - âœ… é€šçŸ¥çŠ¶æ€åº”è¯¥æ˜¯"å·²å¤„ç†"ï¼ˆä¸æ˜¯"å¾…å®¡æ‰¹"ï¼‰

**å¦‚æœè¿˜æœ‰ä¸¤æ¡é€šçŸ¥**ï¼š
- è¯·æä¾›æ§åˆ¶å°æ—¥å¿—æˆªå›¾
- è¯·æä¾›é€šçŸ¥ä¸­å¿ƒæˆªå›¾
- è¯·è¯´æ˜ä¸¤æ¡é€šçŸ¥çš„å†…å®¹åˆ†åˆ«æ˜¯ä»€ä¹ˆ

## ğŸ” å¸¸è§é—®é¢˜

### é—®é¢˜ 1ï¼šç”¨æˆ·IDæ˜¯ 'anon'
**åŸå› **ï¼šç”¨æˆ·æ²¡æœ‰æ­£ç¡®ç™»å½•ï¼Œä½¿ç”¨äº†åŒ¿åä¼šè¯

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. é€€å‡ºç™»å½•
2. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜
3. é‡æ–°ç™»å½•
4. é‡æ–°æµ‹è¯•

### é—®é¢˜ 2ï¼šæŸ¥è¯¢åˆ° 0 æ¡åŸå§‹é€šçŸ¥
**åŸå› **ï¼š
- å¸æœºæäº¤æ—¶é€šçŸ¥åˆ›å»ºå¤±è´¥
- é€šçŸ¥ç±»å‹ä¸åŒ¹é…
- `related_id` ä¸åŒ¹é…

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥å¸æœºç«¯çš„æ§åˆ¶å°æ—¥å¿—ï¼Œç¡®è®¤é€šçŸ¥æ˜¯å¦å‘é€æˆåŠŸ
2. æ£€æŸ¥æ•°æ®åº“ï¼š
```sql
SELECT id, recipient_id, type, title, related_id, approval_status
FROM notifications
WHERE related_id = '<applicationId>'
ORDER BY created_at;
```
3. ç¡®è®¤é€šçŸ¥çš„ `type` æ˜¯ `'leave_application_submitted'`

### é—®é¢˜ 3ï¼šé€šçŸ¥æ›´æ–°å¤±è´¥
**åŸå› **ï¼šRLS ç­–ç•¥ä¸å…è®¸æ›´æ–°

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥é”™è¯¯ä¿¡æ¯
2. ç¡®è®¤ç”¨æˆ·è§’è‰²æ˜¯å¦ä¸ºç®¡ç†å‘˜
3. æ£€æŸ¥ RLS ç­–ç•¥æ˜¯å¦æ­£ç¡®

## ğŸ“Š æ•°æ®åº“æ£€æŸ¥

å¦‚æœéœ€è¦æ‰‹åŠ¨æ£€æŸ¥æ•°æ®åº“ï¼Œå¯ä»¥è¿è¡Œä»¥ä¸‹ SQLï¼š

```sql
-- 1. æŸ¥çœ‹æ‰€æœ‰è¯·å‡ç”³è¯·
SELECT id, user_id, leave_type, status, created_at
FROM leave_applications
ORDER BY created_at DESC
LIMIT 10;

-- 2. æŸ¥çœ‹æ‰€æœ‰è¯·å‡ç›¸å…³é€šçŸ¥
SELECT id, recipient_id, type, title, approval_status, related_id, created_at
FROM notifications
WHERE type IN ('leave_application_submitted', 'leave_approved', 'leave_rejected')
ORDER BY created_at DESC
LIMIT 20;

-- 3. æŸ¥çœ‹ç‰¹å®šè¯·å‡ç”³è¯·çš„æ‰€æœ‰é€šçŸ¥
SELECT id, recipient_id, type, title, approval_status, is_read, created_at, updated_at
FROM notifications
WHERE related_id = '<applicationId>'
ORDER BY created_at;
```

## ğŸ“ åé¦ˆä¿¡æ¯

å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨ï¼Œè¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š

1. **ç”¨æˆ·è®¤è¯æ£€æŸ¥ç»“æœ**ï¼š
   - ç”¨æˆ·IDæ˜¯ä»€ä¹ˆï¼Ÿ
   - æ˜¯å¦æœ‰æ•ˆï¼Ÿ

2. **å¸æœºç«¯æ§åˆ¶å°æ—¥å¿—**ï¼š
   - å®Œæ•´çš„æ—¥å¿—æˆªå›¾
   - ç‰¹åˆ«æ˜¯"è¯·å‡ç”³è¯·åˆ›å»ºæˆåŠŸ"éƒ¨åˆ†

3. **è€æ¿ç«¯æ§åˆ¶å°æ—¥å¿—**ï¼š
   - å®Œæ•´çš„æ—¥å¿—æˆªå›¾
   - ç‰¹åˆ«æ˜¯"æŸ¥è¯¢åŸå§‹ç”³è¯·é€šçŸ¥"å’Œ"é€šçŸ¥æ›´æ–°ç»“æœ"éƒ¨åˆ†

4. **é€šçŸ¥ä¸­å¿ƒæˆªå›¾**ï¼š
   - æ˜¾ç¤º"ä¸¤æ¡ä¿¡æ¯"çš„æˆªå›¾
   - ä¸¤æ¡ä¿¡æ¯çš„å…·ä½“å†…å®¹

5. **æ•°æ®åº“æŸ¥è¯¢ç»“æœ**ï¼š
   - è¯·å‡ç”³è¯·è®°å½•
   - ç›¸å…³é€šçŸ¥è®°å½•

---

**æœ€åæ›´æ–°**ï¼š2025-12-01
**çŠ¶æ€**ï¼šç­‰å¾…æµ‹è¯•ç»“æœ
