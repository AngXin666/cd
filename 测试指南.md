# 通知系统测试指南

## ⚠️ 重要：先修复用户角色问题

根据您提供的日志，系统找不到主账号（老板）和车队长，这是因为 `user_roles` 表中缺少用户角色数据。

### 问题原因
```
⚠️ 未找到主账号
⚠️ 未找到车队长信息
⚠️ 没有找到任何通知接收者
```

这说明：
1. `user_roles` 表中没有 `SUPER_ADMIN` 角色的用户
2. `user_roles` 表中没有 `MANAGER` 角色的用户
3. 导致通知无法发送

### 立即修复步骤

#### 第零步：检查用户角色（必须！）

运行以下 SQL 检查当前状态：

```sql
-- 1. 查看所有用户和角色
SELECT 
  u.id,
  u.name,
  u.phone,
  COALESCE(ur.role::text, '无角色') as role,
  u.created_at
FROM users u
LEFT JOIN user_roles ur ON u.id = ur.user_id
ORDER BY u.created_at;

-- 2. 统计各角色的用户数量
SELECT 
  COALESCE(ur.role::text, '无角色') as role,
  COUNT(*) as count
FROM users u
LEFT JOIN user_roles ur ON u.id = ur.user_id
GROUP BY ur.role;
```

**预期问题**：
- 很多用户的 `role` 列显示为 `'无角色'`
- 没有 `SUPER_ADMIN` 角色的用户
- 没有 `MANAGER` 角色的用户

#### 第一步：应用数据库迁移修复用户角色

**方法 1：使用 Supabase 迁移（推荐）**

我已经创建了迁移文件 `00531_fix_missing_user_roles.sql`，请应用这个迁移：

```bash
# 如果您有 Supabase CLI
supabase db push
```

**方法 2：手动执行 SQL**

如果无法使用迁移，请手动执行以下 SQL：

```sql
-- 1. 为第一个用户添加 SUPER_ADMIN 角色
INSERT INTO user_roles (user_id, role, created_at)
SELECT 
  u.id,
  'SUPER_ADMIN'::user_role,
  NOW()
FROM users u
LEFT JOIN user_roles ur ON u.id = ur.user_id
WHERE ur.role IS NULL
ORDER BY u.created_at
LIMIT 1
ON CONFLICT (user_id) DO NOTHING;

-- 2. 为其他用户添加 DRIVER 角色
INSERT INTO user_roles (user_id, role, created_at)
SELECT 
  u.id,
  'DRIVER'::user_role,
  NOW()
FROM users u
LEFT JOIN user_roles ur ON u.id = ur.user_id
WHERE ur.role IS NULL
ON CONFLICT (user_id) DO NOTHING;
```

#### 第二步：验证修复结果

运行以下 SQL 确认修复成功：

```sql
-- 1. 确认所有用户都有角色
SELECT COUNT(*) as users_without_role
FROM users u
LEFT JOIN user_roles ur ON u.id = ur.user_id
WHERE ur.role IS NULL;
-- 应该返回 0

-- 2. 确认有 SUPER_ADMIN 用户
SELECT COUNT(*) as super_admin_count
FROM user_roles
WHERE role = 'SUPER_ADMIN';
-- 应该至少返回 1

-- 3. 查看所有用户及其角色
SELECT 
  u.id,
  u.name,
  u.phone,
  ur.role,
  u.created_at
FROM users u
LEFT JOIN user_roles ur ON u.id = ur.user_id
ORDER BY u.created_at;
```

**预期结果**：
- ✅ 所有用户都有角色
- ✅ 至少有一个 `SUPER_ADMIN` 用户
- ✅ 其他用户是 `DRIVER` 或 `MANAGER`

#### 第三步：如果需要车队长，手动添加 MANAGER 角色

如果您的系统需要车队长功能，需要手动将某些用户的角色改为 `MANAGER`：

```sql
-- 查看所有用户
SELECT id, name, phone, ur.role
FROM users u
LEFT JOIN user_roles ur ON u.id = ur.user_id
ORDER BY created_at;

-- 将某个用户改为 MANAGER（请替换 <用户ID>）
UPDATE user_roles
SET role = 'MANAGER'::user_role
WHERE user_id = '<用户ID>';

-- 或者直接插入（如果用户没有角色记录）
INSERT INTO user_roles (user_id, role, created_at)
VALUES ('<用户ID>', 'MANAGER'::user_role, NOW())
ON CONFLICT (user_id) DO UPDATE SET role = 'MANAGER'::user_role;
```

#### 第四步：为车队长分配仓库

如果您添加了 `MANAGER` 角色，还需要为车队长分配仓库，这样他们才能收到通知：

```sql
-- 1. 查看所有仓库
SELECT id, name FROM warehouses ORDER BY created_at;

-- 2. 为车队长分配仓库（请替换 <车队长ID> 和 <仓库ID>）
INSERT INTO warehouse_assignments (user_id, warehouse_id, created_at)
VALUES ('<车队长ID>', '<仓库ID>', NOW())
ON CONFLICT (user_id, warehouse_id) DO NOTHING;

-- 3. 验证分配结果
SELECT 
  u.name as user_name,
  w.name as warehouse_name,
  ur.role
FROM warehouse_assignments wa
JOIN users u ON wa.user_id = u.id
JOIN warehouses w ON wa.warehouse_id = w.id
LEFT JOIN user_roles ur ON u.id = ur.user_id
ORDER BY u.name;
```

---

## ✅ 修复完成后，继续以下测试

### 第五步：重新测试通知系统

现在用户角色已经修复，可以重新测试通知系统了。

#### 1. 刷新页面
- 退出登录
- 重新登录
- 确保使用的是有 `SUPER_ADMIN` 角色的账号

#### 2. 司机提交请假申请

1. **使用司机账号登录**
2. **打开浏览器控制台**（F12）
3. **提交一个请假申请**
4. **查看控制台日志**，应该看到：
   ```
   ✅ 请假申请创建成功: {
     applicationId: "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
     userId: "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
     ...
   }
   ```

5. **记录 `applicationId`**（后面需要用到）

**预期结果**：
- ✅ 提交成功
- ✅ `applicationId` 是一个有效的 UUID（不是 `'anon'`）
- ✅ 控制台没有错误信息

**如果出现错误**：
- 如果看到"创建申请失败：无效的申请ID"，说明数据库或认证有问题
- 请检查用户认证状态（第一步）
- 请确认数据清理是否成功

### 第三步：老板审批请假申请

1. **使用老板账号登录**
2. **打开浏览器控制台**（F12）
3. **进入"请假审批"页面**
4. **找到刚才提交的请假申请**
5. **点击"批准"或"拒绝"按钮**
6. **查看控制台日志**，应该看到：

```
🔍 开始查询原始申请通知: {
  related_id: "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
  type: "leave_application_submitted",
  current_user: "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
}

🔍 查询到 X 条原始申请通知

📋 通知详情:
  [1] ID: xxx
      接收者: xxx
      类型: leave_application_submitted
      关联ID: xxx
      审批状态: pending
      ...

📝 准备更新通知 xxx:
  - 接收者: xxx
  - 是否为审批人: true
  - 新状态: approved/rejected
  ...

✅ 成功更新通知 xxx

📊 通知更新结果: 成功 X 条, 失败 0 条

✅ 已发送审批结果通知给司机: xxx
```

**预期结果**：
- ✅ 查询到原始通知（至少 1 条）
- ✅ 所有通知更新成功
- ✅ 没有错误信息

**如果出现错误**：
- 如果看到"无效的申请ID，无法审批"，说明 `applicationId` 是 `'anon'`
- 如果看到"查询到 0 条原始申请通知"，说明通知没有创建或类型不匹配
- 如果看到"查询原始通知失败"，请查看具体的错误信息

### 第四步：检查通知中心

1. **使用老板账号查看通知中心**
2. **查找刚才审批的请假申请通知**
3. **确认通知状态**：
   - ✅ 应该只有**一条**通知
   - ✅ 通知标题应该是"请假审批通知"
   - ✅ 通知内容应该包含审批结果（"已批准"或"已拒绝"）
   - ✅ 通知状态应该是"已处理"（不是"待审批"）

**如果还有两条通知**：
- 请提供控制台日志截图
- 请提供通知中心截图
- 请说明两条通知的内容分别是什么

## 🔍 常见问题

### 问题 1：用户ID是 'anon'
**原因**：用户没有正确登录，使用了匿名会话

**解决方案**：
1. 退出登录
2. 清除浏览器缓存
3. 重新登录
4. 重新测试

### 问题 2：查询到 0 条原始通知
**原因**：
- 司机提交时通知创建失败
- 通知类型不匹配
- `related_id` 不匹配

**解决方案**：
1. 检查司机端的控制台日志，确认通知是否发送成功
2. 检查数据库：
```sql
SELECT id, recipient_id, type, title, related_id, approval_status
FROM notifications
WHERE related_id = '<applicationId>'
ORDER BY created_at;
```
3. 确认通知的 `type` 是 `'leave_application_submitted'`

### 问题 3：通知更新失败
**原因**：RLS 策略不允许更新

**解决方案**：
1. 检查错误信息
2. 确认用户角色是否为管理员
3. 检查 RLS 策略是否正确

## 📊 数据库检查

如果需要手动检查数据库，可以运行以下 SQL：

```sql
-- 1. 查看所有请假申请
SELECT id, user_id, leave_type, status, created_at
FROM leave_applications
ORDER BY created_at DESC
LIMIT 10;

-- 2. 查看所有请假相关通知
SELECT id, recipient_id, type, title, approval_status, related_id, created_at
FROM notifications
WHERE type IN ('leave_application_submitted', 'leave_approved', 'leave_rejected')
ORDER BY created_at DESC
LIMIT 20;

-- 3. 查看特定请假申请的所有通知
SELECT id, recipient_id, type, title, approval_status, is_read, created_at, updated_at
FROM notifications
WHERE related_id = '<applicationId>'
ORDER BY created_at;
```

## 📝 反馈信息

如果问题仍然存在，请提供以下信息：

1. **用户认证检查结果**：
   - 用户ID是什么？
   - 是否有效？

2. **司机端控制台日志**：
   - 完整的日志截图
   - 特别是"请假申请创建成功"部分

3. **老板端控制台日志**：
   - 完整的日志截图
   - 特别是"查询原始申请通知"和"通知更新结果"部分

4. **通知中心截图**：
   - 显示"两条信息"的截图
   - 两条信息的具体内容

5. **数据库查询结果**：
   - 请假申请记录
   - 相关通知记录

---

**最后更新**：2025-12-01
**状态**：等待测试结果
