# 车辆提车/还车管理功能实施方案

## 需求概述

### 核心功能
1. **车辆录入流程优化**：提供"提车录入"和"还车录入"两种操作
2. **车辆详情页面重构**：使用标签页展示提车照片、还车照片、行驶证照片
3. **操作状态与逻辑**：根据车辆状态动态显示操作按钮

---

## 一、数据库设计

### 1.1 vehicles 表字段扩展

需要添加以下字段：

| 字段名 | 类型 | 说明 | 默认值 |
|--------|------|------|--------|
| `pickup_time` | timestamptz | 提车时间 | NULL |
| `return_time` | timestamptz | 还车时间 | NULL |
| `pickup_photos` | text[] | 提车照片URL数组 | '{}' |
| `return_photos` | text[] | 还车照片URL数组 | '{}' |
| `registration_photos` | text[] | 行驶证照片URL数组 | '{}' |

### 1.2 status 字段值定义

| 状态值 | 说明 | 使用场景 |
|--------|------|----------|
| `picked_up` | 已提车（未还车） | 司机完成提车录入，尚未还车 |
| `returned` | 已还车 | 司机完成还车录入 |
| `active` | 使用中（保留） | 原有状态，兼容旧数据 |
| `inactive` | 已停用（保留） | 原有状态，兼容旧数据 |

### 1.3 迁移 SQL

```sql
-- 添加新字段
ALTER TABLE vehicles ADD COLUMN IF NOT EXISTS pickup_time timestamptz;
ALTER TABLE vehicles ADD COLUMN IF NOT EXISTS return_time timestamptz;
ALTER TABLE vehicles ADD COLUMN IF NOT EXISTS pickup_photos text[] DEFAULT '{}';
ALTER TABLE vehicles ADD COLUMN IF NOT EXISTS return_photos text[] DEFAULT '{}';
ALTER TABLE vehicles ADD COLUMN IF NOT EXISTS registration_photos text[] DEFAULT '{}';

-- 更新现有数据：将 active 状态的车辆改为 picked_up（假设已提车）
UPDATE vehicles SET status = 'picked_up' WHERE status = 'active';

-- 注释
COMMENT ON COLUMN vehicles.pickup_time IS '提车时间';
COMMENT ON COLUMN vehicles.return_time IS '还车时间';
COMMENT ON COLUMN vehicles.pickup_photos IS '提车照片URL数组';
COMMENT ON COLUMN vehicles.return_photos IS '还车照片URL数组';
COMMENT ON COLUMN vehicles.registration_photos IS '行驶证照片URL数组';
```

---

## 二、界面设计

### 2.1 车辆列表页面（vehicle-list）

#### 2.1.1 "添加新车辆"按钮显示逻辑

```typescript
// 判断是否显示"添加新车辆"按钮
const shouldShowAddButton = () => {
  // 如果没有车辆，显示按钮
  if (vehicles.length === 0) return true
  
  // 如果有任何车辆处于"已提车未还车"状态，隐藏按钮
  const hasPickedUpVehicle = vehicles.some(v => v.status === 'picked_up')
  return !hasPickedUpVehicle
}
```

#### 2.1.2 车辆卡片操作按钮逻辑

| 车辆状态 | 显示按钮 | 说明 |
|---------|---------|------|
| `picked_up` | "查看详情" + "还车" | 已提车未还车 |
| `returned` | "查看详情" | 已还车 |
| `active` | "查看详情" | 兼容旧数据 |
| `inactive` | "查看详情" | 兼容旧数据 |

#### 2.1.3 界面布局

```
┌─────────────────────────────────────────────────────────┐
│  我的车辆                                    2 辆       │
├─────────────────────────────────────────────────────────┤
│  [添加新车辆] ← 仅当所有车辆都已还车或没有车辆时显示   │
├─────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────┐   │
│  │  京A12345  [已提车]                            │   │
│  │  奔驰 E300                                      │   │
│  │  提车时间：2025-11-15 08:30                    │   │
│  │  ┌──────────────┐  ┌──────────────┐           │   │
│  │  │ 查看详情     │  │    还车      │           │   │
│  │  └──────────────┘  └──────────────┘           │   │
│  └─────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────┐   │
│  │  京B67890  [已还车]                            │   │
│  │  宝马 X5                                        │   │
│  │  提车时间：2025-11-10 09:00                    │   │
│  │  还车时间：2025-11-14 18:00                    │   │
│  │  ┌──────────────────────────────────────────┐  │   │
│  │  │         查看详情                         │  │   │
│  │  └──────────────────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
```

---

### 2.2 添加车辆页面（add-vehicle）

#### 2.2.1 功能定位
- 默认为"提车录入"
- 自动记录提车时间（当前时间）
- 上传提车照片和行驶证照片

#### 2.2.2 表单字段

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| 车牌号 | 文本 | ✅ | 必填 |
| 品牌 | 文本 | ✅ | 必填 |
| 型号 | 文本 | ✅ | 必填 |
| 颜色 | 文本 | ❌ | 可选 |
| 车身长度 | 数字 | ❌ | 可选 |
| VIN码 | 文本 | ❌ | 可选 |
| 提车照片 | 图片 | ✅ | 必填，至少1张 |
| 行驶证照片 | 图片 | ✅ | 必填，至少1张 |

#### 2.2.3 界面布局

```
┌─────────────────────────────────────────────────────────┐
│  提车录入                                               │
├─────────────────────────────────────────────────────────┤
│  基本信息                                               │
│  ┌─────────────────────────────────────────────────┐   │
│  │ 车牌号 *                                        │   │
│  │ [输入框]                                        │   │
│  └─────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────┐   │
│  │ 品牌 *                                          │   │
│  │ [输入框]                                        │   │
│  └─────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────┐   │
│  │ 型号 *                                          │   │
│  │ [输入框]                                        │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
│  提车照片 *                                             │
│  ┌─────────────────────────────────────────────────┐   │
│  │ [上传照片] [照片1] [照片2] ...                  │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
│  行驶证照片 *                                           │
│  ┌─────────────────────────────────────────────────┐   │
│  │ [上传照片] [照片1] [照片2] ...                  │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │              确认提车                           │   │
│  └─────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
```

---

### 2.3 还车录入页面（return-vehicle）

#### 2.3.1 功能定位
- 新建页面，专门用于还车操作
- 自动记录还车时间（当前时间）
- 上传还车照片

#### 2.3.2 页面路由
- 路径：`/pages/driver/return-vehicle/index`
- 参数：`vehicleId` - 车辆ID

#### 2.3.3 表单字段

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| 车辆信息 | 只读 | - | 显示车牌号、品牌型号 |
| 提车时间 | 只读 | - | 显示提车时间 |
| 还车照片 | 图片 | ✅ | 必填，至少1张 |
| 备注 | 文本 | ❌ | 可选 |

#### 2.3.4 界面布局

```
┌─────────────────────────────────────────────────────────┐
│  还车录入                                               │
├─────────────────────────────────────────────────────────┤
│  车辆信息                                               │
│  ┌─────────────────────────────────────────────────┐   │
│  │ 车牌号：京A12345                                │   │
│  │ 品牌型号：奔驰 E300                             │   │
│  │ 提车时间：2025-11-15 08:30                      │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
│  还车照片 *                                             │
│  ┌─────────────────────────────────────────────────┐   │
│  │ [上传照片] [照片1] [照片2] ...                  │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
│  备注                                                   │
│  ┌─────────────────────────────────────────────────┐   │
│  │ [文本框]                                        │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │              确认还车                           │   │
│  └─────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
```

---

### 2.4 车辆详情页面（vehicle-detail）

#### 2.4.1 功能定位
- 重构为标签页（Tab）布局
- 三个标签页：提车照片、还车照片、行驶证照片
- 显示对应的录入时间

#### 2.4.2 标签页设计

| 标签页 | 显示内容 | 录入时间 |
|--------|---------|---------|
| 提车照片 | pickup_photos | pickup_time |
| 还车照片 | return_photos | return_time |
| 行驶证照片 | registration_photos | pickup_time（与提车同时录入） |

#### 2.4.3 界面布局

```
┌─────────────────────────────────────────────────────────┐
│  车辆详情                                               │
├─────────────────────────────────────────────────────────┤
│  基本信息                                               │
│  ┌─────────────────────────────────────────────────┐   │
│  │ 车牌号：京A12345                                │   │
│  │ 品牌型号：奔驰 E300                             │   │
│  │ 颜色：黑色                                      │   │
│  │ 状态：已提车                                    │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
│  ┌─────────┬─────────┬─────────┐                      │
│  │ 提车照片 │ 还车照片 │ 行驶证  │ ← 标签页            │
│  └─────────┴─────────┴─────────┘                      │
│  ┌─────────────────────────────────────────────────┐   │
│  │ 📅 提车时间：2025-11-15 08:30                  │   │
│  │                                                 │   │
│  │ [照片1]  [照片2]  [照片3]                      │   │
│  │                                                 │   │
│  │ [照片4]  [照片5]                                │   │
│  └─────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
```

---

## 三、业务逻辑

### 3.1 车辆状态流转

```
┌─────────┐
│  无车辆  │
└────┬────┘
     │ 添加车辆（提车录入）
     ↓
┌─────────┐
│ picked_up│ ← 已提车未还车
└────┬────┘
     │ 还车录入
     ↓
┌─────────┐
│ returned │ ← 已还车
└─────────┘
```

### 3.2 操作权限矩阵

| 车辆状态 | 可以提车 | 可以还车 | 可以查看 | 可以删除 |
|---------|---------|---------|---------|---------|
| 无车辆 | ✅ | ❌ | ❌ | ❌ |
| picked_up | ❌ | ✅ | ✅ | ❌ |
| returned | ✅（新车） | ❌ | ✅ | ❌ |

### 3.3 "添加新车辆"按钮显示逻辑

```typescript
// 伪代码
function shouldShowAddButton(vehicles: Vehicle[]): boolean {
  // 1. 没有车辆 → 显示
  if (vehicles.length === 0) {
    return true
  }
  
  // 2. 有任何车辆处于"已提车未还车"状态 → 隐藏
  const hasPickedUpVehicle = vehicles.some(v => v.status === 'picked_up')
  if (hasPickedUpVehicle) {
    return false
  }
  
  // 3. 所有车辆都已还车 → 显示
  return true
}
```

### 3.4 车辆卡片按钮显示逻辑

```typescript
// 伪代码
function getVehicleActions(vehicle: Vehicle): Action[] {
  const actions: Action[] = []
  
  // 查看详情按钮（始终显示）
  actions.push({
    label: '查看详情',
    type: 'view',
    handler: () => viewDetail(vehicle.id)
  })
  
  // 还车按钮（仅在已提车未还车时显示）
  if (vehicle.status === 'picked_up') {
    actions.push({
      label: '还车',
      type: 'return',
      handler: () => returnVehicle(vehicle.id)
    })
  }
  
  return actions
}
```

---

## 四、API 设计

### 4.1 新增 API 函数

#### 4.1.1 还车录入

```typescript
/**
 * 还车录入
 * @param vehicleId 车辆ID
 * @param returnPhotos 还车照片URL数组
 * @param notes 备注
 */
export async function returnVehicle(
  vehicleId: string,
  returnPhotos: string[],
  notes?: string
): Promise<boolean> {
  const {error} = await supabase
    .from('vehicles')
    .update({
      status: 'returned',
      return_time: new Date().toISOString(),
      return_photos: returnPhotos
    })
    .eq('id', vehicleId)
  
  return !error
}
```

#### 4.1.2 更新添加车辆函数

```typescript
/**
 * 添加车辆（提车录入）
 * @param vehicleData 车辆数据
 */
export async function addVehicle(vehicleData: {
  plate_number: string
  brand: string
  model: string
  color?: string
  length?: number
  vin?: string
  pickup_photos: string[]  // 提车照片
  registration_photos: string[]  // 行驶证照片
}): Promise<Vehicle | null> {
  const {data, error} = await supabase
    .from('vehicles')
    .insert({
      ...vehicleData,
      user_id: getCurrentUserId(),
      status: 'picked_up',  // 默认状态为已提车
      pickup_time: new Date().toISOString(),  // 记录提车时间
      created_at: new Date().toISOString()
    })
    .select()
    .single()
  
  return error ? null : data
}
```

---

## 五、实施步骤

### 步骤1：数据库迁移
- [ ] 创建迁移 SQL 文件
- [ ] 执行数据库迁移
- [ ] 更新 TypeScript 类型定义

### 步骤2：更新 API 函数
- [ ] 修改 `addVehicle` 函数（提车录入）
- [ ] 新增 `returnVehicle` 函数（还车录入）
- [ ] 更新 `getDriverVehicles` 函数（支持新字段）

### 步骤3：修改车辆列表页面
- [ ] 实现"添加新车辆"按钮显示逻辑
- [ ] 实现车辆卡片按钮动态显示
- [ ] 添加状态标签显示
- [ ] 添加提车/还车时间显示

### 步骤4：修改添加车辆页面
- [ ] 更新页面标题为"提车录入"
- [ ] 添加提车照片上传
- [ ] 添加行驶证照片上传
- [ ] 更新提交逻辑

### 步骤5：创建还车录入页面
- [ ] 创建页面文件和配置
- [ ] 实现车辆信息显示
- [ ] 实现还车照片上传
- [ ] 实现还车提交逻辑
- [ ] 添加路由配置

### 步骤6：重构车辆详情页面
- [ ] 实现标签页布局
- [ ] 实现提车照片标签页
- [ ] 实现还车照片标签页
- [ ] 实现行驶证照片标签页
- [ ] 显示录入时间

### 步骤7：测试
- [ ] 测试提车录入流程
- [ ] 测试还车录入流程
- [ ] 测试按钮显示逻辑
- [ ] 测试标签页切换
- [ ] 测试时间显示

---

## 六、测试场景

### 场景1：新司机首次添加车辆
1. 司机登录，没有车辆
2. 显示"添加新车辆"按钮
3. 点击按钮，进入"提车录入"页面
4. 填写车辆信息，上传提车照片和行驶证照片
5. 提交后，车辆状态为"已提车"
6. 返回列表，"添加新车辆"按钮隐藏
7. 车辆卡片显示"查看详情"和"还车"按钮

### 场景2：司机还车
1. 司机有一辆"已提车"的车辆
2. 点击"还车"按钮
3. 进入"还车录入"页面
4. 上传还车照片
5. 提交后，车辆状态变为"已还车"
6. 返回列表，"添加新车辆"按钮显示
7. 车辆卡片只显示"查看详情"按钮

### 场景3：查看车辆详情
1. 点击"查看详情"按钮
2. 进入车辆详情页面
3. 默认显示"提车照片"标签页
4. 显示提车时间和提车照片
5. 切换到"行驶证照片"标签页
6. 显示提车时间和行驶证照片
7. 如果已还车，切换到"还车照片"标签页
8. 显示还车时间和还车照片

### 场景4：多辆车辆管理
1. 司机有2辆车，一辆"已提车"，一辆"已还车"
2. "添加新车辆"按钮隐藏（因为有车辆未还车）
3. "已提车"的车辆显示"查看详情"和"还车"按钮
4. "已还车"的车辆只显示"查看详情"按钮
5. 将"已提车"的车辆还车后
6. "添加新车辆"按钮显示

---

## 七、注意事项

### 7.1 数据兼容性
- 现有车辆数据需要迁移
- `active` 状态的车辆建议改为 `picked_up`
- `inactive` 状态的车辆保持不变

### 7.2 照片存储
- 使用 Supabase Storage 存储照片
- 照片 URL 存储在数组字段中
- 建议限制每个类型的照片数量（如最多10张）

### 7.3 时间显示
- 使用本地时区显示时间
- 格式：YYYY-MM-DD HH:mm
- 显示相对时间（如"2小时前"）

### 7.4 用户体验
- 提车/还车操作需要确认弹窗
- 上传照片时显示进度
- 操作成功后显示提示
- 返回列表时刷新数据

---

## 八、后续优化建议

### 8.1 功能增强
- 添加车辆使用记录统计
- 支持批量上传照片
- 支持照片预览和放大
- 添加照片备注功能

### 8.2 数据分析
- 统计车辆使用时长
- 分析提车/还车频率
- 生成车辆使用报表

### 8.3 通知提醒
- 提车后超过一定时间未还车，发送提醒
- 还车成功后发送通知

---

**文档版本**: 1.0  
**创建日期**: 2025-11-15  
**状态**: 待实施
