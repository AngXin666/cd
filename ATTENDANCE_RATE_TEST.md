# 出勤率功能测试指南

## 测试目标
验证双管理端计件报表中的出勤率显示功能是否正常工作。

## 测试页面

### 1. 普通管理端计件报表
- **路径**: `/pages/manager/piece-work-report/index`
- **访问方式**: 管理员登录 → 底部导航"工作台" → 点击"计件报表"

### 2. 超级管理端计件报表
- **路径**: `/pages/super-admin/piece-work-report/index`
- **访问方式**: 超级管理员登录 → 底部导航"工作台" → 点击"计件报表"

## 测试步骤

### 测试 1: 正常出勤率显示

**前置条件**:
- 仓库中已分配司机（例如：5 名司机）
- 部分司机已打卡（例如：3 名司机）

**操作步骤**:
1. 登录管理员或超级管理员账号
2. 进入计件报表页面
3. 查看"当日出勤"卡片

**预期结果**:
- 大号数字显示: `3`
- 小号文字显示: `3/5 (60%)`
- 出勤率计算正确: 3 ÷ 5 × 100% = 60%

### 测试 2: 100% 出勤率

**前置条件**:
- 仓库中已分配司机（例如：5 名司机）
- 所有司机都已打卡（5 名司机）

**操作步骤**:
1. 确保所有司机都已打卡
2. 刷新计件报表页面
3. 查看"当日出勤"卡片

**预期结果**:
- 大号数字显示: `5`
- 小号文字显示: `5/5 (100%)`
- 出勤率为 100%

### 测试 3: 0% 出勤率

**前置条件**:
- 仓库中已分配司机（例如：5 名司机）
- 没有司机打卡（0 名司机）

**操作步骤**:
1. 确保没有司机打卡（或选择一个没有打卡记录的日期）
2. 查看"当日出勤"卡片

**预期结果**:
- 大号数字显示: `0`
- 小号文字显示: `0/5 (0%)`
- 出勤率为 0%

### 测试 4: 无司机分配

**前置条件**:
- 仓库中没有分配司机（0 名司机）

**操作步骤**:
1. 选择一个没有分配司机的仓库
2. 查看"当日出勤"卡片

**预期结果**:
- 大号数字显示: `0`
- 小号文字显示: `暂无数据`
- 不显示出勤率（避免除以零）

### 测试 5: 小数百分比四舍五入

**前置条件**:
- 仓库中已分配司机（例如：7 名司机）
- 部分司机已打卡（例如：2 名司机）

**操作步骤**:
1. 确保出勤人数和总人数的比例会产生小数
2. 查看"当日出勤"卡片

**预期结果**:
- 大号数字显示: `2`
- 小号文字显示: `2/7 (29%)`
- 出勤率正确四舍五入: 2 ÷ 7 × 100% = 28.57% → 29%

**其他测试用例**:
- 3/7 → 42.86% → 显示 `3/7 (43%)`
- 4/7 → 57.14% → 显示 `4/7 (57%)`
- 5/7 → 71.43% → 显示 `5/7 (71%)`

### 测试 6: 仓库切换

**前置条件**:
- 有多个仓库，每个仓库的司机数和出勤情况不同

**操作步骤**:
1. 在计件报表页面
2. 使用仓库切换器切换到不同的仓库
3. 观察"当日出勤"卡片的变化

**预期结果**:
- 切换仓库后，出勤人数和总人数正确更新
- 出勤率百分比正确更新
- 数据与当前选中的仓库匹配

### 测试 7: 数据刷新

**前置条件**:
- 页面已加载，显示当前出勤数据

**操作步骤**:
1. 在另一个设备或浏览器中，让一名司机打卡
2. 在计件报表页面下拉刷新
3. 观察"当日出勤"卡片的变化

**预期结果**:
- 出勤人数增加 1
- 出勤率百分比正确更新
- 数据实时同步

## 测试数据准备

### 创建测试场景

**场景 1: 正常出勤**
```
仓库: 测试仓库 A
总司机: 5 名
出勤司机: 3 名
预期显示: 3/5 (60%)
```

**场景 2: 完全出勤**
```
仓库: 测试仓库 B
总司机: 4 名
出勤司机: 4 名
预期显示: 4/4 (100%)
```

**场景 3: 无人出勤**
```
仓库: 测试仓库 C
总司机: 6 名
出勤司机: 0 名
预期显示: 0/6 (0%)
```

**场景 4: 小数百分比**
```
仓库: 测试仓库 D
总司机: 7 名
出勤司机: 2 名
预期显示: 2/7 (29%)
```

**场景 5: 无司机分配**
```
仓库: 测试仓库 E
总司机: 0 名
出勤司机: 0 名
预期显示: 暂无数据
```

## 验证清单

### 功能验证
- [ ] 出勤率计算正确
- [ ] 百分比四舍五入正确
- [ ] 显示格式正确（X/Y (Z%)）
- [ ] 无数据时显示"暂无数据"
- [ ] 仓库切换时数据正确更新

### 界面验证
- [ ] 文字清晰可读
- [ ] 颜色对比度合适（白色文字在深色背景上）
- [ ] 布局整齐，没有重叠
- [ ] 响应式设计正常

### 边界情况验证
- [ ] 总司机数为 0 时不报错
- [ ] 出勤率为 0% 时正常显示
- [ ] 出勤率为 100% 时正常显示
- [ ] 小数百分比正确四舍五入

### 性能验证
- [ ] 页面加载速度正常
- [ ] 数据刷新流畅
- [ ] 仓库切换响应及时

## 常见问题排查

### 问题 1: 出勤率显示为 NaN%
**原因**: 总司机数为 0，导致除以零
**解决**: 检查条件判断 `dashboardData.totalDrivers > 0`

### 问题 2: 出勤率计算不正确
**原因**: 数据源错误或计算公式错误
**解决**: 
1. 检查 `dashboardData.todayDrivers` 和 `dashboardData.totalDrivers` 的值
2. 验证计算公式: `Math.round((todayDrivers / totalDrivers) * 100)`

### 问题 3: 仓库切换后数据不更新
**原因**: 数据没有重新加载
**解决**: 检查仓库切换时是否触发了数据刷新

### 问题 4: 显示"暂无数据"但实际有司机
**原因**: `totalDrivers` 为 0 或数据加载失败
**解决**: 
1. 检查仓库是否分配了司机
2. 检查数据加载逻辑

## 测试报告模板

```
测试日期: ____________________
测试人员: ____________________
测试环境: [ ] H5  [ ] 小程序

测试结果:
┌─────────────────────────────────────────────────┐
│ 测试项                    │ 结果  │ 备注        │
├─────────────────────────────────────────────────┤
│ 正常出勤率显示            │ □通过 │             │
│ 100% 出勤率               │ □通过 │             │
│ 0% 出勤率                 │ □通过 │             │
│ 无司机分配                │ □通过 │             │
│ 小数百分比四舍五入        │ □通过 │             │
│ 仓库切换                  │ □通过 │             │
│ 数据刷新                  │ □通过 │             │
└─────────────────────────────────────────────────┘

发现的问题:
1. ________________________________________________
2. ________________________________________________
3. ________________________________________________

总体评价: [ ] 通过  [ ] 需要修复  [ ] 需要优化

签名: ____________________
```

## 自动化测试建议

### 单元测试
```typescript
describe('出勤率计算', () => {
  it('应该正确计算出勤率', () => {
    const todayDrivers = 3
    const totalDrivers = 5
    const rate = Math.round((todayDrivers / totalDrivers) * 100)
    expect(rate).toBe(60)
  })

  it('应该正确四舍五入', () => {
    const todayDrivers = 2
    const totalDrivers = 7
    const rate = Math.round((todayDrivers / totalDrivers) * 100)
    expect(rate).toBe(29) // 28.57 → 29
  })

  it('总司机数为0时不应该计算', () => {
    const totalDrivers = 0
    const shouldCalculate = totalDrivers > 0
    expect(shouldCalculate).toBe(false)
  })
})
```

## 总结

完成以上所有测试后，应该能够确认：
- ✅ 出勤率功能正常工作
- ✅ 所有边界情况都得到正确处理
- ✅ 用户界面清晰易懂
- ✅ 性能表现良好

如果发现任何问题，请参考"常见问题排查"部分或联系开发团队。
