/*
# 允许超级管理员插入管理员记录

## 问题描述
当前的 RLS 策略中，超级管理员虽然有 "超级管理员完全访问" 策略（FOR ALL），
但在某些情况下可能需要更明确的 INSERT 策略来确保超级管理员可以创建管理员账号。

## 解决方案
添加明确的 RLS 策略，允许超级管理员插入任何角色的用户记录（包括管理员）。

## 策略设计

### 超级管理员插入用户的权限
- 超级管理员可以插入任何角色的用户记录
- 包括：driver（司机）、manager（管理员）、super_admin（超级管理员）

## 安全性考虑
1. 只有超级管理员才能创建管理员账号
2. 普通管理员只能创建司机账号（已有策略）
3. 保持最小权限原则

## 注意事项
- 超级管理员的 "FOR ALL" 策略理论上已经包含了 INSERT 权限
- 但为了明确性和调试方便，添加专门的 INSERT 策略
- 如果发现策略冲突，可以删除此策略，依赖 "FOR ALL" 策略
*/

-- ============================================
-- 删除旧策略（如果存在）
-- ============================================

DROP POLICY IF EXISTS "超级管理员插入任何用户" ON profiles;

-- ============================================
-- 创建新的 INSERT 策略
-- ============================================

-- 超级管理员：插入任何角色的用户记录
CREATE POLICY "超级管理员插入任何用户"
ON profiles
FOR INSERT
TO authenticated
WITH CHECK (
  -- 当前用户必须是超级管理员
  is_super_admin(auth.uid())
);

-- ============================================
-- 验证策略
-- ============================================

-- 查看 profiles 表的所有策略
-- SELECT 
--   schemaname,
--   tablename,
--   policyname,
--   cmd,
--   roles
-- FROM pg_policies
-- WHERE schemaname = 'public' AND tablename = 'profiles'
-- ORDER BY policyname;

-- 预期结果：应该包含新的策略
-- - 超级管理员插入任何用户 (INSERT)
