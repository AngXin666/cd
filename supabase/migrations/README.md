# 数据库迁移文件说明

本目录包含所有数据库迁移文件，按照执行顺序编号。

## 迁移文件列表

### 01_create_profiles_table.sql
创建用户档案表（profiles）和相关的权限控制。

**主要内容**：
- 创建 `user_role` 枚举类型（driver, manager, super_admin）
- 创建 `profiles` 表存储用户信息
- 设置行级安全策略（RLS）
- 创建触发器，首位注册用户自动成为超级管理员

### 02_create_test_accounts.sql
在 profiles 表中创建测试账号的档案记录。

**创建的账号**：
- admin（超级管理员）
- admin1（司机）
- admin2（普通管理员）

### 03_create_auth_test_users.sql
在 auth.users 表中创建测试账号的认证记录。

**主要内容**：
- 为每个测试账号创建 auth.users 记录
- 设置邮箱地址（格式：账号名@fleet.com）
- 设置 phone 字段为账号名（用于账号名登录）
- 标记手机号已确认

### 04_fix_test_accounts_password.sql
使用 PostgreSQL 的 crypt() 函数为测试账号设置正确的密码。

**密码信息**：
- 明文密码：123456
- 使用 crypt() 函数自动生成 bcrypt 哈希
- 这是设置密码的正确方式，确保密码可以被 Supabase Auth 正确验证

## 登录机制说明

系统支持两种登录方式：

### 1. 账号名登录
- 输入账号名（如：admin）
- 系统自动转换为邮箱格式（admin@fleet.com）
- 使用邮箱+密码进行认证

### 2. 手机号登录
- 输入11位手机号
- 使用手机号+密码进行认证
- 或使用手机号+验证码进行认证

## 注意事项

1. **密码安全**：生产环境中应使用更强的密码策略
2. **测试账号**：这些测试账号仅用于开发和测试，生产环境应删除
3. **迁移顺序**：必须按照文件编号顺序执行迁移
4. **RLS 策略**：确保理解行级安全策略的工作原理，避免数据泄露
