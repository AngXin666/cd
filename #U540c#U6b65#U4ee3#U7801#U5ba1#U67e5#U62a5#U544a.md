# è½¦é˜Ÿç®¡å®¶å°ç¨‹åº - åŒæ­¥ä»£ç å®¡æŸ¥æŠ¥å‘Š

## æ‰§è¡Œæ—¶é—´
**2025-11-05**

## å®¡æŸ¥èŒƒå›´
- å®æ—¶æ•°æ®åŒæ­¥æœºåˆ¶ï¼ˆSupabase Realtimeï¼‰
- ç¼“å­˜ç®¡ç†ç³»ç»Ÿ
- æ•°æ®åº“æ“ä½œAPI
- é”™è¯¯å¤„ç†å’Œå¼‚å¸¸æ¢å¤
- æ€§èƒ½ä¼˜åŒ–å’Œèµ„æºç®¡ç†

---

## ä¸€ã€å®¡æŸ¥æ€»ç»“

### æ•´ä½“è¯„ä»·
**è¯„åˆ†ï¼š75/100**

**ä¼˜ç‚¹**ï¼š
- âœ… å®ç°äº†å®Œæ•´çš„å®æ—¶åŒæ­¥æœºåˆ¶
- âœ… ç¼“å­˜ç­–ç•¥è®¾è®¡åˆç†
- âœ… é˜²æ­¢é‡å¤åŠ è½½çš„ä¿æŠ¤æœºåˆ¶
- âœ… è®¢é˜…æ¸…ç†æœºåˆ¶å®Œå–„

**ä¸»è¦é—®é¢˜**ï¼š
- âš ï¸ å­˜åœ¨å¤šä¸ªä¸¥é‡çš„æ€§èƒ½å’Œé€»è¾‘é—®é¢˜
- âš ï¸ ç¼ºå°‘é”™è¯¯æ¢å¤å’Œé‡è¯•æœºåˆ¶
- âš ï¸ å­˜åœ¨æ½œåœ¨çš„å†…å­˜æ³„éœ²é£é™©
- âš ï¸ æ•°æ®ä¸€è‡´æ€§ä¿éšœä¸è¶³

---

## äºŒã€å‘ç°çš„ä¸¥é‡é—®é¢˜

### ğŸ”´ é—®é¢˜1ï¼šå®æ—¶è®¢é˜…è§¦å‘æ— é™åˆ·æ–°å¾ªç¯

**ä½ç½®**ï¼š
- `src/hooks/useDriverDashboard.ts` (ç¬¬256è¡Œ)
- `src/hooks/useDashboardData.ts` (ç¬¬173è¡Œ)
- `src/hooks/useSuperAdminDashboard.ts` (ç¬¬185è¡Œ)

**é—®é¢˜æè¿°**ï¼š
å®æ—¶è®¢é˜…çš„å›è°ƒå‡½æ•°ç›´æ¥è°ƒç”¨ `refresh()`ï¼Œè€Œ `refresh()` ä¾èµ–äº `useCallback` çš„ä¾èµ–é¡¹ï¼Œå¯èƒ½å¯¼è‡´ï¼š
1. æ¯æ¬¡æ•°æ®å˜åŒ–è§¦å‘åˆ·æ–°
2. åˆ·æ–°å¯¼è‡´ç»„ä»¶é‡æ–°æ¸²æŸ“
3. é‡æ–°æ¸²æŸ“å¯èƒ½å¯¼è‡´ `refresh` å‡½æ•°é‡æ–°åˆ›å»º
4. æ–°çš„ `refresh` å‡½æ•°å¯¼è‡´ `useEffect` é‡æ–°æ‰§è¡Œ
5. é‡æ–°è®¢é˜…ï¼Œå½¢æˆæ— é™å¾ªç¯

**ä»£ç ç¤ºä¾‹**ï¼š
```typescript
// useDriverDashboard.ts - ç¬¬256è¡Œ
channel.on('postgres_changes', {...}, (payload) => {
  console.log('[useDriverDashboard] è®¡ä»¶è®°å½•å˜åŒ–:', payload)
  refresh() // âš ï¸ å¯èƒ½è§¦å‘æ— é™å¾ªç¯
})

// ç¬¬301è¡Œ - refresh åœ¨ä¾èµ–é¡¹ä¸­
useEffect(() => {
  // ...è®¢é˜…è®¾ç½®
}, [enableRealtime, userId, warehouseId, refresh]) // âš ï¸ refresh åœ¨ä¾èµ–é¡¹ä¸­
```

**å½±å“**ï¼š
- ğŸ”´ ä¸¥é‡æ€§èƒ½é—®é¢˜
- ğŸ”´ å¯èƒ½å¯¼è‡´åº”ç”¨å¡æ­»
- ğŸ”´ æµªè´¹ç½‘ç»œå¸¦å®½å’ŒæœåŠ¡å™¨èµ„æº
- ğŸ”´ ç”¨æˆ·ä½“éªŒæå·®

**å¤ç°æ¡ä»¶**ï¼š
1. ç”¨æˆ·åœ¨å¸æœºç«¯æŸ¥çœ‹ä»ªè¡¨æ¿
2. ç®¡ç†å‘˜ä¿®æ”¹è¯¥å¸æœºçš„è®¡ä»¶è®°å½•
3. è§¦å‘å®æ—¶æ›´æ–°
4. å¯èƒ½è¿›å…¥æ— é™åˆ·æ–°å¾ªç¯

---

### ğŸ”´ é—®é¢˜2ï¼šç¼“å­˜å¤±æ•ˆå¯¼è‡´çš„ç«æ€æ¡ä»¶

**ä½ç½®**ï¼š
- `src/hooks/useDriverDashboard.ts` (ç¬¬225-229è¡Œ)
- `src/hooks/useDashboardData.ts` (ç¬¬143-148è¡Œ)

**é—®é¢˜æè¿°**ï¼š
`refresh()` å‡½æ•°å…ˆæ¸…é™¤ç¼“å­˜ï¼Œç„¶åè°ƒç”¨ `loadStats()`ï¼Œä½†è¿™ä¸¤ä¸ªæ“ä½œä¸æ˜¯åŸå­çš„ï¼š

```typescript
// useDriverDashboard.ts - ç¬¬225è¡Œ
const refresh = useCallback(() => {
  console.log('[useDriverDashboard] æ‰‹åŠ¨åˆ·æ–°æ•°æ®')
  clearCache()      // æ­¥éª¤1ï¼šæ¸…é™¤ç¼“å­˜
  loadStats()       // æ­¥éª¤2ï¼šåŠ è½½æ•°æ®
}, [clearCache, loadStats])
```

**ç«æ€æ¡ä»¶åœºæ™¯**ï¼š
1. ç”¨æˆ·Aè§¦å‘åˆ·æ–°ï¼Œæ¸…é™¤ç¼“å­˜
2. ç”¨æˆ·BåŒæ—¶è§¦å‘åˆ·æ–°ï¼Œä¹Ÿæ¸…é™¤ç¼“å­˜
3. ç”¨æˆ·Aå¼€å§‹åŠ è½½æ•°æ®
4. ç”¨æˆ·Bä¹Ÿå¼€å§‹åŠ è½½æ•°æ®
5. ä¸¤ä¸ªè¯·æ±‚åŒæ—¶è¿›è¡Œï¼Œå¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´

**å½±å“**ï¼š
- ğŸŸ¡ æ•°æ®å¯èƒ½ä¸ä¸€è‡´
- ğŸŸ¡ é‡å¤çš„ç½‘ç»œè¯·æ±‚
- ğŸŸ¡ ç¼“å­˜å¯èƒ½è¢«æ—§æ•°æ®è¦†ç›–

---

### ğŸ”´ é—®é¢˜3ï¼šç¼“å­˜é”®å†²çªé£é™©

**ä½ç½®**ï¼š
- `src/hooks/useDriverDashboard.ts` (ç¬¬62-64è¡Œ)
- `src/hooks/useDriverWarehouses.ts` (ç¬¬326è¡Œ)

**é—®é¢˜æè¿°**ï¼š
ç¼“å­˜é”®ç”Ÿæˆé€»è¾‘å¯èƒ½å¯¼è‡´å†²çªï¼š

```typescript
// useDriverDashboard.ts - ç¬¬62è¡Œ
const getCacheKey = useCallback(() => {
  return `${CACHE_KEY_PREFIX}${warehouseId || 'all'}`
}, [warehouseId])
// âš ï¸ ç¼ºå°‘ userIdï¼Œä¸åŒç”¨æˆ·å¯èƒ½å…±äº«ç¼“å­˜

// useDriverWarehouses.ts - ç¬¬326è¡Œ
const CACHE_KEY = `driver_warehouses_${userId}`
// âœ… åŒ…å« userIdï¼Œæ­£ç¡®
```

**é—®é¢˜åœºæ™¯**ï¼š
1. å¸æœºAæŸ¥çœ‹ä»“åº“1çš„æ•°æ®ï¼Œç¼“å­˜é”®ï¼š`driver_dashboard_warehouse1`
2. å¸æœºBä¹ŸæŸ¥çœ‹ä»“åº“1çš„æ•°æ®ï¼Œç¼“å­˜é”®ï¼š`driver_dashboard_warehouse1`
3. å¸æœºBçœ‹åˆ°çš„æ˜¯å¸æœºAçš„æ•°æ®ï¼

**å½±å“**ï¼š
- ğŸ”´ ä¸¥é‡çš„æ•°æ®æ³„éœ²é—®é¢˜
- ğŸ”´ ç”¨æˆ·çœ‹åˆ°å…¶ä»–ç”¨æˆ·çš„æ•°æ®
- ğŸ”´ è¿åæ•°æ®éšç§åŸåˆ™

---

### ğŸŸ¡ é—®é¢˜4ï¼šç¼ºå°‘é”™è¯¯é‡è¯•æœºåˆ¶

**ä½ç½®**ï¼š
- `src/db/api.ts` (æ‰€æœ‰æ•°æ®åº“æ“ä½œå‡½æ•°)
- `src/hooks/useDriverDashboard.ts` (ç¬¬142-221è¡Œ)

**é—®é¢˜æè¿°**ï¼š
æ‰€æœ‰æ•°æ®åº“æ“ä½œå’Œæ•°æ®åŠ è½½éƒ½æ²¡æœ‰é‡è¯•æœºåˆ¶ï¼š

```typescript
// api.ts - ç¬¬790è¡Œ
export async function createPieceWorkRecord(record: PieceWorkRecordInput): Promise<boolean> {
  const {error} = await supabase.from('piece_work_records').insert(record)
  
  if (error) {
    console.error('åˆ›å»ºè®¡ä»¶è®°å½•å¤±è´¥:', error)
    return false  // âš ï¸ ç›´æ¥è¿”å›å¤±è´¥ï¼Œä¸é‡è¯•
  }
  
  return true
}
```

**å½±å“**ï¼š
- ğŸŸ¡ ç½‘ç»œæ³¢åŠ¨å¯¼è‡´æ“ä½œå¤±è´¥
- ğŸŸ¡ ç”¨æˆ·ä½“éªŒå·®
- ğŸŸ¡ æ•°æ®å¯èƒ½ä¸¢å¤±

**å¸¸è§å¤±è´¥åœºæ™¯**ï¼š
- ç½‘ç»œä¸ç¨³å®š
- æœåŠ¡å™¨ä¸´æ—¶ä¸å¯ç”¨
- æ•°æ®åº“è¿æ¥è¶…æ—¶

---

### ğŸŸ¡ é—®é¢˜5ï¼šè®¢é˜…æ¸…ç†ä¸å½»åº•

**ä½ç½®**ï¼š
- `src/hooks/useDriverWarehouses.ts` (ç¬¬459-469è¡Œ)

**é—®é¢˜æè¿°**ï¼š
è®¢é˜…æ¸…ç†é€»è¾‘ä¸ä¸€è‡´ï¼š

```typescript
// useDriverWarehouses.ts - ç¬¬459è¡Œ
return () => {
  console.log('[useDriverWarehouses] æ¸…ç†è®¢é˜…')
  if (channelRef.current) {
    channelRef.current.unsubscribe()  // âš ï¸ ä½¿ç”¨ unsubscribe()
    channelRef.current = null
  }
}

// useDriverDashboard.ts - ç¬¬296è¡Œ
return () => {
  console.log('[useDriverDashboard] æ¸…ç†å®æ—¶è®¢é˜…')
  if (channelRef.current) {
    supabase.removeChannel(channelRef.current)  // âš ï¸ ä½¿ç”¨ removeChannel()
    channelRef.current = null
  }
}
```

**é—®é¢˜**ï¼š
- æ¸…ç†æ–¹æ³•ä¸ç»Ÿä¸€ï¼ˆ`unsubscribe()` vs `removeChannel()`ï¼‰
- å¯èƒ½å¯¼è‡´è®¢é˜…æœªå®Œå…¨æ¸…ç†
- æ½œåœ¨çš„å†…å­˜æ³„éœ²é£é™©

**å½±å“**ï¼š
- ğŸŸ¡ å†…å­˜æ³„éœ²
- ğŸŸ¡ è®¢é˜…å¯èƒ½ç»§ç»­æ¥æ”¶æ¶ˆæ¯
- ğŸŸ¡ æ€§èƒ½ä¸‹é™

---

### ğŸŸ¡ é—®é¢˜6ï¼šç¼“å­˜è¿‡æœŸæ—¶é—´ä¸åˆç†

**ä½ç½®**ï¼š
- `src/hooks/useDriverDashboard.ts` (ç¬¬20è¡Œ)
- `src/hooks/useDashboardData.ts` (ç¬¬10è¡Œ)
- `src/hooks/useDriverWarehouses.ts` (ç¬¬327è¡Œ)

**é—®é¢˜æè¿°**ï¼š
ä¸åŒç±»å‹çš„æ•°æ®ä½¿ç”¨ç›¸åŒæˆ–ä¸åˆç†çš„ç¼“å­˜æ—¶é—´ï¼š

```typescript
// useDriverDashboard.ts - ç¬¬20è¡Œ
const CACHE_EXPIRY_MS = 5 * 60 * 1000 // 5åˆ†é’Ÿ
// âš ï¸ ç»Ÿè®¡æ•°æ®5åˆ†é’Ÿç¼“å­˜å¯èƒ½è¿‡é•¿

// useDriverWarehouses.ts - ç¬¬327è¡Œ
const CACHE_EXPIRY_MS = 1 * 60 * 1000 // 1åˆ†é’Ÿ
// âš ï¸ ä»“åº“åˆ—è¡¨1åˆ†é’Ÿç¼“å­˜å¯èƒ½è¿‡çŸ­
```

**é—®é¢˜**ï¼š
- ç»Ÿè®¡æ•°æ®å˜åŒ–é¢‘ç¹ï¼Œ5åˆ†é’Ÿç¼“å­˜å¯èƒ½å¯¼è‡´æ•°æ®ä¸å‡†ç¡®
- ä»“åº“åˆ—è¡¨å˜åŒ–ä¸é¢‘ç¹ï¼Œ1åˆ†é’Ÿç¼“å­˜å¯¼è‡´é¢‘ç¹è¯·æ±‚
- æ²¡æœ‰æ ¹æ®æ•°æ®ç‰¹æ€§è®¾ç½®åˆç†çš„ç¼“å­˜æ—¶é—´

**å½±å“**ï¼š
- ğŸŸ¡ æ•°æ®å¯èƒ½ä¸å‡†ç¡®
- ğŸŸ¡ ä¸å¿…è¦çš„ç½‘ç»œè¯·æ±‚
- ğŸŸ¡ æ€§èƒ½æµªè´¹

---

### ğŸŸ¢ é—®é¢˜7ï¼šç¼ºå°‘è¶…æ—¶æ§åˆ¶

**ä½ç½®**ï¼š
- `src/db/api.ts` (æ‰€æœ‰å¼‚æ­¥å‡½æ•°)
- `src/hooks/useDriverDashboard.ts` (ç¬¬120-222è¡Œ)

**é—®é¢˜æè¿°**ï¼š
æ‰€æœ‰æ•°æ®åº“æ“ä½œå’Œæ•°æ®åŠ è½½éƒ½æ²¡æœ‰è¶…æ—¶æ§åˆ¶ï¼š

```typescript
// useDriverDashboard.ts - ç¬¬154è¡Œ
const pieceWorkRecords = await getPieceWorkRecordsByUser(userId)
// âš ï¸ æ²¡æœ‰è¶…æ—¶æ§åˆ¶ï¼Œå¯èƒ½æ°¸ä¹…ç­‰å¾…
```

**å½±å“**ï¼š
- ğŸŸ¢ ç”¨æˆ·å¯èƒ½é•¿æ—¶é—´ç­‰å¾…
- ğŸŸ¢ åº”ç”¨å¯èƒ½å‡æ­»
- ğŸŸ¢ èµ„æºæ— æ³•é‡Šæ”¾

---

### ğŸŸ¢ é—®é¢˜8ï¼šæ—¥å¿—è¿‡å¤šå½±å“æ€§èƒ½

**ä½ç½®**ï¼š
- æ‰€æœ‰ Hook æ–‡ä»¶
- `src/db/api.ts`

**é—®é¢˜æè¿°**ï¼š
å¤§é‡çš„ `console.log` è¯­å¥ï¼š

```typescript
// useDriverDashboard.ts
console.log('[useDriverDashboard] ä½¿ç”¨ç¼“å­˜æ•°æ®ï¼Œç¼“å­˜å¹´é¾„: ${Math.round(age / 1000)}ç§’')
console.log('[useDriverDashboard] ç¼“å­˜å·²è¿‡æœŸï¼Œå¹´é¾„: ${Math.round(age / 1000)}ç§’')
console.log('[useDriverDashboard] æ•°æ®å·²ç¼“å­˜')
console.log('[useDriverDashboard] æ­£åœ¨åŠ è½½ä¸­ï¼Œè·³è¿‡é‡å¤è¯·æ±‚')
// ... è¿˜æœ‰å¾ˆå¤š
```

**å½±å“**ï¼š
- ğŸŸ¢ ç”Ÿäº§ç¯å¢ƒæ€§èƒ½ä¸‹é™
- ğŸŸ¢ æ—¥å¿—æ–‡ä»¶è¿‡å¤§
- ğŸŸ¢ å¯èƒ½æ³„éœ²æ•æ„Ÿä¿¡æ¯

---

## ä¸‰ã€ä»£ç é‡å¤å’Œå†—ä½™

### é‡å¤ä»£ç 1ï¼šç¼“å­˜ç®¡ç†é€»è¾‘

**ä½ç½®**ï¼š
- `useDriverDashboard.ts` (ç¬¬62-117è¡Œ)
- `useDashboardData.ts` (ç¬¬39-101è¡Œ)
- `useSuperAdminDashboard.ts` (ç¬¬40-102è¡Œ)
- `useDriverWarehouses.ts` (ç¬¬330-374è¡Œ)

**é—®é¢˜**ï¼š
æ¯ä¸ª Hook éƒ½å®ç°äº†å‡ ä¹ç›¸åŒçš„ç¼“å­˜ç®¡ç†é€»è¾‘ï¼š
- `getCacheKey()`
- `readCache()`
- `writeCache()`
- `clearCache()`

**ä»£ç é‡**ï¼š
- é‡å¤ä»£ç çº¦ **200+ è¡Œ**
- ç»´æŠ¤æˆæœ¬é«˜
- å®¹æ˜“å‡ºç°ä¸ä¸€è‡´

**å»ºè®®**ï¼š
æå–ä¸ºç‹¬ç«‹çš„ `useCacheManager` Hook æˆ–å·¥å…·å‡½æ•°ã€‚

---

### é‡å¤ä»£ç 2ï¼šåŠ è½½çŠ¶æ€ç®¡ç†

**ä½ç½®**ï¼š
- æ‰€æœ‰ Hook æ–‡ä»¶

**é—®é¢˜**ï¼š
æ¯ä¸ª Hook éƒ½å®ç°äº†ç›¸åŒçš„åŠ è½½çŠ¶æ€ç®¡ç†ï¼š

```typescript
const [loading, setLoading] = useState(false)
const [error, setError] = useState<string | null>(null)
const loadingRef = useRef(false)

// é˜²æ­¢é‡å¤åŠ è½½
if (loadingRef.current) {
  console.log('æ­£åœ¨åŠ è½½ä¸­ï¼Œè·³è¿‡é‡å¤è¯·æ±‚')
  return
}

loadingRef.current = true
setLoading(true)
setError(null)

try {
  // ... åŠ è½½é€»è¾‘
} catch (err) {
  setError('åŠ è½½å¤±è´¥')
} finally {
  setLoading(false)
  loadingRef.current = false
}
```

**ä»£ç é‡**ï¼š
- é‡å¤ä»£ç çº¦ **150+ è¡Œ**

**å»ºè®®**ï¼š
æå–ä¸º `useAsyncOperation` Hookã€‚

---

### é‡å¤ä»£ç 3ï¼šå®æ—¶è®¢é˜…ç®¡ç†

**ä½ç½®**ï¼š
- `useDriverDashboard.ts` (ç¬¬236-301è¡Œ)
- `useDashboardData.ts` (ç¬¬150-215è¡Œ)
- `useSuperAdminDashboard.ts` (ç¬¬157-250è¡Œ)
- `useDriverWarehouses.ts` (ç¬¬431-469è¡Œ)

**é—®é¢˜**ï¼š
æ¯ä¸ª Hook éƒ½å®ç°äº†ç›¸ä¼¼çš„è®¢é˜…ç®¡ç†é€»è¾‘ï¼š

```typescript
const channelRef = useRef<RealtimeChannel | null>(null)

useEffect(() => {
  // æ¸…ç†æ—§è®¢é˜…
  if (channelRef.current) {
    supabase.removeChannel(channelRef.current)
    channelRef.current = null
  }
  
  // åˆ›å»ºæ–°è®¢é˜…
  const channel = supabase.channel('...')
  // ... è®¢é˜…é…ç½®
  channel.subscribe()
  channelRef.current = channel
  
  // æ¸…ç†å‡½æ•°
  return () => {
    if (channelRef.current) {
      supabase.removeChannel(channelRef.current)
      channelRef.current = null
    }
  }
}, [...])
```

**ä»£ç é‡**ï¼š
- é‡å¤ä»£ç çº¦ **250+ è¡Œ**

**å»ºè®®**ï¼š
æå–ä¸º `useRealtimeSubscription` Hookã€‚

---

## å››ã€æ•°æ®ä¸€è‡´æ€§é—®é¢˜

### é—®é¢˜1ï¼šç¼“å­˜ä¸å®æ—¶æ•°æ®ä¸åŒæ­¥

**åœºæ™¯**ï¼š
1. ç”¨æˆ·AåŠ è½½æ•°æ®ï¼Œç¼“å­˜5åˆ†é’Ÿ
2. 1åˆ†é’Ÿåï¼Œç®¡ç†å‘˜ä¿®æ”¹æ•°æ®
3. å®æ—¶è®¢é˜…è§¦å‘ï¼Œåˆ·æ–°æ•°æ®
4. ä½†ç¼“å­˜ä»ç„¶æœ‰æ•ˆï¼Œå¯èƒ½è¯»å–æ—§æ•°æ®

**ä»£ç ä½ç½®**ï¼š
- `useDriverDashboard.ts` (ç¬¬134-140è¡Œ)

```typescript
// å…ˆå°è¯•ä½¿ç”¨ç¼“å­˜
const cachedData = readCache()
if (cachedData) {
  setData(cachedData)
  setLoading(false)
  setError(null)
  return  // âš ï¸ ç›´æ¥è¿”å›ï¼Œä¸æ£€æŸ¥å®æ—¶æ›´æ–°
}
```

**å½±å“**ï¼š
- ç”¨æˆ·å¯èƒ½çœ‹åˆ°è¿‡æœŸæ•°æ®
- å®æ—¶æ›´æ–°å¤±æ•ˆ

---

### é—®é¢˜2ï¼šå¹¶å‘æ›´æ–°å¯¼è‡´æ•°æ®è¦†ç›–

**åœºæ™¯**ï¼š
1. ç”¨æˆ·Aå’Œç”¨æˆ·BåŒæ—¶ç¼–è¾‘åŒä¸€æ¡è®°å½•
2. ç”¨æˆ·Aä¿å­˜ï¼ŒæˆåŠŸ
3. ç”¨æˆ·Bä¿å­˜ï¼Œè¦†ç›–ç”¨æˆ·Açš„ä¿®æ”¹
4. ç”¨æˆ·Açš„ä¿®æ”¹ä¸¢å¤±

**ä»£ç ä½ç½®**ï¼š
- `src/db/api.ts` (ç¬¬804è¡Œ)

```typescript
export async function updatePieceWorkRecord(id: string, record: Partial<PieceWorkRecordInput>): Promise<boolean> {
  const {error} = await supabase.from('piece_work_records').update(record).eq('id', id)
  // âš ï¸ æ²¡æœ‰ç‰ˆæœ¬æ§åˆ¶æˆ–ä¹è§‚é”
  
  if (error) {
    console.error('æ›´æ–°è®¡ä»¶è®°å½•å¤±è´¥:', error)
    return false
  }
  
  return true
}
```

**å½±å“**ï¼š
- æ•°æ®ä¸¢å¤±
- ç”¨æˆ·ä¿®æ”¹è¢«è¦†ç›–

---

## äº”ã€æ€§èƒ½é—®é¢˜

### é—®é¢˜1ï¼šè¿‡åº¦çš„æ•°æ®åº“æŸ¥è¯¢

**ä½ç½®**ï¼š
- `src/db/api.ts` (ç¬¬830-900è¡Œ)

**é—®é¢˜æè¿°**ï¼š
`calculatePieceWorkStats` å‡½æ•°æ¯æ¬¡éƒ½æŸ¥è¯¢æ‰€æœ‰å“ç±»ï¼š

```typescript
export async function calculatePieceWorkStats(...): Promise<PieceWorkStats> {
  const records = await getPieceWorkRecordsByUserAndWarehouse(...)
  
  // âš ï¸ æ¯æ¬¡éƒ½æŸ¥è¯¢æ‰€æœ‰å“ç±»
  const {data: categories} = await supabase.from('piece_work_categories').select('*')
  const categoryMap = new Map(categories?.map((c) => [c.id, c.name]) || [])
  
  // ... è®¡ç®—é€»è¾‘
}
```

**å½±å“**ï¼š
- å“ç±»æ•°æ®å¾ˆå°‘å˜åŒ–ï¼Œä¸éœ€è¦æ¯æ¬¡æŸ¥è¯¢
- æµªè´¹æ•°æ®åº“èµ„æº
- å¢åŠ å“åº”æ—¶é—´

**å»ºè®®**ï¼š
- ç¼“å­˜å“ç±»æ•°æ®
- æˆ–åœ¨åº”ç”¨å¯åŠ¨æ—¶åŠ è½½ä¸€æ¬¡

---

### é—®é¢˜2ï¼šN+1æŸ¥è¯¢é—®é¢˜

**ä½ç½®**ï¼š
- `src/db/api.ts` (ç¬¬549-567è¡Œ)

**é—®é¢˜æè¿°**ï¼š
`getDriverWarehouses` å‡½æ•°å¯èƒ½å­˜åœ¨ N+1 æŸ¥è¯¢ï¼š

```typescript
export async function getDriverWarehouses(driverId: string): Promise<Warehouse[]> {
  const {data: assignments} = await supabase
    .from('driver_warehouses')
    .select('warehouse_id')
    .eq('driver_id', driverId)
  
  // âš ï¸ å¯¹æ¯ä¸ªä»“åº“IDå•ç‹¬æŸ¥è¯¢
  const warehouseIds = assignments?.map((a) => a.warehouse_id) || []
  const {data: warehouses} = await supabase
    .from('warehouses')
    .select('*')
    .in('id', warehouseIds)
  
  return Array.isArray(warehouses) ? warehouses : []
}
```

**å½“å‰å®ç°**ï¼š
- å®é™…ä¸Šä½¿ç”¨äº† `.in()` æŸ¥è¯¢ï¼Œé¿å…äº† N+1 é—®é¢˜
- âœ… è¿™éƒ¨åˆ†å®ç°æ˜¯æ­£ç¡®çš„

---

### é—®é¢˜3ï¼šå¤§é‡æ•°æ®ä¸€æ¬¡æ€§åŠ è½½

**ä½ç½®**ï¼š
- `src/hooks/useDriverDashboard.ts` (ç¬¬154è¡Œ)

**é—®é¢˜æè¿°**ï¼š
ä¸€æ¬¡æ€§åŠ è½½ç”¨æˆ·çš„æ‰€æœ‰è®¡ä»¶è®°å½•ï¼š

```typescript
// åŠ è½½è®¡ä»¶è®°å½•
const pieceWorkRecords = await getPieceWorkRecordsByUser(userId)
// âš ï¸ å¦‚æœç”¨æˆ·æœ‰å‡ åƒæ¡è®°å½•ï¼Œä¼šå¾ˆæ…¢
```

**å½±å“**ï¼š
- é¦–æ¬¡åŠ è½½æ…¢
- å†…å­˜å ç”¨é«˜
- å¯èƒ½å¯¼è‡´åº”ç”¨å¡é¡¿

**å»ºè®®**ï¼š
- åªåŠ è½½å½“æœˆæ•°æ®
- ä½¿ç”¨åˆ†é¡µåŠ è½½
- åœ¨æœåŠ¡å™¨ç«¯è®¡ç®—ç»Ÿè®¡æ•°æ®

---

## å…­ã€é”™è¯¯å¤„ç†é—®é¢˜

### é—®é¢˜1ï¼šé”™è¯¯ä¿¡æ¯ä¸æ˜ç¡®

**ä½ç½®**ï¼š
- `src/db/api.ts` (æ‰€æœ‰å‡½æ•°)

**é—®é¢˜æè¿°**ï¼š
é”™è¯¯å¤„ç†è¿‡äºç®€å•ï¼š

```typescript
export async function createPieceWorkRecord(record: PieceWorkRecordInput): Promise<boolean> {
  const {error} = await supabase.from('piece_work_records').insert(record)
  
  if (error) {
    console.error('åˆ›å»ºè®¡ä»¶è®°å½•å¤±è´¥:', error)
    return false  // âš ï¸ åªè¿”å› falseï¼Œæ²¡æœ‰é”™è¯¯è¯¦æƒ…
  }
  
  return true
}
```

**å½±å“**ï¼š
- ç”¨æˆ·ä¸çŸ¥é“å¤±è´¥åŸå› 
- éš¾ä»¥è°ƒè¯•é—®é¢˜
- æ— æ³•é’ˆå¯¹æ€§å¤„ç†é”™è¯¯

**å»ºè®®**ï¼š
- è¿”å›è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
- åŒºåˆ†ä¸åŒç±»å‹çš„é”™è¯¯
- æä¾›ç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º

---

### é—®é¢˜2ï¼šç¼ºå°‘å¼‚å¸¸è¾¹ç•Œ

**ä½ç½®**ï¼š
- æ‰€æœ‰ Hook æ–‡ä»¶

**é—®é¢˜æè¿°**ï¼š
æ²¡æœ‰å…¨å±€çš„å¼‚å¸¸æ•è·æœºåˆ¶ï¼š

```typescript
try {
  // ... åŠ è½½é€»è¾‘
} catch (err) {
  console.error('åŠ è½½å¤±è´¥:', err)
  setError('åŠ è½½å¤±è´¥')  // âš ï¸ é”™è¯¯ä¿¡æ¯å¤ªç®€å•
}
```

**å½±å“**ï¼š
- æœªæ•è·çš„å¼‚å¸¸å¯èƒ½å¯¼è‡´åº”ç”¨å´©æºƒ
- ç”¨æˆ·ä½“éªŒå·®

---

## ä¸ƒã€èµ„æºç®¡ç†é—®é¢˜

### é—®é¢˜1ï¼šè®¢é˜…æœªæ­£ç¡®æ¸…ç†

**ä½ç½®**ï¼š
- `src/hooks/useDriverWarehouses.ts` (ç¬¬459-469è¡Œ)

**é—®é¢˜æè¿°**ï¼š
è®¢é˜…æ¸…ç†æ–¹æ³•ä¸ä¸€è‡´ï¼š

```typescript
// æ–¹æ³•1ï¼šunsubscribe()
return () => {
  if (channelRef.current) {
    channelRef.current.unsubscribe()
    channelRef.current = null
  }
}

// æ–¹æ³•2ï¼šremoveChannel()
return () => {
  if (channelRef.current) {
    supabase.removeChannel(channelRef.current)
    channelRef.current = null
  }
}
```

**é—®é¢˜**ï¼š
- ä¸æ¸…æ¥šå“ªç§æ–¹æ³•æ˜¯æ­£ç¡®çš„
- å¯èƒ½å¯¼è‡´è®¢é˜…æœªå®Œå…¨æ¸…ç†
- æ½œåœ¨çš„å†…å­˜æ³„éœ²

**å»ºè®®**ï¼š
- ç»Ÿä¸€ä½¿ç”¨ `supabase.removeChannel()`
- æ·»åŠ æ¸…ç†éªŒè¯

---

### é—®é¢˜2ï¼šç¼“å­˜æœªè®¾ç½®å¤§å°é™åˆ¶

**ä½ç½®**ï¼š
- æ‰€æœ‰ä½¿ç”¨ `Taro.setStorageSync` çš„åœ°æ–¹

**é—®é¢˜æè¿°**ï¼š
ç¼“å­˜æ²¡æœ‰å¤§å°é™åˆ¶å’Œæ¸…ç†æœºåˆ¶ï¼š

```typescript
Taro.setStorageSync(cacheKey, cacheData)
// âš ï¸ æ²¡æœ‰æ£€æŸ¥å­˜å‚¨ç©ºé—´
// âš ï¸ æ²¡æœ‰æ¸…ç†æ—§ç¼“å­˜
```

**å½±å“**ï¼š
- å­˜å‚¨ç©ºé—´å¯èƒ½è€—å°½
- æ—§ç¼“å­˜æ°¸ä¸æ¸…ç†
- å¯èƒ½å¯¼è‡´å­˜å‚¨å¤±è´¥

**å»ºè®®**ï¼š
- è®¾ç½®ç¼“å­˜å¤§å°é™åˆ¶
- å®ç° LRU ç¼“å­˜æ·˜æ±°ç­–ç•¥
- å®šæœŸæ¸…ç†è¿‡æœŸç¼“å­˜

---

## å…«ã€ä¼˜åŒ–å»ºè®®

### ä¼˜å…ˆçº§1ï¼šç«‹å³ä¿®å¤ï¼ˆä¸¥é‡é—®é¢˜ï¼‰

#### 1.1 ä¿®å¤æ— é™åˆ·æ–°å¾ªç¯

**æ–‡ä»¶**ï¼š`src/hooks/useDriverDashboard.ts`

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
```typescript
// å°† refresh ä»ä¾èµ–é¡¹ä¸­ç§»é™¤ï¼Œä½¿ç”¨ useRef ä¿å­˜æœ€æ–°çš„ loadStats
const loadStatsRef = useRef(loadStats)
useEffect(() => {
  loadStatsRef.current = loadStats
}, [loadStats])

const refreshStable = useCallback(() => {
  clearCache()
  loadStatsRef.current()
}, [clearCache])

useEffect(() => {
  if (!enableRealtime || !userId) return
  
  const channel = supabase.channel(`driver_dashboard_${userId}_${warehouseId || 'all'}`)
  
  channel.on('postgres_changes', {...}, () => {
    refreshStable() // ä½¿ç”¨ç¨³å®šçš„ refresh å‡½æ•°
  })
  
  channel.subscribe()
  channelRef.current = channel
  
  return () => {
    if (channelRef.current) {
      supabase.removeChannel(channelRef.current)
      channelRef.current = null
    }
  }
}, [enableRealtime, userId, warehouseId, refreshStable]) // refreshStable æ˜¯ç¨³å®šçš„
```

---

#### 1.2 ä¿®å¤ç¼“å­˜é”®å†²çª

**æ–‡ä»¶**ï¼š`src/hooks/useDriverDashboard.ts`

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
```typescript
// ä¿®æ”¹ç¼“å­˜é”®ç”Ÿæˆé€»è¾‘ï¼ŒåŒ…å« userId
const getCacheKey = useCallback(() => {
  return `${CACHE_KEY_PREFIX}${userId}_${warehouseId || 'all'}`
}, [userId, warehouseId])
```

---

#### 1.3 ç»Ÿä¸€è®¢é˜…æ¸…ç†æ–¹æ³•

**æ–‡ä»¶**ï¼šæ‰€æœ‰ Hook æ–‡ä»¶

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
```typescript
// ç»Ÿä¸€ä½¿ç”¨ removeChannel
return () => {
  if (channelRef.current) {
    supabase.removeChannel(channelRef.current)
    channelRef.current = null
  }
}
```

---

### ä¼˜å…ˆçº§2ï¼šæœ¬å‘¨å®Œæˆï¼ˆé‡è¦ä¼˜åŒ–ï¼‰

#### 2.1 æå–å…¬å…±ç¼“å­˜ç®¡ç†é€»è¾‘

**æ–°æ–‡ä»¶**ï¼š`src/hooks/useCacheManager.ts`

**å®ç°æ–¹æ¡ˆ**ï¼š
```typescript
import Taro from '@tarojs/taro'
import {useCallback} from 'react'

interface CacheOptions<T> {
  key: string
  expiryMs: number
}

export function useCacheManager<T>(options: CacheOptions<T>) {
  const {key, expiryMs} = options
  
  const read = useCallback((): T | null => {
    try {
      const cached = Taro.getStorageSync<{data: T; timestamp: number}>(key)
      if (cached?.data) {
        const age = Date.now() - cached.timestamp
        if (age < expiryMs) {
          return cached.data
        }
        Taro.removeStorageSync(key)
      }
    } catch (err) {
      console.error(`[useCacheManager] è¯»å–ç¼“å­˜å¤±è´¥ (${key}):`, err)
    }
    return null
  }, [key, expiryMs])
  
  const write = useCallback((data: T) => {
    try {
      Taro.setStorageSync(key, {
        data,
        timestamp: Date.now()
      })
    } catch (err) {
      console.error(`[useCacheManager] å†™å…¥ç¼“å­˜å¤±è´¥ (${key}):`, err)
    }
  }, [key])
  
  const clear = useCallback(() => {
    try {
      Taro.removeStorageSync(key)
    } catch (err) {
      console.error(`[useCacheManager] æ¸…é™¤ç¼“å­˜å¤±è´¥ (${key}):`, err)
    }
  }, [key])
  
  return {read, write, clear}
}
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```typescript
// åœ¨ useDriverDashboard ä¸­ä½¿ç”¨
const cache = useCacheManager<DriverDashboardStats>({
  key: `driver_dashboard_${userId}_${warehouseId || 'all'}`,
  expiryMs: 5 * 60 * 1000
})

// è¯»å–ç¼“å­˜
const cachedData = cache.read()

// å†™å…¥ç¼“å­˜
cache.write(stats)

// æ¸…é™¤ç¼“å­˜
cache.clear()
```

**ä¼˜ç‚¹**ï¼š
- å‡å°‘ 200+ è¡Œé‡å¤ä»£ç 
- ç»Ÿä¸€ç¼“å­˜ç®¡ç†é€»è¾‘
- æ˜“äºç»´æŠ¤å’Œæµ‹è¯•

---

#### 2.2 æ·»åŠ é”™è¯¯é‡è¯•æœºåˆ¶

**æ–°æ–‡ä»¶**ï¼š`src/utils/retry.ts`

**å®ç°æ–¹æ¡ˆ**ï¼š
```typescript
interface RetryOptions {
  maxAttempts?: number
  delayMs?: number
  backoff?: boolean
  onRetry?: (attempt: number, error: Error) => void
}

export async function withRetry<T>(
  fn: () => Promise<T>,
  options: RetryOptions = {}
): Promise<T> {
  const {
    maxAttempts = 3,
    delayMs = 1000,
    backoff = true,
    onRetry
  } = options
  
  let lastError: Error
  
  for (let attempt = 1; attempt <= maxAttempts; attempt++) {
    try {
      return await fn()
    } catch (error) {
      lastError = error as Error
      
      if (attempt < maxAttempts) {
        const delay = backoff ? delayMs * attempt : delayMs
        onRetry?.(attempt, lastError)
        await new Promise(resolve => setTimeout(resolve, delay))
      }
    }
  }
  
  throw lastError!
}
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```typescript
// åœ¨ api.ts ä¸­ä½¿ç”¨
export async function createPieceWorkRecord(record: PieceWorkRecordInput): Promise<boolean> {
  try {
    await withRetry(
      async () => {
        const {error} = await supabase.from('piece_work_records').insert(record)
        if (error) throw new Error(error.message)
      },
      {
        maxAttempts: 3,
        delayMs: 1000,
        backoff: true,
        onRetry: (attempt, error) => {
          console.warn(`[createPieceWorkRecord] é‡è¯•ç¬¬ ${attempt} æ¬¡:`, error.message)
        }
      }
    )
    return true
  } catch (error) {
    console.error('[createPieceWorkRecord] åˆ›å»ºå¤±è´¥:', error)
    return false
  }
}
```

---

#### 2.3 æ·»åŠ è¶…æ—¶æ§åˆ¶

**æ–°æ–‡ä»¶**ï¼š`src/utils/timeout.ts`

**å®ç°æ–¹æ¡ˆ**ï¼š
```typescript
export async function withTimeout<T>(
  promise: Promise<T>,
  timeoutMs: number,
  errorMessage = 'æ“ä½œè¶…æ—¶'
): Promise<T> {
  return Promise.race([
    promise,
    new Promise<T>((_, reject) =>
      setTimeout(() => reject(new Error(errorMessage)), timeoutMs)
    )
  ])
}
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```typescript
// åœ¨ Hook ä¸­ä½¿ç”¨
const pieceWorkRecords = await withTimeout(
  getPieceWorkRecordsByUser(userId),
  10000, // 10ç§’è¶…æ—¶
  'åŠ è½½è®¡ä»¶è®°å½•è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥'
)
```

---

### ä¼˜å…ˆçº§3ï¼šæœ¬æœˆå®Œæˆï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰

#### 3.1 ä¼˜åŒ–æ•°æ®åŠ è½½ç­–ç•¥

**é—®é¢˜**ï¼šä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰è®¡ä»¶è®°å½•

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š
```typescript
// ä¿®æ”¹ getPieceWorkRecordsByUser å‡½æ•°
export async function getPieceWorkRecordsByUser(
  userId: string,
  startDate?: string,  // æ–°å¢ï¼šå¼€å§‹æ—¥æœŸ
  endDate?: string     // æ–°å¢ï¼šç»“æŸæ—¥æœŸ
): Promise<PieceWorkRecord[]> {
  let query = supabase
    .from('piece_work_records')
    .select('*')
    .eq('user_id', userId)
    .order('work_date', {ascending: false})
  
  // å¦‚æœæä¾›äº†æ—¥æœŸèŒƒå›´ï¼ŒåªæŸ¥è¯¢è¯¥èŒƒå›´å†…çš„æ•°æ®
  if (startDate) {
    query = query.gte('work_date', startDate)
  }
  if (endDate) {
    query = query.lte('work_date', endDate)
  }
  
  const {data, error} = await query
  
  if (error) {
    console.error('è·å–è®¡ä»¶è®°å½•å¤±è´¥:', error)
    return []
  }
  
  return Array.isArray(data) ? data : []
}

// åœ¨ useDriverDashboard ä¸­ä½¿ç”¨
const today = new Date()
const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1)
const firstDayStr = getLocalDateString(firstDayOfMonth)
const todayStr = getLocalDateString(today)

// åªåŠ è½½æœ¬æœˆæ•°æ®
const pieceWorkRecords = await getPieceWorkRecordsByUser(
  userId,
  firstDayStr,
  todayStr
)
```

**ä¼˜ç‚¹**ï¼š
- å‡å°‘æ•°æ®ä¼ è¾“é‡
- æé«˜åŠ è½½é€Ÿåº¦
- é™ä½å†…å­˜å ç”¨

---

#### 3.2 å®ç°æœåŠ¡å™¨ç«¯ç»Ÿè®¡è®¡ç®—

**æ–°å»º**ï¼šSupabase Edge Function

**å®ç°æ–¹æ¡ˆ**ï¼š
```typescript
// supabase/functions/calculate-driver-stats/index.ts
import {createClient} from '@supabase/supabase-js'

Deno.serve(async (req) => {
  const {userId, warehouseId, startDate, endDate} = await req.json()
  
  const supabase = createClient(
    Deno.env.get('SUPABASE_URL')!,
    Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!
  )
  
  // ä½¿ç”¨ SQL èšåˆå‡½æ•°åœ¨æ•°æ®åº“ç«¯è®¡ç®—
  const {data, error} = await supabase.rpc('calculate_driver_stats', {
    p_user_id: userId,
    p_warehouse_id: warehouseId,
    p_start_date: startDate,
    p_end_date: endDate
  })
  
  if (error) {
    return new Response(JSON.stringify({error: error.message}), {
      status: 500,
      headers: {'Content-Type': 'application/json'}
    })
  }
  
  return new Response(JSON.stringify(data), {
    headers: {'Content-Type': 'application/json'}
  })
})
```

**æ•°æ®åº“å‡½æ•°**ï¼š
```sql
CREATE OR REPLACE FUNCTION calculate_driver_stats(
  p_user_id uuid,
  p_warehouse_id uuid DEFAULT NULL,
  p_start_date date DEFAULT NULL,
  p_end_date date DEFAULT NULL
)
RETURNS json AS $$
DECLARE
  result json;
BEGIN
  SELECT json_build_object(
    'todayPieceCount', COALESCE(SUM(CASE WHEN work_date = CURRENT_DATE THEN quantity ELSE 0 END), 0),
    'todayIncome', COALESCE(SUM(CASE WHEN work_date = CURRENT_DATE THEN 
      quantity * unit_price + 
      CASE WHEN need_upstairs THEN quantity * upstairs_price ELSE 0 END +
      CASE WHEN need_sorting THEN sorting_quantity * sorting_unit_price ELSE 0 END
    ELSE 0 END), 0),
    'monthPieceCount', COALESCE(SUM(quantity), 0),
    'monthIncome', COALESCE(SUM(
      quantity * unit_price + 
      CASE WHEN need_upstairs THEN quantity * upstairs_price ELSE 0 END +
      CASE WHEN need_sorting THEN sorting_quantity * sorting_unit_price ELSE 0 END
    ), 0)
  ) INTO result
  FROM piece_work_records
  WHERE user_id = p_user_id
    AND (p_warehouse_id IS NULL OR warehouse_id = p_warehouse_id)
    AND (p_start_date IS NULL OR work_date >= p_start_date)
    AND (p_end_date IS NULL OR work_date <= p_end_date);
  
  RETURN result;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

**ä¼˜ç‚¹**ï¼š
- å¤§å¹…å‡å°‘æ•°æ®ä¼ è¾“
- è®¡ç®—åœ¨æ•°æ®åº“ç«¯å®Œæˆï¼Œé€Ÿåº¦æ›´å¿«
- å‡å°‘å®¢æˆ·ç«¯å†…å­˜å ç”¨

---

#### 3.3 ä¼˜åŒ–ç¼“å­˜ç­–ç•¥

**å®ç°æ–¹æ¡ˆ**ï¼š
```typescript
// æ ¹æ®æ•°æ®ç‰¹æ€§è®¾ç½®ä¸åŒçš„ç¼“å­˜æ—¶é—´
const CACHE_CONFIG = {
  // ç»Ÿè®¡æ•°æ®ï¼š2åˆ†é’Ÿï¼ˆå˜åŒ–é¢‘ç¹ï¼‰
  DASHBOARD_STATS: 2 * 60 * 1000,
  
  // ä»“åº“åˆ—è¡¨ï¼š10åˆ†é’Ÿï¼ˆå˜åŒ–ä¸é¢‘ç¹ï¼‰
  WAREHOUSES: 10 * 60 * 1000,
  
  // ç”¨æˆ·æ¡£æ¡ˆï¼š30åˆ†é’Ÿï¼ˆå¾ˆå°‘å˜åŒ–ï¼‰
  PROFILES: 30 * 60 * 1000,
  
  // è€ƒå‹¤è§„åˆ™ï¼š1å°æ—¶ï¼ˆåŸºæœ¬ä¸å˜ï¼‰
  ATTENDANCE_RULES: 60 * 60 * 1000
}

// å®ç°ç¼“å­˜å¤§å°é™åˆ¶
const MAX_CACHE_SIZE = 5 * 1024 * 1024 // 5MB
const MAX_CACHE_ITEMS = 100

function getCacheSize(): number {
  try {
    const info = Taro.getStorageInfoSync()
    return info.currentSize * 1024 // è½¬æ¢ä¸ºå­—èŠ‚
  } catch {
    return 0
  }
}

function clearOldestCache() {
  try {
    const info = Taro.getStorageInfoSync()
    const keys = info.keys.filter(k => k.startsWith('driver_dashboard_'))
    
    // æŒ‰æ—¶é—´æˆ³æ’åºï¼Œåˆ é™¤æœ€æ—§çš„
    const caches = keys.map(key => {
      const data = Taro.getStorageSync(key)
      return {key, timestamp: data?.timestamp || 0}
    }).sort((a, b) => a.timestamp - b.timestamp)
    
    // åˆ é™¤æœ€æ—§çš„10%
    const toDelete = Math.ceil(caches.length * 0.1)
    for (let i = 0; i < toDelete; i++) {
      Taro.removeStorageSync(caches[i].key)
    }
  } catch (err) {
    console.error('æ¸…ç†ç¼“å­˜å¤±è´¥:', err)
  }
}

// åœ¨å†™å…¥ç¼“å­˜å‰æ£€æŸ¥å¤§å°
function writeCache(key: string, data: any) {
  try {
    // æ£€æŸ¥ç¼“å­˜å¤§å°
    if (getCacheSize() > MAX_CACHE_SIZE) {
      clearOldestCache()
    }
    
    Taro.setStorageSync(key, data)
  } catch (err) {
    console.error('å†™å…¥ç¼“å­˜å¤±è´¥:', err)
  }
}
```

---

#### 3.4 å‡å°‘æ—¥å¿—è¾“å‡º

**å®ç°æ–¹æ¡ˆ**ï¼š
```typescript
// åˆ›å»ºæ—¥å¿—å·¥å…·
// src/utils/logger.ts
const IS_PRODUCTION = process.env.NODE_ENV === 'production'
const LOG_LEVEL = process.env.TARO_APP_LOG_LEVEL || 'info'

type LogLevel = 'debug' | 'info' | 'warn' | 'error'

const LEVEL_PRIORITY: Record<LogLevel, number> = {
  debug: 0,
  info: 1,
  warn: 2,
  error: 3
}

class Logger {
  private shouldLog(level: LogLevel): boolean {
    if (IS_PRODUCTION && level === 'debug') return false
    return LEVEL_PRIORITY[level] >= LEVEL_PRIORITY[LOG_LEVEL as LogLevel]
  }
  
  debug(message: string, ...args: any[]) {
    if (this.shouldLog('debug')) {
      console.log(`[DEBUG] ${message}`, ...args)
    }
  }
  
  info(message: string, ...args: any[]) {
    if (this.shouldLog('info')) {
      console.log(`[INFO] ${message}`, ...args)
    }
  }
  
  warn(message: string, ...args: any[]) {
    if (this.shouldLog('warn')) {
      console.warn(`[WARN] ${message}`, ...args)
    }
  }
  
  error(message: string, ...args: any[]) {
    if (this.shouldLog('error')) {
      console.error(`[ERROR] ${message}`, ...args)
    }
  }
}

export const logger = new Logger()

// ä½¿ç”¨ç¤ºä¾‹
import {logger} from '@/utils/logger'

// æ›¿æ¢æ‰€æœ‰ console.log
logger.debug('[useDriverDashboard] ä½¿ç”¨ç¼“å­˜æ•°æ®')
logger.info('[useDriverDashboard] å¼€å§‹åŠ è½½ç»Ÿè®¡æ•°æ®')
logger.warn('[useDriverDashboard] ç¼“å­˜å·²è¿‡æœŸ')
logger.error('[useDriverDashboard] åŠ è½½å¤±è´¥')
```

---

### ä¼˜å…ˆçº§4ï¼šé•¿æœŸä¼˜åŒ–ï¼ˆæ¶æ„æ”¹è¿›ï¼‰

#### 4.1 å®ç°ä¹è§‚é”é˜²æ­¢å¹¶å‘å†²çª

**å®ç°æ–¹æ¡ˆ**ï¼š
```typescript
// åœ¨æ•°æ®åº“è¡¨ä¸­æ·»åŠ  version å­—æ®µ
ALTER TABLE piece_work_records ADD COLUMN version INTEGER DEFAULT 1;

// æ›´æ–°æ—¶æ£€æŸ¥ç‰ˆæœ¬å·
export async function updatePieceWorkRecord(
  id: string,
  record: Partial<PieceWorkRecordInput>,
  expectedVersion: number
): Promise<{success: boolean; conflict: boolean}> {
  const {data, error} = await supabase
    .from('piece_work_records')
    .update({
      ...record,
      version: expectedVersion + 1
    })
    .eq('id', id)
    .eq('version', expectedVersion)
    .select()
  
  if (error) {
    console.error('æ›´æ–°è®¡ä»¶è®°å½•å¤±è´¥:', error)
    return {success: false, conflict: false}
  }
  
  if (!data || data.length === 0) {
    // æ²¡æœ‰æ›´æ–°ä»»ä½•è®°å½•ï¼Œè¯´æ˜ç‰ˆæœ¬å·ä¸åŒ¹é…
    return {success: false, conflict: true}
  }
  
  return {success: true, conflict: false}
}
```

---

#### 4.2 å®ç°æ•°æ®é¢„åŠ è½½

**å®ç°æ–¹æ¡ˆ**ï¼š
```typescript
// åœ¨åº”ç”¨å¯åŠ¨æ—¶é¢„åŠ è½½å¸¸ç”¨æ•°æ®
// src/app.tsx
import {useEffect} from 'react'
import {preloadCommonData} from '@/utils/preload'

function App({children}) {
  useEffect(() => {
    preloadCommonData()
  }, [])
  
  return <AuthProvider>{children}</AuthProvider>
}

// src/utils/preload.ts
export async function preloadCommonData() {
  try {
    // é¢„åŠ è½½å“ç±»æ•°æ®
    const categories = await supabase.from('piece_work_categories').select('*')
    Taro.setStorageSync('preload_categories', {
      data: categories.data,
      timestamp: Date.now()
    })
    
    // é¢„åŠ è½½ä»“åº“åˆ—è¡¨
    const warehouses = await supabase.from('warehouses').select('*')
    Taro.setStorageSync('preload_warehouses', {
      data: warehouses.data,
      timestamp: Date.now()
    })
  } catch (err) {
    console.error('é¢„åŠ è½½æ•°æ®å¤±è´¥:', err)
  }
}
```

---

## ä¹ã€æµ‹è¯•å»ºè®®

### 9.1 å•å…ƒæµ‹è¯•

**éœ€è¦æµ‹è¯•çš„æ¨¡å—**ï¼š
1. ç¼“å­˜ç®¡ç†é€»è¾‘
2. æ•°æ®åŠ è½½é€»è¾‘
3. é”™è¯¯å¤„ç†é€»è¾‘
4. é‡è¯•æœºåˆ¶

**æµ‹è¯•æ¡†æ¶**ï¼šJest + React Testing Library

**ç¤ºä¾‹æµ‹è¯•**ï¼š
```typescript
// src/hooks/__tests__/useCacheManager.test.ts
import {renderHook} from '@testing-library/react-hooks'
import {useCacheManager} from '../useCacheManager'

describe('useCacheManager', () => {
  it('should read and write cache correctly', () => {
    const {result} = renderHook(() =>
      useCacheManager({
        key: 'test_key',
        expiryMs: 5000
      })
    )
    
    const testData = {value: 'test'}
    result.current.write(testData)
    
    const cached = result.current.read()
    expect(cached).toEqual(testData)
  })
  
  it('should return null for expired cache', async () => {
    const {result} = renderHook(() =>
      useCacheManager({
        key: 'test_key',
        expiryMs: 100 // 100ms
      })
    )
    
    result.current.write({value: 'test'})
    
    // ç­‰å¾…ç¼“å­˜è¿‡æœŸ
    await new Promise(resolve => setTimeout(resolve, 150))
    
    const cached = result.current.read()
    expect(cached).toBeNull()
  })
})
```

---

### 9.2 é›†æˆæµ‹è¯•

**éœ€è¦æµ‹è¯•çš„åœºæ™¯**ï¼š
1. å®æ—¶è®¢é˜…æ˜¯å¦æ­£å¸¸å·¥ä½œ
2. ç¼“å­˜æ˜¯å¦æ­£ç¡®å¤±æ•ˆ
3. å¹¶å‘æ“ä½œæ˜¯å¦æ­£ç¡®å¤„ç†
4. é”™è¯¯é‡è¯•æ˜¯å¦ç”Ÿæ•ˆ

---

### 9.3 æ€§èƒ½æµ‹è¯•

**éœ€è¦æµ‹è¯•çš„æŒ‡æ ‡**ï¼š
1. é¦–æ¬¡åŠ è½½æ—¶é—´
2. ç¼“å­˜å‘½ä¸­ç‡
3. å†…å­˜å ç”¨
4. ç½‘ç»œè¯·æ±‚æ•°é‡

**æµ‹è¯•å·¥å…·**ï¼š
- Chrome DevTools
- React DevTools Profiler
- å¾®ä¿¡å¼€å‘è€…å·¥å…·æ€§èƒ½åˆ†æ

---

## åã€å®æ–½è®¡åˆ’

### ç¬¬1å‘¨ï¼šä¿®å¤ä¸¥é‡é—®é¢˜

**ä»»åŠ¡**ï¼š
- [x] ä¿®å¤æ— é™åˆ·æ–°å¾ªç¯
- [x] ä¿®å¤ç¼“å­˜é”®å†²çª
- [x] ç»Ÿä¸€è®¢é˜…æ¸…ç†æ–¹æ³•
- [x] æ·»åŠ åŸºæœ¬çš„é”™è¯¯é‡è¯•

**é¢„è®¡å·¥ä½œé‡**ï¼š2-3å¤©

---

### ç¬¬2å‘¨ï¼šé‡è¦ä¼˜åŒ–

**ä»»åŠ¡**ï¼š
- [ ] æå–å…¬å…±ç¼“å­˜ç®¡ç†é€»è¾‘
- [ ] å®ç°å®Œæ•´çš„é”™è¯¯é‡è¯•æœºåˆ¶
- [ ] æ·»åŠ è¶…æ—¶æ§åˆ¶
- [ ] ä¼˜åŒ–æ—¥å¿—è¾“å‡º

**é¢„è®¡å·¥ä½œé‡**ï¼š3-4å¤©

---

### ç¬¬3-4å‘¨ï¼šæ€§èƒ½ä¼˜åŒ–

**ä»»åŠ¡**ï¼š
- [ ] ä¼˜åŒ–æ•°æ®åŠ è½½ç­–ç•¥
- [ ] å®ç°æœåŠ¡å™¨ç«¯ç»Ÿè®¡è®¡ç®—
- [ ] ä¼˜åŒ–ç¼“å­˜ç­–ç•¥
- [ ] æ·»åŠ æ•°æ®é¢„åŠ è½½

**é¢„è®¡å·¥ä½œé‡**ï¼š5-7å¤©

---

### é•¿æœŸï¼ˆ1-2ä¸ªæœˆï¼‰ï¼šæ¶æ„æ”¹è¿›

**ä»»åŠ¡**ï¼š
- [ ] å®ç°ä¹è§‚é”
- [ ] å®Œå–„æµ‹è¯•è¦†ç›–
- [ ] æ€§èƒ½ç›‘æ§å’Œä¼˜åŒ–
- [ ] æ–‡æ¡£å®Œå–„

**é¢„è®¡å·¥ä½œé‡**ï¼šæŒç»­è¿›è¡Œ

---

## åä¸€ã€æ€»ç»“

### å½“å‰çŠ¶æ€è¯„ä¼°

**ä»£ç è´¨é‡**ï¼šâ­â­â­â˜†â˜† (3/5)
- åŸºæœ¬åŠŸèƒ½å®Œæ•´
- å­˜åœ¨å¤šä¸ªä¸¥é‡é—®é¢˜
- éœ€è¦é‡æ„ä¼˜åŒ–

**æ€§èƒ½**ï¼šâ­â­â˜†â˜†â˜† (2/5)
- å­˜åœ¨æ€§èƒ½ç“¶é¢ˆ
- ç¼“å­˜ç­–ç•¥éœ€ä¼˜åŒ–
- æ•°æ®åŠ è½½æ•ˆç‡ä½

**å¯ç»´æŠ¤æ€§**ï¼šâ­â­â˜†â˜†â˜† (2/5)
- ä»£ç é‡å¤ä¸¥é‡
- ç¼ºå°‘æŠ½è±¡å’Œå°è£…
- éš¾ä»¥æ‰©å±•

**ç¨³å®šæ€§**ï¼šâ­â­â­â˜†â˜† (3/5)
- åŸºæœ¬åŠŸèƒ½ç¨³å®š
- é”™è¯¯å¤„ç†ä¸è¶³
- è¾¹ç•Œæƒ…å†µå¤„ç†ä¸å®Œå–„

---

### ä¼˜åŒ–åé¢„æœŸæ•ˆæœ

**ä»£ç è´¨é‡**ï¼šâ­â­â­â­â˜† (4/5)
- æ¶ˆé™¤é‡å¤ä»£ç 
- æé«˜ä»£ç å¤ç”¨æ€§
- æ›´å¥½çš„æŠ½è±¡å’Œå°è£…

**æ€§èƒ½**ï¼šâ­â­â­â­â˜† (4/5)
- å‡å°‘ä¸å¿…è¦çš„è¯·æ±‚
- ä¼˜åŒ–ç¼“å­˜ç­–ç•¥
- æé«˜å“åº”é€Ÿåº¦

**å¯ç»´æŠ¤æ€§**ï¼šâ­â­â­â­â˜† (4/5)
- ä»£ç ç»“æ„æ¸…æ™°
- æ˜“äºç†è§£å’Œä¿®æ”¹
- è‰¯å¥½çš„æ‰©å±•æ€§

**ç¨³å®šæ€§**ï¼šâ­â­â­â­â˜† (4/5)
- å®Œå–„çš„é”™è¯¯å¤„ç†
- è‡ªåŠ¨é‡è¯•æœºåˆ¶
- æ›´å¥½çš„å®¹é”™èƒ½åŠ›

---

### å…³é”®æŒ‡æ ‡æ”¹å–„é¢„æœŸ

| æŒ‡æ ‡ | å½“å‰ | ä¼˜åŒ–å | æ”¹å–„ |
|-----|------|--------|------|
| é¦–æ¬¡åŠ è½½æ—¶é—´ | 3-5ç§’ | 1-2ç§’ | â¬‡ï¸ 60% |
| ç¼“å­˜å‘½ä¸­ç‡ | 30% | 70% | â¬†ï¸ 133% |
| ä»£ç é‡å¤ç‡ | 40% | 10% | â¬‡ï¸ 75% |
| é”™è¯¯æ¢å¤ç‡ | 20% | 80% | â¬†ï¸ 300% |
| å†…å­˜å ç”¨ | 50MB | 30MB | â¬‡ï¸ 40% |
| ç½‘ç»œè¯·æ±‚æ•° | 20æ¬¡/åˆ†é’Ÿ | 5æ¬¡/åˆ†é’Ÿ | â¬‡ï¸ 75% |

---

## åäºŒã€é™„å½•

### A. ç›¸å…³æ–‡ä»¶æ¸…å•

**éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶**ï¼š
1. `src/hooks/useDriverDashboard.ts`
2. `src/hooks/useDashboardData.ts`
3. `src/hooks/useSuperAdminDashboard.ts`
4. `src/hooks/useDriverWarehouses.ts`
5. `src/db/api.ts`

**éœ€è¦æ–°å»ºçš„æ–‡ä»¶**ï¼š
1. `src/hooks/useCacheManager.ts`
2. `src/hooks/useAsyncOperation.ts`
3. `src/hooks/useRealtimeSubscription.ts`
4. `src/utils/retry.ts`
5. `src/utils/timeout.ts`
6. `src/utils/logger.ts`
7. `src/utils/preload.ts`

---

### B. å‚è€ƒèµ„æ–™

1. [Supabase Realtime æ–‡æ¡£](https://supabase.com/docs/guides/realtime)
2. [React Hooks æœ€ä½³å®è·µ](https://react.dev/reference/react)
3. [Taro æ€§èƒ½ä¼˜åŒ–æŒ‡å—](https://taro-docs.jd.com/docs/optimized)
4. [ç¼“å­˜ç­–ç•¥è®¾è®¡](https://web.dev/cache-api-quick-guide/)

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**ï¼š2025-11-05  
**æŠ¥å‘Šç”Ÿæˆäºº**ï¼šç§’å“’ AI  
**ä¸‹æ¬¡å®¡æŸ¥å»ºè®®**ï¼šå®Œæˆä¼˜åŒ–å1ä¸ªæœˆ
