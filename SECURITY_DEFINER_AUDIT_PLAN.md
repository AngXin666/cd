# SECURITY DEFINER å‡½æ•°å®‰å…¨å®¡æŸ¥è®¡åˆ’

ç”Ÿæˆæ—¶é—´: 2025-11-26

---

## ğŸ“‹ å®¡æŸ¥æ¦‚è¿°

### å‘ç°çš„é—®é¢˜
- **å‡½æ•°æ•°é‡**: 47ä¸ª SECURITY DEFINER å‡½æ•°
- **é£é™©ç­‰çº§**: ä¸­å±
- **é—®é¢˜**: è¿™äº›å‡½æ•°ä»¥åˆ›å»ºè€…æƒé™è¿è¡Œï¼Œå¯èƒ½ç»•è¿‡RLS

### å®¡æŸ¥ç›®æ ‡
1. è¯†åˆ«é«˜é£é™©å‡½æ•°
2. æ£€æŸ¥æƒé™æ§åˆ¶é€»è¾‘
3. éªŒè¯è¾“å…¥éªŒè¯
4. ç¡®ä¿ç§Ÿæˆ·éš”ç¦»
5. ä¿®å¤å®‰å…¨æ¼æ´

---

## ğŸ”´ é«˜é£é™©å‡½æ•°ï¼ˆä¼˜å…ˆå®¡æŸ¥ï¼‰

### 1. ç”¨æˆ·è®¤è¯ç›¸å…³å‡½æ•°
- `create_user_auth_account` - åˆ›å»ºç”¨æˆ·è®¤è¯è´¦å·
- `create_user_auth_account_first` - åˆ›å»ºé¦–ä¸ªç”¨æˆ·è®¤è¯è´¦å·
- `reset_user_password_by_admin` - ç®¡ç†å‘˜é‡ç½®å¯†ç 
- `update_user_email` - æ›´æ–°ç”¨æˆ·é‚®ç®±
- `confirm_user_email` - ç¡®è®¤ç”¨æˆ·é‚®ç®±
- `register_user_with_password` - ç”¨æˆ·æ³¨å†Œ

**é£é™©**: å¦‚æœé€»è¾‘æœ‰æ¼æ´ï¼Œå¯èƒ½å¯¼è‡´æœªæˆæƒåˆ›å»º/ä¿®æ”¹ç”¨æˆ·

### 2. ç”¨æˆ·æ¸…ç†å‡½æ•°
- `cleanup_orphaned_auth_users` - æ¸…ç†å­¤ç«‹ç”¨æˆ·

**é£é™©**: å¯èƒ½è¯¯åˆ ç”¨æˆ·æ•°æ®

---

## ğŸŸ¡ ä¸­é£é™©å‡½æ•°

### 3. ç§Ÿæˆ·ç®¡ç†å‡½æ•°
- `auto_set_tenant_id` - è‡ªåŠ¨è®¾ç½®ç§Ÿæˆ·ID
- `auto_set_tenant_id_for_profile` - ä¸ºæ¡£æ¡ˆè®¾ç½®ç§Ÿæˆ·ID
- `set_driver_warehouse_tenant_id` - è®¾ç½®å¸æœºä»“åº“ç§Ÿæˆ·ID
- `get_user_tenant_id` - è·å–ç”¨æˆ·ç§Ÿæˆ·ID

**é£é™©**: å¦‚æœé€»è¾‘æœ‰æ¼æ´ï¼Œå¯èƒ½å¯¼è‡´ç§Ÿæˆ·éš”ç¦»å¤±æ•ˆ

### 4. ç”¨æˆ·åˆå§‹åŒ–å‡½æ•°
- `handle_new_user` - å¤„ç†æ–°ç”¨æˆ·
- `init_lease_admin_profile` - åˆå§‹åŒ–ç§Ÿèµç®¡ç†å‘˜

**é£é™©**: å¯èƒ½å¯¼è‡´æƒé™æå‡

---

## ğŸŸ¢ ä½é£é™©å‡½æ•°

### 5. æƒé™æ£€æŸ¥å‡½æ•°
- `is_admin` - æ£€æŸ¥æ˜¯å¦ä¸ºç®¡ç†å‘˜
- `is_lease_admin` - æ£€æŸ¥æ˜¯å¦ä¸ºç§Ÿèµç®¡ç†å‘˜
- `is_lease_admin_user` - æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ä¸ºç§Ÿèµç®¡ç†å‘˜
- `is_manager` - æ£€æŸ¥æ˜¯å¦ä¸ºè½¦é˜Ÿé•¿
- `is_manager_of_driver` - æ£€æŸ¥æ˜¯å¦ä¸ºå¸æœºçš„è½¦é˜Ÿé•¿
- `is_manager_of_warehouse` - æ£€æŸ¥æ˜¯å¦ä¸ºä»“åº“çš„è½¦é˜Ÿé•¿
- `is_manager_or_above` - æ£€æŸ¥æ˜¯å¦ä¸ºè½¦é˜Ÿé•¿æˆ–ä»¥ä¸Š
- `is_super_admin` - æ£€æŸ¥æ˜¯å¦ä¸ºè¶…çº§ç®¡ç†å‘˜
- `is_driver_of_warehouse` - æ£€æŸ¥æ˜¯å¦ä¸ºä»“åº“çš„å¸æœº
- `can_access_warehouse` - æ£€æŸ¥æ˜¯å¦å¯ä»¥è®¿é—®ä»“åº“
- `manager_has_warehouse` - æ£€æŸ¥è½¦é˜Ÿé•¿æ˜¯å¦æœ‰ä»“åº“

**é£é™©**: ç›¸å¯¹è¾ƒä½ï¼Œä½†éœ€ç¡®ä¿é€»è¾‘æ­£ç¡®

### 6. é€šçŸ¥ç›¸å…³å‡½æ•°
- `create_notification` - åˆ›å»ºé€šçŸ¥
- `create_notifications_batch` - æ‰¹é‡åˆ›å»ºé€šçŸ¥
- `get_active_scroll_notifications` - è·å–æ´»åŠ¨æ»šåŠ¨é€šçŸ¥
- `get_unread_notification_count` - è·å–æœªè¯»é€šçŸ¥æ•°é‡
- `mark_notification_as_read` - æ ‡è®°é€šçŸ¥ä¸ºå·²è¯»
- `mark_all_notifications_as_read` - æ ‡è®°æ‰€æœ‰é€šçŸ¥ä¸ºå·²è¯»
- `cleanup_expired_notifications` - æ¸…ç†è¿‡æœŸé€šçŸ¥

**é£é™©**: ç›¸å¯¹è¾ƒä½

### 7. è§¦å‘å™¨å‡½æ•°
- `notify_on_driver_profile_update` - å¸æœºæ¡£æ¡ˆæ›´æ–°é€šçŸ¥
- `notify_on_driver_type_change` - å¸æœºç±»å‹å˜æ›´é€šçŸ¥
- `notify_on_license_approval` - é©¾ç…§å®¡æ‰¹é€šçŸ¥
- `notify_on_manager_permission_change` - è½¦é˜Ÿé•¿æƒé™å˜æ›´é€šçŸ¥
- `notify_on_warehouse_assignment` - ä»“åº“åˆ†é…é€šçŸ¥
- `send_vehicle_review_notifications` - å‘é€è½¦è¾†å®¡æ ¸é€šçŸ¥
- `prevent_role_change` - é˜²æ­¢è§’è‰²å˜æ›´
- `sync_driver_real_name` - åŒæ­¥å¸æœºçœŸå®å§“å
- `update_late_days_count` - æ›´æ–°è¿Ÿåˆ°å¤©æ•°

**é£é™©**: ç›¸å¯¹è¾ƒä½

### 8. ç»Ÿè®¡æŸ¥è¯¢å‡½æ•°
- `get_driver_attendance_stats` - è·å–å¸æœºè€ƒå‹¤ç»Ÿè®¡
- `get_manager_warehouse_ids` - è·å–è½¦é˜Ÿé•¿ä»“åº“IDåˆ—è¡¨

**é£é™©**: ç›¸å¯¹è¾ƒä½

### 9. æ•°æ®åº“å…ƒæ•°æ®å‡½æ•°
- `get_database_tables` - è·å–æ•°æ®åº“è¡¨åˆ—è¡¨
- `get_table_columns` - è·å–è¡¨å­—æ®µåˆ—è¡¨
- `get_table_constraints` - è·å–è¡¨çº¦æŸåˆ—è¡¨

**é£é™©**: å¯èƒ½æ³„éœ²æ•°æ®åº“ç»“æ„ä¿¡æ¯

### 10. å·¥å…·å‡½æ•°
- `uid` - è·å–å½“å‰ç”¨æˆ·ID

**é£é™©**: ä½

---

## ğŸ” å®¡æŸ¥æ¸…å•

å¯¹æ¯ä¸ªå‡½æ•°æ£€æŸ¥ä»¥ä¸‹å†…å®¹ï¼š

### 1. æƒé™æ£€æŸ¥ âœ“
- [ ] å‡½æ•°å†…éƒ¨æ˜¯å¦æœ‰é€‚å½“çš„æƒé™æ£€æŸ¥ï¼Ÿ
- [ ] æ˜¯å¦éªŒè¯äº† auth.uid()ï¼Ÿ
- [ ] æ˜¯å¦æ£€æŸ¥äº†ç”¨æˆ·è§’è‰²ï¼Ÿ
- [ ] æ˜¯å¦é˜²æ­¢äº†æƒé™æå‡ï¼Ÿ

### 2. è¾“å…¥éªŒè¯ âœ“
- [ ] æ˜¯å¦éªŒè¯äº†æ‰€æœ‰è¾“å…¥å‚æ•°ï¼Ÿ
- [ ] æ˜¯å¦é˜²æ­¢äº†SQLæ³¨å…¥ï¼Ÿ
- [ ] æ˜¯å¦é˜²æ­¢äº†å‚æ•°ç¯¡æ”¹ï¼Ÿ
- [ ] æ˜¯å¦æœ‰é•¿åº¦å’Œæ ¼å¼éªŒè¯ï¼Ÿ

### 3. ç§Ÿæˆ·éš”ç¦» âœ“
- [ ] æ˜¯å¦æ­£ç¡®æ£€æŸ¥äº† tenant_idï¼Ÿ
- [ ] æ˜¯å¦é˜²æ­¢äº†è·¨ç§Ÿæˆ·è®¿é—®ï¼Ÿ
- [ ] æ˜¯å¦æ­£ç¡®å¤„ç†äº†å¹³çº§è´¦å·ï¼Ÿ
- [ ] æ˜¯å¦éªŒè¯äº†æ•°æ®æ‰€æœ‰æƒï¼Ÿ

### 4. æœç´¢è·¯å¾„å®‰å…¨ âœ“
- [ ] æ˜¯å¦è®¾ç½®äº† `SET search_path = public`ï¼Ÿ
- [ ] æ˜¯å¦é˜²æ­¢äº†æœç´¢è·¯å¾„æ”»å‡»ï¼Ÿ

### 5. é”™è¯¯å¤„ç† âœ“
- [ ] æ˜¯å¦æœ‰é€‚å½“çš„é”™è¯¯å¤„ç†ï¼Ÿ
- [ ] é”™è¯¯ä¿¡æ¯æ˜¯å¦æ³„éœ²æ•æ„Ÿä¿¡æ¯ï¼Ÿ
- [ ] æ˜¯å¦ä½¿ç”¨äº† RAISE EXCEPTIONï¼Ÿ

### 6. è¿”å›å€¼å®‰å…¨ âœ“
- [ ] è¿”å›å€¼æ˜¯å¦åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼Ÿ
- [ ] æ˜¯å¦è¿‡æ»¤äº†ä¸åº”è¿”å›çš„æ•°æ®ï¼Ÿ

---

## ğŸ“ å®¡æŸ¥è¿›åº¦

### ç¬¬ä¸€é˜¶æ®µï¼šé«˜é£é™©å‡½æ•°ï¼ˆ2-3å¤©ï¼‰
- [ ] create_user_auth_account
- [ ] create_user_auth_account_first
- [ ] reset_user_password_by_admin
- [ ] update_user_email
- [ ] confirm_user_email
- [ ] register_user_with_password
- [ ] cleanup_orphaned_auth_users

### ç¬¬äºŒé˜¶æ®µï¼šä¸­é£é™©å‡½æ•°ï¼ˆ2-3å¤©ï¼‰
- [ ] auto_set_tenant_id
- [ ] auto_set_tenant_id_for_profile
- [ ] set_driver_warehouse_tenant_id
- [ ] get_user_tenant_id
- [ ] handle_new_user
- [ ] init_lease_admin_profile

### ç¬¬ä¸‰é˜¶æ®µï¼šä½é£é™©å‡½æ•°ï¼ˆ3-4å¤©ï¼‰
- [ ] æƒé™æ£€æŸ¥å‡½æ•°ï¼ˆ11ä¸ªï¼‰
- [ ] é€šçŸ¥ç›¸å…³å‡½æ•°ï¼ˆ7ä¸ªï¼‰
- [ ] è§¦å‘å™¨å‡½æ•°ï¼ˆ9ä¸ªï¼‰
- [ ] ç»Ÿè®¡æŸ¥è¯¢å‡½æ•°ï¼ˆ2ä¸ªï¼‰
- [ ] æ•°æ®åº“å…ƒæ•°æ®å‡½æ•°ï¼ˆ3ä¸ªï¼‰
- [ ] å·¥å…·å‡½æ•°ï¼ˆ1ä¸ªï¼‰

---

## ğŸ¯ é¢„æœŸæˆæœ

1. **å®‰å…¨å®¡æŸ¥æŠ¥å‘Š**: è¯¦ç»†è®°å½•æ¯ä¸ªå‡½æ•°çš„å®‰å…¨çŠ¶å†µ
2. **ä¿®å¤è„šæœ¬**: ä¿®å¤å‘ç°çš„å®‰å…¨æ¼æ´
3. **æœ€ä½³å®è·µæ–‡æ¡£**: ç¼–å†™ SECURITY DEFINER å‡½æ•°çš„æœ€ä½³å®è·µ
4. **è‡ªåŠ¨åŒ–æµ‹è¯•**: æ·»åŠ å®‰å…¨æµ‹è¯•ç”¨ä¾‹

---

**è®¡åˆ’åˆ›å»ºæ—¶é—´**: 2025-11-26
**é¢„è®¡å®Œæˆæ—¶é—´**: 2025-12-03
**è´Ÿè´£äºº**: AI Assistant
