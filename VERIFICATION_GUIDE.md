# ✅ 系统回滚验证指南

## 🎯 快速验证步骤

### 1. 启动开发服务器

```bash
cd /workspace/app-7cdqf07mbu9t
pnpm run dev:h5
```

**预期结果**：
- ✅ 服务器成功启动
- ✅ 访问 http://localhost:10086/
- ✅ 看到登录页面

---

### 2. 测试登录功能

#### 测试账号 1：超级管理员

```
手机号：13800000001
密码：123456
```

**预期结果**：
- ✅ 登录成功
- ✅ 进入超级管理员工作台
- ✅ 可以看到所有管理功能

#### 测试账号 2：司机

```
手机号：13900001122
密码：123456
```

**预期结果**：
- ✅ 登录成功
- ✅ 进入司机工作台
- ✅ 可以看到司机功能

---

### 3. 验证多租户功能

#### 3.1 检查租户列表

1. 使用超级管理员账号登录
2. 进入"中央管理"页面
3. 查看租户列表

**预期结果**：
- ✅ 可以看到 2 个测试租户
  - 测试租户1（tenant_test1）
  - 测试租户2（tenant_test2）

#### 3.2 创建新租户

1. 点击"创建租户"按钮
2. 填写租户信息
3. 提交创建

**预期结果**：
- ✅ 租户创建成功
- ✅ 自动创建租户 Schema
- ✅ 租户出现在列表中

---

### 4. 验证核心功能

#### 4.1 用户管理

- [ ] 查看用户列表
- [ ] 创建新用户
- [ ] 编辑用户信息
- [ ] 分配用户角色

#### 4.2 车辆管理

- [ ] 查看车辆列表
- [ ] 添加新车辆
- [ ] 编辑车辆信息
- [ ] 车辆租赁管理

#### 4.3 仓库管理

- [ ] 查看仓库列表
- [ ] 创建新仓库
- [ ] 分配仓库给司机
- [ ] 分配仓库给管理员

#### 4.4 考勤管理

- [ ] 司机打卡
- [ ] 查看考勤记录
- [ ] 考勤统计

#### 4.5 计件管理

- [ ] 录入计件记录
- [ ] 查看计件报表
- [ ] 计件统计

#### 4.6 请假管理

- [ ] 提交请假申请
- [ ] 审批请假申请
- [ ] 查看请假记录

#### 4.7 通知系统

- [ ] 发送通知
- [ ] 查看通知列表
- [ ] 通知模板管理
- [ ] 定时通知

---

### 5. 验证权限系统

#### 5.1 角色权限

测试不同角色的权限：

**系统管理员（System Admin）**：
- ✅ 可以管理所有租户
- ✅ 可以创建租户
- ✅ 可以查看所有数据

**租户超级管理员（Super Admin）**：
- ✅ 可以管理本租户所有数据
- ✅ 可以创建用户
- ✅ 可以分配权限

**车队长（Fleet Leader）**：
- ✅ 可以管理本车队数据
- ✅ 可以审批请假
- ✅ 可以查看报表

**调度员（Dispatcher）**：
- ✅ 可以分配任务
- ✅ 可以查看司机信息
- ✅ 可以管理仓库

**司机（Driver）**：
- ✅ 可以打卡
- ✅ 可以录入计件
- ✅ 可以申请请假
- ✅ 可以查看自己的数据

#### 5.2 数据隔离

测试租户数据隔离：

1. 创建 2 个不同租户的用户
2. 分别登录
3. 验证只能看到自己租户的数据

**预期结果**：
- ✅ 租户 A 的用户看不到租户 B 的数据
- ✅ 租户 B 的用户看不到租户 A 的数据
- ✅ 系统管理员可以看到所有租户的数据

---

### 6. 验证数据库状态

#### 6.1 检查表结构

```sql
-- 检查所有表
SELECT table_schema, table_name 
FROM information_schema.tables 
WHERE table_schema IN ('public', 'tenant_test1', 'tenant_test2')
ORDER BY table_schema, table_name;
```

**预期结果**：
- ✅ public schema 包含 33 个表
- ✅ 包含多租户核心表：
  - tenants
  - user_credentials
  - system_admins
  - profiles
  - warehouses
  - vehicles
  - attendance
  - leave_applications
  - piece_work_records
  - notifications

#### 6.2 检查租户数据

```sql
-- 检查租户
SELECT id, company_name, schema_name, status 
FROM tenants;
```

**预期结果**：
- ✅ 至少有 2 个测试租户
- ✅ 状态为 active

#### 6.3 检查用户数据

```sql
-- 检查用户
SELECT id, phone, role, tenant_id 
FROM profiles 
ORDER BY created_at;
```

**预期结果**：
- ✅ 至少有 2 个用户
- ✅ 包含超级管理员和司机

---

### 7. 性能测试

#### 7.1 页面加载速度

- [ ] 登录页面加载 < 1 秒
- [ ] 工作台页面加载 < 2 秒
- [ ] 列表页面加载 < 3 秒

#### 7.2 API 响应时间

- [ ] 登录 API < 500ms
- [ ] 查询列表 API < 1000ms
- [ ] 创建数据 API < 500ms

#### 7.3 数据库查询性能

```sql
-- 测试查询性能
EXPLAIN ANALYZE
SELECT * FROM profiles WHERE tenant_id = '26d10bc2-d13b-44b0-ac9f-dec469cfadc9';
```

**预期结果**：
- ✅ 查询时间 < 100ms
- ✅ 使用索引

---

### 8. 错误处理测试

#### 8.1 登录错误

- [ ] 错误的手机号 → 显示错误提示
- [ ] 错误的密码 → 显示错误提示
- [ ] 空输入 → 显示验证错误

#### 8.2 权限错误

- [ ] 无权限访问 → 跳转到登录页
- [ ] 跨租户访问 → 显示权限错误

#### 8.3 数据验证错误

- [ ] 必填字段为空 → 显示验证错误
- [ ] 格式错误 → 显示格式错误
- [ ] 重复数据 → 显示重复错误

---

### 9. 浏览器兼容性测试

测试以下浏览器：

- [ ] Chrome（最新版）
- [ ] Firefox（最新版）
- [ ] Safari（最新版）
- [ ] Edge（最新版）

**预期结果**：
- ✅ 所有浏览器都能正常运行
- ✅ 样式显示正确
- ✅ 功能正常

---

### 10. 移动端测试

#### 10.1 H5 页面测试

在手机浏览器中测试：

- [ ] 页面布局正确
- [ ] 触摸操作正常
- [ ] 表单输入正常
- [ ] 图片显示正常

#### 10.2 微信小程序测试

使用微信开发者工具测试：

```bash
pnpm run dev:weapp
```

- [ ] 小程序正常启动
- [ ] 页面显示正确
- [ ] 功能正常
- [ ] 性能良好

---

## 🚨 常见问题排查

### 问题 1：无法登录

**症状**：输入账号密码后无法登录

**排查步骤**：

1. 检查网络连接
2. 检查 Supabase 连接
3. 检查用户数据

```sql
-- 检查用户是否存在
SELECT * FROM auth.users WHERE phone = '13800000001';

-- 检查 profiles 表
SELECT * FROM profiles WHERE phone = '13800000001';
```

**解决方案**：

如果用户不存在，重新创建用户：

```sql
-- 使用 Supabase Dashboard 创建用户
-- 或使用注册功能
```

### 问题 2：权限错误

**症状**：登录后无法访问某些页面

**排查步骤**：

1. 检查用户角色

```sql
SELECT id, phone, role, tenant_id FROM profiles WHERE phone = '13800000001';
```

2. 检查 RLS 策略

```sql
-- 查看表的 RLS 策略
SELECT * FROM pg_policies WHERE tablename = 'profiles';
```

**解决方案**：

确保用户有正确的角色和权限。

### 问题 3：数据不显示

**症状**：列表页面没有数据

**排查步骤**：

1. 检查数据库是否有数据

```sql
-- 检查表数据
SELECT COUNT(*) FROM warehouses;
SELECT COUNT(*) FROM vehicles;
```

2. 检查 API 调用

打开浏览器开发者工具，查看 Network 标签。

**解决方案**：

如果没有数据，添加测试数据：

```sql
-- 添加测试仓库
INSERT INTO warehouses (name, address, tenant_id)
VALUES ('测试仓库', '测试地址', '26d10bc2-d13b-44b0-ac9f-dec469cfadc9');
```

### 问题 4：页面报错

**症状**：页面显示错误信息或白屏

**排查步骤**：

1. 打开浏览器控制台，查看错误信息
2. 检查 API 调用是否成功
3. 检查数据格式是否正确

**解决方案**：

根据错误信息修复问题。

---

## 📊 验证报告模板

完成验证后，填写以下报告：

```markdown
# 系统回滚验证报告

**验证时间**：2025-11-29  
**验证人员**：[姓名]  
**系统版本**：b47c96f

## 验证结果

### 1. 基础功能
- [ ] 登录功能：✅ 通过 / ❌ 失败
- [ ] 角色识别：✅ 通过 / ❌ 失败
- [ ] 权限控制：✅ 通过 / ❌ 失败

### 2. 多租户功能
- [ ] 租户管理：✅ 通过 / ❌ 失败
- [ ] 数据隔离：✅ 通过 / ❌ 失败
- [ ] 跨租户管理：✅ 通过 / ❌ 失败

### 3. 业务功能
- [ ] 用户管理：✅ 通过 / ❌ 失败
- [ ] 车辆管理：✅ 通过 / ❌ 失败
- [ ] 仓库管理：✅ 通过 / ❌ 失败
- [ ] 考勤管理：✅ 通过 / ❌ 失败
- [ ] 计件管理：✅ 通过 / ❌ 失败
- [ ] 请假管理：✅ 通过 / ❌ 失败
- [ ] 通知系统：✅ 通过 / ❌ 失败

### 4. 性能测试
- [ ] 页面加载速度：✅ 通过 / ❌ 失败
- [ ] API 响应时间：✅ 通过 / ❌ 失败
- [ ] 数据库性能：✅ 通过 / ❌ 失败

### 5. 兼容性测试
- [ ] 浏览器兼容性：✅ 通过 / ❌ 失败
- [ ] 移动端兼容性：✅ 通过 / ❌ 失败

## 发现的问题

1. [问题描述]
   - 严重程度：高/中/低
   - 影响范围：[描述]
   - 解决方案：[描述]

## 总体评价

- [ ] ✅ 系统运行正常，可以投入使用
- [ ] ⚠️ 系统基本正常，有小问题需要修复
- [ ] ❌ 系统有严重问题，需要立即修复

## 备注

[其他说明]
```

---

## 🎉 验证成功标志

当所有验证项都通过时，系统回滚成功！

✅ **系统状态**：
- 代码版本：b47c96f
- 架构类型：多租户架构
- 功能状态：完整可用
- 数据状态：完整保留
- 性能状态：正常

✅ **可以开始使用系统了！**

---

**文档创建时间**：2025-11-29 20:00  
**文档版本**：1.0  
**适用版本**：多租户架构稳定版（b47c96f）
