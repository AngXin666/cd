# 司机端考勤规则访问修复 - 测试验证说明

## 修复内容
已修复司机端无法获取考勤规则的问题，通过添加 RLS 策略允许司机查看他们被分配的仓库的考勤规则。

---

## 测试账号信息

### 测试司机账号
- **司机ID**: `fb2305c2-0f16-4c67-b55c-19a8e4243488`
- **姓名**: 邱吉兴
- **手机**: 15766121960
- **角色**: driver

### 分配的仓库
1. **西区仓库** (ID: `0a25b0b0-6b2c-407b-8f28-54749500c384`)
   - 上班时间: 09:30
   - 下班时间: 18:30
   - 迟到阈值: 20分钟
   - 早退阈值: 20分钟
   - 需要下班打卡: 是

2. **总部仓库** (ID: `6f403c5a-4e76-46b0-a5e7-39f95b93144d`)
   - 上班时间: 09:00
   - 下班时间: 18:00
   - 迟到阈值: 15分钟
   - 早退阈值: 15分钟
   - 需要下班打卡: 是

---

## 测试步骤

### 1. 司机端登录
1. 使用手机号 `15766121960` 登录司机端
2. 进入打卡页面

### 2. 查看仓库列表
**预期结果**：
- ✅ 可以看到"西区仓库"和"总部仓库"
- ✅ 不会看到其他未分配的仓库

### 3. 选择仓库并查看考勤规则
**操作**：选择"西区仓库"

**预期结果**：
- ✅ 显示考勤规则信息
- ✅ 上班时间: 09:30
- ✅ 下班时间: 18:30
- ✅ 迟到阈值: 20分钟
- ✅ 早退阈值: 20分钟

**操作**：选择"总部仓库"

**预期结果**：
- ✅ 显示考勤规则信息
- ✅ 上班时间: 09:00
- ✅ 下班时间: 18:00
- ✅ 迟到阈值: 15分钟
- ✅ 早退阈值: 15分钟

### 4. 进行打卡操作
**操作**：在选择仓库后，点击"上班打卡"或"下班打卡"

**预期结果**：
- ✅ 可以正常进行打卡
- ✅ 打卡成功后显示成功提示
- ✅ 打卡记录保存到数据库

---

## 数据库验证

### 验证 RLS 策略
```sql
-- 查看 attendance_rules 表的 RLS 策略
SELECT tablename, policyname, cmd, roles
FROM pg_policies
WHERE tablename = 'attendance_rules'
ORDER BY policyname;
```

**预期结果**：
- ✅ 存在策略: "Drivers can view attendance rules for their warehouses"
- ✅ 策略类型: SELECT
- ✅ 角色: authenticated

### 验证司机可以查询考勤规则
```sql
-- 查询司机被分配的仓库
SELECT dw.warehouse_id, w.name as warehouse_name
FROM driver_warehouses dw
LEFT JOIN warehouses w ON dw.warehouse_id = w.id
WHERE dw.driver_id = 'fb2305c2-0f16-4c67-b55c-19a8e4243488';

-- 查询这些仓库的考勤规则
SELECT ar.id, ar.warehouse_id, w.name as warehouse_name,
       ar.work_start_time, ar.work_end_time, 
       ar.is_active
FROM attendance_rules ar
LEFT JOIN warehouses w ON ar.warehouse_id = w.id
WHERE ar.warehouse_id IN (
  SELECT warehouse_id 
  FROM driver_warehouses 
  WHERE driver_id = 'fb2305c2-0f16-4c67-b55c-19a8e4243488'
)
AND ar.is_active = true;
```

**预期结果**：
- ✅ 返回2条考勤规则记录
- ✅ 西区仓库的规则
- ✅ 总部仓库的规则

---

## 安全性验证

### 测试场景 1：司机只能查看自己的仓库
**操作**：司机尝试查询未分配的仓库的考勤规则

**预期结果**：
- ✅ 无法获取未分配仓库的考勤规则
- ✅ 查询返回空结果或权限错误

### 测试场景 2：司机无法修改考勤规则
**操作**：司机尝试修改考勤规则

**预期结果**：
- ✅ 操作被拒绝
- ✅ 返回权限错误

### 测试场景 3：司机只能查看启用的规则
**操作**：管理员禁用某个仓库的考勤规则后，司机查询该规则

**预期结果**：
- ✅ 司机无法查询到被禁用的规则
- ✅ 只能看到 `is_active = true` 的规则

---

## 回归测试

### 管理员功能
**验证项目**：
- ✅ 管理员可以查看他们管理的仓库的考勤规则
- ✅ 管理员可以创建、修改、删除考勤规则
- ✅ 管理员无法查看其他仓库的规则

### 超级管理员功能
**验证项目**：
- ✅ 超级管理员可以查看所有考勤规则
- ✅ 超级管理员可以管理所有仓库的规则
- ✅ 超级管理员可以分配司机到仓库

---

## 问题排查

### 如果司机仍然无法查看考勤规则

#### 1. 检查司机是否已登录
```typescript
// 在浏览器控制台执行
const { user } = useAuth();
console.log('当前用户:', user);
```

**预期结果**：
- 应该返回用户信息
- `user.id` 应该等于司机的 ID

#### 2. 检查司机是否被分配到仓库
```sql
SELECT * FROM driver_warehouses 
WHERE driver_id = '<司机ID>';
```

**预期结果**：
- 应该返回至少一条记录
- 记录中的 `warehouse_id` 应该对应有效的仓库

#### 3. 检查考勤规则是否存在且启用
```sql
SELECT * FROM attendance_rules 
WHERE warehouse_id = '<仓库ID>' 
AND is_active = true;
```

**预期结果**：
- 应该返回一条考勤规则记录
- `is_active` 应该为 `true`

#### 4. 检查 RLS 策略是否生效
```sql
SELECT * FROM pg_policies 
WHERE tablename = 'attendance_rules' 
AND policyname = 'Drivers can view attendance rules for their warehouses';
```

**预期结果**：
- 应该返回一条策略记录
- 策略应该处于启用状态

#### 5. 查看错误日志
在浏览器控制台或应用日志中查看是否有错误信息：
- 权限错误
- 网络错误
- 数据库查询错误

---

## 成功标准

### ✅ 功能正常
1. 司机可以登录系统
2. 司机可以看到他们被分配的仓库列表
3. 司机可以选择仓库并查看考勤规则
4. 司机可以正常进行打卡操作
5. 打卡记录正确保存到数据库

### ✅ 安全性保证
1. 司机只能查看自己被分配的仓库的规则
2. 司机无法修改考勤规则
3. 司机只能查看启用状态的规则
4. 管理员和超级管理员的权限不受影响

### ✅ 性能正常
1. 查询考勤规则的响应时间 < 1秒
2. 打卡操作的响应时间 < 2秒
3. 页面加载流畅，无明显卡顿

---

## 联系支持

如果在测试过程中遇到任何问题，请提供以下信息：
1. 测试账号信息（司机ID、手机号）
2. 操作步骤
3. 预期结果 vs 实际结果
4. 错误信息（如果有）
5. 浏览器控制台日志
6. 数据库查询结果

---

**测试日期**: 2025-11-05  
**修复版本**: v1.0.1  
**修复状态**: ✅ 已完成  
**测试状态**: 待验证
