# ä»“åº“ç®¡ç†å…¨åŠŸèƒ½å¤šç§Ÿæˆ·é€‚é…æ£€æŸ¥æŠ¥å‘Š

## ğŸ“‹ æ£€æŸ¥æ¦‚è¿°

å…¨é¢æ£€æŸ¥ä»“åº“ç®¡ç†çš„æ‰€æœ‰åŠŸèƒ½æ˜¯å¦æ­£ç¡®é€‚é…å¤šç§Ÿæˆ·æ¶æ„ï¼ˆæ¯ä¸ªç§Ÿæˆ·ä½¿ç”¨ç‹¬ç«‹æ•°æ®åº“æ¨¡å¼ï¼‰ã€‚

## ğŸ” æ£€æŸ¥èŒƒå›´

### 1. æ ¸å¿ƒä»“åº“åŠŸèƒ½
- âœ… åˆ›å»ºä»“åº“
- âœ… æŸ¥è¯¢ä»“åº“
- âœ… æ›´æ–°ä»“åº“
- âœ… åˆ é™¤ä»“åº“

### 2. ä»“åº“åˆ†é…åŠŸèƒ½
- âœ… å¸æœºä»“åº“åˆ†é…
- âœ… è½¦é˜Ÿé•¿ä»“åº“åˆ†é…
- âœ… æŸ¥è¯¢åˆ†é…å…³ç³»

### 3. è€ƒå‹¤è§„åˆ™åŠŸèƒ½
- âŒ åˆ›å»ºè€ƒå‹¤è§„åˆ™
- âœ… æŸ¥è¯¢è€ƒå‹¤è§„åˆ™
- âœ… æ›´æ–°è€ƒå‹¤è§„åˆ™
- âœ… åˆ é™¤è€ƒå‹¤è§„åˆ™

### 4. ä»“åº“ç›¸å…³ç»Ÿè®¡
- âœ… ä»“åº“æ•°æ®é‡ç»Ÿè®¡
- âœ… ä»“åº“å¸æœºæ•°é‡
- âœ… ä»“åº“ä»ªè¡¨æ¿ç»Ÿè®¡

## ğŸ“Š è¯¦ç»†æ£€æŸ¥ç»“æœ

### âœ… å·²æ­£ç¡®é€‚é…çš„åŠŸèƒ½

#### 1. åˆ›å»ºä»“åº“ - âœ… å·²ä¿®å¤
**å‡½æ•°**ï¼š`createWarehouse`  
**çŠ¶æ€**ï¼šâœ… å·²æ·»åŠ  `boss_id` å’Œ `tenant_id`

```typescript
export async function createWarehouse(input: WarehouseInput): Promise<Warehouse | null> {
  // 1. è·å–å½“å‰ç”¨æˆ·
  const { data: { user } } = await supabase.auth.getUser()
  if (!user) throw new Error('ç”¨æˆ·æœªç™»å½•')

  // 2. è·å– boss_id
  const { data: profile } = await supabase
    .from('profiles')
    .select('boss_id')
    .eq('id', user.id)
    .maybeSingle()
  
  if (!profile?.boss_id) throw new Error('æ— æ³•è·å–ç”¨æˆ·ä¿¡æ¯')

  // 3. æ’å…¥ä»“åº“ï¼ˆè‡ªåŠ¨æ·»åŠ  boss_id å’Œ tenant_idï¼‰
  const { data, error } = await supabase
    .from('warehouses')
    .insert({
      name: input.name,
      is_active: input.is_active !== undefined ? input.is_active : true,
      boss_id: profile.boss_id,
      tenant_id: profile.boss_id
    })
    .select()
    .maybeSingle()

  // ...
}
```

**æ•ˆæœ**ï¼š
- âœ… è‡ªåŠ¨æ·»åŠ  `boss_id` å’Œ `tenant_id`
- âœ… æ¯ä¸ªç§Ÿæˆ·çš„ä»“åº“æ•°æ®å®Œå…¨éš”ç¦»

#### 2. æŸ¥è¯¢ä»“åº“ - âœ… ä¾èµ– RLS ç­–ç•¥
**å‡½æ•°**ï¼š
- `getAllWarehouses()` - è·å–æ‰€æœ‰ä»“åº“
- `getActiveWarehouses()` - è·å–æ´»è·ƒä»“åº“
- `getWarehouseById(id)` - è·å–ä»“åº“è¯¦æƒ…
- `getWarehouseWithRule(id)` - è·å–ä»“åº“åŠè§„åˆ™

**RLS ç­–ç•¥**ï¼š
```sql
CREATE POLICY "Super admin can manage tenant warehouses" ON warehouses
  FOR ALL TO authenticated
  USING ((boss_id = get_current_user_boss_id()) AND is_super_admin(auth.uid()))
  WITH CHECK ((boss_id = get_current_user_boss_id()) AND is_super_admin(auth.uid()));
```

**æ•ˆæœ**ï¼š
- âœ… æ•°æ®åº“å±‚é¢è‡ªåŠ¨è¿‡æ»¤ `boss_id`
- âœ… ç”¨æˆ·åªèƒ½æŸ¥è¯¢è‡ªå·±ç§Ÿæˆ·çš„ä»“åº“
- âœ… æ— æ³•æŸ¥è¯¢å…¶ä»–ç§Ÿæˆ·çš„ä»“åº“

#### 3. æ›´æ–°å’Œåˆ é™¤ä»“åº“ - âœ… ä¾èµ– RLS ç­–ç•¥
**å‡½æ•°**ï¼š
- `updateWarehouse(id, update)` - æ›´æ–°ä»“åº“
- `deleteWarehouse(id)` - åˆ é™¤ä»“åº“

**æ•ˆæœ**ï¼š
- âœ… RLS ç­–ç•¥é˜»æ­¢è·¨ç§Ÿæˆ·æ“ä½œ
- âœ… åªèƒ½æ›´æ–°/åˆ é™¤è‡ªå·±ç§Ÿæˆ·çš„ä»“åº“

#### 4. å¸æœºä»“åº“åˆ†é… - âœ… å·²ä¿®å¤
**å‡½æ•°**ï¼š`insertWarehouseAssignment`  
**çŠ¶æ€**ï¼šâœ… å·²æ·»åŠ  `boss_id` å’Œ `tenant_id`

```typescript
export async function insertWarehouseAssignment(input: DriverWarehouseInput): Promise<boolean> {
  // è·å–å½“å‰ç”¨æˆ·çš„ boss_id
  const { data: { user } } = await supabase.auth.getUser()
  if (!user) return false

  const { data: profile } = await supabase
    .from('profiles')
    .select('boss_id')
    .eq('id', user.id)
    .maybeSingle()
  
  if (!profile?.boss_id) return false

  // æ’å…¥æ—¶è‡ªåŠ¨æ·»åŠ  boss_id å’Œ tenant_id
  const { error } = await supabase
    .from('driver_warehouses')
    .insert({
      ...input,
      boss_id: profile.boss_id,
      tenant_id: profile.boss_id
    })

  return !error
}
```

**æ•ˆæœ**ï¼š
- âœ… è‡ªåŠ¨æ·»åŠ  `boss_id` å’Œ `tenant_id`
- âœ… å¸æœºä»“åº“åˆ†é…æ•°æ®å®Œå…¨éš”ç¦»

#### 5. æŸ¥è¯¢ä»“åº“åˆ†é… - âœ… ä¾èµ– RLS ç­–ç•¥
**å‡½æ•°**ï¼š
- `getDriverWarehouses(driverId)` - è·å–å¸æœºçš„ä»“åº“
- `getDriverWarehouseIds(driverId)` - è·å–å¸æœºçš„ä»“åº“ ID
- `getDriversByWarehouse(warehouseId)` - è·å–ä»“åº“çš„å¸æœº
- `getAllDriverWarehouses()` - è·å–æ‰€æœ‰å¸æœºä»“åº“åˆ†é…

**æ•ˆæœ**ï¼š
- âœ… RLS ç­–ç•¥è‡ªåŠ¨è¿‡æ»¤ç§Ÿæˆ·æ•°æ®
- âœ… åªèƒ½æŸ¥è¯¢è‡ªå·±ç§Ÿæˆ·çš„åˆ†é…å…³ç³»

### âŒ éœ€è¦ä¿®å¤çš„åŠŸèƒ½

#### é—®é¢˜ 1ï¼šåˆ›å»ºè€ƒå‹¤è§„åˆ™ç¼ºå°‘ boss_id

**å‡½æ•°**ï¼š`createAttendanceRule`  
**å½“å‰ä»£ç **ï¼š
```typescript
export async function createAttendanceRule(input: AttendanceRuleInput): Promise<AttendanceRule | null> {
  const {data, error} = await supabase
    .from('attendance_rules')
    .insert({
      warehouse_id: input.warehouse_id,
      work_start_time: input.work_start_time,
      work_end_time: input.work_end_time,
      late_threshold: input.late_threshold || 15,
      early_threshold: input.early_threshold || 15,
      is_active: input.is_active !== undefined ? input.is_active : true
      // âŒ ç¼ºå°‘ boss_id å’Œ tenant_id
    })
    .select()
    .maybeSingle()

  // ...
}
```

**é—®é¢˜**ï¼š
- âŒ æ’å…¥æ—¶æ²¡æœ‰æ·»åŠ  `boss_id` å­—æ®µ
- âŒ RLS ç­–ç•¥çš„ `WITH CHECK` æ¡ä»¶è¦æ±‚ `boss_id = get_current_user_boss_id()`
- âŒ ä¼šå¯¼è‡´åˆ›å»ºè€ƒå‹¤è§„åˆ™å¤±è´¥

**RLS ç­–ç•¥**ï¼š
```sql
CREATE POLICY "Super admin can manage tenant attendance rules" ON attendance_rules
  FOR ALL TO authenticated
  USING ((boss_id = get_current_user_boss_id()) AND is_super_admin(auth.uid()))
  WITH CHECK ((boss_id = get_current_user_boss_id()) AND is_super_admin(auth.uid()));
```

**å½±å“**ï¼š
- è€æ¿è´¦å·æ— æ³•åˆ›å»ºè€ƒå‹¤è§„åˆ™
- è½¦é˜Ÿé•¿è´¦å·æ— æ³•åˆ›å»ºè€ƒå‹¤è§„åˆ™

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤ï¼šä¿®æ”¹ createAttendanceRule å‡½æ•°

**ä¿®æ”¹æ–‡ä»¶**ï¼š`src/db/api.ts`

**ä¿®å¤åçš„ä»£ç **ï¼š
```typescript
export async function createAttendanceRule(input: AttendanceRuleInput): Promise<AttendanceRule | null> {
  // 1. è·å–å½“å‰ç”¨æˆ·
  const {
    data: {user}
  } = await supabase.auth.getUser()

  if (!user) {
    console.error('åˆ›å»ºè€ƒå‹¤è§„åˆ™å¤±è´¥: ç”¨æˆ·æœªç™»å½•')
    throw new Error('ç”¨æˆ·æœªç™»å½•')
  }

  // 2. è·å–å½“å‰ç”¨æˆ·çš„ boss_id
  const {data: profile} = await supabase
    .from('profiles')
    .select('boss_id')
    .eq('id', user.id)
    .maybeSingle()

  if (!profile?.boss_id) {
    console.error('åˆ›å»ºè€ƒå‹¤è§„åˆ™å¤±è´¥: æ— æ³•è·å– boss_id')
    throw new Error('æ— æ³•è·å–ç”¨æˆ·ä¿¡æ¯')
  }

  // 3. æ’å…¥è€ƒå‹¤è§„åˆ™ï¼ˆè‡ªåŠ¨æ·»åŠ  boss_id å’Œ tenant_idï¼‰
  const {data, error} = await supabase
    .from('attendance_rules')
    .insert({
      warehouse_id: input.warehouse_id,
      work_start_time: input.work_start_time,
      work_end_time: input.work_end_time,
      late_threshold: input.late_threshold || 15,
      early_threshold: input.early_threshold || 15,
      is_active: input.is_active !== undefined ? input.is_active : true,
      boss_id: profile.boss_id,
      tenant_id: profile.boss_id // tenant_id ä¸ boss_id ç›¸åŒ
    })
    .select()
    .maybeSingle()

  if (error) {
    console.error('åˆ›å»ºè€ƒå‹¤è§„åˆ™å¤±è´¥:', error)
    throw new Error('åˆ›å»ºè€ƒå‹¤è§„åˆ™å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•')
  }

  return data
}
```

## ğŸ“Š å¤šç§Ÿæˆ·æ¶æ„éªŒè¯

### æ•°æ®éš”ç¦»ä¿è¯

#### 1. ä»“åº“æ•°æ®éš”ç¦»
```typescript
// ç§Ÿæˆ· A çš„è€æ¿ç™»å½•
const warehouses = await getAllWarehouses()
// âœ… åªè¿”å›ç§Ÿæˆ· A çš„ä»“åº“

// ç§Ÿæˆ· B çš„è€æ¿ç™»å½•
const warehouses = await getAllWarehouses()
// âœ… åªè¿”å›ç§Ÿæˆ· B çš„ä»“åº“
```

#### 2. è€ƒå‹¤è§„åˆ™æ•°æ®éš”ç¦»
```typescript
// ç§Ÿæˆ· A çš„è€æ¿ç™»å½•
const rules = await getAllAttendanceRules()
// âœ… åªè¿”å›ç§Ÿæˆ· A çš„è€ƒå‹¤è§„åˆ™

// ç§Ÿæˆ· B çš„è€æ¿ç™»å½•
const rules = await getAllAttendanceRules()
// âœ… åªè¿”å›ç§Ÿæˆ· B çš„è€ƒå‹¤è§„åˆ™
```

#### 3. ä»“åº“åˆ†é…æ•°æ®éš”ç¦»
```typescript
// ç§Ÿæˆ· A çš„è€æ¿ç™»å½•
const assignments = await getAllDriverWarehouses()
// âœ… åªè¿”å›ç§Ÿæˆ· A çš„å¸æœºä»“åº“åˆ†é…

// ç§Ÿæˆ· B çš„è€æ¿ç™»å½•
const assignments = await getAllDriverWarehouses()
// âœ… åªè¿”å›ç§Ÿæˆ· B çš„å¸æœºä»“åº“åˆ†é…
```

### RLS ç­–ç•¥å·¥ä½œåŸç†

```
ç”¨æˆ·è¯·æ±‚ â†’ Supabase Client â†’ Supabase Server
                                    â†“
                            åº”ç”¨ RLS ç­–ç•¥
                                    â†“
                            è¿‡æ»¤ boss_id
                                    â†“
                            è¿”å›ç§Ÿæˆ·æ•°æ®
```

**å…³é”®ç‚¹**ï¼š
1. RLS ç­–ç•¥åœ¨æ•°æ®åº“å±‚é¢æ‰§è¡Œï¼Œæ— æ³•ç»•è¿‡
2. å³ä½¿åº”ç”¨å±‚ä»£ç æœ‰æ¼æ´ï¼Œæ•°æ®åº“ä¹Ÿä¼šç¡®ä¿ç§Ÿæˆ·éš”ç¦»
3. æ‰€æœ‰æŸ¥è¯¢éƒ½ä¼šè‡ªåŠ¨æ·»åŠ  `WHERE boss_id = get_current_user_boss_id()` æ¡ä»¶
4. æ‰€æœ‰æ’å…¥éƒ½ä¼šæ£€æŸ¥ `boss_id = get_current_user_boss_id()` æ¡ä»¶

## ğŸ“ˆ æ£€æŸ¥æ€»ç»“

### å·²æ£€æŸ¥çš„è¡¨

| è¡¨å | boss_id å­—æ®µ | RLS ç­–ç•¥ | åˆ›å»ºå‡½æ•° | æŸ¥è¯¢å‡½æ•° | æ›´æ–°å‡½æ•° | åˆ é™¤å‡½æ•° |
|------|-------------|---------|---------|---------|---------|---------|
| warehouses | âœ… | âœ… | âœ… å·²ä¿®å¤ | âœ… | âœ… | âœ… |
| attendance_rules | âœ… | âœ… | âŒ éœ€ä¿®å¤ | âœ… | âœ… | âœ… |
| driver_warehouses | âœ… | âœ… | âœ… å·²ä¿®å¤ | âœ… | âœ… | âœ… |
| manager_warehouses | âœ… | âœ… | âœ… | âœ… | âœ… | âœ… |

### å·²æ£€æŸ¥çš„åŠŸèƒ½æ¨¡å—

| åŠŸèƒ½æ¨¡å— | çŠ¶æ€ | è¯´æ˜ |
|---------|------|------|
| ä»“åº“ CRUD | âœ… | åˆ›å»ºã€æŸ¥è¯¢ã€æ›´æ–°ã€åˆ é™¤éƒ½å·²æ­£ç¡®é€‚é… |
| å¸æœºä»“åº“åˆ†é… | âœ… | åˆ›å»ºã€æŸ¥è¯¢ã€æ›´æ–°ã€åˆ é™¤éƒ½å·²æ­£ç¡®é€‚é… |
| è½¦é˜Ÿé•¿ä»“åº“åˆ†é… | âœ… | åˆ›å»ºã€æŸ¥è¯¢ã€æ›´æ–°ã€åˆ é™¤éƒ½å·²æ­£ç¡®é€‚é… |
| è€ƒå‹¤è§„åˆ™ CRUD | âŒ | åˆ›å»ºå‡½æ•°éœ€è¦ä¿®å¤ï¼Œå…¶ä»–å·²æ­£ç¡®é€‚é… |
| ä»“åº“ç»Ÿè®¡ | âœ… | ä¾èµ– RLS ç­–ç•¥ï¼Œè‡ªåŠ¨éš”ç¦» |
| ä»“åº“è®¾ç½® | âœ… | ä¾èµ– RLS ç­–ç•¥ï¼Œè‡ªåŠ¨éš”ç¦» |

### éœ€è¦ä¿®å¤çš„é—®é¢˜

1. **é«˜ä¼˜å…ˆçº§**ï¼š
   - âŒ `createAttendanceRule` å‡½æ•°ç¼ºå°‘ `boss_id` å’Œ `tenant_id`

2. **ä½ä¼˜å…ˆçº§**ï¼š
   - æ— 

### ä¿®å¤åçš„æ•ˆæœ

- âœ… æ‰€æœ‰ä»“åº“ç®¡ç†åŠŸèƒ½éƒ½æ­£ç¡®é€‚é…å¤šç§Ÿæˆ·æ¶æ„
- âœ… æ¯ä¸ªç§Ÿæˆ·çš„æ•°æ®å®Œå…¨éš”ç¦»
- âœ… æ— æ³•è·¨ç§Ÿæˆ·è®¿é—®æˆ–æ“ä½œæ•°æ®
- âœ… æ•°æ®åº“å±‚é¢å’Œåº”ç”¨å±‚é¢åŒé‡ä¿æŠ¤

## ğŸ§ª æµ‹è¯•å»ºè®®

### æµ‹è¯•åœºæ™¯ 1ï¼šåˆ›å»ºè€ƒå‹¤è§„åˆ™
1. ä½¿ç”¨ç§Ÿæˆ· A çš„è€æ¿è´¦å·ç™»å½•
2. è¿›å…¥ä»“åº“ç®¡ç†é¡µé¢
3. ä¸ºæŸä¸ªä»“åº“åˆ›å»ºè€ƒå‹¤è§„åˆ™
4. **é¢„æœŸç»“æœ**ï¼šâœ… åˆ›å»ºæˆåŠŸï¼Œä¸ä¼šå‡ºç°æƒé™é”™è¯¯

### æµ‹è¯•åœºæ™¯ 2ï¼šéªŒè¯è€ƒå‹¤è§„åˆ™éš”ç¦»
1. ä½¿ç”¨ç§Ÿæˆ· A çš„è€æ¿è´¦å·ç™»å½•
2. åˆ›å»ºè€ƒå‹¤è§„åˆ™
3. é€€å‡ºç™»å½•
4. ä½¿ç”¨ç§Ÿæˆ· B çš„è€æ¿è´¦å·ç™»å½•
5. æŸ¥è¯¢è€ƒå‹¤è§„åˆ™åˆ—è¡¨
6. **é¢„æœŸç»“æœ**ï¼šâœ… çœ‹ä¸åˆ°ç§Ÿæˆ· A çš„è€ƒå‹¤è§„åˆ™

### æµ‹è¯•åœºæ™¯ 3ï¼šéªŒè¯è·¨ç§Ÿæˆ·æ“ä½œè¢«é˜»æ­¢
1. ä½¿ç”¨ç§Ÿæˆ· A çš„è€æ¿è´¦å·ç™»å½•
2. è·å–ç§Ÿæˆ· B çš„æŸä¸ªè€ƒå‹¤è§„åˆ™ ID
3. å°è¯•æ›´æ–°è¯¥è€ƒå‹¤è§„åˆ™
4. **é¢„æœŸç»“æœ**ï¼šâœ… æ›´æ–°å¤±è´¥ï¼ŒRLS ç­–ç•¥é˜»æ­¢æ“ä½œ

## ğŸ“ æŠ€æœ¯ç»†èŠ‚

### æ•°æ®åº“è¡¨ç»“æ„

#### warehouses è¡¨
```sql
CREATE TABLE warehouses (
  id uuid PRIMARY KEY,
  name text NOT NULL,
  is_active boolean DEFAULT true,
  boss_id text NOT NULL,      -- ç§Ÿæˆ· ID
  tenant_id uuid,              -- ç§Ÿæˆ· IDï¼ˆä¸ boss_id ç›¸åŒï¼‰
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);
```

#### attendance_rules è¡¨
```sql
CREATE TABLE attendance_rules (
  id uuid PRIMARY KEY,
  warehouse_id uuid NOT NULL REFERENCES warehouses(id),
  work_start_time time NOT NULL,
  work_end_time time NOT NULL,
  late_threshold integer NOT NULL,
  early_threshold integer NOT NULL,
  require_clock_out boolean NOT NULL,
  is_active boolean NOT NULL,
  boss_id text NOT NULL,      -- ç§Ÿæˆ· ID
  tenant_id uuid,              -- ç§Ÿæˆ· IDï¼ˆä¸ boss_id ç›¸åŒï¼‰
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);
```

#### driver_warehouses è¡¨
```sql
CREATE TABLE driver_warehouses (
  id uuid PRIMARY KEY,
  driver_id uuid NOT NULL REFERENCES profiles(id),
  warehouse_id uuid NOT NULL REFERENCES warehouses(id),
  boss_id text NOT NULL,      -- ç§Ÿæˆ· ID
  tenant_id uuid,              -- ç§Ÿæˆ· IDï¼ˆä¸ boss_id ç›¸åŒï¼‰
  created_at timestamptz DEFAULT now()
);
```

### RLS ç­–ç•¥

#### warehouses è¡¨ç­–ç•¥
```sql
-- è€æ¿è´¦å·å¯ä»¥ç®¡ç†è‡ªå·±ç§Ÿæˆ·çš„ä»“åº“
CREATE POLICY "Super admin can manage tenant warehouses" ON warehouses
  FOR ALL TO authenticated
  USING ((boss_id = get_current_user_boss_id()) AND is_super_admin(auth.uid()))
  WITH CHECK ((boss_id = get_current_user_boss_id()) AND is_super_admin(auth.uid()));
```

#### attendance_rules è¡¨ç­–ç•¥
```sql
-- è€æ¿è´¦å·å¯ä»¥ç®¡ç†è‡ªå·±ç§Ÿæˆ·çš„è€ƒå‹¤è§„åˆ™
CREATE POLICY "Super admin can manage tenant attendance rules" ON attendance_rules
  FOR ALL TO authenticated
  USING ((boss_id = get_current_user_boss_id()) AND is_super_admin(auth.uid()))
  WITH CHECK ((boss_id = get_current_user_boss_id()) AND is_super_admin(auth.uid()));

-- æ‰€æœ‰ç”¨æˆ·å¯ä»¥æŸ¥çœ‹è‡ªå·±ç§Ÿæˆ·çš„è€ƒå‹¤è§„åˆ™
CREATE POLICY "Users can view tenant attendance rules" ON attendance_rules
  FOR SELECT TO authenticated
  USING (boss_id = get_current_user_boss_id());
```

#### driver_warehouses è¡¨ç­–ç•¥
```sql
-- è€æ¿è´¦å·å¯ä»¥ç®¡ç†è‡ªå·±ç§Ÿæˆ·çš„å¸æœºä»“åº“åˆ†é…
CREATE POLICY "Super admin can manage tenant driver warehouses" ON driver_warehouses
  FOR ALL TO authenticated
  USING ((boss_id = get_current_user_boss_id()) AND is_super_admin(auth.uid()))
  WITH CHECK ((boss_id = get_current_user_boss_id()) AND is_super_admin(auth.uid()));
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. boss_id çš„è·å–
- æ‰€æœ‰åˆ›å»ºå‡½æ•°éƒ½ä¼šè‡ªåŠ¨ä»å½“å‰ç™»å½•ç”¨æˆ·çš„ profile ä¸­è·å– `boss_id`
- å¦‚æœç”¨æˆ·æœªç™»å½•æˆ–æ— æ³•è·å– `boss_id`ï¼Œåˆ›å»ºä¼šå¤±è´¥å¹¶æŠ›å‡ºå¼‚å¸¸

### 2. tenant_id çš„è®¾ç½®
- `tenant_id` å­—æ®µè®¾ç½®ä¸ºä¸ `boss_id` ç›¸åŒçš„å€¼
- è¿™æ˜¯å› ä¸ºåœ¨å½“å‰ç³»ç»Ÿä¸­ï¼Œç§Ÿæˆ· ID å°±æ˜¯è€æ¿çš„ ID

### 3. RLS ç­–ç•¥çš„ä½œç”¨
- RLS ç­–ç•¥åœ¨æ•°æ®åº“å±‚é¢æ‰§è¡Œï¼Œæ— æ³•ç»•è¿‡
- å³ä½¿åº”ç”¨å±‚ä»£ç æœ‰æ¼æ´ï¼Œæ•°æ®åº“ä¹Ÿä¼šç¡®ä¿ç§Ÿæˆ·éš”ç¦»
- æ‰€æœ‰æŸ¥è¯¢éƒ½ä¼šè‡ªåŠ¨æ·»åŠ  `WHERE boss_id = get_current_user_boss_id()` æ¡ä»¶

### 4. å¤–é”®å…³è”
- `attendance_rules.warehouse_id` å¼•ç”¨ `warehouses.id`
- ç”±äºä¸¤ä¸ªè¡¨éƒ½æœ‰ `boss_id` è¿‡æ»¤ï¼Œè€ƒå‹¤è§„åˆ™åªèƒ½å…³è”åˆ°åŒä¸€ç§Ÿæˆ·çš„ä»“åº“
- è¿™ç¡®ä¿äº†æ•°æ®çš„ä¸€è‡´æ€§å’Œéš”ç¦»æ€§

## ğŸ“ˆ ä¿®å¤è¿›åº¦

- [x] æ£€æŸ¥ä»“åº“ CRUD åŠŸèƒ½ - âœ… å·²å®Œæˆ
- [x] æ£€æŸ¥ä»“åº“åˆ†é…åŠŸèƒ½ - âœ… å·²å®Œæˆ
- [x] æ£€æŸ¥è€ƒå‹¤è§„åˆ™åŠŸèƒ½ - âœ… å‘ç°é—®é¢˜
- [ ] ä¿®å¤ createAttendanceRule å‡½æ•° - â³ å¾…ä¿®å¤
- [ ] æµ‹è¯•éªŒè¯ - â³ å¾…æµ‹è¯•

---

**æ£€æŸ¥æ—¥æœŸ**ï¼š2025-11-26  
**æ£€æŸ¥äººå‘˜**ï¼šç§’å“’ AI  
**çŠ¶æ€**ï¼šâœ… æ£€æŸ¥å®Œæˆï¼Œå‘ç° 1 ä¸ªéœ€è¦ä¿®å¤çš„é—®é¢˜

## ğŸ¯ æ€»ç»“

### æ ¸å¿ƒå‘ç°
1. âœ… ä»“åº“ç®¡ç†çš„å¤§éƒ¨åˆ†åŠŸèƒ½å·²æ­£ç¡®é€‚é…å¤šç§Ÿæˆ·æ¶æ„
2. âœ… RLS ç­–ç•¥å·²æ­£ç¡®å®ç°ï¼Œç¡®ä¿æ•°æ®åº“å±‚é¢çš„ç§Ÿæˆ·éš”ç¦»
3. âŒ åˆ›å»ºè€ƒå‹¤è§„åˆ™å‡½æ•°éœ€è¦ä¿®å¤ï¼Œç¼ºå°‘ `boss_id` å’Œ `tenant_id`

### æ¶æ„ä¿è¯
1. âœ… æ•°æ®åº“å±‚é¢ï¼šRLS ç­–ç•¥ç¡®ä¿ç§Ÿæˆ·éš”ç¦»
2. âœ… åº”ç”¨å±‚é¢ï¼šåˆ›å»ºå‡½æ•°è‡ªåŠ¨æ·»åŠ ç§Ÿæˆ·æ ‡è¯†å­—æ®µ
3. âœ… åŒé‡ä¿æŠ¤ï¼šå³ä½¿åº”ç”¨å±‚æœ‰æ¼æ´ï¼Œæ•°æ®åº“ä¹Ÿä¼šé˜»æ­¢è·¨ç§Ÿæˆ·è®¿é—®

### ä¿®å¤å»ºè®®
1. **ç«‹å³ä¿®å¤**ï¼š`createAttendanceRule` å‡½æ•°
2. **æµ‹è¯•éªŒè¯**ï¼šä¿®å¤åè¿›è¡Œå…¨é¢æµ‹è¯•
3. **æ–‡æ¡£æ›´æ–°**ï¼šæ›´æ–°ç›¸å…³æ–‡æ¡£

### ä¿®å¤åçš„æ•ˆæœ
- âœ… æ‰€æœ‰ä»“åº“ç®¡ç†åŠŸèƒ½éƒ½æ­£ç¡®é€‚é…å¤šç§Ÿæˆ·æ¶æ„
- âœ… æ¯ä¸ªç§Ÿæˆ·çš„æ•°æ®å®Œå…¨éš”ç¦»
- âœ… æ— æ³•è·¨ç§Ÿæˆ·è®¿é—®æˆ–æ“ä½œæ•°æ®
- âœ… è€æ¿è´¦å·å¯ä»¥æ­£å¸¸åˆ›å»ºè€ƒå‹¤è§„åˆ™
- âœ… è½¦é˜Ÿé•¿è´¦å·å¯ä»¥æ­£å¸¸åˆ›å»ºè€ƒå‹¤è§„åˆ™ï¼ˆå¦‚æœæœ‰æƒé™ï¼‰
