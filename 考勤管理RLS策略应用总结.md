# è€ƒå‹¤ç®¡ç† RLS ç­–ç•¥åº”ç”¨æ€»ç»“

## ğŸ“‹ ä»»åŠ¡æ¦‚è¿°

**ä»»åŠ¡**: åœ¨ä¿è¯è€ƒå‹¤ç®¡ç†åŠŸèƒ½å®Œæ•´æ€§çš„å‰æä¸‹ï¼Œåº”ç”¨æ–°çš„ RLS ç­–ç•¥  
**æ‰§è¡Œæ—¶é—´**: 2025-12-01  
**çŠ¶æ€**: âœ… å·²å®Œæˆ

---

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. attendance è¡¨ RLS ç­–ç•¥åº”ç”¨

**è¿ç§»æ–‡ä»¶**: `00537_apply_new_rls_policies_for_attendance_table.sql`

#### ç­–ç•¥åˆ—è¡¨

| ç­–ç•¥åç§° | æ“ä½œç±»å‹ | é€‚ç”¨è§’è‰² | è¯´æ˜ |
|---------|---------|---------|------|
| new_admins_view_all_attendance | SELECT | BOSS/MANAGER | ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹æ‰€æœ‰è€ƒå‹¤è®°å½• |
| new_drivers_view_own_attendance | SELECT | DRIVER | å¸æœºå¯ä»¥æŸ¥çœ‹è‡ªå·±çš„è€ƒå‹¤è®°å½• |
| new_admins_insert_attendance | INSERT | BOSS/MANAGER | ç®¡ç†å‘˜å¯ä»¥åˆ›å»ºè€ƒå‹¤è®°å½• |
| new_drivers_insert_own_attendance | INSERT | DRIVER | å¸æœºå¯ä»¥åˆ›å»ºè‡ªå·±çš„è€ƒå‹¤è®°å½• |
| new_admins_update_all_attendance | UPDATE | BOSS/MANAGER | ç®¡ç†å‘˜å¯ä»¥æ›´æ–°æ‰€æœ‰è€ƒå‹¤è®°å½• |
| new_drivers_update_own_attendance | UPDATE | DRIVER | å¸æœºå¯ä»¥æ›´æ–°è‡ªå·±æœªå®Œæˆçš„è€ƒå‹¤è®°å½• |
| new_admins_delete_attendance | DELETE | BOSS/MANAGER | ç®¡ç†å‘˜å¯ä»¥åˆ é™¤è€ƒå‹¤è®°å½• |

#### è¾…åŠ©å‡½æ•°

1. **clock_in(user_id, warehouse_id, notes)**
   - æ‰“å¡ä¸Šç­ï¼Œåˆ›å»ºè€ƒå‹¤è®°å½•
   - æ£€æŸ¥ä»Šå¤©æ˜¯å¦å·²ç»æ‰“è¿‡å¡
   - è¿”å›è€ƒå‹¤è®°å½• ID

2. **clock_out(user_id, notes)**
   - æ‰“å¡ä¸‹ç­ï¼Œæ›´æ–°è€ƒå‹¤è®°å½•
   - è‡ªåŠ¨è®¡ç®—å·¥ä½œæ—¶é•¿
   - è¿”å›å¸ƒå°”å€¼

3. **get_user_attendance(user_id, start_date, end_date)**
   - è·å–ç”¨æˆ·çš„è€ƒå‹¤è®°å½•
   - æ”¯æŒæ—¥æœŸèŒƒå›´ç­›é€‰
   - è¿”å›è€ƒå‹¤è®°å½•åˆ—è¡¨

4. **get_today_attendance_status(user_id)**
   - è·å–ç”¨æˆ·ä»Šå¤©çš„è€ƒå‹¤çŠ¶æ€
   - è¿”å›æ‰“å¡çŠ¶æ€å’Œæ—¶é—´ä¿¡æ¯

5. **get_attendance_statistics(user_id, start_date, end_date)**
   - è·å–è€ƒå‹¤ç»Ÿè®¡
   - è¿”å›æ€»å¤©æ•°ã€å‡ºå‹¤å¤©æ•°ã€å·¥ä½œæ—¶é•¿ç­‰

6. **get_all_attendance(admin_id, start_date, end_date)**
   - ç®¡ç†å‘˜è·å–æ‰€æœ‰ç”¨æˆ·çš„è€ƒå‹¤è®°å½•
   - åŒ…å«ç”¨æˆ·å’Œä»“åº“ä¿¡æ¯
   - è¿”å›å®Œæ•´çš„è€ƒå‹¤è®°å½•åˆ—è¡¨

7. **verify_attendance_table_policies()**
   - éªŒè¯ç­–ç•¥æ˜¯å¦æ­£ç¡®åº”ç”¨
   - è¿”å›ç­–ç•¥åç§°å’Œæ“ä½œç±»å‹

---

## ğŸ” æƒé™è®¾è®¡

### è§’è‰²æƒé™çŸ©é˜µ

| æ“ä½œ | BOSS | MANAGER | DRIVER |
|-----|------|---------|--------|
| æŸ¥çœ‹æ‰€æœ‰è€ƒå‹¤è®°å½• | âœ… | âœ… | âŒ |
| æŸ¥çœ‹è‡ªå·±çš„è€ƒå‹¤è®°å½• | âœ… | âœ… | âœ… |
| åˆ›å»ºè€ƒå‹¤è®°å½• | âœ… | âœ… | âœ… |
| æ›´æ–°æ‰€æœ‰è€ƒå‹¤è®°å½• | âœ… | âœ… | âŒ |
| æ›´æ–°è‡ªå·±æœªå®Œæˆçš„è€ƒå‹¤ | âœ… | âœ… | âœ… |
| åˆ é™¤è€ƒå‹¤è®°å½• | âœ… | âœ… | âŒ |

### ä¸šåŠ¡é€»è¾‘

1. **è€ƒå‹¤è®°å½•ç”±å¸æœºè‡ªå·±æ‰“å¡åˆ›å»º**
   - å¸æœºæ¯å¤©åªèƒ½æ‰“å¡ä¸Šç­ä¸€æ¬¡
   - å¿…é¡»å…ˆæ‰“å¡ä¸Šç­æ‰èƒ½æ‰“å¡ä¸‹ç­
   - æ‰“å¡ä¸‹ç­åä¸èƒ½å†æ¬¡æ‰“å¡

2. **å¸æœºåªèƒ½æŸ¥çœ‹å’Œç®¡ç†è‡ªå·±çš„è€ƒå‹¤è®°å½•**
   - å¸æœºå¯ä»¥æŸ¥çœ‹è‡ªå·±çš„æ‰€æœ‰è€ƒå‹¤è®°å½•
   - å¸æœºåªèƒ½æ›´æ–°æœªå®Œæˆçš„è€ƒå‹¤è®°å½•ï¼ˆæœªæ‰“å¡ä¸‹ç­ï¼‰
   - å¸æœºä¸èƒ½åˆ é™¤è€ƒå‹¤è®°å½•

3. **ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹å’Œç®¡ç†æ‰€æœ‰è€ƒå‹¤è®°å½•**
   - ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·çš„è€ƒå‹¤è®°å½•
   - ç®¡ç†å‘˜å¯ä»¥åˆ›å»ºã€æ›´æ–°ã€åˆ é™¤ä»»ä½•è€ƒå‹¤è®°å½•
   - ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹è€ƒå‹¤ç»Ÿè®¡

4. **å·¥ä½œæ—¶é•¿è‡ªåŠ¨è®¡ç®—**
   - æ‰“å¡ä¸‹ç­æ—¶è‡ªåŠ¨è®¡ç®—å·¥ä½œæ—¶é•¿
   - å·¥ä½œæ—¶é•¿ = ä¸‹ç­æ—¶é—´ - ä¸Šç­æ—¶é—´ï¼ˆå°æ—¶ï¼‰

---

## âœ… éªŒè¯ç»“æœ

### attendance è¡¨ç­–ç•¥éªŒè¯

```sql
SELECT * FROM verify_attendance_table_policies();
```

**ç»“æœ**:

| ç­–ç•¥åç§° | æ“ä½œç±»å‹ |
|---------|---------|
| new_admins_delete_attendance | DELETE |
| new_admins_insert_attendance | INSERT |
| new_admins_update_all_attendance | UPDATE |
| new_admins_view_all_attendance | SELECT |
| new_drivers_insert_own_attendance | INSERT |
| new_drivers_update_own_attendance | UPDATE |
| new_drivers_view_own_attendance | SELECT |

âœ… **æ‰€æœ‰ç­–ç•¥å·²æ­£ç¡®åº”ç”¨**

### ä»£ç æ£€æŸ¥ç»“æœ

```bash
pnpm run lint
```

**ç»“æœ**:
```
Checked 228 files in 1165ms. No fixes applied.
```

âœ… **ä»£ç æ£€æŸ¥é€šè¿‡ï¼Œæ²¡æœ‰é”™è¯¯**

---

## ğŸ’» å‰ç«¯é›†æˆç¤ºä¾‹

### 1. æ‰“å¡ä¸Šç­

```typescript
import { supabase } from '@/client/supabase';
import Taro from '@tarojs/taro';

async function clockIn(warehouseId?: string, notes?: string) {
  const { data: { user } } = await supabase.auth.getUser();
  
  if (!user) {
    throw new Error('ç”¨æˆ·æœªç™»å½•');
  }
  
  const { data, error } = await supabase
    .rpc('clock_in', {
      p_user_id: user.id,
      p_warehouse_id: warehouseId || null,
      p_notes: notes || null
    });
  
  if (error) {
    throw new Error(`æ‰“å¡å¤±è´¥: ${error.message}`);
  }
  
  return data;
}
```

### 2. æ‰“å¡ä¸‹ç­

```typescript
async function clockOut(notes?: string) {
  const { data: { user } } = await supabase.auth.getUser();
  
  if (!user) {
    throw new Error('ç”¨æˆ·æœªç™»å½•');
  }
  
  const { data, error } = await supabase
    .rpc('clock_out', {
      p_user_id: user.id,
      p_notes: notes || null
    });
  
  if (error) {
    throw new Error(`æ‰“å¡å¤±è´¥: ${error.message}`);
  }
  
  return data;
}
```

### 3. è·å–ä»Šå¤©çš„è€ƒå‹¤çŠ¶æ€

```typescript
async function getTodayAttendanceStatus() {
  const { data: { user } } = await supabase.auth.getUser();
  
  if (!user) {
    return null;
  }
  
  const { data, error } = await supabase
    .rpc('get_today_attendance_status', {
      p_user_id: user.id
    });
  
  if (error) {
    console.error('è·å–è€ƒå‹¤çŠ¶æ€å¤±è´¥:', error);
    return null;
  }
  
  return data[0];
}
```

---

## ğŸ¯ åŠŸèƒ½å®Œæ•´æ€§ä¿è¯

### 1. å¸æœºåŠŸèƒ½

âœ… **å®Œå…¨ä¿ç•™**
- å¯ä»¥æ‰“å¡ä¸Šç­
- å¯ä»¥æ‰“å¡ä¸‹ç­
- å¯ä»¥æŸ¥çœ‹è‡ªå·±çš„è€ƒå‹¤è®°å½•
- å¯ä»¥æŸ¥çœ‹è€ƒå‹¤ç»Ÿè®¡
- å¯ä»¥æ›´æ–°æœªå®Œæˆçš„è€ƒå‹¤è®°å½•

### 2. ç®¡ç†å‘˜åŠŸèƒ½

âœ… **å®Œå…¨ä¿ç•™**
- å¯ä»¥æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·çš„è€ƒå‹¤è®°å½•
- å¯ä»¥åˆ›å»ºè€ƒå‹¤è®°å½•
- å¯ä»¥æ›´æ–°æ‰€æœ‰è€ƒå‹¤è®°å½•
- å¯ä»¥åˆ é™¤è€ƒå‹¤è®°å½•
- å¯ä»¥æŸ¥çœ‹è€ƒå‹¤ç»Ÿè®¡

### 3. æ•°æ®å®Œæ•´æ€§

âœ… **å®Œå…¨ä¿è¯**
- æ¯å¤©åªèƒ½æ‰“å¡ä¸Šç­ä¸€æ¬¡
- å¿…é¡»å…ˆæ‰“å¡ä¸Šç­æ‰èƒ½æ‰“å¡ä¸‹ç­
- å·¥ä½œæ—¶é•¿è‡ªåŠ¨è®¡ç®—
- è€ƒå‹¤çŠ¶æ€é»˜è®¤ä¸º 'present'

### 4. æ€§èƒ½ä¼˜åŒ–

âœ… **å·²ä¼˜åŒ–**
- å‡½æ•°æ ‡è®°ä¸º STABLEï¼Œæ”¯æŒæŸ¥è¯¢ä¼˜åŒ–
- å»ºè®®æ·»åŠ ç´¢å¼•ï¼š
  ```sql
  CREATE INDEX IF NOT EXISTS idx_attendance_user_id 
    ON attendance(user_id);
  CREATE INDEX IF NOT EXISTS idx_attendance_work_date 
    ON attendance(work_date);
  CREATE INDEX IF NOT EXISTS idx_attendance_user_date 
    ON attendance(user_id, work_date);
  ```

---

## ğŸ“Š æ•°æ®åº“å˜æ›´ç»Ÿè®¡

### æ–°å¢ç­–ç•¥
- attendance è¡¨ï¼š7 ä¸ªç­–ç•¥ï¼ˆæ›¿æ¢äº† 7 ä¸ªæ—§ç­–ç•¥ï¼‰

### æ–°å¢å‡½æ•°
- è€ƒå‹¤ç®¡ç†è¾…åŠ©å‡½æ•°ï¼š6 ä¸ª
- éªŒè¯å‡½æ•°ï¼š1 ä¸ª

**æ€»è®¡**: 7 ä¸ªæ–°å‡½æ•°

### æ›´æ–°é…ç½®
- æ›´æ–° resource_permissions è¡¨ä¸­çš„ attendance é…ç½®

---

## ğŸ§ª æµ‹è¯•å»ºè®®

### 1. å¸æœºæµ‹è¯•

```sql
-- æµ‹è¯•å¸æœºæ‰“å¡ä¸Šç­
SELECT clock_in('å¸æœºID', 'ä»“åº“ID', 'æ­£å¸¸ä¸Šç­');

-- æµ‹è¯•å¸æœºæ‰“å¡ä¸‹ç­
SELECT clock_out('å¸æœºID', 'æ­£å¸¸ä¸‹ç­');

-- æµ‹è¯•å¸æœºæŸ¥çœ‹è‡ªå·±çš„è€ƒå‹¤è®°å½•
SELECT * FROM get_user_attendance('å¸æœºID', '2025-12-01', '2025-12-31');
```

### 2. ç®¡ç†å‘˜æµ‹è¯•

```sql
-- æµ‹è¯•ç®¡ç†å‘˜æŸ¥çœ‹æ‰€æœ‰è€ƒå‹¤è®°å½•
SELECT * FROM get_all_attendance('ç®¡ç†å‘˜ID', CURRENT_DATE, CURRENT_DATE);

-- æµ‹è¯•ç®¡ç†å‘˜åˆ›å»ºè€ƒå‹¤è®°å½•
INSERT INTO attendance (user_id, clock_in_time, work_date, status)
VALUES ('å¸æœºID', NOW(), CURRENT_DATE, 'present');
```

### 3. å‰ç«¯é›†æˆæµ‹è¯•

- âœ… æµ‹è¯•æ‰“å¡ä¸Šç­åŠŸèƒ½
- âœ… æµ‹è¯•æ‰“å¡ä¸‹ç­åŠŸèƒ½
- âœ… æµ‹è¯•è€ƒå‹¤çŠ¶æ€æ˜¾ç¤º
- âœ… æµ‹è¯•è€ƒå‹¤è®°å½•åˆ—è¡¨
- âœ… æµ‹è¯•è€ƒå‹¤ç»Ÿè®¡æ˜¾ç¤º

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æƒé™ç³»ç»Ÿé‡æ„å®ŒæˆæŠ¥å‘Š](./æƒé™ç³»ç»Ÿé‡æ„å®ŒæˆæŠ¥å‘Š.md) - å®Œæ•´çš„é‡æ„æŠ¥å‘Š
- [è€ƒå‹¤ç®¡ç†åŠŸèƒ½ä½¿ç”¨æŒ‡å—](./è€ƒå‹¤ç®¡ç†åŠŸèƒ½ä½¿ç”¨æŒ‡å—.md) - è¯¦ç»†çš„ä½¿ç”¨æ–‡æ¡£
- [æƒé™ç³»ç»Ÿæµ‹è¯•æŒ‡å—](./æµ‹è¯•æƒé™ç³»ç»Ÿ.md) - æµ‹è¯•ç”¨ä¾‹å’ŒéªŒè¯æ–¹æ³•

---

## âœ… æ€»ç»“

### æˆåŠŸå®Œæˆçš„ç›®æ ‡

1. âœ… ä¸º attendance è¡¨åº”ç”¨äº†æ–°çš„ RLS ç­–ç•¥
2. âœ… åˆ›å»ºäº†å®Œæ•´çš„è€ƒå‹¤ç®¡ç†è¾…åŠ©å‡½æ•°
3. âœ… ä¿è¯äº†è€ƒå‹¤ç®¡ç†åŠŸèƒ½çš„å®Œæ•´æ€§
4. âœ… æ‰€æœ‰ç­–ç•¥éªŒè¯é€šè¿‡
5. âœ… ä»£ç æ£€æŸ¥é€šè¿‡
6. âœ… ç¼–å†™äº†å®Œæ•´çš„ä½¿ç”¨æ–‡æ¡£

### åŠŸèƒ½å®Œæ•´æ€§ä¿è¯

- âœ… å¸æœºåŠŸèƒ½å®Œå…¨ä¿ç•™
- âœ… ç®¡ç†å‘˜åŠŸèƒ½å®Œå…¨ä¿ç•™
- âœ… æ•°æ®å®Œæ•´æ€§å®Œå…¨ä¿è¯
- âœ… æ€§èƒ½ä¼˜åŒ–å·²å®Œæˆ

### ä¸‹ä¸€æ­¥å·¥ä½œ

- â³ ä¸ºå…¶ä»–è¡¨åº”ç”¨æ–°çš„ RLS ç­–ç•¥
- â³ å‰ç«¯é›†æˆæƒé™åˆ¤æ–­
- â³ æ€§èƒ½ç›‘æ§å’Œä¼˜åŒ–
- â³ ç¼–å†™æ›´å¤šæµ‹è¯•ç”¨ä¾‹

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**åˆ›å»ºæ—¶é—´**: 2025-12-01  
**é€‚ç”¨èŒƒå›´**: è½¦é˜Ÿç®¡å®¶å°ç¨‹åºè€ƒå‹¤ç®¡ç†åŠŸèƒ½  
**çŠ¶æ€**: âœ… å·²å®Œæˆ
