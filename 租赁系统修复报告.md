# 租赁系统 RLS 策略修复报告

## 问题描述

**用户反馈**：租赁系统中的租户信息都不见了

**根本原因**：
租赁系统的 RLS 策略使用了 `EXISTS (SELECT 1 FROM profiles WHERE ...)`，这会导致和用户管理系统同样的**无限递归问题**。

---

## 问题分析

### 受影响的表

1. **leases** - 租赁记录表（15 条记录）
2. **lease_bills** - 租赁账单表（0 条记录）
3. **vehicle_leases** - 车辆租赁表（0 条记录）

### 问题策略示例

```sql
-- 旧策略（会导致无限递归）
CREATE POLICY "Lease admins have full access to leases" ON leases
  FOR ALL TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM profiles
      WHERE profiles.id = auth.uid()
        AND profiles.role = 'lease_admin'
    )
  );
```

**递归链**：
1. 查询 `leases` 表
2. RLS 策略检查权限，需要查询 `profiles` 表
3. 查询 `profiles` 表时，又触发 `profiles` 表的 RLS 策略
4. `profiles` 表的 RLS 策略又需要查询 `profiles` 表
5. 形成无限递归 ❌

---

## 修复方案

### 核心思想

使用已创建的 `get_user_role_and_boss` 函数来避免递归。

### 修复内容

#### 1. leases 表

**修复前的策略**：
- ❌ 使用 `EXISTS (SELECT FROM profiles)` 导致递归

**修复后的策略**：

```sql
-- 策略 1：租赁管理员可以查看所有租赁
CREATE POLICY "Lease admins have full access to leases" ON leases
  FOR ALL TO authenticated
  USING (
    (SELECT r.role FROM get_user_role_and_boss(auth.uid()) r) = 'lease_admin'
  );

-- 策略 2：租户可以查看自己的租赁
CREATE POLICY "Tenants can view their own leases" ON leases
  FOR SELECT TO authenticated
  USING (tenant_id = auth.uid());

-- 策略 3：车队长可以查看同租户的租赁
CREATE POLICY "Managers can view tenant leases" ON leases
  FOR SELECT TO authenticated
  USING (
    (SELECT r.role FROM get_user_role_and_boss(auth.uid()) r) = 'manager'
    AND
    EXISTS (
      SELECT 1 FROM profiles p
      WHERE p.id = leases.tenant_id
        AND p.boss_id = (SELECT b.boss_id FROM get_user_role_and_boss(auth.uid()) b)
    )
  );

-- 策略 4：超级管理员可以查看关联账户的租赁
CREATE POLICY "Super admins can view related leases" ON leases
  FOR SELECT TO authenticated
  USING (
    (SELECT r.role FROM get_user_role_and_boss(auth.uid()) r) = 'super_admin'
    AND
    EXISTS (
      SELECT 1 FROM profiles p1
      JOIN profiles p2 ON p1.main_account_id = p2.id
      WHERE p1.id = auth.uid()
        AND p1.main_account_id IS NOT NULL
        AND p2.tenant_id = leases.tenant_id
    )
  );
```

#### 2. lease_bills 表

**创建辅助函数**：

```sql
CREATE OR REPLACE FUNCTION is_lease_admin_user(user_id uuid)
RETURNS boolean
LANGUAGE sql
SECURITY DEFINER
SET search_path = public
STABLE
AS $$
  SELECT (SELECT r.role FROM get_user_role_and_boss(user_id) r) = 'lease_admin';
$$;
```

**修复后的策略**：

```sql
-- 策略 1：租赁管理员可以查看所有账单
CREATE POLICY "租赁管理员查看所有账单" ON lease_bills
  FOR SELECT TO authenticated
  USING (is_lease_admin_user(auth.uid()));

-- 策略 2：租赁管理员可以创建账单
CREATE POLICY "租赁管理员创建账单" ON lease_bills
  FOR INSERT TO authenticated
  WITH CHECK (is_lease_admin_user(auth.uid()));

-- 策略 3：租赁管理员可以更新账单
CREATE POLICY "租赁管理员更新账单" ON lease_bills
  FOR UPDATE TO authenticated
  USING (is_lease_admin_user(auth.uid()));

-- 策略 4：租赁管理员可以删除账单
CREATE POLICY "租赁管理员删除账单" ON lease_bills
  FOR DELETE TO authenticated
  USING (is_lease_admin_user(auth.uid()));
```

#### 3. vehicle_leases 表

**修复后的策略**：

```sql
-- 策略 1：管理员可以查看所有租赁
CREATE POLICY "管理员查看所有租赁" ON vehicle_leases
  FOR SELECT TO authenticated
  USING (
    (SELECT r.role FROM get_user_role_and_boss(auth.uid()) r) IN ('manager', 'super_admin', 'lease_admin')
  );

-- 策略 2：管理员可以创建租赁记录
CREATE POLICY "管理员创建租赁记录" ON vehicle_leases
  FOR INSERT TO authenticated
  WITH CHECK (
    (SELECT r.role FROM get_user_role_and_boss(auth.uid()) r) IN ('manager', 'super_admin', 'lease_admin')
  );

-- 策略 3：管理员可以更新租赁记录
CREATE POLICY "管理员更新租赁记录" ON vehicle_leases
  FOR UPDATE TO authenticated
  USING (
    (SELECT r.role FROM get_user_role_and_boss(auth.uid()) r) IN ('manager', 'super_admin', 'lease_admin')
  );

-- 策略 4：管理员可以删除租赁记录
CREATE POLICY "管理员删除租赁记录" ON vehicle_leases
  FOR DELETE TO authenticated
  USING (
    (SELECT r.role FROM get_user_role_and_boss(auth.uid()) r) IN ('manager', 'super_admin', 'lease_admin')
  );

-- 策略 5：司机可以查看自己的租赁
CREATE POLICY "司机查看自己的租赁" ON vehicle_leases
  FOR SELECT TO authenticated
  USING (
    driver_id = auth.uid()
    AND
    (SELECT r.role FROM get_user_role_and_boss(auth.uid()) r) = 'driver'
  );
```

---

## 验证结果

### 租赁管理员权限测试

**测试对象**：
- 用户：租赁管理员
- 角色：lease_admin
- Boss ID: BOSS_1764145957063_65425759

**测试结果**：

| 测试项 | 结果 | 说明 |
|-------|------|------|
| get_user_role_and_boss 函数 | ✅ 通过 | 正确返回 lease_admin |
| is_lease_admin_user 函数 | ✅ 通过 | 正确返回 true |
| 查看 leases 表 | ✅ 通过 | 可以查看 15 条租赁记录 |
| 查看 vehicle_leases 表 | ✅ 通过 | 表中无数据（0 条） |
| 查看 lease_bills 表 | ✅ 通过 | 表中无数据（0 条） |

### 租赁记录详情

**leases 表**：15 条记录

最新的 5 条记录：

| 租户 ID | 状态 | 开始日期 | 结束日期 | 创建时间 |
|---------|------|---------|---------|---------|
| 29659703-7b22-40c3-b9c0-b56b05060fa0 | active | 2025-11-25 | 2026-02-25 | 2025-11-26 01:35:15 |
| 75b2aa94-ed8e-4e54-be74-531e6cda332b | active | 2025-11-25 | 2026-05-25 | 2025-11-26 01:35:03 |
| 9e04dfd6-9b18-4e00-992f-bcfb73a86900 | active | 2026-08-25 | 2026-11-25 | 2025-11-26 01:08:51 |
| 9e04dfd6-9b18-4e00-992f-bcfb73a86900 | active | 2026-05-25 | 2026-08-25 | 2025-11-26 01:08:38 |
| 9e04dfd6-9b18-4e00-992f-bcfb73a86900 | active | 2025-11-25 | 2026-02-25 | 2025-11-26 01:01:29 |

---

## 用户操作指南

### 立即执行以下操作

#### 方法 1：直接刷新页面（推荐）

按 `F5` 键或 `Ctrl+R`（Mac: `Cmd+R`）刷新页面

#### 方法 2：清除缓存后刷新

如果方法 1 无效，请在浏览器控制台（按 `F12` 打开）执行：

```javascript
localStorage.clear();
sessionStorage.clear();
location.reload();
```

#### 方法 3：重新登录

如果方法 2 无效，请：
1. 退出登录
2. 重新登录
3. 查看租赁管理页面

---

## 技术细节

### 使用的辅助函数

1. **get_user_role_and_boss(user_id uuid)**
   - 返回用户的 role 和 boss_id
   - 使用 SECURITY DEFINER 避免 RLS 递归
   - 已在 00200 迁移中创建

2. **is_lease_admin_user(user_id uuid)**
   - 检查用户是否为租赁管理员
   - 使用 get_user_role_and_boss 函数
   - 在本次迁移中创建

### 性能优化

- 使用 `STABLE` 标记函数，PostgreSQL 可以缓存函数结果
- 减少了递归查询，提高了查询性能
- 使用 `SECURITY DEFINER` 打破递归链

---

## 迁移文件

**文件名**：`supabase/migrations/00206_fix_lease_system_rls_policies.sql`

**内容**：
- 修复 leases 表的 4 个策略
- 修复 lease_bills 表的 4 个策略
- 修复 vehicle_leases 表的 5 个策略
- 创建 is_lease_admin_user 辅助函数

---

## 总结

### 修复内容

1. ✅ 修复了 leases 表的 RLS 策略
2. ✅ 修复了 lease_bills 表的 RLS 策略
3. ✅ 修复了 vehicle_leases 表的 RLS 策略
4. ✅ 创建了 is_lease_admin_user 辅助函数
5. ✅ 验证了租赁管理员可以正常查询数据

### 影响范围

- **leases 表**：15 条记录，RLS 策略已优化
- **lease_bills 表**：0 条记录，RLS 策略已优化
- **vehicle_leases 表**：0 条记录，RLS 策略已优化

### 后续建议

1. **测试**：登录租赁管理员账号，验证是否能正常查看租赁记录
2. **监控**：观察是否还有其他表受到递归问题影响
3. **性能**：监控查询性能，确保优化有效

---

**修复完成时间**：2025-11-26  
**修复状态**：✅ 已完成  
**验证状态**：✅ 已验证  
**租赁记录数**：15 条（可正常访问）
