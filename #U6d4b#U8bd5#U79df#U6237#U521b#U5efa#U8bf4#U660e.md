# 测试租户创建说明

## 📋 概述

本文档说明如何创建测试租户和测试账号，用于开发和测试车队管家系统的多租户功能。

## 🎯 测试租户配置

### 租户1：测试租户1
- **租户代码**：`test-tenant-1`
- **老板账号**：admin1 / 13800000001 / 123456
- **平级管理员**：admin11 / 13800000011 / 123456
- **车队长**：admin111 / 13800000111 / 123456
- **司机**：admin1111 / 13800001111 / 123456

### 租户2：测试租户2
- **租户代码**：`test-tenant-2`
- **老板账号**：admin2 / 13800000002 / 123456
- **平级管理员**：admin22 / 13800000022 / 123456
- **车队长**：admin222 / 13800000222 / 123456
- **司机**：admin2222 / 13800002222 / 123456

## 🚀 创建测试租户

### 方法1：使用自动化脚本（推荐）

```bash
# 进入项目目录
cd /workspace/app-7cdqf07mbu9t

# 运行创建脚本
node scripts/create-test-tenants.js
```

### 方法2：手动创建

#### 步骤1：创建租户1

```bash
# 使用 Edge Function 创建租户
curl -X POST "${SUPABASE_URL}/functions/v1/create-tenant" \
  -H "Authorization: Bearer ${SUPABASE_ANON_KEY}" \
  -H "Content-Type: application/json" \
  -d '{
    "tenant_name": "测试租户1",
    "tenant_code": "test-tenant-1",
    "boss_phone": "13800000001",
    "boss_name": "老板1",
    "boss_password": "123456"
  }'
```

#### 步骤2：创建租户1的其他用户

在租户1的 schema 中创建其他用户（平级管理员、车队长、司机）。

#### 步骤3：重复以上步骤创建租户2

## 📱 快捷登录功能

### 登录页面快捷登录

1. 打开登录页面
2. 点击"🧪 开发测试 - 快速登录"展开测试账号列表
3. 选择要登录的租户和角色
4. 点击对应的账号卡片，系统会自动填充账号和密码
5. 点击"密码登录"按钮完成登录

### 支持的登录方式

#### 方式1：账号名登录
- 输入账号名（如 `admin1`）+ 密码 `123456`
- 系统会自动将账号名转换为对应的手机号

#### 方式2：手机号登录
- 输入手机号（如 `13800000001`）+ 密码 `123456`
- 直接使用手机号登录

#### 方式3：快捷登录
- 点击快捷登录区域的账号卡片
- 系统自动填充账号和密码
- 点击"密码登录"按钮

## 🔧 账号映射配置

登录页面支持以下账号名到手机号的映射：

```typescript
const accountMapping = {
  // 租户1 测试账号
  admin1: '13800000001',      // 老板
  admin11: '13800000011',     // 平级管理员
  admin111: '13800000111',    // 车队长
  admin1111: '13800001111',   // 司机
  
  // 租户2 测试账号
  admin2: '13800000002',      // 老板
  admin22: '13800000022',     // 平级管理员
  admin222: '13800000222',    // 车队长
  admin2222: '13800002222',   // 司机
  
  // 中央管理员
  admin: '13800000001'
}
```

## 📊 测试场景

### 场景1：测试多租户数据隔离
1. 使用租户1的账号登录（如 admin1）
2. 创建一些测试数据（司机、车辆、考勤等）
3. 退出登录
4. 使用租户2的账号登录（如 admin2）
5. 验证看不到租户1的数据

### 场景2：测试角色权限
1. 使用老板账号登录（admin1）
2. 验证可以访问所有功能
3. 退出登录
4. 使用车队长账号登录（admin111）
5. 验证只能访问车队长权限范围内的功能
6. 退出登录
7. 使用司机账号登录（admin1111）
8. 验证只能访问司机功能

### 场景3：测试跨租户操作
1. 使用租户1的老板账号登录（admin1）
2. 尝试访问租户2的数据
3. 验证无法访问（应该被 RLS 策略阻止）

## ⚠️ 注意事项

### 1. 环境变量配置
确保 `.env` 文件中包含以下环境变量：
```env
TARO_APP_SUPABASE_URL=your_supabase_url
TARO_APP_SUPABASE_ANON_KEY=your_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key
```

### 2. Edge Function 部署
确保 `create-tenant` Edge Function 已经部署到 Supabase。

### 3. 数据库权限
确保数据库中的 RLS 策略正确配置，允许创建租户和用户。

### 4. 生产环境
⚠️ **重要**：快捷登录功能仅用于开发测试，生产环境必须删除！

删除方法：
1. 从登录页面删除快捷登录区域的代码
2. 删除账号映射配置中的测试账号
3. 删除测试租户和测试账号

## 🐛 故障排除

### 问题1：创建租户失败
**原因**：Edge Function 未部署或配置错误

**解决**：
```bash
# 检查 Edge Function 状态
supabase functions list

# 重新部署 Edge Function
supabase functions deploy create-tenant
```

### 问题2：无法登录测试账号
**原因**：账号未创建或密码错误

**解决**：
1. 检查数据库中是否存在该账号
2. 确认密码是否为 `123456`
3. 重新运行创建脚本

### 问题3：登录后看不到数据
**原因**：RLS 策略配置错误或租户 schema 未创建

**解决**：
1. 检查租户 schema 是否存在
2. 检查 RLS 策略是否正确
3. 检查用户的 tenant_id 是否正确

## 📚 相关文档

- [多租户架构说明](./MULTI_TENANT_ARCHITECTURE.md)
- [账号类型和权限](./ACCOUNT_TYPES_AND_PERMISSIONS.md)
- [开发者指南](./docs/DEVELOPER_GUIDE.md)

## 🔄 更新日志

### 2025-11-29
- ✅ 创建测试租户自动化脚本
- ✅ 更新登录页面，添加快捷登录功能
- ✅ 添加账号映射配置
- ✅ 创建使用说明文档

---

**维护人员**：开发团队  
**最后更新**：2025-11-29
