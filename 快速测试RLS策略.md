# 快速测试 RLS 策略指南

## 🚀 快速开始

### 方法 1: 浏览器测试（推荐）

#### 步骤 1: 打开老板端
1. 登录车队管家小程序
2. 切换到老板端

#### 步骤 2: 打开控制台
按 `F12` 打开浏览器开发者工具，切换到 `Console` 标签页

#### 步骤 3: 查看测试工具提示
页面加载后会自动显示：
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔧 RLS 策略测试工具已加载
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
使用方法:
  1. 打开浏览器控制台（F12）
  2. 输入以下命令测试:
     - testAllRLSPolicies()          // 测试所有 RLS 策略
     - testNotificationUpdatePermission()  // 测试通知更新权限
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

#### 步骤 4: 执行测试
在控制台输入：
```javascript
testAllRLSPolicies()
```

#### 步骤 5: 查看结果
测试会自动运行并输出详细日志：
```
╔═══════════════════════════════════════════════════════════════╗
║              开始测试 RLS 策略和权限映射表                    ║
╚═══════════════════════════════════════════════════════════════╝

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
测试 1: 检查当前用户
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  📊 获取当前用户信息...
  ✅ 当前用户:
    - 用户ID: xxx
    - 邮箱: xxx
    - 角色: BOSS

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
测试 2: 测试 users 表访问
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  📊 测试查询 users 表...
  ✅ 查询成功:
    - 总记录数: 10
    - 返回记录数: 10

...

╔═══════════════════════════════════════════════════════════════╗
║                        测试总结                                ║
╚═══════════════════════════════════════════════════════════════╝

📊 测试结果统计:
  - 总测试数: 5
  - 成功: 5
  - 失败: 0

✅ 测试完成！
```

### 方法 2: SQL 测试（数据库层面）

#### 步骤 1: 打开 Supabase SQL Editor
1. 登录 Supabase 控制台
2. 进入 SQL Editor

#### 步骤 2: 执行测试脚本
复制并执行以下 SQL：
```sql
\i 测试所有RLS策略和权限.sql
```

或者直接复制文件内容到 SQL Editor 执行。

#### 步骤 3: 查看结果
测试会输出详细的表格和统计信息。

## 📋 测试清单

### 必须通过的测试
- [ ] 当前用户信息正常
- [ ] users 表可以查询
- [ ] user_roles 表可以查询
- [ ] warehouses 表可以查询
- [ ] notifications 表可以查询和创建
- [ ] 通知可以更新（管理员）

### 关键检查点
- [ ] 所有表都启用了 RLS
- [ ] UPDATE 策略都有 WITH CHECK 子句
- [ ] 权限函数返回正确结果
- [ ] 管理员可以更新所有通知

## 🔍 常见问题

### 问题 1: 测试函数未定义
**症状**: 
```
Uncaught ReferenceError: testAllRLSPolicies is not defined
```

**解决方法**:
1. 刷新页面
2. 确保在老板端页面
3. 等待页面完全加载

### 问题 2: 查询失败
**症状**:
```
❌ 查询失败: permission denied for table xxx
```

**解决方法**:
1. 检查用户角色
2. 检查 RLS 策略
3. 执行 RLS 修复脚本

### 问题 3: 更新通知失败
**症状**:
```
❌ 更新通知失败: new row violates row-level security policy
```

**解决方法**:
1. 执行 `99999_fix_notification_rls_final.sql`
2. 确保 UPDATE 策略有 WITH CHECK 子句
3. 重新测试

## 🎯 快速修复

### 修复 RLS 策略
如果测试失败，执行以下 SQL：
```sql
-- 在 Supabase SQL Editor 中执行
\i supabase/migrations/99999_fix_notification_rls_final.sql
```

### 验证修复
再次运行测试：
```javascript
testAllRLSPolicies()
```

## 📊 预期结果

### 成功的测试输出
```
✅ 测试完成！

📊 测试结果统计:
  - 总测试数: 5
  - 成功: 5
  - 失败: 0
```

### 失败的测试输出
```
❌ 失败的测试:
  [1] notifications 表访问
      原因: 更新通知失败: new row violates row-level security policy
```

## 🔧 调试技巧

### 1. 查看详细日志
所有测试都会输出详细的日志，包括：
- 查询条件
- 返回结果
- 错误信息

### 2. 逐步测试
可以单独测试某个功能：
```javascript
// 只测试通知更新权限
testNotificationUpdatePermission()
```

### 3. 检查数据库
在 Supabase SQL Editor 中手动查询：
```sql
-- 检查当前用户角色
SELECT * FROM user_roles WHERE user_id = auth.uid();

-- 检查 RLS 策略
SELECT * FROM pg_policies WHERE tablename = 'notifications';

-- 测试 is_admin 函数
SELECT is_admin(auth.uid());
```

## 📝 测试报告

### 测试通过
如果所有测试都通过，说明：
- ✅ RLS 策略配置正确
- ✅ 权限映射正确
- ✅ 通知系统正常
- ✅ 可以正常使用

### 测试失败
如果有测试失败，需要：
1. 记录失败的测试名称
2. 记录错误信息
3. 执行修复脚本
4. 重新测试

## 🚀 下一步

### 测试通过后
1. 测试实际业务流程
2. 司机提交请假申请
3. 老板审批请假申请
4. 检查通知状态更新

### 测试失败后
1. 查看错误信息
2. 执行修复脚本
3. 重新测试
4. 如果还是失败，查看详细文档

## 📚 相关文档

- `RLS策略和权限测试指南.md` - 详细的测试指南
- `通知创建流程调试笔记.md` - 通知系统调试
- `RLS策略和权限测试完成报告.md` - 完整的测试报告

## ⏱️ 预计时间

- 浏览器测试：2-3 分钟
- SQL 测试：5-10 分钟
- 修复问题：10-20 分钟
- 完整测试：30 分钟

## ✅ 完成标志

当你看到以下输出时，说明测试完成：
```
✅ 测试完成！

📊 测试结果统计:
  - 总测试数: 5
  - 成功: 5
  - 失败: 0
```

---

**文档版本**: 1.0  
**创建时间**: 2025-11-05  
**适用范围**: 车队管家小程序 RLS 策略测试
