# 请假管理系统功能完善计划

## 功能模块概述

### 模块一：草稿管理功能
**目标**：允许用户保存未完成的申请，稍后继续编辑

### 模块二：智能计算功能
**目标**：自动计算请假天数，提升用户体验

### 模块三：审批权限管理
**目标**：实现分层审批权限，超级管理员只审批未分配管理员的仓库

---

## 详细实现方案

### 一、草稿管理功能

#### 1.1 数据库设计
**方案**：在现有表中添加 `is_draft` 字段

**优势**：
- 结构简单，不需要额外的表
- 草稿和正式申请共享相同的字段
- 提交时只需更新 `is_draft` 字段

**需要修改的表**：
- `leave_applications` 表添加 `is_draft` 字段（boolean，默认false）
- `resignation_applications` 表添加 `is_draft` 字段（boolean，默认false）

**字段验证规则调整**：
- 草稿状态下，部分字段可以为空
- 正式提交时，所有必填字段必须填写

#### 1.2 API函数设计
**新增函数**：
1. `saveDraftLeaveApplication` - 保存请假申请草稿
2. `getDraftLeaveApplications` - 获取用户的请假草稿列表
3. `submitDraftLeaveApplication` - 将草稿转为正式申请
4. `deleteDraftLeaveApplication` - 删除草稿
5. `updateDraftLeaveApplication` - 更新草稿内容

**离职申请对应函数**：
1. `saveDraftResignationApplication`
2. `getDraftResignationApplications`
3. `submitDraftResignationApplication`
4. `deleteDraftResignationApplication`
5. `updateDraftResignationApplication`

#### 1.3 前端页面设计
**司机端请假主页改进**：
- 添加"草稿箱"标签页
- 显示草稿列表
- 草稿卡片显示：类型、日期、保存时间
- 操作按钮：继续编辑、删除、提交

**申请页面改进**：
- 添加"保存草稿"按钮
- 添加"提交申请"按钮
- 草稿编辑模式：加载草稿数据
- 自动保存功能（可选）

#### 1.4 用户交互流程
```
用户填写申请 → 点击"保存草稿" → 保存成功提示 → 返回主页
用户查看草稿 → 点击"继续编辑" → 进入编辑页面 → 完成填写 → 提交申请
用户查看草稿 → 点击"删除" → 确认删除 → 草稿删除
用户查看草稿 → 点击"直接提交" → 验证必填项 → 提交成功/失败提示
```

---

### 二、智能计算功能

#### 2.1 计算逻辑
**计算方式**：
- 自然日计算：结束日期 - 开始日期 + 1
- 工作日计算：排除周末（可选）

**实现位置**：
- 前端实时计算
- 使用 `useEffect` 监听日期变化
- 显示在日期选择器下方

#### 2.2 显示设计
```
开始日期：2025-11-10
结束日期：2025-11-15
━━━━━━━━━━━━━━━━━━
请假天数：6天
```

#### 2.3 代码实现
```typescript
const calculateDays = (startDate: string, endDate: string): number => {
  if (!startDate || !endDate) return 0
  const start = new Date(startDate)
  const end = new Date(endDate)
  const diffTime = end.getTime() - start.getTime()
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24))
  return diffDays + 1 // 包含起始日
}
```

---

### 三、审批权限管理

#### 3.1 权限规则
**超级管理员审批权限**：
- ✅ 可以审批：仓库未分配任何管理员的申请
- ❌ 不可审批：仓库已分配管理员的申请

**普通管理员审批权限**：
- ✅ 可以审批：自己管辖仓库的申请
- ❌ 不可审批：其他仓库的申请

#### 3.2 数据库层面实现
**修改RLS策略**：
```sql
-- 超级管理员只能查看未分配管理员的仓库的申请
CREATE POLICY "Super admins can view unassigned warehouse applications" 
ON leave_applications
FOR SELECT USING (
  is_super_admin(auth.uid()) AND
  NOT EXISTS (
    SELECT 1 FROM manager_warehouses mw
    WHERE mw.warehouse_id = leave_applications.warehouse_id
  )
);

-- 超级管理员只能审批未分配管理员的仓库的申请
CREATE POLICY "Super admins can update unassigned warehouse applications"
ON leave_applications
FOR UPDATE USING (
  is_super_admin(auth.uid()) AND
  NOT EXISTS (
    SELECT 1 FROM manager_warehouses mw
    WHERE mw.warehouse_id = leave_applications.warehouse_id
  )
);
```

#### 3.3 API层面实现
**新增辅助函数**：
```typescript
// 检查仓库是否已分配管理员
async function isWarehouseAssigned(warehouseId: string): Promise<boolean> {
  const { data } = await supabase
    .from('manager_warehouses')
    .select('id')
    .eq('warehouse_id', warehouseId)
    .limit(1)
  return data && data.length > 0
}

// 获取超级管理员可审批的申请（仅未分配管理员的仓库）
async function getSuperAdminApprovableApplications(): Promise<LeaveApplication[]> {
  // 获取所有申请
  const allApplications = await getAllLeaveApplications()
  
  // 过滤出未分配管理员的仓库的申请
  const approvable = []
  for (const app of allApplications) {
    const isAssigned = await isWarehouseAssigned(app.warehouse_id)
    if (!isAssigned) {
      approvable.push(app)
    }
  }
  return approvable
}
```

#### 3.4 前端页面实现
**超级管理员审批页面改进**：
1. 显示权限说明
2. 只显示可审批的申请
3. 已分配管理员的仓库申请显示"无权限"标签
4. 提供仓库管理员分配状态查看

**权限说明文案**：
```
📋 审批权限说明：
• 您可以审批未分配管理员的仓库的申请
• 已分配管理员的仓库，由对应管理员负责审批
• 如需调整权限，请前往"管理员仓库分配"页面
```

#### 3.5 用户交互流程
```
超级管理员进入审批页面
  ↓
显示权限说明
  ↓
加载可审批的申请列表
  ↓
如果申请列表为空 → 显示"暂无可审批的申请"
如果有申请 → 显示申请列表 → 点击审批 → 确认操作 → 审批成功
```

---

## 界面交互设计建议

### 1. 草稿管理界面

#### 1.1 草稿列表卡片
```
┌─────────────────────────────────────┐
│ 📝 请假申请草稿                      │
│                                     │
│ 请假类型：事假                       │
│ 开始日期：2025-11-10                │
│ 结束日期：2025-11-15                │
│ 保存时间：2025-11-05 14:30          │
│                                     │
│ [继续编辑] [删除] [直接提交]         │
└─────────────────────────────────────┘
```

#### 1.2 申请页面按钮布局
```
┌─────────────────────────────────────┐
│ 请假类型：[事假 ▼]                  │
│ 开始日期：[2025-11-10]              │
│ 结束日期：[2025-11-15]              │
│ 请假天数：6天                        │
│ 请假事由：[________________]        │
│                                     │
│ [保存草稿]          [提交申请]      │
└─────────────────────────────────────┘
```

### 2. 智能计算界面

#### 2.1 天数显示样式
```
┌─────────────────────────────────────┐
│ 开始日期                             │
│ ┌─────────────────────────────────┐ │
│ │ 2025-11-10                      │ │
│ └─────────────────────────────────┘ │
│                                     │
│ 结束日期                             │
│ ┌─────────────────────────────────┐ │
│ │ 2025-11-15                      │ │
│ └─────────────────────────────────┘ │
│                                     │
│ ┌─────────────────────────────────┐ │
│ │ 📅 请假天数：6天                 │ │
│ └─────────────────────────────────┘ │
└─────────────────────────────────────┘
```

### 3. 权限管理界面

#### 3.1 超级管理员审批页面
```
┌─────────────────────────────────────┐
│ 📋 审批权限说明                      │
│ • 您可以审批未分配管理员的仓库的申请  │
│ • 已分配管理员的仓库由对应管理员审批  │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│ 📝 请假申请                          │
│                                     │
│ 申请人：张三                         │
│ 仓库：北京仓库 [未分配管理员]        │
│ 请假类型：事假                       │
│ 请假时间：2025-11-10 至 2025-11-15  │
│ 请假天数：6天                        │
│                                     │
│ [通过] [驳回]                        │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│ 📝 请假申请                          │
│                                     │
│ 申请人：李四                         │
│ 仓库：上海仓库 [已分配管理员]        │
│ 状态：⚠️ 无审批权限                  │
│                                     │
│ [查看详情]                           │
└─────────────────────────────────────┘
```

---

## 实现优先级

### 第一阶段（核心功能）
1. ✅ 草稿管理 - 数据库迁移
2. ✅ 草稿管理 - API函数
3. ✅ 智能计算 - 前端实现
4. ✅ 审批权限 - RLS策略修改

### 第二阶段（界面优化）
1. ✅ 草稿管理 - 前端页面
2. ✅ 智能计算 - 界面展示
3. ✅ 审批权限 - 前端页面

### 第三阶段（体验提升）
1. ⏳ 自动保存草稿（可选）
2. ⏳ 工作日计算（可选）
3. ⏳ 批量操作（可选）

---

## 技术要点

### 1. 草稿状态管理
- 草稿不参与审批流程
- 草稿不显示在管理员审批页面
- 草稿只能由创建者查看和编辑

### 2. 权限检查时机
- 页面加载时检查权限
- 审批操作前再次检查权限
- 后端RLS策略作为最后防线

### 3. 数据一致性
- 草稿提交时验证所有必填字段
- 审批操作记录完整的审批信息
- 状态变更有明确的时间戳

---

## 测试要点

### 1. 草稿功能测试
- [ ] 保存草稿成功
- [ ] 编辑草稿成功
- [ ] 删除草稿成功
- [ ] 提交草稿成功
- [ ] 草稿列表正确显示

### 2. 智能计算测试
- [ ] 日期选择后自动计算
- [ ] 跨月计算正确
- [ ] 边界情况处理（同一天）

### 3. 权限管理测试
- [ ] 超级管理员只能看到未分配仓库的申请
- [ ] 普通管理员只能看到管辖仓库的申请
- [ ] 权限说明正确显示
- [ ] 无权限操作被正确拦截

---

## 预期效果

### 用户体验提升
1. 📝 草稿功能让用户可以随时保存，不怕丢失数据
2. 🧮 自动计算天数，减少用户计算负担
3. 🔒 清晰的权限管理，避免审批混乱

### 系统管理优化
1. 分层审批，责任明确
2. 权限可控，流程清晰
3. 数据完整，可追溯

### 代码质量保证
1. 类型安全
2. 错误处理完善
3. 用户提示友好
