# 路由配置和权限管理需求文档

## 一、角色与端口映射

### 1. 老板端（Boss Portal）

**可访问角色**：
- ✅ 老板（boss）
- ✅ 平级账号（peer）- 完整权限和只读权限都可以访问

**功能模块**：
- 用户管理
  - 管理员管理
  - 司机管理
- 车辆管理
- 考勤管理
- 请假管理
- 计件管理
- 仓库管理
- 通知中心

### 2. 车队长端（Fleet Leader Portal）

**可访问角色**：
- ✅ 车队长（fleet_leader）- 完整权限和只读权限

**功能模块**：
- 司机管理（仅管辖范围内）
- 车辆管理（仅管辖范围内）
- 考勤管理（仅管辖范围内）
- 请假管理（仅管辖范围内）
- 计件管理（仅管辖范围内）
- 通知中心

### 3. 司机端（Driver Portal）

**可访问角色**：
- ✅ 司机（driver）

**功能模块**：
- 个人信息
- 我的车辆
- 我的考勤
- 我的请假
- 我的计件
- 通知中心

---

## 二、用户管理权限详解

### 1. 老板账号的用户管理

#### 管理员管理
**显示内容**：
- ✅ 平级账号（peer）
- ✅ 车队长（fleet_leader）

**可执行操作**：
- ✅ 查看所有管理员
- ✅ 创建新管理员（平级账号、车队长）
- ✅ 编辑管理员信息
- ✅ 删除管理员
- ✅ 设置管理员权限类型（完整权限/只读权限）
- ✅ 设置车队长的管辖范围（warehouse_ids）

#### 司机管理
**显示内容**：
- ✅ 所有司机（driver）

**可执行操作**：
- ✅ 查看所有司机
- ✅ 创建新司机
- ✅ 编辑司机信息
- ✅ 删除司机
- ✅ 分配司机到仓库（设置 warehouse_ids）

---

### 2. 平级账号的用户管理

#### 管理员管理
**显示内容**：
- ✅ 车队长（fleet_leader）
- ❌ 不显示其他平级账号
- ❌ 不显示老板

**可执行操作**：

**完整权限平级账号**：
- ✅ 查看所有车队长
- ✅ 创建新车队长
- ✅ 编辑车队长信息
- ✅ 删除车队长
- ✅ 设置车队长权限类型（完整权限/只读权限）
- ✅ 设置车队长的管辖范围（warehouse_ids）

**只读权限平级账号**：
- ✅ 查看所有车队长
- ❌ 不能创建、编辑、删除车队长

#### 司机管理
**显示内容**：
- ✅ 所有司机（driver）

**可执行操作**：

**完整权限平级账号**：
- ✅ 查看所有司机
- ✅ 创建新司机
- ✅ 编辑司机信息
- ✅ 删除司机
- ✅ 分配司机到仓库（设置 warehouse_ids）

**只读权限平级账号**：
- ✅ 查看所有司机
- ❌ 不能创建、编辑、删除司机

---

### 3. 车队长的用户管理

#### 管理员管理
**显示内容**：
- ❌ 不显示（车队长没有管理员管理权限）

#### 司机管理
**显示内容**：
- ✅ 管辖范围内的司机（warehouse_ids 匹配）

**可执行操作**：

**完整权限车队长**：
- ✅ 查看管辖范围内的司机
- ✅ 创建新司机（自动分配到管辖范围内的仓库）
- ✅ 编辑管辖范围内的司机信息
- ✅ 删除管辖范围内的司机

**只读权限车队长**：
- ✅ 查看管辖范围内的司机
- ❌ 不能创建、编辑、删除司机

---

## 三、路由配置

### 1. 路由结构

```
/pages
├── /boss                    # 老板端
│   ├── /index              # 老板端首页
│   ├── /admin-management   # 管理员管理
│   ├── /driver-management  # 司机管理
│   ├── /vehicle-management # 车辆管理
│   ├── /attendance         # 考勤管理
│   ├── /leave              # 请假管理
│   ├── /piecework          # 计件管理
│   ├── /warehouse          # 仓库管理
│   └── /notifications      # 通知中心
│
├── /fleet-leader           # 车队长端
│   ├── /index              # 车队长端首页
│   ├── /driver-management  # 司机管理（管辖范围内）
│   ├── /vehicle-management # 车辆管理（管辖范围内）
│   ├── /attendance         # 考勤管理（管辖范围内）
│   ├── /leave              # 请假管理（管辖范围内）
│   ├── /piecework          # 计件管理（管辖范围内）
│   └── /notifications      # 通知中心
│
└── /driver                 # 司机端
    ├── /index              # 司机端首页
    ├── /profile            # 个人信息
    ├── /vehicle            # 我的车辆
    ├── /attendance         # 我的考勤
    ├── /leave              # 我的请假
    ├── /piecework          # 我的计件
    └── /notifications      # 通知中心
```

### 2. 路由守卫

#### 老板端路由守卫
```typescript
// 检查用户角色是否为 boss 或 peer
if (user.role !== 'boss' && user.role !== 'peer') {
  // 重定向到对应的端口
  redirectToCorrectPortal(user.role)
}
```

#### 车队长端路由守卫
```typescript
// 检查用户角色是否为 fleet_leader
if (user.role !== 'fleet_leader') {
  // 重定向到对应的端口
  redirectToCorrectPortal(user.role)
}
```

#### 司机端路由守卫
```typescript
// 检查用户角色是否为 driver
if (user.role !== 'driver') {
  // 重定向到对应的端口
  redirectToCorrectPortal(user.role)
}
```

### 3. 登录后重定向逻辑

```typescript
function redirectAfterLogin(user) {
  switch (user.role) {
    case 'boss':
    case 'peer':
      return '/pages/boss/index'
    case 'fleet_leader':
      return '/pages/fleet-leader/index'
    case 'driver':
      return '/pages/driver/index'
    default:
      return '/pages/login/index'
  }
}
```

---

## 四、管理员管理页面设计

### 1. 老板账号的管理员管理页面

#### 页面标题
**管理员管理**

#### 筛选器
- 角色筛选：全部 / 平级账号 / 车队长
- 权限类型筛选：全部 / 完整权限 / 只读权限
- 状态筛选：全部 / 激活 / 停用

#### 列表显示
| 姓名 | 角色 | 权限类型 | 管辖范围 | 状态 | 操作 |
|------|------|----------|----------|------|------|
| 张三 | 平级账号 | 完整权限 | - | 激活 | 编辑 / 删除 |
| 李四 | 平级账号 | 只读权限 | - | 激活 | 编辑 / 删除 |
| 王五 | 车队长 | 完整权限 | 仓库A, 仓库B | 激活 | 编辑 / 删除 |
| 赵六 | 车队长 | 只读权限 | 仓库C | 激活 | 编辑 / 删除 |

#### 操作按钮
- ✅ 新增管理员

#### 新增/编辑管理员表单
- 姓名（必填）
- 手机号（必填）
- 邮箱（可选）
- 角色（必选）：平级账号 / 车队长
- 权限类型（必选）：完整权限 / 只读权限
- 管辖范围（车队长必填）：多选仓库
- 状态（必选）：激活 / 停用

---

### 2. 平级账号的管理员管理页面

#### 页面标题
**车队长管理**

#### 筛选器
- 权限类型筛选：全部 / 完整权限 / 只读权限
- 状态筛选：全部 / 激活 / 停用

#### 列表显示
| 姓名 | 权限类型 | 管辖范围 | 状态 | 操作 |
|------|----------|----------|------|------|
| 王五 | 完整权限 | 仓库A, 仓库B | 激活 | 编辑 / 删除 |
| 赵六 | 只读权限 | 仓库C | 激活 | 编辑 / 删除 |

**说明**：
- ❌ 不显示平级账号
- ❌ 不显示老板
- ✅ 只显示车队长

#### 操作按钮（完整权限平级账号）
- ✅ 新增车队长

#### 操作按钮（只读权限平级账号）
- ❌ 无新增按钮

#### 新增/编辑车队长表单（完整权限平级账号）
- 姓名（必填）
- 手机号（必填）
- 邮箱（可选）
- 权限类型（必选）：完整权限 / 只读权限
- 管辖范围（必填）：多选仓库
- 状态（必选）：激活 / 停用

---

## 五、权限控制矩阵

### 管理员管理权限

| 角色 | 权限类型 | 查看平级账号 | 管理平级账号 | 查看车队长 | 管理车队长 |
|------|----------|-------------|-------------|-----------|-----------|
| 老板 | full | ✅ | ✅ | ✅ | ✅ |
| 平级账号 | full | ❌ | ❌ | ✅ | ✅ |
| 平级账号 | readonly | ❌ | ❌ | ✅ | ❌ |
| 车队长 | full | ❌ | ❌ | ❌ | ❌ |
| 车队长 | readonly | ❌ | ❌ | ❌ | ❌ |
| 司机 | full | ❌ | ❌ | ❌ | ❌ |

### 司机管理权限

| 角色 | 权限类型 | 查看范围 | 管理权限 |
|------|----------|----------|----------|
| 老板 | full | 所有司机 | ✅ |
| 平级账号 | full | 所有司机 | ✅ |
| 平级账号 | readonly | 所有司机 | ❌ |
| 车队长 | full | 管辖范围内 | ✅ |
| 车队长 | readonly | 管辖范围内 | ❌ |
| 司机 | full | 自己 | ❌ |

---

## 六、实施计划

### ✅ 已完成
1. ✅ 权限模型设计
2. ✅ RLS 策略设计
3. ✅ 通知系统设计

### ⏳ 待完成
1. ⏳ 创建路由结构
2. ⏳ 实现路由守卫
3. ⏳ 实现登录后重定向逻辑
4. ⏳ 实现老板端管理员管理页面
5. ⏳ 实现平级账号的车队长管理页面
6. ⏳ 实现权限控制逻辑

---

## 七、总结

### ✅ 核心需求

1. ✅ **老板账号登录老板端**：可以访问所有功能
2. ✅ **平级账号登录老板端**：可以访问所有功能（根据权限类型）
3. ✅ **老板的管理员管理**：显示平级账号和车队长
4. ✅ **平级账号的管理员管理**：只显示车队长
5. ✅ **车队长登录车队长端**：只能访问管辖范围内的数据
6. ✅ **司机登录司机端**：只能访问自己的数据

### 📊 核心特性

1. **角色分离**：不同角色访问不同的端口
2. **权限控制**：根据角色和权限类型控制功能访问
3. **数据隔离**：根据管辖范围隔离数据
4. **路由守卫**：防止未授权访问
5. **自动重定向**：登录后自动跳转到对应的端口

---

**文档版本**：1.0  
**创建时间**：2025-11-27  
**作者**：秒哒 AI
