# 请假与离职管理功能模块完善方案

## 📋 需求概述

### 司机端功能优化
1. **快捷请假功能**
   - 通过滚轮滑动快速选择请假天数
   - 默认起始日期自动设置为第二天
   - 自动计算结束日期

2. **补请假功能**
   - 允许手动选择当天及之前的日期
   - 用于补录过去的请假记录

3. **离职功能优化**
   - 离职申请日期只能选择距当前日期指定天数后的日期
   - 天数由仓库设置决定

### 超级管理员后台功能
1. **仓库请假天数上限设置**
   - 为每个仓库设置允许的请假天数上限
   - 超过上限则无法请假，需管理员手动补录

2. **仓库离职提前天数设置**
   - 为每个仓库设置离职申请需提前的天数

## 🗄️ 数据库设计

### 1. 更新warehouses表
```sql
ALTER TABLE warehouses 
ADD COLUMN max_leave_days INTEGER DEFAULT 7,
ADD COLUMN resignation_notice_days INTEGER DEFAULT 30;

COMMENT ON COLUMN warehouses.max_leave_days IS '最大请假天数上限';
COMMENT ON COLUMN warehouses.resignation_notice_days IS '离职申请需提前的天数';
```

### 2. 更新类型定义
```typescript
export interface Warehouse {
  id: string
  name: string
  location: string
  max_leave_days: number  // 新增
  resignation_notice_days: number  // 新增
  created_at: string
}
```

## 🔧 API设计

### 1. 仓库设置相关API
```typescript
// 获取仓库设置
getWarehouseSettings(warehouseId: string): Promise<{
  max_leave_days: number
  resignation_notice_days: number
}>

// 更新仓库设置
updateWarehouseSettings(
  warehouseId: string, 
  settings: {
    max_leave_days?: number
    resignation_notice_days?: number
  }
): Promise<boolean>
```

### 2. 验证相关API
```typescript
// 验证请假申请
validateLeaveApplication(
  warehouseId: string, 
  days: number
): Promise<{
  valid: boolean
  maxDays: number
  message?: string
}>

// 验证离职日期
validateResignationDate(
  warehouseId: string, 
  date: string
): Promise<{
  valid: boolean
  minDate: string
  noticeDays: number
  message?: string
}>
```

## 🎨 界面设计方案

### 司机端 - 请假申请页面

#### 布局结构
```
┌─────────────────────────────────┐
│  请假申请                        │
├─────────────────────────────────┤
│  [快捷请假] [补请假]             │
├─────────────────────────────────┤
│                                  │
│  【快捷请假模式】                │
│  ┌───────────────────────────┐  │
│  │ 请假类型: [事假 ▼]        │  │
│  └───────────────────────────┘  │
│  ┌───────────────────────────┐  │
│  │ 请假天数: [3天 ▼]         │  │
│  │ (滚轮选择1-7天)            │  │
│  └───────────────────────────┘  │
│  ┌───────────────────────────┐  │
│  │ 📅 起始日期: 2025-01-07   │  │
│  │    (自动设置为明天)        │  │
│  └───────────────────────────┘  │
│  ┌───────────────────────────┐  │
│  │ 📅 结束日期: 2025-01-09   │  │
│  │    (自动计算)              │  │
│  └───────────────────────────┘  │
│  ┌───────────────────────────┐  │
│  │ 💡 请假天数: 3天          │  │
│  └───────────────────────────┘  │
│  ┌───────────────────────────┐  │
│  │ 请假事由:                  │  │
│  │ ┌─────────────────────┐  │  │
│  │ │                     │  │  │
│  │ └─────────────────────┘  │  │
│  └───────────────────────────┘  │
│                                  │
│  [保存草稿] [提交申请]          │
│                                  │
│  【补请假模式】                  │
│  ┌───────────────────────────┐  │
│  │ 请假类型: [事假 ▼]        │  │
│  └───────────────────────────┘  │
│  ┌───────────────────────────┐  │
│  │ 📅 开始日期: [选择日期]   │  │
│  │    (可选今天及之前)        │  │
│  └───────────────────────────┘  │
│  ┌───────────────────────────┐  │
│  │ 📅 结束日期: [选择日期]   │  │
│  └───────────────────────────┘  │
│  ┌───────────────────────────┐  │
│  │ 💡 请假天数: 3天          │  │
│  └───────────────────────────┘  │
│  ┌───────────────────────────┐  │
│  │ ⚠️ 超过上限提示            │  │
│  │ 您的请假天数(10天)超过仓库 │  │
│  │ 上限(7天)，需要管理员手动  │  │
│  │ 补录。                     │  │
│  └───────────────────────────┘  │
│  ┌───────────────────────────┐  │
│  │ 请假事由:                  │  │
│  │ ┌─────────────────────┐  │  │
│  │ │                     │  │  │
│  │ └─────────────────────┘  │  │
│  └───────────────────────────┘  │
│                                  │
│  [保存草稿] [提交申请]          │
└─────────────────────────────────┘
```

#### 交互说明

**快捷请假模式：**
1. 默认选中"快捷请假"标签
2. 请假天数使用Picker的selector模式，显示1-上限天数的选项
3. 起始日期自动设置为明天，不可修改
4. 结束日期根据天数自动计算，不可修改
5. 实时显示请假天数
6. 如果选择的天数等于上限，显示提示信息

**补请假模式：**
1. 点击"补请假"标签切换
2. 开始日期可以选择今天及之前的任意日期
3. 结束日期可以选择开始日期及之后的任意日期
4. 实时计算并显示请假天数
5. 如果天数超过上限，显示警告提示
6. 超过上限仍可提交，但需要管理员审批

### 司机端 - 离职申请页面

#### 布局结构
```
┌─────────────────────────────────┐
│  离职申请                        │
├─────────────────────────────────┤
│  ┌───────────────────────────┐  │
│  │ ℹ️ 温馨提示                │  │
│  │ 离职申请需提前30天提交     │  │
│  └───────────────────────────┘  │
│  ┌───────────────────────────┐  │
│  │ 📅 期望离职日期:          │  │
│  │    [选择日期]              │  │
│  │    (最早可选: 2025-02-05)  │  │
│  └───────────────────────────┘  │
│  ┌───────────────────────────┐  │
│  │ 离职原因:                  │  │
│  │ ┌─────────────────────┐  │  │
│  │ │                     │  │  │
│  │ └─────────────────────┘  │  │
│  └───────────────────────────┘  │
│                                  │
│  [保存草稿] [提交申请]          │
└─────────────────────────────────┘
```

#### 交互说明
1. 页面顶部显示提前天数提示
2. 日期选择器的最早可选日期为：当前日期 + 提前天数
3. 如果用户尝试选择更早的日期，显示错误提示
4. 显示最早可选日期的具体日期

### 超级管理员 - 仓库管理页面

#### 布局结构
```
┌─────────────────────────────────┐
│  仓库管理 > 仓库详情             │
├─────────────────────────────────┤
│  基本信息                        │
│  ┌───────────────────────────┐  │
│  │ 仓库名称: 北京仓库         │  │
│  │ 仓库位置: 北京市朝阳区     │  │
│  └───────────────────────────┘  │
│                                  │
│  请假与离职设置                  │
│  ┌───────────────────────────┐  │
│  │ 📋 最大请假天数上限        │  │
│  │ ┌─────────────────────┐  │  │
│  │ │ [7] 天               │  │  │
│  │ └─────────────────────┘  │  │
│  │ 说明: 司机单次请假不能超过 │  │
│  │ 此天数，超过需管理员补录   │  │
│  └───────────────────────────┘  │
│  ┌───────────────────────────┐  │
│  │ 📅 离职申请提前天数        │  │
│  │ ┌─────────────────────┐  │  │
│  │ │ [30] 天              │  │  │
│  │ └─────────────────────┘  │  │
│  │ 说明: 司机离职申请需提前   │  │
│  │ 此天数提交                 │  │
│  └───────────────────────────┘  │
│                                  │
│  [保存设置]                      │
└─────────────────────────────────┘
```

#### 交互说明
1. 在仓库详情页面添加"请假与离职设置"区块
2. 使用数字输入框，限制范围1-365
3. 显示清晰的说明文字
4. 保存后立即生效
5. 显示保存成功提示

## 🔄 业务流程

### 快捷请假流程
```
1. 司机进入请假申请页面
2. 默认显示"快捷请假"模式
3. 选择请假类型
4. 通过滚轮选择请假天数(1-上限)
5. 系统自动设置起始日期为明天
6. 系统自动计算结束日期
7. 填写请假事由
8. 提交申请或保存草稿
9. 进入审批流程
```

### 补请假流程
```
1. 司机进入请假申请页面
2. 切换到"补请假"模式
3. 选择请假类型
4. 手动选择开始日期(今天或之前)
5. 手动选择结束日期
6. 系统计算请假天数
7. 如果超过上限，显示警告
8. 填写请假事由
9. 提交申请(需管理员审批)
```

### 离职申请流程
```
1. 司机进入离职申请页面
2. 查看提前天数提示
3. 选择期望离职日期(必须>=当前日期+提前天数)
4. 填写离职原因
5. 提交申请或保存草稿
6. 进入审批流程
```

### 仓库设置流程
```
1. 超级管理员进入仓库管理
2. 选择要设置的仓库
3. 进入仓库详情页面
4. 设置最大请假天数上限
5. 设置离职申请提前天数
6. 保存设置
7. 设置立即生效
```

## ✅ 验证规则

### 请假申请验证
1. **快捷请假**
   - 请假天数 <= 仓库上限
   - 起始日期 = 明天
   - 结束日期 = 起始日期 + 天数 - 1

2. **补请假**
   - 开始日期 <= 今天
   - 结束日期 >= 开始日期
   - 如果天数 > 上限，显示警告但允许提交

### 离职申请验证
1. 期望离职日期 >= 当前日期 + 提前天数
2. 离职原因不能为空

### 仓库设置验证
1. 最大请假天数: 1-365
2. 离职提前天数: 1-365

## 🎯 实施步骤

### 第一阶段：数据库和API
- [ ] 1. 创建数据库迁移文件，添加字段
- [ ] 2. 更新类型定义
- [ ] 3. 实现仓库设置相关API
- [ ] 4. 实现验证相关API
- [ ] 5. 测试API功能

### 第二阶段：司机端功能
- [ ] 6. 重构请假申请页面
  - [ ] 添加快捷请假模式
  - [ ] 添加补请假模式
  - [ ] 实现天数滚轮选择
  - [ ] 实现日期自动计算
  - [ ] 添加超限提示
- [ ] 7. 更新离职申请页面
  - [ ] 添加提前天数提示
  - [ ] 限制日期选择范围
  - [ ] 显示最早可选日期
- [ ] 8. 测试司机端功能

### 第三阶段：管理员端功能
- [ ] 9. 更新仓库管理页面
  - [ ] 添加设置区块
  - [ ] 实现设置保存
  - [ ] 添加验证逻辑
- [ ] 10. 测试管理员端功能

### 第四阶段：集成测试
- [ ] 11. 端到端测试
- [ ] 12. 边界情况测试
- [ ] 13. 用户体验优化
- [ ] 14. 代码检查和优化

## 📊 预期效果

### 用户体验提升
1. **快捷请假**：3步完成请假申请（选类型→选天数→填事由）
2. **补请假**：灵活补录历史请假记录
3. **离职申请**：清晰的提前天数提示，避免无效申请
4. **仓库管理**：灵活的配置，适应不同仓库的管理需求

### 管理效率提升
1. 减少无效申请（超限自动提示）
2. 规范离职流程（强制提前天数）
3. 灵活的仓库配置（不同仓库不同规则）
4. 清晰的权限分层（超管设置，管理员审批）

## 🔐 安全考虑

1. **权限控制**
   - 只有超级管理员可以修改仓库设置
   - 司机只能提交自己的申请
   - 管理员只能审批权限范围内的申请

2. **数据验证**
   - 前端验证 + 后端验证
   - 防止绕过前端限制
   - 数据库层面的约束

3. **审计日志**
   - 记录仓库设置的修改历史
   - 记录超限申请的审批情况

## 📝 注意事项

1. **兼容性**
   - 保持与现有功能的兼容
   - 草稿功能继续可用
   - 现有申请不受影响

2. **用户引导**
   - 添加使用说明
   - 首次使用时显示引导
   - 清晰的错误提示

3. **性能优化**
   - 缓存仓库设置
   - 减少不必要的API调用
   - 优化日期计算逻辑
