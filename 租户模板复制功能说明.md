# 租户模板复制功能说明

## 功能概述

租户模板复制功能允许在创建新租户时，自动复制第一个租户的配置，包括仓库信息、车辆信息等，大大简化了新租户的初始化工作。

## 工作原理

### 1. 模板租户选择

- **模板租户**：系统中第一个创建的租户（按 `created_at` 排序）
- 模板租户的配置会被自动复制到所有新创建的租户

### 2. 复制内容

创建新租户时，系统会自动复制以下内容：

#### 2.1 仓库信息（warehouses）
- 仓库名称
- 仓库地址
- 联系人
- 联系电话
- 仓库状态

#### 2.2 车辆信息（vehicles）
- 车牌号（自动添加"-副本"后缀，避免冲突）
- 所属仓库（自动映射到新租户的对应仓库）
- 车辆状态
- **注意**：不复制司机绑定关系

### 3. 数据映射

系统会自动处理数据关联关系：

- **仓库ID映射**：记录模板租户和新租户的仓库ID对应关系
- **车辆-仓库关联**：根据映射关系，将车辆关联到新租户的对应仓库

## 使用方式

### 自动化流程

创建新租户时，系统会自动执行以下步骤：

1. 创建租户记录
2. 创建租户 Schema 和表结构
3. 创建老板账号
4. 创建老板 profile
5. 创建默认仓库
6. **自动复制模板租户配置** ✨
7. 更新租户记录

### 前端界面

#### 租户管理页面

在租户管理页面顶部，会显示当前的模板租户信息：

```
┌─────────────────────────────────────┐
│ 📋 模板租户                          │
│ 公司名称：XXX公司                    │
│ 租户代码：tenant-001                │
│ 💡 创建新租户时，将自动复制该租户的  │
│    配置（仓库、车辆等）              │
└─────────────────────────────────────┘
```

#### 创建租户页面

在创建租户页面的"自动化部署说明"中，会提示：

```
📌 自动化部署说明
• 系统将自动创建独立的数据库 Schema
• 自动初始化所有业务表结构
• 自动创建老板账号并设置权限
• 自动复制第一个租户的配置（仓库、车辆等）
• 整个过程约需 3-5 秒
```

## 数据库函数

### 1. get_template_tenant_config()

获取模板租户的配置信息。

**返回值**：
```json
{
  "success": true,
  "tenant_id": "uuid",
  "tenant_code": "tenant-001",
  "company_name": "示例公司"
}
```

### 2. copy_template_to_new_tenant(p_new_tenant_code TEXT)

将模板租户的配置复制到新租户。

**参数**：
- `p_new_tenant_code`：新租户的代码（如 "tenant-002"）

**返回值**：
```json
{
  "success": true,
  "message": "配置复制成功",
  "template_tenant": "tenant-001",
  "new_tenant": "tenant-002",
  "warehouse_count": 2,
  "vehicle_count": 5
}
```

## 注意事项

### 1. 车牌号处理

- 复制的车辆车牌号会自动添加"-副本"后缀
- 例如：`京A12345` → `京A12345-副本`
- 避免车牌号冲突

### 2. 司机绑定

- **不会复制**司机绑定关系
- 新租户需要自行配置司机和车辆的绑定

### 3. 仓库映射

- 系统会自动维护仓库ID的映射关系
- 确保车辆正确关联到新租户的对应仓库

### 4. 错误处理

- 如果模板租户不存在，不会影响租户创建流程
- 复制失败不会导致租户创建失败（非致命错误）
- 所有错误都会记录在日志中

## 技术实现

### Edge Function 集成

在 `create-tenant` Edge Function 中，添加了模板复制步骤：

```typescript
// 7. 复制模板租户配置（如果存在）
console.log('📋 开始复制模板租户配置')
const {data: copyResult, error: copyError} = await supabase.rpc('copy_template_to_new_tenant', {
  p_new_tenant_code: tenantCode
})

if (copyError) {
  console.error('⚠️ 复制模板配置失败（非致命错误）:', copyError)
  // 不回滚，继续创建流程
} else if (copyResult?.success) {
  console.log('✅ 模板配置复制成功:', copyResult)
} else {
  console.log('ℹ️ 未复制模板配置:', copyResult?.message || '无模板租户')
}
```

### 前端 API

在 `src/db/central-admin-api.ts` 中添加了：

```typescript
/**
 * 获取模板租户配置
 */
export async function getTemplateTenantConfig(): Promise<{
  success: boolean
  tenant_id?: string
  tenant_code?: string
  company_name?: string
  message?: string
}>
```

## 使用场景

### 1. 快速部署

- 为新客户快速创建租户
- 自动配置基础数据
- 减少手动配置工作

### 2. 标准化配置

- 确保所有租户有相同的基础配置
- 统一仓库结构
- 统一车辆配置

### 3. 测试环境

- 快速创建测试租户
- 保持测试数据一致性
- 方便功能测试

## 未来扩展

可以考虑添加以下功能：

1. **自定义模板**：允许管理员选择不同的模板租户
2. **选择性复制**：允许选择要复制的内容（仓库、车辆等）
3. **模板管理**：创建和管理多个模板配置
4. **复制历史**：记录每次复制的详细信息

## 总结

租户模板复制功能大大简化了新租户的创建流程，通过自动复制第一个租户的配置，确保了所有租户的基础配置一致性，提高了系统部署效率。
