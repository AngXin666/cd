# 多租户架构设计方案

## 📋 需求概述

### 核心需求
1. **架构调整**：从共享数据库模式转向独立数据库架构
2. **移除功能**：移除租赁系统管理模块（lease_admin）
3. **新增功能**：
   - 中央管理系统
   - 租户自动化开通
   - 动态参数管理

### 业务目标
- 租户数量：约 10 个
- 数据隔离：完全物理隔离
- 管理方式：集中式管理平台

## 🏗️ 技术架构方案

### 方案选择：PostgreSQL Schema 级别隔离

#### 为什么选择 Schema 隔离？

**Supabase 限制**：
- Supabase 是托管服务，每个项目 = 一个数据库
- 无法在单个项目中创建多个物理数据库
- 创建新 Supabase 项目需要企业级权限

**Schema 隔离的优势**：
1. ✅ **逻辑隔离**：每个租户拥有独立的命名空间
2. ✅ **安全隔离**：通过 RLS 策略确保数据完全隔离
3. ✅ **动态创建**：可以通过 SQL 动态创建新 Schema
4. ✅ **性能优异**：同一数据库内，查询效率高
5. ✅ **成本效益**：只需一个 Supabase 项目
6. ✅ **管理便捷**：中央管理系统统一管控
7. ✅ **备份恢复**：统一的备份策略

## 🎯 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    Supabase 数据库实例                        │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌─────────────────────────────────────────────────────┐   │
│  │           public schema (中央管理)                    │   │
│  ├─────────────────────────────────────────────────────┤   │
│  │  • tenants (租户表)                                   │   │
│  │  • tenant_configs (租户配置表)                        │   │
│  │  • system_admins (系统管理员表)                       │   │
│  │  • tenant_modules (租户模块配置表)                    │   │
│  │  • audit_logs (审计日志表)                           │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                               │
│  ┌─────────────────────────────────────────────────────┐   │
│  │         tenant_001 schema (租户1)                     │   │
│  ├─────────────────────────────────────────────────────┤   │
│  │  • profiles (用户表)                                  │   │
│  │  • vehicles (车辆表)                                  │   │
│  │  • attendance (考勤表)                                │   │
│  │  • warehouses (仓库表)                                │   │
│  │  • ... (其他业务表)                                   │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                               │
│  ┌─────────────────────────────────────────────────────┐   │
│  │         tenant_002 schema (租户2)                     │   │
│  ├─────────────────────────────────────────────────────┤   │
│  │  • profiles                                           │   │
│  │  • vehicles                                           │   │
│  │  • ... (相同的表结构)                                 │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

## 📱 中央管理系统界面设计

### 1. 租户列表页面

**功能**：
- 查看所有租户
- 搜索租户
- 创建新租户
- 快速操作（查看详情、配置、续费、停用）

**界面布局**：
```
┌─────────────────────────────────────────────────────────┐
│  中央管理系统                                    [退出]   │
├─────────────────────────────────────────────────────────┤
│                                                           │
│  租户管理                                                 │
│                                                           │
│  [+ 创建新租户]                          [搜索: ______]  │
│                                                           │
│  ┌───────────────────────────────────────────────────┐  │
│  │ 租户列表                                           │  │
│  ├───────────────────────────────────────────────────┤  │
│  │                                                     │  │
│  │  📦 租户001 - XX物流公司                           │  │
│  │     状态: ✅ 正常  |  用户: 25/50  |  车辆: 45/100  │  │
│  │     到期时间: 2025-12-31                           │  │
│  │     [查看详情] [配置] [续费] [停用]                │  │
│  │                                                     │  │
│  │  📦 租户002 - YY运输公司                           │  │
│  │     状态: ✅ 正常  |  用户: 18/50  |  车辆: 32/100  │  │
│  │     到期时间: 2025-11-30                           │  │
│  │     [查看详情] [配置] [续费] [停用]                │  │
│  │                                                     │  │
│  └───────────────────────────────────────────────────┘  │
│                                                           │
└─────────────────────────────────────────────────────────┘
```

### 2. 创建租户页面

**功能**：
- 填写租户基本信息
- 设置配额限制
- 选择功能模块
- 创建老板账号

**界面布局**：
```
┌─────────────────────────────────────────────────────────┐
│  创建新租户                                      [返回]   │
├─────────────────────────────────────────────────────────┤
│                                                           │
│  基本信息                                                 │
│  ┌───────────────────────────────────────────────────┐  │
│  │  公司名称: [____________________________]         │  │
│  │  联系人:   [____________________________]         │  │
│  │  联系电话: [____________________________]         │  │
│  │  联系邮箱: [____________________________]         │  │
│  └───────────────────────────────────────────────────┘  │
│                                                           │
│  配额设置                                                 │
│  ┌───────────────────────────────────────────────────┐  │
│  │  最大用户数: [50___]                               │  │
│  │  最大车辆数: [100__]                               │  │
│  │  有效期至:   [2025-12-31]                          │  │
│  └───────────────────────────────────────────────────┘  │
│                                                           │
│  功能模块                                                 │
│  ┌───────────────────────────────────────────────────┐  │
│  │  ☑ 车辆管理                                        │  │
│  │  ☑ 考勤管理                                        │  │
│  │  ☑ 仓库管理                                        │  │
│  │  ☑ 请假管理                                        │  │
│  │  ☑ 计件工资                                        │  │
│  │  ☐ 违章管理                                        │  │
│  │  ☐ 维修管理                                        │  │
│  └───────────────────────────────────────────────────┘  │
│                                                           │
│  老板账号                                                 │
│  ┌───────────────────────────────────────────────────┐  │
│  │  账号: [____________________________]             │  │
│  │  密码: [____________________________]             │  │
│  │  姓名: [____________________________]             │  │
│  └───────────────────────────────────────────────────┘  │
│                                                           │
│  [取消]                                    [创建租户]     │
│                                                           │
└─────────────────────────────────────────────────────────┘
```

### 3. 租户详情页面

**功能**：
- 查看租户基本信息
- 查看使用统计
- 查看功能模块状态
- 编辑租户信息

**界面布局**：
```
┌─────────────────────────────────────────────────────────┐
│  租户详情 - XX物流公司                           [返回]   │
├─────────────────────────────────────────────────────────┤
│                                                           │
│  基本信息                                                 │
│  ┌───────────────────────────────────────────────────┐  │
│  │  公司名称: XX物流公司                              │  │
│  │  Schema: tenant_001                                │  │
│  │  状态: ✅ 正常                                     │  │
│  │  创建时间: 2025-01-15                              │  │
│  │  到期时间: 2025-12-31                              │  │
│  │  联系人: 张三                                      │  │
│  │  联系电话: 13800138000                             │  │
│  └───────────────────────────────────────────────────┘  │
│                                                           │
│  使用统计                                                 │
│  ┌───────────────────────────────────────────────────┐  │
│  │  用户数: 25 / 50  [████████░░░░░░░░░░] 50%        │  │
│  │  车辆数: 45 / 100 [█████████░░░░░░░░░] 45%        │  │
│  │  存储空间: 2.3GB / 10GB                            │  │
│  └───────────────────────────────────────────────────┘  │
│                                                           │
│  功能模块                                                 │
│  ┌───────────────────────────────────────────────────┐  │
│  │  ✅ 车辆管理    ✅ 考勤管理    ✅ 仓库管理         │  │
│  │  ✅ 请假管理    ✅ 计件工资    ❌ 违章管理         │  │
│  │  ❌ 维修管理                                       │  │
│  │                                    [编辑模块配置]  │  │
│  └───────────────────────────────────────────────────┘  │
│                                                           │
│  操作                                                     │
│  [编辑信息] [续费] [停用] [删除]                         │
│                                                           │
└─────────────────────────────────────────────────────────┘
```

### 4. 模块配置页面

**功能**：
- 启用/禁用功能模块
- 配置模块参数
- 动态创建/删除数据表

**界面布局**：
```
┌─────────────────────────────────────────────────────────┐
│  模块配置 - XX物流公司                           [返回]   │
├─────────────────────────────────────────────────────────┤
│                                                           │
│  车辆管理模块                                             │
│  ┌───────────────────────────────────────────────────┐  │
│  │  状态: ✅ 已启用                                   │  │
│  │  表: vehicles, vehicle_records                     │  │
│  │  配置:                                             │  │
│  │    • 启用车辆定位: ☑                               │  │
│  │    • 启用油耗统计: ☑                               │  │
│  │    • 启用维修记录: ☐                               │  │
│  │  [保存配置]                                        │  │
│  └───────────────────────────────────────────────────┘  │
│                                                           │
│  考勤管理模块                                             │
│  ┌───────────────────────────────────────────────────┐  │
│  │  状态: ✅ 已启用                                   │  │
│  │  表: attendance, attendance_rules                  │  │
│  │  配置:                                             │  │
│  │    • 启用GPS打卡: ☑                                │  │
│  │    • 启用人脸识别: ☐                               │  │
│  │    • 迟到扣款: ☑                                   │  │
│  │  [保存配置]                                        │  │
│  └───────────────────────────────────────────────────┘  │
│                                                           │
│  违章管理模块                                             │
│  ┌───────────────────────────────────────────────────┐  │
│  │  状态: ❌ 未启用                                   │  │
│  │  [启用此模块]                                      │  │
│  └───────────────────────────────────────────────────┘  │
│                                                           │
└─────────────────────────────────────────────────────────┘
```

## 🔄 租户创建流程

### 自动化流程图

```
[管理员填写表单]
       ↓
[验证表单数据]
       ↓
[创建租户记录] → public.tenants
       ↓
[生成 Schema 名称] → tenant_xxx
       ↓
[创建 Schema] → CREATE SCHEMA tenant_xxx
       ↓
[初始化表结构] → 根据模块配置创建表
       ↓
[设置 RLS 策略] → 配置安全策略
       ↓
[创建老板账号] → auth.users + tenant_xxx.profiles
       ↓
[记录审计日志] → public.audit_logs
       ↓
[返回创建结果]
```

### 交互流程说明

#### 步骤 1：进入创建页面
1. 系统管理员登录中央管理系统
2. 点击"创建新租户"按钮
3. 进入租户创建表单页面

#### 步骤 2：填写基本信息
1. 输入公司名称（必填）
2. 输入联系人姓名（必填）
3. 输入联系电话（必填，格式验证）
4. 输入联系邮箱（选填，格式验证）

#### 步骤 3：设置配额
1. 设置最大用户数（默认 50）
2. 设置最大车辆数（默认 100）
3. 选择有效期（默认 1 年）

#### 步骤 4：选择功能模块
1. 勾选需要的功能模块
2. 系统显示每个模块的说明
3. 默认勾选：车辆管理、考勤管理、仓库管理

#### 步骤 5：创建老板账号
1. 输入老板账号（手机号或邮箱）
2. 输入初始密码
3. 输入老板姓名

#### 步骤 6：提交创建
1. 点击"创建租户"按钮
2. 系统显示加载动画
3. 后台执行自动化流程：
   - 创建租户记录
   - 创建独立 Schema
   - 初始化表结构
   - 创建老板账号
   - 记录审计日志

#### 步骤 7：创建完成
1. 显示创建成功提示
2. 显示租户信息摘要
3. 显示老板账号登录信息
4. 提供"查看详情"和"返回列表"选项

## 📊 数据库设计

### 中央管理表（public schema）

#### tenants（租户表）

```sql
CREATE TABLE public.tenants (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  schema_name TEXT UNIQUE NOT NULL,           -- Schema 名称
  company_name TEXT NOT NULL,                 -- 公司名称
  contact_name TEXT,                          -- 联系人
  contact_phone TEXT,                         -- 联系电话
  contact_email TEXT,                         -- 联系邮箱
  status TEXT NOT NULL DEFAULT 'active',      -- 状态
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  expired_at TIMESTAMPTZ,                     -- 过期时间
  max_users INTEGER DEFAULT 50,               -- 最大用户数
  max_vehicles INTEGER DEFAULT 100,           -- 最大车辆数
  notes TEXT                                  -- 备注
);
```

#### tenant_modules（租户模块配置表）

```sql
CREATE TABLE public.tenant_modules (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id UUID REFERENCES public.tenants(id) ON DELETE CASCADE,
  module_name TEXT NOT NULL,                  -- 模块名称
  is_enabled BOOLEAN DEFAULT true,            -- 是否启用
  config JSONB,                               -- 模块配置
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(tenant_id, module_name)
);
```

## 🚀 实施计划

### 阶段 1：数据库设计（1天）
- [ ] 设计中央管理表结构
- [ ] 设计租户表结构模板
- [ ] 编写数据库迁移脚本

### 阶段 2：后端开发（3-4天）
- [ ] 实现租户创建 API
- [ ] 实现 Schema 动态创建
- [ ] 实现表结构初始化
- [ ] 实现模块配置管理

### 阶段 3：前端开发（3-4天）
- [ ] 开发租户列表页面
- [ ] 开发租户创建页面
- [ ] 开发租户详情页面
- [ ] 开发模块配置页面

### 阶段 4：测试与优化（2-3天）
- [ ] 功能测试
- [ ] 安全测试
- [ ] 性能测试
- [ ] 用户体验优化

### 总计：约 9-12 天

## ⚠️ 重要说明

### 关于"独立数据库"的说明

由于 Supabase 的架构限制，我们采用 **Schema 级别隔离** 而不是完全独立的物理数据库。但这个方案提供了：

1. ✅ **等同的数据隔离效果**：每个租户的数据在独立的 Schema 中
2. ✅ **更好的安全性**：通过 RLS 策略确保跨租户访问被完全阻止
3. ✅ **更高的性能**：同一数据库内的查询效率更高
4. ✅ **更低的成本**：不需要为每个租户创建独立的 Supabase 项目
5. ✅ **更易管理**：统一的备份、监控和维护

### 如果必须使用完全独立的物理数据库

如果您坚持使用完全独立的物理数据库，需要：

1. **方案 A**：为每个租户创建独立的 Supabase 项目
   - 需要 Supabase 企业级账号
   - 每个项目单独计费
   - 管理复杂度高

2. **方案 B**：自建 PostgreSQL 集群
   - 需要自己管理数据库服务器
   - 失去 Supabase 的便利功能
   - 运维成本高

**建议**：先采用 Schema 隔离方案，如果未来确实需要，再迁移到独立数据库。

---

**文档版本**：v1.0  
**创建日期**：2025-11-27  
**状态**：待确认
