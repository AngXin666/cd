# 调试租户创建错误指南

## 问题描述

创建租户时出现 "Edge Function returned a non-2xx status code" 错误，需要获取更详细的错误信息。

## 已实施的改进

### 1. 使用 fetch 直接调用 Edge Function

修改了 `src/db/central-admin-api.ts` 中的 `createTenant` 函数，使用 `fetch` 直接调用 Edge Function，而不是使用 `supabase.functions.invoke`。

**优势**：
- 可以获取完整的响应文本
- 可以看到详细的错误信息
- 可以查看响应状态码

### 2. 详细的日志输出

现在会输出以下信息：
- 📥 Edge Function 响应状态（如 200、500 等）
- 📥 Edge Function 响应内容（完整的响应体）
- ❌ 解析错误（如果响应不是有效的 JSON）

## 如何查看错误信息

### 步骤 1：打开浏览器控制台

1. 在浏览器中打开应用
2. 按 F12 打开开发者工具
3. 切换到 "Console"（控制台）标签

### 步骤 2：尝试创建租户

1. 填写租户信息
2. 点击"创建租户"按钮
3. 观察控制台输出

### 步骤 3：查看详细错误信息

在控制台中，你会看到类似以下的输出：

```
🚀 开始创建租户: 测试公司
📥 Edge Function 响应状态: 500
📥 Edge Function 响应内容: {"success":false,"error":"克隆 Schema 时发生错误: ..."}
❌ Edge Function 返回错误状态: 500
```

**关键信息**：
- **响应状态**：告诉你是什么类型的错误（500 = 服务器错误）
- **响应内容**：包含详细的错误消息，这是最重要的信息

## 常见错误及解决方案

### 错误 1：克隆 Schema 失败

**错误信息**：
```
克隆 Schema 时发生错误: relation "xxx" does not exist
```

**原因**：模板租户的某个表或对象不存在

**解决方案**：
1. 检查第一个租户的 Schema 是否完整
2. 确保所有必需的表都已创建

### 错误 2：权限不足

**错误信息**：
```
permission denied for schema xxx
```

**原因**：数据库用户没有足够的权限

**解决方案**：
1. 检查 Edge Function 是否使用了 service role key
2. 确保克隆函数有 SECURITY DEFINER 标记

### 错误 3：约束冲突

**错误信息**：
```
duplicate key value violates unique constraint
```

**原因**：尝试插入重复的数据

**解决方案**：
1. 检查是否有重复的租户代码
2. 确保老板账号（手机号/邮箱）没有重复

### 错误 4：默认值引用问题

**错误信息**：
```
relation "tenant_001.xxx_seq" does not exist
```

**原因**：默认值中包含了 Schema 引用（如序列）

**解决方案**：
1. V4 版本已经不复制默认值，避免此问题
2. 如果仍然出现，检查是否有其他地方引用了旧 Schema

## V4 超简化版的优势

V4 版本使用 `CREATE TABLE LIKE` 语法，只复制：
- ✅ 表结构（列名、数据类型）
- ✅ NOT NULL 约束
- ✅ 主键约束

**不复制**：
- ❌ 默认值（避免 Schema 引用问题）
- ❌ 外键（避免跨 Schema 引用）
- ❌ 触发器（避免函数依赖）
- ❌ RLS 策略（避免策略表达式中的 Schema 引用）

这种方法虽然简单，但最可靠，避免了所有可能的 Schema 引用和依赖问题。

## 下一步

1. **查看控制台输出**：按照上述步骤查看详细的错误信息
2. **提供错误信息**：将控制台中的完整错误信息提供给开发人员
3. **分析错误原因**：根据错误信息确定具体的问题
4. **应用解决方案**：根据常见错误及解决方案部分进行修复

## 技术细节

### 修改的文件

- `src/db/central-admin-api.ts`：修改 `createTenant` 函数，使用 fetch 调用
- `supabase/migrations/create_tenant_schema_clone_v4.sql`：V4 超简化版克隆函数

### 关键代码

```typescript
// 使用 fetch 直接调用 Edge Function
const response = await fetch(`${supabaseUrl}/functions/v1/create-tenant`, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    Authorization: `Bearer ${session.access_token}`
  },
  body: JSON.stringify(input)
})

// 获取响应文本
const responseText = await response.text()
console.log('📥 Edge Function 响应状态:', response.status)
console.log('📥 Edge Function 响应内容:', responseText)
```

这样可以看到完整的响应内容，包括详细的错误信息。
