# 车队管理系统通知规则映射表

## 1. 通知触发场景与接收对象映射

### 1.1 司机操作场景

| 操作类型 | 触发条件 | 通知接收对象 | 通知内容 |
|---------|---------|------------|---------|
| 提交请假申请 | 司机提交请假申请 | 1. 老板<br>2. 所有平级账号<br>3. 该司机的车队长（如存在） | 司机【姓名】提交了请假申请<br>时间：【开始时间】至【结束时间】<br>原因：【请假原因】 |
| 提交离职申请 | 司机提交离职申请 | 1. 老板<br>2. 所有平级账号<br>3. 该司机的车队长（如存在） | 司机【姓名】提交了离职申请<br>离职日期：【日期】<br>原因：【离职原因】 |
| 提交车辆审核申请 | 司机提交车辆相关审核 | 1. 老板<br>2. 所有平级账号<br>3. 该司机的车队长（如存在） | 司机【姓名】提交了车辆审核申请<br>车辆：【车牌号】<br>申请类型：【审核类型】 |

### 1.2 车队长操作场景

| 操作类型 | 触发条件 | 通知接收对象 | 通知内容 |
|---------|---------|------------|---------|
| 调整司机分配 | 车队长修改司机的仓库分配 | 1. 老板<br>2. 所有平级账号<br>3. 被操作的司机 | 车队长【姓名】调整了司机【司机姓名】的仓库分配<br>变更：【变更详情】 |
| 调整司机类型 | 车队长修改司机类型 | 1. 老板<br>2. 所有平级账号<br>3. 被操作的司机 | 车队长【姓名】调整了司机【司机姓名】的类型<br>从【原类型】变更为【新类型】 |
| 审批请假申请 | 车队长审批司机请假 | 1. 老板<br>2. 所有平级账号<br>3. 申请的司机 | 车队长【姓名】【通过/驳回】了司机【司机姓名】的请假申请<br>审批意见：【意见】 |
| 审批离职申请 | 车队长审批司机离职 | 1. 老板<br>2. 所有平级账号<br>3. 申请的司机 | 车队长【姓名】【通过/驳回】了司机【司机姓名】的离职申请<br>审批意见：【意见】 |
| 审批车辆申请 | 车队长审批车辆相关申请 | 1. 老板<br>2. 所有平级账号<br>3. 申请的司机 | 车队长【姓名】【通过/驳回】了司机【司机姓名】的车辆审核申请<br>审批意见：【意见】 |

### 1.3 老板操作场景

| 操作类型 | 触发条件 | 通知接收对象 | 通知内容 |
|---------|---------|------------|---------|
| 调整车队长管辖仓库 | 老板修改车队长的仓库分配 | 1. 被操作的车队长<br>2. 相关仓库的其他车队长 | 老板调整了车队长【姓名】的管辖仓库<br>变更：【变更详情】 |
| 调整司机分配 | 老板修改司机的仓库分配 | 1. 相关仓库的所有车队长<br>2. 被操作的司机 | 老板调整了司机【司机姓名】的仓库分配<br>变更：【变更详情】 |
| 调整司机类型 | 老板修改司机类型 | 1. 该司机的车队长（如存在）<br>2. 被操作的司机 | 老板调整了司机【司机姓名】的类型<br>从【原类型】变更为【新类型】 |
| 审批请假申请 | 老板审批司机请假 | 1. 该司机的车队长（如存在）<br>2. 申请的司机 | 老板【通过/驳回】了司机【司机姓名】的请假申请<br>审批意见：【意见】 |
| 审批离职申请 | 老板审批司机离职 | 1. 该司机的车队长（如存在）<br>2. 申请的司机 | 老板【通过/驳回】了司机【司机姓名】的离职申请<br>审批意见：【意见】 |
| 审批车辆申请 | 老板审批车辆相关申请 | 1. 该司机的车队长（如存在）<br>2. 申请的司机 | 老板【通过/驳回】了司机【司机姓名】的车辆审核申请<br>审批意见：【意见】 |

### 1.4 平级账号操作场景

| 操作类型 | 触发条件 | 通知接收对象 | 通知内容 |
|---------|---------|------------|---------|
| 调整车队长管辖仓库 | 平级账号修改车队长的仓库分配 | 1. **老板（必须）**<br>2. 被操作的车队长<br>3. 相关仓库的其他车队长 | 平级账号【姓名】调整了车队长【车队长姓名】的管辖仓库<br>变更：【变更详情】 |
| 调整司机分配 | 平级账号修改司机的仓库分配 | 1. **老板（必须）**<br>2. 相关仓库的所有车队长<br>3. 被操作的司机 | 平级账号【姓名】调整了司机【司机姓名】的仓库分配<br>变更：【变更详情】 |
| 调整司机类型 | 平级账号修改司机类型 | 1. **老板（必须）**<br>2. 该司机的车队长（如存在）<br>3. 被操作的司机 | 平级账号【姓名】调整了司机【司机姓名】的类型<br>从【原类型】变更为【新类型】 |
| 审批请假申请 | 平级账号审批司机请假 | 1. **老板（必须）**<br>2. 该司机的车队长（如存在）<br>3. 申请的司机 | 平级账号【姓名】【通过/驳回】了司机【司机姓名】的请假申请<br>审批意见：【意见】 |
| 审批离职申请 | 平级账号审批司机离职 | 1. **老板（必须）**<br>2. 该司机的车队长（如存在）<br>3. 申请的司机 | 平级账号【姓名】【通过/驳回】了司机【司机姓名】的离职申请<br>审批意见：【意见】 |
| 审批车辆申请 | 平级账号审批车辆相关申请 | 1. **老板（必须）**<br>2. 该司机的车队长（如存在）<br>3. 申请的司机 | 平级账号【姓名】【通过/驳回】了司机【司机姓名】的车辆审核申请<br>审批意见：【意见】 |

## 2. 通知类型定义

```typescript
// 通知类型枚举
enum NotificationType {
  // 请假相关
  LEAVE_SUBMITTED = 'leave_submitted',           // 请假申请已提交
  LEAVE_APPROVED = 'leave_approved',             // 请假申请已通过
  LEAVE_REJECTED = 'leave_rejected',             // 请假申请已驳回
  
  // 离职相关
  RESIGNATION_SUBMITTED = 'resignation_submitted', // 离职申请已提交
  RESIGNATION_APPROVED = 'resignation_approved',   // 离职申请已通过
  RESIGNATION_REJECTED = 'resignation_rejected',   // 离职申请已驳回
  
  // 车辆审核相关
  VEHICLE_AUDIT_SUBMITTED = 'vehicle_audit_submitted', // 车辆审核已提交
  VEHICLE_AUDIT_APPROVED = 'vehicle_audit_approved',   // 车辆审核已通过
  VEHICLE_AUDIT_REJECTED = 'vehicle_audit_rejected',   // 车辆审核已驳回
  
  // 司机管理相关
  DRIVER_WAREHOUSE_CHANGED = 'driver_warehouse_changed', // 司机仓库分配变更
  DRIVER_TYPE_CHANGED = 'driver_type_changed',           // 司机类型变更
  
  // 车队长管理相关
  MANAGER_WAREHOUSE_CHANGED = 'manager_warehouse_changed', // 车队长管辖仓库变更
}
```

## 3. 通知接收对象获取规则

### 3.1 获取老板
```sql
SELECT id FROM profiles 
WHERE role = 'super_admin' 
AND boss_id = [当前租户的boss_id]
```

### 3.2 获取所有平级账号
```sql
SELECT id FROM profiles 
WHERE role = 'peer_admin' 
AND boss_id = [当前租户的boss_id]
```

### 3.3 获取司机的车队长
```sql
SELECT DISTINCT mw.manager_id 
FROM driver_warehouses dw
JOIN manager_warehouses mw ON dw.warehouse_id = mw.warehouse_id
WHERE dw.driver_id = [司机ID]
AND dw.boss_id = [当前租户的boss_id]
```

### 3.4 获取仓库的所有车队长
```sql
SELECT DISTINCT manager_id 
FROM manager_warehouses
WHERE warehouse_id IN ([仓库ID列表])
AND boss_id = [当前租户的boss_id]
```

## 4. 实现方案

### 4.1 创建通知服务模块
创建 `src/services/notificationService.ts`，包含以下功能：
- `sendDriverSubmissionNotification()` - 司机提交申请时的通知
- `sendManagerActionNotification()` - 车队长操作时的通知
- `sendBossActionNotification()` - 老板操作时的通知
- `sendPeerAdminActionNotification()` - 平级账号操作时的通知

### 4.2 集成到业务操作
在以下位置集成通知发送：
- 请假申请提交/审批
- 离职申请提交/审批
- 车辆审核提交/审批
- 司机仓库分配变更
- 司机类型变更
- 车队长仓库分配变更

### 4.3 通知内容模板
每个通知包含：
- `title`: 通知标题
- `content`: 通知内容（包含操作类型、操作对象、操作执行者）
- `type`: 通知类型
- `related_id`: 关联的业务对象ID
- `created_at`: 创建时间（自动生成）
- `sender_id`: 发送者ID
- `sender_name`: 发送者姓名
- `sender_role`: 发送者角色

## 5. 通知优先级

| 优先级 | 通知类型 | 说明 |
|-------|---------|------|
| 高 | 请假/离职/车辆审核申请 | 需要审批的申请 |
| 中 | 审批结果通知 | 申请的审批结果 |
| 中 | 司机分配/类型变更 | 影响工作安排的变更 |
| 低 | 车队长管辖仓库变更 | 管理范围调整 |

## 6. 通知去重规则

- 同一操作不重复发送给同一用户
- 如果用户同时是老板和平级账号，只发送一次
- 如果用户同时是车队长和被操作对象，只发送一次

## 7. 错误处理

- 通知发送失败不影响业务操作的执行
- 记录通知发送失败的日志
- 提供通知重发机制（可选）
