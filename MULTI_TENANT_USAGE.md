# 多租户功能使用说明

## 概述

车队管家小程序现已支持多租户功能，每个老板（租户）的数据完全独立，互不干扰。

## 角色说明

### 1. 租赁管理员（lease_admin）
- **权限**：管理所有老板账号，查看所有租户数据
- **登录账号**：admin888
- **登录密码**：hye19911206
- **主要功能**：
  - 创建新的老板账号
  - 查看所有老板账号列表
  - 编辑老板账号信息
  - 停用/启用老板账号
  - 查看租赁账单
  - 核销租赁费用

### 2. 老板（super_admin）
- **权限**：管理自己租户下的所有数据
- **登录方式**：使用创建时设置的邮箱和密码
- **主要功能**：
  - 管理车队长和司机
  - 管理车辆和仓库
  - 查看计件记录和考勤
  - 设置品类价格
  - 查看统计报表

### 3. 车队长（manager）
- **权限**：管理分配给自己的仓库和司机
- **登录方式**：使用老板分配的账号密码
- **主要功能**：
  - 管理司机
  - 查看计件记录
  - 审批请假申请

### 4. 司机（driver）
- **权限**：查看自己的工作数据
- **登录方式**：使用老板分配的账号密码
- **主要功能**：
  - 查看自己的计件记录
  - 提交请假申请
  - 查看考勤记录

## 创建新租户

### 步骤

1. **登录租赁管理员账号**
   - 账号：admin888
   - 密码：hye19911206

2. **进入老板账号管理**
   - 点击底部"租赁端"标签
   - 进入"老板账号列表"

3. **创建新老板账号**
   - 点击"新增老板账号"按钮
   - 填写必填信息：
     - 姓名
     - 手机号
     - 邮箱（用于登录）
     - 密码（至少6位）
   - 填写可选信息：
     - 公司名称
     - 租赁开始日期
     - 租赁结束日期
     - 月租费用
     - 备注
   - 点击"提交"

4. **通知老板**
   - 将邮箱和密码告知老板
   - 老板可以使用邮箱和密码登录系统

## 租户登录

### 老板登录

1. 打开车队管家小程序
2. 使用创建时设置的邮箱和密码登录
3. 登录后自动进入老板工作台

### 车队长/司机登录

1. 由老板在系统中创建账号
2. 使用老板分配的账号密码登录
3. 登录后根据角色进入对应工作台

## 数据隔离说明

### 完全隔离

- 每个租户的数据完全独立
- 租户A无法看到租户B的任何数据
- 包括：
  - 用户（车队长、司机）
  - 车辆
  - 仓库
  - 计件记录
  - 考勤记录
  - 请假申请
  - 通知
  - 等所有业务数据

### 自动归属

- 租户创建的所有数据自动归属到该租户
- 无需手动设置数据归属
- 系统自动处理数据隔离

### 租赁管理员特权

- 租赁管理员可以查看所有租户的数据
- 用于系统管理和问题排查
- 不影响租户间的数据隔离

## 常见问题

### Q1: 如何修改老板账号的密码？

**A:** 目前需要通过 Supabase Dashboard 修改。后续版本会添加密码修改功能。

### Q2: 老板忘记密码怎么办？

**A:** 租赁管理员可以通过 Supabase Dashboard 重置密码，或者创建新账号。

### Q3: 可以删除老板账号吗？

**A:** 可以，但会删除该租户的所有数据（级联删除）。建议使用"停用"功能代替删除。

### Q4: 租户数据可以迁移吗？

**A:** 目前不支持租户间数据迁移。如有需求，需要通过数据库操作手动迁移。

### Q5: 租赁管理员可以代替老板操作吗？

**A:** 租赁管理员只能查看数据，不能代替老板进行业务操作。

## 技术说明

### 数据库层面

- 使用 PostgreSQL 行级安全策略（RLS）
- 所有业务表都有 `tenant_id` 字段
- 触发器自动设置 `tenant_id`
- 索引优化查询性能

### 应用层面

- 前端无需关心 `tenant_id` 的设置
- API 自动处理数据隔离
- 用户只能访问自己租户的数据

### 安全性

- 数据库层面强制执行隔离
- 无法通过 API 绕过隔离
- 审计日志记录所有操作

## 更新日志

### 2025-11-25
- ✅ 实现多租户数据隔离功能
- ✅ 添加租户创建流程
- ✅ 添加邮箱和密码登录
- ✅ 自动设置 tenant_id
- ✅ 创建 RLS 策略
- ✅ 创建触发器
- ✅ 数据迁移

## 联系支持

如有问题或建议，请联系技术支持团队。
