# 管理端请假审批和打卡记录功能优化完成

## 优化时间
2025-11-05

## 优化内容

### 1. 优化请假审批管理页面 (`/pages/manager/leave-approval/index.tsx`)

#### 新增功能
- **快捷入口**：添加"查看打卡记录"按钮，方便快速跳转到打卡记录页面
- **状态筛选**：新增状态筛选功能，可以筛选"待审批"、"已批准"、"已拒绝"或"全部状态"
- **标签切换**：添加"待审批申请"和"司机统计"两个标签页，优化信息展示
- **待审批列表**：独立展示待审批的请假和离职申请，支持直接批准或拒绝
- **审批操作**：在待审批列表中直接显示批准/拒绝按钮，无需跳转到详情页

#### 优化功能
- **数据加载**：添加加载提示，提升用户体验
- **排序优化**：司机统计按待审批数量和请假天数排序，优先显示需要处理的司机
- **视觉优化**：
  - 待审批申请使用橙色标签
  - 离职申请使用紫色标签
  - 请假申请使用蓝色图标
  - 统计数据使用不同颜色区分

#### 修复问题
- 修复审批函数调用错误，正确传递ApplicationReviewInput对象
- 修复离职申请日期字段名称（expected_date）

### 2. 新增打卡记录查看页面 (`/pages/manager/attendance-records/index.tsx`)

#### 核心功能
- **多维度筛选**：
  - 月份筛选：支持查看最近12个月的打卡记录
  - 仓库筛选：只显示管理员管辖的仓库
  - 司机筛选：可以按司机筛选打卡记录

- **统计数据展示**：
  - 总记录数
  - 正常打卡数
  - 迟到次数
  - 早退次数

- **打卡记录详情**：
  - 司机姓名和所属仓库
  - 打卡状态（正常/迟到/早退/缺勤）
  - 上班打卡时间
  - 下班打卡时间
  - 工作时长
  - 备注信息

#### 视觉设计
- **状态标签**：
  - 正常：绿色标签
  - 迟到：橙色标签
  - 早退：黄色标签
  - 缺勤：红色标签

- **图标系统**：
  - 日历图标：显示日期
  - 上班打卡：绿色时钟图标
  - 下班打卡：蓝色时钟图标
  - 工作时长：蓝色计时器图标

#### 数据处理
- 自动初始化为当前月份
- 按日期倒序排序，最新记录在前
- 支持下拉刷新
- 只显示管理员管辖仓库的打卡记录

### 3. 路由配置更新

在 `src/app.config.ts` 中添加新页面路由：
```typescript
'pages/manager/attendance-records/index'
```

## 技术实现

### 数据库查询
- 使用 `getAllAttendanceRecords(year, month)` 获取指定月份的打卡记录
- 使用 `getManagerWarehouses(userId)` 获取管理员管辖的仓库
- 使用 `reviewLeaveApplication()` 和 `reviewResignationApplication()` 进行审批操作

### 状态管理
- 使用 React Hooks 管理组件状态
- 使用 useCallback 优化函数性能
- 使用 useDidShow 确保页面显示时数据最新

### 用户体验优化
- 加载时显示 Loading 提示
- 操作成功/失败显示 Toast 提示
- 支持下拉刷新
- 空状态友好提示

## 文件变更

### 新增文件
1. `/src/pages/manager/attendance-records/index.tsx` - 打卡记录页面
2. `/src/pages/manager/attendance-records/index.config.ts` - 页面配置

### 修改文件
1. `/src/pages/manager/leave-approval/index.tsx` - 请假审批管理页面
2. `/src/app.config.ts` - 路由配置

## 测试建议

### 请假审批管理测试
1. 测试快捷入口跳转到打卡记录页面
2. 测试状态筛选功能（待审批、已批准、已拒绝、全部）
3. 测试仓库筛选功能
4. 测试标签切换（待审批申请、司机统计）
5. 测试批准/拒绝请假申请
6. 测试批准/拒绝离职申请
7. 测试点击司机卡片跳转到详情页

### 打卡记录测试
1. 测试月份筛选（最近12个月）
2. 测试仓库筛选
3. 测试司机筛选
4. 测试打卡记录列表显示
5. 测试状态标签显示（正常、迟到、早退、缺勤）
6. 测试下拉刷新
7. 测试空状态显示

## 注意事项

1. **权限控制**：只显示管理员管辖仓库的数据
2. **数据准确性**：打卡状态基于数据库中的status字段（normal/late/early/absent）
3. **性能优化**：使用useCallback避免不必要的重新渲染
4. **用户体验**：所有异步操作都有加载提示和结果反馈

## 后续优化建议

1. 添加打卡记录导出功能（Excel）
2. 添加打卡异常统计报表
3. 支持批量审批请假申请
4. 添加审批历史记录查看
5. 支持审批时添加备注
6. 添加打卡记录详情页，显示打卡位置地图

## 相关文档

- 数据库表结构：`/supabase/migrations/05_create_attendance_table.sql`
- API函数：`/src/db/api.ts`
- 类型定义：`/src/db/types.ts`
