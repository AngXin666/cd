# 数据库中使用 SECURITY DEFINER 的函数列表

**日期**：2025-11-28  
**说明**：SECURITY DEFINER 函数会以函数所有者的权限执行，可以绕过 RLS 策略

---

## 📋 函数列表

### 1. 通知相关函数

#### 1.1 `create_notifications_batch(notifications jsonb)`
- **用途**：批量创建通知
- **原因**：需要绕过 RLS 策略，允许系统为其他用户创建通知
- **安全性**：✅ 安全 - 只有认证用户可以调用，且有适当的权限检查

#### 1.2 `add_notifications_to_schema(p_schema_name text)`
- **用途**：为指定 Schema 创建通知表和相关策略
- **原因**：需要管理员权限来创建表和策略
- **安全性**：✅ 安全 - 只用于初始化，不会被普通用户调用

---

### 2. 用户认证相关函数

#### 2.1 `current_user_id()`
- **用途**：获取当前用户 ID
- **原因**：需要访问 auth.uid()，显式指定 Schema 路径
- **安全性**：✅ 安全 - 只返回当前用户的 ID

#### 2.2 `uid()`
- **用途**：获取当前用户 ID（别名）
- **原因**：需要访问 auth.uid()
- **安全性**：✅ 安全 - 只返回当前用户的 ID

---

### 3. 权限检查函数

#### 3.1 `can_view_user(viewer_id uuid, target_user_id uuid)`
- **用途**：检查用户是否可以查看目标用户
- **原因**：需要查询 profiles 表，绕过 RLS 策略进行权限判断
- **安全性**：✅ 安全 - 有明确的权限逻辑

#### 3.2 `can_manage_user(manager_id uuid, target_user_id uuid)`
- **用途**：检查用户是否可以管理目标用户
- **原因**：需要查询 profiles 表，绕过 RLS 策略进行权限判断
- **安全性**：✅ 安全 - 有明确的权限逻辑

#### 3.3 `can_view_profile(viewer_id uuid, target_id uuid, target_boss_id text)`
- **用途**：检查用户是否可以查看目标用户的 profile
- **原因**：需要查询 profiles 表，绕过 RLS 策略进行权限判断
- **安全性**：✅ 安全 - 有明确的权限逻辑

#### 3.4 `is_admin(user_id uuid)`
- **用途**：检查用户是否为管理员
- **原因**：需要查询 profiles 表，绕过 RLS 策略
- **安全性**：✅ 安全 - 只返回布尔值

#### 3.5 `is_super_admin(user_id uuid)`
- **用途**：检查用户是否为超级管理员
- **原因**：需要查询 profiles 表，绕过 RLS 策略
- **安全性**：✅ 安全 - 只返回布尔值

#### 3.6 `is_lease_admin_user(user_id uuid)`
- **用途**：检查用户是否为租赁管理员
- **原因**：需要查询 profiles 表，绕过 RLS 策略
- **安全性**：✅ 安全 - 只返回布尔值

---

### 4. 用户管理函数

#### 4.1 `handle_new_user()`
- **用途**：触发器函数，处理新用户注册
- **原因**：需要在 auth.users 表更新时自动创建 profiles 记录
- **安全性**：✅ 安全 - 只在用户注册时自动执行

#### 4.2 `update_user_email(target_user_id uuid, new_email text)`
- **用途**：更新用户邮箱
- **原因**：需要修改 auth.users 表，普通用户无权限
- **安全性**：✅ 安全 - 只有超级管理员可以调用

#### 4.3 `auto_init_user_permissions()`
- **用途**：触发器函数，自动初始化用户权限
- **原因**：需要在用户创建时自动创建权限记录
- **安全性**：✅ 安全 - 只在用户创建时自动执行

---

### 5. 租户管理函数

#### 5.1 `create_tenant_schema(boss_id_str text)`
- **用途**：为新租户创建独立的 Schema
- **原因**：需要管理员权限来创建 Schema 和表
- **安全性**：✅ 安全 - 只在老板注册时调用

#### 5.2 `auto_create_tenant_schema_on_boss_creation()`
- **用途**：触发器函数，自动为新老板创建租户 Schema
- **原因**：需要在老板注册时自动创建 Schema
- **安全性**：✅ 安全 - 只在老板注册时自动执行

#### 5.3 `add_remaining_tables_to_schema(p_schema_name text)`
- **用途**：为指定 Schema 创建剩余的表
- **原因**：需要管理员权限来创建表
- **安全性**：✅ 安全 - 只用于初始化

#### 5.4 `get_user_role_and_boss(user_id uuid)`
- **用途**：获取用户的角色和 boss_id
- **原因**：需要查询 profiles 表，绕过 RLS 策略
- **安全性**：✅ 安全 - 只返回用户自己的信息

---

### 6. 审计日志函数

#### 6.1 `log_permission_change(...)`
- **用途**：记录权限变更日志
- **原因**：需要写入审计日志表，绕过 RLS 策略
- **安全性**：✅ 安全 - 只记录日志，不修改业务数据

#### 6.2 `audit_profile_create()`
- **用途**：触发器函数，记录用户创建日志
- **原因**：需要在用户创建时自动记录日志
- **安全性**：✅ 安全 - 只记录日志

#### 6.3 `audit_profile_role_change()`
- **用途**：触发器函数，记录角色变更日志
- **原因**：需要在角色变更时自动记录日志
- **安全性**：✅ 安全 - 只记录日志

#### 6.4 `audit_warehouse_assignment()`
- **用途**：触发器函数，记录仓库分配日志
- **原因**：需要在仓库分配时自动记录日志
- **安全性**：✅ 安全 - 只记录日志

#### 6.5 `audit_warehouse_unassignment()`
- **用途**：触发器函数，记录仓库取消分配日志
- **原因**：需要在仓库取消分配时自动记录日志
- **安全性**：✅ 安全 - 只记录日志

---

### 7. 统计和计算函数

#### 7.1 `update_late_days_count()`
- **用途**：触发器函数，更新迟到天数统计
- **原因**：需要在考勤记录变更时自动更新统计
- **安全性**：✅ 安全 - 只更新统计数据

#### 7.2 `calculate_feature_weight(access_count integer, last_access_at timestamptz)`
- **用途**：计算功能权重分数
- **原因**：需要访问系统配置，绕过 RLS 策略
- **安全性**：✅ 安全 - 只计算权重，不修改数据

#### 7.3 `update_user_feature_weight(p_user_id uuid, p_feature_module text)`
- **用途**：更新用户功能权重
- **原因**：需要写入权重表，绕过 RLS 策略
- **安全性**：✅ 安全 - 只更新权重数据

---

### 8. 测试函数

#### 8.1 `test_data_isolation()`
- **用途**：测试数据隔离
- **原因**：需要查询所有租户的数据进行测试
- **安全性**：⚠️ 注意 - 只用于测试，生产环境应禁用

#### 8.2 `test_driver_query_as_user(test_user_id uuid)`
- **用途**：测试司机查询权限
- **原因**：需要模拟不同用户查询数据
- **安全性**：⚠️ 注意 - 只用于测试，生产环境应禁用

---

## 🔒 安全性分析

### 安全的函数（✅）

大部分函数都是安全的，因为：

1. **权限检查函数**：只返回布尔值，不泄露敏感数据
2. **触发器函数**：只在特定事件自动执行，不能被普通用户直接调用
3. **审计日志函数**：只记录日志，不修改业务数据
4. **通知函数**：有适当的权限检查，只允许创建通知给有权限的用户

### 需要注意的函数（⚠️）

1. **测试函数**：
   - `test_data_isolation()`
   - `test_driver_query_as_user()`
   - 这些函数只用于测试，生产环境应该禁用或删除

---

## 📊 统计

- **总函数数量**：约 40 个
- **安全函数**：约 38 个（✅）
- **需要注意的函数**：2 个（⚠️）

---

## 🎯 建议

### 1. 保留的函数

以下函数应该保留，因为它们是系统正常运行所必需的：

- 所有权限检查函数（`can_view_user`, `is_admin` 等）
- 所有触发器函数（`handle_new_user`, `audit_*` 等）
- 通知相关函数（`create_notifications_batch`）
- 用户管理函数（`update_user_email`）
- 租户管理函数（`create_tenant_schema` 等）

### 2. 可以删除的函数

以下函数只用于测试，生产环境可以删除：

- `test_data_isolation()`
- `test_driver_query_as_user()`

### 3. 安全性建议

1. **定期审查**：定期审查所有 SECURITY DEFINER 函数，确保没有安全漏洞
2. **最小权限原则**：确保函数只执行必要的操作，不泄露敏感数据
3. **输入验证**：所有函数都应该验证输入参数，防止 SQL 注入
4. **日志记录**：关键操作应该记录审计日志

---

## ✅ 结论

系统中的 SECURITY DEFINER 函数大部分都是安全的，只有 2 个测试函数需要在生产环境中删除。其他函数都有明确的用途和适当的权限检查，不会造成安全风险。

---

**生成时间**：2025-11-28  
**状态**：✅ 已完成审查  
**下一步**：建议在生产环境中删除测试函数
