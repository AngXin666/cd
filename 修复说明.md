# 通知系统修复说明

## 问题描述

系统日志显示：
```
⚠️ 未找到主账号
⚠️ 未找到车队长信息
⚠️ 没有找到任何通知接收者，通知发送完成（无接收者）
```

## 根本原因

**查询逻辑错误**：通知服务查询的角色名称与数据库不匹配

- 代码查询：`'SUPER_ADMIN'`
- 数据库枚举：`'BOSS'`

系统实际的角色枚举值：`('BOSS', 'PEER_ADMIN', 'MANAGER', 'DRIVER')`

## 修复内容

修改了 `src/services/notificationService.ts` 中的三个函数：

1. **getPrimaryAdmin()**
   - 修改前：查询 `role = 'SUPER_ADMIN'`
   - 修改后：查询 `role = 'BOSS'`

2. **getPeerAccounts()**
   - 修改前：查询 `role = 'SUPER_ADMIN'`（跳过第一个）
   - 修改后：查询 `role = 'PEER_ADMIN'`

3. **_getAllAdmins()**
   - 修改前：查询 `role = 'SUPER_ADMIN'`
   - 修改后：查询 `role IN ('BOSS', 'PEER_ADMIN')`

## 验证方法

### 1. 检查数据库中的角色数据

运行 `验证角色数据.sql` 中的 SQL 语句，确认：
- 至少有一个用户的角色是 `BOSS`
- 如果需要车队长功能，至少有一个用户的角色是 `MANAGER`

### 2. 测试通知功能

1. 刷新页面
2. 司机提交请假申请
3. 查看控制台日志，应该看到：
   ```
   ✅ 找到主账号: { userId: 'xxx', name: 'xxx' }
   ✅ 找到有管辖权的车队长: { count: X }
   ✅ 通知发送成功
   ```

## 相关文件

- `src/services/notificationService.ts`：修复的代码文件
- `验证角色数据.sql`：验证数据库角色数据的 SQL 脚本
- `README.md`：更新日志

---

**修复日期**：2025-12-01  
**修复类型**：代码逻辑修复（无需数据库迁移）
