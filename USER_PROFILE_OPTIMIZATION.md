# 用户信息管理模块优化说明

## 优化概述

根据需求对司机个人信息页面进行了全面重构，实现了证件信息自动读取、字段编辑权限精确控制和系统信息展示。

## 主要变更

### 1. 证件信息读取优先级调整

**修改前：**
- 显示车辆行驶证信息（车主姓名、车牌号、VIN等）
- 从 `vehicles` 表读取数据

**修改后：**
- 显示用户自己的身份证和驾驶证信息
- 从 `driver_licenses` 表读取数据
- 优先展示个人证件信息，而非车辆信息

### 2. 可编辑字段精确控制

**严格限制用户可修改的字段：**

| 字段 | 是否可编辑 | 说明 |
|------|-----------|------|
| 姓名 | ❌ 否 | 从身份证自动读取 |
| 身份证号 | ❌ 否 | 从身份证自动读取 |
| 手机号 | ✅ 是 | 用户可自行修改 |
| 登录密码 | ✅ 是 | 用户可自行修改 |
| 用户角色 | ❌ 否 | 由系统分配 |
| 注册时间 | ❌ 否 | 系统记录 |

### 3. 新增系统信息显示

**新增只读信息：**
1. **用户角色**
   - 显示位置：基本信息卡片
   - 显示格式：司机/管理员/超级管理员
   - 标注说明：由系统分配

2. **账户注册时间**
   - 显示位置：基本信息卡片
   - 显示格式：YYYY-MM-DD
   - 标注说明：账户创建时间

## 详细功能说明

### 基本信息卡片

**显示内容：**
1. **姓名**（只读）
   - 数据来源：`driver_licenses.id_card_name`
   - 标注：来自身份证信息
   - 无法编辑

2. **手机号**（可编辑）
   - 数据来源：`profiles.phone`
   - 编辑方式：点击"修改"按钮
   - 验证规则：11位手机号格式
   - 保存后立即生效

3. **登录密码**（可修改）
   - 显示方式：••••••（隐藏）
   - 修改方式：点击"修改"按钮
   - 验证规则：
     - 至少6位字符
     - 两次输入必须一致
   - 使用 Supabase Auth API 更新

4. **用户角色**（只读）
   - 数据来源：`profiles.role`
   - 显示格式：中文翻译
   - 标注：由系统分配

5. **注册时间**（只读）
   - 数据来源：`profiles.created_at`
   - 显示格式：本地化日期
   - 标注：账户创建时间

### 身份证信息卡片

**显示内容：**
- 姓名
- 身份证号
- 出生日期
- 住址

**数据来源：**
- 表：`driver_licenses`
- 字段：`id_card_name`, `id_card_number`, `id_card_birth_date`, `id_card_address`

**特点：**
- 所有信息只读
- 标注"系统自动读取"
- 如果没有数据则不显示该卡片

### 驾驶证信息卡片

**显示内容：**
- 驾驶证号
- 准驾车型
- 初次领证日期
- 有效期至
- 发证机关

**数据来源：**
- 表：`driver_licenses`
- 字段：`license_number`, `license_class`, `valid_from`, `valid_to`, `issue_authority`

**特点：**
- 所有信息只读
- 标注"系统自动读取"
- 如果没有数据则不显示该卡片

### 证件照片卡片

**显示内容：**
- 身份证正面
- 身份证背面
- 驾驶证照片

**功能特性：**
- 点击图片可预览
- 支持多图片切换浏览
- 使用 Supabase Storage 存储
- 从 `{APP_ID}_driver_images` bucket 读取

## 技术实现

### 数据加载流程

```typescript
// 1. 加载个人资料
const profileData = await getCurrentUserProfile()
setProfile(profileData)

// 2. 加载驾驶证信息
const licenseData = await getDriverLicense(user.id)
setDriverLicense(licenseData)
```

### 手机号修改流程

```typescript
// 1. 验证手机号格式
const phoneRegex = /^1[3-9]\d{9}$/
if (!phoneRegex.test(editForm.phone)) {
  // 显示错误提示
  return
}

// 2. 调用API更新
await updateProfile(user.id, {phone: editForm.phone})

// 3. 重新加载数据
await loadProfile()
```

### 密码修改流程

```typescript
// 1. 验证密码
if (editForm.newPassword.length < 6) {
  // 密码至少6位
  return
}

if (editForm.newPassword !== editForm.confirmPassword) {
  // 两次密码不一致
  return
}

// 2. 使用 Supabase Auth API 更新
const {error} = await supabase.auth.updateUser({
  password: editForm.newPassword
})
```

### 图片加载

```typescript
// 获取图片公共URL
const getImageUrl = (path: string | null): string => {
  if (!path) return ''
  const {data} = supabase.storage
    .from(`${process.env.TARO_APP_APP_ID}_driver_images`)
    .getPublicUrl(path)
  return data.publicUrl
}

// 预览图片
const previewImage = (url: string, allUrls: string[]) => {
  Taro.previewImage({
    current: url,
    urls: allUrls
  })
}
```

## 用户界面设计

### 视觉层次

**颜色编码：**
- 🔵 蓝色：基本信息
- 🟢 绿色：身份证信息
- 🟠 橙色：驾驶证信息
- 🟣 紫色：证件照片

**图标使用：**
- `i-mdi-account-circle`：页面标题
- `i-mdi-account-details`：基本信息
- `i-mdi-card-account-details`：身份证信息
- `i-mdi-card-account-details-outline`：驾驶证信息
- `i-mdi-image-multiple`：证件照片

### 交互设计

**编辑模式：**
1. 默认显示模式：所有信息只读展示
2. 点击"修改"按钮：进入编辑模式
3. 编辑模式下：
   - 显示输入框
   - 显示"取消"和"保存"按钮
   - 取消：恢复原值
   - 保存：验证并提交

**反馈机制：**
- 加载中：显示"加载中..."
- 保存中：显示 Loading 提示
- 成功：显示成功 Toast
- 失败：显示错误 Toast

## 页面布局

```
┌─────────────────────────────────┐
│  页面标题                        │
│  - 个人信息                      │
│  - 返回按钮                      │
└─────────────────────────────────┘

┌─────────────────────────────────┐
│  基本信息                        │
│  - 姓名（只读，来自身份证）      │
│  - 手机号（可编辑）              │
│  - 登录密码（可修改）            │
│  - 用户角色（只读，系统分配）    │
│  - 注册时间（只读，系统记录）    │
└─────────────────────────────────┘

┌─────────────────────────────────┐
│  身份证信息（系统自动读取）      │
│  - 姓名                          │
│  - 身份证号                      │
│  - 出生日期                      │
│  - 住址                          │
└─────────────────────────────────┘

┌─────────────────────────────────┐
│  驾驶证信息（系统自动读取）      │
│  - 驾驶证号                      │
│  - 准驾车型                      │
│  - 初次领证日期                  │
│  - 有效期至                      │
│  - 发证机关                      │
└─────────────────────────────────┘

┌─────────────────────────────────┐
│  证件照片                        │
│  - 身份证正面                    │
│  - 身份证背面                    │
│  - 驾驶证照片                    │
└─────────────────────────────────┘

┌─────────────────────────────────┐
│  温馨提示                        │
│  - 只能修改手机号和密码          │
│  - 证件信息由系统自动读取        │
│  - 如需更新请联系管理员          │
└─────────────────────────────────┘
```

## 数据流程图

```
用户进入页面
    ↓
加载个人资料 (profiles)
    ↓
加载驾驶证信息 (driver_licenses)
    ↓
显示基本信息
    ├─ 姓名（从 driver_licenses 读取）
    ├─ 手机号（从 profiles 读取）
    ├─ 用户角色（从 profiles 读取）
    └─ 注册时间（从 profiles 读取）
    ↓
显示身份证信息（从 driver_licenses 读取）
    ↓
显示驾驶证信息（从 driver_licenses 读取）
    ↓
显示证件照片（从 Supabase Storage 读取）
```

## 权限控制

### 字段级权限

| 字段 | 查看 | 编辑 | 数据来源 |
|------|------|------|----------|
| 姓名 | ✅ | ❌ | driver_licenses |
| 身份证号 | ✅ | ❌ | driver_licenses |
| 出生日期 | ✅ | ❌ | driver_licenses |
| 住址 | ✅ | ❌ | driver_licenses |
| 手机号 | ✅ | ✅ | profiles |
| 密码 | ❌ | ✅ | auth.users |
| 用户角色 | ✅ | ❌ | profiles |
| 注册时间 | ✅ | ❌ | profiles |
| 驾驶证号 | ✅ | ❌ | driver_licenses |
| 准驾车型 | ✅ | ❌ | driver_licenses |
| 证件照片 | ✅ | ❌ | storage |

### 操作权限

**用户可以：**
- 查看自己的所有信息
- 修改自己的手机号
- 修改自己的登录密码

**用户不能：**
- 修改姓名、身份证号等证件信息
- 修改用户角色
- 修改注册时间
- 删除证件照片

**管理员权限：**
- 如需修改证件信息，需联系管理员
- 管理员可通过后台管理系统修改

## 错误处理

### 输入验证

1. **手机号验证**
   - 格式：11位数字
   - 正则：`/^1[3-9]\d{9}$/`
   - 错误提示："请输入正确的手机号"

2. **密码验证**
   - 长度：至少6位
   - 一致性：两次输入必须相同
   - 错误提示：
     - "密码至少6位"
     - "两次密码不一致"

### 异常处理

1. **数据加载失败**
   - 显示 Toast："加载失败"
   - 不影响页面其他功能

2. **保存失败**
   - 显示 Toast："保存失败"
   - 保持编辑状态，允许重试

3. **网络错误**
   - 自动重试机制
   - 显示友好错误提示

## 性能优化

### 数据加载

1. **并行加载**
   - 同时加载 profiles 和 driver_licenses
   - 减少等待时间

2. **按需显示**
   - 如果没有身份证信息，不显示身份证卡片
   - 如果没有驾驶证信息，不显示驾驶证卡片
   - 如果没有证件照片，不显示照片卡片

### 图片优化

1. **懒加载**
   - 图片按需加载
   - 使用 Taro Image 组件的优化特性

2. **预览优化**
   - 点击预览时才加载大图
   - 支持多图切换

### 状态管理

1. **useCallback**
   - 使用 useCallback 包装异步函数
   - 避免不必要的重新渲染

2. **useDidShow**
   - 页面显示时刷新数据
   - 确保数据最新

## 测试建议

### 功能测试

1. **数据显示测试**
   - 测试有完整证件信息的用户
   - 测试部分证件信息缺失的用户
   - 测试完全没有证件信息的用户

2. **编辑功能测试**
   - 测试手机号修改
   - 测试密码修改
   - 测试取消编辑
   - 测试输入验证

3. **图片功能测试**
   - 测试图片加载
   - 测试图片预览
   - 测试多图切换

### UI测试

1. **布局测试**
   - 测试不同屏幕尺寸
   - 测试横竖屏切换
   - 测试长内容显示

2. **交互测试**
   - 测试按钮点击
   - 测试输入框输入
   - 测试滚动效果

### 性能测试

1. **加载速度**
   - 测试首次加载时间
   - 测试刷新加载时间

2. **响应速度**
   - 测试编辑响应时间
   - 测试保存响应时间

## 注意事项

1. **数据依赖**
   - 姓名等信息依赖于 driver_licenses 表
   - 如果用户没有录入证件信息，相关字段显示"未填写"

2. **权限限制**
   - 用户只能修改手机号和密码
   - 其他信息需要联系管理员修改

3. **数据同步**
   - 修改手机号后立即生效
   - 修改密码后需要重新登录

4. **用户引导**
   - 在页面底部显示温馨提示
   - 说明哪些字段可以修改
   - 提示如何更新证件信息

## 后续优化建议

1. **增加邮箱验证**
   - 如果需要邮箱功能，可以添加邮箱修改

2. **增加头像上传**
   - 允许用户上传个人头像

3. **增加修改历史**
   - 记录用户修改手机号的历史

4. **增加安全验证**
   - 修改手机号时发送验证码
   - 修改密码时需要输入旧密码

5. **增加数据导出**
   - 允许用户导出个人信息
   - 符合数据隐私保护要求
