# 测试账号功能说明

## 功能位置

测试账号快速登录功能已移至**登录首页**（`/pages/login/index`），不再放在中央管理系统中。

## 功能特点

### 1. 可折叠设计

- **默认状态**：收起，不占用太多空间
- **展开方式**：点击"🧪 开发测试 - 快速登录"标题栏
- **收起方式**：再次点击标题栏

### 2. 自动加载

- 首次展开时自动从数据库加载测试账号列表
- 显示前 20 个账号（按创建时间排序）
- 包含账号的角色、姓名、手机号等信息

### 3. 一键登录

- **点击账号卡片**：直接使用该账号登录（默认密码：123456）
- **自动跳转**：登录成功后根据角色自动跳转到对应页面
  - 司机 → 司机工作台
  - 车队长 → 管理员工作台
  - 老板 → 超级管理员工作台

### 4. 角色标识

每个账号卡片都有清晰的角色标识：

| 角色 | 颜色 | 说明 |
|------|------|------|
| 老板 | 红色 | super_admin |
| 车队长 | 蓝色 | manager |
| 平级账号 | 紫色 | peer_admin |
| 租赁管理员 | 绿色 | lease_admin |
| 司机 | 灰色 | driver |

## 使用场景

### 开发环境

1. **快速切换角色**：
   - 测试不同角色的功能
   - 验证权限控制
   - 调试角色相关的 UI

2. **节省时间**：
   - 不需要手动输入账号密码
   - 一键登录，快速进入测试

3. **方便调试**：
   - 可以快速查看所有测试账号
   - 清晰的角色标识便于选择

### 生产环境

⚠️ **重要提示**：此功能仅用于开发测试，生产环境应该删除！

## 删除方法

### 方法1：删除整个功能区域（推荐）

在 `src/pages/login/index.tsx` 中，删除以下代码块：

```tsx
{/* 测试账号快速登录（开发测试用） */}
<View className="mt-8">
  <View className="bg-white bg-opacity-10 rounded-lg p-4">
    {/* ... 整个测试账号区域 ... */}
  </View>
</View>
```

**位置**：大约在第 483-537 行

### 方法2：使用环境变量控制

添加环境变量判断，只在开发环境显示：

```tsx
{process.env.NODE_ENV === 'development' && (
  <View className="mt-8">
    {/* 测试账号快速登录 */}
  </View>
)}
```

### 方法3：注释掉

如果不确定是否需要删除，可以先注释掉：

```tsx
{/* 
{/* 测试账号快速登录（开发测试用） *\/}
<View className="mt-8">
  ...
</View>
*/}
```

## 与中央管理系统的关系

### 之前的问题

- 测试账号功能放在中央管理系统的租户列表页面
- 点击测试账号登录会覆盖超级管理员的 session
- 导致创建租户时提示"登录状态已过期"

### 现在的解决方案

1. **功能位置改变**：
   - 从中央管理系统移到登录首页
   - 中央管理系统不再有测试账号入口

2. **登录流程分离**：
   - 测试账号登录 → 跳转到对应角色页面
   - 中央管理员登录 → 跳转到工作台首页 → 自动跳转到中央管理系统

3. **Session 管理**：
   - 测试账号登录会设置 `loginSourcePage` 标记
   - 中央管理系统页面有路由守卫，会验证 session
   - 如果 session 无效，自动跳转到登录页面

## 技术实现

### 状态管理

```typescript
const [showTestAccounts, setShowTestAccounts] = useState(false)  // 是否展开
const [testAccounts, setTestAccounts] = useState<TestAccount[]>([])  // 账号列表
const [testLoading, setTestLoading] = useState(false)  // 登录中状态
```

### 加载账号列表

```typescript
const loadTestAccounts = useCallback(async () => {
  const {data, error} = await supabase
    .from('profiles')
    .select('id, name, phone, email, role')
    .order('created_at', {ascending: true})
    .limit(20)
  
  // 处理数据...
}, [getRoleName])
```

### 快速登录

```typescript
const handleTestLogin = async (testAccount: TestAccount) => {
  // 使用手机号和默认密码登录
  const {data, error} = await supabase.auth.signInWithPassword({
    phone: testAccount.phone,
    password: '123456'
  })
  
  // 设置登录来源标记
  Taro.setStorageSync('loginSourcePage', '/pages/login/index')
  
  // 根据角色跳转
  if (testAccount.role === 'driver') {
    Taro.switchTab({url: '/pages/driver/index'})
  } else if (testAccount.role === 'manager') {
    Taro.switchTab({url: '/pages/manager/index'})
  } else if (testAccount.role === 'super_admin') {
    Taro.switchTab({url: '/pages/super-admin/index'})
  }
}
```

## 注意事项

### 1. 默认密码

所有测试账号的默认密码都是 `123456`，如果某个账号的密码不是这个，快速登录会失败。

### 2. 数据库依赖

测试账号列表从 `profiles` 表读取，需要确保：
- 数据库连接正常
- `profiles` 表存在且有数据
- 当前用户有读取权限

### 3. 角色跳转

快速登录后会根据角色自动跳转，需要确保：
- 对应的页面路由已配置
- 页面文件存在
- TabBar 配置正确

### 4. Session 覆盖

使用测试账号登录会覆盖当前的 session，如果你正在使用中央管理员账号，登录测试账号后需要重新登录中央管理员账号。

## 常见问题

### Q1：为什么要移到登录首页？

**A**：之前放在中央管理系统的租户列表页面，会影响中央管理员的登录状态。移到登录首页后：
- 功能更独立
- 不影响中央管理系统
- 更符合使用场景（登录前选择测试账号）

### Q2：生产环境如何处理？

**A**：生产环境应该删除此功能，有三种方法：
1. 直接删除代码（推荐）
2. 使用环境变量控制显示
3. 注释掉代码

### Q3：如何添加新的测试账号？

**A**：测试账号列表是从数据库动态加载的，只需要：
1. 在数据库中创建新账号
2. 设置密码为 `123456`
3. 刷新登录页面，展开测试账号列表即可看到

### Q4：可以修改默认密码吗？

**A**：可以，在 `handleTestLogin` 函数中修改：

```typescript
const {data, error} = await supabase.auth.signInWithPassword({
  phone: testAccount.phone,
  password: '你的新密码'  // 修改这里
})
```

但是需要确保所有测试账号都使用相同的密码。

### Q5：为什么有些账号登录失败？

**A**：可能的原因：
1. 账号密码不是 `123456`
2. 账号被禁用或删除
3. 手机号格式不正确
4. 网络连接问题

可以查看浏览器控制台的错误信息进行排查。

## 总结

测试账号快速登录功能现在已经移到登录首页，具有以下优势：

1. ✅ **位置合理**：在登录页面，符合使用场景
2. ✅ **不影响中央系统**：避免 session 冲突
3. ✅ **易于删除**：生产环境可以直接删除
4. ✅ **使用方便**：一键登录，快速测试
5. ✅ **清晰标识**：角色颜色标识，易于区分

建议在生产环境部署前删除此功能，或使用环境变量控制显示。
