# RLS 权限矩阵设计文档

生成时间: 2025-11-26

---

## 📋 角色权限定义

### 1. 租赁管理员 (lease_admin)

**管辖范围**: 
- ✅ 老板账号 (super_admin)
- ✅ 平级账号 (其他 lease_admin)
- ❌ 车队长 (manager) - 无权管辖
- ❌ 司机 (driver) - 无权管辖

**权限**:
- ✅ 查看：老板、平级账号
- ✅ 增加：老板、平级账号
- ✅ 修改：老板、平级账号
- ✅ 停用/删除：老板、平级账号

---

### 2. 老板账号 (super_admin)

**管辖范围**:
- ✅ 车队长 (manager)
- ✅ 司机 (driver)
- ✅ 平级账号 (其他 super_admin) - 仅限修改和停用
- ❌ 租赁管理员 (lease_admin) - 无权管辖

**权限**:
- ✅ 查看：车队长、司机、平级账号
- ✅ 增加：车队长、司机
- ✅ 修改：车队长、司机、平级账号
- ✅ 停用/删除：车队长、司机、平级账号
- ❌ 增加：平级账号（不能创建新的老板账号）

---

### 3. 平级账号 (super_admin，但受老板管辖)

**说明**: 平级账号本质上也是 super_admin 角色，但是由某个老板账号创建的。

**管辖范围**:
- ✅ 车队长 (manager)
- ✅ 司机 (driver)
- ❌ 其他平级账号 - 无权管辖
- ❌ 租赁管理员 (lease_admin) - 无权管辖

**权限**:
- ✅ 查看：车队长、司机
- ✅ 增加：车队长、司机
- ✅ 修改：车队长、司机
- ✅ 停用/删除：车队长、司机

**区别于老板账号**:
- 平级账号不能管理其他平级账号
- 平级账号受创建它的老板账号管辖

---

### 4. 车队长 (manager)

**管辖范围**:
- ✅ 自己管辖的仓库内的司机
- ❌ 其他仓库的司机 - 无权管辖

**权限（权限被允许时）**:
- ✅ 查看：自己仓库的司机
- ✅ 增加：自己仓库的司机
- ✅ 修改：自己仓库的司机
- ✅ 停用/删除：自己仓库的司机

**权限（权限被禁止时）**:
- ✅ 查看：自己仓库的司机
- ❌ 增加：禁止
- ❌ 修改：禁止
- ❌ 停用/删除：禁止

**权限控制字段**: 需要在 profiles 表中添加一个字段来控制车队长的权限是否被禁止。

---

### 5. 司机 (driver)

**管辖范围**:
- ✅ 自己的账号

**权限**:
- ✅ 查看：自己的账号
- ✅ 修改：自己的账号
- ❌ 增加：禁止
- ❌ 停用/删除：禁止

---

## 🔐 数据表权限矩阵

### profiles 表

| 角色 | 查看 | 增加 | 修改 | 删除 |
|-----|------|------|------|------|
| 租赁管理员 | 老板、平级 | 老板、平级 | 老板、平级 | 老板、平级 |
| 老板账号 | 车队长、司机、平级 | 车队长、司机 | 车队长、司机、平级 | 车队长、司机、平级 |
| 平级账号 | 车队长、司机 | 车队长、司机 | 车队长、司机 | 车队长、司机 |
| 车队长（权限开启） | 仓库司机 | 仓库司机 | 仓库司机 | 仓库司机 |
| 车队长（权限禁止） | 仓库司机 | ❌ | ❌ | ❌ |
| 司机 | 自己 | ❌ | 自己 | ❌ |

---

### attendance（考勤记录）表

| 角色 | 查看 | 增加 | 修改 | 删除 |
|-----|------|------|------|------|
| 租赁管理员 | 所有 | 所有 | 所有 | 所有 |
| 老板账号 | 租户内所有 | 租户内所有 | 租户内所有 | 租户内所有 |
| 平级账号 | 租户内所有 | 租户内所有 | 租户内所有 | 租户内所有 |
| 车队长（权限开启） | 仓库司机 | 仓库司机 | 仓库司机 | 仓库司机 |
| 车队长（权限禁止） | 仓库司机 | ❌ | ❌ | ❌ |
| 司机 | 自己 | ❌ | ❌ | ❌ |

---

### piece_work_records（计件记录）表

| 角色 | 查看 | 增加 | 修改 | 删除 |
|-----|------|------|------|------|
| 租赁管理员 | 所有 | 所有 | 所有 | 所有 |
| 老板账号 | 租户内所有 | 租户内所有 | 租户内所有 | 租户内所有 |
| 平级账号 | 租户内所有 | 租户内所有 | 租户内所有 | 租户内所有 |
| 车队长（权限开启） | 仓库司机 | 仓库司机 | 仓库司机 | 仓库司机 |
| 车队长（权限禁止） | 仓库司机 | ❌ | ❌ | ❌ |
| 司机 | 自己 | ❌ | ❌ | ❌ |

---

### leave_applications（请假申请）表

| 角色 | 查看 | 增加 | 修改 | 删除 |
|-----|------|------|------|------|
| 租赁管理员 | 所有 | 所有 | 所有 | 所有 |
| 老板账号 | 租户内所有 | 租户内所有 | 租户内所有 | 租户内所有 |
| 平级账号 | 租户内所有 | 租户内所有 | 租户内所有 | 租户内所有 |
| 车队长（权限开启） | 仓库司机 | 仓库司机 | 仓库司机 | 仓库司机 |
| 车队长（权限禁止） | 仓库司机 | ❌ | ❌ | ❌ |
| 司机 | 自己 | 自己 | 自己 | 自己 |

---

### resignation_applications（离职申请）表

| 角色 | 查看 | 增加 | 修改 | 删除 |
|-----|------|------|------|------|
| 租赁管理员 | 所有 | 所有 | 所有 | 所有 |
| 老板账号 | 租户内所有 | 租户内所有 | 租户内所有 | 租户内所有 |
| 平级账号 | 租户内所有 | 租户内所有 | 租户内所有 | 租户内所有 |
| 车队长（权限开启） | 仓库司机 | 仓库司机 | 仓库司机 | 仓库司机 |
| 车队长（权限禁止） | 仓库司机 | ❌ | ❌ | ❌ |
| 司机 | 自己 | 自己 | 自己 | 自己 |

---

### driver_licenses（司机驾照）表

| 角色 | 查看 | 增加 | 修改 | 删除 |
|-----|------|------|------|------|
| 租赁管理员 | 所有 | 所有 | 所有 | 所有 |
| 老板账号 | 租户内所有 | 租户内所有 | 租户内所有 | 租户内所有 |
| 平级账号 | 租户内所有 | 租户内所有 | 租户内所有 | 租户内所有 |
| 车队长（权限开启） | 仓库司机 | 仓库司机 | 仓库司机 | 仓库司机 |
| 车队长（权限禁止） | 仓库司机 | ❌ | ❌ | ❌ |
| 司机 | 自己 | ❌ | 自己 | ❌ |

---

### notifications（通知）表

| 角色 | 查看 | 增加 | 修改 | 删除 |
|-----|------|------|------|------|
| 租赁管理员 | 所有 | 所有 | 所有 | 所有 |
| 老板账号 | 自己的 | 租户内所有 | 自己的 | 自己的 |
| 平级账号 | 自己的 | 租户内所有 | 自己的 | 自己的 |
| 车队长 | 自己的 | 仓库司机 | 自己的 | 自己的 |
| 司机 | 自己的 | ❌ | 自己的 | 自己的 |

---

## 🔧 实现细节

### 1. 车队长权限控制

需要在 profiles 表中添加一个字段来控制车队长的权限：

```sql
ALTER TABLE profiles 
ADD COLUMN manager_permissions_enabled boolean DEFAULT true;

COMMENT ON COLUMN profiles.manager_permissions_enabled IS '车队长权限是否启用（true=可以增删改，false=只能查看）';
```

### 2. 平级账号识别

平级账号和老板账号都是 super_admin 角色，需要通过 `main_account_id` 字段来区分：
- 老板账号：`main_account_id IS NULL`
- 平级账号：`main_account_id IS NOT NULL`（指向创建它的老板账号）

### 3. 辅助函数

需要创建以下辅助函数：

```sql
-- 检查是否为老板账号（不是平级账号）
CREATE OR REPLACE FUNCTION is_main_boss(user_id uuid)
RETURNS boolean AS $$
  SELECT EXISTS (
    SELECT 1 FROM profiles
    WHERE id = user_id
    AND role = 'super_admin'
    AND main_account_id IS NULL
  );
$$ LANGUAGE sql SECURITY DEFINER STABLE;

-- 检查是否为平级账号
CREATE OR REPLACE FUNCTION is_peer_admin(user_id uuid)
RETURNS boolean AS $$
  SELECT EXISTS (
    SELECT 1 FROM profiles
    WHERE id = user_id
    AND role = 'super_admin'
    AND main_account_id IS NOT NULL
  );
$$ LANGUAGE sql SECURITY DEFINER STABLE;

-- 检查车队长权限是否启用
CREATE OR REPLACE FUNCTION is_manager_permissions_enabled(user_id uuid)
RETURNS boolean AS $$
  SELECT COALESCE(
    (SELECT manager_permissions_enabled FROM profiles WHERE id = user_id),
    false
  );
$$ LANGUAGE sql SECURITY DEFINER STABLE;
```

---

## 📝 关键设计决策

### 1. 租赁管理员不管辖车队长和司机

**原因**: 租赁管理员是系统级别的管理员，主要负责管理租户（老板账号），不直接管理租户内部的员工。

**实现**: 租赁管理员的 RLS 策略只允许访问 `role IN ('lease_admin', 'super_admin')` 的用户。

---

### 2. 老板账号可以管理平级账号

**原因**: 老板账号需要能够停用或修改平级账号，但不能创建新的平级账号（避免权限滥用）。

**实现**: 
- SELECT: 允许查看平级账号
- UPDATE: 允许修改平级账号
- DELETE: 允许删除平级账号
- INSERT: 不允许创建平级账号（通过 WITH CHECK 限制）

---

### 3. 车队长权限可以被禁止

**原因**: 老板账号可能需要临时限制某个车队长的权限，但不想删除该账号。

**实现**: 使用 `manager_permissions_enabled` 字段控制，当为 false 时，车队长只能查看数据，不能增删改。

---

### 4. 司机可以提交请假和离职申请

**原因**: 司机需要能够主动提交请假和离职申请。

**实现**: 在 leave_applications 和 resignation_applications 表中，允许司机 INSERT 和 UPDATE 自己的记录。

---

**文档版本**: 1.0
**最后更新**: 2025-11-26
