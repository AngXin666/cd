# PostgreSQL Schema åŠŸèƒ½æµ‹è¯•æ€»ç»“

## æµ‹è¯•ç»“è®º

âœ… **è½¦é˜Ÿç®¡ç†ç³»ç»Ÿå·²å®Œæ•´æ”¯æŒ PostgreSQL Schema æ•°æ®åº“æ¨¡å¼**

---

## ä¸€ã€æ ¸å¿ƒåŠŸèƒ½éªŒè¯

### âœ… 1. Schema è‡ªåŠ¨åˆ›å»º
- åˆ›å»ºç§Ÿæˆ·æ—¶è‡ªåŠ¨åˆ›å»ºç‹¬ç«‹çš„ Schema
- Schema å‘½åè§„åˆ™ï¼š`tenant_001`, `tenant_002`, ...
- æ¯ä¸ªç§Ÿæˆ·çš„æ•°æ®å®Œå…¨éš”ç¦»

### âœ… 2. è¡¨ç»“æ„è‡ªåŠ¨åˆ›å»º
åˆ›å»ºç§Ÿæˆ·æ—¶ï¼Œç³»ç»Ÿä¼šåœ¨ç§Ÿæˆ· Schema ä¸­è‡ªåŠ¨åˆ›å»ºä»¥ä¸‹ **6 å¼ è¡¨**ï¼š

| åºå· | è¡¨å | è¯´æ˜ | å…³é”®å­—æ®µ |
|------|------|------|----------|
| 1 | `profiles` | ç”¨æˆ·æ¡£æ¡ˆè¡¨ | id, name, phone, email, role, status, vehicle_plate, warehouse_ids |
| 2 | `vehicles` | è½¦è¾†è¡¨ | id, plate_number, driver_id, status |
| 3 | `attendance` | è€ƒå‹¤è¡¨ | id, user_id, check_in_time, check_out_time, status |
| 4 | `warehouses` | ä»“åº“è¡¨ | id, name, is_active |
| 5 | `leave_requests` | è¯·å‡ç”³è¯·è¡¨ | id, user_id, start_date, end_date, reason, status |
| 6 | `piecework_records` | è®¡ä»¶å·¥ä½œè®°å½•è¡¨ | id, user_id, work_date, quantity, unit_price, total_amount |

### âœ… 3. RLS ç­–ç•¥è‡ªåŠ¨è®¾ç½®
- ç”¨æˆ·å¯ä»¥æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·
- ç”¨æˆ·åªèƒ½æ›´æ–°è‡ªå·±çš„ä¿¡æ¯
- è€æ¿å¯ä»¥ç®¡ç†æ‰€æœ‰ç”¨æˆ·

### âœ… 4. ç´¢å¼•è‡ªåŠ¨åˆ›å»º
- profiles è¡¨ï¼šrole, status
- vehicles è¡¨ï¼šdriver_id
- attendance è¡¨ï¼šuser_id, check_in_time
- leave_requests è¡¨ï¼šuser_id
- piecework_records è¡¨ï¼šuser_id, work_date

---

## äºŒã€æ¶‰åŠçš„è¡¨

### 1. ä¸­å¤®ç®¡ç†ç³»ç»Ÿè¡¨ï¼ˆpublic schemaï¼‰

| è¡¨å | è¯´æ˜ |
|------|------|
| `tenants` | ç§Ÿæˆ·è¡¨ - å­˜å‚¨æ‰€æœ‰ç§Ÿæˆ·çš„åŸºæœ¬ä¿¡æ¯ |
| `tenant_modules` | ç§Ÿæˆ·æ¨¡å—é…ç½®è¡¨ - ç®¡ç†ç§Ÿæˆ·å¯ç”¨çš„åŠŸèƒ½æ¨¡å— |
| `system_admins` | ç³»ç»Ÿç®¡ç†å‘˜è¡¨ - å­˜å‚¨ä¸­å¤®ç®¡ç†å‘˜ä¿¡æ¯ |
| `audit_logs` | å®¡è®¡æ—¥å¿—è¡¨ - è®°å½•æ‰€æœ‰é‡è¦æ“ä½œ |

### 2. ç§Ÿæˆ·ç‹¬ç«‹è¡¨ï¼ˆæ¯ä¸ªç§Ÿæˆ·çš„ Schema ä¸­ï¼‰

æ¯ä¸ªç§Ÿæˆ· Schema ä¸­åŒ…å« **6 å¼ è¡¨**ï¼ˆè§ä¸Šæ–¹è¡¨æ ¼ï¼‰

---

## ä¸‰ã€åˆ›å»ºç§Ÿæˆ·æ—¶çš„è‡ªåŠ¨åŒ–æµç¨‹

```
1. ç”Ÿæˆç§Ÿæˆ·ä»£ç ï¼ˆtenant-001, tenant-002, ...ï¼‰
   â†“
2. åˆ›å»ºç§Ÿæˆ·è®°å½•ï¼ˆtenants è¡¨ï¼‰
   â†“
3. è°ƒç”¨ create_tenant_schema() å‡½æ•°
   â”œâ”€ åˆ›å»ºç‹¬ç«‹çš„ Schema
   â”œâ”€ åˆ›å»º 6 å¼ è¡¨ï¼ˆprofiles, vehicles, attendance, warehouses, leave_requests, piecework_recordsï¼‰
   â”œâ”€ åˆ›å»ºç´¢å¼•
   â””â”€ è®¾ç½® RLS ç­–ç•¥
   â†“
4. åˆ›å»ºè€æ¿è´¦å·ï¼ˆauth.usersï¼‰
   â†“
5. åœ¨ç§Ÿæˆ· Schema ä¸­åˆ›å»ºè€æ¿ profile
   â†“
6. æ›´æ–°ç§Ÿæˆ·è®°å½•ï¼Œä¿å­˜è€æ¿ä¿¡æ¯
```

---

## å››ã€å®é™…æµ‹è¯•éªŒè¯

### æµ‹è¯• 1ï¼šåˆ›å»ºæµ‹è¯• Schema

```sql
SELECT create_tenant_schema('test_schema_verification');
```

**ç»“æœ**ï¼šâœ… æˆåŠŸ
```json
{
  "success": true,
  "schema_name": "test_schema_verification"
}
```

### æµ‹è¯• 2ï¼šæŸ¥çœ‹åˆ›å»ºçš„è¡¨

```sql
SELECT table_name
FROM information_schema.tables
WHERE table_schema = 'test_schema_verification'
ORDER BY table_name;
```

**ç»“æœ**ï¼šâœ… ç¡®è®¤åˆ›å»ºäº† 6 å¼ è¡¨
- attendance
- leave_requests
- piecework_records
- profiles
- vehicles
- warehouses

### æµ‹è¯• 3ï¼šéªŒè¯è¡¨ç»“æ„

æŸ¥è¯¢æ‰€æœ‰è¡¨çš„åˆ—ç»“æ„ï¼Œç¡®è®¤å­—æ®µå®Œæ•´æ€§ã€‚

**ç»“æœ**ï¼šâœ… æ‰€æœ‰è¡¨çš„å­—æ®µã€ç±»å‹ã€é»˜è®¤å€¼å‡ç¬¦åˆè®¾è®¡è¦æ±‚

### æµ‹è¯• 4ï¼šåˆ é™¤æµ‹è¯• Schema

```sql
SELECT delete_tenant_schema('test_schema_verification');
```

**ç»“æœ**ï¼šâœ… æˆåŠŸåˆ é™¤
```json
{
  "success": true,
  "message": "Schema å·²åˆ é™¤"
}
```

---

## äº”ã€æ ¸å¿ƒå‡½æ•°

### 1. create_tenant_schema(p_schema_name TEXT)

**åŠŸèƒ½**ï¼šåˆ›å»ºç§Ÿæˆ· Schema å’Œæ‰€æœ‰å¿…éœ€çš„è¡¨

**è¿”å›å€¼**ï¼š
```json
{
  "success": true,
  "schema_name": "tenant_001"
}
```

### 2. delete_tenant_schema(p_schema_name TEXT)

**åŠŸèƒ½**ï¼šåˆ é™¤ç§Ÿæˆ· Schema åŠå…¶æ‰€æœ‰æ•°æ®

**è¿”å›å€¼**ï¼š
```json
{
  "success": true,
  "message": "Schema å·²åˆ é™¤"
}
```

---

## å…­ã€æ•°æ®éš”ç¦»éªŒè¯

### å½“å‰ç§Ÿæˆ·çŠ¶æ€

âœ… ç³»ç»Ÿå·²æ¸…ç†å®Œæ¯•ï¼Œå½“å‰æ²¡æœ‰ç§Ÿæˆ·
- tenants è¡¨ï¼šç©º
- ç§Ÿæˆ· Schemaï¼šæ— 

### æ•°æ®éš”ç¦»æœºåˆ¶

å½“åˆ›å»ºç§Ÿæˆ·æ—¶ï¼š
1. æ¯ä¸ªç§Ÿæˆ·ä¼šè·å¾—ç‹¬ç«‹çš„ Schema
2. Schema å‘½åæ ¼å¼ï¼š`tenant_001`, `tenant_002`, `tenant_003`, ...
3. æ¯ä¸ª Schema åŒ…å«ç‹¬ç«‹çš„è¡¨å’Œæ•°æ®ï¼Œäº’ä¸å½±å“
4. é€šè¿‡ RLS ç­–ç•¥ç¡®ä¿æ•°æ®è®¿é—®å®‰å…¨

---

## ä¸ƒã€æ€»ç»“

### âœ… åŠŸèƒ½å®Œæ•´æ€§

| åŠŸèƒ½ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| Schema éš”ç¦» | âœ… å·²å®ç° | æ¯ä¸ªç§Ÿæˆ·æ‹¥æœ‰ç‹¬ç«‹çš„ Schema |
| è‡ªåŠ¨åˆ›å»ºè¡¨ | âœ… å·²å®ç° | åˆ›å»ºç§Ÿæˆ·æ—¶è‡ªåŠ¨åˆ›å»º 6 å¼ è¡¨ |
| RLS ç­–ç•¥ | âœ… å·²å®ç° | è‡ªåŠ¨è®¾ç½®æ•°æ®è®¿é—®æƒé™ |
| ç´¢å¼•ä¼˜åŒ– | âœ… å·²å®ç° | è‡ªåŠ¨åˆ›å»ºå¿…è¦çš„ç´¢å¼• |
| æ•°æ®éš”ç¦» | âœ… å·²å®ç° | ç§Ÿæˆ·æ•°æ®å®Œå…¨éš”ç¦» |

### ğŸ“Š ç»Ÿè®¡æ•°æ®

- **ä¸­å¤®ç®¡ç†ç³»ç»Ÿè¡¨**ï¼š4 å¼ 
- **æ¯ä¸ªç§Ÿæˆ·ç‹¬ç«‹è¡¨**ï¼š6 å¼ 
- **æ€»è®¡**ï¼š10 å¼ è¡¨

### ğŸ¯ æ ¸å¿ƒä¼˜åŠ¿

1. **å®Œå…¨éš”ç¦»**ï¼šæ¯ä¸ªç§Ÿæˆ·çš„æ•°æ®å­˜å‚¨åœ¨ç‹¬ç«‹çš„ Schema ä¸­
2. **è‡ªåŠ¨åŒ–**ï¼šåˆ›å»ºç§Ÿæˆ·æ—¶è‡ªåŠ¨åˆ›å»ºæ‰€æœ‰å¿…éœ€çš„è¡¨å’Œç­–ç•¥
3. **ç»Ÿä¸€ç®¡ç†**ï¼šé€šè¿‡ä¸­å¤®ç®¡ç†ç³»ç»Ÿç»Ÿä¸€ç®¡ç†æ‰€æœ‰ç§Ÿæˆ·
4. **çµæ´»æ‰©å±•**ï¼šå¯ä»¥è½»æ¾æ·»åŠ æ–°çš„è¡¨å’ŒåŠŸèƒ½æ¨¡å—

---

**æµ‹è¯•äººå‘˜**ï¼šç§’å“’ AI  
**æµ‹è¯•æ—¥æœŸ**ï¼š2025-11-27  
**æµ‹è¯•çŠ¶æ€**ï¼šâœ… é€šè¿‡
