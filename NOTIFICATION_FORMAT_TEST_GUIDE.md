# 通知格式优化 - 快速测试指南

## 🎯 测试目标

验证通知消息中不再显示重复的角色名称，例如：
- ❌ 旧版本：`超级管理员 管理员 修改了...`
- ✅ 新版本：`超级管理员修改了...` 或 `超级管理员【张三】修改了...`

## 📋 测试场景

### 场景1：用户名是"管理员"（最常见的问题场景）

**测试步骤**：
1. 使用超级管理员账号登录（用户名是"管理员"，没有上传驾驶证）
2. 进入"用户管理"页面
3. 选择一个司机，点击"仓库分配"
4. 勾选一个仓库，点击"保存"
5. 使用普通管理员账号登录
6. 进入"通知中心"

**预期结果**：
```
仓库分配操作通知
超级管理员修改了司机 邱吉兴 的仓库分配，涉及仓库：上海仓库、北京仓库
```

**不应该显示**：
```
超级管理员 管理员 修改了...  ❌
超级管理员【管理员】修改了...  ❌
```

### 场景2：用户名是"admin"

**测试步骤**：
1. 创建一个超级管理员账号，用户名设置为"admin"
2. 不上传驾驶证
3. 使用该账号登录
4. 进入"用户管理"页面
5. 选择一个司机，点击"切换成带车司机"
6. 使用普通管理员账号登录
7. 进入"通知中心"

**预期结果**：
```
司机类型变更操作通知
超级管理员【admin】修改了司机类型：李四，从【纯司机】变更为【带车司机】
```

### 场景3：有真实姓名

**测试步骤**：
1. 使用超级管理员账号登录
2. 上传驾驶证（id_card_name 为"张三"）
3. 进入"用户管理"页面
4. 选择一个司机，点击"仓库分配"
5. 勾选一个仓库，点击"保存"
6. 使用普通管理员账号登录
7. 进入"通知中心"

**预期结果**：
```
仓库分配操作通知
超级管理员【张三】修改了司机 邱吉兴 的仓库分配，涉及仓库：上海仓库、北京仓库
```

### 场景4：普通管理员操作

**测试步骤**：
1. 使用普通管理员账号登录（用户名是"管理员"，没有上传驾驶证）
2. 进入"司机管理"页面
3. 选择一个司机，点击"切换成带车司机"
4. 使用超级管理员账号登录
5. 进入"通知中心"

**预期结果**：
```
司机类型变更操作通知
管理员修改了司机类型：李四，从【纯司机】变更为【带车司机】
```

**不应该显示**：
```
管理员 管理员 修改了...  ❌
管理员【管理员】修改了...  ❌
```

## 🔍 调试方法

### 1. 查看控制台日志

打开浏览器控制台（F12），执行操作后查看日志：

**搜索关键词**：`操作人显示文本`

**预期日志**：
```javascript
👤 [仓库分配] 操作人显示文本: 超级管理员
// 或
👤 [仓库分配] 操作人显示文本: 超级管理员【张三】
// 或
👤 [仓库分配] 操作人显示文本: 超级管理员【admin】
```

### 2. 查询数据库

**查询用户信息**：
```sql
SELECT 
  p.id,
  p.name,
  p.role,
  dl.id_card_name as real_name
FROM profiles p
LEFT JOIN driver_licenses dl ON p.id = dl.driver_id
WHERE p.role IN ('super_admin', 'manager')
ORDER BY p.created_at DESC;
```

**查询最近的通知**：
```sql
SELECT 
  n.id,
  n.message,
  n.created_at
FROM notifications n
WHERE n.created_at > NOW() - INTERVAL '10 minutes'
  AND (n.message LIKE '%超级管理员%' OR n.message LIKE '%管理员%')
ORDER BY n.created_at DESC;
```

## 📊 显示格式对照表

| 情况 | real_name | name | 显示结果 |
|------|-----------|------|----------|
| 有真实姓名 | "张三" | "admin" | `超级管理员【张三】` |
| 有用户名（非角色） | null | "admin" | `超级管理员【admin】` |
| 用户名是"管理员" | null | "管理员" | `超级管理员` |
| 用户名是"超级管理员" | null | "超级管理员" | `超级管理员` |
| 没有姓名 | null | null | `超级管理员` |

## ✅ 验证清单

测试完成后，请确认以下各项：

- [ ] 用户名是"管理员"时，不显示重复的角色名称
- [ ] 用户名是"超级管理员"时，不显示重复的角色名称
- [ ] 用户名是其他值时，正确显示用户名
- [ ] 有真实姓名时，优先显示真实姓名
- [ ] 没有姓名时，只显示角色名称
- [ ] 超级管理员端的通知格式正确
- [ ] 普通管理员端的通知格式正确

## 🎉 测试通过标准

所有通知消息应该符合以下格式之一：

1. **有真实姓名**：`超级管理员【张三】修改了...`
2. **有用户名（非角色）**：`超级管理员【admin】修改了...`
3. **用户名是角色或没有姓名**：`超级管理员修改了...`

**绝对不应该出现**：
- ❌ `超级管理员 管理员 修改了...`
- ❌ `超级管理员【管理员】修改了...`
- ❌ `管理员 管理员 修改了...`
- ❌ `管理员【管理员】修改了...`

## 📞 问题反馈

如果测试中发现任何问题，请记录以下信息：

1. **用户信息**
   - 用户ID
   - 用户名（name）
   - 真实姓名（real_name）
   - 角色（role）

2. **通知消息**
   - 完整的通知消息内容
   - 通知类型
   - 创建时间

3. **控制台日志**
   - 搜索"操作人显示文本"
   - 复制相关日志

4. **数据库查询结果**
   - 用户信息查询结果
   - 通知记录查询结果

---

**测试指南创建时间**：2025-11-05
**创建人**：秒哒 AI 助手
