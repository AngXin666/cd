# 车辆租赁管理功能说明

## 功能概述

车辆租赁管理模块是专为超级管理员设计的功能，用于管理车队中的车辆租赁信息，包括租赁方、承租方、租金和租期等关键信息。

## 功能特性

### 1. 核心功能

#### 1.1 车辆基本信息管理
- ✅ 完整的车辆信息增删改查操作
- ✅ 车牌号、品牌、型号等基本信息
- ✅ 车辆类型（货车等，可自定义）
- ✅ 车辆归属明确区分（公司车/个人车）

#### 1.2 租赁信息管理
- ✅ 租赁方信息：记录出租车辆的公司或个人详情
- ✅ 承租方信息：记录租用车辆的公司或个人详情
- ✅ 租金金额：记录每月的租金费用
- ✅ 租赁起止时间：记录租赁合同的有效期限

#### 1.3 租金缴纳时间自动计算
- ✅ 系统根据租赁开始时间自动计算每月租金缴纳日
- ✅ 自动计算下一个租金缴纳截止日期
- ✅ 支持手动调整租金缴纳日（1-31日）

### 2. 界面功能

#### 2.1 车辆列表页面
- ✅ 显示所有车辆的租赁信息
- ✅ 车牌号搜索功能
- ✅ 租赁状态标识（租赁中/已结束）
- ✅ 关键信息一目了然：
  - 租赁方名称
  - 租赁时间（起止日期）
  - 下次缴纳租金时间
  - 租金费用

#### 2.2 车辆编辑页面
- ✅ 基本信息编辑
  - 车牌号、品牌、型号
  - 车辆类型、颜色
  - 车辆识别代号(VIN)
  - 所有人、注册日期
- ✅ 租赁信息编辑
  - 车辆归属选择（公司车/个人车）
  - 租赁方信息（名称、联系方式）
  - 承租方信息（名称、联系方式）
  - 月租金金额
  - 租赁起止日期
  - 每月租金缴纳日

### 3. 数据管理

#### 3.1 数据库设计
- 表名：`vehicles_base`
- 新增字段：
  - `ownership_type`: 车辆归属类型（company/personal）
  - `lessor_name`: 租赁方名称
  - `lessor_contact`: 租赁方联系方式
  - `lessee_name`: 承租方名称
  - `lessee_contact`: 承租方联系方式
  - `monthly_rent`: 月租金（元）
  - `lease_start_date`: 租赁开始日期
  - `lease_end_date`: 租赁结束日期
  - `rent_payment_day`: 每月租金缴纳日（1-31）

#### 3.2 数据库视图
- 视图名：`vehicle_lease_info`
- 包含计算字段：
  - `next_payment_date`: 下一个租金缴纳日期（自动计算）
  - `is_lease_active`: 租赁是否有效（在租期内）

#### 3.3 自动化功能
- 触发器：自动根据租赁开始日期设置租金缴纳日
- 函数：`calculate_next_rent_payment_date()` 计算下一个租金缴纳日期

### 4. 用户体验

#### 4.1 操作流程
1. 从超级管理员首页点击"车辆租赁"入口
2. 查看车辆列表，可使用搜索功能
3. 点击"添加车辆"创建新车辆记录
4. 填写基本信息和租赁信息
5. 系统自动计算租金缴纳日期
6. 保存后返回列表页面

#### 4.2 安全机制
- ✅ 删除操作需要确认，防止误操作
- ✅ 必填字段验证（车牌号、品牌、型号）
- ✅ 数据格式验证（租金金额、日期范围）

#### 4.3 界面设计
- ✅ 清晰的视觉层次
- ✅ 卡片式布局，信息分组明确
- ✅ 图标辅助，提升可读性
- ✅ 响应式设计，适配不同屏幕

## 技术实现

### 1. 数据库迁移
- 文件：`supabase/migrations/62_add_vehicle_lease_management.sql`
- 包含：表结构扩展、视图创建、触发器和函数

### 2. TypeScript类型定义
- 文件：`src/db/types.ts`
- 新增类型：
  - `OwnershipType`: 车辆归属类型
  - `VehicleLeaseInfo`: 车辆租赁信息（包含计算字段）

### 3. 数据库API
- 文件：`src/db/vehicle-lease.ts`
- 主要函数：
  - `getAllVehicleLeaseInfo()`: 获取所有车辆租赁信息
  - `getVehicleBaseById()`: 根据ID获取车辆信息
  - `createVehicle()`: 创建车辆
  - `updateVehicle()`: 更新车辆信息
  - `deleteVehicle()`: 删除车辆
  - `searchVehiclesByPlateNumber()`: 搜索车辆
  - `calculateNextPaymentDate()`: 计算下一个租金缴纳日期

### 4. 页面组件
- 列表页面：`src/pages/super-admin/vehicle-lease-management/index.tsx`
- 编辑页面：`src/pages/super-admin/vehicle-lease-edit/index.tsx`

### 5. 路由配置
- 已添加到 `src/app.config.ts`：
  - `pages/super-admin/vehicle-lease-management/index`
  - `pages/super-admin/vehicle-lease-edit/index`

### 6. 入口配置
- 超级管理员首页添加"车辆租赁"入口
- 位置：车辆管理板块
- 图标：文档编辑图标
- 颜色：青绿色主题

## 使用说明

### 访问路径
1. 登录超级管理员账号
2. 进入超级管理员工作台
3. 点击"车辆租赁"卡片

### 添加车辆
1. 点击"添加车辆"按钮
2. 填写基本信息（必填：车牌号、品牌、型号）
3. 填写租赁信息（可选）
4. 点击"保存"

### 编辑车辆
1. 在列表中点击车辆卡片右上角的编辑图标
2. 修改信息
3. 点击"保存"

### 删除车辆
1. 在列表中点击车辆卡片右上角的删除图标
2. 确认删除操作

### 搜索车辆
1. 在搜索框输入车牌号关键词
2. 点击"搜索"按钮
3. 点击"清空"按钮恢复完整列表

## 租金缴纳时间计算规则

### 自动计算逻辑
1. 当设置租赁开始日期时，系统自动提取日期中的"日"作为每月租金缴纳日
2. 例如：租赁开始日期为 2025-01-15，则每月15号为租金缴纳日
3. 系统自动计算下一个租金缴纳日期：
   - 如果当月的缴纳日期还未到，显示当月日期
   - 如果当月的缴纳日期已过，显示下月日期

### 手动调整
- 可以在编辑页面手动修改"每月租金缴纳日"字段
- 范围：1-31日
- 修改后系统会根据新的缴纳日重新计算下次缴纳日期

## 数据展示

### 列表页面显示内容
- 车牌号（醒目显示）
- 租赁状态标签（租赁中/已结束）
- 车辆信息：品牌 型号 (车辆类型)
- 车辆归属：公司车/个人车
- 租赁方：名称 (联系方式)
- 承租方：名称 (联系方式)
- 租赁时间：起始日期 至 结束日期
- 租金费用：¥X.XX/月
- 下次缴纳：YYYY-MM-DD

## 注意事项

1. **数据完整性**
   - 车牌号、品牌、型号为必填项
   - 其他字段为可选项，可根据实际情况填写

2. **租金计算**
   - 租金缴纳日会根据租赁开始日期自动设置
   - 如需调整，可手动修改

3. **租赁状态**
   - 系统根据当前日期和租赁起止日期自动判断租赁是否有效
   - 租赁中的车辆会显示绿色标签

4. **删除操作**
   - 删除车辆会同时删除所有相关的录入记录
   - 操作不可恢复，请谨慎操作

## 后续扩展建议

1. **租金缴纳记录**
   - 可以添加租金缴纳记录表
   - 记录每次租金缴纳的时间和金额
   - 生成租金缴纳报表

2. **到期提醒**
   - 租赁到期前自动提醒
   - 租金缴纳日前自动提醒

3. **合同管理**
   - 上传租赁合同文件
   - 合同到期自动提醒

4. **统计报表**
   - 租金收支统计
   - 车辆租赁状态统计
   - 租赁方/承租方统计

## 更新日志

### 2025-11-05
- ✅ 创建车辆租赁管理功能
- ✅ 数据库表结构扩展
- ✅ 创建车辆租赁信息视图
- ✅ 实现租金缴纳时间自动计算
- ✅ 完成列表页面和编辑页面
- ✅ 添加超级管理员入口
- ✅ 完成功能测试
