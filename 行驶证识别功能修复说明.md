# 行驶证识别功能修复说明

## 修复内容概述

本次更新修复了行驶证识别功能的三个主要问题，并增强了用户体验。

---

## 1. 图片自动旋转修复 ✅

### 问题描述
- 拍摄的行驶证照片经常出现倒置或方向错误
- 导致OCR识别困难或失败

### 解决方案
- **自动图片处理**：在PhotoCapture组件中集成图片压缩和旋转功能
- **使用Taro API**：利用`Taro.compressImage`自动修正照片方向
- **保持质量**：压缩质量设置为90%，确保识别准确性
- **尺寸优化**：最大尺寸限制为1920px，平衡质量和性能

### 技术实现
```typescript
// 压缩图片并自动旋转（修复方向问题）
const compressRes = await Taro.compressImage({
  src: path,
  quality: 90, // 保持较高质量
  compressedWidth: 1920, // 最大宽度
  compressedHeight: 1920 // 最大高度
})
```

### 用户体验改进
- ✅ 拍照后自动转正，无需手动调整
- ✅ 提高OCR识别成功率
- ✅ 减少重新拍摄的次数

---

## 2. 副页识别功能修复 ✅

### 问题描述
- 副页信息无法正确识别
- OCR返回的JSON格式解析失败

### 问题根源
- OCR提示词中的JSON格式不正确
- 数字字段没有使用引号，导致JSON解析错误

### 解决方案
- **修正JSON格式**：所有字段值都使用字符串格式
- **改进提示词**：添加更详细的识别说明
- **错误处理**：添加null值处理机制

### 修正前后对比

**修正前（错误）：**
```json
{
  "total_mass": 总质量（数字，单位kg），
  "approved_passengers": 核定载人数（数字）
}
```

**修正后（正确）：**
```json
{
  "total_mass": "总质量（数字，单位kg）",
  "approved_passengers": "核定载人数（数字）"
}
```

### 识别字段清单

#### 副页字段：
- ✅ 档案编号 (archive_number)
- ✅ 总质量 (total_mass) - kg
- ✅ 核定载人数 (approved_passengers)
- ✅ 整备质量 (curb_weight) - kg
- ✅ 核定载质量 (approved_load) - kg
- ✅ 外廓尺寸-长 (overall_dimension_length) - mm
- ✅ 外廓尺寸-宽 (overall_dimension_width) - mm
- ✅ 外廓尺寸-高 (overall_dimension_height) - mm
- ✅ 检验有效期 (inspection_valid_until)

---

## 3. 年检时间识别功能 ✅

### 新增功能
- **年检时间识别**：从副页背页提取最近一次年检日期
- **剩余天数计算**：自动计算距离下次年检的剩余天数
- **过期提醒**：年检过期时显示"已过期"提示

### 数据库变更
```sql
-- 添加年检时间字段
ALTER TABLE vehicles ADD COLUMN inspection_date DATE;
```

### 识别字段

#### 副页背页字段：
- ✅ 年检时间 (inspection_date) - 最近一次年检日期
- ✅ 强制报废期 (mandatory_scrap_date)

### 显示效果

**识别结果展示：**
```
副页背页信息
├─ 年检时间: 2024-01-15
├─ 剩余年检时间: 45天
└─ 强制报废期: 2034-01-15
```

**过期情况：**
```
副页背页信息
├─ 年检时间: 2023-01-15
├─ 剩余年检时间: 已过期
└─ 强制报废期: 2033-01-15
```

### 计算逻辑
```typescript
// 计算剩余年检天数
const inspectionDate = new Date(formData.inspection_date)
const validUntil = new Date(formData.inspection_valid_until)
const today = new Date()
const daysRemaining = Math.ceil(
  (validUntil.getTime() - today.getTime()) / (1000 * 60 * 60 * 24)
)
```

---

## 4. 用户体验优化 ✅

### 拍照提示优化
- **更清晰的说明**：明确告知需要拍摄的内容
- **分步指导**：每个步骤都有详细提示

#### 副页背页拍照提示：
```
行驶证副页背页
请拍摄行驶证副页背页，包含年检记录和强制报废期

提示：
• 确保照片清晰
• 包含年检记录
• 包含强制报废期信息
```

### 识别结果展示优化
- **分类展示**：主页、副页、副页背页信息分开显示
- **格式化显示**：日期、数字等格式化展示
- **智能计算**：自动计算剩余年检时间

### 错误处理优化
- **详细日志**：记录识别过程中的详细信息
- **友好提示**：识别失败时给出明确的操作建议
- **重试机制**：支持重新拍摄和识别

---

## 完整识别流程

### 步骤1：拍摄行驶证主页
1. 点击"拍照"按钮
2. 拍摄行驶证主页
3. 照片自动转正
4. 点击"识别主页"按钮

**识别内容：**
- 车牌号码
- 车辆类型
- 品牌型号
- VIN码
- 发动机号码
- 所有人
- 使用性质
- 注册日期
- 发证日期

### 步骤2：拍摄行驶证副页
1. 点击"拍照"按钮
2. 拍摄行驶证副页
3. 照片自动转正
4. 点击"识别副页"按钮

**识别内容：**
- 档案编号
- 总质量
- 核定载人数
- 整备质量
- 核定载质量
- 外廓尺寸（长×宽×高）
- 检验有效期

### 步骤3：拍摄行驶证副页背页
1. 点击"拍照"按钮
2. 拍摄行驶证副页背页
3. 照片自动转正
4. 点击"识别副页背页"按钮

**识别内容：**
- 年检时间
- 强制报废期

**自动计算：**
- 剩余年检天数

---

## 技术改进总结

### 1. 图片处理
- ✅ 自动旋转和压缩
- ✅ 保持高质量
- ✅ 优化文件大小

### 2. OCR识别
- ✅ 修正JSON格式
- ✅ 改进提示词
- ✅ 增强错误处理

### 3. 数据管理
- ✅ 新增年检时间字段
- ✅ 完善类型定义
- ✅ 优化数据验证

### 4. 用户界面
- ✅ 清晰的拍照提示
- ✅ 详细的识别结果
- ✅ 智能的时间计算

---

## 使用建议

### 拍照技巧
1. **光线充足**：在明亮环境下拍摄
2. **避免反光**：调整角度避免反光
3. **保持稳定**：拍摄时保持手机稳定
4. **完整清晰**：确保所有文字都在画面内

### 识别顺序
1. 先拍摄并识别主页
2. 确认主页信息正确
3. 再拍摄并识别副页
4. 最后拍摄并识别副页背页

### 数据检查
1. 识别后仔细核对每个字段
2. 特别注意数字字段的准确性
3. 确认日期格式正确
4. 检查剩余年检时间是否合理

---

## 已知限制

1. **OCR准确率**：取决于照片质量和光线条件
2. **网络依赖**：需要网络连接进行OCR识别
3. **格式要求**：日期必须是YYYY-MM-DD格式
4. **数字识别**：复杂数字可能需要手动确认

---

## 故障排除

### 问题1：照片还是倒置
**解决方案**：
- 确保使用最新版本的应用
- 尝试从相册选择照片
- 检查手机系统权限

### 问题2：副页识别失败
**解决方案**：
- 确保照片清晰完整
- 避免反光和阴影
- 重新拍摄并识别

### 问题3：年检时间不显示
**解决方案**：
- 确保副页背页包含年检记录
- 检查照片是否清晰
- 手动输入年检时间

---

## 更新日志

### 版本：2024-11-05

**新增功能：**
- ✅ 图片自动旋转功能
- ✅ 年检时间识别
- ✅ 剩余年检天数计算

**问题修复：**
- ✅ 副页识别失败问题
- ✅ JSON格式解析错误
- ✅ 照片方向错误

**体验优化：**
- ✅ 改进拍照提示
- ✅ 优化识别结果展示
- ✅ 增强错误处理

---

## 技术支持

如遇到问题，请提供：
1. 浏览器控制台的错误日志
2. 识别结果的截图
3. 操作步骤的详细描述
4. 使用的设备和浏览器版本

详细的调试指南请参考：`DEBUGGING_GUIDE.md`
