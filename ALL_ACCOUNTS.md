# 车队管家 - 所有账号列表

## 概述

本文档列出了车队管家小程序中所有预创建的测试账号，包括超级管理员和普通管理员账号。

## 账号列表

### 1. 超级管理员账号

#### admin - 超级管理员
| 字段 | 值 |
|------|-----|
| 用户ID | `00000000-0000-0000-0000-000000000001` |
| 手机号 | `admin` |
| 邮箱 | `admin@fleet.com` |
| 密码 | `admin123` |
| 角色 | 🔴 **超级管理员** (super_admin) |
| 姓名 | 超级管理员 |

**权限范围**：
- ✅ 完全访问所有数据
- ✅ 创建、编辑、删除任何用户
- ✅ 修改用户角色
- ✅ 分配仓库和权限
- ✅ 管理所有功能模块

**登录方式**：
```
手机号：admin
密码：admin123
```

---

### 2. 普通管理员账号

#### admin2 - 普通管理员
| 字段 | 值 |
|------|-----|
| 用户ID | `00000000-0000-0000-0000-000000000002` |
| 手机号 | `admin2` |
| 邮箱 | `admin2@fleet.com` |
| 密码 | `admin123` |
| 角色 | 🟡 **普通管理员** (manager) |
| 姓名 | 普通管理员 |

**权限范围**：
- ✅ 查看自己和管辖的司机
- ✅ 编辑管辖的司机信息
- ✅ 管理考勤规则
- ✅ 编辑计件记录
- ✅ 管理品类
- ❌ 不能查看其他管理员
- ❌ 不能修改用户角色
- ❌ 不能创建或删除用户

**登录方式**：
```
手机号：admin2
密码：admin123
```

**注意事项**：
- 新创建的管理员默认没有分配任何仓库
- 需要超级管理员在 `manager_warehouses` 表中分配仓库
- 未分配仓库时，管理员无法管理任何司机

---

## 角色对比

### 权限对比表

| 功能 | 超级管理员 (admin) | 普通管理员 (admin2) | 司机 |
|------|-------------------|-------------------|------|
| **用户管理** |
| 查看所有用户 | ✅ | ❌ | ❌ |
| 查看自己 | ✅ | ✅ | ✅ |
| 查看管辖的司机 | ✅ | ✅ | ❌ |
| 创建新用户 | ✅ | ❌ | ❌ |
| 编辑任何用户 | ✅ | ❌ | ❌ |
| 编辑管辖的司机 | ✅ | ✅ | ❌ |
| 编辑自己 | ✅ | ❌* | ✅ |
| 删除用户 | ✅ | ❌ | ❌ |
| 修改用户角色 | ✅ | ❌ | ❌ |
| **仓库管理** |
| 创建仓库 | ✅ | ❌ | ❌ |
| 编辑仓库 | ✅ | ❌ | ❌ |
| 删除仓库 | ✅ | ❌ | ❌ |
| 分配仓库 | ✅ | ❌ | ❌ |
| 查看分配的仓库 | ✅ | ✅ | ✅ |
| **权限管理** |
| 设置管理员权限 | ✅ | ❌ | ❌ |
| 查看自己的权限 | ✅ | ✅ | ❌ |
| **考勤管理** |
| 管理考勤规则 | ✅ | ✅ | ❌ |
| 查看考勤记录 | ✅ | ✅ | ✅ |
| 打卡 | ✅ | ✅ | ✅ |
| **请假管理** |
| 审批请假 | ✅ | ✅ | ❌ |
| 提交请假申请 | ✅ | ✅ | ✅ |
| 查看请假记录 | ✅ | ✅ | ✅ |
| **计件管理** |
| 编辑计件记录 | ✅ | ✅ | ❌ |
| 查看计件记录 | ✅ | ✅ | ✅ |
| 提交计件 | ✅ | ✅ | ✅ |
| **品类管理** |
| 管理品类 | ✅ | ✅ | ❌ |
| 查看品类 | ✅ | ✅ | ✅ |

*注：普通管理员不能通过 RLS 策略更新自己，需要超级管理员权限

---

## 数据访问范围

### 超级管理员 (admin)
```
┌─────────────────────────────────────┐
│     完全访问所有数据                  │
│                                     │
│  ✅ 所有用户                         │
│  ✅ 所有仓库                         │
│  ✅ 所有司机                         │
│  ✅ 所有考勤记录                      │
│  ✅ 所有请假记录                      │
│  ✅ 所有计件记录                      │
│  ✅ 所有品类                         │
└─────────────────────────────────────┘
```

### 普通管理员 (admin2)
```
┌─────────────────────────────────────┐
│     受限访问（基于仓库分配）           │
│                                     │
│  ✅ 自己的信息                       │
│  ✅ 分配的仓库                       │
│  ✅ 管辖的司机                       │
│  ✅ 管辖司机的考勤记录                │
│  ✅ 管辖司机的请假记录                │
│  ✅ 管辖司机的计件记录                │
│  ✅ 分配仓库的品类                    │
│                                     │
│  ❌ 其他管理员                       │
│  ❌ 其他仓库                         │
│  ❌ 不在管辖范围内的司机               │
└─────────────────────────────────────┘
```

### 司机
```
┌─────────────────────────────────────┐
│     仅访问自己的数据                  │
│                                     │
│  ✅ 自己的信息                       │
│  ✅ 自己的考勤记录                    │
│  ✅ 自己的请假记录                    │
│  ✅ 自己的计件记录                    │
│  ✅ 分配仓库的品类（只读）             │
│                                     │
│  ❌ 其他用户                         │
│  ❌ 其他司机                         │
│  ❌ 管理功能                         │
└─────────────────────────────────────┘
```

---

## 使用指南

### 首次登录

#### 1. 超级管理员登录
```
1. 打开车队管家小程序
2. 点击"登录"
3. 输入手机号：admin
4. 输入密码：admin123
5. 点击"登录"
```

#### 2. 普通管理员登录
```
1. 打开车队管家小程序
2. 点击"登录"
3. 输入手机号：admin2
4. 输入密码：admin123
5. 点击"登录"
```

### 为普通管理员分配仓库

使用超级管理员账号登录后：

```sql
-- 方法1: 通过 SQL 直接分配
INSERT INTO manager_warehouses (manager_id, warehouse_id)
VALUES (
  '00000000-0000-0000-0000-000000000002',  -- admin2 的 ID
  'your-warehouse-uuid'                     -- 仓库的 UUID
);

-- 方法2: 通过超级管理端界面操作
1. 登录超级管理端
2. 进入"用户管理"
3. 找到 admin2
4. 点击"分配仓库"
5. 选择要分配的仓库
6. 保存
```

### 调整普通管理员权限

使用超级管理员账号：

```sql
-- 禁用某些权限
UPDATE manager_permissions
SET 
  can_edit_user_info = false,           -- 禁止编辑用户信息
  can_manage_categories = false         -- 禁止管理品类
WHERE manager_id = '00000000-0000-0000-0000-000000000002';

-- 启用所有权限
UPDATE manager_permissions
SET 
  can_edit_user_info = true,
  can_edit_piece_work = true,
  can_manage_attendance_rules = true,
  can_manage_categories = true
WHERE manager_id = '00000000-0000-0000-0000-000000000002';
```

---

## 测试场景

### 场景 1: 超级管理员功能测试

1. **用户管理**
   - 创建新的管理员账号
   - 创建新的司机账号
   - 修改用户角色
   - 删除测试账号

2. **仓库管理**
   - 创建新仓库
   - 编辑仓库信息
   - 为管理员分配仓库
   - 禁用/启用仓库

3. **权限管理**
   - 设置管理员权限
   - 查看权限列表
   - 调整权限配置

### 场景 2: 普通管理员功能测试

**前提条件**：
- 已为 admin2 分配至少一个仓库
- 仓库中有司机

**测试步骤**：

1. **登录测试**
   - 使用 admin2 账号登录
   - 验证登录成功

2. **数据可见性测试**
   - 查看司机列表（应该只看到管辖的司机）
   - 尝试查看其他管理员（应该看不到）
   - 查看仓库列表（应该只看到分配的仓库）

3. **编辑权限测试**
   - 编辑管辖的司机信息（应该成功）
   - 尝试修改司机角色（应该失败）
   - 尝试编辑其他管理员（应该失败）

4. **功能模块测试**
   - 管理考勤规则
   - 查看考勤记录
   - 审批请假申请
   - 编辑计件记录
   - 管理品类

### 场景 3: 权限隔离测试

1. **使用 admin2 登录**
2. **尝试越权操作**：
   - 查看所有用户（应该只看到自己和管辖的司机）
   - 修改自己的角色（应该失败）
   - 访问其他管理员的数据（应该失败）
   - 编辑不在管辖范围内的司机（应该失败）

3. **验证结果**：
   - 所有越权操作都应该失败
   - 系统应该返回空结果或错误提示
   - 不应该出现权限提升

---

## 安全性说明

### 密码安全
- ✅ 所有密码使用 bcrypt 加密
- ✅ 加密强度：gen_salt('bf')
- ✅ 密码不会以明文存储
- ⚠️ 建议首次登录后修改密码

### RLS 保护
- ✅ profiles 表已启用 RLS
- ✅ 使用 SECURITY DEFINER 函数
- ✅ 数据隔离明确
- ⚠️ 其他表的 RLS 仍处于禁用状态

### 角色保护
- ✅ prevent_role_change 触发器保护
- ✅ 只有超级管理员可以修改角色
- ✅ 防止权限提升攻击

### Token 字段
- ✅ 所有 token 字段设置为空字符串
- ✅ 避免 NULL 转换错误
- ✅ 确保系统稳定性

---

## 常见问题

### Q1: 普通管理员登录后看不到任何司机？
**A**: 这是正常的。新创建的管理员默认没有分配任何仓库。需要超级管理员为其分配仓库后，才能看到该仓库中的司机。

### Q2: 如何为普通管理员分配仓库？
**A**: 使用超级管理员账号登录，在用户管理界面为管理员分配仓库，或者直接在 `manager_warehouses` 表中插入记录。

### Q3: 普通管理员可以修改自己的信息吗？
**A**: 根据当前的 RLS 策略，普通管理员不能通过策略更新自己的信息。如果需要修改，需要超级管理员操作。

### Q4: 如何调整普通管理员的权限？
**A**: 使用超级管理员账号，在 `manager_permissions` 表中更新对应管理员的权限字段。

### Q5: 忘记密码怎么办？
**A**: 目前可以通过超级管理员重置密码，或者直接在 `auth.users` 表中更新密码（使用 `crypt('新密码', gen_salt('bf'))`）。

### Q6: 为什么普通管理员看不到其他管理员？
**A**: 这是 RLS 策略的设计。普通管理员只能看到自己和管辖的司机，不能看到其他管理员。这是为了数据隔离和安全性。

---

## 相关文档

- `PROFILES_RLS_ENABLED.md` - profiles 表 RLS 策略详细说明
- `ADMIN2_ACCOUNT_CREATED.md` - admin2 账号创建详情
- `COMPLETE_ERROR_FIX_SUMMARY.md` - 错误修复总结
- `ERROR_500_ANALYSIS.md` - 500 错误分析
- `CONFIRMATION_TOKEN_NULL_ERROR_FIX.md` - NULL 错误修复

## 迁移文件

- `supabase/migrations/30_create_admin_account.sql` - 创建超级管理员账号
- `supabase/migrations/33_enable_profiles_rls.sql` - 启用 profiles 表 RLS
- `supabase/migrations/34_create_manager_admin2.sql` - 创建普通管理员账号

---

## 总结

### 当前账号状态

| 账号 | 角色 | 状态 | 仓库分配 | 权限配置 |
|------|------|------|---------|---------|
| admin | 超级管理员 | ✅ 可用 | N/A | 完全权限 |
| admin2 | 普通管理员 | ✅ 可用 | ⚠️ 未分配 | ✅ 所有权限已启用 |

### 下一步操作

1. ✅ 创建超级管理员账号 (admin)
2. ✅ 启用 profiles 表 RLS
3. ✅ 创建普通管理员账号 (admin2)
4. ⏳ 为 admin2 分配仓库
5. ⏳ 创建司机账号进行测试
6. ⏳ 测试权限隔离
7. ⏳ 为其他表启用 RLS

---

**文档更新时间**: 2025-11-14 21:50  
**文档维护**: Miaoda AI Assistant  
**文档版本**: 1.0
