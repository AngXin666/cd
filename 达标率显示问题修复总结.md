# 达标率显示问题修复总结

## 问题描述

用户反馈：司机明明有 13 件的完成数量,但达标率显示为 0%。

## 问题分析

### 根本原因

达标率的计算依赖于仓库的 `daily_target`(每日目标)字段。如果仓库没有设置每日目标,达标率计算公式会返回 0%。

### 计算逻辑

```typescript
// 今天达标率计算
if (dailyTarget > 0) {
  dailyCompletionRate = (dailyQuantity / dailyTarget) * 100
}
// 如果 dailyTarget 为 0 或 null,达标率为 0%
```

### 数据库检查

查询发现"测试2"仓库的 `daily_target` 字段为 NULL:

```sql
SELECT id, name, daily_target FROM warehouses;

-- 结果:
-- 北京仓库: daily_target = 100
-- 测试2: daily_target = NULL  ← 问题所在
-- 上海仓库: daily_target = 200
```

## 修复方案

### 1. 数据修复

为"测试2"仓库设置每日目标:

```sql
UPDATE warehouses
SET daily_target = 100
WHERE id = '38114568-6ddc-40f2-a3ec-58f6b0db4833';
```

### 2. UI 优化

修改计件报表页面,当仓库未设置每日目标时显示友好提示:

**修改前:**
```tsx
<Text className="text-xs text-gray-500 mt-1">目标: {dailyTarget}件</Text>
// 显示: 目标: 0件 (用户困惑)
```

**修改后:**
```tsx
{dailyTarget > 0 ? (
  <Text className="text-xs text-gray-500 mt-1">目标: {dailyTarget}件</Text>
) : (
  <Text className="text-xs text-warning mt-1">未设置目标</Text>
)}
// 显示: 未设置目标 (清晰明了)
```

### 3. 影响范围

修改了以下文件:
- `src/pages/super-admin/piece-work-report/index.tsx` - 超级管理端计件报表
- `src/pages/manager/piece-work-report/index.tsx` - 普通管理端计件报表

## 修复效果

### 修复前
- ✗ 达标率显示 0%,但有件数
- ✗ 用户不知道为什么达标率是 0%
- ✗ 目标显示为 "目标: 0件"

### 修复后
- ✓ 设置了每日目标后,达标率正常计算
- ✓ 未设置目标时显示 "未设置目标" 提示
- ✓ 用户能快速识别配置问题

## 业务逻辑说明

### 达标率计算公式

1. **今天达标率** = (今天件数 / 每日目标) × 100%
2. **本周达标率** = (本周件数 / (每日目标 × 本周应工作天数)) × 100%
3. **本月达标率** = (本月件数 / (每日目标 × 本月应工作天数)) × 100%

### 应工作天数计算

- 考虑新员工入职日期
- 扣除合规请假天数(不超过仓库允许的最大请假天数)
- 公式: 应工作天数 = 实际天数 - 合规请假天数

## 预防措施

### 1. 仓库创建时的默认值

建议在创建仓库时设置默认的 `daily_target` 值,避免为 NULL。

### 2. 数据验证

在仓库管理页面添加必填验证,确保每日目标不为空。

### 3. 用户提示

当检测到仓库未设置每日目标时:
- 在计件报表页面显示 "未设置目标" 提示
- 在仓库管理页面显示警告标识

## 测试验证

### 测试步骤

1. 登录超级管理端
2. 进入计件报表页面
3. 选择"测试2"仓库
4. 查看司机达标率

### 预期结果

- 如果仓库已设置每日目标: 显示正常的达标率百分比
- 如果仓库未设置每日目标: 显示 "未设置目标" 提示

## 相关提交

- `c4dea69` - 修复达标率显示问题并优化提示信息
- `36501d5` - 修复司机端品类价格读取逻辑

## 总结

此次修复解决了两个问题:

1. **数据问题**: 为缺失每日目标的仓库设置了合理的默认值
2. **用户体验问题**: 优化了 UI 提示,让用户能快速识别配置问题

通过这次修复,用户不再困惑为什么有件数但达标率是 0%,系统的可用性得到了提升。
