# 申请详情查看功能实现总结

## 功能概述

本次更新实现了已处理申请的详情查看功能，优化了超级管理员的通知内容，使所有用户都能方便地查看申请的完整信息。

## 主要改进

### 1. 超级管理员通知优化

**文件：** `src/db/api.ts`

**改进内容：**
- 在 `reviewLeaveApplication` 和 `reviewResignationApplication` 函数中获取申请人信息
- 优化通知消息内容，包含更详细的信息：
  - 申请人姓名和联系电话
  - 申请类型和详细内容
  - 申请时间和期限
  - 审批人姓名
  - 审批时间
  - 审批意见

**通知消息格式：**

对于审批人自己：
```
您已同意了张三的事假申请
申请时间：2025-01-01 至 2025-01-03
申请事由：家中有事
审批意见：同意
```

对于其他超级管理员：
```
李四同意了张三的事假申请
申请人：张三（13800138000）
申请时间：2025-01-01 至 2025-01-03
申请事由：家中有事
审批人：李四
审批时间：2025-01-15 10:30:00
审批意见：同意
```

### 2. 申请详情弹窗组件

**文件：** `src/components/application/ApplicationDetailDialog.tsx`

**功能特点：**
- 通用组件，支持请假和离职两种申请类型
- 自动加载申请详情、申请人信息、审批人信息
- 清晰的信息分组展示：
  - 申请人信息（姓名、电话、申请时间）
  - 申请详情（类型、时间、事由等）
  - 审批信息（状态、审批人、审批时间、审批意见）
- 响应式设计，适配移动端
- 点击遮罩层或关闭按钮可关闭弹窗

### 3. 通知中心查看详情功能

**文件：** `src/pages/common/notifications/index.tsx`

**改进内容：**
- 添加详情弹窗状态管理
- 修改 `handleNotificationClick` 函数：
  - 对于已处理的申请（approved/rejected），点击后显示详情弹窗
  - 自动识别申请类型（请假/离职）
  - 标记通知为已读
- 在页面底部添加 `ApplicationDetailDialog` 组件

**支持的通知类型：**
- `leave_approved` - 请假申请已同意
- `leave_rejected` - 请假申请已拒绝
- `leave_application_submitted` - 请假申请已提交
- `resignation_approved` - 离职申请已同意
- `resignation_rejected` - 离职申请已拒绝
- `resignation_application_submitted` - 离职申请已提交

### 4. 司机端查看详情功能

**文件：** `src/pages/driver/leave/index.tsx`

**改进内容：**
- 添加详情弹窗状态管理
- 添加 `handleViewDetail` 函数处理点击事件
- 为请假申请列表和离职申请列表添加点击事件
- 添加视觉反馈（hover 效果）
- 在页面底部添加 `ApplicationDetailDialog` 组件

**用户体验：**
- 点击任意申请记录即可查看完整详情
- 包括待审核、已同意、已拒绝的所有申请
- 统一的详情展示界面

## 技术实现

### 数据获取流程

1. **申请基本信息**
   - 从 `leave_applications` 或 `resignation_applications` 表获取

2. **申请人信息**
   - 通过 `user_id` 从 `profiles` 表获取姓名和电话

3. **审批人信息**
   - 通过 `reviewed_by` 从 `profiles` 表获取审批人姓名

### 组件设计

- 使用 `useCallback` 优化数据加载函数
- 使用 `useEffect` 监听弹窗显示状态，自动加载数据
- 状态管理清晰，避免不必要的重新渲染

### 样式设计

- 使用 Tailwind CSS 实现响应式布局
- 固定定位的标题栏和底部按钮
- 可滚动的内容区域
- 清晰的信息分组和视觉层次

## 用户角色权限

### 司机
- 可以查看自己的所有申请详情
- 通过"请假与离职"页面查看
- 通过通知中心查看

### 普通管理员
- 可以查看自己审批的申请详情
- 通过通知中心查看

### 超级管理员
- 可以查看所有申请详情
- 通过通知中心查看
- 接收更详细的通知消息

## 测试建议

### 功能测试
1. 司机提交请假/离职申请
2. 管理员审批申请
3. 各角色查看通知中心
4. 点击已处理的申请通知
5. 验证详情弹窗显示正确信息
6. 司机在"请假与离职"页面点击申请记录
7. 验证详情弹窗显示正确信息

### 边界测试
1. 申请人信息缺失的情况
2. 审批人信息缺失的情况
3. 申请事由为空的情况
4. 审批意见为空的情况
5. 长文本内容的显示

### 兼容性测试
1. 不同屏幕尺寸的显示效果
2. 微信小程序环境
3. H5 浏览器环境

## 后续优化建议

1. **性能优化**
   - 考虑缓存已加载的申请详情
   - 减少重复的数据库查询

2. **功能增强**
   - 添加申请历史记录（如果有多次审批）
   - 支持导出申请详情为 PDF
   - 添加申请详情的分享功能

3. **用户体验**
   - 添加加载动画
   - 优化错误提示
   - 支持键盘快捷键关闭弹窗

## 相关文件

### 新增文件
- `src/components/application/ApplicationDetailDialog.tsx` - 申请详情弹窗组件

### 修改文件
- `src/db/api.ts` - 优化通知消息内容
- `src/pages/common/notifications/index.tsx` - 添加查看详情功能
- `src/pages/driver/leave/index.tsx` - 添加查看详情功能

## 提交信息

```
feat: 实现申请详情查看功能并优化超级管理员通知

- 优化超级管理员通知内容，包含申请人、申请详情、审批信息
- 创建 ApplicationDetailDialog 组件显示申请完整详情
- 在通知中心添加点击查看详情功能
- 在司机端申请列表添加点击查看详情功能
- 支持所有用户角色查看已处理申请的详情
```
