# ç”¨æˆ·ç®¡ç†å…¨åŠŸèƒ½å¤šç§Ÿæˆ·é€‚é…æ£€æŸ¥æŠ¥å‘Š

## ğŸ“‹ æ£€æŸ¥æ¦‚è¿°

å…¨é¢æ£€æŸ¥ç”¨æˆ·ç®¡ç†ç³»ç»Ÿçš„æ‰€æœ‰åŠŸèƒ½æ˜¯å¦æ­£ç¡®é€‚é…å¤šç§Ÿæˆ·æ¶æ„ï¼ˆæ¯ä¸ªç§Ÿæˆ·ä½¿ç”¨ç‹¬ç«‹æ•°æ®åº“æ¨¡å¼ï¼‰ã€‚

## ğŸ” æ£€æŸ¥èŒƒå›´

### 1. ç”¨æˆ·åŸºç¡€åŠŸèƒ½
- âŒ åˆ›å»ºç”¨æˆ·
- âœ… æŸ¥è¯¢ç”¨æˆ·
- âœ… æ›´æ–°ç”¨æˆ·
- âœ… åˆ é™¤ç”¨æˆ·

### 2. ç”¨æˆ·è§’è‰²ç®¡ç†
- âœ… æŸ¥è¯¢è§’è‰²
- âœ… æ›´æ–°è§’è‰²
- âœ… è§’è‰²æƒé™æ§åˆ¶

### 3. ç”¨æˆ·ç»Ÿè®¡åŠŸèƒ½
- âœ… å¸æœºç»Ÿè®¡
- âœ… ç®¡ç†å‘˜ç»Ÿè®¡
- âœ… ç”¨æˆ·åˆ—è¡¨

## ğŸ“Š è¯¦ç»†æ£€æŸ¥ç»“æœ

### âœ… å·²æ­£ç¡®é€‚é…çš„åŠŸèƒ½

#### 1. æŸ¥è¯¢ç”¨æˆ· - âœ… ä¾èµ– RLS ç­–ç•¥
**å‡½æ•°**ï¼š
- `getCurrentUserProfile()` - è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
- `getAllProfiles()` - è·å–æ‰€æœ‰ç”¨æˆ·
- `getAllDrivers()` - è·å–æ‰€æœ‰å¸æœº
- `getAllManagers()` - è·å–æ‰€æœ‰ç®¡ç†å‘˜
- `getAllSuperAdmins()` - è·å–æ‰€æœ‰è€æ¿
- `getProfileById(id)` - è·å–ç”¨æˆ·è¯¦æƒ…
- `getDriverProfiles()` - è·å–å¸æœºåˆ—è¡¨
- `getManagerProfiles()` - è·å–ç®¡ç†å‘˜åˆ—è¡¨

**RLS ç­–ç•¥**ï¼š
```sql
-- ç”¨æˆ·å¯ä»¥æŸ¥çœ‹è‡ªå·±çš„ä¿¡æ¯
CREATE POLICY "Users can view own profile" ON profiles
  FOR SELECT TO authenticated
  USING (auth.uid() = id);

-- ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹åŒç§Ÿæˆ·çš„ç”¨æˆ·
CREATE POLICY "Admins can view same tenant users" ON profiles
  FOR SELECT TO authenticated
  USING ((
    (SELECT r.role FROM get_user_role_and_boss(auth.uid()) r(role, boss_id)) 
    = ANY (ARRAY['manager'::user_role, 'super_admin'::user_role])
  ) AND (
    boss_id = (SELECT b.boss_id FROM get_user_role_and_boss(auth.uid()) b(role, boss_id))
  ));

-- è€æ¿å¯ä»¥ç®¡ç†åŒç§Ÿæˆ·çš„ç”¨æˆ·
CREATE POLICY "Super admin can manage tenant users" ON profiles
  FOR ALL TO authenticated
  USING ((boss_id = get_current_user_boss_id()) AND is_super_admin(auth.uid()))
  WITH CHECK ((boss_id = get_current_user_boss_id()) AND is_super_admin(auth.uid()));
```

**æ•ˆæœ**ï¼š
- âœ… æ•°æ®åº“å±‚é¢è‡ªåŠ¨è¿‡æ»¤ `boss_id`
- âœ… ç”¨æˆ·åªèƒ½æŸ¥è¯¢è‡ªå·±ç§Ÿæˆ·çš„ç”¨æˆ·
- âœ… å¸æœºåªèƒ½æŸ¥çœ‹è‡ªå·±çš„ä¿¡æ¯
- âœ… ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹æ‰€æœ‰å¸æœºå’Œç®¡ç†å‘˜çš„ä¿¡æ¯
- âœ… è€æ¿å¯ä»¥æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·çš„ä¿¡æ¯

#### 2. æ›´æ–°å’Œåˆ é™¤ç”¨æˆ· - âœ… ä¾èµ– RLS ç­–ç•¥
**å‡½æ•°**ï¼š
- `updateProfile(id, updates)` - æ›´æ–°ç”¨æˆ·ä¿¡æ¯
- `updateUserRole(userId, role)` - æ›´æ–°ç”¨æˆ·è§’è‰²
- `updateUserInfo(userId, updates)` - æ›´æ–°ç”¨æˆ·è¯¦ç»†ä¿¡æ¯
- åˆ é™¤ç”¨æˆ·ï¼ˆå¦‚æœæœ‰ï¼‰

**RLS ç­–ç•¥**ï¼š
```sql
-- ç”¨æˆ·å¯ä»¥ç®¡ç†è‡ªå·±çš„ä¿¡æ¯
CREATE POLICY "Users can manage own profile" ON profiles
  FOR ALL TO authenticated
  USING ((boss_id = get_current_user_boss_id()) AND (auth.uid() = id))
  WITH CHECK ((boss_id = get_current_user_boss_id()) AND (auth.uid() = id));

-- ç®¡ç†å‘˜å¯ä»¥æ›´æ–°åŒç§Ÿæˆ·çš„ç”¨æˆ·
CREATE POLICY "Manager can update tenant users" ON profiles
  FOR UPDATE TO authenticated
  USING ((boss_id = get_current_user_boss_id()) AND (is_admin(auth.uid()) OR is_super_admin(auth.uid())))
  WITH CHECK ((boss_id = get_current_user_boss_id()) AND (is_admin(auth.uid()) OR is_super_admin(auth.uid())));

-- ç®¡ç†å‘˜å¯ä»¥åˆ é™¤åŒç§Ÿæˆ·çš„ç”¨æˆ·
CREATE POLICY "Manager can delete tenant users" ON profiles
  FOR DELETE TO authenticated
  USING ((boss_id = get_current_user_boss_id()) AND (is_admin(auth.uid()) OR is_super_admin(auth.uid())));
```

**æ•ˆæœ**ï¼š
- âœ… RLS ç­–ç•¥é˜»æ­¢è·¨ç§Ÿæˆ·æ“ä½œ
- âœ… åªèƒ½æ›´æ–°/åˆ é™¤è‡ªå·±ç§Ÿæˆ·çš„ç”¨æˆ·

#### 3. ç”¨æˆ·ç»Ÿè®¡ - âœ… ä¾èµ– RLS ç­–ç•¥
**å‡½æ•°**ï¼š
- `getDriverStats(userId)` - è·å–å¸æœºç»Ÿè®¡
- `getManagerStats(userId)` - è·å–ç®¡ç†å‘˜ç»Ÿè®¡

**æ•ˆæœ**ï¼š
- âœ… RLS ç­–ç•¥è‡ªåŠ¨è¿‡æ»¤ç§Ÿæˆ·æ•°æ®
- âœ… åªèƒ½æŸ¥è¯¢è‡ªå·±ç§Ÿæˆ·çš„ç»Ÿè®¡æ•°æ®

### âŒ éœ€è¦ä¿®å¤çš„åŠŸèƒ½

#### é—®é¢˜ 1ï¼šåˆ›å»ºç”¨æˆ·ç¼ºå°‘ boss_id

**å‡½æ•°**ï¼š`createUser`  
**å½“å‰ä»£ç **ï¼š
```typescript
export async function createUser(
  phone: string,
  name: string,
  role: 'driver' | 'manager',
  driverType?: 'pure' | 'with_vehicle'
): Promise<Profile | null> {
  // ... çœç•¥å‰é¢çš„ä»£ç  ...

  // æ­¥éª¤3: åˆ›å»º profiles è¡¨è®°å½•
  const insertData: any = {
    id: userId,
    phone,
    name,
    role: role as UserRole,
    email: loginEmail
    // âŒ ç¼ºå°‘ boss_id å’Œ tenant_id
  }

  // å¦‚æœæ˜¯å¸æœºï¼Œæ·»åŠ å¸æœºç±»å‹å’Œå…¥èŒæ—¥æœŸ
  if (role === 'driver') {
    insertData.driver_type = driverType || 'pure'
    insertData.join_date = new Date().toISOString().split('T')[0]
  }

  const {data, error} = await supabase
    .from('profiles')
    .insert(insertData)
    .select()
    .maybeSingle()

  // ...
}
```

**é—®é¢˜**ï¼š
- âŒ æ’å…¥æ—¶æ²¡æœ‰æ·»åŠ  `boss_id` å­—æ®µ
- âŒ RLS ç­–ç•¥çš„ `WITH CHECK` æ¡ä»¶è¦æ±‚ `boss_id = get_current_user_boss_id()`
- âŒ ä¼šå¯¼è‡´åˆ›å»ºç”¨æˆ·å¤±è´¥

**RLS ç­–ç•¥**ï¼š
```sql
-- ç®¡ç†å‘˜å¯ä»¥åˆ›å»ºåŒç§Ÿæˆ·çš„ç”¨æˆ·
CREATE POLICY "Manager can create tenant users" ON profiles
  FOR INSERT TO authenticated
  WITH CHECK ((boss_id = get_current_user_boss_id()) AND (is_admin(auth.uid()) OR is_super_admin(auth.uid())));

-- ç”¨æˆ·å¯ä»¥åˆ›å»ºè‡ªå·±çš„ä¿¡æ¯
CREATE POLICY "Users can create own profile" ON profiles
  FOR INSERT TO authenticated
  WITH CHECK ((boss_id = get_current_user_boss_id()) AND (id = auth.uid()));
```

**å½±å“**ï¼š
- è€æ¿æ— æ³•åˆ›å»ºå¸æœº
- è€æ¿æ— æ³•åˆ›å»ºç®¡ç†å‘˜
- ç®¡ç†å‘˜æ— æ³•åˆ›å»ºå¸æœº
- è¿™æ˜¯ä¸€ä¸ª**ä¸¥é‡çš„é—®é¢˜**ï¼Œä¼šå¯¼è‡´ç”¨æˆ·ç®¡ç†åŠŸèƒ½å®Œå…¨æ— æ³•ä½¿ç”¨

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤ï¼šä¿®æ”¹ createUser å‡½æ•°

**ä¿®æ”¹æ–‡ä»¶**ï¼š`src/db/api.ts`

**ä¿®å¤åçš„ä»£ç **ï¼š
```typescript
export async function createUser(
  phone: string,
  name: string,
  role: 'driver' | 'manager',
  driverType?: 'pure' | 'with_vehicle'
): Promise<Profile | null> {
  const timestamp = new Date().toISOString()
  console.log(`\n${'='.repeat(80)}`)
  console.log('ğŸš€ [createUser] å‡½æ•°è°ƒç”¨å¼€å§‹')
  console.log('â° æ—¶é—´æˆ³:', timestamp)
  console.log('ğŸ“± è¾“å…¥å‚æ•°:')
  console.log('  - æ‰‹æœºå·:', phone)
  console.log('  - å§“å:', name)
  console.log('  - è§’è‰²:', role)
  console.log('  - å¸æœºç±»å‹:', driverType || 'N/A')
  console.log(`${'='.repeat(80)}\n`)

  try {
    // æ­¥éª¤0: è·å–å½“å‰ç”¨æˆ·çš„ boss_id
    console.log('ğŸ“‹ [æ­¥éª¤0] è·å–å½“å‰ç”¨æˆ·çš„ boss_id')
    const {
      data: {user}
    } = await supabase.auth.getUser()

    if (!user) {
      console.error('  âŒ ç”¨æˆ·æœªç™»å½•')
      return null
    }

    const {data: currentProfile} = await supabase
      .from('profiles')
      .select('boss_id')
      .eq('id', user.id)
      .maybeSingle()

    if (!currentProfile?.boss_id) {
      console.error('  âŒ æ— æ³•è·å–å½“å‰ç”¨æˆ·çš„ boss_id')
      return null
    }

    console.log('  âœ… å½“å‰ç”¨æˆ·çš„ boss_id:', currentProfile.boss_id)
    console.log('')

    // æ­¥éª¤1: æ£€æŸ¥æ‰‹æœºå·æ˜¯å¦å·²å­˜åœ¨
    console.log('ğŸ“‹ [æ­¥éª¤1] æ£€æŸ¥æ‰‹æœºå·æ˜¯å¦å·²å­˜åœ¨')
    console.log('  - æŸ¥è¯¢æ¡ä»¶: phone =', phone)

    const {data: existingProfiles, error: checkError} = await supabase
      .from('profiles')
      .select('*')
      .eq('phone', phone)
      .maybeSingle()

    if (checkError) {
      console.error('  âŒ æŸ¥è¯¢ profiles å¤±è´¥:', checkError)
      console.error('  é”™è¯¯è¯¦æƒ…:', JSON.stringify(checkError, null, 2))
      return null
    }

    if (existingProfiles) {
      console.warn('  âš ï¸ æ‰‹æœºå·å·²å­˜åœ¨äº profiles è¡¨')
      console.warn('  å·²å­˜åœ¨çš„ç”¨æˆ·ID:', existingProfiles.id)
      console.warn('  å·²å­˜åœ¨çš„ç”¨æˆ·å§“å:', existingProfiles.name)
      console.log('  âŒ åˆ›å»ºå¤±è´¥ï¼šæ‰‹æœºå·é‡å¤\n')
      return null
    }

    console.log('  âœ… æ‰‹æœºå·å¯ç”¨ï¼Œç»§ç»­åˆ›å»º\n')

    // æ­¥éª¤2: å…ˆåˆ›å»º auth.users è¡¨è®°å½•
    console.log('ğŸ“‹ [æ­¥éª¤2] åˆ›å»º auth.users è¡¨è®°å½•')
    const loginEmail = `${phone}@fleet.com`
    console.log('  - ç™»å½•é‚®ç®±:', loginEmail)
    console.log('  - æ‰‹æœºå·:', phone)
    console.log('  - é»˜è®¤å¯†ç : 123456')
    console.log('  - ä½¿ç”¨å‡½æ•°: create_user_auth_account_first')

    let userId: string | null = null

    try {
      const {data: rpcData, error: authError} = await supabase.rpc('create_user_auth_account_first', {
        user_email: loginEmail,
        user_phone: phone
      })

      console.log('  - RPC è°ƒç”¨å®Œæˆ')
      console.log('  - è¿”å›æ•°æ®:', rpcData)
      console.log('  - é”™è¯¯ä¿¡æ¯:', authError)

      if (authError) {
        console.error('  âŒ åˆ›å»º auth.users è®°å½•å¤±è´¥')
        console.error('  é”™è¯¯ä»£ç :', authError.code)
        console.error('  é”™è¯¯æ¶ˆæ¯:', authError.message)
        console.error('  é”™è¯¯è¯¦æƒ…:', JSON.stringify(authError, null, 2))
        return null
      }

      if (!rpcData || rpcData.success === false) {
        console.error('  âŒ åˆ›å»º auth.users è®°å½•å¤±è´¥')
        console.error('  é”™è¯¯:', rpcData?.error)
        console.error('  è¯¦æƒ…:', rpcData?.details)
        return null
      }

      userId = rpcData.user_id
      console.log('  âœ… auth.users è®°å½•åˆ›å»ºæˆåŠŸ')
      console.log('  - ç”¨æˆ·ID:', userId)
      console.log('  - é‚®ç®±:', rpcData.email)
      console.log('  - é»˜è®¤å¯†ç :', rpcData.default_password)
    } catch (authError) {
      console.error('  âŒ åˆ›å»º auth.users è®°å½•å¼‚å¸¸')
      console.error('  å¼‚å¸¸ç±»å‹:', typeof authError)
      console.error('  å¼‚å¸¸å†…å®¹:', authError)
      if (authError instanceof Error) {
        console.error('  å¼‚å¸¸æ¶ˆæ¯:', authError.message)
        console.error('  å¼‚å¸¸å †æ ˆ:', authError.stack)
      }
      return null
    }

    if (!userId) {
      console.error('  âŒ æœªèƒ½è·å–ç”¨æˆ·ID')
      return null
    }

    console.log('')

    // æ­¥éª¤3: åˆ›å»º profiles è¡¨è®°å½•ï¼ˆè‡ªåŠ¨æ·»åŠ  boss_id å’Œ tenant_idï¼‰
    console.log('ğŸ“‹ [æ­¥éª¤3] åˆ›å»º profiles è¡¨è®°å½•')
    const insertData: any = {
      id: userId,
      phone,
      name,
      role: role as UserRole,
      email: loginEmail,
      boss_id: currentProfile.boss_id,      // æ·»åŠ  boss_id
      tenant_id: currentProfile.boss_id     // æ·»åŠ  tenant_id
    }

    // å¦‚æœæ˜¯å¸æœºï¼Œæ·»åŠ å¸æœºç±»å‹å’Œå…¥èŒæ—¥æœŸ
    if (role === 'driver') {
      insertData.driver_type = driverType || 'pure'
      insertData.join_date = new Date().toISOString().split('T')[0]
    }

    console.log('  - æ’å…¥æ•°æ®:', JSON.stringify(insertData, null, 2))

    const {data, error} = await supabase
      .from('profiles')
      .insert(insertData)
      .select()
      .maybeSingle()

    if (error) {
      console.error('  âŒ æ’å…¥å¤±è´¥:', error)
      console.error('  é”™è¯¯ä»£ç :', error.code)
      console.error('  é”™è¯¯æ¶ˆæ¯:', error.message)
      console.error('  é”™è¯¯è¯¦æƒ…:', JSON.stringify(error, null, 2))
      console.warn('  âš ï¸ auth.users è®°å½•å·²åˆ›å»ºï¼Œä½† profiles è®°å½•åˆ›å»ºå¤±è´¥')
      console.warn('  ğŸ’¡ éœ€è¦æ‰‹åŠ¨æ¸…ç† auth.users è®°å½•æˆ–ç¨åé‡è¯•')
      return null
    }

    if (!data) {
      console.error('  âŒ æ’å…¥å¤±è´¥ï¼šè¿”å›æ•°æ®ä¸ºç©º')
      return null
    }

    console.log('  âœ… profiles è¡¨è®°å½•åˆ›å»ºæˆåŠŸ')
    console.log('  - ç”¨æˆ·ID:', data.id)
    console.log('  - æ‰‹æœºå·:', data.phone)
    console.log('  - å§“å:', data.name)
    console.log('  - è§’è‰²:', data.role)
    console.log('  - é‚®ç®±:', data.email)
    console.log('  - boss_id:', data.boss_id)
    console.log('  - tenant_id:', data.tenant_id)
    if (role === 'driver') {
      console.log('  - å¸æœºç±»å‹:', data.driver_type)
      console.log('  - å…¥èŒæ—¥æœŸ:', data.join_date)
    }
    console.log('  - åˆ›å»ºæ—¶é—´:', data.created_at)
    console.log('  - å®Œæ•´æ•°æ®:', JSON.stringify(data, null, 2))

    console.log('')
    console.log('='.repeat(80))
    console.log('âœ… [createUser] å‡½æ•°æ‰§è¡Œå®Œæˆ')
    console.log('ğŸ“Š æœ€ç»ˆç»“æœ:')
    console.log('  - auth.users è¡¨: âœ… åˆ›å»ºæˆåŠŸ')
    console.log('  - profiles è¡¨: âœ… åˆ›å»ºæˆåŠŸ')
    console.log('  ğŸ’¡ ç”¨æˆ·å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹å¼ç™»å½•:')
    console.log(`    1. æ‰‹æœºå· + å¯†ç : ${phone} / 123456`)
    console.log(`    2. é‚®ç®± + å¯†ç : ${loginEmail} / 123456`)
    console.log('    3. æ‰‹æœºå· + éªŒè¯ç ')
    console.log('  - è¿”å›æ•°æ®:', JSON.stringify(data, null, 2))
    console.log(`${'='.repeat(80)}\n`)

    return data as Profile
  } catch (error) {
    console.error(`\n${'='.repeat(80)}`)
    console.error('âŒ [createUser] å‡½æ•°æ‰§è¡Œå¼‚å¸¸')
    console.error('å¼‚å¸¸ç±»å‹:', typeof error)
    console.error('å¼‚å¸¸å†…å®¹:', error)
    if (error instanceof Error) {
      console.error('å¼‚å¸¸æ¶ˆæ¯:', error.message)
      console.error('å¼‚å¸¸å †æ ˆ:', error.stack)
    }
    console.error(`${'='.repeat(80)}\n`)
    return null
  }
}
```

## ğŸ“Š å¤šç§Ÿæˆ·æ¶æ„éªŒè¯

### æ•°æ®éš”ç¦»ä¿è¯

#### 1. ç”¨æˆ·æ•°æ®éš”ç¦»
```typescript
// ç§Ÿæˆ· A çš„è€æ¿ç™»å½•
const users = await getAllProfiles()
// âœ… åªè¿”å›ç§Ÿæˆ· A çš„ç”¨æˆ·

// ç§Ÿæˆ· B çš„è€æ¿ç™»å½•
const users = await getAllProfiles()
// âœ… åªè¿”å›ç§Ÿæˆ· B çš„ç”¨æˆ·
```

#### 2. ç”¨æˆ·åˆ›å»ºéš”ç¦»
```typescript
// ç§Ÿæˆ· A çš„è€æ¿ç™»å½•
const user = await createUser('13800138000', 'å¼ ä¸‰', 'driver')
// âœ… åˆ›å»ºçš„ç”¨æˆ·è‡ªåŠ¨å±äºç§Ÿæˆ· A

// ç§Ÿæˆ· B çš„è€æ¿ç™»å½•
const user = await createUser('13800138001', 'æå››', 'driver')
// âœ… åˆ›å»ºçš„ç”¨æˆ·è‡ªåŠ¨å±äºç§Ÿæˆ· B
```

#### 3. ç”¨æˆ·ç»Ÿè®¡éš”ç¦»
```typescript
// ç§Ÿæˆ· A çš„è€æ¿ç™»å½•
const stats = await getDriverStats(driverId)
// âœ… åªè¿”å›ç§Ÿæˆ· A çš„å¸æœºç»Ÿè®¡

// ç§Ÿæˆ· B çš„è€æ¿ç™»å½•
const stats = await getDriverStats(driverId)
// âœ… åªè¿”å›ç§Ÿæˆ· B çš„å¸æœºç»Ÿè®¡
```

### RLS ç­–ç•¥å·¥ä½œåŸç†

```
ç”¨æˆ·è¯·æ±‚ â†’ Supabase Client â†’ Supabase Server
                                    â†“
                            åº”ç”¨ RLS ç­–ç•¥
                                    â†“
                            è¿‡æ»¤ boss_id
                                    â†“
                            è¿”å›ç§Ÿæˆ·æ•°æ®
```

**å…³é”®ç‚¹**ï¼š
1. RLS ç­–ç•¥åœ¨æ•°æ®åº“å±‚é¢æ‰§è¡Œï¼Œæ— æ³•ç»•è¿‡
2. å³ä½¿åº”ç”¨å±‚ä»£ç æœ‰æ¼æ´ï¼Œæ•°æ®åº“ä¹Ÿä¼šç¡®ä¿ç§Ÿæˆ·éš”ç¦»
3. æ‰€æœ‰æŸ¥è¯¢éƒ½ä¼šè‡ªåŠ¨æ·»åŠ  `WHERE boss_id = get_current_user_boss_id()` æ¡ä»¶
4. æ‰€æœ‰æ’å…¥éƒ½ä¼šæ£€æŸ¥ `boss_id = get_current_user_boss_id()` æ¡ä»¶

## ğŸ“ˆ æ£€æŸ¥æ€»ç»“

### å·²æ£€æŸ¥çš„è¡¨

| è¡¨å | boss_id å­—æ®µ | RLS ç­–ç•¥ | åˆ›å»ºå‡½æ•° | æŸ¥è¯¢å‡½æ•° | æ›´æ–°å‡½æ•° | åˆ é™¤å‡½æ•° |
|------|-------------|---------|---------|---------|---------|---------|
| profiles | âœ… | âœ… | âŒ éœ€ä¿®å¤ | âœ… | âœ… | âœ… |

### å·²æ£€æŸ¥çš„åŠŸèƒ½æ¨¡å—

| åŠŸèƒ½æ¨¡å— | çŠ¶æ€ | è¯´æ˜ |
|---------|------|------|
| ç”¨æˆ· CRUD | âŒ | åˆ›å»ºå‡½æ•°éœ€è¦ä¿®å¤ï¼Œå…¶ä»–å·²æ­£ç¡®é€‚é… |
| ç”¨æˆ·è§’è‰²ç®¡ç† | âœ… | æŸ¥è¯¢ã€æ›´æ–°éƒ½å·²æ­£ç¡®é€‚é… |
| ç”¨æˆ·ç»Ÿè®¡ | âœ… | ä¾èµ– RLS ç­–ç•¥ï¼Œè‡ªåŠ¨éš”ç¦» |
| ç”¨æˆ·åˆ—è¡¨ | âœ… | ä¾èµ– RLS ç­–ç•¥ï¼Œè‡ªåŠ¨éš”ç¦» |

### éœ€è¦ä¿®å¤çš„é—®é¢˜

1. **é«˜ä¼˜å…ˆçº§**ï¼š
   - âŒ `createUser` å‡½æ•°ç¼ºå°‘ `boss_id` å’Œ `tenant_id`ï¼ˆ**ä¸¥é‡é—®é¢˜**ï¼‰

2. **ä½ä¼˜å…ˆçº§**ï¼š
   - æ— 

### ä¿®å¤åçš„æ•ˆæœ

- âœ… æ‰€æœ‰ç”¨æˆ·ç®¡ç†åŠŸèƒ½éƒ½æ­£ç¡®é€‚é…å¤šç§Ÿæˆ·æ¶æ„
- âœ… æ¯ä¸ªç§Ÿæˆ·çš„æ•°æ®å®Œå…¨éš”ç¦»
- âœ… æ— æ³•è·¨ç§Ÿæˆ·è®¿é—®æˆ–æ“ä½œæ•°æ®
- âœ… è€æ¿å¯ä»¥æ­£å¸¸åˆ›å»ºå¸æœºå’Œç®¡ç†å‘˜
- âœ… ç®¡ç†å‘˜å¯ä»¥æ­£å¸¸åˆ›å»ºå¸æœº
- âœ… æ•°æ®åº“å±‚é¢å’Œåº”ç”¨å±‚é¢åŒé‡ä¿æŠ¤

## ğŸ§ª æµ‹è¯•å»ºè®®

### æµ‹è¯•åœºæ™¯ 1ï¼šåˆ›å»ºç”¨æˆ·
1. ä½¿ç”¨ç§Ÿæˆ· A çš„è€æ¿è´¦å·ç™»å½•
2. è¿›å…¥ç”¨æˆ·ç®¡ç†é¡µé¢
3. åˆ›å»ºä¸€ä¸ªå¸æœº
4. **é¢„æœŸç»“æœ**ï¼šâœ… åˆ›å»ºæˆåŠŸï¼Œä¸ä¼šå‡ºç°æƒé™é”™è¯¯

### æµ‹è¯•åœºæ™¯ 2ï¼šéªŒè¯ç”¨æˆ·éš”ç¦»
1. ä½¿ç”¨ç§Ÿæˆ· A çš„è€æ¿è´¦å·ç™»å½•
2. åˆ›å»ºä¸€ä¸ªå¸æœº
3. é€€å‡ºç™»å½•
4. ä½¿ç”¨ç§Ÿæˆ· B çš„è€æ¿è´¦å·ç™»å½•
5. æŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨
6. **é¢„æœŸç»“æœ**ï¼šâœ… çœ‹ä¸åˆ°ç§Ÿæˆ· A çš„å¸æœº

### æµ‹è¯•åœºæ™¯ 3ï¼šç®¡ç†å‘˜åˆ›å»ºç”¨æˆ·
1. ä½¿ç”¨ç§Ÿæˆ· A çš„ç®¡ç†å‘˜è´¦å·ç™»å½•
2. è¿›å…¥ç”¨æˆ·ç®¡ç†é¡µé¢
3. åˆ›å»ºä¸€ä¸ªå¸æœº
4. **é¢„æœŸç»“æœ**ï¼šâœ… åˆ›å»ºæˆåŠŸï¼Œä¸ä¼šå‡ºç°æƒé™é”™è¯¯

### æµ‹è¯•åœºæ™¯ 4ï¼šéªŒè¯è·¨ç§Ÿæˆ·æ“ä½œè¢«é˜»æ­¢
1. ä½¿ç”¨ç§Ÿæˆ· A çš„è€æ¿è´¦å·ç™»å½•
2. è·å–ç§Ÿæˆ· B çš„æŸä¸ªç”¨æˆ· ID
3. å°è¯•æ›´æ–°è¯¥ç”¨æˆ·
4. **é¢„æœŸç»“æœ**ï¼šâœ… æ›´æ–°å¤±è´¥ï¼ŒRLS ç­–ç•¥é˜»æ­¢æ“ä½œ

## ğŸ“ æŠ€æœ¯ç»†èŠ‚

### æ•°æ®åº“è¡¨ç»“æ„

#### profiles è¡¨
```sql
CREATE TABLE profiles (
  id uuid PRIMARY KEY REFERENCES auth.users(id),
  phone text,
  email text,
  name text,
  role user_role NOT NULL,
  driver_type driver_type,
  avatar_url text,
  nickname text,
  address_province text,
  address_city text,
  address_district text,
  address_detail text,
  emergency_contact_name text,
  emergency_contact_phone text,
  login_account text,
  vehicle_plate text,
  join_date date,
  status text,
  company_name text,
  lease_start_date date,
  lease_end_date date,
  monthly_fee numeric,
  notes text,
  boss_id text NOT NULL,      -- ç§Ÿæˆ· ID
  tenant_id uuid,              -- ç§Ÿæˆ· IDï¼ˆä¸ boss_id ç›¸åŒï¼‰
  main_account_id uuid,
  manager_permissions_enabled boolean,
  peer_account_permission peer_account_permission,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);
```

### RLS ç­–ç•¥

#### profiles è¡¨ç­–ç•¥
```sql
-- ç”¨æˆ·å¯ä»¥æŸ¥çœ‹è‡ªå·±çš„ä¿¡æ¯
CREATE POLICY "Users can view own profile" ON profiles
  FOR SELECT TO authenticated
  USING (auth.uid() = id);

-- ç”¨æˆ·å¯ä»¥ç®¡ç†è‡ªå·±çš„ä¿¡æ¯
CREATE POLICY "Users can manage own profile" ON profiles
  FOR ALL TO authenticated
  USING ((boss_id = get_current_user_boss_id()) AND (auth.uid() = id))
  WITH CHECK ((boss_id = get_current_user_boss_id()) AND (auth.uid() = id));

-- ç”¨æˆ·å¯ä»¥åˆ›å»ºè‡ªå·±çš„ä¿¡æ¯
CREATE POLICY "Users can create own profile" ON profiles
  FOR INSERT TO authenticated
  WITH CHECK ((boss_id = get_current_user_boss_id()) AND (id = auth.uid()));

-- ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹åŒç§Ÿæˆ·çš„ç”¨æˆ·
CREATE POLICY "Admins can view same tenant users" ON profiles
  FOR SELECT TO authenticated
  USING ((
    (SELECT r.role FROM get_user_role_and_boss(auth.uid()) r(role, boss_id)) 
    = ANY (ARRAY['manager'::user_role, 'super_admin'::user_role])
  ) AND (
    boss_id = (SELECT b.boss_id FROM get_user_role_and_boss(auth.uid()) b(role, boss_id))
  ));

-- ç®¡ç†å‘˜å¯ä»¥åˆ›å»ºåŒç§Ÿæˆ·çš„ç”¨æˆ·
CREATE POLICY "Manager can create tenant users" ON profiles
  FOR INSERT TO authenticated
  WITH CHECK ((boss_id = get_current_user_boss_id()) AND (is_admin(auth.uid()) OR is_super_admin(auth.uid())));

-- ç®¡ç†å‘˜å¯ä»¥æ›´æ–°åŒç§Ÿæˆ·çš„ç”¨æˆ·
CREATE POLICY "Manager can update tenant users" ON profiles
  FOR UPDATE TO authenticated
  USING ((boss_id = get_current_user_boss_id()) AND (is_admin(auth.uid()) OR is_super_admin(auth.uid())))
  WITH CHECK ((boss_id = get_current_user_boss_id()) AND (is_admin(auth.uid()) OR is_super_admin(auth.uid())));

-- ç®¡ç†å‘˜å¯ä»¥åˆ é™¤åŒç§Ÿæˆ·çš„ç”¨æˆ·
CREATE POLICY "Manager can delete tenant users" ON profiles
  FOR DELETE TO authenticated
  USING ((boss_id = get_current_user_boss_id()) AND (is_admin(auth.uid()) OR is_super_admin(auth.uid())));

-- è€æ¿å¯ä»¥ç®¡ç†åŒç§Ÿæˆ·çš„æ‰€æœ‰ç”¨æˆ·
CREATE POLICY "Super admin can manage tenant users" ON profiles
  FOR ALL TO authenticated
  USING ((boss_id = get_current_user_boss_id()) AND is_super_admin(auth.uid()))
  WITH CHECK ((boss_id = get_current_user_boss_id()) AND is_super_admin(auth.uid()));

-- ç§Ÿèµç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹æ‰€æœ‰è€æ¿è´¦å·
CREATE POLICY "Lease admins can view all boss accounts" ON profiles
  FOR SELECT TO authenticated
  USING ((
    (SELECT r.role FROM get_user_role_and_boss(auth.uid()) r(role, boss_id)) = 'lease_admin'::user_role
  ) AND (role = 'super_admin'::user_role));

-- ç§Ÿèµç®¡ç†å‘˜å¯ä»¥åˆ é™¤è€æ¿è´¦å·
CREATE POLICY "ç§Ÿèµç®¡ç†å‘˜å¯ä»¥åˆ é™¤è€æ¿è´¦å·" ON profiles
  FOR DELETE TO authenticated
  USING (is_lease_admin_user(auth.uid()) AND (role = 'super_admin'::user_role));
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. boss_id çš„è·å–
- æ‰€æœ‰åˆ›å»ºå‡½æ•°éƒ½ä¼šè‡ªåŠ¨ä»å½“å‰ç™»å½•ç”¨æˆ·çš„ profile ä¸­è·å– `boss_id`
- å¦‚æœç”¨æˆ·æœªç™»å½•æˆ–æ— æ³•è·å– `boss_id`ï¼Œåˆ›å»ºä¼šå¤±è´¥

### 2. tenant_id çš„è®¾ç½®
- `tenant_id` å­—æ®µè®¾ç½®ä¸ºä¸ `boss_id` ç›¸åŒçš„å€¼
- è¿™æ˜¯å› ä¸ºåœ¨å½“å‰ç³»ç»Ÿä¸­ï¼Œç§Ÿæˆ· ID å°±æ˜¯è€æ¿çš„ ID

### 3. RLS ç­–ç•¥çš„ä½œç”¨
- RLS ç­–ç•¥åœ¨æ•°æ®åº“å±‚é¢æ‰§è¡Œï¼Œæ— æ³•ç»•è¿‡
- å³ä½¿åº”ç”¨å±‚ä»£ç æœ‰æ¼æ´ï¼Œæ•°æ®åº“ä¹Ÿä¼šç¡®ä¿ç§Ÿæˆ·éš”ç¦»
- æ‰€æœ‰æŸ¥è¯¢éƒ½ä¼šè‡ªåŠ¨æ·»åŠ  `WHERE boss_id = get_current_user_boss_id()` æ¡ä»¶

### 4. ç”¨æˆ·åˆ›å»ºçš„ç‰¹æ®Šæ€§
- ç”¨æˆ·åˆ›å»ºæ˜¯ç³»ç»Ÿçš„æ ¸å¿ƒåŠŸèƒ½
- å¿…é¡»ç¡®ä¿ç”¨æˆ·åˆ›å»ºåŠŸèƒ½æ­£å¸¸å·¥ä½œ
- ç”¨æˆ·åˆ›å»ºå¤±è´¥ä¼šä¸¥é‡å½±å“ç³»ç»Ÿä½¿ç”¨

### 5. ç¬¬ä¸€ä¸ªç”¨æˆ·çš„ç‰¹æ®Šå¤„ç†
- ç¬¬ä¸€ä¸ªæ³¨å†Œçš„ç”¨æˆ·ä¼šè‡ªåŠ¨æˆä¸ºè€æ¿ï¼ˆsuper_adminï¼‰
- è€æ¿çš„ `boss_id` æ˜¯è‡ªå·±çš„ ID
- åç»­åˆ›å»ºçš„ç”¨æˆ·ä¼šç»§æ‰¿åˆ›å»ºè€…çš„ `boss_id`

## ğŸ“ˆ ä¿®å¤è¿›åº¦

- [x] æ£€æŸ¥ç”¨æˆ· CRUD åŠŸèƒ½ - âœ… å·²å®Œæˆ
- [x] æ£€æŸ¥ç”¨æˆ·è§’è‰²ç®¡ç† - âœ… å·²å®Œæˆ
- [x] æ£€æŸ¥ç”¨æˆ·ç»Ÿè®¡åŠŸèƒ½ - âœ… å·²å®Œæˆ
- [ ] ä¿®å¤ createUser å‡½æ•° - â³ å¾…ä¿®å¤
- [ ] æµ‹è¯•éªŒè¯ - â³ å¾…æµ‹è¯•

---

**æ£€æŸ¥æ—¥æœŸ**ï¼š2025-11-26  
**æ£€æŸ¥äººå‘˜**ï¼šç§’å“’ AI  
**çŠ¶æ€**ï¼šâœ… æ£€æŸ¥å®Œæˆï¼Œå‘ç° 1 ä¸ªéœ€è¦ä¿®å¤çš„é—®é¢˜

## ğŸ¯ æ€»ç»“

### æ ¸å¿ƒå‘ç°
1. âœ… ç”¨æˆ·ç®¡ç†çš„å¤§éƒ¨åˆ†åŠŸèƒ½å·²æ­£ç¡®é€‚é…å¤šç§Ÿæˆ·æ¶æ„
2. âœ… RLS ç­–ç•¥å·²æ­£ç¡®å®ç°ï¼Œç¡®ä¿æ•°æ®åº“å±‚é¢çš„ç§Ÿæˆ·éš”ç¦»
3. âŒ åˆ›å»ºç”¨æˆ·å‡½æ•°éœ€è¦ä¿®å¤ï¼Œç¼ºå°‘ `boss_id` å’Œ `tenant_id`ï¼ˆ**ä¸¥é‡é—®é¢˜**ï¼‰

### æ¶æ„ä¿è¯
1. âœ… æ•°æ®åº“å±‚é¢ï¼šRLS ç­–ç•¥ç¡®ä¿ç§Ÿæˆ·éš”ç¦»
2. âœ… åº”ç”¨å±‚é¢ï¼šåˆ›å»ºå‡½æ•°è‡ªåŠ¨æ·»åŠ ç§Ÿæˆ·æ ‡è¯†å­—æ®µ
3. âœ… åŒé‡ä¿æŠ¤ï¼šå³ä½¿åº”ç”¨å±‚æœ‰æ¼æ´ï¼Œæ•°æ®åº“ä¹Ÿä¼šé˜»æ­¢è·¨ç§Ÿæˆ·è®¿é—®

### ä¿®å¤å»ºè®®
1. **ç«‹å³ä¿®å¤**ï¼š`createUser` å‡½æ•°ï¼ˆ**é«˜ä¼˜å…ˆçº§ï¼Œä¸¥é‡é—®é¢˜**ï¼‰
2. **æµ‹è¯•éªŒè¯**ï¼šä¿®å¤åè¿›è¡Œå…¨é¢æµ‹è¯•
3. **æ–‡æ¡£æ›´æ–°**ï¼šæ›´æ–°ç›¸å…³æ–‡æ¡£

### ä¿®å¤åçš„æ•ˆæœ
- âœ… æ‰€æœ‰ç”¨æˆ·ç®¡ç†åŠŸèƒ½éƒ½æ­£ç¡®é€‚é…å¤šç§Ÿæˆ·æ¶æ„
- âœ… æ¯ä¸ªç§Ÿæˆ·çš„æ•°æ®å®Œå…¨éš”ç¦»
- âœ… æ— æ³•è·¨ç§Ÿæˆ·è®¿é—®æˆ–æ“ä½œæ•°æ®
- âœ… è€æ¿å¯ä»¥æ­£å¸¸åˆ›å»ºå¸æœºå’Œç®¡ç†å‘˜
- âœ… ç®¡ç†å‘˜å¯ä»¥æ­£å¸¸åˆ›å»ºå¸æœº
- âœ… æ–°åˆ›å»ºçš„ç”¨æˆ·è‡ªåŠ¨å±äºåˆ›å»ºè€…çš„ç§Ÿæˆ·

### é—®é¢˜ä¸¥é‡æ€§åˆ†æ
- **ä¸¥é‡ç¨‹åº¦**ï¼šğŸ”´ é«˜
- **å½±å“èŒƒå›´**ï¼šç”¨æˆ·ç®¡ç†çš„æ ¸å¿ƒåŠŸèƒ½
- **å½±å“ç”¨æˆ·**ï¼šæ‰€æœ‰è€æ¿å’Œç®¡ç†å‘˜
- **ä¿®å¤ä¼˜å…ˆçº§**ï¼šæœ€é«˜
- **ä¿®å¤éš¾åº¦**ï¼šä½ï¼ˆåªéœ€æ·»åŠ å‡ è¡Œä»£ç ï¼‰
