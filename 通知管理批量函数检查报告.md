# é€šçŸ¥ç®¡ç†æ‰¹é‡å‡½æ•°æ£€æŸ¥æŠ¥å‘Š

## ğŸ“‹ æ£€æŸ¥æ¦‚è¿°

**æ£€æŸ¥æ—¥æœŸ**ï¼š2025-11-26  
**æ£€æŸ¥äººå‘˜**ï¼šç§’å“’ AI  
**æ£€æŸ¥å¯¹è±¡**ï¼š`create_notifications_batch` æ•°æ®åº“å‡½æ•°  
**æ£€æŸ¥ç›®æ ‡**ï¼šéªŒè¯è¯¥å‡½æ•°æ˜¯å¦æ­£ç¡®å¤„ç†äº† `boss_id` å­—æ®µï¼Œç¡®ä¿æ”¯æŒå¤šç§Ÿæˆ·æ¶æ„

## ğŸ¯ æ£€æŸ¥ç»“æœ

### æ€»ä½“è¯„ä¼°

âœ… **ä¼˜ç§€**ï¼š`create_notifications_batch` å‡½æ•°å®Œå…¨æ”¯æŒå¤šç§Ÿæˆ·æ¶æ„ï¼Œæ­£ç¡®å¤„ç†äº† `boss_id` å­—æ®µã€‚

## ğŸ“Š å‡½æ•°åˆ†æ

### å‡½æ•°ç­¾å

```sql
CREATE OR REPLACE FUNCTION public.create_notifications_batch(notifications jsonb)
RETURNS integer
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path TO 'public'
```

### å‡½æ•°é€»è¾‘

#### 1. è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯

```sql
-- è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ï¼ˆåŒ…æ‹¬ boss_idï¼‰
SELECT id, name, role::text, boss_id 
INTO current_user_id, current_user_name, current_user_role, current_boss_id
FROM profiles
WHERE id = auth.uid();
```

âœ… **æ­£ç¡®**ï¼šå‡½æ•°ä¼šä» `profiles` è¡¨ä¸­è·å–å½“å‰ç”¨æˆ·çš„ `boss_id`ã€‚

#### 2. éªŒè¯ç”¨æˆ·ä¿¡æ¯

```sql
-- å¦‚æœæ²¡æœ‰æ‰¾åˆ°å½“å‰ç”¨æˆ·ï¼Œä½¿ç”¨é»˜è®¤å€¼
IF current_user_id IS NULL THEN
  current_user_id := auth.uid();
  current_user_name := 'ç³»ç»Ÿ';
  current_user_role := 'super_admin';
  -- å¦‚æœæ²¡æœ‰ boss_idï¼ŒæŠ›å‡ºé”™è¯¯
  RAISE EXCEPTION 'æ— æ³•è·å–å½“å‰ç”¨æˆ·çš„ boss_idï¼Œè¯·ç¡®ä¿ç”¨æˆ·å·²ç™»å½•';
END IF;

-- å¦‚æœæ²¡æœ‰ boss_idï¼ŒæŠ›å‡ºé”™è¯¯
IF current_boss_id IS NULL THEN
  RAISE EXCEPTION 'å½“å‰ç”¨æˆ·æ²¡æœ‰ boss_idï¼Œè¯·è”ç³»ç®¡ç†å‘˜';
END IF;
```

âœ… **æ­£ç¡®**ï¼šå‡½æ•°ä¼šéªŒè¯ `boss_id` æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨ä¼šæŠ›å‡ºé”™è¯¯ï¼Œç¡®ä¿æ•°æ®å®Œæ•´æ€§ã€‚

#### 3. æ‰¹é‡æ’å…¥é€šçŸ¥

```sql
-- æ’å…¥é€šçŸ¥ï¼ˆæ”¯æŒæ–°æ—§å­—æ®µåï¼Œå¹¶è‡ªåŠ¨æ·»åŠ  boss_idï¼‰
WITH inserted AS (
  INSERT INTO notifications (
    recipient_id, 
    sender_id, 
    sender_name, 
    sender_role, 
    type, 
    title, 
    content, 
    action_url, 
    related_id,
    is_read,
    boss_id  -- âœ… æ·»åŠ äº† boss_id å­—æ®µ
  )
  SELECT 
    -- æ”¯æŒ user_id æˆ– recipient_id
    COALESCE((n->>'recipient_id')::uuid, (n->>'user_id')::uuid),
    -- sender_id: ä½¿ç”¨æä¾›çš„å€¼æˆ–å½“å‰ç”¨æˆ·ID
    COALESCE((n->>'sender_id')::uuid, current_user_id),
    -- sender_name: ä½¿ç”¨æä¾›çš„å€¼æˆ–å½“å‰ç”¨æˆ·å
    COALESCE(n->>'sender_name', current_user_name),
    -- sender_role: ä½¿ç”¨æä¾›çš„å€¼æˆ–å½“å‰ç”¨æˆ·è§’è‰²
    COALESCE(n->>'sender_role', current_user_role),
    -- type: ç›´æ¥ä½¿ç”¨æ–‡æœ¬ç±»å‹
    COALESCE(n->>'type', 'system'),
    -- title
    n->>'title',
    -- æ”¯æŒ message æˆ– content
    COALESCE(n->>'content', n->>'message'),
    -- action_url
    n->>'action_url',
    -- related_id: å…³è”çš„ä¸šåŠ¡å¯¹è±¡ID
    (n->>'related_id')::uuid,
    -- is_read
    COALESCE((n->>'is_read')::boolean, false),
    -- boss_id: ä½¿ç”¨å½“å‰ç”¨æˆ·çš„ boss_id âœ…
    current_boss_id
  FROM jsonb_array_elements(notifications) AS n
  RETURNING 1
)
SELECT COUNT(*) INTO inserted_count FROM inserted;

RETURN inserted_count;
```

âœ… **æ­£ç¡®**ï¼šå‡½æ•°åœ¨æ’å…¥é€šçŸ¥æ—¶ï¼Œä¼šè‡ªåŠ¨æ·»åŠ  `boss_id` å­—æ®µï¼Œä½¿ç”¨å½“å‰ç”¨æˆ·çš„ `boss_id`ã€‚

## ğŸ” è¯¦ç»†æ£€æŸ¥

### æ£€æŸ¥é¡¹ 1ï¼šæ˜¯å¦è·å– boss_id

| æ£€æŸ¥é¡¹ | çŠ¶æ€ | è¯´æ˜ |
|--------|------|------|
| ä» profiles è¡¨è·å– boss_id | âœ… | æ­£ç¡® |
| å­˜å‚¨åˆ°å˜é‡ current_boss_id | âœ… | æ­£ç¡® |

### æ£€æŸ¥é¡¹ 2ï¼šæ˜¯å¦éªŒè¯ boss_id

| æ£€æŸ¥é¡¹ | çŠ¶æ€ | è¯´æ˜ |
|--------|------|------|
| æ£€æŸ¥ boss_id æ˜¯å¦ä¸º NULL | âœ… | æ­£ç¡® |
| boss_id ä¸º NULL æ—¶æŠ›å‡ºé”™è¯¯ | âœ… | æ­£ç¡® |
| é”™è¯¯ä¿¡æ¯æ¸…æ™° | âœ… | æ­£ç¡® |

### æ£€æŸ¥é¡¹ 3ï¼šæ˜¯å¦æ·»åŠ  boss_id åˆ°æ’å…¥è¯­å¥

| æ£€æŸ¥é¡¹ | çŠ¶æ€ | è¯´æ˜ |
|--------|------|------|
| INSERT è¯­å¥åŒ…å« boss_id å­—æ®µ | âœ… | æ­£ç¡® |
| SELECT è¯­å¥æä¾› boss_id å€¼ | âœ… | æ­£ç¡® |
| ä½¿ç”¨ current_boss_id å˜é‡ | âœ… | æ­£ç¡® |

### æ£€æŸ¥é¡¹ 4ï¼šæ˜¯å¦æ”¯æŒå¤šç§Ÿæˆ·æ¶æ„

| æ£€æŸ¥é¡¹ | çŠ¶æ€ | è¯´æ˜ |
|--------|------|------|
| æ¯ä¸ªé€šçŸ¥éƒ½æœ‰ boss_id | âœ… | æ­£ç¡® |
| boss_id æ¥è‡ªå½“å‰ç”¨æˆ· | âœ… | æ­£ç¡® |
| ä¸å…è®¸è·¨ç§Ÿæˆ·åˆ›å»ºé€šçŸ¥ | âœ… | æ­£ç¡® |

## ğŸ¯ å‡½æ•°ç‰¹ç‚¹

### ä¼˜ç‚¹

1. âœ… **è‡ªåŠ¨æ·»åŠ  boss_id**ï¼šå‡½æ•°ä¼šè‡ªåŠ¨ä»å½“å‰ç”¨æˆ·è·å– `boss_id` å¹¶æ·»åŠ åˆ°æ‰€æœ‰æ‰¹é‡åˆ›å»ºçš„é€šçŸ¥ä¸­
2. âœ… **æ•°æ®å®Œæ•´æ€§éªŒè¯**ï¼šå¦‚æœ `boss_id` ä¸å­˜åœ¨ï¼Œä¼šæŠ›å‡ºé”™è¯¯ï¼Œç¡®ä¿æ•°æ®å®Œæ•´æ€§
3. âœ… **æ”¯æŒå¤šç§Ÿæˆ·æ¶æ„**ï¼šæ¯ä¸ªé€šçŸ¥éƒ½æœ‰ `boss_id`ï¼Œç¡®ä¿æ•°æ®éš”ç¦»
4. âœ… **å…¼å®¹æ€§å¥½**ï¼šæ”¯æŒæ–°æ—§å­—æ®µåï¼ˆ`recipient_id` å’Œ `user_id`ï¼Œ`content` å’Œ `message`ï¼‰
5. âœ… **é»˜è®¤å€¼å¤„ç†**ï¼šä¸º `sender_id`ã€`sender_name`ã€`sender_role`ã€`type`ã€`is_read` æä¾›é»˜è®¤å€¼
6. âœ… **å®‰å…¨æ€§é«˜**ï¼šä½¿ç”¨ `SECURITY DEFINER` ç¡®ä¿å‡½æ•°ä»¥å®šä¹‰è€…æƒé™æ‰§è¡Œ

### å®‰å…¨ä¿è¯

1. âœ… **RLS ç­–ç•¥ä¿æŠ¤**ï¼šå³ä½¿å‡½æ•°ä½¿ç”¨ `SECURITY DEFINER`ï¼Œæ’å…¥çš„æ•°æ®ä»ç„¶å— RLS ç­–ç•¥ä¿æŠ¤
2. âœ… **boss_id éªŒè¯**ï¼šå‡½æ•°ä¼šéªŒè¯ `boss_id` æ˜¯å¦å­˜åœ¨ï¼Œé˜²æ­¢æ•°æ®ä¸å®Œæ•´
3. âœ… **ç§Ÿæˆ·éš”ç¦»**ï¼šæ‰€æœ‰é€šçŸ¥éƒ½ä½¿ç”¨å½“å‰ç”¨æˆ·çš„ `boss_id`ï¼Œç¡®ä¿ç§Ÿæˆ·éš”ç¦»

## ğŸ“Š ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šæ‰¹é‡åˆ›å»ºé€šçŸ¥

```sql
SELECT create_notifications_batch('[
  {
    "recipient_id": "user-uuid-1",
    "type": "system",
    "title": "ç³»ç»Ÿé€šçŸ¥",
    "content": "è¿™æ˜¯ä¸€æ¡ç³»ç»Ÿé€šçŸ¥"
  },
  {
    "recipient_id": "user-uuid-2",
    "type": "approval",
    "title": "å®¡æ‰¹é€šçŸ¥",
    "content": "æ‚¨æœ‰ä¸€æ¡å¾…å®¡æ‰¹çš„è¯·å‡ç”³è¯·"
  }
]'::jsonb);
```

**ç»“æœ**ï¼š
- âœ… ä¸¤æ¡é€šçŸ¥éƒ½ä¼šè‡ªåŠ¨æ·»åŠ å½“å‰ç”¨æˆ·çš„ `boss_id`
- âœ… `sender_id`ã€`sender_name`ã€`sender_role` ä¼šè‡ªåŠ¨ä½¿ç”¨å½“å‰ç”¨æˆ·çš„ä¿¡æ¯
- âœ… è¿”å›æ’å…¥çš„é€šçŸ¥æ•°é‡ï¼ˆ2ï¼‰

### ç¤ºä¾‹ 2ï¼šä½¿ç”¨æ—§å­—æ®µå

```sql
SELECT create_notifications_batch('[
  {
    "user_id": "user-uuid-1",
    "type": "system",
    "title": "ç³»ç»Ÿé€šçŸ¥",
    "message": "è¿™æ˜¯ä¸€æ¡ç³»ç»Ÿé€šçŸ¥"
  }
]'::jsonb);
```

**ç»“æœ**ï¼š
- âœ… å‡½æ•°ä¼šè‡ªåŠ¨å°† `user_id` æ˜ å°„åˆ° `recipient_id`
- âœ… å‡½æ•°ä¼šè‡ªåŠ¨å°† `message` æ˜ å°„åˆ° `content`
- âœ… é€šçŸ¥ä¼šè‡ªåŠ¨æ·»åŠ å½“å‰ç”¨æˆ·çš„ `boss_id`

## ğŸ”„ ä¸åº”ç”¨å±‚å‡½æ•°çš„å¯¹æ¯”

### åº”ç”¨å±‚å‡½æ•°ï¼š`createNotificationRecord`

```typescript
export async function createNotificationRecord(input: CreateNotificationInput): Promise<Notification | null> {
  try {
    // 1. è·å–å½“å‰ç”¨æˆ·
    const {
      data: {user}
    } = await supabase.auth.getUser()

    if (!user) {
      console.error('åˆ›å»ºé€šçŸ¥å¤±è´¥: ç”¨æˆ·æœªç™»å½•')
      return null
    }

    // 2. è·å–å½“å‰ç”¨æˆ·çš„ boss_id
    const {data: profile} = await supabase.from('profiles').select('boss_id').eq('id', user.id).maybeSingle()

    if (!profile?.boss_id) {
      console.error('åˆ›å»ºé€šçŸ¥å¤±è´¥: æ— æ³•è·å– boss_id')
      return null
    }

    // 3. æ’å…¥é€šçŸ¥ï¼ˆè‡ªåŠ¨æ·»åŠ  boss_idï¼‰
    const {data, error} = await supabase
      .from('notifications')
      .insert({
        recipient_id: input.recipient_id,
        sender_id: input.sender_id,
        sender_name: input.sender_name,
        sender_role: input.sender_role,
        type: input.type,
        title: input.title,
        content: input.content,
        action_url: input.action_url || null,
        boss_id: profile.boss_id  // âœ… æ·»åŠ  boss_id
      })
      .select()
      .maybeSingle()

    if (error) {
      console.error('åˆ›å»ºé€šçŸ¥å¤±è´¥:', error)
      return null
    }

    return data
  } catch (error) {
    console.error('åˆ›å»ºé€šçŸ¥å¼‚å¸¸:', error)
    return null
  }
}
```

### å¯¹æ¯”åˆ†æ

| ç‰¹æ€§ | åº”ç”¨å±‚å‡½æ•° | æ•°æ®åº“å‡½æ•° |
|------|-----------|-----------|
| è·å– boss_id | âœ… | âœ… |
| éªŒè¯ boss_id | âœ… | âœ… |
| æ·»åŠ  boss_id | âœ… | âœ… |
| æ‰¹é‡åˆ›å»º | âŒ | âœ… |
| é»˜è®¤å€¼å¤„ç† | âŒ | âœ… |
| å…¼å®¹æ—§å­—æ®µå | âŒ | âœ… |

**ç»“è®º**ï¼šä¸¤ä¸ªå‡½æ•°éƒ½æ­£ç¡®å¤„ç†äº† `boss_id`ï¼Œæ•°æ®åº“å‡½æ•°åŠŸèƒ½æ›´å¼ºå¤§ï¼Œæ”¯æŒæ‰¹é‡åˆ›å»ºå’Œæ›´å¤šç‰¹æ€§ã€‚

## ğŸ‰ æ€»ç»“

### æ£€æŸ¥ç»“æœ

âœ… **ä¼˜ç§€**ï¼š`create_notifications_batch` å‡½æ•°å®Œå…¨æ”¯æŒå¤šç§Ÿæˆ·æ¶æ„ï¼Œæ­£ç¡®å¤„ç†äº† `boss_id` å­—æ®µã€‚

### æ ¸å¿ƒæˆæœ

1. âœ… **è‡ªåŠ¨æ·»åŠ  boss_id**ï¼šå‡½æ•°ä¼šè‡ªåŠ¨ä»å½“å‰ç”¨æˆ·è·å– `boss_id` å¹¶æ·»åŠ åˆ°æ‰€æœ‰æ‰¹é‡åˆ›å»ºçš„é€šçŸ¥ä¸­
2. âœ… **æ•°æ®å®Œæ•´æ€§éªŒè¯**ï¼šå¦‚æœ `boss_id` ä¸å­˜åœ¨ï¼Œä¼šæŠ›å‡ºé”™è¯¯
3. âœ… **æ”¯æŒå¤šç§Ÿæˆ·æ¶æ„**ï¼šæ¯ä¸ªé€šçŸ¥éƒ½æœ‰ `boss_id`ï¼Œç¡®ä¿æ•°æ®éš”ç¦»
4. âœ… **åŠŸèƒ½å®Œå–„**ï¼šæ”¯æŒæ‰¹é‡åˆ›å»ºã€é»˜è®¤å€¼å¤„ç†ã€å…¼å®¹æ—§å­—æ®µå

### å»ºè®®

1. âœ… **æ— éœ€ä¿®æ”¹**ï¼šå‡½æ•°å®ç°å®Œå…¨æ­£ç¡®ï¼Œæ— éœ€ä»»ä½•ä¿®æ”¹
2. âœ… **å¯ä»¥æ”¾å¿ƒä½¿ç”¨**ï¼šå‡½æ•°å·²ç»å®Œå…¨æ”¯æŒå¤šç§Ÿæˆ·æ¶æ„
3. âœ… **æ¨èä½¿ç”¨**ï¼šå¯¹äºæ‰¹é‡åˆ›å»ºé€šçŸ¥çš„åœºæ™¯ï¼Œæ¨èä½¿ç”¨è¿™ä¸ªæ•°æ®åº“å‡½æ•°

---

**æŠ¥å‘Šæ—¥æœŸ**ï¼š2025-11-26  
**æŠ¥å‘Šäººå‘˜**ï¼šç§’å“’ AI  
**æŠ¥å‘ŠçŠ¶æ€**ï¼šâœ… å·²å®Œæˆ  
**æ£€æŸ¥ç»“è®º**ï¼šâœ… é€šè¿‡
