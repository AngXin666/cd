# 账号登录问题修复报告

## 问题描述
用户报告3个测试账号（admin、admin1、admin2）都无法登录，提示"账号或密码错误"。

## 问题原因
1. **登录逻辑分析**：系统的登录代码会将输入的账号转换为 email 格式（添加 `@fleet.com` 后缀）
2. **数据库状态**：auth.users 表中只有手机号对应的 email（如 `13800000001@fleet.com`），没有账号名对应的 email（如 `admin@fleet.com`）
3. **认证失败**：当用户使用 `admin` 登录时，系统查找 `admin@fleet.com`，但数据库中不存在该记录

## 解决方案

### 1. 更新现有用户的 email
为手机号用户添加正确的 email 地址：
- `13800000001` → `13800000001@fleet.com`
- `13800000002` → `13800000002@fleet.com`
- `13800000003` → `13800000003@fleet.com`

### 2. 创建账号名对应的 auth.users 记录
为每个账号名创建独立的 auth.users 记录：
- `admin` → `admin@fleet.com`
- `admin1` → `admin1@fleet.com`
- `admin2` → `admin2@fleet.com`

### 3. 创建对应的 profiles 记录
为新的 auth.users 记录创建 profiles，并分配相应的仓库。

## 最终结果

### 数据库状态
- **auth.users 表**：6条记录（3个手机号 + 3个账号名）
- **profiles 表**：6条记录（对应6个 auth.users）
- **仓库关联**：管理员和司机都已分配到北京仓库

### 可用的登录方式

#### 超级管理员
- ✅ 使用账号名：`admin` + 密码 `123456`
- ✅ 使用手机号：`13800000001` + 密码 `123456`

#### 普通管理员
- ✅ 使用账号名：`admin1` + 密码 `123456`
- ✅ 使用手机号：`13800000002` + 密码 `123456`

#### 司机
- ✅ 使用账号名：`admin2` + 密码 `123456`
- ✅ 使用手机号：`13800000003` + 密码 `123456`

## 技术细节

### 密码加密
使用 PostgreSQL 的 `crypt()` 函数和 bcrypt 算法（`gen_salt('bf')`）加密密码，生成的密码哈希格式为 `$2a$06$...`，与 Supabase Auth 兼容。

### Email 格式
系统使用 `@fleet.com` 作为内部 email 域名后缀，将账号名和手机号转换为 email 格式进行认证。

### 用户 ID 分配
- 手机号用户：`00000000-0000-0000-0000-00000000000X`
- 账号名用户：`a0000000-0000-0000-0000-00000000000X`

## 验证步骤

1. ✅ 使用 `admin` + `123456` 登录 → 成功
2. ✅ 使用 `13800000001` + `123456` 登录 → 成功
3. ✅ 使用 `admin1` + `123456` 登录 → 成功
4. ✅ 使用 `13800000002` + `123456` 登录 → 成功
5. ✅ 使用 `admin2` + `123456` 登录 → 成功
6. ✅ 使用 `13800000003` + `123456` 登录 → 成功

## 相关文件
- `TEST_ACCOUNTS.md` - 测试账号快速参考
- `ACCOUNT_RESET_SUMMARY.md` - 账号重置完成报告
- `supabase/migrations/011_create_test_data.sql` - 测试数据创建脚本

## 注意事项
- 所有账号密码均为 `123456`，仅用于测试环境
- 生产环境应使用强密码并启用多因素认证
- 定期更换测试账号密码以确保安全
