# å¹³çº§ç®¡ç†å‘˜åŠŸèƒ½è¯´æ˜

## ğŸ“‹ æ¦‚è¿°

å¹³çº§ç®¡ç†å‘˜ï¼ˆpeer_adminï¼‰æ˜¯ä¸€ä¸ªæ–°å¢çš„ç”¨æˆ·è§’è‰²ï¼Œæ‹¥æœ‰ä¸è€æ¿ï¼ˆsuper_adminï¼‰ç›¸åŒçš„æ•°æ®è®¿é—®æƒé™ï¼Œä½†å—è€æ¿è´¦å·ç®¡ç†ã€‚

## ğŸ¯ è®¾è®¡ç›®æ ‡

1. **æƒé™å¯¹ç­‰**ï¼šå¹³çº§ç®¡ç†å‘˜æ‹¥æœ‰ä¸è€æ¿ç›¸åŒçš„æ•°æ®è®¿é—®å’Œç®¡ç†æƒé™
2. **å—æ§ç®¡ç†**ï¼šå¹³çº§ç®¡ç†å‘˜ç”±è€æ¿åˆ›å»ºå’Œç®¡ç†
3. **æ•°æ®éš”ç¦»**ï¼šå¹³çº§ç®¡ç†å‘˜åªèƒ½è®¿é—®æ‰€å±ç§Ÿæˆ·çš„æ•°æ®
4. **æƒé™é™åˆ¶**ï¼šå¹³çº§ç®¡ç†å‘˜ä¸èƒ½ç®¡ç†å…¶ä»–å¹³çº§ç®¡ç†å‘˜æˆ–è€æ¿è´¦å·

## ğŸ”‘ è§’è‰²å®šä¹‰

### è§’è‰²ç±»å‹

ç³»ç»Ÿç°åœ¨æ”¯æŒä»¥ä¸‹è§’è‰²ï¼š

| è§’è‰² | ä»£ç  | è¯´æ˜ |
|------|------|------|
| è€æ¿ | `super_admin` | ç§Ÿæˆ·çš„æœ€é«˜ç®¡ç†å‘˜ï¼Œæ‹¥æœ‰æ‰€æœ‰æƒé™ |
| å¹³çº§ç®¡ç†å‘˜ | `peer_admin` | ä¸è€æ¿æ‹¥æœ‰ç›¸åŒçš„æ•°æ®è®¿é—®æƒé™ï¼Œä½†å—è€æ¿ç®¡ç† |
| è½¦é˜Ÿé•¿ | `manager` | è½¦é˜Ÿç®¡ç†å‘˜ï¼Œæ‹¥æœ‰éƒ¨åˆ†ç®¡ç†æƒé™ |
| å¸æœº | `driver` | æ™®é€šå¸æœºï¼Œåªèƒ½æŸ¥çœ‹å’Œç®¡ç†è‡ªå·±çš„æ•°æ® |
| ç§Ÿèµç®¡ç†å‘˜ | `lease_admin` | ç³»ç»Ÿçº§ç®¡ç†å‘˜ï¼Œå¯ä»¥ç®¡ç†æ‰€æœ‰ç§Ÿæˆ· |

### æƒé™å¯¹æ¯”

| åŠŸèƒ½ | è€æ¿ | å¹³çº§ç®¡ç†å‘˜ | è½¦é˜Ÿé•¿ | å¸æœº |
|------|------|-----------|--------|------|
| æŸ¥çœ‹ç§Ÿæˆ·æ‰€æœ‰æ•°æ® | âœ… | âœ… | âœ… | âŒ |
| åˆ›å»º/ç¼–è¾‘/åˆ é™¤ç”¨æˆ· | âœ… | âœ…ï¼ˆä»…å¸æœºå’Œè½¦é˜Ÿé•¿ï¼‰ | âŒ | âŒ |
| åˆ›å»ºå¹³çº§ç®¡ç†å‘˜ | âœ… | âŒ | âŒ | âŒ |
| ç®¡ç†ä»“åº“ | âœ… | âœ… | âœ… | âŒ |
| ç®¡ç†è€ƒå‹¤è§„åˆ™ | âœ… | âœ… | âœ… | âŒ |
| ç®¡ç†è®¡ä»¶ä»·æ ¼ | âœ… | âœ… | âœ… | âŒ |
| å®¡æ‰¹è¯·å‡/ç¦»èŒ | âœ… | âœ… | âœ… | âŒ |
| ç®¡ç†è½¦è¾† | âœ… | âœ… | âœ… | âŒ |
| æŸ¥çœ‹ç»Ÿè®¡æŠ¥è¡¨ | âœ… | âœ… | âœ… | âŒ |

## ğŸ”§ æŠ€æœ¯å®ç°

### 1. æ•°æ®åº“å±‚é¢

#### æšä¸¾ç±»å‹æ›´æ–°

```sql
-- æ·»åŠ  peer_admin è§’è‰²åˆ° user_role æšä¸¾ç±»å‹
ALTER TYPE user_role ADD VALUE IF NOT EXISTS 'peer_admin';
```

#### è¾…åŠ©å‡½æ•°

```sql
-- æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ä¸º super_admin æˆ– peer_admin
CREATE OR REPLACE FUNCTION is_super_admin_or_peer(uid uuid)
RETURNS boolean LANGUAGE sql SECURITY DEFINER AS $$
    SELECT EXISTS (
        SELECT 1 FROM profiles p
        WHERE p.id = uid AND p.role IN ('super_admin', 'peer_admin')
    );
$$;

-- æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å¯ä»¥ç®¡ç†æŒ‡å®šè§’è‰²çš„ç”¨æˆ·
CREATE OR REPLACE FUNCTION can_manage_user(manager_id uuid, target_role user_role)
RETURNS boolean LANGUAGE sql SECURITY DEFINER AS $$
    SELECT EXISTS (
        SELECT 1 FROM profiles p
        WHERE p.id = manager_id 
        AND (
            -- super_admin å¯ä»¥ç®¡ç†æ‰€æœ‰è§’è‰²ï¼ˆåŒ…æ‹¬ peer_adminï¼‰
            (p.role = 'super_admin') OR
            -- peer_admin å¯ä»¥ç®¡ç† driver å’Œ managerï¼Œä½†ä¸èƒ½ç®¡ç† super_admin å’Œå…¶ä»– peer_admin
            (p.role = 'peer_admin' AND target_role IN ('driver', 'manager'))
        )
    );
$$;
```

#### RLS ç­–ç•¥æ›´æ–°

æ‰€æœ‰è¡¨çš„ RLS ç­–ç•¥éƒ½å·²æ›´æ–°ï¼Œå°† `peer_admin` çš„æƒé™è®¾ç½®ä¸ºä¸ `super_admin` ç›¸åŒï¼š

```sql
-- ç¤ºä¾‹ï¼šprofiles è¡¨çš„ç­–ç•¥
DROP POLICY IF EXISTS "Super admin can manage tenant profiles" ON profiles;
CREATE POLICY "Super admin and peer admin can manage tenant profiles" ON profiles
  FOR ALL TO authenticated
  USING ((boss_id = get_current_user_boss_id()) AND is_super_admin_or_peer(auth.uid()))
  WITH CHECK ((boss_id = get_current_user_boss_id()) AND is_super_admin_or_peer(auth.uid()));
```

### 2. åº”ç”¨å±‚é¢

#### TypeScript ç±»å‹å®šä¹‰

```typescript
// src/db/types.ts
export type UserRole = 'driver' | 'manager' | 'super_admin' | 'peer_admin' | 'lease_admin'
```

#### è¾…åŠ©å‡½æ•°

```typescript
// src/utils/roleHelper.ts

/**
 * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ä¸ºè¶…çº§ç®¡ç†å‘˜ï¼ˆè€æ¿æˆ–å¹³çº§ç®¡ç†å‘˜ï¼‰
 */
export function isSuperAdmin(role: UserRole | undefined | null): boolean {
  return role === 'super_admin' || role === 'peer_admin'
}

/**
 * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å¯ä»¥ç®¡ç†å…¶ä»–ç”¨æˆ·
 */
export function canManageUser(managerRole: UserRole | undefined | null, targetRole: UserRole): boolean {
  if (!managerRole) return false

  // super_admin å¯ä»¥ç®¡ç†æ‰€æœ‰è§’è‰²
  if (managerRole === 'super_admin') return true

  // peer_admin å¯ä»¥ç®¡ç† driver å’Œ managerï¼Œä½†ä¸èƒ½ç®¡ç† super_admin å’Œå…¶ä»– peer_admin
  if (managerRole === 'peer_admin') {
    return targetRole === 'driver' || targetRole === 'manager'
  }

  return false
}

/**
 * è·å–å¯åˆ›å»ºçš„è§’è‰²åˆ—è¡¨
 */
export function getCreatableRoles(currentRole: UserRole | undefined | null): UserRole[] {
  if (!currentRole) return []

  // super_admin å¯ä»¥åˆ›å»ºæ‰€æœ‰è§’è‰²ï¼ˆé™¤äº† lease_adminï¼‰
  if (currentRole === 'super_admin') {
    return ['peer_admin', 'manager', 'driver']
  }

  // peer_admin åªèƒ½åˆ›å»º driver å’Œ manager
  if (currentRole === 'peer_admin') {
    return ['manager', 'driver']
  }

  return []
}
```

#### API å‡½æ•°æ›´æ–°

æ‰€æœ‰éœ€è¦æ£€æŸ¥ `super_admin` æƒé™çš„åœ°æ–¹éƒ½å·²æ›´æ–°ä¸ºåŒæ—¶æ£€æŸ¥ `peer_admin`ï¼š

```typescript
// ç¤ºä¾‹ï¼šè·å–ç®¡ç†å‘˜æƒé™
if (profile.role === 'super_admin' || profile.role === 'peer_admin') {
  return {
    can_edit_user_info: true,
    can_edit_piece_work: true,
    can_manage_attendance_rules: true,
    can_manage_categories: true,
    // ...
  }
}
```

## ğŸ“ ä½¿ç”¨åœºæ™¯

### åœºæ™¯ 1ï¼šè€æ¿åˆ›å»ºå¹³çº§ç®¡ç†å‘˜

1. è€æ¿ç™»å½•ç³»ç»Ÿ
2. è¿›å…¥ç”¨æˆ·ç®¡ç†é¡µé¢
3. ç‚¹å‡»"æ·»åŠ ç”¨æˆ·"æŒ‰é’®
4. é€‰æ‹©è§’è‰²ä¸º"å¹³çº§ç®¡ç†å‘˜"
5. å¡«å†™ç”¨æˆ·ä¿¡æ¯
6. ä¿å­˜åï¼Œå¹³çº§ç®¡ç†å‘˜è´¦å·åˆ›å»ºæˆåŠŸ

### åœºæ™¯ 2ï¼šå¹³çº§ç®¡ç†å‘˜ç®¡ç†ç”¨æˆ·

1. å¹³çº§ç®¡ç†å‘˜ç™»å½•ç³»ç»Ÿ
2. è¿›å…¥ç”¨æˆ·ç®¡ç†é¡µé¢
3. å¯ä»¥æŸ¥çœ‹ã€åˆ›å»ºã€ç¼–è¾‘ã€åˆ é™¤å¸æœºå’Œè½¦é˜Ÿé•¿
4. æ— æ³•ç®¡ç†è€æ¿è´¦å·å’Œå…¶ä»–å¹³çº§ç®¡ç†å‘˜

### åœºæ™¯ 3ï¼šå¹³çº§ç®¡ç†å‘˜è®¿é—®æ•°æ®

1. å¹³çº§ç®¡ç†å‘˜ç™»å½•ç³»ç»Ÿ
2. å¯ä»¥è®¿é—®æ‰€æœ‰ç§Ÿæˆ·æ•°æ®ï¼ˆä»“åº“ã€è€ƒå‹¤ã€è®¡ä»¶ã€è¯·å‡ã€ç¦»èŒã€è½¦è¾†ã€é€šçŸ¥ç­‰ï¼‰
3. æ‹¥æœ‰ä¸è€æ¿ç›¸åŒçš„æ•°æ®è®¿é—®æƒé™
4. æ— æ³•è®¿é—®å…¶ä»–ç§Ÿæˆ·çš„æ•°æ®

## ğŸ”’ å®‰å…¨ä¿è¯

### 1. æ•°æ®åº“å±‚é¢ä¿æŠ¤

- **RLS ç­–ç•¥**ï¼šæ‰€æœ‰è¡¨éƒ½å¯ç”¨äº† RLSï¼Œç¡®ä¿å¹³çº§ç®¡ç†å‘˜åªèƒ½è®¿é—®æ‰€å±ç§Ÿæˆ·çš„æ•°æ®
- **è¾…åŠ©å‡½æ•°**ï¼šä½¿ç”¨ `is_super_admin_or_peer` å‡½æ•°ç»Ÿä¸€æ£€æŸ¥æƒé™
- **æƒé™æ£€æŸ¥**ï¼šä½¿ç”¨ `can_manage_user` å‡½æ•°æ£€æŸ¥ç”¨æˆ·ç®¡ç†æƒé™

### 2. åº”ç”¨å±‚é¢ä¿æŠ¤

- **è§’è‰²æ£€æŸ¥**ï¼šæ‰€æœ‰éœ€è¦æƒé™çš„æ“ä½œéƒ½ä¼šæ£€æŸ¥ç”¨æˆ·è§’è‰²
- **æƒé™é™åˆ¶**ï¼šå¹³çº§ç®¡ç†å‘˜ä¸èƒ½ç®¡ç†è€æ¿å’Œå…¶ä»–å¹³çº§ç®¡ç†å‘˜
- **æ•°æ®éš”ç¦»**ï¼šå¹³çº§ç®¡ç†å‘˜åªèƒ½è®¿é—®æ‰€å±ç§Ÿæˆ·çš„æ•°æ®

### 3. åŒé‡ä¿æŠ¤æœºåˆ¶

- **æ•°æ®åº“å±‚é¢**ï¼šRLS ç­–ç•¥ç¡®ä¿æ•°æ®éš”ç¦»
- **åº”ç”¨å±‚é¢**ï¼šä»£ç é€»è¾‘ç¡®ä¿æƒé™æ§åˆ¶
- **å³ä½¿åº”ç”¨å±‚æœ‰æ¼æ´ï¼Œæ•°æ®åº“ä¹Ÿä¼šé˜»æ­¢è·¨ç§Ÿæˆ·è®¿é—®**

## ğŸ“Š æ•°æ®ç»“æ„

### profiles è¡¨å­—æ®µ

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | uuid | ç”¨æˆ·ID |
| role | user_role | ç”¨æˆ·è§’è‰²ï¼ˆåŒ…æ‹¬ peer_adminï¼‰ |
| boss_id | uuid | ç§Ÿæˆ·IDï¼ŒæŒ‡å‘ super_admin çš„ id |
| main_account_id | uuid | ä¸»è´¦å·IDï¼ŒNULL è¡¨ç¤ºè¿™æ˜¯ä¸»è´¦å· |
| ... | ... | å…¶ä»–å­—æ®µ |

### å¹³çº§ç®¡ç†å‘˜çš„æ•°æ®ç‰¹å¾

- `role = 'peer_admin'`
- `boss_id` æŒ‡å‘è€æ¿è´¦å·çš„ ID
- `main_account_id` å¯ä»¥ä¸º NULLï¼ˆç‹¬ç«‹è´¦å·ï¼‰æˆ–æŒ‡å‘è€æ¿è´¦å·ï¼ˆå¹³çº§è´¦å·ï¼‰

## ğŸ¯ æœ€ä½³å®è·µ

### 1. åˆ›å»ºå¹³çº§ç®¡ç†å‘˜

- åªæœ‰è€æ¿å¯ä»¥åˆ›å»ºå¹³çº§ç®¡ç†å‘˜
- å¹³çº§ç®¡ç†å‘˜çš„ `boss_id` åº”è¯¥æŒ‡å‘è€æ¿è´¦å·çš„ ID
- å»ºè®®ä¸ºå¹³çº§ç®¡ç†å‘˜è®¾ç½®æ¸…æ™°çš„åç§°ï¼Œä¾¿äºè¯†åˆ«

### 2. æƒé™ç®¡ç†

- å¹³çº§ç®¡ç†å‘˜æ‹¥æœ‰ä¸è€æ¿ç›¸åŒçš„æ•°æ®è®¿é—®æƒé™
- å¹³çº§ç®¡ç†å‘˜ä¸èƒ½ç®¡ç†è€æ¿å’Œå…¶ä»–å¹³çº§ç®¡ç†å‘˜
- å¹³çº§ç®¡ç†å‘˜å¯ä»¥ç®¡ç†å¸æœºå’Œè½¦é˜Ÿé•¿

### 3. æ•°æ®å®‰å…¨

- ç¡®ä¿å¹³çº§ç®¡ç†å‘˜çš„ `boss_id` æ­£ç¡®è®¾ç½®
- å®šæœŸæ£€æŸ¥å¹³çº§ç®¡ç†å‘˜çš„æƒé™
- åŠæ—¶åˆ é™¤ä¸å†éœ€è¦çš„å¹³çº§ç®¡ç†å‘˜è´¦å·

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å¤šç§Ÿæˆ·æ¶æ„è®¾è®¡æ–‡æ¡£](./MULTI_TENANT_ARCHITECTURE.md)
- [å¤šç§Ÿæˆ·é€‚é…å…¨é¢æ£€æŸ¥å’Œä¿®å¤æ€»ç»“](./å¤šç§Ÿæˆ·é€‚é…å…¨é¢æ£€æŸ¥å’Œä¿®å¤æ€»ç»“.md)
- [æ•°æ®åº“è¿ç§»æ–‡ä»¶](./supabase/migrations/)

## ğŸ”„ æ›´æ–°è®°å½•

| æ—¥æœŸ | ç‰ˆæœ¬ | è¯´æ˜ |
|------|------|------|
| 2025-11-26 | 1.0.0 | åˆå§‹ç‰ˆæœ¬ï¼Œæ·»åŠ å¹³çº§ç®¡ç†å‘˜åŠŸèƒ½ |

---

**æ–‡æ¡£æ—¥æœŸ**ï¼š2025-11-26  
**æ–‡æ¡£ä½œè€…**ï¼šç§’å“’ AI  
**æ–‡æ¡£çŠ¶æ€**ï¼šâœ… å·²å®Œæˆ
