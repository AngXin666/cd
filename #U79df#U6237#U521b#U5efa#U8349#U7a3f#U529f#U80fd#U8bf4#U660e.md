# 租户创建草稿功能说明

## 功能概述

租户创建页面支持自动保存草稿功能，避免因创建失败或意外退出导致的重复输入问题。

## 主要功能

### 1. 自动保存草稿

- **实时保存**：用户填写表单时，系统会自动保存草稿到本地存储
- **延迟写入**：使用 500ms 延迟，避免频繁写入影响性能
- **全字段保存**：保存所有表单字段，包括确认密码

### 2. 失败自动保存

- **创建失败**：当租户创建失败时，自动保存当前填写的内容
- **网络异常**：网络错误或服务异常时，也会自动保存草稿
- **友好提示**：失败提示中明确告知用户已保存草稿

### 3. 自动恢复草稿

- **页面加载**：打开创建租户页面时，自动检测并恢复草稿
- **恢复提示**：显示 Toast 提示"已恢复上次填写的内容"
- **视觉标识**：页面头部显示"已恢复草稿"标签

### 4. 草稿管理

#### 4.1 手动清除
- 草稿提示卡片中提供"清除草稿"按钮
- 点击后弹出确认对话框
- 确认后清除草稿并重置表单

#### 4.2 取消时询问
- 点击"取消"按钮时，如果有内容则询问是否保留
- 选择"保留"：保存草稿并返回
- 选择"清除"：清除草稿并返回

#### 4.3 成功自动清除
- 租户创建成功后，自动清除草稿
- 避免下次打开时恢复已成功的数据

## 用户界面

### 1. 草稿恢复标识

页面头部显示：
```
┌─────────────────────────────────┐
│ 创建新租户          [已恢复草稿] │
│ 填写租户信息，系统将自动完成部署 │
└─────────────────────────────────┘
```

### 2. 草稿提示卡片

```
┌─────────────────────────────────────┐
│ ℹ️ 已自动恢复上次填写的内容          │
│                                     │
│ [清除草稿]                          │
└─────────────────────────────────────┘
```

### 3. 失败提示

创建失败时显示：
```
┌─────────────────────────────────────┐
│           创建失败                   │
│                                     │
│ 克隆模板租户架构失败: xxx           │
│                                     │
│ 您填写的内容已自动保存为草稿，      │
│ 下次打开页面时会自动恢复。          │
│                                     │
│              [确定]                 │
└─────────────────────────────────────┘
```

### 4. 取消确认

点击取消时显示：
```
┌─────────────────────────────────────┐
│             提示                     │
│                                     │
│ 是否保留当前填写的内容？            │
│                                     │
│ 选择"保留"将在下次打开时自动恢复。  │
│                                     │
│      [清除]        [保留]           │
└─────────────────────────────────────┘
```

## 技术实现

### 1. 存储机制

- **存储位置**：使用 Taro 的本地存储 API
- **存储键**：`tenant_create_draft`
- **存储内容**：
  ```json
  {
    "formData": {
      "company_name": "...",
      "boss_name": "...",
      "boss_phone": "...",
      "boss_account": "...",
      "boss_password": "..."
    },
    "confirmPassword": "...",
    "savedAt": "2025-11-28T14:47:00.000Z"
  }
  ```

### 2. 核心函数

#### 2.1 保存草稿
```typescript
const saveDraft = () => {
  try {
    const draft = {
      formData,
      confirmPassword,
      savedAt: new Date().toISOString()
    }
    Taro.setStorageSync(DRAFT_KEY, JSON.stringify(draft))
  } catch (error) {
    console.error('保存草稿失败:', error)
  }
}
```

#### 2.2 加载草稿
```typescript
useEffect(() => {
  const loadDraft = () => {
    try {
      const draftStr = Taro.getStorageSync(DRAFT_KEY)
      if (draftStr) {
        const draft = JSON.parse(draftStr)
        setFormData(draft.formData)
        setConfirmPassword(draft.confirmPassword || '')
        setHasDraft(true)
        
        Taro.showToast({
          title: '已恢复上次填写的内容',
          icon: 'none',
          duration: 2000
        })
      }
    } catch (error) {
      console.error('加载草稿失败:', error)
    }
  }
  
  loadDraft()
}, [])
```

#### 2.3 清除草稿
```typescript
const clearDraft = () => {
  try {
    Taro.removeStorageSync(DRAFT_KEY)
    setHasDraft(false)
  } catch (error) {
    console.error('清除草稿失败:', error)
  }
}
```

### 3. 自动保存策略

- **输入时保存**：每次输入后延迟 500ms 保存
- **失败时保存**：创建失败或异常时立即保存
- **成功时清除**：创建成功后立即清除

## 使用场景

### 场景1：创建失败
1. 用户填写完整的租户信息
2. 点击"创建租户"按钮
3. 系统尝试创建，但失败（如 Schema 克隆失败）
4. 系统自动保存草稿
5. 显示失败提示，告知已保存草稿
6. 用户下次打开页面时，自动恢复填写的内容

### 场景2：网络异常
1. 用户填写租户信息
2. 点击"创建租户"按钮
3. 网络请求失败或超时
4. 系统自动保存草稿
5. 显示网络错误提示，告知已保存草稿
6. 用户下次打开页面时，自动恢复

### 场景3：意外退出
1. 用户正在填写租户信息
2. 意外点击返回或关闭页面
3. 系统询问是否保留草稿
4. 用户选择"保留"
5. 下次打开页面时，自动恢复

### 场景4：创建成功
1. 用户填写租户信息
2. 点击"创建租户"按钮
3. 创建成功
4. 系统自动清除草稿
5. 下次打开页面时，显示空白表单

## 注意事项

1. **密码安全**：草稿包含密码信息，存储在本地，请注意安全
2. **存储限制**：本地存储有大小限制，草稿数据较小，不会有问题
3. **跨设备**：草稿存储在本地，不支持跨设备同步
4. **过期处理**：当前版本不会自动清理过期草稿，可根据需要添加

## 未来优化

1. **草稿过期**：添加草稿过期时间，自动清理过期草稿
2. **多草稿**：支持保存多个草稿，用户可选择恢复
3. **云端同步**：将草稿同步到云端，支持跨设备访问
4. **敏感信息加密**：对密码等敏感信息进行加密存储
