# 车辆管理功能实现方案

## 一、功能概述

为司机客户端开发全面的车辆管理功能模块，支持车辆信息的自主添加与管理，包括：
- 车辆基本信息录入
- 行驶证OCR识别
- 车辆照片拍摄上传
- 驾驶员证件OCR识别（身份证、驾驶证）

## 二、技术架构

### 2.1 数据库设计

#### vehicles 表（车辆信息）
```sql
CREATE TABLE vehicles (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  driver_id UUID NOT NULL REFERENCES profiles(id),
  
  -- 基本信息
  plate_number TEXT NOT NULL UNIQUE,
  brand TEXT NOT NULL,
  model TEXT NOT NULL,
  color TEXT,
  vin TEXT,
  
  -- 行驶证信息
  vehicle_type TEXT,
  owner_name TEXT,
  use_character TEXT,
  register_date DATE,
  issue_date DATE,
  
  -- 车辆照片
  front_photo TEXT,
  back_photo TEXT,
  left_photo TEXT,
  right_photo TEXT,
  tire_photo TEXT,
  driving_license_photo TEXT,
  
  -- 状态
  status TEXT DEFAULT 'active',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

#### driver_licenses 表（驾驶员证件信息）
```sql
CREATE TABLE driver_licenses (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  driver_id UUID NOT NULL REFERENCES profiles(id),
  
  -- 身份证信息
  id_card_number TEXT,
  id_card_name TEXT,
  id_card_address TEXT,
  id_card_birth_date DATE,
  id_card_photo_front TEXT,
  id_card_photo_back TEXT,
  
  -- 驾驶证信息
  license_number TEXT,
  license_class TEXT,
  valid_from DATE,
  valid_to DATE,
  issue_authority TEXT,
  driving_license_photo TEXT,
  
  -- 状态
  status TEXT DEFAULT 'active',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### 2.2 API集成方案

#### OCR识别API
使用**文心一言多模态输入大模型接口**实现OCR识别功能：

1. **行驶证识别**
   - 拍摄/选择行驶证照片
   - 转换为Base64格式
   - 调用多模态API，提示词："请识别这张行驶证，提取以下信息：车牌号、车辆类型、所有人、使用性质、品牌型号、车辆识别代号、注册日期、发证日期。以JSON格式返回。"

2. **身份证识别**
   - 拍摄/选择身份证正反面
   - 转换为Base64格式
   - 调用多模态API，提示词："请识别这张身份证，提取姓名、身份证号、地址、出生日期。以JSON格式返回。"

3. **驾驶证识别**
   - 拍摄/选择驾驶证照片
   - 转换为Base64格式
   - 调用多模态API，提示词："请识别这张驾驶证，提取证号、准驾车型、有效期起始日期、有效期截止日期、发证机关。以JSON格式返回。"

### 2.3 图片存储方案

使用 Supabase Storage 存储所有照片：
- Bucket名称：`app-7cdqf07mbu9t_vehicles`
- 文件命名规则：`{driver_id}/{vehicle_id}/{photo_type}_{timestamp}.jpg`
- 图片压缩：上传前压缩至1MB以下
- 支持格式：JPG、JPEG、PNG、BMP

## 三、页面设计

### 3.1 车辆管理列表页
**路径：** `/pages/driver/vehicle-list/index.tsx`

**功能：**
- 显示司机名下所有车辆
- 车辆卡片展示：车牌号、品牌型号、状态
- 添加车辆按钮
- 编辑/删除车辆操作

### 3.2 添加车辆流程页
**路径：** `/pages/driver/add-vehicle/index.tsx`

**流程步骤：**

#### 步骤1：基本信息录入
- 车牌号输入（必填，格式验证）
- 品牌输入（必填）
- 型号输入（必填）
- 颜色选择（可选）

#### 步骤2：行驶证识别
- 拍照/选择照片按钮
- OCR识别进度提示
- 识别结果展示与确认
- 手动修正功能

#### 步骤3：车辆照片拍摄
- 车辆前方照片（必填）
- 车辆后方照片（必填）
- 车辆左侧照片（必填）
- 车辆右侧照片（必填）
- 轮胎特写照片（必填）
- 每个照片位置提供拍照引导

#### 步骤4：驾驶员证件识别
- 身份证正面识别
- 身份证反面识别
- 驾驶证识别
- 识别结果确认

### 3.3 拍照组件
**组件路径：** `/components/PhotoCapture/index.tsx`

**功能：**
- 即时拍照（调用摄像头）
- 从相册选择
- 图片预览
- 重新拍摄/选择
- 拍照引导框和提示文案

### 3.4 OCR识别结果确认页
**组件路径：** `/components/OcrResult/index.tsx`

**功能：**
- 显示识别结果
- 字段编辑功能
- 确认/重新识别按钮

## 四、交互设计

### 4.1 拍照引导设计

#### 行驶证拍照引导
```
┌─────────────────────────┐
│   请将行驶证放置在框内   │
│                         │
│  ┌─────────────────┐   │
│  │                 │   │
│  │   行驶证取景框   │   │
│  │                 │   │
│  └─────────────────┘   │
│                         │
│  提示：                 │
│  • 确保证件完整清晰     │
│  • 避免反光和阴影       │
│  • 保持水平拍摄         │
│                         │
│  [拍照] [从相册选择]    │
└─────────────────────────┘
```

#### 车辆照片拍照引导
```
┌─────────────────────────┐
│   拍摄车辆前方照片       │
│                         │
│  ┌─────────────────┐   │
│  │                 │   │
│  │   车辆取景框     │   │
│  │                 │   │
│  └─────────────────┘   │
│                         │
│  提示：                 │
│  • 完整拍摄车辆前部     │
│  • 包含车牌号码         │
│  • 光线充足             │
│                         │
│  [拍照] [从相册选择]    │
└─────────────────────────┘
```

### 4.2 流程导航设计

```
步骤指示器：
[1 基本信息] → [2 行驶证] → [3 车辆照片] → [4 证件识别]
   ✓            当前          待完成         待完成

底部操作栏：
[上一步]  [保存草稿]  [下一步]
```

### 4.3 OCR识别流程

```
用户操作流程：
1. 点击"拍照"或"从相册选择"
   ↓
2. 选择照片后显示预览
   ↓
3. 确认照片 → 开始识别
   ↓
4. 显示识别进度（加载动画）
   ↓
5. 识别完成 → 显示结果
   ↓
6. 用户确认/修改 → 下一步
```

## 五、技术实现要点

### 5.1 图片处理

```typescript
// 图片压缩和转换
const processImage = async (imagePath: string) => {
  // 1. 压缩图片
  const compressed = await compressImage(imagePath, 0.8)
  
  // 2. 转换为Base64
  const base64 = await imageToBase64(compressed)
  
  // 3. 上传到Supabase Storage
  const publicUrl = await uploadToStorage(base64)
  
  return { base64, publicUrl }
}
```

### 5.2 OCR识别

```typescript
// 调用多模态API进行OCR识别
const recognizeDocument = async (
  imageBase64: string,
  documentType: 'driving_license' | 'id_card' | 'driver_license'
) => {
  const prompts = {
    driving_license: '请识别这张行驶证，提取车牌号、车辆类型、所有人、使用性质、品牌型号、车辆识别代号、注册日期、发证日期。以JSON格式返回。',
    id_card: '请识别这张身份证，提取姓名、身份证号、地址、出生日期。以JSON格式返回。',
    driver_license: '请识别这张驾驶证，提取证号、准驾车型、有效期起始日期、有效期截止日期、发证机关。以JSON格式返回。'
  }
  
  const result = await sendChatStream({
    endpoint: API_ENDPOINT,
    appId: APP_ID,
    messages: [{
      role: 'user',
      content: [
        { type: 'text', text: prompts[documentType] },
        { type: 'image_url', image_url: { url: imageBase64 } }
      ]
    }],
    onUpdate: handleData,
    onComplete: () => parseResult(),
    onError: handleError
  })
  
  return result
}
```

### 5.3 表单验证

```typescript
// 车牌号验证
const validatePlateNumber = (plate: string) => {
  const pattern = /^[京津沪渝冀豫云辽黑湘皖鲁新苏浙赣鄂桂甘晋蒙陕吉闽贵粤青藏川宁琼使领][A-Z][A-HJ-NP-Z0-9]{5}$/
  return pattern.test(plate)
}

// 身份证号验证
const validateIdCard = (idCard: string) => {
  const pattern = /^[1-9]\d{5}(18|19|20)\d{2}(0[1-9]|1[0-2])(0[1-9]|[12]\d|3[01])\d{3}[\dXx]$/
  return pattern.test(idCard)
}
```

### 5.4 数据提交

```typescript
// 提交车辆信息
const submitVehicle = async (vehicleData: VehicleFormData) => {
  try {
    // 1. 上传所有照片
    const photoUrls = await uploadAllPhotos(vehicleData.photos)
    
    // 2. 插入车辆记录
    const vehicle = await insertVehicle({
      ...vehicleData,
      ...photoUrls,
      driver_id: user.id
    })
    
    // 3. 插入驾驶员证件记录
    if (vehicleData.driverLicense) {
      await insertDriverLicense({
        ...vehicleData.driverLicense,
        driver_id: user.id
      })
    }
    
    showToast({ title: '车辆添加成功', icon: 'success' })
    navigateBack()
  } catch (error) {
    showToast({ title: '提交失败，请重试', icon: 'error' })
  }
}
```

## 六、用户体验优化

### 6.1 加载状态
- OCR识别时显示加载动画
- 图片上传时显示进度条
- 数据提交时禁用按钮

### 6.2 错误处理
- 网络错误提示
- OCR识别失败提示
- 图片格式/大小错误提示
- 表单验证错误提示

### 6.3 草稿保存
- 支持保存未完成的表单
- 下次进入时恢复草稿
- 草稿过期自动清理

### 6.4 操作引导
- 首次使用显示功能引导
- 每个步骤提供操作提示
- 拍照时显示取景框和要求

## 七、安全性考虑

### 7.1 数据权限
- 司机只能查看和管理自己的车辆
- RLS策略限制数据访问
- 管理员可以查看所有车辆

### 7.2 图片安全
- 图片上传前验证格式和大小
- 存储时使用唯一文件名
- 设置合理的访问权限

### 7.3 敏感信息
- 身份证号、驾驶证号加密存储
- 证件照片访问权限控制
- 日志记录敏感操作

## 八、实施计划

### 阶段1：数据库和存储（1天）
- 创建数据库表结构
- 配置Supabase Storage
- 设置RLS策略

### 阶段2：基础组件（2天）
- 开发拍照组件
- 开发OCR识别组件
- 开发表单验证

### 阶段3：页面开发（3天）
- 车辆列表页
- 添加车辆流程页
- OCR结果确认页

### 阶段4：集成测试（1天）
- 功能测试
- 兼容性测试
- 性能优化

### 阶段5：上线部署（1天）
- 代码审查
- 部署上线
- 用户培训

## 九、后续优化方向

1. **智能识别优化**
   - 提高OCR识别准确率
   - 支持更多证件类型
   - 自动纠错功能

2. **批量操作**
   - 批量添加车辆
   - 批量更新信息
   - 批量导出数据

3. **车辆档案**
   - 维修记录
   - 保险信息
   - 年检提醒

4. **数据分析**
   - 车辆使用统计
   - 维护成本分析
   - 车辆状态监控
