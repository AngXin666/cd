# 仓库分配通知测试指南

## 🎯 测试目标

验证以下功能是否正常工作：
1. ✅ 司机被分配仓库时收到通知
2. ✅ 超级管理员分配司机到仓库时，该仓库的管理员收到通知

## 📋 测试前准备

### 1. 准备测试账号

需要准备以下三个账号：

| 角色 | 账号名称 | 用途 |
|------|---------|------|
| 超级管理员 | 超管账号 | 执行仓库分配操作 |
| 司机 | 司机账号 | 接收仓库分配通知 |
| 普通管理员 | 管理员账号 | 接收仓库分配操作通知 |

### 2. 准备测试数据

确保系统中有：
- ✅ 至少1个仓库
- ✅ 该仓库已分配给普通管理员
- ✅ 司机尚未分配到该仓库（或已分配但可以修改）

### 3. 打开浏览器开发者工具

**重要**：必须打开浏览器控制台才能看到调试日志

- **Chrome/Edge**：按 `F12` 或 `Ctrl+Shift+I`
- **Firefox**：按 `F12` 或 `Ctrl+Shift+K`
- **Safari**：按 `Cmd+Option+I`

切换到 **Console** 标签页

## 🧪 测试步骤

### 步骤1：登录超级管理员账号

1. 打开小程序或H5页面
2. 登录超级管理员账号
3. 确认登录成功

### 步骤2：进入仓库分配页面

1. 点击底部导航栏的"超管"标签
2. 找到"仓库分配"功能入口
3. 点击进入仓库分配页面

### 步骤3：选择司机

1. 在司机列表中选择一个司机
2. 查看该司机当前分配的仓库

**控制台应该输出**：
```
（选择司机时可能没有日志，这是正常的）
```

### 步骤4：修改仓库分配

**场景A：分配新仓库**
1. 勾选一个之前没有分配的仓库
2. 点击"保存分配"按钮

**场景B：取消仓库分配**
1. 取消勾选一个已分配的仓库
2. 点击"保存分配"按钮

### 步骤5：查看控制台日志

点击"保存分配"后，控制台应该输出以下日志：

```
💾 [保存] 开始保存仓库分配
💾 [保存] 选中的司机 {司机: "xxx", 司机ID: "xxx", 选中的仓库: [...]}
💾 [保存] 之前的仓库 [...]
💾 [保存] 保存结果 {success: true}
✅ [保存] 保存成功，准备发送通知
💾 [保存] 当前用户信息 {currentUserProfile: "xxx", role: "super_admin"}
💾 [保存] 调用通知发送函数
🔔 [通知系统] 开始发送仓库分配通知 {司机: "xxx", ...}
📊 [通知系统] 仓库变更情况 {新增的仓库: [...], 取消的仓库: [...]}
📝 [通知系统] 准备通知司机（新增仓库） {司机ID: "xxx", 仓库: "xxx"}
👤 [通知系统] 操作者是超级管理员，准备通知相关仓库的管理员
📦 [通知系统] 受影响的仓库 {仓库ID列表: [...], 仓库数量: 1}
📦 [通知系统] 仓库 xxx 的管理员 {管理员数量: 1, 管理员: ["xxx"]}
👥 [通知系统] 需要通知的管理员总数 {管理员数量: 1}
📝 [通知系统] 准备通知管理员 {管理员数量: 1, 操作描述: "分配了新仓库"}
📤 [通知系统] 准备发送通知 {通知数量: 2, 通知列表: [...]}
✅ [通知系统] 已成功发送 2 条仓库分配通知
💾 [保存] 通知发送函数执行完毕
```

### 步骤6：验证司机收到通知

1. 退出超级管理员账号
2. 登录司机账号
3. 进入工作台页面
4. 查看顶部通知栏是否显示新通知
5. 点击通知栏或进入通知中心
6. 查看是否有"仓库分配通知"

**预期结果**：
- ✅ 通知栏显示"1条未读通知"
- ✅ 通知中心显示"仓库分配通知"
- ✅ 通知内容：`您已被分配到新的仓库：xxx`

### 步骤7：验证管理员收到通知

1. 退出司机账号
2. 登录普通管理员账号（该仓库的管理员）
3. 进入工作台页面
4. 查看顶部通知栏是否显示新通知
5. 点击通知栏或进入通知中心
6. 查看是否有"仓库分配操作通知"

**预期结果**：
- ✅ 通知栏显示"1条未读通知"
- ✅ 通知中心显示"仓库分配操作通知"
- ✅ 通知内容：`超级管理员 xxx 分配了新仓库：司机 xxx，仓库 xxx`

## 🔍 问题排查

### 问题1：控制台没有任何日志输出

**可能原因**：
- 浏览器控制台没有打开
- 日志被过滤了

**解决方法**：
1. 确认浏览器控制台已打开
2. 在控制台的过滤框中清空所有过滤条件
3. 确认没有勾选"Hide network messages"等选项

### 问题2：日志显示"仓库没有变更"

**日志内容**：
```
ℹ️ [通知系统] 仓库没有变更，不发送通知
```

**原因**：
- 选择的仓库和之前一样，没有任何变更

**解决方法**：
- 选择不同的仓库
- 或者先取消所有仓库，保存后再重新分配

### 问题3：日志显示"操作者信息为空"

**日志内容**：
```
⚠️ [通知系统] 操作者信息为空，无法通知管理员
```

**原因**：
- `currentUserProfile` 为 null
- 当前用户信息获取失败

**解决方法**：
1. 检查是否正确登录
2. 刷新页面重新进入
3. 查看 `💾 [保存] 当前用户信息` 日志，确认用户信息

### 问题4：日志显示"发送通知失败"

**日志内容**：
```
❌ [通知系统] 发送通知失败
```

**原因**：
- 数据库连接失败
- 通知表的 RLS 策略阻止了插入
- 通知类型枚举不包含 'warehouse_assigned'

**解决方法**：
1. 检查网络连接
2. 检查 Supabase 配置
3. 查看 Network 标签页，检查 API 请求是否成功
4. 查看数据库日志

### 问题5：日志显示"管理员数量: 0"

**日志内容**：
```
👥 [通知系统] 需要通知的管理员总数 {管理员数量: 0}
```

**原因**：
- 该仓库没有分配管理员
- 管理员查询失败

**解决方法**：
1. 进入"管理员仓库分配"页面
2. 为该仓库分配一个管理员
3. 重新测试

### 问题6：通知发送成功但司机/管理员没有收到

**日志内容**：
```
✅ [通知系统] 已成功发送 2 条仓库分配通知
```

**原因**：
- 通知已发送到数据库，但前端没有刷新
- 实时订阅没有工作

**解决方法**：
1. 刷新页面
2. 重新进入通知中心
3. 检查数据库中是否有通知记录

## 📊 数据库验证

如果前端没有显示通知，可以直接查询数据库验证通知是否已创建：

### 查询最近的仓库分配通知

```sql
SELECT 
  n.id,
  n.user_id,
  p.name as user_name,
  p.role as user_role,
  n.type,
  n.title,
  n.message,
  n.is_read,
  n.created_at
FROM notifications n
LEFT JOIN profiles p ON n.user_id = p.id
WHERE n.type IN ('warehouse_assigned', 'warehouse_unassigned')
ORDER BY n.created_at DESC
LIMIT 10;
```

**预期结果**：
- 应该看到新创建的通知记录
- 司机的通知：`type = 'warehouse_assigned'`, `title = '仓库分配通知'`
- 管理员的通知：`type = 'warehouse_assigned'`, `title = '仓库分配操作通知'`

### 查询特定用户的通知

```sql
-- 查询司机的通知
SELECT * FROM notifications 
WHERE user_id = '司机的user_id'
ORDER BY created_at DESC
LIMIT 5;

-- 查询管理员的通知
SELECT * FROM notifications 
WHERE user_id = '管理员的user_id'
ORDER BY created_at DESC
LIMIT 5;
```

### 查询仓库的管理员

```sql
SELECT 
  p.id,
  p.name,
  p.role,
  w.name as warehouse_name
FROM manager_warehouses mw
JOIN profiles p ON mw.manager_id = p.id
JOIN warehouses w ON mw.warehouse_id = w.id
WHERE w.id = '仓库ID';
```

## 📝 测试记录表

请按照以下表格记录测试结果：

| 测试项 | 预期结果 | 实际结果 | 状态 | 备注 |
|--------|---------|---------|------|------|
| 控制台日志输出 | 显示完整日志 | | ⬜ | |
| 司机收到通知 | 通知中心显示通知 | | ⬜ | |
| 管理员收到通知 | 通知中心显示通知 | | ⬜ | |
| 通知栏显示 | 显示未读数量 | | ⬜ | |
| 数据库记录 | 有通知记录 | | ⬜ | |

状态说明：
- ✅ 通过
- ❌ 失败
- ⬜ 未测试

## 🎯 关键日志说明

### 1. 保存阶段日志

```
💾 [保存] 开始保存仓库分配
💾 [保存] 选中的司机
💾 [保存] 之前的仓库
💾 [保存] 保存结果
✅ [保存] 保存成功，准备发送通知
💾 [保存] 当前用户信息
💾 [保存] 调用通知发送函数
```

**说明**：
- 这些日志确认保存操作是否成功
- 确认当前用户信息是否正确获取
- 确认通知发送函数是否被调用

### 2. 通知发送阶段日志

```
🔔 [通知系统] 开始发送仓库分配通知
📊 [通知系统] 仓库变更情况
📝 [通知系统] 准备通知司机
👤 [通知系统] 操作者是超级管理员
📦 [通知系统] 受影响的仓库
📦 [通知系统] 仓库 xxx 的管理员
👥 [通知系统] 需要通知的管理员总数
📝 [通知系统] 准备通知管理员
📤 [通知系统] 准备发送通知
✅ [通知系统] 已成功发送 X 条通知
```

**说明**：
- 这些日志确认通知发送的每个步骤
- 确认仓库变更情况
- 确认需要通知的用户
- 确认通知是否发送成功

### 3. 完成阶段日志

```
💾 [保存] 通知发送函数执行完毕
```

**说明**：
- 确认整个流程执行完毕

## 🚨 重要提示

### 1. 必须打开控制台

**没有控制台日志，无法排查问题！**

请务必：
1. 打开浏览器开发者工具（F12）
2. 切换到 Console 标签页
3. 执行操作
4. 截图保存日志

### 2. 日志是排查问题的关键

根据日志输出，可以准确判断：
- 函数是否被调用
- 数据是否正确
- 哪一步出了问题
- 具体的错误信息

### 3. 如果没有日志输出

说明代码可能没有执行到通知发送部分，需要检查：
- 是否点击了"保存分配"按钮
- 保存操作是否成功
- 是否有 JavaScript 错误

### 4. 如果有日志但没有通知

说明通知发送成功，但前端显示有问题，需要检查：
- 刷新页面
- 重新登录
- 检查实时订阅功能
- 查询数据库验证

## 📞 需要提供的信息

如果测试失败，请提供以下信息：

1. **完整的控制台日志**（截图或复制文本）
2. **测试步骤**（具体操作了什么）
3. **预期结果**（期望看到什么）
4. **实际结果**（实际看到了什么）
5. **数据库查询结果**（如果可以的话）

## ✅ 测试成功标准

测试通过的标准：

1. ✅ 控制台输出完整的日志
2. ✅ 日志显示"已成功发送 X 条通知"
3. ✅ 司机账号能看到"仓库分配通知"
4. ✅ 管理员账号能看到"仓库分配操作通知"
5. ✅ 通知栏正确显示未读数量
6. ✅ 数据库中有对应的通知记录

如果以上6项都满足，说明功能正常！🎉
