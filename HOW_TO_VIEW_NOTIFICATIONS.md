# 如何查看通知

## 通知功能说明

通知系统已经成功实现并正常工作。当发生以下操作时，系统会自动发送通知：

### 1. 司机类型变更通知
- **触发条件**：管理员或超级管理员切换司机类型（带车司机 ↔ 纯司机）
- **通知对象**：
  - 司机本人
  - 相关管理员（根据操作者角色）

### 2. 仓库分配通知
- **触发条件**：管理员或超级管理员为司机分配/取消仓库
- **通知对象**：
  - 司机本人
  - 相关管理员（根据操作者角色）

## 如何查看通知

### 方法1：通过工作台顶部通知栏（推荐）⭐

**这是最直观的方式！**

1. 打开小程序，进入工作台（首页）
2. 如果有未读通知，会在页面顶部自动显示通知栏
3. 通知栏会显示最新的未读通知内容
4. 如果有多条未读通知，通知栏会自动轮播切换
5. **点击通知栏任意位置**，即可跳转到通知中心查看所有通知

**通知栏特点**：
- ✅ 自动显示：有未读通知时自动出现
- ✅ 实时更新：新通知会立即显示
- ✅ 轮播切换：多条通知自动轮播，每5秒切换一次
- ✅ 一键跳转：点击即可进入通知中心
- ✅ 未读数量：显示未读通知总数

**所有角色都可以使用**：
- 司机端：工作台顶部通知栏
- 管理员端：工作台顶部通知栏
- 超级管理员端：工作台顶部通知栏

### 方法2：通过"我的"页面快捷入口

1. 打开小程序
2. 点击底部导航栏的"我的"
3. 在快捷功能区域，点击"通知中心"（铃铛图标）
4. 进入通知中心页面查看所有通知

**所有角色都可以使用此方法**：
- 司机端：我的 → 通知中心
- 管理员端：我的 → 通知中心
- 超级管理员端：我的 → 通知中心

### 方法3：通过页面路径（开发调试）

直接访问通知页面路径：`/pages/common/notifications/index`

## 通知栏效果展示

```
┌─────────────────────────────────────────┐
│ 司机工作台                              │
│ 欢迎回来，简单共                        │
├─────────────────────────────────────────┤
│ 🔔 您的请假申请已通过                   │
│    管理员已批准您的请假申请      刚刚   │
│    ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│    进度条 ▓▓▓▓▓▓▓▓▓▓░░░░░░░░░░  2/5    │
└─────────────────────────────────────────┘
```

**通知栏说明**：
- 左侧：通知类型图标（不同类型有不同颜色）
- 中间：通知标题和内容
- 右侧：时间和未读数量
- 底部：进度条（显示当前查看的是第几条通知）
- 点击任意位置：跳转到通知中心

## 通知中心功能

### 查看通知
- 未读通知会有蓝色边框和红点标记
- 已读通知显示为灰色
- 点击通知可查看详情并自动标记为已读

### 管理通知
- **全部已读**：一键将所有未读通知标记为已读
- **清空已读**：删除所有已读通知
- **删除单条**：点击通知右下角的"删除"按钮

### 通知图标说明
- 🏢 仓库图标（蓝色）：仓库分配通知
- 🏢 仓库图标（灰色）：仓库取消分配通知
- 👤 账户切换图标（紫色）：司机类型变更通知
- ✅ 勾选图标（绿色）：审批通过通知
- ❌ 叉号图标（红色）：审批拒绝通知
- 🔔 铃铛图标：其他通知

## 验证通知是否发送成功

### 数据库验证

通知已经成功保存到数据库中。您可以通过以下SQL查询验证：

```sql
-- 查看最近的通知
SELECT 
  n.type,
  n.title,
  n.message,
  p.name as user_name,
  p.role as user_role,
  n.created_at
FROM notifications n
LEFT JOIN profiles p ON n.user_id = p.id
ORDER BY n.created_at DESC
LIMIT 10;
```

### 前端验证

**方法1：查看工作台通知栏**
1. 登录对应的用户账号（司机或管理员）
2. 进入工作台（首页）
3. 查看页面顶部是否显示通知栏
4. 如果有未读通知，通知栏会自动显示

**方法2：查看通知中心**
1. 登录对应的用户账号（司机或管理员）
2. 点击底部"我的"，然后点击"通知中心"
3. 查看是否有新通知

## 测试步骤

### 测试司机类型变更通知

1. **使用超级管理员账号登录**
2. 进入"用户管理"页面
3. 找到一个司机，点击"切换类型"按钮
4. 确认切换
5. **切换到司机账号**
   - 进入工作台，查看顶部是否显示通知栏
   - 或点击"我的" → "通知中心"，应该能看到"司机类型变更通知"
6. **切换到该司机所属仓库的管理员账号**
   - 进入工作台，查看顶部是否显示通知栏
   - 或点击"我的" → "通知中心"，应该能看到"司机类型变更操作通知"

### 测试仓库分配通知

1. **使用超级管理员账号登录**
2. 进入"仓库分配"页面
3. 选择一个司机
4. 勾选一个或多个仓库
5. 点击"保存"
6. **切换到司机账号**
   - 进入工作台，查看顶部是否显示通知栏
   - 或点击"我的" → "通知中心"，应该能看到"仓库分配通知"
7. **切换到相关仓库的管理员账号**
   - 进入工作台，查看顶部是否显示通知栏
   - 或点击"我的" → "通知中心"，应该能看到"仓库分配操作通知"

## 常见问题

### Q1：为什么我看不到通知栏？

**可能原因**：
1. 您没有未读通知
2. 您不在工作台页面（通知栏只在工作台显示）
3. 页面没有刷新

**解决方法**：
1. 确认您有未读通知（可以通过"我的" → "通知中心"查看）
2. 确保您在工作台页面（首页）
3. 下拉刷新页面
4. 退出小程序，重新打开

### Q2：为什么我看不到通知？

**可能原因**：
1. 您登录的账号不是通知的接收者
2. 通知已被删除
3. 页面没有刷新，需要重新进入通知中心
4. 您没有找到通知入口

**解决方法**：
1. 确认您登录的账号是否是操作相关的用户
2. 查看工作台顶部是否有通知栏
3. 点击底部"我的"，然后点击"通知中心"（铃铛图标）
4. 退出通知中心页面，重新进入
5. 检查数据库中是否有对应的通知记录

### Q3：通知显示不正确？

**可能原因**：
1. 缓存问题
2. 数据同步延迟

**解决方法**：
1. 下拉刷新页面
2. 退出小程序，重新打开
3. 清除小程序缓存

### Q4：如何确认通知已经发送？

**验证方法**：
1. 查看浏览器控制台日志，搜索"通知创建成功"或"批量通知创建成功"
2. 查看数据库 notifications 表，确认有新记录
3. 使用对应的用户账号登录，查看工作台顶部是否有通知栏
4. 或点击"我的" → "通知中心"查看

### Q5：找不到通知入口？

**查找方法**：
1. **最简单的方式**：进入工作台（首页），查看页面顶部的通知栏
2. 或者点击底部导航栏的"我的"
3. 在快捷功能区域（页面上方），找到"通知中心"（铃铛图标）
4. 点击进入通知中心

### Q6：通知栏可以关闭吗？

**说明**：
- 通知栏不能手动关闭
- 当您将所有通知标记为已读后，通知栏会自动消失
- 这样设计是为了确保您不会错过重要通知

## 技术细节

### 通知发送流程

```
操作触发 → 保存数据 → 创建通知记录 → 通知保存到数据库 → 工作台显示通知栏 → 用户查看通知
```

### 通知类型

- `warehouse_assigned`：仓库分配
- `warehouse_unassigned`：仓库取消分配
- `driver_type_changed`：司机类型变更
- `vehicle_review_pending`：车辆审核待处理
- `vehicle_review_approved`：车辆审核通过
- `vehicle_review_need_supplement`：车辆审核需补充
- `leave_approved`：请假审批通过
- `leave_rejected`：请假审批拒绝
- `system_notice`：系统通知

### 实时更新

- 通知中心使用 Supabase 实时订阅功能，当有新通知时会自动刷新列表
- 工作台通知栏会自动加载最新的未读通知
- 通知栏每5秒自动轮播切换（如果有多条未读通知）

### 通知栏组件

- **组件名称**：RealNotificationBar
- **位置**：工作台页面顶部（欢迎信息下方）
- **功能**：
  - 自动加载未读通知
  - 自动轮播切换
  - 点击跳转到通知中心
  - 显示未读数量
  - 显示进度条
- **适用页面**：
  - 司机工作台
  - 管理员工作台
  - 超级管理员工作台

## 数据库记录示例

根据最新的数据库查询，已经成功创建了以下通知：

```
类型：driver_type_changed
标题：司机类型变更通知
消息：您的司机类型已从【纯司机】变更为【带车司机】
接收者：司机（driver）
时间：2025-11-23 10:03:18

类型：driver_type_changed
标题：司机类型变更操作通知
消息：超级管理员 管理员 修改了司机类型：邱吉兴，从【纯司机】变更为【带车司机】
接收者：管理员1（manager）
时间：2025-11-23 10:03:18
```

这证明通知系统已经正常工作！

## 更新说明

### 2025-11-23 更新 v2

1. **工作台通知栏**：在所有工作台页面顶部添加了通知栏组件
   - 司机工作台：显示通知栏
   - 管理员工作台：显示通知栏
   - 超级管理员工作台：显示通知栏

2. **通知栏功能**：
   - 自动显示未读通知
   - 自动轮播切换（多条通知时）
   - 点击跳转到通知中心
   - 显示未读数量和进度条
   - 实时更新

3. **用户体验优化**：
   - 用户无需主动查找通知入口
   - 有新通知时会自动在工作台显示
   - 点击通知栏即可查看详情
   - 更加直观和便捷

### 2025-11-23 更新 v1

1. **新增通知入口**：在"我的"页面的快捷功能区域添加了"通知中心"入口
2. **所有角色可用**：司机、管理员、超级管理员都可以通过"我的" → "通知中心"查看通知
3. **通知图标优化**：为所有通知类型添加了对应的图标和颜色
4. **通知栏组件**：创建了 RealNotificationBar 组件，连接到真实的数据库通知系统

## 联系支持

如果您仍然无法看到通知，请提供以下信息：

1. 您登录的账号角色（司机/管理员/超级管理员）
2. 您执行的操作（切换司机类型/分配仓库）
3. 浏览器控制台的错误日志（如果有）
4. 工作台页面的截图（查看是否有通知栏）
5. 通知中心页面的截图
6. 是否能在"我的"页面看到"通知中心"入口
