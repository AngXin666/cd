# 测试账号管理使用说明

## 功能介绍

为了方便测试不同角色的功能，系统在**中央管理系统**中提供了**测试账号管理**功能。该功能按租户分组显示所有测试账号，方便测试数据隔离，您可以快速切换不同租户、不同角色的账号，无需手动输入账号密码。

## 核心特性

### 🎯 按租户分组显示
- **租户隔离**：同一租户的账号合并显示，方便测试数据隔离
- **清晰分类**：每个租户组显示租户名称和账号数量
- **未分配账号**：没有分配租户的账号单独显示在"未分配租户"组

### 🎯 智能退出登录
系统会自动记住您的登录方式，并在退出时智能跳转：
- **通过测试登录进入** → 退出后自动返回测试登录页面，方便继续测试其他账号
- **通过正常登录进入** → 退出后返回正常登录页面，保持正常使用流程

这个功能让测试工作更加流畅，无需在测试和正常登录之间反复切换！

## 访问入口

### 方式一：通过中央管理系统访问（推荐）
1. 登录中央管理系统
2. 进入"租户管理"页面
3. 点击顶部的"测试账号管理"按钮
4. 进入测试账号管理页面

### 方式二：直接访问页面
- 页面路径：`/pages/central-admin/test-accounts/index`
- 在浏览器中直接访问该路径

## 功能特点

### 1. 按租户分组显示
- 同一租户的账号显示在同一组
- 每组显示租户名称和账号数量
- 有租户的账号在前，未分配的在后
- 租户按名称排序

### 2. 显示所有测试账号
- 老板（super_admin）
- 车队长（manager）
- 平级账号（peer_admin）
- 租赁管理员（lease_admin）
- 司机（driver）

### 3. 当前登录状态
- 显示当前登录的账号信息
- 高亮显示当前账号
- 提供"退出登录"按钮

### 4. 一键登录
- 点击任意账号卡片即可快速登录
- 默认密码：`123456`
- 登录成功后自动跳转到对应角色的首页

### 5. 自动跳转规则
- **司机**：跳转到 `/pages/driver/index`
- **车队长**：跳转到 `/pages/manager/index`
- **老板**：跳转到 `/pages/super-admin/index`
- **平级账号**：跳转到 `/pages/super-admin/index`
- **租赁管理员**：跳转到 `/pages/lease-admin/index`

## 使用步骤

1. **进入测试账号管理页面**
   - 通过中央管理系统的"租户管理"页面进入
   - 点击"测试账号管理"按钮

2. **查看账号列表**
   - 页面会自动加载所有测试账号
   - 账号按租户分组显示
   - 每个账号卡片显示：
     - 角色标签（带颜色区分）
     - 姓名
     - 手机号
     - 邮箱

3. **点击账号登录**
   - 点击任意账号卡片
   - 系统会自动使用默认密码（123456）登录
   - 登录成功后显示提示信息
   - 1秒后自动跳转到对应角色的首页

4. **退出登录**
   - 如需退出当前账号，点击顶部的"退出登录"按钮
   - 退出后可以继续选择其他账号登录

5. **下拉刷新**
   - 支持下拉刷新功能
   - 可以重新加载最新的账号列表

## 注意事项

1. **默认密码**
   - 所有测试账号的默认密码都是：`123456`
   - 如果密码被修改，需要手动输入正确的密码

2. **账号列表刷新**
   - 支持下拉刷新功能
   - 系统会重新加载所有测试账号

3. **登录失败处理**
   - 如果登录失败，会显示错误提示
   - 请检查账号密码是否正确
   - 或联系管理员重置密码

4. **角色权限**
   - 不同角色登录后会看到不同的功能界面
   - 请根据测试需求选择对应的角色账号

5. **租户隔离**
   - 同一租户的账号数据是隔离的
   - 测试时请注意选择正确的租户账号

## 常见问题

### Q1: 为什么看不到某个角色的账号？
A: 可能是该角色的账号还没有创建。请联系管理员创建对应角色的测试账号。

### Q2: 登录失败怎么办？
A: 
- 检查账号密码是否正确（默认密码：123456）
- 尝试下拉刷新账号列表
- 如果问题持续，请联系管理员

### Q3: 如何添加新的测试账号？
A: 
- 通过注册功能创建新账号
- 或联系管理员在数据库中添加

### Q4: 为什么有些账号显示在"未分配租户"组？
A: 这些账号还没有分配到具体的租户。可以通过中央管理系统为这些账号分配租户。

### Q5: 测试登录功能在生产环境中会保留吗？
A: 建议在生产环境中移除或限制访问权限，仅在开发和测试环境中使用。

## 技术说明

### 页面路径
- 文件位置：`src/pages/central-admin/test-accounts/index.tsx`
- 路由配置：已添加到 `src/app.config.ts`

### 数据来源
- 使用数据库函数 `get_all_test_accounts()` 获取所有账号
- 该函数使用 SECURITY DEFINER 权限，绕过 RLS 限制
- 从 `profiles` 表查询数据
- 使用 `company_name` 字段进行分组
- 按公司分组显示
- 按创建时间排序

### 登录方式
- 使用 Supabase Auth 的 `signInWithPassword` 方法
- 手机号或邮箱 + 密码登录
- 默认密码：`123456`

## 更新日志

### 2025-11-28 v2.2
- ✅ 修复退出登录后返回页面错误的问题
- ✅ 优化登录来源标记机制，使用 `loginSourcePage` 替代 `isTestLogin`
- ✅ 确保从中央管理系统测试账号页面退出后返回到中央管理系统
- ✅ 修复返回按钮无法返回到租户管理页面的问题
- ✅ 优化返回逻辑，智能判断页面栈状态

### 2025-11-28 v2.1
- ✅ 修复测试账号管理页面无法显示数据的问题
- ✅ 创建 `get_all_test_accounts()` 数据库函数
- ✅ 使用 SECURITY DEFINER 权限绕过 RLS 限制
- ✅ 确保所有用户都能查看测试账号列表

### 2025-11-28 v2.0
- ✅ 将测试账号管理功能移至中央管理系统
- ✅ 实现按租户分组显示
- ✅ 支持下拉刷新功能
- ✅ 从老板端首页移除测试登录入口
- ✅ 在租户管理页面添加测试账号管理入口

### 2025-11-28 v1.0
- ✅ 创建测试账号快速登录页面
- ✅ 添加到老板端首页快捷功能
- ✅ 支持显示所有角色账号
- ✅ 实现一键登录功能
- ✅ 添加当前登录状态显示
- ✅ 实现自动跳转功能
- ✅ 实现智能退出登录功能
