# 计件表格达标率算法检查报告

## 📋 报告概述

本报告详细分析了车队管家小程序中计件报表的达标率计算逻辑，包括当日达标率和月度达标率两个核心指标。

---

## 1️⃣ 当日达标率计算逻辑

### 1.1 当前算法实现

**位置**: `src/pages/super-admin/piece-work-report/index.tsx` 第 433-436 行

```typescript
const _completionRate = useMemo(() => {
  if (dailyTarget === 0) return 0
  return (totalQuantity / dailyTarget) * 100
}, [totalQuantity, dailyTarget])
```

### 1.2 算法公式与参数说明

**公式**:
```
当日达标率 = (总件数 / 每日指标数) × 100%
```

**参数说明**:
- `totalQuantity`: 所有司机在当前日期的总计件数
- `dailyTarget`: 每日指标数（单个司机的每日目标件数）
- 返回值: 百分比数值（如 85 表示 85%）

### 1.3 ⚠️ 存在的严重问题

#### 问题 1: 算法逻辑错误 - 未考虑司机人数

**问题描述**:
当前算法将"所有司机的总件数"直接除以"单个司机的每日指标"，这在逻辑上是错误的。

**数据示例说明问题**:

假设场景：
- 每日指标（dailyTarget）= 100 件/人
- 当日出勤司机数 = 5 人
- 实际完成总件数 = 400 件

**当前算法计算**:
```
当日达标率 = (400 / 100) × 100% = 400%
```

**问题分析**:
- 5 个司机的总目标应该是 500 件（100 × 5）
- 实际完成 400 件，真实达标率应该是 80%（400 / 500）
- 但当前算法显示 400%，严重偏离实际情况

#### 问题 2: 未区分出勤司机和总司机

**问题描述**:
计算达标率时应该基于"实际出勤司机数"，而不是"仓库总司机数"。

**数据示例**:

假设场景：
- 仓库总司机数 = 10 人
- 当日实际出勤 = 6 人
- 每日指标 = 100 件/人
- 实际完成总件数 = 480 件

**正确计算方式**:
```
应该基于出勤司机数:
当日总目标 = 100 × 6 = 600 件
当日达标率 = (480 / 600) × 100% = 80%
```

**错误计算方式**:
```
如果基于总司机数:
当日总目标 = 100 × 10 = 1000 件
当日达标率 = (480 / 1000) × 100% = 48%
```

### 1.4 ✅ 正确的算法公式

```
当日达标率 = (当日总完成件数 / (每日指标 × 当日出勤司机数)) × 100%
```

**参数说明**:
- `当日总完成件数`: 所有出勤司机在当日完成的总件数
- `每日指标`: 单个司机的每日目标件数
- `当日出勤司机数`: 当日实际打卡出勤的司机人数

---

## 2️⃣ 月度达标率计算逻辑

### 2.1 当前算法实现

**位置**: `src/pages/super-admin/piece-work-report/index.tsx` 第 325-330 行

```typescript
// 计算每日达标率
// 达标率 = (总件数 / 每日指标数) * 100%
let driverCompletionRate = 0
if (dailyTarget > 0) {
  driverCompletionRate = (summary.totalQuantity / dailyTarget) * 100
}
```

### 2.2 算法公式与参数说明

**公式**:
```
司机月度达标率 = (司机总件数 / 每日指标数) × 100%
```

**参数说明**:
- `summary.totalQuantity`: 该司机在查询时间段内的总计件数
- `dailyTarget`: 每日指标数（单个司机的每日目标件数）
- 返回值: 百分比数值

### 2.3 ⚠️ 存在的严重问题

#### 问题 1: 算法逻辑错误 - 未考虑时间跨度

**问题描述**:
当前算法将"司机在整个时间段的总件数"直接除以"单日指标"，完全忽略了时间跨度。

**数据示例说明问题**:

假设场景：
- 查询时间段：2025-01-01 至 2025-01-31（31 天）
- 每日指标 = 100 件/人/天
- 司机 A 实际出勤 = 20 天
- 司机 A 总完成件数 = 1800 件

**当前算法计算**:
```
月度达标率 = (1800 / 100) × 100% = 1800%
```

**问题分析**:
- 司机 A 出勤 20 天，总目标应该是 2000 件（100 × 20）
- 实际完成 1800 件，真实达标率应该是 90%（1800 / 2000）
- 但当前算法显示 1800%，完全失去参考意义

#### 问题 2: 未考虑实际出勤天数

**问题描述**:
月度达标率应该基于"实际出勤天数"计算，而不是"日历天数"或"固定天数"。

**数据示例**:

假设场景：
- 查询时间段：2025-01-01 至 2025-01-31（31 天）
- 每日指标 = 100 件/人/天
- 司机 B 实际出勤 = 15 天（请假 5 天，周末休息 11 天）
- 司机 B 总完成件数 = 1350 件

**正确计算方式**:
```
应该基于实际出勤天数:
月度总目标 = 100 × 15 = 1500 件
月度达标率 = (1350 / 1500) × 100% = 90%
```

**错误计算方式 1（基于日历天数）**:
```
月度总目标 = 100 × 31 = 3100 件
月度达标率 = (1350 / 3100) × 100% = 43.5%
```

**错误计算方式 2（当前算法）**:
```
月度达标率 = (1350 / 100) × 100% = 1350%
```

#### 问题 3: 请假天数的处理逻辑不明确

**问题描述**:
当前代码虽然查询了请假天数（`leaveDays`），但在达标率计算中没有使用。需要明确：
- 请假天数是否应该从出勤天数中扣除？
- 请假天数是否应该计入总目标？

**业务场景分析**:

| 场景 | 出勤天数 | 请假天数 | 应计入目标的天数 | 说明 |
|------|---------|---------|----------------|------|
| 场景 1 | 20 天 | 5 天 | 20 天 | 请假不影响目标，只计算实际出勤的达标率 |
| 场景 2 | 20 天 | 5 天 | 25 天 | 请假也要完成目标，总目标包含请假天数 |

**建议**:
根据车队管理的实际业务需求，通常采用**场景 1**的逻辑：
- 请假天数不计入目标
- 只对实际出勤天数计算达标率
- 这样更公平，不会因为请假而降低达标率

### 2.4 ✅ 正确的算法公式

```
司机月度达标率 = (司机总完成件数 / (每日指标 × 实际出勤天数)) × 100%
```

**参数说明**:
- `司机总完成件数`: 该司机在查询时间段内完成的总件数
- `每日指标`: 单个司机的每日目标件数
- `实际出勤天数`: 该司机在查询时间段内实际打卡出勤的天数（不包括请假、缺勤）

---

## 3️⃣ 综合问题分析

### 3.1 根本原因

两个达标率计算都存在**相同的根本问题**：

1. **缺少时间维度**: 没有考虑时间跨度（天数）
2. **缺少人数维度**: 没有考虑司机数量（出勤人数）
3. **公式不完整**: 分母只有"每日指标"一个变量，缺少"天数"和"人数"的乘积

### 3.2 业务影响

| 影响项 | 严重程度 | 具体表现 |
|--------|---------|---------|
| 数据准确性 | 🔴 严重 | 达标率数值严重偏离实际，失去参考价值 |
| 决策支持 | 🔴 严重 | 管理层无法基于错误数据做出正确决策 |
| 绩效考核 | 🔴 严重 | 司机绩效评估不公平，可能引发劳资纠纷 |
| 用户信任 | 🟡 中等 | 用户发现数据异常后会质疑系统可靠性 |

### 3.3 数据验证方法

#### 验证方法 1: 边界值测试

**测试用例**:
```
场景: 单个司机，单日，刚好完成目标
- 司机数: 1 人
- 出勤天数: 1 天
- 每日指标: 100 件
- 实际完成: 100 件

预期结果: 达标率 = 100%
当前算法结果: (100 / 100) × 100% = 100% ✅ 正确

但这只是巧合！当司机数或天数 > 1 时就会出错。
```

#### 验证方法 2: 多司机场景测试

**测试用例**:
```
场景: 多个司机，单日，部分达标
- 司机数: 5 人
- 出勤天数: 1 天
- 每日指标: 100 件
- 实际完成: 400 件

预期结果: 达标率 = 400 / (100 × 5) = 80%
当前算法结果: (400 / 100) × 100% = 400% ❌ 错误
```

#### 验证方法 3: 多天场景测试

**测试用例**:
```
场景: 单个司机，多天，平均达标
- 司机数: 1 人
- 出勤天数: 10 天
- 每日指标: 100 件
- 实际完成: 900 件

预期结果: 达标率 = 900 / (100 × 10) = 90%
当前算法结果: (900 / 100) × 100% = 900% ❌ 错误
```

---

## 4️⃣ 修正方案

### 4.1 当日达标率修正

#### 修正代码

```typescript
// 计算当日达标率
const completionRate = useMemo(() => {
  // 1. 检查每日指标是否有效
  if (dailyTarget === 0) return 0
  
  // 2. 获取当日出勤司机数
  const todayDriversCount = dashboardData.todayDrivers
  
  // 3. 检查出勤司机数是否有效
  if (todayDriversCount === 0) return 0
  
  // 4. 计算当日总目标
  const todayTotalTarget = dailyTarget * todayDriversCount
  
  // 5. 计算达标率
  return (totalQuantity / todayTotalTarget) * 100
}, [totalQuantity, dailyTarget, dashboardData.todayDrivers])
```

#### 修正说明

1. **增加出勤司机数检查**: 避免除以 0 的错误
2. **计算总目标**: `总目标 = 每日指标 × 出勤司机数`
3. **正确计算达标率**: `达标率 = 总完成件数 / 总目标`

#### 数据验证

```
测试场景:
- 每日指标: 100 件/人
- 当日出勤: 5 人
- 实际完成: 400 件

修正后计算:
todayTotalTarget = 100 × 5 = 500 件
completionRate = (400 / 500) × 100% = 80% ✅ 正确
```

### 4.2 月度达标率修正

#### 修正代码

```typescript
// 在 loadAttendanceData 函数中修正
const loadAttendanceData = async () => {
  const summariesWithAttendance = await Promise.all(
    driverSummariesBase.map(async (summary) => {
      const attendanceStats = await getDriverAttendanceStats(summary.driverId, startDate, endDate)

      // 计算司机月度达标率
      let driverCompletionRate = 0
      
      // 1. 检查每日指标是否有效
      if (dailyTarget > 0) {
        // 2. 获取实际出勤天数
        const actualAttendanceDays = attendanceStats.attendanceDays
        
        // 3. 检查出勤天数是否有效
        if (actualAttendanceDays > 0) {
          // 4. 计算该司机的总目标
          const driverTotalTarget = dailyTarget * actualAttendanceDays
          
          // 5. 计算达标率
          driverCompletionRate = (summary.totalQuantity / driverTotalTarget) * 100
        }
      }

      return {
        ...summary,
        attendanceDays: attendanceStats.attendanceDays,
        lateDays: attendanceStats.lateDays,
        leaveDays: attendanceStats.leaveDays,
        completionRate: driverCompletionRate
      }
    })
  )

  // 排序逻辑保持不变
  summariesWithAttendance.sort((a, b) => {
    let compareValue = 0
    if (sortBy === 'completion') {
      compareValue = b.completionRate - a.completionRate
    } else if (sortBy === 'quantity') {
      compareValue = b.totalQuantity - a.totalQuantity
    } else if (sortBy === 'leave') {
      compareValue = b.leaveDays - a.leaveDays
    }
    return sortOrder === 'desc' ? compareValue : -compareValue
  })

  setDriverSummaries(summariesWithAttendance)
}
```

#### 修正说明

1. **使用实际出勤天数**: 从 `attendanceStats.attendanceDays` 获取
2. **计算司机总目标**: `总目标 = 每日指标 × 实际出勤天数`
3. **正确计算达标率**: `达标率 = 司机总完成件数 / 司机总目标`
4. **增加边界检查**: 避免出勤天数为 0 时的除法错误

#### 数据验证

```
测试场景:
- 查询时间段: 2025-01-01 至 2025-01-31（31 天）
- 每日指标: 100 件/人/天
- 司机 A 实际出勤: 20 天
- 司机 A 总完成: 1800 件

修正后计算:
driverTotalTarget = 100 × 20 = 2000 件
driverCompletionRate = (1800 / 2000) × 100% = 90% ✅ 正确
```

### 4.3 仪表盘显示修正

当前仪表盘中的"当日达标率"和"月度达标率"显示为"--"（空白状态），需要修正为实际计算的值。

#### 修正代码

```typescript
{/* 当日达标率 */}
<View className="bg-white bg-opacity-20 rounded-lg p-4">
  <View className="flex items-center gap-2 mb-2">
    <View className="i-mdi-calendar-today text-white text-xl" />
    <Text className="text-white text-opacity-90 text-sm">当日达标率</Text>
  </View>
  <Text className="text-white text-3xl font-bold">
    {dashboardData.todayDrivers > 0 ? `${completionRate.toFixed(1)}%` : '--'}
  </Text>
  <Text className="text-white text-opacity-70 text-xs mt-1">
    {dashboardData.todayDrivers > 0 ? `目标: ${(dailyTarget * dashboardData.todayDrivers).toFixed(0)}件` : '暂无数据'}
  </Text>
</View>

{/* 月度达标率 */}
<View className="bg-white bg-opacity-20 rounded-lg p-4">
  <View className="flex items-center gap-2 mb-2">
    <View className="i-mdi-calendar-month text-white text-xl" />
    <Text className="text-white text-opacity-90 text-sm">月度达标率</Text>
  </View>
  <Text className="text-white text-3xl font-bold">
    {driverSummaries.length > 0 
      ? `${(driverSummaries.reduce((sum, s) => sum + s.completionRate, 0) / driverSummaries.length).toFixed(1)}%`
      : '--'}
  </Text>
  <Text className="text-white text-opacity-70 text-xs mt-1">
    {driverSummaries.length > 0 ? `平均值` : '暂无数据'}
  </Text>
</View>
```

---

## 5️⃣ 实施建议

### 5.1 修复优先级

| 优先级 | 修复项 | 预计工作量 | 影响范围 |
|--------|--------|-----------|---------|
| 🔴 P0 | 月度达标率算法修正 | 30 分钟 | 司机列表、排序功能 |
| 🔴 P0 | 当日达标率算法修正 | 20 分钟 | 仪表盘显示 |
| 🟡 P1 | 仪表盘数据显示 | 15 分钟 | 仪表盘卡片 |
| 🟢 P2 | 增加单元测试 | 1 小时 | 代码质量保障 |

### 5.2 测试计划

#### 测试用例 1: 单司机单日场景
```
输入:
- 司机数: 1 人
- 出勤天数: 1 天
- 每日指标: 100 件
- 实际完成: 80 件

预期输出:
- 达标率: 80%
```

#### 测试用例 2: 多司机单日场景
```
输入:
- 司机数: 5 人
- 出勤天数: 1 天
- 每日指标: 100 件
- 实际完成: 450 件

预期输出:
- 达标率: 90%
```

#### 测试用例 3: 单司机多日场景
```
输入:
- 司机数: 1 人
- 出勤天数: 20 天
- 每日指标: 100 件
- 实际完成: 1800 件

预期输出:
- 达标率: 90%
```

#### 测试用例 4: 边界情况 - 零出勤
```
输入:
- 司机数: 0 人
- 出勤天数: 0 天
- 每日指标: 100 件
- 实际完成: 0 件

预期输出:
- 达标率: 0% 或 "--"（显示暂无数据）
```

#### 测试用例 5: 边界情况 - 超额完成
```
输入:
- 司机数: 3 人
- 出勤天数: 1 天
- 每日指标: 100 件
- 实际完成: 400 件

预期输出:
- 达标率: 133.3%
```

### 5.3 回归测试检查项

- [ ] 当日达标率显示正确
- [ ] 月度达标率显示正确
- [ ] 司机列表按达标率排序正确
- [ ] 达标率圆环显示正确（颜色、角度）
- [ ] 边界情况处理正确（0 出勤、0 指标）
- [ ] 数据刷新后达标率更新正确
- [ ] 切换仓库后达标率重新计算正确
- [ ] 修改每日指标后达标率重新计算正确

---

## 6️⃣ 总结

### 6.1 问题总结

1. **当日达标率**: 未考虑出勤司机数，导致数值偏大
2. **月度达标率**: 未考虑出勤天数，导致数值严重偏大
3. **仪表盘显示**: 达标率数据未正确显示

### 6.2 修正要点

1. **当日达标率**: `总完成件数 / (每日指标 × 当日出勤司机数)`
2. **月度达标率**: `司机总完成件数 / (每日指标 × 实际出勤天数)`
3. **边界处理**: 增加除数为 0 的检查

### 6.3 预期效果

修正后，达标率将准确反映实际情况：
- ✅ 数值范围合理（通常在 0-150% 之间）
- ✅ 能够正确评估司机绩效
- ✅ 支持管理层做出正确决策
- ✅ 提升系统可信度

---

## 📌 附录

### A. 相关代码文件

- 超级管理员计件报表: `src/pages/super-admin/piece-work-report/index.tsx`
- 普通管理员计件报表: `src/pages/manager/piece-work-report/index.tsx`
- 数据库 API: `src/db/api.ts`

### B. 相关数据库表

- `piece_work_records`: 计件记录表
- `attendance_records`: 考勤记录表
- `profiles`: 用户档案表
- `warehouses`: 仓库表

### C. 关键函数

- `getDriverAttendanceStats()`: 获取司机考勤统计
- `getAttendanceRecordsByWarehouse()`: 获取仓库考勤记录
- `getDriversByWarehouse()`: 获取仓库司机列表

---

**报告生成时间**: 2025-01-05  
**报告版本**: v1.0  
**审核状态**: 待修复
