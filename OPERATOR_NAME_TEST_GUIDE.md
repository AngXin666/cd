# 通知操作人显示优化 - 快速测试指南

## 🎯 测试目标

验证通知消息中能够显示具体的操作人姓名，而不是笼统的"超级管理员"或"管理员"。

## 🚀 快速测试步骤

### 测试1：超级管理员操作（推荐）

这是最直接的验证方法！

1. **登录超级管理员账号**
2. **打开浏览器控制台（F12）**
3. **进入"用户管理"页面**
4. **找到一个司机**
5. **点击"切换成带车司机"或"切换成纯司机"**
6. **确认操作**
7. **查看控制台日志**

**预期日志**：
```
[getCurrentUserWithRealName] 成功获取用户档案: {
  id: "...",
  name: "admin",
  real_name: "张三",    ← 这里应该显示真实姓名
  role: "super_admin"
}
✅ 已发送 X 条司机类型变更通知
```

**验证通知**：
1. 使用管理员账号登录
2. 进入"通知中心"
3. 查看最新通知

**预期通知内容**：
```
标题：司机类型变更操作通知
内容：超级管理员 张三 修改了司机类型：李四，从【纯司机】变更为【带车司机】
       ↑↑↑↑↑↑↑↑↑↑
       应该显示具体的姓名，而不是"超级管理员"
```

### 测试2：普通管理员操作

1. **登录普通管理员账号**
2. **打开浏览器控制台（F12）**
3. **进入"司机管理"页面**
4. **找到一个司机**
5. **点击"切换成带车司机"或"切换成纯司机"**
6. **确认操作**
7. **查看控制台日志**

**预期日志**：
```
[getCurrentUserWithRealName] 成功获取用户档案: {
  id: "...",
  name: "manager1",
  real_name: "王五",    ← 这里应该显示真实姓名
  role: "manager"
}
✅ 已发送 X 条司机类型变更通知
```

**验证通知**：
1. 使用超级管理员账号登录
2. 进入"通知中心"
3. 查看最新通知

**预期通知内容**：
```
标题：司机类型变更操作通知
内容：管理员 王五 修改了司机类型：李四，从【纯司机】变更为【带车司机】
       ↑↑↑↑↑↑↑
       应该显示具体的姓名，而不是"管理员"
```

### 测试3：仓库分配操作

1. **登录超级管理员账号**
2. **打开浏览器控制台（F12）**
3. **进入"用户管理"页面**
4. **找到一个司机**
5. **点击"仓库分配"**
6. **勾选一个仓库**
7. **点击"保存"**
8. **查看控制台日志**

**预期日志**：
```
👤 [仓库分配] 当前用户信息: {
  用户ID: "...",
  角色: "super_admin",
  姓名: "admin",
  真实姓名: "张三"    ← 这里应该显示真实姓名
}
👤 [仓库分配] 操作人显示名称: 张三
✅ [仓库分配] 已成功发送 X 条通知
```

**验证通知**：
1. 使用管理员账号登录
2. 进入"通知中心"
3. 查看最新通知

**预期通知内容**：
```
标题：仓库分配操作通知
内容：超级管理员 张三 修改了司机 李四 的仓库分配，涉及仓库：仓库A
       ↑↑↑↑↑↑↑↑↑↑
       应该显示具体的姓名
```

## ✅ 成功标准

- ✅ 控制台日志显示 `real_name` 字段有值
- ✅ 控制台日志显示"操作人显示名称"为具体姓名
- ✅ 通知消息中显示具体的操作人姓名
- ✅ 不再显示笼统的"超级管理员"或"管理员"

## ❌ 常见问题

### 问题1：控制台日志显示 `real_name: null`

**原因**：用户没有上传驾驶证

**解决方法**：
1. 进入"个人中心"
2. 上传驾驶证
3. 确保驾驶证审核通过
4. 重新测试

**备选方案**：
- 如果 `real_name` 为 null，系统会自动使用 `name` 字段
- 如果 `name` 也为 null，系统会显示"超级管理员"或"管理员"

### 问题2：通知消息中仍然显示"超级管理员"

**原因**：
- 用户既没有真实姓名也没有用户名
- 或者代码没有正确获取真实姓名

**解决方法**：
1. 查看控制台日志，确认 `real_name` 和 `name` 的值
2. 如果都为 null，需要完善用户信息
3. 如果有值但没有显示，检查代码逻辑

### 问题3：控制台没有日志输出

**原因**：
- 没有打开控制台
- JavaScript 错误导致代码中断

**解决方法**：
1. 按 F12 打开浏览器开发者工具
2. 切换到 Console 标签页
3. 查看是否有红色的错误信息

## 📊 数据库验证

如果前端显示不正确，可以直接查询数据库：

```sql
-- 查询用户的真实姓名
SELECT 
  p.id,
  p.name,
  p.role,
  dl.id_card_name as real_name
FROM profiles p
LEFT JOIN driver_licenses dl ON p.id = dl.driver_id
WHERE p.role IN ('super_admin', 'manager')
ORDER BY p.created_at DESC;
```

**预期结果**：
- 如果用户上传了驾驶证，`real_name` 列应该有值
- 如果没有上传驾驶证，`real_name` 列为 null

## 🎯 推荐测试流程

1. **先测试超级管理员操作**（2分钟）
   - 最常见的场景
   - 最容易验证

2. **再测试普通管理员操作**（2分钟）
   - 验证不同角色的显示

3. **测试仓库分配操作**（2分钟）
   - 验证不同功能的显示

4. **验证通知内容**（1分钟）
   - 确认显示正确

**总计时间**：约7分钟

## 📞 需要帮助？

如果测试过程中遇到问题，请提供：

1. **控制台日志截图**
   - 完整的 `getCurrentUserWithRealName` 日志
   - 是否有错误信息？

2. **通知消息截图**
   - 显示的内容是什么？
   - 是否显示了具体姓名？

3. **数据库查询结果**
   - 用户的 `real_name` 是什么？
   - 用户的 `name` 是什么？

4. **操作步骤**
   - 具体操作了什么？
   - 使用的是哪个账号？

## 📚 详细文档

- `NOTIFICATION_OPERATOR_NAME_FIX.md` - 完整实现说明
- `WAREHOUSE_ASSIGNMENT_NOTIFICATION_COMPLETE.md` - 仓库分配通知实现
- `NOTIFICATION_DEBUG_GUIDE.md` - 详细调试指南

## 🎉 显示名称优先级

系统按以下优先级显示操作人姓名：

1. **真实姓名**（`real_name`）← 最优先
   - 来源：驾驶证上的姓名
   - 示例：`超级管理员 张三`

2. **用户名**（`name`）← 次优先
   - 来源：用户注册时的用户名
   - 示例：`超级管理员 admin`

3. **角色名称** ← 最后备选
   - 固定文本
   - 示例：`超级管理员` 或 `管理员`

---

**祝测试顺利！** 🎉
