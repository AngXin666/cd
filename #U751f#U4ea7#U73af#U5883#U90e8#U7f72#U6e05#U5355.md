# 生产环境部署清单

## ⚠️ 重要提示

在将应用部署到生产环境之前，**必须**完成以下清理工作，以确保系统安全性和专业性。

---

## 1. 删除测试账号快速登录功能

### 位置
`src/pages/login/index.tsx`

### 需要删除的代码块

#### 删除状态变量（第 24-26 行）
```typescript
const [showTestAccounts, setShowTestAccounts] = useState(false)
const [testAccounts, setTestAccounts] = useState<TestAccount[]>([])
const [testLoading, setTestLoading] = useState(false)
```

#### 删除接口定义（第 7-14 行）
```typescript
interface TestAccount {
  id: string
  name: string | null
  phone: string
  email: string
  role: string
  role_name: string
}
```

#### 删除相关函数（第 58-160 行）
```typescript
// 获取角色名称
const getRoleName = useCallback((role: string): string => {
  // ...
}, [])

// 加载测试账号列表
const loadTestAccounts = useCallback(async () => {
  // ...
}, [getRoleName])

// 测试账号快速登录
const handleTestLogin = async (testAccount: TestAccount) => {
  // ...
}

// 获取角色颜色
const getRoleColor = (role: string): string => {
  // ...
}
```

#### 删除 UI 组件（大约第 483-543 行）
```tsx
{/* 测试账号快速登录（开发测试用） */}
<View className="mt-8">
  <View className="bg-white bg-opacity-10 rounded-lg p-4">
    {/* ... 整个测试账号区域 ... */}
  </View>
</View>
```

### 快速删除方法

**方法1：搜索关键字删除**
1. 搜索 `🧪 开发测试 - 快速登录`
2. 删除整个 `<View className="mt-8">` 到 `</View>` 的代码块
3. 删除相关的状态变量和函数

**方法2：使用注释标记**
在代码中搜索以下注释：
- `{/* 测试账号快速登录（开发测试用） */}`
- 删除从这个注释开始到对应的 `</View>` 结束的所有代码

---

## 2. 删除数据库 RLS 策略

### 位置
Supabase 数据库 - `profiles` 表

### 需要删除的策略
策略名称：`Allow read for test login`

### 删除方法

#### 方法1：通过 Supabase Dashboard
1. 登录 Supabase Dashboard
2. 进入项目的 Database 页面
3. 选择 `profiles` 表
4. 点击 "Policies" 标签
5. 找到 `Allow read for test login` 策略
6. 点击删除按钮

#### 方法2：执行 SQL
在 Supabase SQL Editor 中执行：
```sql
DROP POLICY IF EXISTS "Allow read for test login" ON profiles;
```

#### 方法3：创建迁移文件
创建新的迁移文件 `remove_test_login_policy.sql`：
```sql
/*
# 删除测试登录的读取策略

生产环境部署：删除开发测试专用的 RLS 策略
*/

DROP POLICY IF EXISTS "Allow read for test login" ON profiles;
```

---

## 3. 删除测试账号说明文档（可选）

### 需要删除的文件
- `测试账号功能说明.md`
- `登录状态说明.md`
- `调试租户创建错误.md`
- `生产环境部署清单.md`（本文件）

### 删除方法
```bash
rm 测试账号功能说明.md
rm 登录状态说明.md
rm 调试租户创建错误.md
rm 生产环境部署清单.md
```

---

## 4. 更新功能说明区域

### 位置
`src/pages/login/index.tsx` - 功能说明区域

### 修改前
```tsx
<View className="mt-2 pt-2 border-t border-white border-opacity-20">
  <Text className="text-xs text-blue-100 block mb-1">测试账号（默认密码：123456）：</Text>
  <Text className="text-xs text-blue-100 block">• 司机：admin1</Text>
  <Text className="text-xs text-blue-100 block">• 车队长：admin2</Text>
  <Text className="text-xs text-blue-100 block">• 老板：admin3</Text>
  <Text className="text-xs text-blue-100 block mt-1">• 中央管理员：admin 或 13800000001</Text>
  <Text className="text-xs text-blue-100 block">  密码：hye19911206</Text>
</View>
```

### 修改后
删除整个测试账号说明部分，只保留登录方式说明：
```tsx
{/* 功能说明 */}
<View className="mt-4">
  <View className="bg-white bg-opacity-10 rounded-lg p-4">
    <Text className="text-xs text-white block mb-2 font-bold">登录方式说明：</Text>
    <View className="mb-1">
      <Text className="text-xs text-blue-100 block">• 密码登录：支持手机号或账号名 + 密码</Text>
    </View>
    <View className="mb-1">
      <Text className="text-xs text-blue-100 block">• 验证码登录：仅支持手机号 + 验证码</Text>
    </View>
  </View>
</View>
```

---

## 5. 清理测试数据（可选）

### 数据库清理

如果需要清理测试账号数据，可以执行以下 SQL：

```sql
-- 删除测试账号（根据实际情况调整条件）
DELETE FROM profiles 
WHERE phone IN ('13800000001', '13800000002', '13800000003')
   OR name IN ('admin1', 'admin2', 'admin3');

-- 删除测试租户
DELETE FROM tenants 
WHERE tenant_code LIKE 'test-%' 
   OR company_name LIKE '测试%';
```

⚠️ **警告**：执行删除操作前请务必备份数据库！

---

## 6. 验证清理结果

### 检查清单

- [ ] 登录页面不再显示"🧪 开发测试 - 快速登录"区域
- [ ] 登录页面不再显示测试账号列表
- [ ] 数据库 `profiles` 表的 RLS 策略中没有 `Allow read for test login`
- [ ] 功能说明区域不再显示测试账号信息
- [ ] 测试文档已删除（可选）
- [ ] 测试数据已清理（可选）

### 测试步骤

1. **前端测试**：
   - 打开登录页面
   - 确认没有测试账号相关的 UI
   - 确认登录功能正常

2. **数据库测试**：
   - 尝试在未登录状态下读取 `profiles` 表
   - 应该返回权限错误（这是正确的）

3. **功能测试**：
   - 使用正常账号登录
   - 确认所有功能正常工作

---

## 7. 部署流程建议

### 推荐步骤

1. **在开发环境测试**：
   - 先在开发环境完成所有清理工作
   - 测试确认功能正常

2. **代码审查**：
   - 检查是否有遗漏的测试代码
   - 确认所有安全警告都已处理

3. **数据库迁移**：
   - 创建删除 RLS 策略的迁移文件
   - 在生产环境执行迁移

4. **前端部署**：
   - 构建生产版本
   - 部署到生产环境

5. **验证测试**：
   - 按照上述检查清单验证
   - 测试核心功能

---

## 8. 回滚方案

如果需要恢复测试功能（仅限开发环境）：

### 恢复 RLS 策略
```sql
CREATE POLICY "Allow read for test login" ON profiles
  FOR SELECT TO anon, authenticated
  USING (true);
```

### 恢复代码
从 Git 历史中恢复删除的代码：
```bash
git log --all --full-history -- "src/pages/login/index.tsx"
git checkout <commit-hash> -- "src/pages/login/index.tsx"
```

---

## 9. 安全检查清单

部署前的最终安全检查：

- [ ] 所有测试账号的默认密码已修改
- [ ] 数据库 RLS 策略正确配置
- [ ] 没有硬编码的敏感信息
- [ ] 环境变量正确配置
- [ ] API 密钥已更换为生产环境密钥
- [ ] 日志级别设置为生产模式
- [ ] 错误信息不暴露敏感信息

---

## 10. 联系支持

如果在清理过程中遇到问题：

1. 查看项目的 README.md
2. 查看相关的说明文档
3. 检查 Git 提交历史
4. 联系开发团队

---

## 总结

完成以上所有步骤后，您的应用将：

✅ 移除所有开发测试专用功能  
✅ 提高系统安全性  
✅ 呈现专业的生产环境界面  
✅ 符合生产环境部署标准  

**记住**：在执行任何删除操作前，请务必备份代码和数据库！
